{"version":3,"file":"terminalWindowManager.js","sourceRoot":"","sources":["../../src/desktop/terminalWindowManager.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Terminal Window Manager\n *\n * Manages pop-out terminal windows for workspaces.\n * Each workspace can have multiple terminal windows open simultaneously.\n */\n\nimport { app, BrowserWindow } from \"electron\";\nimport * as path from \"path\";\nimport { log } from \"@/node/services/log\";\nimport type { Config } from \"@/node/config\";\n\nexport class TerminalWindowManager {\n  private windows = new Map<string, Set<BrowserWindow>>(); // workspaceId -> Set of windows\n  private windowCount = 0; // Counter for unique window IDs\n  private readonly config: Config;\n\n  constructor(config: Config) {\n    this.config = config;\n  }\n\n  /**\n   * Open a new terminal window for a workspace\n   * Multiple windows can be open for the same workspace\n   * @param sessionId Optional session ID to reattach to (for pop-out handoff from embedded terminal)\n   */\n  async openTerminalWindow(workspaceId: string, sessionId?: string): Promise<void> {\n    this.windowCount++;\n    const windowId = this.windowCount;\n\n    // Look up workspace metadata to get project and branch names\n    const allWorkspaces = await this.config.getAllWorkspaceMetadata();\n    const workspace = allWorkspaces.find((ws) => ws.id === workspaceId);\n\n    let title: string;\n    if (workspace) {\n      title = `Terminal ${windowId} — ${workspace.projectName} (${workspace.name})`;\n    } else {\n      // Fallback if workspace not found\n      title = `Terminal ${windowId} — ${workspaceId}`;\n    }\n\n    const terminalWindow = new BrowserWindow({\n      width: 1000,\n      height: 600,\n      title,\n      webPreferences: {\n        nodeIntegration: false,\n        contextIsolation: true,\n        // __dirname is dist/services/ but preload.js is in dist/\n        preload: path.join(__dirname, \"../preload.js\"),\n      },\n      backgroundColor: \"#1e1e1e\",\n    });\n\n    // Track the window\n    if (!this.windows.has(workspaceId)) {\n      this.windows.set(workspaceId, new Set());\n    }\n    this.windows.get(workspaceId)!.add(terminalWindow);\n\n    // Clean up when window is closed\n    terminalWindow.on(\"closed\", () => {\n      const windowSet = this.windows.get(workspaceId);\n      if (windowSet) {\n        windowSet.delete(terminalWindow);\n        if (windowSet.size === 0) {\n          this.windows.delete(workspaceId);\n        }\n      }\n      log.info(`Terminal window ${windowId} closed for workspace: ${workspaceId}`);\n    });\n\n    // Load the terminal page\n    // Match main window logic: use dev server unless packaged or MUX_E2E_LOAD_DIST=1\n    const forceDistLoad = process.env.MUX_E2E_LOAD_DIST === \"1\";\n    const useDevServer = !app.isPackaged && !forceDistLoad;\n\n    // Build query params including optional sessionId for session handoff\n    const queryParams: Record<string, string> = { workspaceId };\n    if (sessionId) {\n      queryParams.sessionId = sessionId;\n    }\n\n    if (useDevServer) {\n      // Development mode - load from Vite dev server\n      const params = new URLSearchParams(queryParams);\n      await terminalWindow.loadURL(`http://localhost:5173/terminal.html?${params.toString()}`);\n      terminalWindow.webContents.openDevTools();\n    } else {\n      // Production mode (or E2E dist mode) - load from built files\n      await terminalWindow.loadFile(path.join(__dirname, \"../terminal.html\"), {\n        query: queryParams,\n      });\n    }\n\n    log.info(`Terminal window ${windowId} opened for workspace: ${workspaceId}`);\n  }\n\n  /**\n   * Close all terminal windows for a workspace\n   */\n  closeTerminalWindow(workspaceId: string): void {\n    const windowSet = this.windows.get(workspaceId);\n    if (windowSet) {\n      for (const window of windowSet) {\n        if (!window.isDestroyed()) {\n          window.close();\n        }\n      }\n      this.windows.delete(workspaceId);\n    }\n  }\n\n  /**\n   * Close all terminal windows for all workspaces\n   */\n  closeAll(): void {\n    for (const [workspaceId, windowSet] of this.windows.entries()) {\n      for (const window of windowSet) {\n        if (!window.isDestroyed()) {\n          window.close();\n        }\n      }\n      this.windows.delete(workspaceId);\n    }\n  }\n\n  /**\n   * Get all windows for a workspace\n   */\n  getWindows(workspaceId: string): BrowserWindow[] {\n    const windowSet = this.windows.get(workspaceId);\n    if (!windowSet) return [];\n    return Array.from(windowSet).filter((w) => !w.isDestroyed());\n  }\n\n  /**\n   * Get count of open terminal windows for a workspace\n   */\n  getWindowCount(workspaceId: string): number {\n    return this.getWindows(workspaceId).length;\n  }\n}\n"]}