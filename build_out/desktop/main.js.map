{"version":3,"file":"main.js","sourceRoot":"","sources":["../../src/desktop/main.ts"],"names":[],"mappings":"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","sourcesContent":["// Enable source map support for better error stack traces in production\nimport \"source-map-support/register\";\n\n// Fix PATH on macOS when launched from Finder (not terminal).\n// GUI apps inherit minimal PATH from launchd, missing Homebrew tools like git-lfs.\n// Must run before any child process spawns. Failures are silently ignored.\nif (process.platform === \"darwin\") {\n  try {\n    // eslint-disable-next-line @typescript-eslint/no-require-imports\n    (require(\"fix-path\") as { default: () => void }).default();\n  } catch (e) {\n    // App works with existing PATH; debug log for troubleshooting\n    console.debug(\"[fix-path] Failed to enrich PATH:\", e);\n  }\n}\n\nimport { randomBytes } from \"crypto\";\nimport { RPCHandler } from \"@orpc/server/message-port\";\nimport { onError } from \"@orpc/server\";\nimport { router } from \"@/node/orpc/router\";\nimport { formatOrpcError } from \"@/node/orpc/formatOrpcError\";\nimport { ServerLockfile } from \"@/node/services/serverLockfile\";\nimport \"disposablestack/auto\";\n\nimport type { MenuItemConstructorOptions } from \"electron\";\nimport {\n  app,\n  BrowserWindow,\n  ipcMain as electronIpcMain,\n  Menu,\n  Tray,\n  dialog,\n  nativeImage,\n  nativeTheme,\n  screen,\n  shell,\n} from \"electron\";\n\n// Increase renderer V8 heap limit from default ~4GB to 8GB.\n// At ~3.9GB usage, the default limit causes frequent Mark-Compact GC cycles\n// with low mutator utilization (~39%), degrading UI responsiveness.\n// Must be called before app.whenReady().\napp.commandLine.appendSwitch(\"js-flags\", \"--max-old-space-size=8192\");\n\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport type { Config } from \"@/node/config\";\nimport type { ServiceContainer } from \"@/node/services/serviceContainer\";\nimport { VERSION } from \"@/version\";\nimport { getMuxHome, migrateLegacyMuxHome } from \"@/common/constants/paths\";\nimport type { MuxDeepLinkPayload } from \"@/common/types/deepLink\";\nimport { parseMuxDeepLink } from \"@/common/utils/deepLink\";\n\nimport assert from \"@/common/utils/assert\";\nimport { loadTokenizerModules } from \"@/node/utils/main/tokenizer\";\nimport { isBashAvailable } from \"@/node/utils/main/bashPath\";\nimport windowStateKeeper from \"electron-window-state\";\nimport { getTitleBarOptions } from \"@/desktop/titleBarOptions\";\n\n// React DevTools for development profiling\n// Using dynamic import() to avoid loading electron-devtools-installer at module init time\n\n// IMPORTANT: Lazy-load heavy dependencies to maintain fast startup time\n//\n// To keep startup time under 4s, avoid importing AI SDK packages at the top level.\n// These files MUST use dynamic import():\n//   - main.ts, config.ts, preload.ts (startup-critical)\n//\n// ✅ GOOD: const { createAnthropic } = await import(\"@ai-sdk/anthropic\");\n// ❌ BAD:  import { createAnthropic } from \"@ai-sdk/anthropic\";\n//\n// Enforcement: scripts/check_eager_imports.sh validates this in CI\n//\n// Lazy-load Config and ServiceContainer to avoid loading heavy AI SDK dependencies at startup\n// These will be loaded on-demand when createWindow() is called\nlet config: Config | null = null;\nlet services: ServiceContainer | null = null;\nconst isE2ETest = process.env.MUX_E2E === \"1\";\nconst forceDistLoad = process.env.MUX_E2E_LOAD_DIST === \"1\";\n\nif (isE2ETest) {\n  // For e2e tests, use a test-specific userData directory\n  // Note: getMuxHome() already respects MUX_ROOT for test isolation\n  const e2eUserData = path.join(getMuxHome(), \"user-data\");\n  try {\n    fs.mkdirSync(e2eUserData, { recursive: true });\n    app.setPath(\"userData\", e2eUserData);\n    console.log(\"Using test userData directory:\", e2eUserData);\n  } catch (error) {\n    console.warn(\"Failed to prepare test userData directory:\", error);\n  }\n}\n\nconst devServerPort = process.env.MUX_DEVSERVER_PORT ?? \"5173\";\n\nconsole.log(\n  `Mux starting - version: ${(VERSION as { git?: string; buildTime?: string }).git ?? \"(dev)\"} (built: ${(VERSION as { git?: string; buildTime?: string }).buildTime ?? \"dev-mode\"})`\n);\nconsole.log(\"Main process starting...\");\n\n// Debug: abort immediately if MUX_DEBUG_START_TIME is set\n// This is used to measure baseline startup time without full initialization\nif (process.env.MUX_DEBUG_START_TIME === \"1\") {\n  console.log(\"MUX_DEBUG_START_TIME is set - aborting immediately\");\n  process.exit(0);\n}\n\n// Global error handlers for better error reporting\nprocess.on(\"uncaughtException\", (error: unknown) => {\n  console.error(\"Uncaught Exception:\", error);\n\n  const message = error instanceof Error ? error.message : String(error);\n  const stack = error instanceof Error ? error.stack : undefined;\n\n  console.error(\"Stack:\", stack);\n\n  // Show error dialog in production\n  if (app.isPackaged) {\n    dialog.showErrorBox(\n      \"Application Error\",\n      `An unexpected error occurred:\\n\\n${message}\\n\\nStack trace:\\n${stack ?? \"No stack trace available\"}`\n    );\n  }\n});\n\nprocess.on(\"unhandledRejection\", (reason, promise) => {\n  console.error(\"Unhandled Rejection at:\", promise);\n  console.error(\"Reason:\", reason);\n\n  if (app.isPackaged) {\n    const message = reason instanceof Error ? reason.message : String(reason);\n    const stack = reason instanceof Error ? reason.stack : undefined;\n    dialog.showErrorBox(\n      \"Unhandled Promise Rejection\",\n      `An unhandled promise rejection occurred:\\n\\n${message}\\n\\nStack trace:\\n${stack ?? \"No stack trace available\"}`\n    );\n  }\n});\n\n// Single instance lock (can be disabled for development with CMUX_ALLOW_MULTIPLE_INSTANCES=1)\nconst allowMultipleInstances = process.env.CMUX_ALLOW_MULTIPLE_INSTANCES === \"1\";\nconst gotTheLock = allowMultipleInstances || app.requestSingleInstanceLock();\nconsole.log(\"Single instance lock acquired:\", gotTheLock);\n\nif (!gotTheLock) {\n  // Another instance is already running, quit this one\n  console.log(\"Another instance is already running, quitting...\");\n  app.quit();\n} else {\n  // This is the primary instance\n  console.log(\"This is the primary instance\");\n  app.on(\"second-instance\", (_event, argv) => {\n    // Someone tried to run a second instance, focus our window instead\n    console.log(\"Second instance attempted to start\");\n\n    try {\n      handleArgvMuxDeepLinks(argv);\n    } catch (error) {\n      console.debug(\"[deep-link] Failed to parse second-instance argv for mux deep links:\", error);\n    }\n\n    focusMainWindow();\n  });\n}\n\nlet mainWindow: BrowserWindow | null = null;\nlet splashWindow: BrowserWindow | null = null;\nlet tray: Tray | null = null;\nlet isQuitting = false;\n\n// mux:// deep links can arrive before the main window exists / finishes loading.\nconst bufferedMuxDeepLinks: MuxDeepLinkPayload[] = [];\nlet mainWindowFinishedLoading = false;\n\nfunction focusMainWindow() {\n  if (!mainWindow) return;\n  if (mainWindow.isMinimized()) mainWindow.restore();\n  // Closing Mux on Windows hides to tray; show it again when a second-instance launch occurs.\n  mainWindow.show();\n  mainWindow.focus();\n}\n\nfunction flushBufferedMuxDeepLinks() {\n  if (!mainWindow || !mainWindowFinishedLoading) return;\n\n  while (bufferedMuxDeepLinks.length > 0) {\n    const payload = bufferedMuxDeepLinks[0];\n    try {\n      mainWindow.webContents.send(\"mux:deep-link\", payload);\n      bufferedMuxDeepLinks.shift();\n    } catch (error) {\n      // Best-effort: never crash startup if the renderer isn't ready.\n      console.debug(\"[deep-link] Failed to send mux deep link payload:\", error);\n      return;\n    }\n  }\n}\n\nfunction handleMuxDeepLink(raw: string) {\n  try {\n    const payload = parseMuxDeepLink(raw);\n    if (!payload) return;\n\n    // Buffer until the renderer has finished loading.\n    if (!mainWindow || !mainWindowFinishedLoading) {\n      bufferedMuxDeepLinks.push(payload);\n      return;\n    }\n\n    mainWindow.webContents.send(\"mux:deep-link\", payload);\n  } catch (error) {\n    // Best-effort: never crash startup if argv parsing/protocol handling is weird.\n    console.debug(`[deep-link] Failed to handle mux deep link: ${raw}`, error);\n  }\n}\n\nfunction handleArgvMuxDeepLinks(argv: string[]) {\n  for (const arg of argv) {\n    if (arg.startsWith(\"mux:\")) {\n      handleMuxDeepLink(arg);\n    }\n  }\n}\n\n// macOS deep links arrive via open-url (must be registered before ready)\nif (process.platform === \"darwin\") {\n  app.on(\"open-url\", (event, url) => {\n    event.preventDefault();\n    handleMuxDeepLink(url);\n    focusMainWindow();\n  });\n}\n\n// Initial launch: Windows/Linux deep links are passed in argv.\ntry {\n  handleArgvMuxDeepLinks(process.argv);\n} catch (error) {\n  console.debug(\"[deep-link] Failed to parse initial argv for mux deep links:\", error);\n}\n\nfunction registerMuxProtocolClient() {\n  try {\n    if (!app.isPackaged && process.defaultApp && process.argv[1]) {\n      // On Windows dev builds, Electron needs the executable + app path to register.\n      app.setAsDefaultProtocolClient(\"mux\", process.execPath, [path.resolve(process.argv[1])]);\n      return;\n    }\n\n    app.setAsDefaultProtocolClient(\"mux\");\n  } catch (error) {\n    // Best-effort: never crash startup if protocol registration fails.\n    console.debug(\"[deep-link] Failed to register mux:// protocol handler:\", error);\n  }\n}\n\n/**\n * Format timestamp as HH:MM:SS.mmm for readable logging\n */\nfunction timestamp(): string {\n  const now = new Date();\n  const hours = String(now.getHours()).padStart(2, \"0\");\n  const minutes = String(now.getMinutes()).padStart(2, \"0\");\n  const seconds = String(now.getSeconds()).padStart(2, \"0\");\n  const ms = String(now.getMilliseconds()).padStart(3, \"0\");\n  return `${hours}:${minutes}:${seconds}.${ms}`;\n}\n\nfunction createMenu() {\n  const template: MenuItemConstructorOptions[] = [\n    {\n      label: \"Edit\",\n      submenu: [\n        { role: \"undo\" },\n        { role: \"redo\" },\n        { type: \"separator\" },\n        { role: \"cut\" },\n        { role: \"copy\" },\n        { role: \"paste\" },\n        { role: \"selectAll\" },\n      ],\n    },\n    {\n      label: \"View\",\n      submenu: [\n        // Reload without Ctrl+R shortcut (reserved for Code Review refresh)\n        {\n          label: \"Reload\",\n          click: (_item, focusedWindow) => {\n            if (focusedWindow && \"reload\" in focusedWindow) {\n              (focusedWindow as BrowserWindow).reload();\n            }\n          },\n        },\n        { role: \"forceReload\" },\n        { role: \"toggleDevTools\" },\n        { type: \"separator\" },\n        { role: \"resetZoom\" },\n        { role: \"zoomIn\" },\n        { role: \"zoomOut\" },\n        { type: \"separator\" },\n        {\n          role: \"togglefullscreen\",\n          accelerator: process.platform === \"darwin\" ? \"Ctrl+Command+F\" : \"F11\",\n        },\n      ],\n    },\n    {\n      label: \"Window\",\n      submenu: [{ role: \"minimize\" }, { role: \"close\" }],\n    },\n  ];\n\n  if (process.platform === \"darwin\") {\n    template.unshift({\n      label: app.getName(),\n      submenu: [\n        { role: \"about\" },\n        { type: \"separator\" },\n        {\n          label: \"Settings...\",\n          accelerator: \"Cmd+,\",\n          click: () => {\n            services?.menuEventService.emitOpenSettings();\n          },\n        },\n        { type: \"separator\" },\n        { role: \"services\", submenu: [] },\n        { type: \"separator\" },\n        { role: \"hide\" },\n        { role: \"hideOthers\" },\n        { role: \"unhide\" },\n        { type: \"separator\" },\n        { role: \"quit\" },\n      ],\n    });\n  }\n\n  const menu = Menu.buildFromTemplate(template);\n  Menu.setApplicationMenu(menu);\n}\n\n/**\n * System tray (Windows/Linux) / menu bar (macOS) icon.\n *\n * - macOS: use a template image (always the black asset) so the system\n *   automatically adapts to light/dark menu bar appearances.\n * - Windows/Linux: switch between black/white assets based on the OS theme.\n *\n * Tray icon assets are expected in the built dist root (copied from /public),\n * alongside splash.html.\n */\nfunction getTrayIconPath(): string {\n  if (process.platform === \"darwin\") {\n    return path.join(__dirname, \"../tray-icon-black.png\");\n  }\n\n  const fileName = nativeTheme.shouldUseDarkColors ? \"tray-icon-white.png\" : \"tray-icon-black.png\";\n  return path.join(__dirname, `../${fileName}`);\n}\n\nfunction loadTrayIconImage() {\n  const iconPath = getTrayIconPath();\n\n  // Tray icons are 24×24 PNGs with cropped viewBox. We manually add @2x and\n  // @3x representations so macOS picks the sharpest variant for the display's\n  // scale factor. Electron auto-detects @2x from the path naming convention\n  // but only when both files exist – and it doesn't look for @3x at all.\n  const image = nativeImage.createFromPath(iconPath);\n\n  if (image.isEmpty()) {\n    console.warn(`[${timestamp()}] [tray] Tray icon missing or unreadable: ${iconPath}`);\n    return null;\n  }\n\n  for (const scaleFactor of [2, 3] as const) {\n    const hqPath = iconPath.replace(/\\.png$/, `@${scaleFactor}x.png`);\n    const hqImage = nativeImage.createFromPath(hqPath);\n    if (!hqImage.isEmpty()) {\n      image.addRepresentation({ scaleFactor, buffer: hqImage.toPNG() });\n    }\n  }\n\n  if (process.platform === \"darwin\") {\n    image.setTemplateImage(true);\n  }\n\n  return image;\n}\n\nfunction openMuxFromTray() {\n  if (mainWindow) {\n    if (mainWindow.isMinimized()) mainWindow.restore();\n    mainWindow.show();\n    mainWindow.focus();\n    return;\n  }\n\n  // On macOS the app stays open after all windows are closed; recreate the window.\n  if (process.platform === \"darwin\") {\n    if (!services) {\n      console.warn(`[${timestamp()}] [tray] Cannot open mux (services not loaded yet)`);\n      return;\n    }\n\n    createWindow();\n  }\n}\n\nfunction updateTrayIcon() {\n  if (!tray) return;\n\n  const image = loadTrayIconImage();\n  if (!image) {\n    return;\n  }\n\n  tray.setImage(image);\n}\n\nfunction createTray() {\n  if (tray) return;\n\n  const image = loadTrayIconImage();\n  if (!image) {\n    console.warn(`[${timestamp()}] [tray] Skipping tray creation (icon unavailable)`);\n    return;\n  }\n\n  try {\n    tray = new Tray(image);\n  } catch (error) {\n    console.warn(`[${timestamp()}] [tray] Failed to create tray:`, error);\n    tray = null;\n    return;\n  }\n\n  const menu = Menu.buildFromTemplate([\n    {\n      label: \"Open mux\",\n      click: () => {\n        openMuxFromTray();\n      },\n    },\n    {\n      label: \"Exit\",\n      click: () => {\n        app.quit();\n      },\n    },\n  ]);\n\n  tray.setContextMenu(menu);\n\n  // Best-effort: update tray icon when OS appearance changes.\n  nativeTheme.on(\"updated\", () => {\n    updateTrayIcon();\n  });\n}\n\n/**\n * Create and show splash screen - instant visual feedback (<100ms)\n *\n * Shows a lightweight native window with static HTML while services load.\n * No IPC, no React, no heavy dependencies - just immediate user feedback.\n */\nasync function showSplashScreen() {\n  const startTime = Date.now();\n  console.log(`[${timestamp()}] Showing splash screen...`);\n\n  splashWindow = new BrowserWindow({\n    width: 400,\n    height: 300,\n    frame: false,\n    transparent: false,\n    backgroundColor: \"#1f1f1f\", // Match splash HTML background (hsl(0 0% 12%)) - prevents white flash\n    alwaysOnTop: true,\n    center: true,\n    resizable: false,\n    show: false, // Don't show until HTML is loaded\n    webPreferences: {\n      nodeIntegration: false,\n      contextIsolation: true,\n    },\n  });\n\n  // Wait for splash HTML to load\n  await splashWindow.loadFile(path.join(__dirname, \"../splash.html\"));\n\n  // Wait for the window to actually be shown and rendered before continuing\n  // This ensures the splash is visible before we block the event loop with heavy work\n  await new Promise<void>((resolve) => {\n    splashWindow!.once(\"show\", () => {\n      const loadTime = Date.now() - startTime;\n      console.log(`[${timestamp()}] Splash screen shown (${loadTime}ms)`);\n      // Give one more event loop tick for the window to actually paint\n      setImmediate(resolve);\n    });\n    splashWindow!.show();\n  });\n\n  splashWindow.on(\"closed\", () => {\n    console.log(`[${timestamp()}] Splash screen closed event`);\n    splashWindow = null;\n  });\n}\n\n/**\n * Close splash screen\n */\nfunction closeSplashScreen() {\n  if (splashWindow) {\n    console.log(`[${timestamp()}] Closing splash screen...`);\n    splashWindow.close();\n    splashWindow = null;\n  }\n}\n\n/**\n * Load backend services (Config, ServiceContainer, AI SDK, tokenizer)\n *\n * Heavy initialization (~100ms) happens here while splash is visible.\n * Note: Spinner may freeze briefly during this phase. This is acceptable since\n * the splash still provides visual feedback that the app is loading.\n */\nasync function loadServices(): Promise<void> {\n  if (config && services) return; // Already loaded\n\n  const startTime = Date.now();\n  console.log(`[${timestamp()}] Loading services...`);\n\n  /* eslint-disable no-restricted-syntax */\n  // Dynamic imports are justified here for performance:\n  // - ServiceContainer transitively imports the entire AI SDK (ai, @ai-sdk/anthropic, etc.)\n  // - These are large modules (~100ms load time) that would block splash from appearing\n  // - Loading happens once, then cached\n  const [\n    { Config: ConfigClass },\n    { ServiceContainer: ServiceContainerClass },\n    { TerminalWindowManager: TerminalWindowManagerClass },\n  ] = await Promise.all([\n    import(\"@/node/config\"),\n    import(\"@/node/services/serviceContainer\"),\n    import(\"@/desktop/terminalWindowManager\"),\n  ]);\n  /* eslint-enable no-restricted-syntax */\n  config = new ConfigClass();\n\n  services = new ServiceContainerClass(config);\n  await services.initialize();\n\n  // Generate auth token (use env var or random per-session)\n  const authToken = process.env.MUX_SERVER_AUTH_TOKEN ?? randomBytes(32).toString(\"hex\");\n\n  // Store auth token so the API server can be restarted via Settings.\n  services.serverService.setApiAuthToken(authToken);\n\n  // Single router instance with auth middleware - used for both MessagePort and HTTP/WS\n  const orpcRouter = router(authToken);\n\n  const orpcHandler = new RPCHandler(orpcRouter, {\n    interceptors: [\n      onError((error, options) => {\n        const formatted = formatOrpcError(error, options);\n        console.error(formatted.message);\n      }),\n    ],\n  });\n\n  const orpcContext = services.toORPCContext();\n\n  // Track API server base URL for frontend icon resolution\n  let apiServerBaseUrl: string | null = null;\n\n  electronIpcMain.handle(\"mux:get-api-server-url\", () => {\n    return apiServerBaseUrl;\n  });\n\n  electronIpcMain.handle(\"mux:get-is-rosetta\", async () => {\n    if (process.platform !== \"darwin\") {\n      return false;\n    }\n\n    try {\n      // Intentionally lazy import to keep startup fast and avoid bundling concerns.\n      // eslint-disable-next-line no-restricted-syntax -- main-process-only builtin\n      const { execSync } = await import(\"node:child_process\");\n      const result = execSync(\"sysctl -n sysctl.proc_translated\", { encoding: \"utf8\" }).trim();\n      return result === \"1\";\n    } catch {\n      return false;\n    }\n  });\n  electronIpcMain.handle(\"mux:get-is-windows-wsl-shell\", async () => {\n    if (process.platform !== \"win32\") return false;\n\n    const normalize = (p: string) => p.replace(/\\//g, \"\\\\\").toLowerCase();\n    const isWslLauncher = (p: string) => {\n      const base = path.win32.basename(p);\n      return (\n        p === \"wsl\" ||\n        base === \"wsl.exe\" ||\n        p === \"bash\" ||\n        p === \"bash.exe\" ||\n        p.endsWith(\"\\\\windows\\\\system32\\\\bash.exe\")\n      );\n    };\n\n    // Check if the default shell appears to be WSL.\n    let looksLikeWsl = false;\n\n    const envShell = process.env.SHELL?.trim();\n    if (envShell && isWslLauncher(normalize(envShell))) {\n      looksLikeWsl = true;\n    } else {\n      try {\n        // Intentionally lazy import to keep startup fast and avoid bundling concerns.\n        // eslint-disable-next-line no-restricted-syntax -- main-process-only builtin\n        const { execSync } = await import(\"node:child_process\");\n        const result = execSync(\"where bash\", {\n          encoding: \"utf8\",\n          stdio: [\"pipe\", \"pipe\", \"ignore\"],\n          windowsHide: true,\n        });\n        const firstPath = result\n          .split(/\\r?\\n/)\n          .map((line) => line.trim())\n          .find((line) => line.length > 0);\n\n        looksLikeWsl = firstPath ? isWslLauncher(normalize(firstPath)) : false;\n      } catch {\n        // Ignore\n      }\n    }\n\n    // Even if WSL is the default, don't warn if Git for Windows bash is available\n    // (Mux will use that instead).\n    if (looksLikeWsl && isBashAvailable()) {\n      return false;\n    }\n\n    return looksLikeWsl;\n  });\n\n  electronIpcMain.on(\"start-orpc-server\", (event) => {\n    const [serverPort] = event.ports;\n    orpcHandler.upgrade(serverPort, {\n      context: {\n        ...orpcContext,\n        // Inject synthetic auth header so auth middleware passes\n        headers: { authorization: `Bearer ${authToken}` },\n      },\n    });\n    serverPort.start();\n  });\n\n  // Start HTTP/WS API server for CLI access (unless explicitly disabled)\n  if (process.env.MUX_NO_API_SERVER !== \"1\") {\n    const lockfile = new ServerLockfile(config.rootDir);\n    const existing = await lockfile.read();\n\n    if (existing) {\n      apiServerBaseUrl = existing.baseUrl;\n      console.log(`[${timestamp()}] API server already running at ${existing.baseUrl}, skipping`);\n    } else {\n      try {\n        const loadedConfig = config.loadConfigOrDefault();\n        const configuredBindHost =\n          typeof loadedConfig.apiServerBindHost === \"string\" &&\n          loadedConfig.apiServerBindHost.trim()\n            ? loadedConfig.apiServerBindHost.trim()\n            : undefined;\n        const serveStatic = loadedConfig.apiServerServeWebUi === true;\n        const configuredPort = loadedConfig.apiServerPort;\n\n        const envPortRaw = process.env.MUX_SERVER_PORT\n          ? Number.parseInt(process.env.MUX_SERVER_PORT, 10)\n          : undefined;\n        const envPort =\n          envPortRaw !== undefined && Number.isFinite(envPortRaw) ? envPortRaw : undefined;\n\n        const port = envPort ?? configuredPort ?? 0;\n        const host = configuredBindHost ?? \"127.0.0.1\";\n\n        const serverInfo = await services.serverService.startServer({\n          muxHome: config.rootDir,\n          context: orpcContext,\n          router: orpcRouter,\n          authToken,\n          host,\n          serveStatic,\n          port,\n        });\n        apiServerBaseUrl = serverInfo.baseUrl;\n        console.log(`[${timestamp()}] API server started at ${serverInfo.baseUrl}`);\n      } catch (error) {\n        console.error(`[${timestamp()}] Failed to start API server:`, error);\n        // Non-fatal - continue without API server\n      }\n    }\n  }\n\n  // Set TerminalWindowManager for desktop mode (pop-out terminal windows)\n  const terminalWindowManager = new TerminalWindowManagerClass(config);\n  services.setProjectDirectoryPicker(async () => {\n    const win = BrowserWindow.getFocusedWindow();\n    if (!win) return null;\n\n    const res = await dialog.showOpenDialog(win, {\n      properties: [\"openDirectory\", \"createDirectory\", \"showHiddenFiles\"],\n      title: \"Select Project Directory\",\n      buttonLabel: \"Select Project\",\n    });\n\n    return res.canceled || res.filePaths.length === 0 ? null : res.filePaths[0];\n  });\n\n  services.setTerminalWindowManager(terminalWindowManager);\n\n  loadTokenizerModules().catch((error) => {\n    console.error(\"Failed to preload tokenizer modules:\", error);\n  });\n\n  // Initialize updater service in packaged builds or when DEBUG_UPDATER is set\n  // Moved to UpdateService (services.updateService)\n\n  const loadTime = Date.now() - startTime;\n  console.log(`[${timestamp()}] Services loaded in ${loadTime}ms`);\n}\n\nfunction createWindow() {\n  assert(services, \"Services must be loaded before creating window\");\n\n  mainWindowFinishedLoading = false;\n\n  // Calculate default window size (80% of screen)\n  const primaryDisplay = screen.getPrimaryDisplay();\n  const { width: screenWidth, height: screenHeight } = primaryDisplay.workArea;\n\n  // Load saved window state with fallback to defaults\n  const windowState = windowStateKeeper({\n    defaultWidth: Math.max(1200, Math.floor(screenWidth * 0.8)),\n    defaultHeight: Math.max(800, Math.floor(screenHeight * 0.8)),\n  });\n\n  console.log(`[${timestamp()}] [window] Creating BrowserWindow...`);\n\n  mainWindow = new BrowserWindow({\n    x: windowState.x,\n    y: windowState.y,\n    width: windowState.width,\n    height: windowState.height,\n    webPreferences: {\n      nodeIntegration: false,\n      contextIsolation: true,\n      devTools: true,\n      preload: path.join(__dirname, \"../preload.js\"),\n    },\n    title: \"mux - coder multiplexer\",\n    // Hide menu bar on Linux by default (like VS Code)\n    // User can press Alt to toggle it\n    autoHideMenuBar: process.platform === \"linux\",\n    show: false, // Don't show until ready-to-show event\n    // VSCode-like integrated titlebar (hidden native titlebar with native window controls)\n    ...getTitleBarOptions(),\n  });\n\n  // Track window state (handles resize, move, maximize, fullscreen)\n  windowState.manage(mainWindow);\n\n  // Register window service with the main window\n  console.log(`[${timestamp()}] [window] Registering window service...`);\n  services.windowService.setMainWindow(mainWindow);\n\n  mainWindow.on(\"close\", (event) => {\n    // Close-to-tray behavior: when the user closes the main window, keep mux\n    // running in the tray/menu bar so it can be re-opened from there.\n    //\n    // Only hide when the tray exists to avoid trapping the user with no UI path\n    // to restore the app.\n    if (isQuitting || !tray) {\n      return;\n    }\n\n    event.preventDefault();\n    mainWindow?.hide();\n  });\n\n  // Show window once it's ready and close splash\n  console.time(\"main window startup\");\n  mainWindow.once(\"ready-to-show\", () => {\n    console.log(`[${timestamp()}] Main window ready to show`);\n    mainWindow?.show();\n    mainWindow?.webContents.openDevTools();\n    closeSplashScreen();\n    console.timeEnd(\"main window startup\");\n  });\n\n  // Open all external links in default browser\n  mainWindow.webContents.setWindowOpenHandler(({ url }) => {\n    void shell.openExternal(url);\n    return { action: \"deny\" };\n  });\n\n  mainWindow.webContents.on(\"will-navigate\", (event, url) => {\n    const currentOrigin = new URL(mainWindow!.webContents.getURL()).origin;\n    const targetOrigin = new URL(url).origin;\n    // Prevent navigation away from app origin, open externally instead\n    if (targetOrigin !== currentOrigin) {\n      event.preventDefault();\n      void shell.openExternal(url);\n    }\n  });\n\n  // Load from dev server in development, built files in production\n  // app.isPackaged is true when running from a built .app/.exe, false in development\n  console.log(`[${timestamp()}] [window] Loading content...`);\n  console.time(\"[window] Content load\");\n  if ((isE2ETest && !forceDistLoad) || (!app.isPackaged && !forceDistLoad)) {\n    // Development mode: load from vite dev server\n    const devHost = process.env.MUX_DEVSERVER_HOST ?? \"127.0.0.1\";\n    const url = `http://${devHost}:${devServerPort}`;\n    console.log(`[${timestamp()}] [window] Loading from dev server: ${url}`);\n    void mainWindow.loadURL(url);\n    if (!isE2ETest) {\n      mainWindow.webContents.once(\"did-finish-load\", () => {\n        mainWindow?.webContents.openDevTools();\n      });\n    }\n  } else {\n    // Production mode: load built files\n    const htmlPath = path.join(__dirname, \"../index.html\");\n    console.log(`[${timestamp()}] [window] Loading from file: ${htmlPath}`);\n    void mainWindow.loadFile(htmlPath);\n\n    // Open DevTools in production too (per user request)\n    mainWindow.webContents.once(\"did-finish-load\", () => {\n      mainWindow?.webContents.openDevTools();\n    });\n  }\n\n  // Track when content finishes loading\n  mainWindow.webContents.once(\"did-finish-load\", () => {\n    console.timeEnd(\"[window] Content load\");\n    console.log(`[${timestamp()}] [window] Content finished loading`);\n\n    mainWindowFinishedLoading = true;\n    flushBufferedMuxDeepLinks();\n\n    // NOTE: Tokenizer modules are NOT loaded at startup anymore!\n    // The Proxy in tokenizer.ts loads them on-demand when first accessed.\n    // This reduces startup time from ~8s to <1s.\n    // First token count will use approximation, accurate count caches in background.\n  });\n\n  mainWindow.on(\"closed\", () => {\n    mainWindow = null;\n    mainWindowFinishedLoading = false;\n  });\n}\n\n// Only setup app handlers if we got the lock\nif (gotTheLock) {\n  void app.whenReady().then(async () => {\n    try {\n      console.log(\"App ready, creating window...\");\n\n      registerMuxProtocolClient();\n\n      // Migrate from .cmux to .mux directory structure if needed\n      migrateLegacyMuxHome();\n\n      // Install React DevTools in development\n      if (!app.isPackaged) {\n        try {\n          const { default: installExtension, REACT_DEVELOPER_TOOLS } =\n            // eslint-disable-next-line no-restricted-syntax -- dev-only dependency, intentionally lazy-loaded\n            await import(\"electron-devtools-installer\");\n          const extension = await installExtension(REACT_DEVELOPER_TOOLS, {\n            loadExtensionOptions: { allowFileAccess: true },\n          });\n          console.log(`✅ React DevTools installed: ${extension.name} (id: ${extension.id})`);\n        } catch (err) {\n          console.log(\"❌ Error installing React DevTools:\", err);\n        }\n      }\n\n      createMenu();\n\n      // Three-phase startup:\n      // 1. Show splash immediately (<100ms) and wait for it to load\n      // 2. Load services while splash visible (fast - ~100ms)\n      // 3. Create window and start loading content (splash stays visible)\n      // 4. When window ready-to-show: close splash, show main window\n      //\n      // Skip splash in E2E tests to avoid app.firstWindow() grabbing the wrong window\n      if (!isE2ETest) {\n        await showSplashScreen(); // Wait for splash to actually load\n      }\n      await loadServices();\n      createWindow();\n      createTray();\n      // Note: splash closes in ready-to-show event handler\n\n      // Tokenizer modules load in background after did-finish-load event (see createWindow())\n    } catch (error) {\n      console.error(`[${timestamp()}] Startup failed:`, error);\n\n      closeSplashScreen();\n\n      // Show error dialog to user\n      const errorMessage =\n        error instanceof Error ? `${error.message}\\n\\n${error.stack ?? \"\"}` : String(error);\n\n      dialog.showErrorBox(\n        \"Startup Failed\",\n        `The application failed to start:\\n\\n${errorMessage}\\n\\nPlease check the console for details.`\n      );\n\n      // Quit after showing error\n      app.quit();\n    }\n  });\n\n  // Track if we're in the middle of disposing to prevent re-entry\n  let isDisposing = false;\n\n  app.on(\"before-quit\", (event) => {\n    // Ensure window close handlers don't block an explicit quit.\n    // IMPORTANT: must be set before any early returns.\n    isQuitting = true;\n\n    // Skip if already disposing or no services to clean up\n    if (isDisposing || !services) {\n      return;\n    }\n\n    // Prevent quit, clean up, then quit again\n    event.preventDefault();\n    isDisposing = true;\n\n    // Race dispose against timeout to ensure app quits even if disposal hangs\n    const disposePromise = services.dispose().catch((err) => {\n      console.error(\"Error during ServiceContainer dispose:\", err);\n    });\n    const timeoutPromise = new Promise<void>((resolve) => setTimeout(resolve, 5000));\n\n    void Promise.race([disposePromise, timeoutPromise]).finally(() => {\n      app.quit();\n    });\n  });\n\n  app.on(\"window-all-closed\", () => {\n    if (process.platform !== \"darwin\") {\n      app.quit();\n    }\n  });\n\n  app.on(\"before-quit\", () => {\n    console.log(`[${timestamp()}] App before-quit - cleaning up...`);\n    if (services) {\n      void services.serverService.stopServer();\n      void services.shutdown();\n    }\n  });\n\n  app.on(\"activate\", () => {\n    // Skip splash on reactivation - services already loaded, window creation is fast.\n    // Clicking the Dock icon should also re-open the existing window if it was\n    // hidden by close-to-tray.\n    // Guard: services must be loaded (prevents race if activate fires during startup).\n    if (app.isReady() && services) {\n      openMuxFromTray();\n    }\n  });\n}\n"]}