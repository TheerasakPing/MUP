{"version":3,"file":"main.js","sourceRoot":"","sources":["../../src/desktop/main.ts"],"names":[],"mappings":"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","sourcesContent":["// Enable source map support for better error stack traces in production\r\nimport \"source-map-support/register\";\r\n\r\n// Fix PATH on macOS when launched from Finder (not terminal).\r\n// GUI apps inherit minimal PATH from launchd, missing Homebrew tools like git-lfs.\r\n// Must run before any child process spawns. Failures are silently ignored.\r\nif (process.platform === \"darwin\") {\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/no-require-imports\r\n    (require(\"fix-path\") as { default: () => void }).default();\r\n  } catch (e) {\r\n    // App works with existing PATH; debug log for troubleshooting\r\n    console.debug(\"[fix-path] Failed to enrich PATH:\", e);\r\n  }\r\n}\r\n\r\nimport { randomBytes } from \"crypto\";\r\nimport { RPCHandler } from \"@orpc/server/message-port\";\r\nimport { onError } from \"@orpc/server\";\r\nimport { router } from \"@/node/orpc/router\";\r\nimport { formatOrpcError } from \"@/node/orpc/formatOrpcError\";\r\nimport { ServerLockfile } from \"@/node/services/serverLockfile\";\r\nimport \"disposablestack/auto\";\r\n\r\nimport type { MenuItemConstructorOptions } from \"electron\";\r\nimport {\r\n  app,\r\n  BrowserWindow,\r\n  ipcMain as electronIpcMain,\r\n  Menu,\r\n  Tray,\r\n  dialog,\r\n  nativeImage,\r\n  nativeTheme,\r\n  screen,\r\n  shell,\r\n} from \"electron\";\r\n\r\n// Increase renderer V8 heap limit from default ~4GB to 8GB.\r\n// At ~3.9GB usage, the default limit causes frequent Mark-Compact GC cycles\r\n// with low mutator utilization (~39%), degrading UI responsiveness.\r\n// Must be called before app.whenReady().\r\napp.commandLine.appendSwitch(\"js-flags\", \"--max-old-space-size=8192\");\r\n\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { ServiceContainer } from \"@/node/services/serviceContainer\";\r\nimport { VERSION } from \"@/version\";\r\nimport { getMuxHome, migrateLegacyMuxHome } from \"@/common/constants/paths\";\r\nimport type { MuxDeepLinkPayload } from \"@/common/types/deepLink\";\r\nimport { parseMuxDeepLink } from \"@/common/utils/deepLink\";\r\n\r\nimport assert from \"@/common/utils/assert\";\r\nimport { loadTokenizerModules } from \"@/node/utils/main/tokenizer\";\r\nimport { isBashAvailable } from \"@/node/utils/main/bashPath\";\r\nimport windowStateKeeper from \"electron-window-state\";\r\nimport { getTitleBarOptions } from \"@/desktop/titleBarOptions\";\r\n\r\n// React DevTools for development profiling\r\n// Using dynamic import() to avoid loading electron-devtools-installer at module init time\r\n\r\n// IMPORTANT: Lazy-load heavy dependencies to maintain fast startup time\r\n//\r\n// To keep startup time under 4s, avoid importing AI SDK packages at the top level.\r\n// These files MUST use dynamic import():\r\n//   - main.ts, config.ts, preload.ts (startup-critical)\r\n//\r\n// ✅ GOOD: const { createAnthropic } = await import(\"@ai-sdk/anthropic\");\r\n// ❌ BAD:  import { createAnthropic } from \"@ai-sdk/anthropic\";\r\n//\r\n// Enforcement: scripts/check_eager_imports.sh validates this in CI\r\n//\r\n// Lazy-load Config and ServiceContainer to avoid loading heavy AI SDK dependencies at startup\r\n// These will be loaded on-demand when createWindow() is called\r\nlet config: Config | null = null;\r\nlet services: ServiceContainer | null = null;\r\nconst isE2ETest = process.env.MUX_E2E === \"1\";\r\nconst forceDistLoad = process.env.MUX_E2E_LOAD_DIST === \"1\";\r\n\r\nif (isE2ETest) {\r\n  // For e2e tests, use a test-specific userData directory\r\n  // Note: getMuxHome() already respects MUX_ROOT for test isolation\r\n  const e2eUserData = path.join(getMuxHome(), \"user-data\");\r\n  try {\r\n    fs.mkdirSync(e2eUserData, { recursive: true });\r\n    app.setPath(\"userData\", e2eUserData);\r\n    console.log(\"Using test userData directory:\", e2eUserData);\r\n  } catch (error) {\r\n    console.warn(\"Failed to prepare test userData directory:\", error);\r\n  }\r\n}\r\n\r\nconst devServerPort = process.env.MUX_DEVSERVER_PORT ?? \"5173\";\r\n\r\nconsole.log(\r\n  `Mux starting - version: ${(VERSION as { git?: string; buildTime?: string }).git ?? \"(dev)\"} (built: ${(VERSION as { git?: string; buildTime?: string }).buildTime ?? \"dev-mode\"})`\r\n);\r\nconsole.log(\"Main process starting...\");\r\n\r\n// Debug: abort immediately if MUX_DEBUG_START_TIME is set\r\n// This is used to measure baseline startup time without full initialization\r\nif (process.env.MUX_DEBUG_START_TIME === \"1\") {\r\n  console.log(\"MUX_DEBUG_START_TIME is set - aborting immediately\");\r\n  process.exit(0);\r\n}\r\n\r\n// Global error handlers for better error reporting\r\nprocess.on(\"uncaughtException\", (error: unknown) => {\r\n  console.error(\"Uncaught Exception:\", error);\r\n\r\n  const message = error instanceof Error ? error.message : String(error);\r\n  const stack = error instanceof Error ? error.stack : undefined;\r\n\r\n  console.error(\"Stack:\", stack);\r\n\r\n  // Show error dialog in production\r\n  if (app.isPackaged) {\r\n    dialog.showErrorBox(\r\n      \"Application Error\",\r\n      `An unexpected error occurred:\\n\\n${message}\\n\\nStack trace:\\n${stack ?? \"No stack trace available\"}`\r\n    );\r\n  }\r\n});\r\n\r\nprocess.on(\"unhandledRejection\", (reason, promise) => {\r\n  console.error(\"Unhandled Rejection at:\", promise);\r\n  console.error(\"Reason:\", reason);\r\n\r\n  if (app.isPackaged) {\r\n    const message = reason instanceof Error ? reason.message : String(reason);\r\n    const stack = reason instanceof Error ? reason.stack : undefined;\r\n    dialog.showErrorBox(\r\n      \"Unhandled Promise Rejection\",\r\n      `An unhandled promise rejection occurred:\\n\\n${message}\\n\\nStack trace:\\n${stack ?? \"No stack trace available\"}`\r\n    );\r\n  }\r\n});\r\n\r\n// Single instance lock (can be disabled for development with CMUX_ALLOW_MULTIPLE_INSTANCES=1)\r\nconst allowMultipleInstances = process.env.CMUX_ALLOW_MULTIPLE_INSTANCES === \"1\";\r\nconst gotTheLock = allowMultipleInstances || app.requestSingleInstanceLock();\r\nconsole.log(\"Single instance lock acquired:\", gotTheLock);\r\n\r\nif (!gotTheLock) {\r\n  // Another instance is already running, quit this one\r\n  console.log(\"Another instance is already running, quitting...\");\r\n  app.quit();\r\n} else {\r\n  // This is the primary instance\r\n  console.log(\"This is the primary instance\");\r\n  app.on(\"second-instance\", (_event, argv) => {\r\n    // Someone tried to run a second instance, focus our window instead\r\n    console.log(\"Second instance attempted to start\");\r\n\r\n    try {\r\n      handleArgvMuxDeepLinks(argv);\r\n    } catch (error) {\r\n      console.debug(\"[deep-link] Failed to parse second-instance argv for mux deep links:\", error);\r\n    }\r\n\r\n    focusMainWindow();\r\n  });\r\n}\r\n\r\nlet mainWindow: BrowserWindow | null = null;\r\nlet splashWindow: BrowserWindow | null = null;\r\nlet tray: Tray | null = null;\r\nlet isQuitting = false;\r\n\r\n// mux:// deep links can arrive before the main window exists / finishes loading.\r\nconst bufferedMuxDeepLinks: MuxDeepLinkPayload[] = [];\r\nlet mainWindowFinishedLoading = false;\r\n\r\nfunction focusMainWindow() {\r\n  if (!mainWindow) return;\r\n  if (mainWindow.isMinimized()) mainWindow.restore();\r\n  // Closing Mux on Windows hides to tray; show it again when a second-instance launch occurs.\r\n  mainWindow.show();\r\n  mainWindow.focus();\r\n}\r\n\r\nfunction flushBufferedMuxDeepLinks() {\r\n  if (!mainWindow || !mainWindowFinishedLoading) return;\r\n\r\n  while (bufferedMuxDeepLinks.length > 0) {\r\n    const payload = bufferedMuxDeepLinks[0];\r\n    try {\r\n      mainWindow.webContents.send(\"mux:deep-link\", payload);\r\n      bufferedMuxDeepLinks.shift();\r\n    } catch (error) {\r\n      // Best-effort: never crash startup if the renderer isn't ready.\r\n      console.debug(\"[deep-link] Failed to send mux deep link payload:\", error);\r\n      return;\r\n    }\r\n  }\r\n}\r\n\r\nfunction handleMuxDeepLink(raw: string) {\r\n  try {\r\n    const payload = parseMuxDeepLink(raw);\r\n    if (!payload) return;\r\n\r\n    // Buffer until the renderer has finished loading.\r\n    if (!mainWindow || !mainWindowFinishedLoading) {\r\n      bufferedMuxDeepLinks.push(payload);\r\n      return;\r\n    }\r\n\r\n    mainWindow.webContents.send(\"mux:deep-link\", payload);\r\n  } catch (error) {\r\n    // Best-effort: never crash startup if argv parsing/protocol handling is weird.\r\n    console.debug(`[deep-link] Failed to handle mux deep link: ${raw}`, error);\r\n  }\r\n}\r\n\r\nfunction handleArgvMuxDeepLinks(argv: string[]) {\r\n  for (const arg of argv) {\r\n    if (arg.startsWith(\"mux:\")) {\r\n      handleMuxDeepLink(arg);\r\n    }\r\n  }\r\n}\r\n\r\n// macOS deep links arrive via open-url (must be registered before ready)\r\nif (process.platform === \"darwin\") {\r\n  app.on(\"open-url\", (event, url) => {\r\n    event.preventDefault();\r\n    handleMuxDeepLink(url);\r\n    focusMainWindow();\r\n  });\r\n}\r\n\r\n// Initial launch: Windows/Linux deep links are passed in argv.\r\ntry {\r\n  handleArgvMuxDeepLinks(process.argv);\r\n} catch (error) {\r\n  console.debug(\"[deep-link] Failed to parse initial argv for mux deep links:\", error);\r\n}\r\n\r\nfunction registerMuxProtocolClient() {\r\n  try {\r\n    if (!app.isPackaged && process.defaultApp && process.argv[1]) {\r\n      // On Windows dev builds, Electron needs the executable + app path to register.\r\n      app.setAsDefaultProtocolClient(\"mux\", process.execPath, [path.resolve(process.argv[1])]);\r\n      return;\r\n    }\r\n\r\n    app.setAsDefaultProtocolClient(\"mux\");\r\n  } catch (error) {\r\n    // Best-effort: never crash startup if protocol registration fails.\r\n    console.debug(\"[deep-link] Failed to register mux:// protocol handler:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Format timestamp as HH:MM:SS.mmm for readable logging\r\n */\r\nfunction timestamp(): string {\r\n  const now = new Date();\r\n  const hours = String(now.getHours()).padStart(2, \"0\");\r\n  const minutes = String(now.getMinutes()).padStart(2, \"0\");\r\n  const seconds = String(now.getSeconds()).padStart(2, \"0\");\r\n  const ms = String(now.getMilliseconds()).padStart(3, \"0\");\r\n  return `${hours}:${minutes}:${seconds}.${ms}`;\r\n}\r\n\r\nfunction createMenu() {\r\n  const template: MenuItemConstructorOptions[] = [\r\n    {\r\n      label: \"Edit\",\r\n      submenu: [\r\n        { role: \"undo\" },\r\n        { role: \"redo\" },\r\n        { type: \"separator\" },\r\n        { role: \"cut\" },\r\n        { role: \"copy\" },\r\n        { role: \"paste\" },\r\n        { role: \"selectAll\" },\r\n      ],\r\n    },\r\n    {\r\n      label: \"View\",\r\n      submenu: [\r\n        // Reload without Ctrl+R shortcut (reserved for Code Review refresh)\r\n        {\r\n          label: \"Reload\",\r\n          click: (_item, focusedWindow) => {\r\n            if (focusedWindow && \"reload\" in focusedWindow) {\r\n              (focusedWindow as BrowserWindow).reload();\r\n            }\r\n          },\r\n        },\r\n        { role: \"forceReload\" },\r\n        { role: \"toggleDevTools\" },\r\n        { type: \"separator\" },\r\n        { role: \"resetZoom\" },\r\n        { role: \"zoomIn\" },\r\n        { role: \"zoomOut\" },\r\n        { type: \"separator\" },\r\n        {\r\n          role: \"togglefullscreen\",\r\n          accelerator: process.platform === \"darwin\" ? \"Ctrl+Command+F\" : \"F11\",\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      label: \"Window\",\r\n      submenu: [{ role: \"minimize\" }, { role: \"close\" }],\r\n    },\r\n  ];\r\n\r\n  if (process.platform === \"darwin\") {\r\n    template.unshift({\r\n      label: app.getName(),\r\n      submenu: [\r\n        { role: \"about\" },\r\n        { type: \"separator\" },\r\n        {\r\n          label: \"Settings...\",\r\n          accelerator: \"Cmd+,\",\r\n          click: () => {\r\n            services?.menuEventService.emitOpenSettings();\r\n          },\r\n        },\r\n        { type: \"separator\" },\r\n        { role: \"services\", submenu: [] },\r\n        { type: \"separator\" },\r\n        { role: \"hide\" },\r\n        { role: \"hideOthers\" },\r\n        { role: \"unhide\" },\r\n        { type: \"separator\" },\r\n        { role: \"quit\" },\r\n      ],\r\n    });\r\n  }\r\n\r\n  const menu = Menu.buildFromTemplate(template);\r\n  Menu.setApplicationMenu(menu);\r\n}\r\n\r\n/**\r\n * System tray (Windows/Linux) / menu bar (macOS) icon.\r\n *\r\n * - macOS: use a template image (always the black asset) so the system\r\n *   automatically adapts to light/dark menu bar appearances.\r\n * - Windows/Linux: switch between black/white assets based on the OS theme.\r\n *\r\n * Tray icon assets are expected in the built dist root (copied from /public),\r\n * alongside splash.html.\r\n */\r\nfunction getTrayIconPath(): string {\r\n  if (process.platform === \"darwin\") {\r\n    return path.join(__dirname, \"../tray-icon-black.png\");\r\n  }\r\n\r\n  const fileName = nativeTheme.shouldUseDarkColors ? \"tray-icon-white.png\" : \"tray-icon-black.png\";\r\n  return path.join(__dirname, `../${fileName}`);\r\n}\r\n\r\nfunction loadTrayIconImage() {\r\n  const iconPath = getTrayIconPath();\r\n\r\n  // Tray icons are 24×24 PNGs with cropped viewBox. We manually add @2x and\r\n  // @3x representations so macOS picks the sharpest variant for the display's\r\n  // scale factor. Electron auto-detects @2x from the path naming convention\r\n  // but only when both files exist – and it doesn't look for @3x at all.\r\n  const image = nativeImage.createFromPath(iconPath);\r\n\r\n  if (image.isEmpty()) {\r\n    console.warn(`[${timestamp()}] [tray] Tray icon missing or unreadable: ${iconPath}`);\r\n    return null;\r\n  }\r\n\r\n  for (const scaleFactor of [2, 3] as const) {\r\n    const hqPath = iconPath.replace(/\\.png$/, `@${scaleFactor}x.png`);\r\n    const hqImage = nativeImage.createFromPath(hqPath);\r\n    if (!hqImage.isEmpty()) {\r\n      image.addRepresentation({ scaleFactor, buffer: hqImage.toPNG() });\r\n    }\r\n  }\r\n\r\n  if (process.platform === \"darwin\") {\r\n    image.setTemplateImage(true);\r\n  }\r\n\r\n  return image;\r\n}\r\n\r\nfunction openMuxFromTray() {\r\n  if (mainWindow) {\r\n    if (mainWindow.isMinimized()) mainWindow.restore();\r\n    mainWindow.show();\r\n    mainWindow.focus();\r\n    return;\r\n  }\r\n\r\n  // On macOS the app stays open after all windows are closed; recreate the window.\r\n  if (process.platform === \"darwin\") {\r\n    if (!services) {\r\n      console.warn(`[${timestamp()}] [tray] Cannot open mux (services not loaded yet)`);\r\n      return;\r\n    }\r\n\r\n    createWindow();\r\n  }\r\n}\r\n\r\nfunction updateTrayIcon() {\r\n  if (!tray) return;\r\n\r\n  const image = loadTrayIconImage();\r\n  if (!image) {\r\n    return;\r\n  }\r\n\r\n  tray.setImage(image);\r\n}\r\n\r\nfunction createTray() {\r\n  if (tray) return;\r\n\r\n  const image = loadTrayIconImage();\r\n  if (!image) {\r\n    console.warn(`[${timestamp()}] [tray] Skipping tray creation (icon unavailable)`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    tray = new Tray(image);\r\n  } catch (error) {\r\n    console.warn(`[${timestamp()}] [tray] Failed to create tray:`, error);\r\n    tray = null;\r\n    return;\r\n  }\r\n\r\n  const menu = Menu.buildFromTemplate([\r\n    {\r\n      label: \"Open mux\",\r\n      click: () => {\r\n        openMuxFromTray();\r\n      },\r\n    },\r\n    {\r\n      label: \"Exit\",\r\n      click: () => {\r\n        app.quit();\r\n      },\r\n    },\r\n  ]);\r\n\r\n  tray.setContextMenu(menu);\r\n\r\n  // Best-effort: update tray icon when OS appearance changes.\r\n  nativeTheme.on(\"updated\", () => {\r\n    updateTrayIcon();\r\n  });\r\n}\r\n\r\n/**\r\n * Create and show splash screen - instant visual feedback (<100ms)\r\n *\r\n * Shows a lightweight native window with static HTML while services load.\r\n * No IPC, no React, no heavy dependencies - just immediate user feedback.\r\n */\r\nasync function showSplashScreen() {\r\n  const startTime = Date.now();\r\n  console.log(`[${timestamp()}] Showing splash screen...`);\r\n\r\n  splashWindow = new BrowserWindow({\r\n    width: 400,\r\n    height: 300,\r\n    frame: false,\r\n    transparent: false,\r\n    backgroundColor: \"#1f1f1f\", // Match splash HTML background (hsl(0 0% 12%)) - prevents white flash\r\n    alwaysOnTop: true,\r\n    center: true,\r\n    resizable: false,\r\n    show: false, // Don't show until HTML is loaded\r\n    webPreferences: {\r\n      nodeIntegration: false,\r\n      contextIsolation: true,\r\n    },\r\n  });\r\n\r\n  // Wait for splash HTML to load\r\n  await splashWindow.loadFile(path.join(__dirname, \"../splash.html\"));\r\n\r\n  // Wait for the window to actually be shown and rendered before continuing\r\n  // This ensures the splash is visible before we block the event loop with heavy work\r\n  await new Promise<void>((resolve) => {\r\n    splashWindow!.once(\"show\", () => {\r\n      const loadTime = Date.now() - startTime;\r\n      console.log(`[${timestamp()}] Splash screen shown (${loadTime}ms)`);\r\n      // Give one more event loop tick for the window to actually paint\r\n      setImmediate(resolve);\r\n    });\r\n    splashWindow!.show();\r\n  });\r\n\r\n  splashWindow.on(\"closed\", () => {\r\n    console.log(`[${timestamp()}] Splash screen closed event`);\r\n    splashWindow = null;\r\n  });\r\n}\r\n\r\n/**\r\n * Close splash screen\r\n */\r\nfunction closeSplashScreen() {\r\n  if (splashWindow) {\r\n    console.log(`[${timestamp()}] Closing splash screen...`);\r\n    splashWindow.close();\r\n    splashWindow = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Load backend services (Config, ServiceContainer, AI SDK, tokenizer)\r\n *\r\n * Heavy initialization (~100ms) happens here while splash is visible.\r\n * Note: Spinner may freeze briefly during this phase. This is acceptable since\r\n * the splash still provides visual feedback that the app is loading.\r\n */\r\nasync function loadServices(): Promise<void> {\r\n  if (config && services) return; // Already loaded\r\n\r\n  const startTime = Date.now();\r\n  console.log(`[${timestamp()}] Loading services...`);\r\n\r\n  /* eslint-disable no-restricted-syntax */\r\n  // Dynamic imports are justified here for performance:\r\n  // - ServiceContainer transitively imports the entire AI SDK (ai, @ai-sdk/anthropic, etc.)\r\n  // - These are large modules (~100ms load time) that would block splash from appearing\r\n  // - Loading happens once, then cached\r\n  const [\r\n    { Config: ConfigClass },\r\n    { ServiceContainer: ServiceContainerClass },\r\n    { TerminalWindowManager: TerminalWindowManagerClass },\r\n  ] = await Promise.all([\r\n    import(\"@/node/config\"),\r\n    import(\"@/node/services/serviceContainer\"),\r\n    import(\"@/desktop/terminalWindowManager\"),\r\n  ]);\r\n  /* eslint-enable no-restricted-syntax */\r\n  config = new ConfigClass();\r\n\r\n  services = new ServiceContainerClass(config);\r\n  await services.initialize();\r\n\r\n  // Generate auth token (use env var or random per-session)\r\n  const authToken = process.env.MUX_SERVER_AUTH_TOKEN ?? randomBytes(32).toString(\"hex\");\r\n\r\n  // Store auth token so the API server can be restarted via Settings.\r\n  services.serverService.setApiAuthToken(authToken);\r\n\r\n  // Single router instance with auth middleware - used for both MessagePort and HTTP/WS\r\n  const orpcRouter = router(authToken);\r\n\r\n  const orpcHandler = new RPCHandler(orpcRouter, {\r\n    interceptors: [\r\n      onError((error, options) => {\r\n        const formatted = formatOrpcError(error, options);\r\n        console.error(formatted.message);\r\n      }),\r\n    ],\r\n  });\r\n\r\n  const orpcContext = services.toORPCContext();\r\n\r\n  // Track API server base URL for frontend icon resolution\r\n  let apiServerBaseUrl: string | null = null;\r\n\r\n  electronIpcMain.handle(\"mux:get-api-server-url\", () => {\r\n    return apiServerBaseUrl;\r\n  });\r\n\r\n  electronIpcMain.handle(\"mux:get-is-rosetta\", async () => {\r\n    if (process.platform !== \"darwin\") {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      // Intentionally lazy import to keep startup fast and avoid bundling concerns.\r\n      // eslint-disable-next-line no-restricted-syntax -- main-process-only builtin\r\n      const { execSync } = await import(\"node:child_process\");\r\n      const result = execSync(\"sysctl -n sysctl.proc_translated\", { encoding: \"utf8\" }).trim();\r\n      return result === \"1\";\r\n    } catch {\r\n      return false;\r\n    }\r\n  });\r\n  electronIpcMain.handle(\"mux:get-is-windows-wsl-shell\", async () => {\r\n    if (process.platform !== \"win32\") return false;\r\n\r\n    const normalize = (p: string) => p.replace(/\\//g, \"\\\\\").toLowerCase();\r\n    const isWslLauncher = (p: string) => {\r\n      const base = path.win32.basename(p);\r\n      return (\r\n        p === \"wsl\" ||\r\n        base === \"wsl.exe\" ||\r\n        p === \"bash\" ||\r\n        p === \"bash.exe\" ||\r\n        p.endsWith(\"\\\\windows\\\\system32\\\\bash.exe\")\r\n      );\r\n    };\r\n\r\n    // Check if the default shell appears to be WSL.\r\n    let looksLikeWsl = false;\r\n\r\n    const envShell = process.env.SHELL?.trim();\r\n    if (envShell && isWslLauncher(normalize(envShell))) {\r\n      looksLikeWsl = true;\r\n    } else {\r\n      try {\r\n        // Intentionally lazy import to keep startup fast and avoid bundling concerns.\r\n        // eslint-disable-next-line no-restricted-syntax -- main-process-only builtin\r\n        const { execSync } = await import(\"node:child_process\");\r\n        const result = execSync(\"where bash\", {\r\n          encoding: \"utf8\",\r\n          stdio: [\"pipe\", \"pipe\", \"ignore\"],\r\n          windowsHide: true,\r\n        });\r\n        const firstPath = result\r\n          .split(/\\r?\\n/)\r\n          .map((line) => line.trim())\r\n          .find((line) => line.length > 0);\r\n\r\n        looksLikeWsl = firstPath ? isWslLauncher(normalize(firstPath)) : false;\r\n      } catch {\r\n        // Ignore\r\n      }\r\n    }\r\n\r\n    // Even if WSL is the default, don't warn if Git for Windows bash is available\r\n    // (Mux will use that instead).\r\n    if (looksLikeWsl && isBashAvailable()) {\r\n      return false;\r\n    }\r\n\r\n    return looksLikeWsl;\r\n  });\r\n\r\n  electronIpcMain.on(\"start-orpc-server\", (event) => {\r\n    const [serverPort] = event.ports;\r\n    orpcHandler.upgrade(serverPort, {\r\n      context: {\r\n        ...orpcContext,\r\n        // Inject synthetic auth header so auth middleware passes\r\n        headers: { authorization: `Bearer ${authToken}` },\r\n      },\r\n    });\r\n    serverPort.start();\r\n  });\r\n\r\n  // Start HTTP/WS API server for CLI access (unless explicitly disabled)\r\n  if (process.env.MUX_NO_API_SERVER !== \"1\") {\r\n    const lockfile = new ServerLockfile(config.rootDir);\r\n    const existing = await lockfile.read();\r\n\r\n    if (existing) {\r\n      apiServerBaseUrl = existing.baseUrl;\r\n      console.log(`[${timestamp()}] API server already running at ${existing.baseUrl}, skipping`);\r\n    } else {\r\n      try {\r\n        const loadedConfig = config.loadConfigOrDefault();\r\n        const configuredBindHost =\r\n          typeof loadedConfig.apiServerBindHost === \"string\" &&\r\n          loadedConfig.apiServerBindHost.trim()\r\n            ? loadedConfig.apiServerBindHost.trim()\r\n            : undefined;\r\n        const serveStatic = loadedConfig.apiServerServeWebUi === true;\r\n        const configuredPort = loadedConfig.apiServerPort;\r\n\r\n        const envPortRaw = process.env.MUX_SERVER_PORT\r\n          ? Number.parseInt(process.env.MUX_SERVER_PORT, 10)\r\n          : undefined;\r\n        const envPort =\r\n          envPortRaw !== undefined && Number.isFinite(envPortRaw) ? envPortRaw : undefined;\r\n\r\n        const port = envPort ?? configuredPort ?? 0;\r\n        const host = configuredBindHost ?? \"127.0.0.1\";\r\n\r\n        const serverInfo = await services.serverService.startServer({\r\n          muxHome: config.rootDir,\r\n          context: orpcContext,\r\n          router: orpcRouter,\r\n          authToken,\r\n          host,\r\n          serveStatic,\r\n          port,\r\n        });\r\n        apiServerBaseUrl = serverInfo.baseUrl;\r\n        console.log(`[${timestamp()}] API server started at ${serverInfo.baseUrl}`);\r\n      } catch (error) {\r\n        console.error(`[${timestamp()}] Failed to start API server:`, error);\r\n        // Non-fatal - continue without API server\r\n      }\r\n    }\r\n  }\r\n\r\n  // Set TerminalWindowManager for desktop mode (pop-out terminal windows)\r\n  const terminalWindowManager = new TerminalWindowManagerClass(config);\r\n  services.setProjectDirectoryPicker(async () => {\r\n    const win = BrowserWindow.getFocusedWindow();\r\n    if (!win) return null;\r\n\r\n    const res = await dialog.showOpenDialog(win, {\r\n      properties: [\"openDirectory\", \"createDirectory\", \"showHiddenFiles\"],\r\n      title: \"Select Project Directory\",\r\n      buttonLabel: \"Select Project\",\r\n    });\r\n\r\n    return res.canceled || res.filePaths.length === 0 ? null : res.filePaths[0];\r\n  });\r\n\r\n  services.setTerminalWindowManager(terminalWindowManager);\r\n\r\n  loadTokenizerModules().catch((error) => {\r\n    console.error(\"Failed to preload tokenizer modules:\", error);\r\n  });\r\n\r\n  // Initialize updater service in packaged builds or when DEBUG_UPDATER is set\r\n  // Moved to UpdateService (services.updateService)\r\n\r\n  const loadTime = Date.now() - startTime;\r\n  console.log(`[${timestamp()}] Services loaded in ${loadTime}ms`);\r\n}\r\n\r\nfunction createWindow() {\r\n  assert(services, \"Services must be loaded before creating window\");\r\n\r\n  mainWindowFinishedLoading = false;\r\n\r\n  // Calculate default window size (80% of screen)\r\n  const primaryDisplay = screen.getPrimaryDisplay();\r\n  const { width: screenWidth, height: screenHeight } = primaryDisplay.workArea;\r\n\r\n  // Load saved window state with fallback to defaults\r\n  const windowState = windowStateKeeper({\r\n    defaultWidth: Math.max(1200, Math.floor(screenWidth * 0.8)),\r\n    defaultHeight: Math.max(800, Math.floor(screenHeight * 0.8)),\r\n  });\r\n\r\n  console.log(`[${timestamp()}] [window] Creating BrowserWindow...`);\r\n\r\n  mainWindow = new BrowserWindow({\r\n    x: windowState.x,\r\n    y: windowState.y,\r\n    width: windowState.width,\r\n    height: windowState.height,\r\n    webPreferences: {\r\n      nodeIntegration: false,\r\n      contextIsolation: true,\r\n      devTools: true,\r\n      preload: path.join(__dirname, \"../preload.js\"),\r\n    },\r\n    title: \"mux - coder multiplexer\",\r\n    // Hide menu bar on Linux by default (like VS Code)\r\n    // User can press Alt to toggle it\r\n    autoHideMenuBar: process.platform === \"linux\",\r\n    show: false, // Don't show until ready-to-show event\r\n    // VSCode-like integrated titlebar (hidden native titlebar with native window controls)\r\n    ...getTitleBarOptions(),\r\n  });\r\n\r\n  // Track window state (handles resize, move, maximize, fullscreen)\r\n  windowState.manage(mainWindow);\r\n\r\n  // Register window service with the main window\r\n  console.log(`[${timestamp()}] [window] Registering window service...`);\r\n  services.windowService.setMainWindow(mainWindow);\r\n\r\n  mainWindow.on(\"close\", (event) => {\r\n    // Close-to-tray behavior: when the user closes the main window, keep mux\r\n    // running in the tray/menu bar so it can be re-opened from there.\r\n    //\r\n    // Only hide when the tray exists to avoid trapping the user with no UI path\r\n    // to restore the app.\r\n    if (isQuitting || !tray) {\r\n      return;\r\n    }\r\n\r\n    event.preventDefault();\r\n    mainWindow?.hide();\r\n  });\r\n\r\n  // Show window once it's ready and close splash\r\n  console.time(\"main window startup\");\r\n  mainWindow.once(\"ready-to-show\", () => {\r\n    console.log(`[${timestamp()}] Main window ready to show`);\r\n    mainWindow?.show();\r\n    mainWindow?.webContents.openDevTools();\r\n    closeSplashScreen();\r\n    console.timeEnd(\"main window startup\");\r\n  });\r\n\r\n  // Open all external links in default browser\r\n  mainWindow.webContents.setWindowOpenHandler(({ url }) => {\r\n    void shell.openExternal(url);\r\n    return { action: \"deny\" };\r\n  });\r\n\r\n  mainWindow.webContents.on(\"will-navigate\", (event, url) => {\r\n    const currentOrigin = new URL(mainWindow!.webContents.getURL()).origin;\r\n    const targetOrigin = new URL(url).origin;\r\n    // Prevent navigation away from app origin, open externally instead\r\n    if (targetOrigin !== currentOrigin) {\r\n      event.preventDefault();\r\n      void shell.openExternal(url);\r\n    }\r\n  });\r\n\r\n  // Load from dev server in development, built files in production\r\n  // app.isPackaged is true when running from a built .app/.exe, false in development\r\n  console.log(`[${timestamp()}] [window] Loading content...`);\r\n  console.time(\"[window] Content load\");\r\n  if ((isE2ETest && !forceDistLoad) || (!app.isPackaged && !forceDistLoad)) {\r\n    // Development mode: load from vite dev server\r\n    const devHost = process.env.MUX_DEVSERVER_HOST ?? \"127.0.0.1\";\r\n    const url = `http://${devHost}:${devServerPort}`;\r\n    console.log(`[${timestamp()}] [window] Loading from dev server: ${url}`);\r\n    void mainWindow.loadURL(url);\r\n    if (!isE2ETest) {\r\n      mainWindow.webContents.once(\"did-finish-load\", () => {\r\n        mainWindow?.webContents.openDevTools();\r\n      });\r\n    }\r\n  } else {\r\n    // Production mode: load built files\r\n    const htmlPath = path.join(__dirname, \"../index.html\");\r\n    console.log(`[${timestamp()}] [window] Loading from file: ${htmlPath}`);\r\n    void mainWindow.loadFile(htmlPath);\r\n\r\n    // Open DevTools in production too (per user request)\r\n    mainWindow.webContents.once(\"did-finish-load\", () => {\r\n      mainWindow?.webContents.openDevTools();\r\n    });\r\n  }\r\n\r\n  // Track when content finishes loading\r\n  mainWindow.webContents.once(\"did-finish-load\", () => {\r\n    console.timeEnd(\"[window] Content load\");\r\n    console.log(`[${timestamp()}] [window] Content finished loading`);\r\n\r\n    mainWindowFinishedLoading = true;\r\n    flushBufferedMuxDeepLinks();\r\n\r\n    // NOTE: Tokenizer modules are NOT loaded at startup anymore!\r\n    // The Proxy in tokenizer.ts loads them on-demand when first accessed.\r\n    // This reduces startup time from ~8s to <1s.\r\n    // First token count will use approximation, accurate count caches in background.\r\n  });\r\n\r\n  mainWindow.on(\"closed\", () => {\r\n    mainWindow = null;\r\n    mainWindowFinishedLoading = false;\r\n  });\r\n}\r\n\r\n// Only setup app handlers if we got the lock\r\nif (gotTheLock) {\r\n  void app.whenReady().then(async () => {\r\n    try {\r\n      console.log(\"App ready, creating window...\");\r\n\r\n      registerMuxProtocolClient();\r\n\r\n      // Migrate from .cmux to .mux directory structure if needed\r\n      migrateLegacyMuxHome();\r\n\r\n      // Install React DevTools in development\r\n      if (!app.isPackaged) {\r\n        try {\r\n          const { default: installExtension, REACT_DEVELOPER_TOOLS } =\r\n            // eslint-disable-next-line no-restricted-syntax -- dev-only dependency, intentionally lazy-loaded\r\n            await import(\"electron-devtools-installer\");\r\n          const extension = await installExtension(REACT_DEVELOPER_TOOLS, {\r\n            loadExtensionOptions: { allowFileAccess: true },\r\n          });\r\n          console.log(`✅ React DevTools installed: ${extension.name} (id: ${extension.id})`);\r\n        } catch (err) {\r\n          console.log(\"❌ Error installing React DevTools:\", err);\r\n        }\r\n      }\r\n\r\n      createMenu();\r\n\r\n      // Three-phase startup:\r\n      // 1. Show splash immediately (<100ms) and wait for it to load\r\n      // 2. Load services while splash visible (fast - ~100ms)\r\n      // 3. Create window and start loading content (splash stays visible)\r\n      // 4. When window ready-to-show: close splash, show main window\r\n      //\r\n      // Skip splash in E2E tests to avoid app.firstWindow() grabbing the wrong window\r\n      if (!isE2ETest) {\r\n        await showSplashScreen(); // Wait for splash to actually load\r\n      }\r\n      await loadServices();\r\n      createWindow();\r\n      createTray();\r\n      // Note: splash closes in ready-to-show event handler\r\n\r\n      // Tokenizer modules load in background after did-finish-load event (see createWindow())\r\n    } catch (error) {\r\n      console.error(`[${timestamp()}] Startup failed:`, error);\r\n\r\n      closeSplashScreen();\r\n\r\n      // Show error dialog to user\r\n      const errorMessage =\r\n        error instanceof Error ? `${error.message}\\n\\n${error.stack ?? \"\"}` : String(error);\r\n\r\n      dialog.showErrorBox(\r\n        \"Startup Failed\",\r\n        `The application failed to start:\\n\\n${errorMessage}\\n\\nPlease check the console for details.`\r\n      );\r\n\r\n      // Quit after showing error\r\n      app.quit();\r\n    }\r\n  });\r\n\r\n  // Track if we're in the middle of disposing to prevent re-entry\r\n  let isDisposing = false;\r\n\r\n  app.on(\"before-quit\", (event) => {\r\n    // Ensure window close handlers don't block an explicit quit.\r\n    // IMPORTANT: must be set before any early returns.\r\n    isQuitting = true;\r\n\r\n    // Skip if already disposing or no services to clean up\r\n    if (isDisposing || !services) {\r\n      return;\r\n    }\r\n\r\n    // Prevent quit, clean up, then quit again\r\n    event.preventDefault();\r\n    isDisposing = true;\r\n\r\n    // Race dispose against timeout to ensure app quits even if disposal hangs\r\n    const disposePromise = services.dispose().catch((err) => {\r\n      console.error(\"Error during ServiceContainer dispose:\", err);\r\n    });\r\n    const timeoutPromise = new Promise<void>((resolve) => setTimeout(resolve, 5000));\r\n\r\n    void Promise.race([disposePromise, timeoutPromise]).finally(() => {\r\n      app.quit();\r\n    });\r\n  });\r\n\r\n  app.on(\"window-all-closed\", () => {\r\n    if (process.platform !== \"darwin\") {\r\n      app.quit();\r\n    }\r\n  });\r\n\r\n  app.on(\"before-quit\", () => {\r\n    console.log(`[${timestamp()}] App before-quit - cleaning up...`);\r\n    if (services) {\r\n      void services.serverService.stopServer();\r\n      void services.shutdown();\r\n    }\r\n  });\r\n\r\n  app.on(\"activate\", () => {\r\n    // Skip splash on reactivation - services already loaded, window creation is fast.\r\n    // Clicking the Dock icon should also re-open the existing window if it was\r\n    // hidden by close-to-tray.\r\n    // Guard: services must be loaded (prevents race if activate fires during startup).\r\n    if (app.isReady() && services) {\r\n      openMuxFromTray();\r\n    }\r\n  });\r\n}\r\n"]}