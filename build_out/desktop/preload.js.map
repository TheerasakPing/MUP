{"version":3,"file":"preload.js","sourceRoot":"","sources":["../../src/desktop/preload.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Electron Preload Script\r\n *\r\n * This script bridges the renderer process with the main process via ORPC over MessagePort.\r\n *\r\n * Key responsibilities:\r\n * 1) Forward MessagePort from renderer to main process for ORPC transport setup\r\n * 2) Expose minimal platform info to renderer via contextBridge\r\n *\r\n * The ORPC connection flow:\r\n * - Renderer creates MessageChannel, posts \"start-orpc-client\" with serverPort\r\n * - Preload intercepts, forwards serverPort to main via ipcRenderer.postMessage\r\n * - Main process upgrades the port with RPCHandler for bidirectional RPC\r\n *\r\n * Build: `bun build src/desktop/preload.ts --format=cjs --target=node --external=electron`\r\n */\r\n\r\nimport { contextBridge, ipcRenderer } from \"electron\";\r\nimport type { MuxDeepLinkPayload } from \"@/common/types/deepLink\";\r\n\r\n// mux:// deep links can arrive before the React app subscribes.\r\n// Buffer them here so the renderer can consume them on mount.\r\nconst pendingDeepLinks: MuxDeepLinkPayload[] = [];\r\nconst deepLinkSubscribers = new Set<(payload: MuxDeepLinkPayload) => void>();\r\n\r\nipcRenderer.on(\"mux:deep-link\", (_event: unknown, payload: MuxDeepLinkPayload) => {\r\n  if (deepLinkSubscribers.size === 0) {\r\n    pendingDeepLinks.push(payload);\r\n  }\r\n\r\n  for (const subscriber of deepLinkSubscribers) {\r\n    try {\r\n      subscriber(payload);\r\n    } catch (error) {\r\n      // Best-effort: a renderer bug shouldn't break deep link delivery.\r\n      console.debug(\"[deep-link] Renderer subscriber threw:\", error);\r\n    }\r\n  }\r\n});\r\n\r\n// Forward ORPC MessagePort from renderer to main process\r\nwindow.addEventListener(\"message\", (event) => {\r\n  if (event.data === \"start-orpc-client\" && event.ports?.[0]) {\r\n    ipcRenderer.postMessage(\"start-orpc-server\", null, [...event.ports]);\r\n  }\r\n});\r\n\r\ncontextBridge.exposeInMainWorld(\"api\", {\r\n  platform: process.platform,\r\n  versions: {\r\n    node: process.versions.node,\r\n    chrome: process.versions.chrome,\r\n    electron: process.versions.electron,\r\n  },\r\n  isE2E: process.env.MUX_E2E === \"1\",\r\n  enableTelemetryInDev: process.env.MUX_ENABLE_TELEMETRY_IN_DEV === \"1\",\r\n  // Note: When debugging LLM requests, we also want to see synthetic/request-only\r\n  // messages in the chat history so the UI matches what was sent to the provider.\r\n  debugLlmRequest: process.env.MUX_DEBUG_LLM_REQUEST === \"1\",\r\n  // Allow testing against a mux.md staging/local deployment without rebuilding the renderer.\r\n  muxMdUrlOverride: process.env.MUX_MD_URL_OVERRIDE,\r\n  // NOTE: This is intentionally async so the preload script does not rely on Node builtins\r\n  // like `child_process` (which can break in hardened/sandboxed environments).\r\n  getIsRosetta: () => ipcRenderer.invoke(\"mux:get-is-rosetta\"),\r\n  getApiServerUrl: () => ipcRenderer.invoke(\"mux:get-api-server-url\") as Promise<string | null>,\r\n  getIsWindowsWslShell: () => ipcRenderer.invoke(\"mux:get-is-windows-wsl-shell\"),\r\n  // Register a callback for notification clicks (navigates to workspace)\r\n  // Returns an unsubscribe function.\r\n  onNotificationClicked: (callback: (data: { workspaceId: string }) => void) => {\r\n    const listener = (_event: unknown, data: { workspaceId: string }) => callback(data);\r\n    ipcRenderer.on(\"mux:notification-clicked\", listener);\r\n    return () => {\r\n      ipcRenderer.off(\"mux:notification-clicked\", listener);\r\n    };\r\n  },\r\n  consumePendingDeepLinks: () => pendingDeepLinks.splice(0, pendingDeepLinks.length),\r\n  onDeepLink: (callback: (payload: MuxDeepLinkPayload) => void) => {\r\n    deepLinkSubscribers.add(callback);\r\n    return () => {\r\n      deepLinkSubscribers.delete(callback);\r\n    };\r\n  },\r\n});\r\n"]}