{"version":3,"file":"preload.js","sourceRoot":"","sources":["../../src/desktop/preload.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Electron Preload Script\n *\n * This script bridges the renderer process with the main process via ORPC over MessagePort.\n *\n * Key responsibilities:\n * 1) Forward MessagePort from renderer to main process for ORPC transport setup\n * 2) Expose minimal platform info to renderer via contextBridge\n *\n * The ORPC connection flow:\n * - Renderer creates MessageChannel, posts \"start-orpc-client\" with serverPort\n * - Preload intercepts, forwards serverPort to main via ipcRenderer.postMessage\n * - Main process upgrades the port with RPCHandler for bidirectional RPC\n *\n * Build: `bun build src/desktop/preload.ts --format=cjs --target=node --external=electron`\n */\n\nimport { contextBridge, ipcRenderer } from \"electron\";\nimport type { MuxDeepLinkPayload } from \"@/common/types/deepLink\";\n\n// mux:// deep links can arrive before the React app subscribes.\n// Buffer them here so the renderer can consume them on mount.\nconst pendingDeepLinks: MuxDeepLinkPayload[] = [];\nconst deepLinkSubscribers = new Set<(payload: MuxDeepLinkPayload) => void>();\n\nipcRenderer.on(\"mux:deep-link\", (_event: unknown, payload: MuxDeepLinkPayload) => {\n  if (deepLinkSubscribers.size === 0) {\n    pendingDeepLinks.push(payload);\n  }\n\n  for (const subscriber of deepLinkSubscribers) {\n    try {\n      subscriber(payload);\n    } catch (error) {\n      // Best-effort: a renderer bug shouldn't break deep link delivery.\n      console.debug(\"[deep-link] Renderer subscriber threw:\", error);\n    }\n  }\n});\n\n// Forward ORPC MessagePort from renderer to main process\nwindow.addEventListener(\"message\", (event) => {\n  if (event.data === \"start-orpc-client\" && event.ports?.[0]) {\n    ipcRenderer.postMessage(\"start-orpc-server\", null, [...event.ports]);\n  }\n});\n\ncontextBridge.exposeInMainWorld(\"api\", {\n  platform: process.platform,\n  versions: {\n    node: process.versions.node,\n    chrome: process.versions.chrome,\n    electron: process.versions.electron,\n  },\n  isE2E: process.env.MUX_E2E === \"1\",\n  enableTelemetryInDev: process.env.MUX_ENABLE_TELEMETRY_IN_DEV === \"1\",\n  // Note: When debugging LLM requests, we also want to see synthetic/request-only\n  // messages in the chat history so the UI matches what was sent to the provider.\n  debugLlmRequest: process.env.MUX_DEBUG_LLM_REQUEST === \"1\",\n  // Allow testing against a mux.md staging/local deployment without rebuilding the renderer.\n  muxMdUrlOverride: process.env.MUX_MD_URL_OVERRIDE,\n  // NOTE: This is intentionally async so the preload script does not rely on Node builtins\n  // like `child_process` (which can break in hardened/sandboxed environments).\n  getIsRosetta: () => ipcRenderer.invoke(\"mux:get-is-rosetta\"),\n  getApiServerUrl: () => ipcRenderer.invoke(\"mux:get-api-server-url\") as Promise<string | null>,\n  getIsWindowsWslShell: () => ipcRenderer.invoke(\"mux:get-is-windows-wsl-shell\"),\n  // Register a callback for notification clicks (navigates to workspace)\n  // Returns an unsubscribe function.\n  onNotificationClicked: (callback: (data: { workspaceId: string }) => void) => {\n    const listener = (_event: unknown, data: { workspaceId: string }) => callback(data);\n    ipcRenderer.on(\"mux:notification-clicked\", listener);\n    return () => {\n      ipcRenderer.off(\"mux:notification-clicked\", listener);\n    };\n  },\n  consumePendingDeepLinks: () => pendingDeepLinks.splice(0, pendingDeepLinks.length),\n  onDeepLink: (callback: (payload: MuxDeepLinkPayload) => void) => {\n    deepLinkSubscribers.add(callback);\n    return () => {\n      deepLinkSubscribers.delete(callback);\n    };\n  },\n});\n"]}