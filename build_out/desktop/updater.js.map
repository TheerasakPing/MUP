{"version":3,"file":"updater.js","sourceRoot":"","sources":["../../src/desktop/updater.ts"],"names":[],"mappings":"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","sourcesContent":["import { autoUpdater } from \"electron-updater\";\nimport type { UpdateInfo } from \"electron-updater\";\nimport { log } from \"@/node/services/log\";\nimport { parseDebugUpdater } from \"@/common/utils/env\";\n\n// Update check timeout in milliseconds (30 seconds)\nconst UPDATE_CHECK_TIMEOUT_MS = 30_000;\n\n// Backend UpdateStatus type (uses full UpdateInfo from electron-updater)\nexport type UpdateStatus =\n  | { type: \"idle\" } // Initial state, no check performed yet\n  | { type: \"checking\" }\n  | { type: \"available\"; info: UpdateInfo }\n  | { type: \"up-to-date\" } // Explicitly checked, no updates available\n  | { type: \"downloading\"; percent: number }\n  | { type: \"downloaded\"; info: UpdateInfo }\n  | { type: \"error\"; message: string };\n\n/**\n * Manages application updates using electron-updater.\n *\n * This service integrates with Electron's auto-updater to:\n * - Check for updates automatically and on-demand\n * - Download updates in the background\n * - Notify the renderer process of update status changes\n * - Install updates when requested by the user\n */\nexport class UpdaterService {\n  private updateStatus: UpdateStatus = { type: \"idle\" };\n  private checkTimeout: ReturnType<typeof setTimeout> | null = null;\n  private readonly fakeVersion: string | undefined;\n  private subscribers = new Set<(status: UpdateStatus) => void>();\n\n  constructor() {\n    // Configure auto-updater\n    autoUpdater.autoDownload = false; // Wait for user confirmation\n    autoUpdater.autoInstallOnAppQuit = true;\n\n    // Parse DEBUG_UPDATER for dev mode and optional fake version\n    const debugConfig = parseDebugUpdater(process.env.DEBUG_UPDATER);\n    this.fakeVersion = debugConfig.fakeVersion;\n\n    if (debugConfig.enabled) {\n      log.debug(\"Forcing dev update config (DEBUG_UPDATER is set)\");\n      autoUpdater.forceDevUpdateConfig = true;\n\n      if (this.fakeVersion) {\n        log.debug(`DEBUG_UPDATER fake version enabled: ${this.fakeVersion}`);\n      }\n    }\n\n    // Set up event handlers\n    this.setupEventHandlers();\n  }\n\n  private setupEventHandlers() {\n    autoUpdater.on(\"checking-for-update\", () => {\n      log.debug(\"Checking for updates...\");\n      this.updateStatus = { type: \"checking\" };\n      this.notifyRenderer();\n    });\n\n    autoUpdater.on(\"update-available\", (info: UpdateInfo) => {\n      log.info(\"Update available:\", info.version);\n      this.clearCheckTimeout();\n      this.updateStatus = { type: \"available\", info };\n      this.notifyRenderer();\n    });\n\n    autoUpdater.on(\"update-not-available\", () => {\n      log.debug(\"No updates available - up to date\");\n      this.clearCheckTimeout();\n      this.updateStatus = { type: \"up-to-date\" };\n      this.notifyRenderer();\n    });\n\n    autoUpdater.on(\"download-progress\", (progress) => {\n      const percent = Math.round(progress.percent);\n      log.debug(`Download progress: ${percent}%`);\n      this.updateStatus = { type: \"downloading\", percent };\n      this.notifyRenderer();\n    });\n\n    autoUpdater.on(\"update-downloaded\", (info: UpdateInfo) => {\n      log.info(\"Update downloaded:\", info.version);\n      this.updateStatus = { type: \"downloaded\", info };\n      this.notifyRenderer();\n    });\n\n    autoUpdater.on(\"error\", (error) => {\n      log.error(\"Update error:\", error);\n      this.clearCheckTimeout();\n      this.updateStatus = { type: \"error\", message: error.message };\n      this.notifyRenderer();\n    });\n  }\n\n  /**\n   * Clear the check timeout\n   */\n  private clearCheckTimeout() {\n    if (this.checkTimeout) {\n      clearTimeout(this.checkTimeout);\n      this.checkTimeout = null;\n    }\n  }\n\n  /**\n   * Check for updates manually\n   *\n   * This triggers the check but returns immediately. The actual results\n   * will be delivered via event handlers (checking-for-update, update-available, etc.)\n   *\n   * A 30-second timeout ensures we don't stay in \"checking\" state indefinitely.\n   */\n  checkForUpdates(): void {\n    log.debug(\"checkForUpdates() called\");\n    try {\n      // Clear any existing timeout\n      this.clearCheckTimeout();\n\n      // Set checking status immediately\n      log.debug(\"Setting status to 'checking'\");\n      this.updateStatus = { type: \"checking\" };\n      this.notifyRenderer();\n\n      // If fake version is set, immediately report it as available\n      if (this.fakeVersion) {\n        log.debug(`Faking update available: ${this.fakeVersion}`);\n        const version = this.fakeVersion;\n        setTimeout(() => {\n          const fakeInfo = {\n            version,\n          } satisfies Partial<UpdateInfo> as UpdateInfo;\n          this.updateStatus = {\n            type: \"available\",\n            info: fakeInfo,\n          };\n          this.notifyRenderer();\n        }, 500); // Small delay to simulate check\n        return;\n      }\n\n      // Set timeout to prevent hanging in \"checking\" state\n      log.debug(`Setting ${UPDATE_CHECK_TIMEOUT_MS}ms timeout`);\n      this.checkTimeout = setTimeout(() => {\n        if (this.updateStatus.type === \"checking\") {\n          log.debug(\n            `Update check timed out after ${UPDATE_CHECK_TIMEOUT_MS}ms, returning to idle state`\n          );\n          this.updateStatus = { type: \"idle\" };\n          this.notifyRenderer();\n        } else {\n          log.debug(`Timeout fired but status already changed to: ${this.updateStatus.type}`);\n        }\n      }, UPDATE_CHECK_TIMEOUT_MS);\n\n      // Trigger the check (don't await - it never resolves, just fires events)\n      log.debug(\"Calling autoUpdater.checkForUpdates()\");\n      autoUpdater.checkForUpdates().catch((error) => {\n        this.clearCheckTimeout();\n        const message = error instanceof Error ? error.message : \"Unknown error\";\n        log.error(\"Update check failed:\", message);\n        this.updateStatus = { type: \"error\", message };\n        this.notifyRenderer();\n      });\n    } catch (error) {\n      this.clearCheckTimeout();\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      log.error(\"Update check error:\", message);\n      this.updateStatus = { type: \"error\", message };\n      this.notifyRenderer();\n    }\n  }\n\n  /**\n   * Download an available update\n   */\n  async downloadUpdate(): Promise<void> {\n    if (this.updateStatus.type !== \"available\") {\n      throw new Error(\"No update available to download\");\n    }\n\n    // If using fake version, simulate download progress\n    if (this.fakeVersion) {\n      log.debug(`Faking download for version ${this.fakeVersion}`);\n      this.updateStatus = { type: \"downloading\", percent: 0 };\n      this.notifyRenderer();\n\n      // Simulate download progress\n      for (let percent = 0; percent <= 100; percent += 10) {\n        await new Promise((resolve) => setTimeout(resolve, 200));\n        this.updateStatus = { type: \"downloading\", percent };\n        this.notifyRenderer();\n      }\n\n      // Mark as downloaded\n      const version = this.fakeVersion;\n      const fakeDownloadedInfo = { version } satisfies Partial<UpdateInfo> as UpdateInfo;\n      this.updateStatus = {\n        type: \"downloaded\",\n        info: fakeDownloadedInfo,\n      };\n      this.notifyRenderer();\n      return;\n    }\n\n    await autoUpdater.downloadUpdate();\n  }\n\n  /**\n   * Install a downloaded update and restart the app\n   */\n  installUpdate(): void {\n    if (this.updateStatus.type !== \"downloaded\") {\n      throw new Error(\"No update downloaded to install\");\n    }\n\n    // If using fake version, just log (can't actually restart with fake update)\n    if (this.fakeVersion) {\n      log.debug(`Fake update install requested for ${this.fakeVersion} - would restart app here`);\n      return;\n    }\n\n    autoUpdater.quitAndInstall();\n  }\n\n  /**\n   * Get the current update status\n   */\n\n  /**\n   * Subscribe to status updates\n   */\n  subscribe(callback: (status: UpdateStatus) => void): () => void {\n    this.subscribers.add(callback);\n    return () => {\n      this.subscribers.delete(callback);\n    };\n  }\n  getStatus(): UpdateStatus {\n    return this.updateStatus;\n  }\n\n  /**\n   * Notify the renderer process of status changes\n   */\n  private notifyRenderer() {\n    log.debug(\"notifyRenderer() called, status:\", this.updateStatus);\n    // Notify subscribers (ORPC)\n    for (const subscriber of this.subscribers) {\n      try {\n        subscriber(this.updateStatus);\n      } catch (err) {\n        log.error(\"Error notifying subscriber:\", err);\n      }\n    }\n  }\n}\n"]}