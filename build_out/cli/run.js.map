{"version":3,"file":"run.js","sourceRoot":"","sources":["../../src/cli/run.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env bun\r\n/**\r\n * `mux run` - First-class CLI for running agent sessions\r\n *\r\n * Usage:\r\n *   mux run \"Fix the failing tests\"\r\n *   mux run --dir /path/to/project \"Add authentication\"\r\n *   mux run --runtime \"ssh user@host\" \"Deploy changes\"\r\n */\r\n\r\nimport { Command } from \"commander\";\r\nimport { tool } from \"ai\";\r\nimport { z } from \"zod\";\r\nimport * as path from \"path\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as fsSync from \"fs\";\r\nimport { Config } from \"@/node/config\";\r\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\r\nimport { AgentSession, type AgentSessionChatEvent } from \"@/node/services/agentSession\";\r\nimport { CodexOauthService } from \"@/node/services/codexOauthService\";\r\nimport { createCoreServices } from \"@/node/services/coreServices\";\r\nimport {\r\n  isCaughtUpMessage,\r\n  isReasoningDelta,\r\n  isReasoningEnd,\r\n  isStreamAbort,\r\n  isStreamDelta,\r\n  isStreamEnd,\r\n  isStreamError,\r\n  isStreamStart,\r\n  isToolCallDelta,\r\n  isToolCallEnd,\r\n  isToolCallStart,\r\n  isUsageDelta,\r\n  type SendMessageOptions,\r\n  type WorkspaceChatMessage,\r\n} from \"@/common/orpc/types\";\r\nimport { createDisplayUsage } from \"@/common/utils/tokens/displayUsage\";\r\nimport {\r\n  getTotalCost,\r\n  formatCostWithDollar,\r\n  sumUsageHistory,\r\n  type ChatUsageDisplay,\r\n} from \"@/common/utils/tokens/usageAggregator\";\r\nimport {\r\n  formatToolStart,\r\n  formatToolEnd,\r\n  formatGenericToolStart,\r\n  formatGenericToolEnd,\r\n  isMultilineResultTool,\r\n} from \"./toolFormatters\";\r\nimport { defaultModel, resolveModelAlias } from \"@/common/utils/ai/models\";\r\nimport { buildProvidersFromEnv, hasAnyConfiguredProvider } from \"@/node/utils/providerRequirements\";\r\n\r\nimport {\r\n  DEFAULT_THINKING_LEVEL,\r\n  THINKING_DISPLAY_LABELS,\r\n  parseThinkingInput,\r\n  type ParsedThinkingInput,\r\n} from \"@/common/types/thinking\";\r\nimport { resolveThinkingInput } from \"@/common/utils/thinking/policy\";\r\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\r\nimport { parseRuntimeModeAndHost, RUNTIME_MODE } from \"@/common/types/runtime\";\r\nimport assert from \"@/common/utils/assert\";\r\nimport type { LanguageModelV2Usage } from \"@ai-sdk/provider\";\r\nimport { log, type LogLevel } from \"@/node/services/log\";\r\nimport chalk from \"chalk\";\r\nimport type { InitLogger, WorkspaceInitResult } from \"@/node/runtime/Runtime\";\r\nimport { DockerRuntime } from \"@/node/runtime/DockerRuntime\";\r\nimport { runFullInit } from \"@/node/runtime/runtimeFactory\";\r\nimport { execSync } from \"child_process\";\r\nimport { getParseOptions } from \"./argv\";\r\nimport { EXPERIMENT_IDS } from \"@/common/constants/experiments\";\r\n\r\n// Display labels for CLI help (OFF, LOW, MED, HIGH, MAX)\r\nconst THINKING_LABELS_LIST = Object.values(THINKING_DISPLAY_LABELS).join(\", \");\r\n\r\ntype CLIMode = \"plan\" | \"exec\";\r\n\r\nfunction parseRuntimeConfig(value: string | undefined, srcBaseDir: string): RuntimeConfig {\r\n  if (!value) {\r\n    // Default to local for `mux run` (no worktree isolation needed for one-off)\r\n    return { type: \"local\" };\r\n  }\r\n\r\n  const parsed = parseRuntimeModeAndHost(value);\r\n  if (!parsed) {\r\n    throw new Error(\r\n      `Invalid runtime: '${value}'. Use 'local', 'worktree', 'ssh <host>', or 'docker <image>'`\r\n    );\r\n  }\r\n\r\n  switch (parsed.mode) {\r\n    case RUNTIME_MODE.LOCAL:\r\n      return { type: \"local\" };\r\n    case RUNTIME_MODE.WORKTREE:\r\n      return { type: \"worktree\", srcBaseDir };\r\n    case RUNTIME_MODE.SSH:\r\n      return { type: \"ssh\", host: parsed.host, srcBaseDir };\r\n    case RUNTIME_MODE.DOCKER:\r\n      return { type: \"docker\", image: parsed.image };\r\n    default:\r\n      return { type: \"local\" };\r\n  }\r\n}\r\n\r\nfunction parseThinkingLevel(value: string | undefined): ParsedThinkingInput {\r\n  if (!value) return DEFAULT_THINKING_LEVEL; // Default for mux run\r\n\r\n  // Accepts named levels (off, low, med, high, max, xhigh) and numeric (0–N)\r\n  const level = parseThinkingInput(value);\r\n  if (level != null) {\r\n    return level;\r\n  }\r\n  throw new Error(`Invalid thinking level \"${value}\". Expected: ${THINKING_LABELS_LIST}, or 0–N`);\r\n}\r\n\r\nfunction parseMode(value: string | undefined): CLIMode {\r\n  if (!value) return \"exec\";\r\n\r\n  const normalized = value.trim().toLowerCase();\r\n  if (normalized === \"plan\") return \"plan\";\r\n  if (normalized === \"exec\" || normalized === \"execute\") return \"exec\";\r\n\r\n  throw new Error(`Invalid mode \"${value}\". Expected: plan, exec`);\r\n}\r\n\r\nfunction generateWorkspaceId(): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  return `run-${timestamp}-${random}`;\r\n}\r\n\r\nfunction makeCliInitLogger(writeHumanLine: (text?: string) => void): InitLogger {\r\n  return {\r\n    logStep: (msg) => writeHumanLine(`  ${msg}`),\r\n    logStdout: (line) => writeHumanLine(`  ${line}`),\r\n    logStderr: (line) => writeHumanLine(`  [stderr] ${line}`),\r\n    logComplete: (exitCode) => {\r\n      if (exitCode !== 0) writeHumanLine(`  Init completed with exit code ${exitCode}`);\r\n    },\r\n  };\r\n}\r\n\r\nasync function ensureDirectory(dirPath: string): Promise<void> {\r\n  const stats = await fs.stat(dirPath);\r\n  if (!stats.isDirectory()) {\r\n    throw new Error(`\"${dirPath}\" is not a directory`);\r\n  }\r\n}\r\n\r\nasync function gatherMessageFromStdin(): Promise<string> {\r\n  if (process.stdin.isTTY) {\r\n    return \"\";\r\n  }\r\n\r\n  const chunks: Uint8Array[] = [];\r\n  for await (const chunk of process.stdin) {\r\n    if (Buffer.isBuffer(chunk)) {\r\n      chunks.push(chunk);\r\n    } else if (typeof chunk === \"string\") {\r\n      chunks.push(Buffer.from(chunk));\r\n    } else if (chunk instanceof Uint8Array) {\r\n      chunks.push(chunk);\r\n    }\r\n  }\r\n  return Buffer.concat(chunks).toString(\"utf-8\");\r\n}\r\n\r\nfunction renderUnknown(value: unknown): string {\r\n  if (typeof value === \"string\") return value;\r\n  try {\r\n    return JSON.stringify(value, null, 2);\r\n  } catch {\r\n    return String(value);\r\n  }\r\n}\r\n\r\nconst VALID_EXPERIMENT_IDS = new Set<string>(Object.values(EXPERIMENT_IDS));\r\n\r\nfunction collectExperiments(value: string, previous: string[]): string[] {\r\n  const experimentId = value.trim().toLowerCase();\r\n  if (!VALID_EXPERIMENT_IDS.has(experimentId)) {\r\n    throw new Error(\r\n      `Unknown experiment \"${value}\". Valid experiments: ${[...VALID_EXPERIMENT_IDS].join(\", \")}`\r\n    );\r\n  }\r\n  if (previous.includes(experimentId)) {\r\n    return previous; // Dedupe\r\n  }\r\n  return [...previous, experimentId];\r\n}\r\n\r\n/**\r\n * Convert experiment ID array to the experiments object expected by SendMessageOptions.\r\n */\r\nfunction buildExperimentsObject(experimentIds: string[]): SendMessageOptions[\"experiments\"] {\r\n  if (experimentIds.length === 0) return undefined;\r\n\r\n  return {\r\n    programmaticToolCalling: experimentIds.includes(\"programmatic-tool-calling\"),\r\n    programmaticToolCallingExclusive: experimentIds.includes(\"programmatic-tool-calling-exclusive\"),\r\n    system1: experimentIds.includes(\"system-1\"),\r\n    execSubagentHardRestart: experimentIds.includes(\"exec-subagent-hard-restart\"),\r\n  };\r\n}\r\n\r\ninterface MCPServerEntry {\r\n  name: string;\r\n  command: string;\r\n}\r\n\r\nfunction collectMcpServers(value: string, previous: MCPServerEntry[]): MCPServerEntry[] {\r\n  const eqIndex = value.indexOf(\"=\");\r\n  if (eqIndex === -1) {\r\n    throw new Error(`Invalid --mcp format: \"${value}\". Expected: name=command`);\r\n  }\r\n  const name = value.slice(0, eqIndex).trim();\r\n  const command = value.slice(eqIndex + 1).trim();\r\n  if (!name) {\r\n    throw new Error(`Invalid --mcp format: \"${value}\". Server name is required`);\r\n  }\r\n  if (!command) {\r\n    throw new Error(`Invalid --mcp format: \"${value}\". Command is required`);\r\n  }\r\n  return [...previous, { name, command }];\r\n}\r\n\r\nconst program = new Command();\r\n\r\nprogram\r\n  .name(\"mux run\")\r\n  .description(\"Run an agent session in the current directory\")\r\n  .argument(\"[message...]\", \"instruction for the agent (can also be piped via stdin)\")\r\n  .option(\"-d, --dir <path>\", \"project directory\", process.cwd())\r\n  .option(\"-m, --model <model>\", \"model to use\", defaultModel)\r\n  .option(\r\n    \"-r, --runtime <runtime>\",\r\n    \"runtime type: local, worktree, 'ssh <host>', or 'docker <image>'\",\r\n    \"local\"\r\n  )\r\n  .option(\"--mode <mode>\", \"agent mode: plan or exec\", \"exec\")\r\n  .option(\r\n    \"-t, --thinking <level>\",\r\n    `thinking level: ${THINKING_LABELS_LIST}`,\r\n    THINKING_DISPLAY_LABELS[DEFAULT_THINKING_LEVEL]\r\n  )\r\n  .option(\"-v, --verbose\", \"show info-level logs (default: errors only)\")\r\n  .option(\"--hide-costs\", \"hide cost summary at end of run\")\r\n  .option(\"--log-level <level>\", \"set log level: error, warn, info, debug\")\r\n  .option(\"--json\", \"output NDJSON for programmatic consumption\")\r\n  .option(\"-q, --quiet\", \"only output final result\")\r\n  .option(\"--mcp <server>\", \"MCP server as name=command (can be repeated)\", collectMcpServers, [])\r\n  .option(\"--no-mcp-config\", \"ignore global + repo MCP config files (use only --mcp servers)\")\r\n  .option(\"-e, --experiment <id>\", \"enable experiment (can be repeated)\", collectExperiments, [])\r\n  .option(\"-b, --budget <usd>\", \"stop when session cost exceeds budget (USD)\", parseFloat)\r\n  .option(\"--service-tier <tier>\", \"OpenAI service tier: auto, default, flex, priority\", \"auto\")\r\n  .option(\"--use-1m\", \"enable 1M context window for supported Anthropic models\")\r\n  .option(\r\n    \"--keep-background-processes\",\r\n    \"do not terminate background processes on exit (for CI/bench)\"\r\n  )\r\n  .addHelpText(\r\n    \"after\",\r\n    `\r\nExamples:\r\n  $ mux run \"Fix the failing tests\"\r\n  $ mux run --dir /path/to/project \"Add authentication\"\r\n  $ mux run --runtime \"ssh user@host\" \"Deploy changes\"\r\n  $ mux run --mode plan \"Refactor the auth module\"\r\n  $ mux run --budget 1.50 \"Quick code review\"\r\n  $ echo \"Add logging\" | mux run\r\n  $ mux run --json \"List all files\" | jq '.type'\r\n  $ mux run --mcp \"memory=npx -y @modelcontextprotocol/server-memory\" \"Remember this\"\r\n  $ mux run --mcp \"chrome=npx chrome-devtools-mcp\" --mcp \"fs=npx @anthropic/mcp-fs\" \"Take a screenshot\"\r\n`\r\n  );\r\n\r\nprogram.parse(process.argv, getParseOptions());\r\n\r\ninterface CLIOptions {\r\n  dir: string;\r\n  model: string;\r\n  runtime: string;\r\n  mode: string;\r\n  thinking: string;\r\n  verbose?: boolean;\r\n  hideCosts?: boolean;\r\n  logLevel?: string;\r\n  json?: boolean;\r\n  quiet?: boolean;\r\n  mcp: MCPServerEntry[];\r\n  mcpConfig: boolean;\r\n  experiment: string[];\r\n  budget?: number;\r\n  serviceTier: \"auto\" | \"default\" | \"flex\" | \"priority\";\r\n  use1m?: boolean;\r\n  keepBackgroundProcesses?: boolean;\r\n}\r\n\r\nconst opts = program.opts<CLIOptions>();\r\nconst keepBackgroundProcesses =\r\n  opts.keepBackgroundProcesses === true || process.env.MUX_KEEP_BACKGROUND_PROCESSES === \"1\";\r\nconst messageArg = program.args.join(\" \");\r\n\r\nasync function main(): Promise<number> {\r\n  // Configure log level early (before any logging happens)\r\n  if (opts.logLevel) {\r\n    const level = opts.logLevel.toLowerCase();\r\n    if (level === \"error\" || level === \"warn\" || level === \"info\" || level === \"debug\") {\r\n      log.setLevel(level as LogLevel);\r\n    } else {\r\n      console.error(`Invalid log level \"${opts.logLevel}\". Expected: error, warn, info, debug`);\r\n      process.exit(1);\r\n    }\r\n  } else if (opts.verbose) {\r\n    log.setLevel(\"info\");\r\n  }\r\n  // Default is already \"warn\" for CLI mode (set in log.ts)\r\n\r\n  // Get message from arg or stdin\r\n  const stdinMessage = await gatherMessageFromStdin();\r\n  const message = messageArg?.trim() || stdinMessage.trim();\r\n\r\n  if (!message) {\r\n    console.error(\"Error: No message provided. Pass as argument or pipe via stdin.\");\r\n    console.error('Usage: mux run \"Your instruction here\"');\r\n    process.exit(1);\r\n  }\r\n\r\n  // Create ephemeral temp dir for session data (auto-cleaned on exit)\r\n  using tempDir = new DisposableTempDir(\"mux-run\");\r\n\r\n  // Use real config for providers, but ephemeral temp dir for session data\r\n  const realConfig = new Config();\r\n  const config = new Config(tempDir.path);\r\n\r\n  // Copy providers and secrets from real config to ephemeral config\r\n  const existingProviders = realConfig.loadProvidersConfig();\r\n  if (hasAnyConfiguredProvider(existingProviders)) {\r\n    // Write providers to temp config so services can find them\r\n    const providersFile = path.join(config.rootDir, \"providers.jsonc\");\r\n    fsSync.writeFileSync(providersFile, JSON.stringify(existingProviders, null, 2));\r\n  }\r\n\r\n  // Copy secrets so tools/MCP servers get project secrets (e.g., GH_TOKEN)\r\n  const existingSecrets = realConfig.loadSecretsConfig();\r\n  if (Object.keys(existingSecrets).length > 0) {\r\n    const secretsFile = path.join(config.rootDir, \"secrets.json\");\r\n    fsSync.writeFileSync(secretsFile, JSON.stringify(existingSecrets, null, 2));\r\n  }\r\n\r\n  const workspaceId = generateWorkspaceId();\r\n  const projectDir = path.resolve(opts.dir);\r\n  await ensureDirectory(projectDir);\r\n\r\n  const model: string = resolveModelAlias(opts.model);\r\n  const runtimeConfig = parseRuntimeConfig(opts.runtime, config.srcDir);\r\n  // Resolve thinking: numeric indices map to the model's allowed levels (0 = lowest)\r\n  const thinkingLevel = resolveThinkingInput(parseThinkingLevel(opts.thinking), model);\r\n  const initialMode = parseMode(opts.mode);\r\n  const emitJson = opts.json === true;\r\n  const quiet = opts.quiet === true;\r\n  const hideCosts = opts.hideCosts === true;\r\n\r\n  const budget = opts.budget;\r\n\r\n  // Validate budget\r\n  if (budget !== undefined) {\r\n    if (Number.isNaN(budget)) {\r\n      console.error(\"Error: --budget must be a valid number\");\r\n      process.exit(1);\r\n    }\r\n    if (budget < 0) {\r\n      console.error(\"Error: --budget cannot be negative\");\r\n      process.exit(1);\r\n    }\r\n  }\r\n\r\n  const suppressHumanOutput = emitJson || quiet;\r\n  const stdoutIsTTY = process.stdout.isTTY === true;\r\n  const stderrIsTTY = process.stderr.isTTY === true;\r\n\r\n  const writeHuman = (text: string) => {\r\n    if (!suppressHumanOutput) process.stdout.write(text);\r\n  };\r\n  const writeHumanLine = (text = \"\") => {\r\n    if (!suppressHumanOutput) process.stdout.write(`${text}\\n`);\r\n  };\r\n  const writeThinking = (text: string) => {\r\n    if (suppressHumanOutput) return;\r\n    // Purple color matching Mux UI thinking blocks (hsl(271, 76%, 53%) = #A855F7)\r\n    const colored = stderrIsTTY ? chalk.hex(\"#A855F7\")(text) : text;\r\n    process.stderr.write(colored);\r\n  };\r\n  const emitJsonLine = (payload: unknown) => {\r\n    if (emitJson) process.stdout.write(`${JSON.stringify(payload)}\\n`);\r\n  };\r\n\r\n  // Log startup info (shown at info+ level, i.e., with --verbose)\r\n  log.info(`Directory: ${projectDir}`);\r\n  log.info(`Model: ${model}`);\r\n  log.info(\r\n    `Runtime: ${runtimeConfig.type}${runtimeConfig.type === \"ssh\" ? ` (${runtimeConfig.host})` : \"\"}`\r\n  );\r\n  log.info(`Mode: ${initialMode}`);\r\n\r\n  // Bootstrap providers from env vars if no providers.jsonc exists\r\n  if (!hasAnyConfiguredProvider(existingProviders)) {\r\n    const providersFromEnv = buildProvidersFromEnv();\r\n    if (hasAnyConfiguredProvider(providersFromEnv)) {\r\n      config.saveProvidersConfig(providersFromEnv);\r\n    } else {\r\n      throw new Error(\r\n        \"No provider credentials found. Configure providers.jsonc or set ANTHROPIC_API_KEY / OPENAI_API_KEY / OPENROUTER_API_KEY / GOOGLE_GENERATIVE_AI_API_KEY.\"\r\n      );\r\n    }\r\n  }\r\n\r\n  // Initialize the core service graph (shared with ServiceContainer).\r\n  // CLI overrides: ephemeral extension metadata, persistent MCP config via\r\n  // realConfig, and CLI-specific MCPServerManager options for inline servers.\r\n  const inlineServers: Record<string, string> = {};\r\n  for (const entry of opts.mcp) {\r\n    inlineServers[entry.name] = entry.command;\r\n  }\r\n  const {\r\n    aiService,\r\n    historyService,\r\n    partialService,\r\n    initStateManager,\r\n    backgroundProcessManager,\r\n    mcpServerManager,\r\n    providerService,\r\n    workspaceService,\r\n    costTrackingService,\r\n  } = createCoreServices({\r\n    config,\r\n    extensionMetadataPath: path.join(tempDir.path, \"extensionMetadata.json\"),\r\n    mcpConfig: realConfig,\r\n    mcpServerManagerOptions: {\r\n      inlineServers,\r\n      ignoreConfigFile: !opts.mcpConfig,\r\n    },\r\n  });\r\n\r\n  // `mux run` uses createCoreServices directly (without ServiceContainer), so wire\r\n  // Codex OAuth explicitly to ensure Codex-routed OpenAI requests can load/refresh\r\n  // OAuth tokens from providers.jsonc.\r\n  const codexOauthService = new CodexOauthService(config, providerService);\r\n  aiService.setCodexOauthService(codexOauthService);\r\n\r\n  // CLI-only exit code control: allows agent to set the process exit code\r\n  // Useful for CI workflows where the agent should block merge on failure\r\n  let agentExitCode: number | undefined;\r\n  const setExitCodeSchema = z.object({\r\n    exit_code: z\r\n      .number()\r\n      .int()\r\n      .min(0)\r\n      .max(255)\r\n      .describe(\"Exit code (0 = success, 1-255 = failure)\"),\r\n  });\r\n  const setExitCodeTool = tool({\r\n    description:\r\n      \"Set the process exit code for this CLI session. \" +\r\n      \"Use this in CI/automation to signal success (0) or failure (non-zero). \" +\r\n      \"For example, exit 1 to block a PR merge when issues are found. \" +\r\n      \"Only available in `mux run` CLI mode.\",\r\n    inputSchema: setExitCodeSchema,\r\n    execute: ({ exit_code }: z.infer<typeof setExitCodeSchema>) => {\r\n      agentExitCode = exit_code;\r\n      return { success: true, exit_code };\r\n    },\r\n  });\r\n  aiService.setExtraTools({ set_exit_code: setExitCodeTool });\r\n\r\n  const session = new AgentSession({\r\n    workspaceId,\r\n    config,\r\n    historyService,\r\n    partialService,\r\n    aiService,\r\n    initStateManager,\r\n    costTrackingService,\r\n    backgroundProcessManager,\r\n    keepBackgroundProcesses,\r\n  });\r\n  // Register with WorkspaceService so TaskService operations that target the parent\r\n  // workspace (e.g. resumeStream after sub-agent completion) reuse this session\r\n  // instead of creating a duplicate.\r\n  workspaceService.registerSession(workspaceId, session);\r\n\r\n  // For Docker runtime, create and initialize the container first\r\n  let workspacePath = projectDir;\r\n  if (runtimeConfig.type === \"docker\") {\r\n    const runtime = new DockerRuntime(runtimeConfig);\r\n    // Use a sanitized branch name (CLI runs are typically one-off, no real branch needed)\r\n    const branchName = `cli-${workspaceId.replace(/[^a-zA-Z0-9-]/g, \"-\")}`;\r\n\r\n    // Detect trunk branch from repo\r\n    let trunkBranch = \"main\";\r\n    try {\r\n      const symbolic = execSync(\"git symbolic-ref refs/remotes/origin/HEAD\", {\r\n        cwd: projectDir,\r\n        encoding: \"utf-8\",\r\n      }).trim();\r\n      trunkBranch = symbolic.replace(\"refs/remotes/origin/\", \"\");\r\n    } catch {\r\n      // Fallback to main\r\n    }\r\n\r\n    const initLogger = makeCliInitLogger(writeHumanLine);\r\n    const createResult = await runtime.createWorkspace({\r\n      projectPath: projectDir,\r\n      branchName,\r\n      trunkBranch,\r\n      directoryName: branchName,\r\n      initLogger,\r\n    });\r\n    if (!createResult.success) {\r\n      console.error(`Failed to create Docker workspace: ${createResult.error ?? \"unknown error\"}`);\r\n      process.exit(1);\r\n    }\r\n\r\n    // Use runFullInit to ensure postCreateSetup runs before initWorkspace\r\n    let initResult: WorkspaceInitResult;\r\n    try {\r\n      initResult = await runFullInit(runtime, {\r\n        projectPath: projectDir,\r\n        branchName,\r\n        trunkBranch,\r\n        workspacePath: createResult.workspacePath!,\r\n        initLogger,\r\n      });\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      initLogger.logStderr(`Initialization failed: ${errorMessage}`);\r\n      initLogger.logComplete(-1);\r\n      initResult = { success: false, error: errorMessage };\r\n    }\r\n    if (!initResult.success) {\r\n      // Clean up orphaned container\r\n      // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n      await runtime.deleteWorkspace(projectDir, branchName, true).catch(() => { });\r\n      console.error(\r\n        `Failed to initialize Docker workspace: ${initResult.error ?? \"unknown error\"}`\r\n      );\r\n      process.exit(1);\r\n    }\r\n\r\n    // Docker workspacePath is /src; projectName stays as original\r\n    workspacePath = createResult.workspacePath!;\r\n  }\r\n\r\n  // Initialize workspace metadata (ephemeral - stored in temp dir)\r\n  await session.ensureMetadata({\r\n    workspacePath,\r\n    projectName: path.basename(projectDir),\r\n    runtimeConfig,\r\n  });\r\n\r\n  // Note: taskService.initialize() is intentionally NOT called. It resumes tasks from a\r\n  // previous session, but mux run uses an ephemeral Config (temp dir) with no prior state.\r\n  // Calling initialize() on a fresh config is a no-op, but skipping it makes the intent\r\n  // clear and avoids any risk of cross-workspace side effects if config were ever shared.\r\n\r\n  const experiments = buildExperimentsObject(opts.experiment);\r\n\r\n  const buildSendOptions = (cliMode: CLIMode): SendMessageOptions => ({\r\n    model,\r\n    thinkingLevel,\r\n    agentId: cliMode,\r\n    experiments,\r\n    providerOptions: {\r\n      ...(opts.use1m && { anthropic: { use1MContext: true } }),\r\n      openai: { serviceTier: opts.serviceTier },\r\n    },\r\n    // Disable UI-only tools that have no effect in CLI mode:\r\n    // - status_set: backend no-op, status indicator only visible in desktop UI\r\n    // - todo_write/todo_read: TODO list only visible in desktop UI\r\n    // - notify: sends OS notifications via Electron, silently swallowed in CLI\r\n    toolPolicy: [\r\n      { regex_match: \"status_set\", action: \"disable\" as const },\r\n      { regex_match: \"todo_write\", action: \"disable\" as const },\r\n      { regex_match: \"todo_read\", action: \"disable\" as const },\r\n      { regex_match: \"notify\", action: \"disable\" as const },\r\n    ],\r\n    // Plan agent instructions are handled by the backend (has access to plan file path)\r\n  });\r\n\r\n  const liveEvents: WorkspaceChatMessage[] = [];\r\n  let readyForLive = false;\r\n\r\n  /**\r\n   * Tracks whether stdout currently has an unfinished line (i.e. the last write was\r\n   * via `writeHuman(...)` without a trailing newline).\r\n   *\r\n   * This is used to prevent concatenating multi-line blocks (like tool results) onto\r\n   * the end of an inline prefix.\r\n   */\r\n  let streamLineOpen = false;\r\n  let activeMessageId: string | null = null;\r\n  let planProposed = false;\r\n  let streamEnded = false;\r\n\r\n  // Track usage for cost summary at end of run\r\n  const usageHistory: ChatUsageDisplay[] = [];\r\n  // Track latest usage-delta per message as fallback when stream-end lacks usage metadata\r\n  const latestUsageDelta = new Map<\r\n    string,\r\n    { usage: LanguageModelV2Usage; providerMetadata?: Record<string, unknown>; model: string }\r\n  >();\r\n\r\n  const writeHumanChunk = (text: string) => {\r\n    if (text.length === 0) return;\r\n    writeHuman(text);\r\n    streamLineOpen = !text.endsWith(\"\\n\");\r\n  };\r\n\r\n  const writeHumanLineClosed = (text = \"\") => {\r\n    writeHumanLine(text);\r\n    streamLineOpen = false;\r\n  };\r\n\r\n  const closeHumanLine = () => {\r\n    if (!streamLineOpen) return;\r\n    writeHumanLineClosed(\"\");\r\n  };\r\n\r\n  // Track tool call args by toolCallId for use in end formatting\r\n  const toolCallArgs = new Map<string, unknown>();\r\n\r\n  // Budget tracking state\r\n  let budgetExceeded = false;\r\n\r\n  // Centralized output type tracking for spacing\r\n  type OutputType = \"none\" | \"text\" | \"thinking\" | \"tool\";\r\n  let lastOutputType: OutputType = \"none\";\r\n\r\n  /**\r\n   * Ensure proper spacing before starting a new output block.\r\n   * Call this before writing any output to handle transitions cleanly.\r\n   */\r\n  const ensureSpacing = (nextType: OutputType) => {\r\n    const isTransition = lastOutputType !== nextType;\r\n\r\n    // Finish any open line when transitioning to a different output type\r\n    if (isTransition) {\r\n      closeHumanLine();\r\n    }\r\n\r\n    // Add blank line for transitions (but not at start of output)\r\n    if (lastOutputType !== \"none\" && isTransition) {\r\n      writeHumanLineClosed(\"\");\r\n    }\r\n    // Also add blank line between consecutive tool calls\r\n    if (lastOutputType === \"tool\" && nextType === \"tool\") {\r\n      writeHumanLineClosed(\"\");\r\n    }\r\n\r\n    lastOutputType = nextType;\r\n  };\r\n\r\n  let resolveCompletion: ((value: void) => void) | null = null;\r\n  let rejectCompletion: ((reason?: unknown) => void) | null = null;\r\n  let completionPromise: Promise<void> = Promise.resolve();\r\n\r\n  const createCompletionPromise = (): Promise<void> => {\r\n    streamEnded = false;\r\n    return new Promise<void>((resolve, reject) => {\r\n      resolveCompletion = resolve;\r\n      rejectCompletion = reject;\r\n    });\r\n  };\r\n\r\n  const waitForCompletion = async (): Promise<void> => {\r\n    await completionPromise;\r\n\r\n    if (!streamEnded) {\r\n      throw new Error(\"Stream completion promise resolved unexpectedly without stream end\");\r\n    }\r\n  };\r\n\r\n  const resetCompletionHandlers = () => {\r\n    resolveCompletion = null;\r\n    rejectCompletion = null;\r\n  };\r\n\r\n  const rejectStream = (error: Error) => {\r\n    // Keep terminal output readable (error messages should not start mid-line)\r\n    closeHumanLine();\r\n    rejectCompletion?.(error);\r\n    resetCompletionHandlers();\r\n  };\r\n\r\n  const resolveStream = () => {\r\n    closeHumanLine();\r\n\r\n    streamEnded = true;\r\n    resolveCompletion?.();\r\n    resetCompletionHandlers();\r\n\r\n    activeMessageId = null;\r\n    toolCallArgs.clear();\r\n  };\r\n\r\n  const sendAndAwait = async (msg: string, options: SendMessageOptions): Promise<void> => {\r\n    completionPromise = createCompletionPromise();\r\n    const sendResult = await session.sendMessage(msg, options);\r\n    if (!sendResult.success) {\r\n      const errorValue = sendResult.error;\r\n      let formattedError = \"unknown error\";\r\n      if (typeof errorValue === \"string\") {\r\n        formattedError = errorValue;\r\n      } else if (errorValue && typeof errorValue === \"object\") {\r\n        const maybeRaw = (errorValue as { raw?: unknown }).raw;\r\n        if (typeof maybeRaw === \"string\" && maybeRaw.trim().length > 0) {\r\n          formattedError = maybeRaw;\r\n        } else {\r\n          formattedError = JSON.stringify(errorValue);\r\n        }\r\n      }\r\n      throw new Error(`Failed to send message: ${formattedError}`);\r\n    }\r\n    await waitForCompletion();\r\n  };\r\n\r\n  const handleToolStart = (payload: WorkspaceChatMessage): boolean => {\r\n    if (!isToolCallStart(payload)) return false;\r\n\r\n    // Cache args for use in end formatting\r\n    toolCallArgs.set(payload.toolCallId, payload.args);\r\n    ensureSpacing(\"tool\");\r\n\r\n    // Try formatted output, fall back to generic\r\n    const formatted = formatToolStart(payload);\r\n    if (formatted) {\r\n      // For multiline result tools, put result on a new line; for inline, keep the line open\r\n      // so the end marker (`✓` / `✗`) can land on the same line.\r\n      if (isMultilineResultTool(payload.toolName)) {\r\n        writeHumanLineClosed(formatted);\r\n      } else {\r\n        writeHumanChunk(formatted);\r\n      }\r\n    } else {\r\n      writeHumanLineClosed(formatGenericToolStart(payload));\r\n    }\r\n    return true;\r\n  };\r\n\r\n  const handleToolDelta = (payload: WorkspaceChatMessage): boolean => {\r\n    if (!isToolCallDelta(payload)) return false;\r\n    // Tool deltas (e.g., bash streaming output) - write inline\r\n    // Preserve whitespace-only chunks (e.g., newlines) to avoid merging lines\r\n    const deltaStr =\r\n      typeof payload.delta === \"string\" ? payload.delta : renderUnknown(payload.delta);\r\n    writeHumanChunk(deltaStr);\r\n    return true;\r\n  };\r\n\r\n  const handleToolEnd = (payload: WorkspaceChatMessage): boolean => {\r\n    if (!isToolCallEnd(payload)) return false;\r\n\r\n    // Retrieve cached args and clean up\r\n    const args = toolCallArgs.get(payload.toolCallId);\r\n    toolCallArgs.delete(payload.toolCallId);\r\n\r\n    // Try formatted output, fall back to generic\r\n    const formatted = formatToolEnd(payload, args);\r\n    if (formatted) {\r\n      // For multiline tools, ensure we don't concatenate results onto streaming output.\r\n      if (isMultilineResultTool(payload.toolName)) {\r\n        closeHumanLine();\r\n      }\r\n      writeHumanLineClosed(formatted);\r\n    } else {\r\n      closeHumanLine();\r\n      writeHumanLineClosed(formatGenericToolEnd(payload));\r\n    }\r\n\r\n    if (payload.toolName === \"propose_plan\") {\r\n      planProposed = true;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  const chatListener = (event: AgentSessionChatEvent) => {\r\n    const payload = event.message;\r\n\r\n    if (!readyForLive) {\r\n      if (isCaughtUpMessage(payload)) {\r\n        readyForLive = true;\r\n        emitJsonLine({ type: \"caught-up\", workspaceId });\r\n      }\r\n      return;\r\n    }\r\n\r\n    emitJsonLine({ type: \"event\", workspaceId, payload });\r\n    liveEvents.push(payload);\r\n\r\n    if (handleToolStart(payload) || handleToolDelta(payload) || handleToolEnd(payload)) {\r\n      return;\r\n    }\r\n\r\n    if (isStreamStart(payload)) {\r\n      if (activeMessageId && activeMessageId !== payload.messageId) {\r\n        rejectStream(\r\n          new Error(\r\n            `Received conflicting stream-start message IDs (${activeMessageId} vs ${payload.messageId})`\r\n          )\r\n        );\r\n        return;\r\n      }\r\n      activeMessageId = payload.messageId;\r\n      return;\r\n    }\r\n\r\n    if (isStreamDelta(payload)) {\r\n      assert(typeof payload.delta === \"string\", \"stream delta must include text\");\r\n      ensureSpacing(\"text\");\r\n      writeHumanChunk(payload.delta);\r\n      return;\r\n    }\r\n\r\n    if (isReasoningDelta(payload)) {\r\n      ensureSpacing(\"thinking\");\r\n      writeThinking(payload.delta);\r\n      return;\r\n    }\r\n\r\n    if (isReasoningEnd(payload)) {\r\n      // Ensure thinking ends with newline (spacing handled by next ensureSpacing call)\r\n      writeThinking(\"\\n\");\r\n      return;\r\n    }\r\n\r\n    if (isStreamError(payload)) {\r\n      rejectStream(new Error(payload.error));\r\n      return;\r\n    }\r\n\r\n    if (isStreamAbort(payload)) {\r\n      // Don't treat budget-triggered abort as an error\r\n      if (budgetExceeded) {\r\n        resolveStream();\r\n      } else {\r\n        rejectStream(new Error(\"Stream aborted before completion\"));\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (isStreamEnd(payload)) {\r\n      if (activeMessageId && payload.messageId !== activeMessageId) {\r\n        rejectStream(\r\n          new Error(\r\n            `Mismatched stream-end message ID. Expected ${activeMessageId}, received ${payload.messageId}`\r\n          )\r\n        );\r\n        return;\r\n      }\r\n\r\n      // Track usage for cost summary - prefer stream-end metadata, fall back to usage-delta\r\n      let displayUsage: ChatUsageDisplay | undefined;\r\n      if (payload.metadata.usage) {\r\n        displayUsage = createDisplayUsage(\r\n          payload.metadata.usage,\r\n          payload.metadata.model,\r\n          payload.metadata.providerMetadata\r\n        );\r\n      } else {\r\n        // Fallback: use cumulative usage from the last usage-delta event\r\n        const fallback = latestUsageDelta.get(payload.messageId);\r\n        if (fallback) {\r\n          displayUsage = createDisplayUsage(\r\n            fallback.usage,\r\n            fallback.model,\r\n            fallback.providerMetadata\r\n          );\r\n        }\r\n      }\r\n      if (displayUsage) {\r\n        usageHistory.push(displayUsage);\r\n\r\n        // Budget enforcement at stream-end for providers that don't emit usage-delta events\r\n        // Use cumulative cost across all messages in this run (not just the current message)\r\n        if (budget !== undefined && !budgetExceeded) {\r\n          const totalUsage = sumUsageHistory(usageHistory);\r\n          const cost = getTotalCost(totalUsage);\r\n          const hasTokens = totalUsage\r\n            ? totalUsage.input.tokens +\r\n            totalUsage.output.tokens +\r\n            totalUsage.cached.tokens +\r\n            totalUsage.cacheCreate.tokens +\r\n            totalUsage.reasoning.tokens >\r\n            0\r\n            : false;\r\n\r\n          if (hasTokens && cost === undefined) {\r\n            const errMsg = `Cannot enforce budget: unknown pricing for model \"${payload.metadata.model ?? model}\"`;\r\n            emitJsonLine({\r\n              type: \"budget-error\",\r\n              error: errMsg,\r\n              model: payload.metadata.model ?? model,\r\n            });\r\n            rejectStream(new Error(errMsg));\r\n            return;\r\n          }\r\n\r\n          if (cost !== undefined && cost > budget) {\r\n            budgetExceeded = true;\r\n            const msg = `Budget exceeded ($${cost.toFixed(2)} of $${budget.toFixed(2)}) - stopping`;\r\n            emitJsonLine({ type: \"budget-exceeded\", spent: cost, budget });\r\n            writeHumanLineClosed(`\\n${chalk.yellow(msg)}`);\r\n            // Don't interrupt - stream is already ending\r\n          }\r\n        }\r\n      }\r\n      latestUsageDelta.delete(payload.messageId);\r\n\r\n      resolveStream();\r\n      return;\r\n    }\r\n\r\n    // When a sub-agent workspace is cleaned up, its usage is rolled up into the parent\r\n    // and emitted as a session-usage-delta event. Add to usageHistory so budget checks\r\n    // and the final cost summary include sub-agent costs.\r\n    if (payload.type === \"session-usage-delta\") {\r\n      for (const usage of Object.values(payload.byModelDelta)) {\r\n        usageHistory.push(usage);\r\n      }\r\n\r\n      // Enforce budget after rolling up sub-agent costs (mirrors the stream-end budget check).\r\n      // sumUsageHistory sets hasUnknownCosts when any component has cost_usd===undefined,\r\n      // which catches models with unknown pricing regardless of how entries were merged.\r\n      if (budget !== undefined && !budgetExceeded) {\r\n        const totalUsage = sumUsageHistory(usageHistory);\r\n        const cost = getTotalCost(totalUsage);\r\n\r\n        if (totalUsage?.hasUnknownCosts) {\r\n          const errMsg = `Cannot enforce budget: sub-agent used a model with unknown pricing`;\r\n          emitJsonLine({ type: \"budget-error\", error: errMsg });\r\n          rejectStream(new Error(errMsg));\r\n          return;\r\n        }\r\n\r\n        if (cost !== undefined && cost > budget) {\r\n          budgetExceeded = true;\r\n          const msg = `Budget exceeded ($${cost.toFixed(2)} of $${budget.toFixed(2)}) - stopping`;\r\n          emitJsonLine({ type: \"budget-exceeded\", spent: cost, budget });\r\n          writeHumanLineClosed(`\\n${chalk.yellow(msg)}`);\r\n          void session.interruptStream({ abandonPartial: false });\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Capture usage-delta events as fallback when stream-end lacks usage metadata\r\n    // Also check budget limits if --budget is specified\r\n    if (isUsageDelta(payload)) {\r\n      latestUsageDelta.set(payload.messageId, {\r\n        usage: payload.cumulativeUsage,\r\n        providerMetadata: payload.cumulativeProviderMetadata,\r\n        model, // Use the model from CLI options\r\n      });\r\n\r\n      // Budget enforcement\r\n      if (budget !== undefined) {\r\n        const displayUsage = createDisplayUsage(\r\n          payload.cumulativeUsage,\r\n          model,\r\n          payload.cumulativeProviderMetadata\r\n        );\r\n\r\n        const cost = getTotalCost(displayUsage);\r\n\r\n        // Reject if model has unknown pricing: displayUsage exists with tokens but cost is undefined\r\n        // (createDisplayUsage doesn't set hasUnknownCosts; that's only set by sumUsageHistory)\r\n        // Include all token types: input, output, cached, cacheCreate, and reasoning\r\n        const hasTokens =\r\n          displayUsage &&\r\n          displayUsage.input.tokens +\r\n          displayUsage.output.tokens +\r\n          displayUsage.cached.tokens +\r\n          displayUsage.cacheCreate.tokens +\r\n          displayUsage.reasoning.tokens >\r\n          0;\r\n        if (hasTokens && cost === undefined) {\r\n          const errMsg = `Cannot enforce budget: unknown pricing for model \"${model}\"`;\r\n          emitJsonLine({ type: \"budget-error\", error: errMsg, model });\r\n          rejectStream(new Error(errMsg));\r\n          return;\r\n        }\r\n\r\n        if (cost !== undefined && cost > budget) {\r\n          budgetExceeded = true;\r\n          const msg = `Budget exceeded ($${cost.toFixed(2)} of $${budget.toFixed(2)}) - stopping`;\r\n          emitJsonLine({ type: \"budget-exceeded\", spent: cost, budget });\r\n          writeHumanLineClosed(`\\n${chalk.yellow(msg)}`);\r\n          void session.interruptStream({ abandonPartial: false });\r\n        }\r\n      }\r\n      return;\r\n    }\r\n  };\r\n\r\n  const unsubscribe = await session.subscribeChat(chatListener);\r\n\r\n  try {\r\n    await sendAndAwait(message, buildSendOptions(initialMode));\r\n\r\n    // Stop if budget was exceeded during first message\r\n    if (budgetExceeded) {\r\n      // Skip plan auto-approval and any follow-up work\r\n    } else {\r\n      const planWasProposed = planProposed;\r\n      planProposed = false;\r\n      if (initialMode === \"plan\" && !planWasProposed) {\r\n        throw new Error(\"Plan mode was requested, but the assistant never proposed a plan.\");\r\n      }\r\n      if (planWasProposed) {\r\n        writeHumanLineClosed(\r\n          \"\\n[auto] Plan received. Approving and switching to execute mode...\\n\"\r\n        );\r\n        await sendAndAwait(\"Plan approved. Execute it.\", buildSendOptions(\"exec\"));\r\n      }\r\n    }\r\n\r\n    // Output final result for --quiet mode\r\n    if (quiet) {\r\n      let finalEvent: WorkspaceChatMessage | undefined;\r\n      for (let i = liveEvents.length - 1; i >= 0; i--) {\r\n        if (isStreamEnd(liveEvents[i])) {\r\n          finalEvent = liveEvents[i];\r\n          break;\r\n        }\r\n      }\r\n      if (finalEvent && isStreamEnd(finalEvent)) {\r\n        const parts = (finalEvent as unknown as { parts?: unknown[] }).parts ?? [];\r\n        for (const part of parts) {\r\n          if (part && typeof part === \"object\" && \"type\" in part && part.type === \"text\") {\r\n            const text = (part as { text?: string }).text;\r\n            if (text) console.log(text);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Compute final usage/cost summary. usageHistory includes both parent stream usage\r\n    // (from stream-end events) and rolled-up sub-agent costs (from session-usage-delta events).\r\n    const totalUsage = sumUsageHistory(usageHistory);\r\n    const totalCost = getTotalCost(totalUsage);\r\n\r\n    // Emit run-complete event in JSON mode with usage and cost\r\n    if (emitJson) {\r\n      emitJsonLine({\r\n        type: \"run-complete\",\r\n        usage: totalUsage\r\n          ? {\r\n            inputTokens: totalUsage.input.tokens,\r\n            outputTokens: totalUsage.output.tokens,\r\n            cachedTokens: totalUsage.cached.tokens,\r\n            cacheCreateTokens: totalUsage.cacheCreate.tokens,\r\n            reasoningTokens: totalUsage.reasoning.tokens,\r\n          }\r\n          : null,\r\n        cost_usd: totalCost ?? null,\r\n      });\r\n    }\r\n\r\n    // Print cost summary at end of run (unless --hide-costs or --json)\r\n    if (!hideCosts && !emitJson) {\r\n      // Skip if no cost data or if model pricing is unknown (would show misleading $0.00)\r\n      if (totalCost !== undefined && !totalUsage?.hasUnknownCosts) {\r\n        const costLine = `Cost: ${formatCostWithDollar(totalCost)}`;\r\n        writeHumanLineClosed(\"\");\r\n        writeHumanLineClosed(stdoutIsTTY ? chalk.gray(costLine) : costLine);\r\n      }\r\n    }\r\n  } finally {\r\n    unsubscribe();\r\n    session.dispose();\r\n    mcpServerManager.dispose();\r\n    await codexOauthService.dispose();\r\n    if (!keepBackgroundProcesses) {\r\n      await backgroundProcessManager.terminateAll();\r\n    }\r\n  }\r\n\r\n  // Exit codes: 2 for budget exceeded, agent-specified exit code, or 0 for success\r\n  if (budgetExceeded) return 2;\r\n  return agentExitCode ?? 0;\r\n}\r\n\r\n// Keep process alive - Bun may exit when stdin closes even if async work is pending\r\nconst keepAliveInterval = setInterval(() => {\r\n  // No-op to keep event loop alive\r\n}, 1000000);\r\n\r\nmain()\r\n  .then((exitCode) => {\r\n    clearInterval(keepAliveInterval);\r\n    // Flush stdout before exiting — process.exit() kills immediately and may\r\n    // drop buffered writes (e.g. the run-complete JSON line piped to tee in benchmarks).\r\n    if (process.stdout.writableNeedDrain) {\r\n      const exit = () => process.exit(exitCode);\r\n      process.stdout.once(\"drain\", exit);\r\n      // Safety: if the downstream consumer closes (broken pipe) or backpressure\r\n      // never resolves, exit anyway after 1s to avoid hanging.\r\n      process.stdout.once(\"error\", exit);\r\n      process.stdout.once(\"close\", exit);\r\n      setTimeout(exit, 1000).unref();\r\n    } else {\r\n      process.exit(exitCode);\r\n    }\r\n  })\r\n  .catch((error) => {\r\n    clearInterval(keepAliveInterval);\r\n    console.error(`Error: ${error instanceof Error ? error.message : String(error)}`);\r\n    process.exit(1);\r\n  });\r\n"]}