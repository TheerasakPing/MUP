{"version":3,"file":"run.js","sourceRoot":"","sources":["../../src/cli/run.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env bun\n/**\n * `mux run` - First-class CLI for running agent sessions\n *\n * Usage:\n *   mux run \"Fix the failing tests\"\n *   mux run --dir /path/to/project \"Add authentication\"\n *   mux run --runtime \"ssh user@host\" \"Deploy changes\"\n */\n\nimport { Command } from \"commander\";\nimport { tool } from \"ai\";\nimport { z } from \"zod\";\nimport * as path from \"path\";\nimport * as fs from \"fs/promises\";\nimport * as fsSync from \"fs\";\nimport { Config } from \"@/node/config\";\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\nimport { AgentSession, type AgentSessionChatEvent } from \"@/node/services/agentSession\";\nimport { CodexOauthService } from \"@/node/services/codexOauthService\";\nimport { createCoreServices } from \"@/node/services/coreServices\";\nimport {\n  isCaughtUpMessage,\n  isReasoningDelta,\n  isReasoningEnd,\n  isStreamAbort,\n  isStreamDelta,\n  isStreamEnd,\n  isStreamError,\n  isStreamStart,\n  isToolCallDelta,\n  isToolCallEnd,\n  isToolCallStart,\n  isUsageDelta,\n  type SendMessageOptions,\n  type WorkspaceChatMessage,\n} from \"@/common/orpc/types\";\nimport { createDisplayUsage } from \"@/common/utils/tokens/displayUsage\";\nimport {\n  getTotalCost,\n  formatCostWithDollar,\n  sumUsageHistory,\n  type ChatUsageDisplay,\n} from \"@/common/utils/tokens/usageAggregator\";\nimport {\n  formatToolStart,\n  formatToolEnd,\n  formatGenericToolStart,\n  formatGenericToolEnd,\n  isMultilineResultTool,\n} from \"./toolFormatters\";\nimport { defaultModel, resolveModelAlias } from \"@/common/utils/ai/models\";\nimport { buildProvidersFromEnv, hasAnyConfiguredProvider } from \"@/node/utils/providerRequirements\";\n\nimport {\n  DEFAULT_THINKING_LEVEL,\n  THINKING_DISPLAY_LABELS,\n  parseThinkingInput,\n  type ParsedThinkingInput,\n} from \"@/common/types/thinking\";\nimport { resolveThinkingInput } from \"@/common/utils/thinking/policy\";\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\nimport { parseRuntimeModeAndHost, RUNTIME_MODE } from \"@/common/types/runtime\";\nimport assert from \"@/common/utils/assert\";\nimport type { LanguageModelV2Usage } from \"@ai-sdk/provider\";\nimport { log, type LogLevel } from \"@/node/services/log\";\nimport chalk from \"chalk\";\nimport type { InitLogger, WorkspaceInitResult } from \"@/node/runtime/Runtime\";\nimport { DockerRuntime } from \"@/node/runtime/DockerRuntime\";\nimport { runFullInit } from \"@/node/runtime/runtimeFactory\";\nimport { execSync } from \"child_process\";\nimport { getParseOptions } from \"./argv\";\nimport { EXPERIMENT_IDS } from \"@/common/constants/experiments\";\n\n// Display labels for CLI help (OFF, LOW, MED, HIGH, MAX)\nconst THINKING_LABELS_LIST = Object.values(THINKING_DISPLAY_LABELS).join(\", \");\n\ntype CLIMode = \"plan\" | \"exec\";\n\nfunction parseRuntimeConfig(value: string | undefined, srcBaseDir: string): RuntimeConfig {\n  if (!value) {\n    // Default to local for `mux run` (no worktree isolation needed for one-off)\n    return { type: \"local\" };\n  }\n\n  const parsed = parseRuntimeModeAndHost(value);\n  if (!parsed) {\n    throw new Error(\n      `Invalid runtime: '${value}'. Use 'local', 'worktree', 'ssh <host>', or 'docker <image>'`\n    );\n  }\n\n  switch (parsed.mode) {\n    case RUNTIME_MODE.LOCAL:\n      return { type: \"local\" };\n    case RUNTIME_MODE.WORKTREE:\n      return { type: \"worktree\", srcBaseDir };\n    case RUNTIME_MODE.SSH:\n      return { type: \"ssh\", host: parsed.host, srcBaseDir };\n    case RUNTIME_MODE.DOCKER:\n      return { type: \"docker\", image: parsed.image };\n    default:\n      return { type: \"local\" };\n  }\n}\n\nfunction parseThinkingLevel(value: string | undefined): ParsedThinkingInput {\n  if (!value) return DEFAULT_THINKING_LEVEL; // Default for mux run\n\n  // Accepts named levels (off, low, med, high, max, xhigh) and numeric (0–N)\n  const level = parseThinkingInput(value);\n  if (level != null) {\n    return level;\n  }\n  throw new Error(`Invalid thinking level \"${value}\". Expected: ${THINKING_LABELS_LIST}, or 0–N`);\n}\n\nfunction parseMode(value: string | undefined): CLIMode {\n  if (!value) return \"exec\";\n\n  const normalized = value.trim().toLowerCase();\n  if (normalized === \"plan\") return \"plan\";\n  if (normalized === \"exec\" || normalized === \"execute\") return \"exec\";\n\n  throw new Error(`Invalid mode \"${value}\". Expected: plan, exec`);\n}\n\nfunction generateWorkspaceId(): string {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 8);\n  return `run-${timestamp}-${random}`;\n}\n\nfunction makeCliInitLogger(writeHumanLine: (text?: string) => void): InitLogger {\n  return {\n    logStep: (msg) => writeHumanLine(`  ${msg}`),\n    logStdout: (line) => writeHumanLine(`  ${line}`),\n    logStderr: (line) => writeHumanLine(`  [stderr] ${line}`),\n    logComplete: (exitCode) => {\n      if (exitCode !== 0) writeHumanLine(`  Init completed with exit code ${exitCode}`);\n    },\n  };\n}\n\nasync function ensureDirectory(dirPath: string): Promise<void> {\n  const stats = await fs.stat(dirPath);\n  if (!stats.isDirectory()) {\n    throw new Error(`\"${dirPath}\" is not a directory`);\n  }\n}\n\nasync function gatherMessageFromStdin(): Promise<string> {\n  if (process.stdin.isTTY) {\n    return \"\";\n  }\n\n  const chunks: Uint8Array[] = [];\n  for await (const chunk of process.stdin) {\n    if (Buffer.isBuffer(chunk)) {\n      chunks.push(chunk);\n    } else if (typeof chunk === \"string\") {\n      chunks.push(Buffer.from(chunk));\n    } else if (chunk instanceof Uint8Array) {\n      chunks.push(chunk);\n    }\n  }\n  return Buffer.concat(chunks).toString(\"utf-8\");\n}\n\nfunction renderUnknown(value: unknown): string {\n  if (typeof value === \"string\") return value;\n  try {\n    return JSON.stringify(value, null, 2);\n  } catch {\n    return String(value);\n  }\n}\n\nconst VALID_EXPERIMENT_IDS = new Set<string>(Object.values(EXPERIMENT_IDS));\n\nfunction collectExperiments(value: string, previous: string[]): string[] {\n  const experimentId = value.trim().toLowerCase();\n  if (!VALID_EXPERIMENT_IDS.has(experimentId)) {\n    throw new Error(\n      `Unknown experiment \"${value}\". Valid experiments: ${[...VALID_EXPERIMENT_IDS].join(\", \")}`\n    );\n  }\n  if (previous.includes(experimentId)) {\n    return previous; // Dedupe\n  }\n  return [...previous, experimentId];\n}\n\n/**\n * Convert experiment ID array to the experiments object expected by SendMessageOptions.\n */\nfunction buildExperimentsObject(experimentIds: string[]): SendMessageOptions[\"experiments\"] {\n  if (experimentIds.length === 0) return undefined;\n\n  return {\n    programmaticToolCalling: experimentIds.includes(\"programmatic-tool-calling\"),\n    programmaticToolCallingExclusive: experimentIds.includes(\"programmatic-tool-calling-exclusive\"),\n    system1: experimentIds.includes(\"system-1\"),\n    execSubagentHardRestart: experimentIds.includes(\"exec-subagent-hard-restart\"),\n  };\n}\n\ninterface MCPServerEntry {\n  name: string;\n  command: string;\n}\n\nfunction collectMcpServers(value: string, previous: MCPServerEntry[]): MCPServerEntry[] {\n  const eqIndex = value.indexOf(\"=\");\n  if (eqIndex === -1) {\n    throw new Error(`Invalid --mcp format: \"${value}\". Expected: name=command`);\n  }\n  const name = value.slice(0, eqIndex).trim();\n  const command = value.slice(eqIndex + 1).trim();\n  if (!name) {\n    throw new Error(`Invalid --mcp format: \"${value}\". Server name is required`);\n  }\n  if (!command) {\n    throw new Error(`Invalid --mcp format: \"${value}\". Command is required`);\n  }\n  return [...previous, { name, command }];\n}\n\nconst program = new Command();\n\nprogram\n  .name(\"mux run\")\n  .description(\"Run an agent session in the current directory\")\n  .argument(\"[message...]\", \"instruction for the agent (can also be piped via stdin)\")\n  .option(\"-d, --dir <path>\", \"project directory\", process.cwd())\n  .option(\"-m, --model <model>\", \"model to use\", defaultModel)\n  .option(\n    \"-r, --runtime <runtime>\",\n    \"runtime type: local, worktree, 'ssh <host>', or 'docker <image>'\",\n    \"local\"\n  )\n  .option(\"--mode <mode>\", \"agent mode: plan or exec\", \"exec\")\n  .option(\n    \"-t, --thinking <level>\",\n    `thinking level: ${THINKING_LABELS_LIST}`,\n    THINKING_DISPLAY_LABELS[DEFAULT_THINKING_LEVEL]\n  )\n  .option(\"-v, --verbose\", \"show info-level logs (default: errors only)\")\n  .option(\"--hide-costs\", \"hide cost summary at end of run\")\n  .option(\"--log-level <level>\", \"set log level: error, warn, info, debug\")\n  .option(\"--json\", \"output NDJSON for programmatic consumption\")\n  .option(\"-q, --quiet\", \"only output final result\")\n  .option(\"--mcp <server>\", \"MCP server as name=command (can be repeated)\", collectMcpServers, [])\n  .option(\"--no-mcp-config\", \"ignore global + repo MCP config files (use only --mcp servers)\")\n  .option(\"-e, --experiment <id>\", \"enable experiment (can be repeated)\", collectExperiments, [])\n  .option(\"-b, --budget <usd>\", \"stop when session cost exceeds budget (USD)\", parseFloat)\n  .option(\"--service-tier <tier>\", \"OpenAI service tier: auto, default, flex, priority\", \"auto\")\n  .option(\"--use-1m\", \"enable 1M context window for supported Anthropic models\")\n  .option(\n    \"--keep-background-processes\",\n    \"do not terminate background processes on exit (for CI/bench)\"\n  )\n  .addHelpText(\n    \"after\",\n    `\nExamples:\n  $ mux run \"Fix the failing tests\"\n  $ mux run --dir /path/to/project \"Add authentication\"\n  $ mux run --runtime \"ssh user@host\" \"Deploy changes\"\n  $ mux run --mode plan \"Refactor the auth module\"\n  $ mux run --budget 1.50 \"Quick code review\"\n  $ echo \"Add logging\" | mux run\n  $ mux run --json \"List all files\" | jq '.type'\n  $ mux run --mcp \"memory=npx -y @modelcontextprotocol/server-memory\" \"Remember this\"\n  $ mux run --mcp \"chrome=npx chrome-devtools-mcp\" --mcp \"fs=npx @anthropic/mcp-fs\" \"Take a screenshot\"\n`\n  );\n\nprogram.parse(process.argv, getParseOptions());\n\ninterface CLIOptions {\n  dir: string;\n  model: string;\n  runtime: string;\n  mode: string;\n  thinking: string;\n  verbose?: boolean;\n  hideCosts?: boolean;\n  logLevel?: string;\n  json?: boolean;\n  quiet?: boolean;\n  mcp: MCPServerEntry[];\n  mcpConfig: boolean;\n  experiment: string[];\n  budget?: number;\n  serviceTier: \"auto\" | \"default\" | \"flex\" | \"priority\";\n  use1m?: boolean;\n  keepBackgroundProcesses?: boolean;\n}\n\nconst opts = program.opts<CLIOptions>();\nconst keepBackgroundProcesses =\n  opts.keepBackgroundProcesses === true || process.env.MUX_KEEP_BACKGROUND_PROCESSES === \"1\";\nconst messageArg = program.args.join(\" \");\n\nasync function main(): Promise<number> {\n  // Configure log level early (before any logging happens)\n  if (opts.logLevel) {\n    const level = opts.logLevel.toLowerCase();\n    if (level === \"error\" || level === \"warn\" || level === \"info\" || level === \"debug\") {\n      log.setLevel(level as LogLevel);\n    } else {\n      console.error(`Invalid log level \"${opts.logLevel}\". Expected: error, warn, info, debug`);\n      process.exit(1);\n    }\n  } else if (opts.verbose) {\n    log.setLevel(\"info\");\n  }\n  // Default is already \"warn\" for CLI mode (set in log.ts)\n\n  // Get message from arg or stdin\n  const stdinMessage = await gatherMessageFromStdin();\n  const message = messageArg?.trim() || stdinMessage.trim();\n\n  if (!message) {\n    console.error(\"Error: No message provided. Pass as argument or pipe via stdin.\");\n    console.error('Usage: mux run \"Your instruction here\"');\n    process.exit(1);\n  }\n\n  // Create ephemeral temp dir for session data (auto-cleaned on exit)\n  using tempDir = new DisposableTempDir(\"mux-run\");\n\n  // Use real config for providers, but ephemeral temp dir for session data\n  const realConfig = new Config();\n  const config = new Config(tempDir.path);\n\n  // Copy providers and secrets from real config to ephemeral config\n  const existingProviders = realConfig.loadProvidersConfig();\n  if (hasAnyConfiguredProvider(existingProviders)) {\n    // Write providers to temp config so services can find them\n    const providersFile = path.join(config.rootDir, \"providers.jsonc\");\n    fsSync.writeFileSync(providersFile, JSON.stringify(existingProviders, null, 2));\n  }\n\n  // Copy secrets so tools/MCP servers get project secrets (e.g., GH_TOKEN)\n  const existingSecrets = realConfig.loadSecretsConfig();\n  if (Object.keys(existingSecrets).length > 0) {\n    const secretsFile = path.join(config.rootDir, \"secrets.json\");\n    fsSync.writeFileSync(secretsFile, JSON.stringify(existingSecrets, null, 2));\n  }\n\n  const workspaceId = generateWorkspaceId();\n  const projectDir = path.resolve(opts.dir);\n  await ensureDirectory(projectDir);\n\n  const model: string = resolveModelAlias(opts.model);\n  const runtimeConfig = parseRuntimeConfig(opts.runtime, config.srcDir);\n  // Resolve thinking: numeric indices map to the model's allowed levels (0 = lowest)\n  const thinkingLevel = resolveThinkingInput(parseThinkingLevel(opts.thinking), model);\n  const initialMode = parseMode(opts.mode);\n  const emitJson = opts.json === true;\n  const quiet = opts.quiet === true;\n  const hideCosts = opts.hideCosts === true;\n\n  const budget = opts.budget;\n\n  // Validate budget\n  if (budget !== undefined) {\n    if (Number.isNaN(budget)) {\n      console.error(\"Error: --budget must be a valid number\");\n      process.exit(1);\n    }\n    if (budget < 0) {\n      console.error(\"Error: --budget cannot be negative\");\n      process.exit(1);\n    }\n  }\n\n  const suppressHumanOutput = emitJson || quiet;\n  const stdoutIsTTY = process.stdout.isTTY === true;\n  const stderrIsTTY = process.stderr.isTTY === true;\n\n  const writeHuman = (text: string) => {\n    if (!suppressHumanOutput) process.stdout.write(text);\n  };\n  const writeHumanLine = (text = \"\") => {\n    if (!suppressHumanOutput) process.stdout.write(`${text}\\n`);\n  };\n  const writeThinking = (text: string) => {\n    if (suppressHumanOutput) return;\n    // Purple color matching Mux UI thinking blocks (hsl(271, 76%, 53%) = #A855F7)\n    const colored = stderrIsTTY ? chalk.hex(\"#A855F7\")(text) : text;\n    process.stderr.write(colored);\n  };\n  const emitJsonLine = (payload: unknown) => {\n    if (emitJson) process.stdout.write(`${JSON.stringify(payload)}\\n`);\n  };\n\n  // Log startup info (shown at info+ level, i.e., with --verbose)\n  log.info(`Directory: ${projectDir}`);\n  log.info(`Model: ${model}`);\n  log.info(\n    `Runtime: ${runtimeConfig.type}${runtimeConfig.type === \"ssh\" ? ` (${runtimeConfig.host})` : \"\"}`\n  );\n  log.info(`Mode: ${initialMode}`);\n\n  // Bootstrap providers from env vars if no providers.jsonc exists\n  if (!hasAnyConfiguredProvider(existingProviders)) {\n    const providersFromEnv = buildProvidersFromEnv();\n    if (hasAnyConfiguredProvider(providersFromEnv)) {\n      config.saveProvidersConfig(providersFromEnv);\n    } else {\n      throw new Error(\n        \"No provider credentials found. Configure providers.jsonc or set ANTHROPIC_API_KEY / OPENAI_API_KEY / OPENROUTER_API_KEY / GOOGLE_GENERATIVE_AI_API_KEY.\"\n      );\n    }\n  }\n\n  // Initialize the core service graph (shared with ServiceContainer).\n  // CLI overrides: ephemeral extension metadata, persistent MCP config via\n  // realConfig, and CLI-specific MCPServerManager options for inline servers.\n  const inlineServers: Record<string, string> = {};\n  for (const entry of opts.mcp) {\n    inlineServers[entry.name] = entry.command;\n  }\n  const {\n    aiService,\n    historyService,\n    partialService,\n    initStateManager,\n    backgroundProcessManager,\n    mcpServerManager,\n    providerService,\n    workspaceService,\n    costTrackingService,\n  } = createCoreServices({\n    config,\n    extensionMetadataPath: path.join(tempDir.path, \"extensionMetadata.json\"),\n    mcpConfig: realConfig,\n    mcpServerManagerOptions: {\n      inlineServers,\n      ignoreConfigFile: !opts.mcpConfig,\n    },\n  });\n\n  // `mux run` uses createCoreServices directly (without ServiceContainer), so wire\n  // Codex OAuth explicitly to ensure Codex-routed OpenAI requests can load/refresh\n  // OAuth tokens from providers.jsonc.\n  const codexOauthService = new CodexOauthService(config, providerService);\n  aiService.setCodexOauthService(codexOauthService);\n\n  // CLI-only exit code control: allows agent to set the process exit code\n  // Useful for CI workflows where the agent should block merge on failure\n  let agentExitCode: number | undefined;\n  const setExitCodeSchema = z.object({\n    exit_code: z\n      .number()\n      .int()\n      .min(0)\n      .max(255)\n      .describe(\"Exit code (0 = success, 1-255 = failure)\"),\n  });\n  const setExitCodeTool = tool({\n    description:\n      \"Set the process exit code for this CLI session. \" +\n      \"Use this in CI/automation to signal success (0) or failure (non-zero). \" +\n      \"For example, exit 1 to block a PR merge when issues are found. \" +\n      \"Only available in `mux run` CLI mode.\",\n    inputSchema: setExitCodeSchema,\n    execute: ({ exit_code }: z.infer<typeof setExitCodeSchema>) => {\n      agentExitCode = exit_code;\n      return { success: true, exit_code };\n    },\n  });\n  aiService.setExtraTools({ set_exit_code: setExitCodeTool });\n\n  const session = new AgentSession({\n    workspaceId,\n    config,\n    historyService,\n    partialService,\n    aiService,\n    initStateManager,\n    costTrackingService,\n    backgroundProcessManager,\n    keepBackgroundProcesses,\n  });\n  // Register with WorkspaceService so TaskService operations that target the parent\n  // workspace (e.g. resumeStream after sub-agent completion) reuse this session\n  // instead of creating a duplicate.\n  workspaceService.registerSession(workspaceId, session);\n\n  // For Docker runtime, create and initialize the container first\n  let workspacePath = projectDir;\n  if (runtimeConfig.type === \"docker\") {\n    const runtime = new DockerRuntime(runtimeConfig);\n    // Use a sanitized branch name (CLI runs are typically one-off, no real branch needed)\n    const branchName = `cli-${workspaceId.replace(/[^a-zA-Z0-9-]/g, \"-\")}`;\n\n    // Detect trunk branch from repo\n    let trunkBranch = \"main\";\n    try {\n      const symbolic = execSync(\"git symbolic-ref refs/remotes/origin/HEAD\", {\n        cwd: projectDir,\n        encoding: \"utf-8\",\n      }).trim();\n      trunkBranch = symbolic.replace(\"refs/remotes/origin/\", \"\");\n    } catch {\n      // Fallback to main\n    }\n\n    const initLogger = makeCliInitLogger(writeHumanLine);\n    const createResult = await runtime.createWorkspace({\n      projectPath: projectDir,\n      branchName,\n      trunkBranch,\n      directoryName: branchName,\n      initLogger,\n    });\n    if (!createResult.success) {\n      console.error(`Failed to create Docker workspace: ${createResult.error ?? \"unknown error\"}`);\n      process.exit(1);\n    }\n\n    // Use runFullInit to ensure postCreateSetup runs before initWorkspace\n    let initResult: WorkspaceInitResult;\n    try {\n      initResult = await runFullInit(runtime, {\n        projectPath: projectDir,\n        branchName,\n        trunkBranch,\n        workspacePath: createResult.workspacePath!,\n        initLogger,\n      });\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      initLogger.logStderr(`Initialization failed: ${errorMessage}`);\n      initLogger.logComplete(-1);\n      initResult = { success: false, error: errorMessage };\n    }\n    if (!initResult.success) {\n      // Clean up orphaned container\n      // eslint-disable-next-line @typescript-eslint/no-empty-function\n      await runtime.deleteWorkspace(projectDir, branchName, true).catch(() => { });\n      console.error(\n        `Failed to initialize Docker workspace: ${initResult.error ?? \"unknown error\"}`\n      );\n      process.exit(1);\n    }\n\n    // Docker workspacePath is /src; projectName stays as original\n    workspacePath = createResult.workspacePath!;\n  }\n\n  // Initialize workspace metadata (ephemeral - stored in temp dir)\n  await session.ensureMetadata({\n    workspacePath,\n    projectName: path.basename(projectDir),\n    runtimeConfig,\n  });\n\n  // Note: taskService.initialize() is intentionally NOT called. It resumes tasks from a\n  // previous session, but mux run uses an ephemeral Config (temp dir) with no prior state.\n  // Calling initialize() on a fresh config is a no-op, but skipping it makes the intent\n  // clear and avoids any risk of cross-workspace side effects if config were ever shared.\n\n  const experiments = buildExperimentsObject(opts.experiment);\n\n  const buildSendOptions = (cliMode: CLIMode): SendMessageOptions => ({\n    model,\n    thinkingLevel,\n    agentId: cliMode,\n    experiments,\n    providerOptions: {\n      ...(opts.use1m && { anthropic: { use1MContext: true } }),\n      openai: { serviceTier: opts.serviceTier },\n    },\n    // Disable UI-only tools that have no effect in CLI mode:\n    // - status_set: backend no-op, status indicator only visible in desktop UI\n    // - todo_write/todo_read: TODO list only visible in desktop UI\n    // - notify: sends OS notifications via Electron, silently swallowed in CLI\n    toolPolicy: [\n      { regex_match: \"status_set\", action: \"disable\" as const },\n      { regex_match: \"todo_write\", action: \"disable\" as const },\n      { regex_match: \"todo_read\", action: \"disable\" as const },\n      { regex_match: \"notify\", action: \"disable\" as const },\n    ],\n    // Plan agent instructions are handled by the backend (has access to plan file path)\n  });\n\n  const liveEvents: WorkspaceChatMessage[] = [];\n  let readyForLive = false;\n\n  /**\n   * Tracks whether stdout currently has an unfinished line (i.e. the last write was\n   * via `writeHuman(...)` without a trailing newline).\n   *\n   * This is used to prevent concatenating multi-line blocks (like tool results) onto\n   * the end of an inline prefix.\n   */\n  let streamLineOpen = false;\n  let activeMessageId: string | null = null;\n  let planProposed = false;\n  let streamEnded = false;\n\n  // Track usage for cost summary at end of run\n  const usageHistory: ChatUsageDisplay[] = [];\n  // Track latest usage-delta per message as fallback when stream-end lacks usage metadata\n  const latestUsageDelta = new Map<\n    string,\n    { usage: LanguageModelV2Usage; providerMetadata?: Record<string, unknown>; model: string }\n  >();\n\n  const writeHumanChunk = (text: string) => {\n    if (text.length === 0) return;\n    writeHuman(text);\n    streamLineOpen = !text.endsWith(\"\\n\");\n  };\n\n  const writeHumanLineClosed = (text = \"\") => {\n    writeHumanLine(text);\n    streamLineOpen = false;\n  };\n\n  const closeHumanLine = () => {\n    if (!streamLineOpen) return;\n    writeHumanLineClosed(\"\");\n  };\n\n  // Track tool call args by toolCallId for use in end formatting\n  const toolCallArgs = new Map<string, unknown>();\n\n  // Budget tracking state\n  let budgetExceeded = false;\n\n  // Centralized output type tracking for spacing\n  type OutputType = \"none\" | \"text\" | \"thinking\" | \"tool\";\n  let lastOutputType: OutputType = \"none\";\n\n  /**\n   * Ensure proper spacing before starting a new output block.\n   * Call this before writing any output to handle transitions cleanly.\n   */\n  const ensureSpacing = (nextType: OutputType) => {\n    const isTransition = lastOutputType !== nextType;\n\n    // Finish any open line when transitioning to a different output type\n    if (isTransition) {\n      closeHumanLine();\n    }\n\n    // Add blank line for transitions (but not at start of output)\n    if (lastOutputType !== \"none\" && isTransition) {\n      writeHumanLineClosed(\"\");\n    }\n    // Also add blank line between consecutive tool calls\n    if (lastOutputType === \"tool\" && nextType === \"tool\") {\n      writeHumanLineClosed(\"\");\n    }\n\n    lastOutputType = nextType;\n  };\n\n  let resolveCompletion: ((value: void) => void) | null = null;\n  let rejectCompletion: ((reason?: unknown) => void) | null = null;\n  let completionPromise: Promise<void> = Promise.resolve();\n\n  const createCompletionPromise = (): Promise<void> => {\n    streamEnded = false;\n    return new Promise<void>((resolve, reject) => {\n      resolveCompletion = resolve;\n      rejectCompletion = reject;\n    });\n  };\n\n  const waitForCompletion = async (): Promise<void> => {\n    await completionPromise;\n\n    if (!streamEnded) {\n      throw new Error(\"Stream completion promise resolved unexpectedly without stream end\");\n    }\n  };\n\n  const resetCompletionHandlers = () => {\n    resolveCompletion = null;\n    rejectCompletion = null;\n  };\n\n  const rejectStream = (error: Error) => {\n    // Keep terminal output readable (error messages should not start mid-line)\n    closeHumanLine();\n    rejectCompletion?.(error);\n    resetCompletionHandlers();\n  };\n\n  const resolveStream = () => {\n    closeHumanLine();\n\n    streamEnded = true;\n    resolveCompletion?.();\n    resetCompletionHandlers();\n\n    activeMessageId = null;\n    toolCallArgs.clear();\n  };\n\n  const sendAndAwait = async (msg: string, options: SendMessageOptions): Promise<void> => {\n    completionPromise = createCompletionPromise();\n    const sendResult = await session.sendMessage(msg, options);\n    if (!sendResult.success) {\n      const errorValue = sendResult.error;\n      let formattedError = \"unknown error\";\n      if (typeof errorValue === \"string\") {\n        formattedError = errorValue;\n      } else if (errorValue && typeof errorValue === \"object\") {\n        const maybeRaw = (errorValue as { raw?: unknown }).raw;\n        if (typeof maybeRaw === \"string\" && maybeRaw.trim().length > 0) {\n          formattedError = maybeRaw;\n        } else {\n          formattedError = JSON.stringify(errorValue);\n        }\n      }\n      throw new Error(`Failed to send message: ${formattedError}`);\n    }\n    await waitForCompletion();\n  };\n\n  const handleToolStart = (payload: WorkspaceChatMessage): boolean => {\n    if (!isToolCallStart(payload)) return false;\n\n    // Cache args for use in end formatting\n    toolCallArgs.set(payload.toolCallId, payload.args);\n    ensureSpacing(\"tool\");\n\n    // Try formatted output, fall back to generic\n    const formatted = formatToolStart(payload);\n    if (formatted) {\n      // For multiline result tools, put result on a new line; for inline, keep the line open\n      // so the end marker (`✓` / `✗`) can land on the same line.\n      if (isMultilineResultTool(payload.toolName)) {\n        writeHumanLineClosed(formatted);\n      } else {\n        writeHumanChunk(formatted);\n      }\n    } else {\n      writeHumanLineClosed(formatGenericToolStart(payload));\n    }\n    return true;\n  };\n\n  const handleToolDelta = (payload: WorkspaceChatMessage): boolean => {\n    if (!isToolCallDelta(payload)) return false;\n    // Tool deltas (e.g., bash streaming output) - write inline\n    // Preserve whitespace-only chunks (e.g., newlines) to avoid merging lines\n    const deltaStr =\n      typeof payload.delta === \"string\" ? payload.delta : renderUnknown(payload.delta);\n    writeHumanChunk(deltaStr);\n    return true;\n  };\n\n  const handleToolEnd = (payload: WorkspaceChatMessage): boolean => {\n    if (!isToolCallEnd(payload)) return false;\n\n    // Retrieve cached args and clean up\n    const args = toolCallArgs.get(payload.toolCallId);\n    toolCallArgs.delete(payload.toolCallId);\n\n    // Try formatted output, fall back to generic\n    const formatted = formatToolEnd(payload, args);\n    if (formatted) {\n      // For multiline tools, ensure we don't concatenate results onto streaming output.\n      if (isMultilineResultTool(payload.toolName)) {\n        closeHumanLine();\n      }\n      writeHumanLineClosed(formatted);\n    } else {\n      closeHumanLine();\n      writeHumanLineClosed(formatGenericToolEnd(payload));\n    }\n\n    if (payload.toolName === \"propose_plan\") {\n      planProposed = true;\n    }\n    return true;\n  };\n\n  const chatListener = (event: AgentSessionChatEvent) => {\n    const payload = event.message;\n\n    if (!readyForLive) {\n      if (isCaughtUpMessage(payload)) {\n        readyForLive = true;\n        emitJsonLine({ type: \"caught-up\", workspaceId });\n      }\n      return;\n    }\n\n    emitJsonLine({ type: \"event\", workspaceId, payload });\n    liveEvents.push(payload);\n\n    if (handleToolStart(payload) || handleToolDelta(payload) || handleToolEnd(payload)) {\n      return;\n    }\n\n    if (isStreamStart(payload)) {\n      if (activeMessageId && activeMessageId !== payload.messageId) {\n        rejectStream(\n          new Error(\n            `Received conflicting stream-start message IDs (${activeMessageId} vs ${payload.messageId})`\n          )\n        );\n        return;\n      }\n      activeMessageId = payload.messageId;\n      return;\n    }\n\n    if (isStreamDelta(payload)) {\n      assert(typeof payload.delta === \"string\", \"stream delta must include text\");\n      ensureSpacing(\"text\");\n      writeHumanChunk(payload.delta);\n      return;\n    }\n\n    if (isReasoningDelta(payload)) {\n      ensureSpacing(\"thinking\");\n      writeThinking(payload.delta);\n      return;\n    }\n\n    if (isReasoningEnd(payload)) {\n      // Ensure thinking ends with newline (spacing handled by next ensureSpacing call)\n      writeThinking(\"\\n\");\n      return;\n    }\n\n    if (isStreamError(payload)) {\n      rejectStream(new Error(payload.error));\n      return;\n    }\n\n    if (isStreamAbort(payload)) {\n      // Don't treat budget-triggered abort as an error\n      if (budgetExceeded) {\n        resolveStream();\n      } else {\n        rejectStream(new Error(\"Stream aborted before completion\"));\n      }\n      return;\n    }\n\n    if (isStreamEnd(payload)) {\n      if (activeMessageId && payload.messageId !== activeMessageId) {\n        rejectStream(\n          new Error(\n            `Mismatched stream-end message ID. Expected ${activeMessageId}, received ${payload.messageId}`\n          )\n        );\n        return;\n      }\n\n      // Track usage for cost summary - prefer stream-end metadata, fall back to usage-delta\n      let displayUsage: ChatUsageDisplay | undefined;\n      if (payload.metadata.usage) {\n        displayUsage = createDisplayUsage(\n          payload.metadata.usage,\n          payload.metadata.model,\n          payload.metadata.providerMetadata\n        );\n      } else {\n        // Fallback: use cumulative usage from the last usage-delta event\n        const fallback = latestUsageDelta.get(payload.messageId);\n        if (fallback) {\n          displayUsage = createDisplayUsage(\n            fallback.usage,\n            fallback.model,\n            fallback.providerMetadata\n          );\n        }\n      }\n      if (displayUsage) {\n        usageHistory.push(displayUsage);\n\n        // Budget enforcement at stream-end for providers that don't emit usage-delta events\n        // Use cumulative cost across all messages in this run (not just the current message)\n        if (budget !== undefined && !budgetExceeded) {\n          const totalUsage = sumUsageHistory(usageHistory);\n          const cost = getTotalCost(totalUsage);\n          const hasTokens = totalUsage\n            ? totalUsage.input.tokens +\n            totalUsage.output.tokens +\n            totalUsage.cached.tokens +\n            totalUsage.cacheCreate.tokens +\n            totalUsage.reasoning.tokens >\n            0\n            : false;\n\n          if (hasTokens && cost === undefined) {\n            const errMsg = `Cannot enforce budget: unknown pricing for model \"${payload.metadata.model ?? model}\"`;\n            emitJsonLine({\n              type: \"budget-error\",\n              error: errMsg,\n              model: payload.metadata.model ?? model,\n            });\n            rejectStream(new Error(errMsg));\n            return;\n          }\n\n          if (cost !== undefined && cost > budget) {\n            budgetExceeded = true;\n            const msg = `Budget exceeded ($${cost.toFixed(2)} of $${budget.toFixed(2)}) - stopping`;\n            emitJsonLine({ type: \"budget-exceeded\", spent: cost, budget });\n            writeHumanLineClosed(`\\n${chalk.yellow(msg)}`);\n            // Don't interrupt - stream is already ending\n          }\n        }\n      }\n      latestUsageDelta.delete(payload.messageId);\n\n      resolveStream();\n      return;\n    }\n\n    // When a sub-agent workspace is cleaned up, its usage is rolled up into the parent\n    // and emitted as a session-usage-delta event. Add to usageHistory so budget checks\n    // and the final cost summary include sub-agent costs.\n    if (payload.type === \"session-usage-delta\") {\n      for (const usage of Object.values(payload.byModelDelta)) {\n        usageHistory.push(usage);\n      }\n\n      // Enforce budget after rolling up sub-agent costs (mirrors the stream-end budget check).\n      // sumUsageHistory sets hasUnknownCosts when any component has cost_usd===undefined,\n      // which catches models with unknown pricing regardless of how entries were merged.\n      if (budget !== undefined && !budgetExceeded) {\n        const totalUsage = sumUsageHistory(usageHistory);\n        const cost = getTotalCost(totalUsage);\n\n        if (totalUsage?.hasUnknownCosts) {\n          const errMsg = `Cannot enforce budget: sub-agent used a model with unknown pricing`;\n          emitJsonLine({ type: \"budget-error\", error: errMsg });\n          rejectStream(new Error(errMsg));\n          return;\n        }\n\n        if (cost !== undefined && cost > budget) {\n          budgetExceeded = true;\n          const msg = `Budget exceeded ($${cost.toFixed(2)} of $${budget.toFixed(2)}) - stopping`;\n          emitJsonLine({ type: \"budget-exceeded\", spent: cost, budget });\n          writeHumanLineClosed(`\\n${chalk.yellow(msg)}`);\n          void session.interruptStream({ abandonPartial: false });\n        }\n      }\n      return;\n    }\n\n    // Capture usage-delta events as fallback when stream-end lacks usage metadata\n    // Also check budget limits if --budget is specified\n    if (isUsageDelta(payload)) {\n      latestUsageDelta.set(payload.messageId, {\n        usage: payload.cumulativeUsage,\n        providerMetadata: payload.cumulativeProviderMetadata,\n        model, // Use the model from CLI options\n      });\n\n      // Budget enforcement\n      if (budget !== undefined) {\n        const displayUsage = createDisplayUsage(\n          payload.cumulativeUsage,\n          model,\n          payload.cumulativeProviderMetadata\n        );\n\n        const cost = getTotalCost(displayUsage);\n\n        // Reject if model has unknown pricing: displayUsage exists with tokens but cost is undefined\n        // (createDisplayUsage doesn't set hasUnknownCosts; that's only set by sumUsageHistory)\n        // Include all token types: input, output, cached, cacheCreate, and reasoning\n        const hasTokens =\n          displayUsage &&\n          displayUsage.input.tokens +\n          displayUsage.output.tokens +\n          displayUsage.cached.tokens +\n          displayUsage.cacheCreate.tokens +\n          displayUsage.reasoning.tokens >\n          0;\n        if (hasTokens && cost === undefined) {\n          const errMsg = `Cannot enforce budget: unknown pricing for model \"${model}\"`;\n          emitJsonLine({ type: \"budget-error\", error: errMsg, model });\n          rejectStream(new Error(errMsg));\n          return;\n        }\n\n        if (cost !== undefined && cost > budget) {\n          budgetExceeded = true;\n          const msg = `Budget exceeded ($${cost.toFixed(2)} of $${budget.toFixed(2)}) - stopping`;\n          emitJsonLine({ type: \"budget-exceeded\", spent: cost, budget });\n          writeHumanLineClosed(`\\n${chalk.yellow(msg)}`);\n          void session.interruptStream({ abandonPartial: false });\n        }\n      }\n      return;\n    }\n  };\n\n  const unsubscribe = await session.subscribeChat(chatListener);\n\n  try {\n    await sendAndAwait(message, buildSendOptions(initialMode));\n\n    // Stop if budget was exceeded during first message\n    if (budgetExceeded) {\n      // Skip plan auto-approval and any follow-up work\n    } else {\n      const planWasProposed = planProposed;\n      planProposed = false;\n      if (initialMode === \"plan\" && !planWasProposed) {\n        throw new Error(\"Plan mode was requested, but the assistant never proposed a plan.\");\n      }\n      if (planWasProposed) {\n        writeHumanLineClosed(\n          \"\\n[auto] Plan received. Approving and switching to execute mode...\\n\"\n        );\n        await sendAndAwait(\"Plan approved. Execute it.\", buildSendOptions(\"exec\"));\n      }\n    }\n\n    // Output final result for --quiet mode\n    if (quiet) {\n      let finalEvent: WorkspaceChatMessage | undefined;\n      for (let i = liveEvents.length - 1; i >= 0; i--) {\n        if (isStreamEnd(liveEvents[i])) {\n          finalEvent = liveEvents[i];\n          break;\n        }\n      }\n      if (finalEvent && isStreamEnd(finalEvent)) {\n        const parts = (finalEvent as unknown as { parts?: unknown[] }).parts ?? [];\n        for (const part of parts) {\n          if (part && typeof part === \"object\" && \"type\" in part && part.type === \"text\") {\n            const text = (part as { text?: string }).text;\n            if (text) console.log(text);\n          }\n        }\n      }\n    }\n\n    // Compute final usage/cost summary. usageHistory includes both parent stream usage\n    // (from stream-end events) and rolled-up sub-agent costs (from session-usage-delta events).\n    const totalUsage = sumUsageHistory(usageHistory);\n    const totalCost = getTotalCost(totalUsage);\n\n    // Emit run-complete event in JSON mode with usage and cost\n    if (emitJson) {\n      emitJsonLine({\n        type: \"run-complete\",\n        usage: totalUsage\n          ? {\n            inputTokens: totalUsage.input.tokens,\n            outputTokens: totalUsage.output.tokens,\n            cachedTokens: totalUsage.cached.tokens,\n            cacheCreateTokens: totalUsage.cacheCreate.tokens,\n            reasoningTokens: totalUsage.reasoning.tokens,\n          }\n          : null,\n        cost_usd: totalCost ?? null,\n      });\n    }\n\n    // Print cost summary at end of run (unless --hide-costs or --json)\n    if (!hideCosts && !emitJson) {\n      // Skip if no cost data or if model pricing is unknown (would show misleading $0.00)\n      if (totalCost !== undefined && !totalUsage?.hasUnknownCosts) {\n        const costLine = `Cost: ${formatCostWithDollar(totalCost)}`;\n        writeHumanLineClosed(\"\");\n        writeHumanLineClosed(stdoutIsTTY ? chalk.gray(costLine) : costLine);\n      }\n    }\n  } finally {\n    unsubscribe();\n    session.dispose();\n    mcpServerManager.dispose();\n    await codexOauthService.dispose();\n    if (!keepBackgroundProcesses) {\n      await backgroundProcessManager.terminateAll();\n    }\n  }\n\n  // Exit codes: 2 for budget exceeded, agent-specified exit code, or 0 for success\n  if (budgetExceeded) return 2;\n  return agentExitCode ?? 0;\n}\n\n// Keep process alive - Bun may exit when stdin closes even if async work is pending\nconst keepAliveInterval = setInterval(() => {\n  // No-op to keep event loop alive\n}, 1000000);\n\nmain()\n  .then((exitCode) => {\n    clearInterval(keepAliveInterval);\n    // Flush stdout before exiting — process.exit() kills immediately and may\n    // drop buffered writes (e.g. the run-complete JSON line piped to tee in benchmarks).\n    if (process.stdout.writableNeedDrain) {\n      const exit = () => process.exit(exitCode);\n      process.stdout.once(\"drain\", exit);\n      // Safety: if the downstream consumer closes (broken pipe) or backpressure\n      // never resolves, exit anyway after 1s to avoid hanging.\n      process.stdout.once(\"error\", exit);\n      process.stdout.once(\"close\", exit);\n      setTimeout(exit, 1000).unref();\n    } else {\n      process.exit(exitCode);\n    }\n  })\n  .catch((error) => {\n    clearInterval(keepAliveInterval);\n    console.error(`Error: ${error instanceof Error ? error.message : String(error)}`);\n    process.exit(1);\n  });\n"]}