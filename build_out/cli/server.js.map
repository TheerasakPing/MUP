{"version":3,"file":"server.js","sourceRoot":"","sources":["../../src/cli/server.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * CLI entry point for the mux oRPC server.\n * Uses createOrpcServer from ./orpcServer.ts for the actual server logic.\n */\nimport { Config } from \"@/node/config\";\nimport { ServiceContainer } from \"@/node/services/serviceContainer\";\nimport { ServerLockfile } from \"@/node/services/serverLockfile\";\nimport { getMuxHome, migrateLegacyMuxHome } from \"@/common/constants/paths\";\nimport type { BrowserWindow } from \"electron\";\nimport { Command } from \"commander\";\nimport { validateProjectPath } from \"@/node/utils/pathUtils\";\nimport { createOrpcServer } from \"@/node/orpc/server\";\nimport { VERSION } from \"@/version\";\nimport {\n  buildMuxMdnsServiceOptions,\n  MdnsAdvertiserService,\n} from \"@/node/services/mdnsAdvertiserService\";\nimport * as os from \"os\";\nimport { getParseOptions } from \"./argv\";\n\nconst program = new Command();\nprogram\n  .name(\"mux server\")\n  .description(\"HTTP/WebSocket ORPC server for mux\")\n  .option(\"-h, --host <host>\", \"bind to specific host\", \"localhost\")\n  .option(\"-p, --port <port>\", \"bind to specific port\", \"3000\")\n  .option(\"--auth-token <token>\", \"optional bearer token for HTTP/WS auth\")\n  .option(\"--ssh-host <host>\", \"SSH hostname/alias for editor deep links (e.g., devbox)\")\n  .option(\"--add-project <path>\", \"add and open project at the specified path (idempotent)\")\n  .parse(process.argv, getParseOptions());\n\nconst options = program.opts();\nconst HOST = options.host as string;\nconst PORT = Number.parseInt(String(options.port), 10);\nconst rawAuthToken = (options.authToken as string | undefined) ?? process.env.MUX_SERVER_AUTH_TOKEN;\nconst AUTH_TOKEN = rawAuthToken?.trim() ? rawAuthToken.trim() : undefined;\nconst ADD_PROJECT_PATH = options.addProject as string | undefined;\n// SSH host for editor deep links (CLI flag > env var > config file, resolved later)\nconst CLI_SSH_HOST = options.sshHost as string | undefined;\n\n// Track the launch project path for initial navigation\nlet launchProjectPath: string | null = null;\n\nfunction isLoopbackHost(host: string): boolean {\n  const normalized = host.trim().toLowerCase();\n\n  // IPv4 loopback range (RFC 1122): 127.0.0.0/8\n  if (normalized.startsWith(\"127.\")) {\n    return true;\n  }\n\n  return normalized === \"localhost\" || normalized === \"::1\";\n}\n\n// Minimal BrowserWindow stub for services that expect one\nconst mockWindow: BrowserWindow = {\n  isDestroyed: () => false,\n  setTitle: () => undefined,\n  webContents: {\n    send: () => undefined,\n    openDevTools: () => undefined,\n  },\n} as unknown as BrowserWindow;\n\n(async () => {\n  // Keepalive interval to prevent premature process exit during async initialization.\n  // During startup, taskService.initialize() may resume running tasks by calling\n  // sendMessage(), which spawns background AI streams. Between the completion of\n  // serviceContainer.initialize() and the HTTP server starting to listen, there can\n  // be a brief moment where no ref'd handles exist, causing Node to exit with code 0.\n  // This interval ensures the event loop stays alive until the server is listening.\n  const startupKeepalive = setInterval(() => {\n    // Intentionally empty - keeps event loop alive during startup\n  }, 1000);\n\n  migrateLegacyMuxHome();\n\n  // Check for existing server (Electron or another mux server instance)\n  const lockfile = new ServerLockfile(getMuxHome());\n  const existing = await lockfile.read();\n  if (existing) {\n    console.error(`Error: mux API server is already running at ${existing.baseUrl}`);\n    console.error(`Use 'mux api' commands to interact with the running instance.`);\n    process.exit(1);\n  }\n\n  const config = new Config();\n  const serviceContainer = new ServiceContainer(config);\n  await serviceContainer.initialize();\n  serviceContainer.windowService.setMainWindow(mockWindow);\n\n  if (ADD_PROJECT_PATH) {\n    await initializeProjectDirect(ADD_PROJECT_PATH, serviceContainer);\n  }\n\n  // Set launch project path for clients\n  serviceContainer.serverService.setLaunchProject(launchProjectPath);\n\n  // Set SSH host for editor deep links (CLI > env > config file)\n  const sshHost = CLI_SSH_HOST ?? process.env.MUX_SSH_HOST ?? config.getServerSshHost();\n  serviceContainer.serverService.setSshHost(sshHost);\n\n  const context = serviceContainer.toORPCContext();\n\n  const mdnsAdvertiser = new MdnsAdvertiserService();\n  const server = await createOrpcServer({\n    host: HOST,\n    port: PORT,\n    authToken: AUTH_TOKEN,\n    context,\n    serveStatic: true,\n  });\n\n  // Server is now listening - clear the startup keepalive since httpServer keeps the loop alive\n  clearInterval(startupKeepalive);\n\n  // Acquire lockfile so other instances know we're running\n  await lockfile.acquire(server.baseUrl, AUTH_TOKEN ?? \"\");\n\n  const mdnsAdvertisementEnabled = config.getMdnsAdvertisementEnabled();\n  if (mdnsAdvertisementEnabled !== false && !isLoopbackHost(HOST)) {\n    const instanceName = config.getMdnsServiceName() ?? `mux-${os.hostname()}`;\n    const serviceOptions = buildMuxMdnsServiceOptions({\n      bindHost: HOST,\n      port: server.port,\n      instanceName,\n      version: VERSION.git_describe,\n      authRequired: AUTH_TOKEN?.trim().length ? true : false,\n    });\n\n    try {\n      await mdnsAdvertiser.start(serviceOptions);\n    } catch (err) {\n      console.warn(\"Failed to advertise mux API server via mDNS:\", err);\n    }\n  } else if (mdnsAdvertisementEnabled === true && isLoopbackHost(HOST)) {\n    console.warn(\n      \"mDNS advertisement requested, but the API server is loopback-only. \" +\n        \"Set --host 0.0.0.0 (or a LAN IP) to enable LAN discovery.\"\n    );\n  }\n\n  console.log(`Server is running on ${server.baseUrl}`);\n\n  // Cleanup on shutdown\n  let cleanupInProgress = false;\n  const cleanup = async () => {\n    if (cleanupInProgress) return;\n    cleanupInProgress = true;\n\n    console.log(\"Shutting down server...\");\n\n    // Force exit after timeout if cleanup hangs\n    const forceExitTimer = setTimeout(() => {\n      console.log(\"Cleanup timed out, forcing exit...\");\n      process.exit(1);\n    }, 5000);\n\n    try {\n      // Close all PTY sessions first (these are the \"sub-processes\" nodemon sees)\n      serviceContainer.terminalService.closeAllSessions();\n\n      // Dispose background processes\n      await serviceContainer.dispose();\n\n      // Release lockfile and close server\n      try {\n        await mdnsAdvertiser.stop();\n      } catch (err) {\n        console.warn(\"Failed to stop mDNS advertiser:\", err);\n      }\n\n      await lockfile.release();\n      await server.close();\n\n      clearTimeout(forceExitTimer);\n      process.exit(0);\n    } catch (err) {\n      console.error(\"Cleanup error:\", err);\n      clearTimeout(forceExitTimer);\n      process.exit(1);\n    }\n  };\n\n  process.on(\"SIGINT\", () => void cleanup());\n  process.on(\"SIGTERM\", () => void cleanup());\n})().catch((error) => {\n  console.error(\"Failed to initialize server:\", error);\n  process.exit(1);\n});\n\nasync function initializeProjectDirect(\n  projectPath: string,\n  serviceContainer: ServiceContainer\n): Promise<void> {\n  try {\n    let normalizedPath = projectPath.replace(/\\/+$/, \"\");\n    const validation = await validateProjectPath(normalizedPath);\n    if (!validation.valid || !validation.expandedPath) {\n      console.error(\n        `Invalid project path provided via --add-project: ${validation.error ?? \"unknown error\"}`\n      );\n      return;\n    }\n    normalizedPath = validation.expandedPath;\n\n    const projects = serviceContainer.projectService.list();\n    const alreadyExists = Array.isArray(projects)\n      ? projects.some(([path]) => path === normalizedPath)\n      : false;\n\n    if (alreadyExists) {\n      console.log(`Project already exists: ${normalizedPath}`);\n      launchProjectPath = normalizedPath;\n      return;\n    }\n\n    console.log(`Creating project via --add-project: ${normalizedPath}`);\n    const result = await serviceContainer.projectService.create(normalizedPath);\n    if (result.success) {\n      console.log(`Project created at ${normalizedPath}`);\n      launchProjectPath = normalizedPath;\n    } else {\n      const errorMsg =\n        typeof result.error === \"string\"\n          ? result.error\n          : JSON.stringify(result.error ?? \"unknown error\");\n      console.error(`Failed to create project at ${normalizedPath}: ${errorMsg}`);\n    }\n  } catch (error) {\n    console.error(`initializeProject failed for ${projectPath}:`, error);\n  }\n}\n"]}