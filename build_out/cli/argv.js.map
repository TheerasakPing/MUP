{"version":3,"file":"argv.js","sourceRoot":"","sources":["../../src/cli/argv.ts"],"names":[],"mappings":";AAAA;;;;;GAKG;;;;;;;;;AAWH;;;;;;;;GAQG;AACH,8BACE,QAAQ,GAAuC,OAAO,CAAC,QAAQ,EAC/D,UAAU,GAAwB,OAAO,CAAC,UAAU,EACpC;IAChB,MAAM,UAAU,GAAG,UAAU,IAAI,QAAQ,CAAC;IAC1C,MAAM,kBAAkB,GAAG,UAAU,IAAI,CAAC,UAAU,CAAC;IACrD,MAAM,aAAa,GAAG,kBAAkB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;IACjD,OAAO,EAAE,UAAU,EAAE,kBAAkB,EAAE,aAAa,EAAE,CAAC;AAAA,CAC1D;AAED;;;GAGG;AACH,yBAAgC,GAAG,GAAmB,oBAAoB,EAAE,EAE1E;IACA,OAAO,EAAE,IAAI,EAAE,GAAG,CAAC,kBAAkB,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC;AAAA,CAC/D;AAED;;GAEG;AACH,uBACE,IAAI,GAAa,OAAO,CAAC,IAAI,EAC7B,GAAG,GAAmB,oBAAoB,EAAE,EACxB;IACpB,OAAO,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AAAA,CAChC;AAED;;;;;;;;;GASG;AACH,4BACE,IAAI,GAAa,OAAO,CAAC,IAAI,EAC7B,GAAG,GAAmB,oBAAoB,EAAE,EAClC;IACV,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AAAA,CACtC;AAED;;;;;;GAMG;AACU,QAAA,gBAAgB,GAAG,CAAC,QAAQ,EAAE,IAAI,EAAE,WAAW,EAAE,IAAI,CAAU,CAAC;AAE7E;;;;;GAKG;AACH,6BACE,UAA8B,EAC9B,GAAG,GAAmB,oBAAoB,EAAE,EACnC;IACT,IAAI,CAAC,GAAG,CAAC,UAAU;QAAE,OAAO,KAAK,CAAC;IAElC,qEAAqE;IACrE,wEAAwE;IACxE,IAAI,UAAU,EAAE,UAAU,CAAC,QAAQ,CAAC,KAAK,IAAI;QAAE,OAAO,IAAI,CAAC;IAE3D,IAAI,GAAG,CAAC,kBAAkB,EAAE,CAAC;QAC3B,iEAAiE;QACjE,OAAO,OAAO,CACZ,UAAU,EAAE,UAAU,CAAC,GAAG,CAAC;YAC3B,CAAC,QAAA,gBAAgB,CAAC,QAAQ,CAAC,UAA+C,CAAC,CAC5E,CAAC;IACJ,CAAC;IAED,6CAA6C;IAC7C,OAAO,UAAU,KAAK,GAAG,IAAI,UAAU,EAAE,UAAU,CAAC,GAAG,CAAC,KAAK,IAAI,CAAC;AAAA,CACnE;AAED;;;;GAIG;AACH,4BACE,OAAe,EACf,GAAG,GAAmB,oBAAoB,EAAE,EACnC;IACT,IAAI,OAAO,KAAK,KAAK,EAAE,CAAC;QACtB,kFAAkF;QAClF,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC;IACzB,CAAC;IACD,IAAI,OAAO,KAAK,SAAS,EAAE,CAAC;QAC1B,mEAAmE;QACnE,4EAA4E;QAC5E,8EAA8E;QAC9E,OAAO,GAAG,CAAC,UAAU,CAAC;IACxB,CAAC;IACD,OAAO,IAAI,CAAC;AAAA,CACb","sourcesContent":["/**\n * CLI environment detection for correct argv parsing across:\n * - bun/node direct invocation\n * - Electron dev mode (electron .)\n * - Packaged Electron app (./mux.AppImage)\n */\n\nexport interface CliEnvironment {\n  /** Running under Electron runtime */\n  isElectron: boolean;\n  /** Running as packaged Electron app (not dev mode) */\n  isPackagedElectron: boolean;\n  /** Index of first user argument in process.argv */\n  firstArgIndex: number;\n}\n\n/**\n * Detect CLI environment from process state.\n *\n * | Environment       | isElectron | defaultApp | firstArgIndex |\n * |-------------------|------------|------------|---------------|\n * | bun/node          | false      | undefined  | 2             |\n * | electron dev      | true       | true       | 2             |\n * | packaged electron | true       | undefined  | 1             |\n */\nexport function detectCliEnvironment(\n  versions: Record<string, string | undefined> = process.versions,\n  defaultApp: boolean | undefined = process.defaultApp\n): CliEnvironment {\n  const isElectron = \"electron\" in versions;\n  const isPackagedElectron = isElectron && !defaultApp;\n  const firstArgIndex = isPackagedElectron ? 1 : 2;\n  return { isElectron, isPackagedElectron, firstArgIndex };\n}\n\n/**\n * Get Commander parse options for current environment.\n * Use with: program.parse(process.argv, getParseOptions())\n */\nexport function getParseOptions(env: CliEnvironment = detectCliEnvironment()): {\n  from: \"electron\" | \"node\";\n} {\n  return { from: env.isPackagedElectron ? \"electron\" : \"node\" };\n}\n\n/**\n * Get the subcommand from argv (e.g., \"server\", \"api\", \"run\").\n */\nexport function getSubcommand(\n  argv: string[] = process.argv,\n  env: CliEnvironment = detectCliEnvironment()\n): string | undefined {\n  return argv[env.firstArgIndex];\n}\n\n/**\n * Get args for a subcommand after the subcommand name has been spliced out.\n * This is what subcommand handlers (server.ts, api.ts, run.ts) use after\n * index.ts removes the subcommand name from process.argv.\n *\n * @example\n * // Original: [\"electron\", \".\", \"api\", \"--help\"]\n * // After index.ts splices: [\"electron\", \".\", \"--help\"]\n * // getArgsAfterSplice returns: [\"--help\"]\n */\nexport function getArgsAfterSplice(\n  argv: string[] = process.argv,\n  env: CliEnvironment = detectCliEnvironment()\n): string[] {\n  return argv.slice(env.firstArgIndex);\n}\n\n/**\n * Global CLI flags that should show help/version, not launch desktop.\n * Commander auto-adds --help/-h. We add --version/-v in index.ts.\n *\n * IMPORTANT: If you add new global flags to the CLI in index.ts,\n * add them here too so packaged Electron routes them correctly.\n */\nexport const CLI_GLOBAL_FLAGS = [\"--help\", \"-h\", \"--version\", \"-v\"] as const;\n\n/**\n * Check if the subcommand is an Electron launch arg (not a real CLI command).\n * In dev mode, \".\" or flags before the app path should launch desktop.\n * In packaged mode, Electron flags (--no-sandbox, etc.) should launch desktop,\n * but CLI flags (--help, --version) should show CLI help.\n */\nexport function isElectronLaunchArg(\n  subcommand: string | undefined,\n  env: CliEnvironment = detectCliEnvironment()\n): boolean {\n  if (!env.isElectron) return false;\n\n  // In packaged Electron, Windows/Linux deep links are passed in argv.\n  // Treat them as desktop launch args instead of unknown CLI subcommands.\n  if (subcommand?.startsWith(\"mux://\") === true) return true;\n\n  if (env.isPackagedElectron) {\n    // In packaged: flags that aren't CLI flags should launch desktop\n    return Boolean(\n      subcommand?.startsWith(\"-\") &&\n      !CLI_GLOBAL_FLAGS.includes(subcommand as (typeof CLI_GLOBAL_FLAGS)[number])\n    );\n  }\n\n  // Dev mode: \".\" or any flag launches desktop\n  return subcommand === \".\" || subcommand?.startsWith(\"-\") === true;\n}\n\n/**\n * Check if a command is available in the current environment.\n * - \"run\" requires bun/node - it's not bundled in Electron.\n * - \"desktop\" only works when running inside Electron runtime.\n */\nexport function isCommandAvailable(\n  command: string,\n  env: CliEnvironment = detectCliEnvironment()\n): boolean {\n  if (command === \"run\") {\n    // run.ts is only available in bun/node, not bundled in Electron (dev or packaged)\n    return !env.isElectron;\n  }\n  if (command === \"desktop\") {\n    // Desktop command only works when running inside Electron runtime.\n    // When run via node/bun (npx mux), require(\"../desktop/main\") fails because\n    // the Electron APIs aren't available. Users should download the packaged app.\n    return env.isElectron;\n  }\n  return true;\n}\n"]}