{"version":3,"file":"argv.js","sourceRoot":"","sources":["../../src/cli/argv.ts"],"names":[],"mappings":";AAAA;;;;;GAKG;;;;;;;;;AAWH;;;;;;;;GAQG;AACH,8BACE,QAAQ,GAAuC,OAAO,CAAC,QAAQ,EAC/D,UAAU,GAAwB,OAAO,CAAC,UAAU,EACpC;IAChB,MAAM,UAAU,GAAG,UAAU,IAAI,QAAQ,CAAC;IAC1C,MAAM,kBAAkB,GAAG,UAAU,IAAI,CAAC,UAAU,CAAC;IACrD,MAAM,aAAa,GAAG,kBAAkB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;IACjD,OAAO,EAAE,UAAU,EAAE,kBAAkB,EAAE,aAAa,EAAE,CAAC;AAAA,CAC1D;AAED;;;GAGG;AACH,yBAAgC,GAAG,GAAmB,oBAAoB,EAAE,EAE1E;IACA,OAAO,EAAE,IAAI,EAAE,GAAG,CAAC,kBAAkB,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC;AAAA,CAC/D;AAED;;GAEG;AACH,uBACE,IAAI,GAAa,OAAO,CAAC,IAAI,EAC7B,GAAG,GAAmB,oBAAoB,EAAE,EACxB;IACpB,OAAO,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AAAA,CAChC;AAED;;;;;;;;;GASG;AACH,4BACE,IAAI,GAAa,OAAO,CAAC,IAAI,EAC7B,GAAG,GAAmB,oBAAoB,EAAE,EAClC;IACV,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AAAA,CACtC;AAED;;;;;;GAMG;AACU,QAAA,gBAAgB,GAAG,CAAC,QAAQ,EAAE,IAAI,EAAE,WAAW,EAAE,IAAI,CAAU,CAAC;AAE7E;;;;;GAKG;AACH,6BACE,UAA8B,EAC9B,GAAG,GAAmB,oBAAoB,EAAE,EACnC;IACT,IAAI,CAAC,GAAG,CAAC,UAAU;QAAE,OAAO,KAAK,CAAC;IAElC,qEAAqE;IACrE,wEAAwE;IACxE,IAAI,UAAU,EAAE,UAAU,CAAC,QAAQ,CAAC,KAAK,IAAI;QAAE,OAAO,IAAI,CAAC;IAE3D,IAAI,GAAG,CAAC,kBAAkB,EAAE,CAAC;QAC3B,iEAAiE;QACjE,OAAO,OAAO,CACZ,UAAU,EAAE,UAAU,CAAC,GAAG,CAAC;YAC3B,CAAC,QAAA,gBAAgB,CAAC,QAAQ,CAAC,UAA+C,CAAC,CAC5E,CAAC;IACJ,CAAC;IAED,6CAA6C;IAC7C,OAAO,UAAU,KAAK,GAAG,IAAI,UAAU,EAAE,UAAU,CAAC,GAAG,CAAC,KAAK,IAAI,CAAC;AAAA,CACnE;AAED;;;;GAIG;AACH,4BACE,OAAe,EACf,GAAG,GAAmB,oBAAoB,EAAE,EACnC;IACT,IAAI,OAAO,KAAK,KAAK,EAAE,CAAC;QACtB,kFAAkF;QAClF,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC;IACzB,CAAC;IACD,IAAI,OAAO,KAAK,SAAS,EAAE,CAAC;QAC1B,mEAAmE;QACnE,4EAA4E;QAC5E,8EAA8E;QAC9E,OAAO,GAAG,CAAC,UAAU,CAAC;IACxB,CAAC;IACD,OAAO,IAAI,CAAC;AAAA,CACb","sourcesContent":["/**\r\n * CLI environment detection for correct argv parsing across:\r\n * - bun/node direct invocation\r\n * - Electron dev mode (electron .)\r\n * - Packaged Electron app (./mux.AppImage)\r\n */\r\n\r\nexport interface CliEnvironment {\r\n  /** Running under Electron runtime */\r\n  isElectron: boolean;\r\n  /** Running as packaged Electron app (not dev mode) */\r\n  isPackagedElectron: boolean;\r\n  /** Index of first user argument in process.argv */\r\n  firstArgIndex: number;\r\n}\r\n\r\n/**\r\n * Detect CLI environment from process state.\r\n *\r\n * | Environment       | isElectron | defaultApp | firstArgIndex |\r\n * |-------------------|------------|------------|---------------|\r\n * | bun/node          | false      | undefined  | 2             |\r\n * | electron dev      | true       | true       | 2             |\r\n * | packaged electron | true       | undefined  | 1             |\r\n */\r\nexport function detectCliEnvironment(\r\n  versions: Record<string, string | undefined> = process.versions,\r\n  defaultApp: boolean | undefined = process.defaultApp\r\n): CliEnvironment {\r\n  const isElectron = \"electron\" in versions;\r\n  const isPackagedElectron = isElectron && !defaultApp;\r\n  const firstArgIndex = isPackagedElectron ? 1 : 2;\r\n  return { isElectron, isPackagedElectron, firstArgIndex };\r\n}\r\n\r\n/**\r\n * Get Commander parse options for current environment.\r\n * Use with: program.parse(process.argv, getParseOptions())\r\n */\r\nexport function getParseOptions(env: CliEnvironment = detectCliEnvironment()): {\r\n  from: \"electron\" | \"node\";\r\n} {\r\n  return { from: env.isPackagedElectron ? \"electron\" : \"node\" };\r\n}\r\n\r\n/**\r\n * Get the subcommand from argv (e.g., \"server\", \"api\", \"run\").\r\n */\r\nexport function getSubcommand(\r\n  argv: string[] = process.argv,\r\n  env: CliEnvironment = detectCliEnvironment()\r\n): string | undefined {\r\n  return argv[env.firstArgIndex];\r\n}\r\n\r\n/**\r\n * Get args for a subcommand after the subcommand name has been spliced out.\r\n * This is what subcommand handlers (server.ts, api.ts, run.ts) use after\r\n * index.ts removes the subcommand name from process.argv.\r\n *\r\n * @example\r\n * // Original: [\"electron\", \".\", \"api\", \"--help\"]\r\n * // After index.ts splices: [\"electron\", \".\", \"--help\"]\r\n * // getArgsAfterSplice returns: [\"--help\"]\r\n */\r\nexport function getArgsAfterSplice(\r\n  argv: string[] = process.argv,\r\n  env: CliEnvironment = detectCliEnvironment()\r\n): string[] {\r\n  return argv.slice(env.firstArgIndex);\r\n}\r\n\r\n/**\r\n * Global CLI flags that should show help/version, not launch desktop.\r\n * Commander auto-adds --help/-h. We add --version/-v in index.ts.\r\n *\r\n * IMPORTANT: If you add new global flags to the CLI in index.ts,\r\n * add them here too so packaged Electron routes them correctly.\r\n */\r\nexport const CLI_GLOBAL_FLAGS = [\"--help\", \"-h\", \"--version\", \"-v\"] as const;\r\n\r\n/**\r\n * Check if the subcommand is an Electron launch arg (not a real CLI command).\r\n * In dev mode, \".\" or flags before the app path should launch desktop.\r\n * In packaged mode, Electron flags (--no-sandbox, etc.) should launch desktop,\r\n * but CLI flags (--help, --version) should show CLI help.\r\n */\r\nexport function isElectronLaunchArg(\r\n  subcommand: string | undefined,\r\n  env: CliEnvironment = detectCliEnvironment()\r\n): boolean {\r\n  if (!env.isElectron) return false;\r\n\r\n  // In packaged Electron, Windows/Linux deep links are passed in argv.\r\n  // Treat them as desktop launch args instead of unknown CLI subcommands.\r\n  if (subcommand?.startsWith(\"mux://\") === true) return true;\r\n\r\n  if (env.isPackagedElectron) {\r\n    // In packaged: flags that aren't CLI flags should launch desktop\r\n    return Boolean(\r\n      subcommand?.startsWith(\"-\") &&\r\n      !CLI_GLOBAL_FLAGS.includes(subcommand as (typeof CLI_GLOBAL_FLAGS)[number])\r\n    );\r\n  }\r\n\r\n  // Dev mode: \".\" or any flag launches desktop\r\n  return subcommand === \".\" || subcommand?.startsWith(\"-\") === true;\r\n}\r\n\r\n/**\r\n * Check if a command is available in the current environment.\r\n * - \"run\" requires bun/node - it's not bundled in Electron.\r\n * - \"desktop\" only works when running inside Electron runtime.\r\n */\r\nexport function isCommandAvailable(\r\n  command: string,\r\n  env: CliEnvironment = detectCliEnvironment()\r\n): boolean {\r\n  if (command === \"run\") {\r\n    // run.ts is only available in bun/node, not bundled in Electron (dev or packaged)\r\n    return !env.isElectron;\r\n  }\r\n  if (command === \"desktop\") {\r\n    // Desktop command only works when running inside Electron runtime.\r\n    // When run via node/bun (npx mux), require(\"../desktop/main\") fails because\r\n    // the Electron APIs aren't available. Users should download the packaged app.\r\n    return env.isElectron;\r\n  }\r\n  return true;\r\n}\r\n"]}