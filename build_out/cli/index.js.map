{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/cli/index.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\n/**\n * Mux CLI entry point.\n *\n * LAZY LOADING REQUIREMENT:\n * We manually route subcommands before calling program.parse() to avoid\n * eagerly importing heavy modules. The desktop app imports Electron, which\n * fails when running CLI commands in non-GUI environments. Subcommands like\n * `run` and `server` import the AI SDK which has significant startup cost.\n *\n * By checking argv first, we only load the code path actually needed.\n *\n * ELECTRON DETECTION:\n * When run via `electron .` or as a packaged app, Electron sets process.versions.electron.\n * In that case, we launch the desktop app automatically. When run via `bun` or `node`,\n * we show CLI help instead.\n *\n * ARGV OFFSET:\n * In development (`electron .`), argv = [electron, \".\", ...args] so first arg is at index 2.\n * In packaged apps (`./mux.AppImage`), argv = [app, ...args] so first arg is at index 1.\n * process.defaultApp is true in dev mode and undefined in packaged apps.\n */\nimport { Command } from \"commander\";\nimport { VERSION } from \"../version_gen\";\nimport {\n  CLI_GLOBAL_FLAGS,\n  detectCliEnvironment,\n  getParseOptions,\n  getSubcommand,\n  isCommandAvailable,\n  isElectronLaunchArg,\n} from \"./argv\";\n\nconst env = detectCliEnvironment();\nconst subcommand = getSubcommand(process.argv, env);\n\nfunction launchDesktop(): void {\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  require(\"../desktop/main\");\n}\n\n// Route known subcommands to their dedicated entry points (each has its own Commander instance)\n\nif (subcommand === \"run\") {\n  if (!isCommandAvailable(\"run\", env)) {\n    console.error(\"The 'run' command is only available via the CLI (bun mux run).\");\n    console.error(\"It is not bundled in Electron.\");\n    process.exit(1);\n  }\n  process.argv.splice(env.firstArgIndex, 1); // Remove \"run\" since run.ts defines .name(\"mux run\")\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  require(\"./run\");\n} else if (subcommand === \"server\") {\n  process.argv.splice(env.firstArgIndex, 1);\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  require(\"./server\");\n} else if (subcommand === \"api\") {\n  process.argv.splice(env.firstArgIndex, 1);\n  // Must use native import() to load ESM module - trpc-cli requires ESM with top-level await.\n  // Using Function constructor prevents TypeScript from converting this to require().\n  // The .mjs extension is critical for Node.js to treat it as ESM.\n  // eslint-disable-next-line @typescript-eslint/no-implied-eval, @typescript-eslint/no-unsafe-call\n  void new Function(\"return import('./api.mjs')\")();\n} else if (\n  subcommand === \"desktop\" ||\n  (env.isElectron && (subcommand === undefined || isElectronLaunchArg(subcommand, env)))\n) {\n  // Explicit `mux desktop`, or Electron runtime with no subcommand / Electron launch args\n  if (!isCommandAvailable(\"desktop\", env)) {\n    console.error(\"The 'desktop' command requires Electron to be installed.\");\n    console.error(\"When installed via npm, use the packaged desktop app instead.\");\n    console.error(\"Download from: https://github.com/coder/mux/releases\");\n    process.exit(1);\n  }\n  launchDesktop();\n} else {\n  // No subcommand (non-Electron), flags (--help, --version), or unknown commands\n  const program = new Command();\n\n  // VERSION comes from generated src/version.ts during builds.\n  // For lint/typecheck contexts where that file may be missing or not fully type-resolved,\n  // treat it as unknown and parse defensively.\n  const versionRecord = VERSION as Record<string, unknown>;\n  const gitDescribe =\n    typeof versionRecord.git_describe === \"string\" ? versionRecord.git_describe : \"unknown\";\n  const gitCommit =\n    typeof versionRecord.git_commit === \"string\" ? versionRecord.git_commit : \"unknown\";\n\n  // Global flags are defined in CLI_GLOBAL_FLAGS (argv.ts) for routing logic.\n  // Commander auto-adds --help/-h. We define --version/-v below.\n  program\n    .name(\"mux\")\n    .description(\"Mux - AI agent orchestration\")\n    .version(`${gitDescribe} (${gitCommit})`, \"-v, --version\");\n\n  // Sanity check: ensure version flags match CLI_GLOBAL_FLAGS\n  if (process.env.NODE_ENV !== \"production\") {\n    const versionFlags = [\"-v\", \"--version\"];\n    for (const flag of versionFlags) {\n      if (!CLI_GLOBAL_FLAGS.includes(flag as (typeof CLI_GLOBAL_FLAGS)[number])) {\n        console.warn(`Warning: version flag \"${flag}\" not in CLI_GLOBAL_FLAGS`);\n      }\n    }\n  }\n\n  // Register subcommand stubs for help display (actual implementations are above)\n  // `run` is only available via bun/node CLI, not bundled in Electron\n  if (isCommandAvailable(\"run\", env)) {\n    program.command(\"run\").description(\"Run a one-off agent task\");\n  }\n  program.command(\"server\").description(\"Start the HTTP/WebSocket ORPC server\");\n  program.command(\"api\").description(\"Interact with the mux API via a running server\");\n  if (isCommandAvailable(\"desktop\", env)) {\n    program\n      .command(\"desktop\")\n      .description(\n        env.isElectron ? \"Launch the desktop app\" : \"Launch the desktop app (requires Electron)\"\n      );\n  }\n\n  program.parse(process.argv, getParseOptions(env));\n}\n"]}