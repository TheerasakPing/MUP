{"version":3,"file":"muxMd.test.js","sourceRoot":"","sources":["../../../src/common/lib/muxMd.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport {\r\n  MUX_MD_BASE_URL,\r\n  deleteFromMuxMd,\r\n  downloadFromMuxMd,\r\n  getMuxMdBaseUrl,\r\n  isMuxMdUrl,\r\n  parseMuxMdUrl,\r\n  uploadToMuxMd,\r\n} from \"./muxMd\";\r\n\r\nconst itIntegration = process.env.TEST_INTEGRATION === \"1\" ? it : it.skip;\r\n\r\ndescribe(\"muxMd\", () => {\r\n  describe(\"getMuxMdBaseUrl\", () => {\r\n    it(\"should default to the production mux.md origin\", () => {\r\n      const originalOverride = process.env.MUX_MD_URL_OVERRIDE;\r\n\r\n      try {\r\n        delete process.env.MUX_MD_URL_OVERRIDE;\r\n        expect(getMuxMdBaseUrl()).toBe(MUX_MD_BASE_URL);\r\n      } finally {\r\n        if (originalOverride === undefined) {\r\n          delete process.env.MUX_MD_URL_OVERRIDE;\r\n        } else {\r\n          process.env.MUX_MD_URL_OVERRIDE = originalOverride;\r\n        }\r\n      }\r\n    });\r\n\r\n    it(\"should normalize and accept a MUX_MD_URL_OVERRIDE host\", () => {\r\n      const originalOverride = process.env.MUX_MD_URL_OVERRIDE;\r\n      process.env.MUX_MD_URL_OVERRIDE = \"https://mux-md-staging.test/some/path\";\r\n\r\n      try {\r\n        expect(getMuxMdBaseUrl()).toBe(\"https://mux-md-staging.test\");\r\n\r\n        // Override host should be allowed.\r\n        expect(isMuxMdUrl(\"https://mux-md-staging.test/abc123#key456\")).toBe(true);\r\n\r\n        // Production links should still be recognized while an override is set.\r\n        expect(isMuxMdUrl(\"https://mux.md/abc123#key456\")).toBe(true);\r\n\r\n        expect(isMuxMdUrl(\"https://not-mux-md.test/abc123#key456\")).toBe(false);\r\n      } finally {\r\n        if (originalOverride === undefined) {\r\n          delete process.env.MUX_MD_URL_OVERRIDE;\r\n        } else {\r\n          process.env.MUX_MD_URL_OVERRIDE = originalOverride;\r\n        }\r\n      }\r\n    });\r\n\r\n    it(\"should prefer window.api.muxMdUrlOverride over process.env\", () => {\r\n      const originalOverride = process.env.MUX_MD_URL_OVERRIDE;\r\n      const globalWithWindow = globalThis as unknown as {\r\n        window?: {\r\n          api?: {\r\n            muxMdUrlOverride?: string;\r\n          };\r\n        };\r\n      };\r\n      const originalWindow = globalWithWindow.window;\r\n\r\n      process.env.MUX_MD_URL_OVERRIDE = \"https://mux-md-staging.test\";\r\n      globalWithWindow.window = {\r\n        api: {\r\n          muxMdUrlOverride: \"http://localhost:8787/foo\",\r\n        },\r\n      };\r\n\r\n      try {\r\n        expect(getMuxMdBaseUrl()).toBe(\"http://localhost:8787\");\r\n      } finally {\r\n        if (originalOverride === undefined) {\r\n          delete process.env.MUX_MD_URL_OVERRIDE;\r\n        } else {\r\n          process.env.MUX_MD_URL_OVERRIDE = originalOverride;\r\n        }\r\n\r\n        if (originalWindow === undefined) {\r\n          delete globalWithWindow.window;\r\n        } else {\r\n          globalWithWindow.window = originalWindow;\r\n        }\r\n      }\r\n    });\r\n\r\n    it(\"should use globalThis.__MUX_MD_URL_OVERRIDE__ in browser mode without preload\", () => {\r\n      const originalOverride = process.env.MUX_MD_URL_OVERRIDE;\r\n      const originalDefineOverride = globalThis.__MUX_MD_URL_OVERRIDE__;\r\n      const globalWithWindow = globalThis as unknown as {\r\n        window?: Record<string, unknown>;\r\n      };\r\n      const originalWindow = globalWithWindow.window;\r\n\r\n      // When running `make dev-server`, the renderer runs in a normal browser where `window.api`\r\n      // is not available, so we rely on the Vite-injected define.\r\n      process.env.MUX_MD_URL_OVERRIDE = \"https://should-not-be-used.test\";\r\n      globalThis.__MUX_MD_URL_OVERRIDE__ = \"https://mux-md-staging.test/some/path\";\r\n      globalWithWindow.window = {};\r\n\r\n      try {\r\n        expect(getMuxMdBaseUrl()).toBe(\"https://mux-md-staging.test\");\r\n      } finally {\r\n        if (originalOverride === undefined) {\r\n          delete process.env.MUX_MD_URL_OVERRIDE;\r\n        } else {\r\n          process.env.MUX_MD_URL_OVERRIDE = originalOverride;\r\n        }\r\n\r\n        globalThis.__MUX_MD_URL_OVERRIDE__ = originalDefineOverride;\r\n\r\n        if (originalWindow === undefined) {\r\n          delete globalWithWindow.window;\r\n        } else {\r\n          globalWithWindow.window = originalWindow;\r\n        }\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"isMuxMdUrl\", () => {\r\n    it(\"should detect valid mux.md URLs\", () => {\r\n      expect(isMuxMdUrl(\"https://mux.md/abc123#key456\")).toBe(true);\r\n      expect(isMuxMdUrl(\"https://mux.md/RQJe3#Fbbhosspt9q9Ig\")).toBe(true);\r\n    });\r\n\r\n    it(\"should reject URLs without fragment\", () => {\r\n      expect(isMuxMdUrl(\"https://mux.md/abc123\")).toBe(false);\r\n      expect(isMuxMdUrl(\"https://mux.md/abc123#\")).toBe(false);\r\n    });\r\n\r\n    it(\"should reject non-mux.md URLs\", () => {\r\n      expect(isMuxMdUrl(\"https://example.com/page#hash\")).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"parseMuxMdUrl\", () => {\r\n    it(\"should extract id and key from URL\", () => {\r\n      expect(parseMuxMdUrl(\"https://mux.md/abc123#key456\")).toEqual({\r\n        id: \"abc123\",\r\n        key: \"key456\",\r\n      });\r\n    });\r\n\r\n    it(\"should return null for invalid URLs\", () => {\r\n      expect(parseMuxMdUrl(\"https://mux.md/abc123\")).toBeNull();\r\n      expect(parseMuxMdUrl(\"https://mux.md/#key\")).toBeNull();\r\n      expect(parseMuxMdUrl(\"not-a-url\")).toBeNull();\r\n    });\r\n  });\r\n\r\n  // Round-trip test: upload then download\r\n  itIntegration(\"should upload and download content correctly\", async () => {\r\n    const testContent = \"# Test Message\\n\\nThis is a test of mux.md encryption.\";\r\n    const testFileInfo = {\r\n      name: \"test-message.md\",\r\n      type: \"text/markdown\",\r\n      size: testContent.length,\r\n      model: \"test-model\",\r\n    };\r\n\r\n    // Upload\r\n    const uploadResult = await uploadToMuxMd(testContent, testFileInfo, {\r\n      expiresAt: new Date(Date.now() + 60000), // Expire in 1 minute\r\n    });\r\n\r\n    expect(uploadResult.url).toContain(`${getMuxMdBaseUrl()}/`);\r\n    expect(uploadResult.url).toContain(\"#\");\r\n    expect(uploadResult.id).toBeTruthy();\r\n    expect(uploadResult.key).toBeTruthy();\r\n    expect(uploadResult.mutateKey).toBeTruthy();\r\n\r\n    try {\r\n      // Download and decrypt\r\n      const downloadResult = await downloadFromMuxMd(uploadResult.id, uploadResult.key);\r\n\r\n      expect(downloadResult.content).toBe(testContent);\r\n      expect(downloadResult.fileInfo).toBeDefined();\r\n      expect(downloadResult.fileInfo?.name).toBe(\"test-message.md\");\r\n      expect(downloadResult.fileInfo?.model).toBe(\"test-model\");\r\n    } finally {\r\n      // Clean up - delete the uploaded file\r\n      await deleteFromMuxMd(uploadResult.id, uploadResult.mutateKey);\r\n    }\r\n  });\r\n\r\n  itIntegration(\"should fail gracefully for non-existent shares\", async () => {\r\n    let error: Error | undefined;\r\n    try {\r\n      await downloadFromMuxMd(\"nonexistent123\", \"fakekey456\");\r\n    } catch (e) {\r\n      error = e as Error;\r\n    }\r\n    expect(error).toBeDefined();\r\n    expect(error?.message).toMatch(/not found|expired/i);\r\n  });\r\n});\r\n"]}