{"version":3,"file":"muxMd.js","sourceRoot":"","sources":["../../../src/common/lib/muxMd.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * mux.md Client Library\n *\n * Thin wrapper around @coder/mux-md-client for Mux app integration.\n * Re-exports types and provides convenience functions with default base URL.\n */\n\nimport {\n  upload,\n  download,\n  deleteFile,\n  setExpiration,\n  parseUrl,\n  type FileInfo,\n  type SignOptions,\n  type SignatureEnvelope,\n  type UploadResult,\n} from \"@coder/mux-md-client\";\n\n// Re-export types from package\nexport type { FileInfo, SignOptions, SignatureEnvelope, UploadResult };\n\nexport const MUX_MD_BASE_URL = \"https://mux.md\";\nexport const MUX_MD_HOST = \"mux.md\";\n\nfunction getMuxMdUrlOverrideRaw(): string | undefined {\n  // In Electron, we expose the env var via preload so the renderer doesn't need `process.env`.\n  if (typeof window !== \"undefined\") {\n    const fromPreload = window.api?.muxMdUrlOverride;\n    if (fromPreload && fromPreload.trim().length > 0) return fromPreload;\n\n    // In dev-server browser mode (no Electron preload), Vite injects the env var into the bundle.\n    const fromViteDefine = globalThis.__MUX_MD_URL_OVERRIDE__;\n    if (fromViteDefine && fromViteDefine.trim().length > 0) return fromViteDefine;\n\n    // Important: avoid falling back to `process.env` in the renderer bundle.\n    return undefined;\n  }\n\n  // In Node (main process / tests), read directly from the environment.\n  const fromEnv = globalThis.process?.env?.MUX_MD_URL_OVERRIDE;\n  if (fromEnv && fromEnv.trim().length > 0) return fromEnv;\n\n  return undefined;\n}\n\nfunction normalizeMuxMdBaseUrlOverride(raw: string): string | undefined {\n  try {\n    const parsed = new URL(raw);\n    if (parsed.protocol !== \"https:\" && parsed.protocol !== \"http:\") return undefined;\n    return parsed.origin;\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Returns the effective mux.md base URL.\n *\n * Supports a runtime override (via `MUX_MD_URL_OVERRIDE`) so we can test against staging/local mux.md\n * deployments without rebuilding the renderer bundle.\n */\nexport function getMuxMdBaseUrl(): string {\n  const overrideRaw = getMuxMdUrlOverrideRaw();\n  const override = overrideRaw ? normalizeMuxMdBaseUrlOverride(overrideRaw) : undefined;\n  return override ?? MUX_MD_BASE_URL;\n}\n\n/**\n * Hosts that should be treated as mux.md share links.\n *\n * Even when an override is set, we still allow the production host so existing share links keep\n * working.\n */\nexport function getMuxMdAllowedHosts(): string[] {\n  const hosts = new Set<string>();\n  hosts.add(MUX_MD_HOST);\n\n  try {\n    hosts.add(new URL(getMuxMdBaseUrl()).host);\n  } catch {\n    // Best-effort: getMuxMdBaseUrl() should always be a valid URL.\n  }\n\n  return [...hosts];\n}\n\n// --- URL utilities ---\n\n/**\n * Check if URL is a mux.md share link with encryption key in fragment\n */\nexport function isMuxMdUrl(url: string): boolean {\n  try {\n    const parsed = new URL(url);\n    return getMuxMdAllowedHosts().includes(parsed.host) && parseUrl(url) !== null;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Parse a mux.md share URL to extract ID and key.\n *\n * Note: `parseUrl` does not validate the host; call `isMuxMdUrl()` when validating user input.\n */\nexport function parseMuxMdUrl(url: string): { id: string; key: string } | null {\n  return parseUrl(url);\n}\n\nexport interface UploadOptions {\n  /** Expiration time (ISO date string or Date object) */\n  expiresAt?: string | Date;\n  /**\n   * Precomputed signature envelope to embed in the encrypted payload.\n   * Takes precedence over `sign`.\n   */\n  signature?: SignatureEnvelope;\n  /** Sign options for native signing via mux-md-client */\n  sign?: SignOptions;\n}\n\n// --- Public API ---\n\n/**\n * Upload content to mux.md with end-to-end encryption.\n */\nexport async function uploadToMuxMd(\n  content: string,\n  fileInfo: FileInfo,\n  options: UploadOptions = {}\n): Promise<UploadResult> {\n  return upload(new TextEncoder().encode(content), fileInfo, {\n    baseUrl: getMuxMdBaseUrl(),\n    expiresAt: options.expiresAt,\n    signature: options.signature,\n    sign: options.sign,\n  });\n}\n\n/**\n * Delete a shared file from mux.md.\n */\nexport async function deleteFromMuxMd(id: string, mutateKey: string): Promise<void> {\n  await deleteFile(id, mutateKey, { baseUrl: getMuxMdBaseUrl() });\n}\n\n/**\n * Update expiration of a shared file on mux.md.\n */\nexport async function updateMuxMdExpiration(\n  id: string,\n  mutateKey: string,\n  expiresAt: Date | string\n): Promise<number | undefined> {\n  const result = await setExpiration(id, mutateKey, expiresAt, { baseUrl: getMuxMdBaseUrl() });\n  return result.expiresAt;\n}\n\n// --- Download API ---\n\nexport interface DownloadResult {\n  /** Decrypted content */\n  content: string;\n  /** File metadata (if available) */\n  fileInfo?: FileInfo;\n}\n\n/**\n * Download and decrypt content from mux.md.\n */\nexport async function downloadFromMuxMd(\n  id: string,\n  keyMaterial: string,\n  _signal?: AbortSignal,\n  options?: {\n    baseUrl?: string;\n  }\n): Promise<DownloadResult> {\n  const result = await download(id, keyMaterial, {\n    baseUrl: options?.baseUrl ?? getMuxMdBaseUrl(),\n  });\n  return {\n    content: new TextDecoder().decode(result.data),\n    fileInfo: result.info,\n  };\n}\n"]}