{"version":3,"file":"muxMd.js","sourceRoot":"","sources":["../../../src/common/lib/muxMd.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * mux.md Client Library\r\n *\r\n * Thin wrapper around @coder/mux-md-client for Mux app integration.\r\n * Re-exports types and provides convenience functions with default base URL.\r\n */\r\n\r\nimport {\r\n  upload,\r\n  download,\r\n  deleteFile,\r\n  setExpiration,\r\n  parseUrl,\r\n  type FileInfo,\r\n  type SignOptions,\r\n  type SignatureEnvelope,\r\n  type UploadResult,\r\n} from \"@coder/mux-md-client\";\r\n\r\n// Re-export types from package\r\nexport type { FileInfo, SignOptions, SignatureEnvelope, UploadResult };\r\n\r\nexport const MUX_MD_BASE_URL = \"https://mux.md\";\r\nexport const MUX_MD_HOST = \"mux.md\";\r\n\r\nfunction getMuxMdUrlOverrideRaw(): string | undefined {\r\n  // In Electron, we expose the env var via preload so the renderer doesn't need `process.env`.\r\n  if (typeof window !== \"undefined\") {\r\n    const fromPreload = window.api?.muxMdUrlOverride;\r\n    if (fromPreload && fromPreload.trim().length > 0) return fromPreload;\r\n\r\n    // In dev-server browser mode (no Electron preload), Vite injects the env var into the bundle.\r\n    const fromViteDefine = globalThis.__MUX_MD_URL_OVERRIDE__;\r\n    if (fromViteDefine && fromViteDefine.trim().length > 0) return fromViteDefine;\r\n\r\n    // Important: avoid falling back to `process.env` in the renderer bundle.\r\n    return undefined;\r\n  }\r\n\r\n  // In Node (main process / tests), read directly from the environment.\r\n  const fromEnv = globalThis.process?.env?.MUX_MD_URL_OVERRIDE;\r\n  if (fromEnv && fromEnv.trim().length > 0) return fromEnv;\r\n\r\n  return undefined;\r\n}\r\n\r\nfunction normalizeMuxMdBaseUrlOverride(raw: string): string | undefined {\r\n  try {\r\n    const parsed = new URL(raw);\r\n    if (parsed.protocol !== \"https:\" && parsed.protocol !== \"http:\") return undefined;\r\n    return parsed.origin;\r\n  } catch {\r\n    return undefined;\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the effective mux.md base URL.\r\n *\r\n * Supports a runtime override (via `MUX_MD_URL_OVERRIDE`) so we can test against staging/local mux.md\r\n * deployments without rebuilding the renderer bundle.\r\n */\r\nexport function getMuxMdBaseUrl(): string {\r\n  const overrideRaw = getMuxMdUrlOverrideRaw();\r\n  const override = overrideRaw ? normalizeMuxMdBaseUrlOverride(overrideRaw) : undefined;\r\n  return override ?? MUX_MD_BASE_URL;\r\n}\r\n\r\n/**\r\n * Hosts that should be treated as mux.md share links.\r\n *\r\n * Even when an override is set, we still allow the production host so existing share links keep\r\n * working.\r\n */\r\nexport function getMuxMdAllowedHosts(): string[] {\r\n  const hosts = new Set<string>();\r\n  hosts.add(MUX_MD_HOST);\r\n\r\n  try {\r\n    hosts.add(new URL(getMuxMdBaseUrl()).host);\r\n  } catch {\r\n    // Best-effort: getMuxMdBaseUrl() should always be a valid URL.\r\n  }\r\n\r\n  return [...hosts];\r\n}\r\n\r\n// --- URL utilities ---\r\n\r\n/**\r\n * Check if URL is a mux.md share link with encryption key in fragment\r\n */\r\nexport function isMuxMdUrl(url: string): boolean {\r\n  try {\r\n    const parsed = new URL(url);\r\n    return getMuxMdAllowedHosts().includes(parsed.host) && parseUrl(url) !== null;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Parse a mux.md share URL to extract ID and key.\r\n *\r\n * Note: `parseUrl` does not validate the host; call `isMuxMdUrl()` when validating user input.\r\n */\r\nexport function parseMuxMdUrl(url: string): { id: string; key: string } | null {\r\n  return parseUrl(url);\r\n}\r\n\r\nexport interface UploadOptions {\r\n  /** Expiration time (ISO date string or Date object) */\r\n  expiresAt?: string | Date;\r\n  /**\r\n   * Precomputed signature envelope to embed in the encrypted payload.\r\n   * Takes precedence over `sign`.\r\n   */\r\n  signature?: SignatureEnvelope;\r\n  /** Sign options for native signing via mux-md-client */\r\n  sign?: SignOptions;\r\n}\r\n\r\n// --- Public API ---\r\n\r\n/**\r\n * Upload content to mux.md with end-to-end encryption.\r\n */\r\nexport async function uploadToMuxMd(\r\n  content: string,\r\n  fileInfo: FileInfo,\r\n  options: UploadOptions = {}\r\n): Promise<UploadResult> {\r\n  return upload(new TextEncoder().encode(content), fileInfo, {\r\n    baseUrl: getMuxMdBaseUrl(),\r\n    expiresAt: options.expiresAt,\r\n    signature: options.signature,\r\n    sign: options.sign,\r\n  });\r\n}\r\n\r\n/**\r\n * Delete a shared file from mux.md.\r\n */\r\nexport async function deleteFromMuxMd(id: string, mutateKey: string): Promise<void> {\r\n  await deleteFile(id, mutateKey, { baseUrl: getMuxMdBaseUrl() });\r\n}\r\n\r\n/**\r\n * Update expiration of a shared file on mux.md.\r\n */\r\nexport async function updateMuxMdExpiration(\r\n  id: string,\r\n  mutateKey: string,\r\n  expiresAt: Date | string\r\n): Promise<number | undefined> {\r\n  const result = await setExpiration(id, mutateKey, expiresAt, { baseUrl: getMuxMdBaseUrl() });\r\n  return result.expiresAt;\r\n}\r\n\r\n// --- Download API ---\r\n\r\nexport interface DownloadResult {\r\n  /** Decrypted content */\r\n  content: string;\r\n  /** File metadata (if available) */\r\n  fileInfo?: FileInfo;\r\n}\r\n\r\n/**\r\n * Download and decrypt content from mux.md.\r\n */\r\nexport async function downloadFromMuxMd(\r\n  id: string,\r\n  keyMaterial: string,\r\n  _signal?: AbortSignal,\r\n  options?: {\r\n    baseUrl?: string;\r\n  }\r\n): Promise<DownloadResult> {\r\n  const result = await download(id, keyMaterial, {\r\n    baseUrl: options?.baseUrl ?? getMuxMdBaseUrl(),\r\n  });\r\n  return {\r\n    content: new TextDecoder().decode(result.data),\r\n    fileInfo: result.info,\r\n  };\r\n}\r\n"]}