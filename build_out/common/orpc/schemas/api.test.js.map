{"version":3,"file":"api.test.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/api.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport {\r\n  AWSCredentialStatusSchema,\r\n  ProviderConfigInfoSchema,\r\n  ProvidersConfigMapSchema,\r\n} from \"./api\";\r\nimport type { AWSCredentialStatus, ProviderConfigInfo, ProvidersConfigMap } from \"../types\";\r\n\r\n/**\r\n * Schema conformance tests for provider types.\r\n *\r\n * These tests ensure that the Zod schemas preserve all fields when parsing data.\r\n * oRPC uses these schemas for output validation and strips fields not in the schema,\r\n * so any field present in the TypeScript type MUST be present in the schema.\r\n *\r\n * If these tests fail, it means the schema is missing fields that the backend\r\n * service returns, which would cause data loss when crossing the IPC boundary.\r\n */\r\ndescribe(\"ProviderConfigInfoSchema conformance\", () => {\r\n  it(\"preserves all AWSCredentialStatus fields\", () => {\r\n    const full: AWSCredentialStatus = {\r\n      region: \"us-east-1\",\r\n      profile: \"my-sso-profile\",\r\n      bearerTokenSet: true,\r\n      accessKeyIdSet: true,\r\n      secretAccessKeySet: false,\r\n    };\r\n\r\n    const parsed = AWSCredentialStatusSchema.parse(full);\r\n\r\n    // Verify no fields were stripped\r\n    expect(parsed).toEqual(full);\r\n    expect(Object.keys(parsed).sort()).toEqual(Object.keys(full).sort());\r\n  });\r\n\r\n  it(\"preserves all ProviderConfigInfo fields (base case)\", () => {\r\n    const full: ProviderConfigInfo = {\r\n      apiKeySet: true,\r\n      isConfigured: true,\r\n      baseUrl: \"https://api.example.com\",\r\n      models: [\"model-a\", \"model-b\"],\r\n    };\r\n\r\n    const parsed = ProviderConfigInfoSchema.parse(full);\r\n\r\n    expect(parsed).toEqual(full);\r\n    expect(Object.keys(parsed).sort()).toEqual(Object.keys(full).sort());\r\n  });\r\n\r\n  it(\"preserves all ProviderConfigInfo fields (with AWS/Bedrock)\", () => {\r\n    const full: ProviderConfigInfo = {\r\n      apiKeySet: false,\r\n      isConfigured: false,\r\n      baseUrl: undefined,\r\n      models: [],\r\n      aws: {\r\n        region: \"eu-west-1\",\r\n        profile: \"my-sso-profile\",\r\n        bearerTokenSet: false,\r\n        accessKeyIdSet: true,\r\n        secretAccessKeySet: true,\r\n      },\r\n    };\r\n\r\n    const parsed = ProviderConfigInfoSchema.parse(full);\r\n\r\n    expect(parsed).toEqual(full);\r\n    // Check nested aws object is preserved\r\n    expect(parsed.aws).toEqual(full.aws);\r\n  });\r\n\r\n  it(\"preserves all ProviderConfigInfo fields (with couponCodeSet)\", () => {\r\n    const full: ProviderConfigInfo = {\r\n      apiKeySet: true,\r\n      isConfigured: true,\r\n      couponCodeSet: true,\r\n    };\r\n\r\n    const parsed = ProviderConfigInfoSchema.parse(full);\r\n\r\n    expect(parsed).toEqual(full);\r\n    expect(parsed.couponCodeSet).toBe(true);\r\n  });\r\n\r\n  it(\"preserves all ProviderConfigInfo fields (full object with all optional fields)\", () => {\r\n    // This is the most comprehensive test - includes ALL possible fields\r\n    const full: ProviderConfigInfo = {\r\n      apiKeySet: true,\r\n      isConfigured: true,\r\n      baseUrl: \"https://custom.endpoint.com\",\r\n      models: [\"claude-3-opus\", \"claude-3-sonnet\"],\r\n      serviceTier: \"flex\",\r\n      codexOauthSet: true,\r\n      codexOauthDefaultAuth: \"apiKey\",\r\n      aws: {\r\n        region: \"ap-northeast-1\",\r\n        profile: \"my-sso-profile\",\r\n        bearerTokenSet: true,\r\n        accessKeyIdSet: true,\r\n        secretAccessKeySet: true,\r\n      },\r\n      couponCodeSet: true,\r\n    };\r\n\r\n    const parsed = ProviderConfigInfoSchema.parse(full);\r\n\r\n    // Deep equality check\r\n    expect(parsed).toEqual(full);\r\n\r\n    // Explicit field-by-field verification for clarity\r\n    expect(parsed.apiKeySet).toBe(full.apiKeySet);\r\n    expect(parsed.baseUrl).toBe(full.baseUrl);\r\n    expect(parsed.models).toEqual(full.models);\r\n    expect(parsed.serviceTier).toBe(full.serviceTier);\r\n    expect(parsed.codexOauthSet).toBe(full.codexOauthSet);\r\n    expect(parsed.codexOauthDefaultAuth).toBe(full.codexOauthDefaultAuth);\r\n    expect(parsed.aws).toEqual(full.aws);\r\n    expect(parsed.couponCodeSet).toBe(full.couponCodeSet);\r\n  });\r\n\r\n  it(\"preserves ProvidersConfigMap with multiple providers\", () => {\r\n    const full: ProvidersConfigMap = {\r\n      anthropic: {\r\n        apiKeySet: true,\r\n        isConfigured: true,\r\n        models: [\"claude-3-opus\"],\r\n      },\r\n      openai: {\r\n        apiKeySet: true,\r\n        isConfigured: true,\r\n        serviceTier: \"auto\",\r\n        codexOauthSet: true,\r\n        codexOauthDefaultAuth: \"oauth\",\r\n      },\r\n      bedrock: {\r\n        apiKeySet: false,\r\n        isConfigured: false,\r\n        aws: {\r\n          region: \"us-west-2\",\r\n          profile: \"my-sso-profile\",\r\n          bearerTokenSet: false,\r\n          accessKeyIdSet: true,\r\n          secretAccessKeySet: true,\r\n        },\r\n      },\r\n      \"mux-gateway\": {\r\n        apiKeySet: false,\r\n        isConfigured: false,\r\n        couponCodeSet: true,\r\n        models: [\"anthropic/claude-sonnet-4-5\"],\r\n      },\r\n    };\r\n\r\n    const parsed = ProvidersConfigMapSchema.parse(full);\r\n\r\n    expect(parsed).toEqual(full);\r\n    expect(Object.keys(parsed)).toEqual(Object.keys(full));\r\n  });\r\n});\r\n"]}