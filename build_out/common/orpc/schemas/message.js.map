{"version":3,"file":"message.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/message.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\r\nimport { AgentIdSchema } from \"./agentDefinition\";\r\nimport { StreamErrorTypeSchema } from \"./errors\";\r\nimport { AgentSkillScopeSchema, SkillNameSchema } from \"./agentSkill\";\r\n\r\nexport const FilePartSchema = z.object({\r\n  url: z.string(),\r\n  mediaType: z.string(),\r\n  filename: z.string().optional(),\r\n});\r\n\r\nexport const MuxTextPartSchema = z.object({\r\n  type: z.literal(\"text\"),\r\n  text: z.string(),\r\n  timestamp: z.number().optional(),\r\n});\r\n\r\nexport const MuxReasoningPartSchema = z.object({\r\n  type: z.literal(\"reasoning\"),\r\n  text: z.string(),\r\n  timestamp: z.number().optional(),\r\n});\r\n\r\n// Base schema for tool parts - shared fields\r\nconst MuxToolPartBase = z.object({\r\n  type: z.literal(\"dynamic-tool\"),\r\n  toolCallId: z.string(),\r\n  toolName: z.string(),\r\n  input: z.unknown(),\r\n  timestamp: z.number().optional(),\r\n});\r\n\r\n/**\r\n * Schema for nested tool calls within code_execution.\r\n *\r\n * PERSISTENCE:\r\n * - During live streaming: parentToolCallId on events â†’ streamManager persists to part.nestedCalls\r\n * - In chat.jsonl: nestedCalls is persisted alongside result.toolCalls (for interrupted streams)\r\n * - On history replay: Aggregator uses persisted nestedCalls, or reconstructs from result.toolCalls\r\n *\r\n * The reconstruction from result.toolCalls provides backward compatibility for older history.\r\n */\r\nexport const NestedToolCallSchema = z.object({\r\n  toolCallId: z.string(),\r\n  toolName: z.string(),\r\n  input: z.unknown(),\r\n  output: z.unknown().optional(),\r\n  state: z.enum([\"input-available\", \"output-available\", \"output-redacted\"]),\r\n  timestamp: z.number().optional(),\r\n});\r\n\r\nexport type NestedToolCall = z.infer<typeof NestedToolCallSchema>;\r\n\r\n// Discriminated tool part schemas - output required only when state is \"output-available\"\r\nexport const DynamicToolPartPendingSchema = MuxToolPartBase.extend({\r\n  state: z.literal(\"input-available\"),\r\n  nestedCalls: z.array(NestedToolCallSchema).optional(),\r\n});\r\n\r\nexport const DynamicToolPartAvailableSchema = MuxToolPartBase.extend({\r\n  state: z.literal(\"output-available\"),\r\n  output: z.unknown(),\r\n  nestedCalls: z.array(NestedToolCallSchema).optional(),\r\n});\r\nexport const DynamicToolPartRedactedSchema = MuxToolPartBase.extend({\r\n  state: z.literal(\"output-redacted\"),\r\n  nestedCalls: z.array(NestedToolCallSchema).optional(),\r\n});\r\n\r\nexport const DynamicToolPartSchema = z.discriminatedUnion(\"state\", [\r\n  DynamicToolPartAvailableSchema,\r\n  DynamicToolPartPendingSchema,\r\n  DynamicToolPartRedactedSchema,\r\n]);\r\n\r\n// Alias for message schemas\r\nexport const MuxToolPartSchema = DynamicToolPartSchema;\r\n\r\nexport const MuxFilePartSchema = FilePartSchema.extend({\r\n  type: z.literal(\"file\"),\r\n});\r\n\r\n// Export types inferred from schemas for reuse across app/test code.\r\nexport type FilePart = z.infer<typeof FilePartSchema>;\r\nexport type MuxFilePart = z.infer<typeof MuxFilePartSchema>;\r\n\r\nconst CompactionEpochSchema = z.optional(\r\n  z.preprocess(\r\n    (value) =>\r\n      typeof value === \"number\" && Number.isInteger(value) && value > 0 ? value : undefined,\r\n    z.number().int().positive().or(z.undefined())\r\n  )\r\n);\r\n\r\n// MuxMessage (simplified)\r\nexport const MuxMessageSchema = z.object({\r\n  id: z.string(),\r\n  role: z.enum([\"system\", \"user\", \"assistant\"]),\r\n  parts: z.array(\r\n    z.discriminatedUnion(\"type\", [\r\n      MuxTextPartSchema,\r\n      MuxReasoningPartSchema,\r\n      MuxToolPartSchema,\r\n      MuxFilePartSchema,\r\n    ])\r\n  ),\r\n  createdAt: z.date().optional(),\r\n  metadata: z\r\n    .object({\r\n      historySequence: z.number().optional(),\r\n      timestamp: z.number().optional(),\r\n      model: z.string().optional(),\r\n      thinkingLevel: z.enum([\"off\", \"low\", \"medium\", \"high\", \"xhigh\", \"max\"]).optional(),\r\n      routedThroughGateway: z.boolean().optional(),\r\n      usage: z.any().optional(),\r\n      contextUsage: z.any().optional(),\r\n      providerMetadata: z.record(z.string(), z.unknown()).optional(),\r\n      contextProviderMetadata: z.record(z.string(), z.unknown()).optional(),\r\n      duration: z.number().optional(),\r\n      systemMessageTokens: z.number().optional(),\r\n      muxMetadata: z.any().optional(),\r\n      cmuxMetadata: z.any().optional(), // Legacy field for backward compatibility\r\n      // Compaction source: \"user\" (manual), \"idle\" (auto), or legacy boolean (true)\r\n      compacted: z.union([z.literal(\"user\"), z.literal(\"idle\"), z.boolean()]).optional(),\r\n      // Monotonic compaction epoch id. Incremented whenever compaction succeeds.\r\n      // Self-healing read path: malformed persisted compactionEpoch is ignored.\r\n      compactionEpoch: CompactionEpochSchema,\r\n      // Durable boundary marker for compaction summaries.\r\n      compactionBoundary: z.boolean().optional(),\r\n      toolPolicy: z.any().optional(),\r\n      agentId: AgentIdSchema.optional().catch(undefined),\r\n      partial: z.boolean().optional(),\r\n      synthetic: z.boolean().optional(),\r\n      uiVisible: z.boolean().optional(),\r\n\r\n      agentSkillSnapshot: z\r\n        .object({\r\n          skillName: SkillNameSchema,\r\n          scope: AgentSkillScopeSchema,\r\n          sha256: z.string(),\r\n          frontmatterYaml: z.string().optional(),\r\n        })\r\n        .optional(),\r\n      error: z.string().optional(),\r\n      errorType: StreamErrorTypeSchema.optional(),\r\n    })\r\n    .optional(),\r\n});\r\n\r\nexport const BranchListResultSchema = z.object({\r\n  branches: z.array(z.string()),\r\n  /** Recommended trunk branch, or null for non-git directories */\r\n  recommendedTrunk: z.string().nullable(),\r\n});\r\n"]}