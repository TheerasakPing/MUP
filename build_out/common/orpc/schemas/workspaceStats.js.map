{"version":3,"file":"workspaceStats.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/workspaceStats.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\nimport { AgentModeSchema } from \"../../types/mode\";\nimport { AgentIdSchema } from \"./agentDefinition\";\n\n// Mode is an enum, but we defensively drop unknown values when replaying old history.\nconst ModeSchema = AgentModeSchema.optional().catch(undefined);\n// Agent IDs should already be safe (they come from filenames), but defensively drop unknown values\n// when replaying old history.\nconst AgentIdStatsSchema = AgentIdSchema.optional().catch(undefined);\n\nexport const TimingAnomalySchema = z.enum([\n  \"negative_duration\",\n  \"tool_gt_total\",\n  \"ttft_gt_total\",\n  \"percent_out_of_range\",\n  \"nan\",\n]);\n\nexport const ActiveStreamStatsSchema = z.object({\n  messageId: z.string(),\n  model: z.string(),\n  mode: ModeSchema,\n  agentId: AgentIdStatsSchema,\n\n  elapsedMs: z.number(),\n  ttftMs: z.number().nullable(),\n  toolExecutionMs: z.number(),\n  modelTimeMs: z.number(),\n  streamingMs: z.number(),\n\n  outputTokens: z.number(),\n  reasoningTokens: z.number(),\n\n  /** Total tokens streamed so far (text + reasoning + tool args). */\n  liveTokenCount: z.number(),\n  /** Tokens/sec, trailing window. */\n  liveTPS: z.number(),\n\n  invalid: z.boolean(),\n  anomalies: z.array(TimingAnomalySchema),\n});\n\nexport const CompletedStreamStatsSchema = z.object({\n  messageId: z.string(),\n  model: z.string(),\n  mode: ModeSchema,\n  agentId: AgentIdStatsSchema,\n\n  totalDurationMs: z.number(),\n  ttftMs: z.number().nullable(),\n  toolExecutionMs: z.number(),\n  modelTimeMs: z.number(),\n  streamingMs: z.number(),\n\n  outputTokens: z.number(),\n  reasoningTokens: z.number(),\n\n  invalid: z.boolean(),\n  anomalies: z.array(TimingAnomalySchema),\n});\n\nexport const ModelTimingStatsSchema = z.object({\n  model: z.string(),\n  mode: ModeSchema,\n  agentId: AgentIdStatsSchema,\n\n  totalDurationMs: z.number(),\n  totalToolExecutionMs: z.number(),\n  totalStreamingMs: z.number(),\n\n  totalTtftMs: z.number(),\n  ttftCount: z.number(),\n  responseCount: z.number(),\n\n  totalOutputTokens: z.number(),\n  totalReasoningTokens: z.number(),\n});\n\nexport const SessionTimingStatsSchema = z.object({\n  totalDurationMs: z.number(),\n  totalToolExecutionMs: z.number(),\n  totalStreamingMs: z.number(),\n\n  totalTtftMs: z.number(),\n  ttftCount: z.number(),\n  responseCount: z.number(),\n\n  totalOutputTokens: z.number(),\n  totalReasoningTokens: z.number(),\n\n  /**\n   * Per-model breakdown.\n   *\n   * Key is a stable identifier like normalizeGatewayModel(model) or model:agentId (fallback: model:mode).\n   */\n  byModel: z.record(z.string(), ModelTimingStatsSchema),\n});\n\nexport const WorkspaceStatsSnapshotSchema = z.object({\n  workspaceId: z.string(),\n  generatedAt: z.number(),\n\n  active: ActiveStreamStatsSchema.optional(),\n  lastRequest: CompletedStreamStatsSchema.optional(),\n  session: SessionTimingStatsSchema.optional(),\n});\n\nexport const SessionTimingFileSchema = z.object({\n  version: z.literal(2),\n  lastRequest: CompletedStreamStatsSchema.optional(),\n  session: SessionTimingStatsSchema,\n\n  /**\n   * Idempotency ledger for rolled-up sub-agent timing.\n   *\n   * When a child workspace is deleted, we merge its session timing into the parent.\n   * This tracks which children have already been merged to prevent double-counting\n   * if removal is retried.\n   */\n  rolledUpFrom: z.record(z.string(), z.literal(true)).optional(),\n});\n\n// Convenient TypeScript type exports\nexport type TimingAnomaly = z.infer<typeof TimingAnomalySchema>;\nexport type ActiveStreamStats = z.infer<typeof ActiveStreamStatsSchema>;\nexport type CompletedStreamStats = z.infer<typeof CompletedStreamStatsSchema>;\nexport type ModelTimingStats = z.infer<typeof ModelTimingStatsSchema>;\nexport type SessionTimingStats = z.infer<typeof SessionTimingStatsSchema>;\nexport type WorkspaceStatsSnapshot = z.infer<typeof WorkspaceStatsSnapshotSchema>;\nexport type SessionTimingFile = z.infer<typeof SessionTimingFileSchema>;\n"]}