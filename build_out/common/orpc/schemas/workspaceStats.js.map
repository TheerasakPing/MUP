{"version":3,"file":"workspaceStats.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/workspaceStats.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\r\nimport { AgentModeSchema } from \"../../types/mode\";\r\nimport { AgentIdSchema } from \"./agentDefinition\";\r\n\r\n// Mode is an enum, but we defensively drop unknown values when replaying old history.\r\nconst ModeSchema = AgentModeSchema.optional().catch(undefined);\r\n// Agent IDs should already be safe (they come from filenames), but defensively drop unknown values\r\n// when replaying old history.\r\nconst AgentIdStatsSchema = AgentIdSchema.optional().catch(undefined);\r\n\r\nexport const TimingAnomalySchema = z.enum([\r\n  \"negative_duration\",\r\n  \"tool_gt_total\",\r\n  \"ttft_gt_total\",\r\n  \"percent_out_of_range\",\r\n  \"nan\",\r\n]);\r\n\r\nexport const ActiveStreamStatsSchema = z.object({\r\n  messageId: z.string(),\r\n  model: z.string(),\r\n  mode: ModeSchema,\r\n  agentId: AgentIdStatsSchema,\r\n\r\n  elapsedMs: z.number(),\r\n  ttftMs: z.number().nullable(),\r\n  toolExecutionMs: z.number(),\r\n  modelTimeMs: z.number(),\r\n  streamingMs: z.number(),\r\n\r\n  outputTokens: z.number(),\r\n  reasoningTokens: z.number(),\r\n\r\n  /** Total tokens streamed so far (text + reasoning + tool args). */\r\n  liveTokenCount: z.number(),\r\n  /** Tokens/sec, trailing window. */\r\n  liveTPS: z.number(),\r\n\r\n  invalid: z.boolean(),\r\n  anomalies: z.array(TimingAnomalySchema),\r\n});\r\n\r\nexport const CompletedStreamStatsSchema = z.object({\r\n  messageId: z.string(),\r\n  model: z.string(),\r\n  mode: ModeSchema,\r\n  agentId: AgentIdStatsSchema,\r\n\r\n  totalDurationMs: z.number(),\r\n  ttftMs: z.number().nullable(),\r\n  toolExecutionMs: z.number(),\r\n  modelTimeMs: z.number(),\r\n  streamingMs: z.number(),\r\n\r\n  outputTokens: z.number(),\r\n  reasoningTokens: z.number(),\r\n\r\n  invalid: z.boolean(),\r\n  anomalies: z.array(TimingAnomalySchema),\r\n});\r\n\r\nexport const ModelTimingStatsSchema = z.object({\r\n  model: z.string(),\r\n  mode: ModeSchema,\r\n  agentId: AgentIdStatsSchema,\r\n\r\n  totalDurationMs: z.number(),\r\n  totalToolExecutionMs: z.number(),\r\n  totalStreamingMs: z.number(),\r\n\r\n  totalTtftMs: z.number(),\r\n  ttftCount: z.number(),\r\n  responseCount: z.number(),\r\n\r\n  totalOutputTokens: z.number(),\r\n  totalReasoningTokens: z.number(),\r\n});\r\n\r\nexport const SessionTimingStatsSchema = z.object({\r\n  totalDurationMs: z.number(),\r\n  totalToolExecutionMs: z.number(),\r\n  totalStreamingMs: z.number(),\r\n\r\n  totalTtftMs: z.number(),\r\n  ttftCount: z.number(),\r\n  responseCount: z.number(),\r\n\r\n  totalOutputTokens: z.number(),\r\n  totalReasoningTokens: z.number(),\r\n\r\n  /**\r\n   * Per-model breakdown.\r\n   *\r\n   * Key is a stable identifier like normalizeGatewayModel(model) or model:agentId (fallback: model:mode).\r\n   */\r\n  byModel: z.record(z.string(), ModelTimingStatsSchema),\r\n});\r\n\r\nexport const WorkspaceStatsSnapshotSchema = z.object({\r\n  workspaceId: z.string(),\r\n  generatedAt: z.number(),\r\n\r\n  active: ActiveStreamStatsSchema.optional(),\r\n  lastRequest: CompletedStreamStatsSchema.optional(),\r\n  session: SessionTimingStatsSchema.optional(),\r\n});\r\n\r\nexport const SessionTimingFileSchema = z.object({\r\n  version: z.literal(2),\r\n  lastRequest: CompletedStreamStatsSchema.optional(),\r\n  session: SessionTimingStatsSchema,\r\n\r\n  /**\r\n   * Idempotency ledger for rolled-up sub-agent timing.\r\n   *\r\n   * When a child workspace is deleted, we merge its session timing into the parent.\r\n   * This tracks which children have already been merged to prevent double-counting\r\n   * if removal is retried.\r\n   */\r\n  rolledUpFrom: z.record(z.string(), z.literal(true)).optional(),\r\n});\r\n\r\n// Convenient TypeScript type exports\r\nexport type TimingAnomaly = z.infer<typeof TimingAnomalySchema>;\r\nexport type ActiveStreamStats = z.infer<typeof ActiveStreamStatsSchema>;\r\nexport type CompletedStreamStats = z.infer<typeof CompletedStreamStatsSchema>;\r\nexport type ModelTimingStats = z.infer<typeof ModelTimingStatsSchema>;\r\nexport type SessionTimingStats = z.infer<typeof SessionTimingStatsSchema>;\r\nexport type WorkspaceStatsSnapshot = z.infer<typeof WorkspaceStatsSnapshotSchema>;\r\nexport type SessionTimingFile = z.infer<typeof SessionTimingFileSchema>;\r\n"]}