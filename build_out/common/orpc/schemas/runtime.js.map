{"version":3,"file":"runtime.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/runtime.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\r\nimport { CoderWorkspaceConfigSchema } from \"./coder\";\r\n\r\nexport const RuntimeModeSchema = z.enum([\"local\", \"worktree\", \"ssh\", \"docker\", \"devcontainer\"]);\r\n\r\n/**\r\n * Runtime configuration union type.\r\n *\r\n * COMPATIBILITY NOTE:\r\n * - `type: \"local\"` with `srcBaseDir` = legacy worktree config (for backward compat)\r\n * - `type: \"local\"` without `srcBaseDir` = new project-dir runtime\r\n * - `type: \"worktree\"` = explicit worktree runtime (new workspaces)\r\n *\r\n * This allows two-way compatibility: users can upgrade/downgrade without breaking workspaces.\r\n */\r\n// Common field for background process output directory\r\nconst bgOutputDirField = z\r\n  .string()\r\n  .optional()\r\n  .meta({ description: \"Directory for background process output (e.g., /tmp/mux-bashes)\" });\r\n\r\nexport const DevcontainerConfigInfoSchema = z.object({\r\n  path: z.string(),\r\n  label: z.string(),\r\n});\r\n\r\n/**\r\n * Runtime availability status - discriminated union that can carry mode-specific data.\r\n * Most runtimes use the simple available/unavailable shape; devcontainer carries extra\r\n * config info when available.\r\n *\r\n * IMPORTANT: The configs-bearing shape MUST come before the plain `{ available: true }`\r\n * shape in the union. Zod matches the first valid schema, so if the plain shape comes\r\n * first, it will match and strip the `configs` field from devcontainer responses.\r\n */\r\nexport const RuntimeAvailabilityStatusSchema = z.union([\r\n  // Devcontainer-specific: available with configs (must be first to preserve configs)\r\n  z.object({\r\n    available: z.literal(true),\r\n    configs: z.array(DevcontainerConfigInfoSchema),\r\n    cliVersion: z.string().optional(),\r\n  }),\r\n  // Generic: available without extra data\r\n  z.object({ available: z.literal(true) }),\r\n  // Unavailable with reason\r\n  z.object({ available: z.literal(false), reason: z.string() }),\r\n]);\r\n\r\nexport const RuntimeAvailabilitySchema = z.object({\r\n  local: RuntimeAvailabilityStatusSchema,\r\n  worktree: RuntimeAvailabilityStatusSchema,\r\n  ssh: RuntimeAvailabilityStatusSchema,\r\n  docker: RuntimeAvailabilityStatusSchema,\r\n  devcontainer: RuntimeAvailabilityStatusSchema,\r\n});\r\nexport const RuntimeConfigSchema = z.union([\r\n  // Legacy local with srcBaseDir (treated as worktree)\r\n  z.object({\r\n    type: z.literal(\"local\"),\r\n    srcBaseDir: z.string().meta({\r\n      description: \"Base directory where all workspaces are stored (legacy worktree config)\",\r\n    }),\r\n    bgOutputDir: bgOutputDirField,\r\n  }),\r\n  // New project-dir local (no srcBaseDir)\r\n  z.object({\r\n    type: z.literal(\"local\"),\r\n    bgOutputDir: bgOutputDirField,\r\n  }),\r\n  // Explicit worktree runtime\r\n  z.object({\r\n    type: z.literal(\"worktree\"),\r\n    srcBaseDir: z\r\n      .string()\r\n      .meta({ description: \"Base directory where all workspaces are stored (e.g., ~/.mux/src)\" }),\r\n    bgOutputDir: bgOutputDirField,\r\n  }),\r\n  // SSH runtime\r\n  z.object({\r\n    type: z.literal(\"ssh\"),\r\n    host: z\r\n      .string()\r\n      .meta({ description: \"SSH host (can be hostname, user@host, or SSH config alias)\" }),\r\n    srcBaseDir: z\r\n      .string()\r\n      .meta({ description: \"Base directory on remote host where all workspaces are stored\" }),\r\n    bgOutputDir: bgOutputDirField,\r\n    identityFile: z\r\n      .string()\r\n      .optional()\r\n      .meta({ description: \"Path to SSH private key (if not using ~/.ssh/config or ssh-agent)\" }),\r\n    port: z.number().optional().meta({ description: \"SSH port (default: 22)\" }),\r\n    coder: CoderWorkspaceConfigSchema.optional().meta({\r\n      description: \"Coder workspace configuration (when using Coder as SSH backend)\",\r\n    }),\r\n  }),\r\n  // Docker runtime - each workspace runs in its own container\r\n  z.object({\r\n    type: z.literal(\"docker\"),\r\n    image: z.string().meta({ description: \"Docker image to use (e.g., node:20)\" }),\r\n    containerName: z\r\n      .string()\r\n      .optional()\r\n      .meta({ description: \"Container name (populated after workspace creation)\" }),\r\n    shareCredentials: z.boolean().optional().meta({\r\n      description: \"Forward SSH agent and mount ~/.gitconfig read-only\",\r\n    }),\r\n  }),\r\n  // Devcontainer runtime - uses devcontainer CLI to build/run containers from devcontainer.json\r\n  z.object({\r\n    type: z.literal(\"devcontainer\"),\r\n    configPath: z\r\n      .string()\r\n      .meta({ description: \"Path to devcontainer.json (relative to project root)\" }),\r\n    shareCredentials: z.boolean().optional().meta({\r\n      description: \"Forward SSH agent and mount ~/.gitconfig read-only\",\r\n    }),\r\n  }),\r\n]);\r\n"]}