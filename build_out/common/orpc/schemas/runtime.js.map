{"version":3,"file":"runtime.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/runtime.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\nimport { CoderWorkspaceConfigSchema } from \"./coder\";\n\nexport const RuntimeModeSchema = z.enum([\"local\", \"worktree\", \"ssh\", \"docker\", \"devcontainer\"]);\n\n/**\n * Runtime configuration union type.\n *\n * COMPATIBILITY NOTE:\n * - `type: \"local\"` with `srcBaseDir` = legacy worktree config (for backward compat)\n * - `type: \"local\"` without `srcBaseDir` = new project-dir runtime\n * - `type: \"worktree\"` = explicit worktree runtime (new workspaces)\n *\n * This allows two-way compatibility: users can upgrade/downgrade without breaking workspaces.\n */\n// Common field for background process output directory\nconst bgOutputDirField = z\n  .string()\n  .optional()\n  .meta({ description: \"Directory for background process output (e.g., /tmp/mux-bashes)\" });\n\nexport const DevcontainerConfigInfoSchema = z.object({\n  path: z.string(),\n  label: z.string(),\n});\n\n/**\n * Runtime availability status - discriminated union that can carry mode-specific data.\n * Most runtimes use the simple available/unavailable shape; devcontainer carries extra\n * config info when available.\n *\n * IMPORTANT: The configs-bearing shape MUST come before the plain `{ available: true }`\n * shape in the union. Zod matches the first valid schema, so if the plain shape comes\n * first, it will match and strip the `configs` field from devcontainer responses.\n */\nexport const RuntimeAvailabilityStatusSchema = z.union([\n  // Devcontainer-specific: available with configs (must be first to preserve configs)\n  z.object({\n    available: z.literal(true),\n    configs: z.array(DevcontainerConfigInfoSchema),\n    cliVersion: z.string().optional(),\n  }),\n  // Generic: available without extra data\n  z.object({ available: z.literal(true) }),\n  // Unavailable with reason\n  z.object({ available: z.literal(false), reason: z.string() }),\n]);\n\nexport const RuntimeAvailabilitySchema = z.object({\n  local: RuntimeAvailabilityStatusSchema,\n  worktree: RuntimeAvailabilityStatusSchema,\n  ssh: RuntimeAvailabilityStatusSchema,\n  docker: RuntimeAvailabilityStatusSchema,\n  devcontainer: RuntimeAvailabilityStatusSchema,\n});\nexport const RuntimeConfigSchema = z.union([\n  // Legacy local with srcBaseDir (treated as worktree)\n  z.object({\n    type: z.literal(\"local\"),\n    srcBaseDir: z.string().meta({\n      description: \"Base directory where all workspaces are stored (legacy worktree config)\",\n    }),\n    bgOutputDir: bgOutputDirField,\n  }),\n  // New project-dir local (no srcBaseDir)\n  z.object({\n    type: z.literal(\"local\"),\n    bgOutputDir: bgOutputDirField,\n  }),\n  // Explicit worktree runtime\n  z.object({\n    type: z.literal(\"worktree\"),\n    srcBaseDir: z\n      .string()\n      .meta({ description: \"Base directory where all workspaces are stored (e.g., ~/.mux/src)\" }),\n    bgOutputDir: bgOutputDirField,\n  }),\n  // SSH runtime\n  z.object({\n    type: z.literal(\"ssh\"),\n    host: z\n      .string()\n      .meta({ description: \"SSH host (can be hostname, user@host, or SSH config alias)\" }),\n    srcBaseDir: z\n      .string()\n      .meta({ description: \"Base directory on remote host where all workspaces are stored\" }),\n    bgOutputDir: bgOutputDirField,\n    identityFile: z\n      .string()\n      .optional()\n      .meta({ description: \"Path to SSH private key (if not using ~/.ssh/config or ssh-agent)\" }),\n    port: z.number().optional().meta({ description: \"SSH port (default: 22)\" }),\n    coder: CoderWorkspaceConfigSchema.optional().meta({\n      description: \"Coder workspace configuration (when using Coder as SSH backend)\",\n    }),\n  }),\n  // Docker runtime - each workspace runs in its own container\n  z.object({\n    type: z.literal(\"docker\"),\n    image: z.string().meta({ description: \"Docker image to use (e.g., node:20)\" }),\n    containerName: z\n      .string()\n      .optional()\n      .meta({ description: \"Container name (populated after workspace creation)\" }),\n    shareCredentials: z.boolean().optional().meta({\n      description: \"Forward SSH agent and mount ~/.gitconfig read-only\",\n    }),\n  }),\n  // Devcontainer runtime - uses devcontainer CLI to build/run containers from devcontainer.json\n  z.object({\n    type: z.literal(\"devcontainer\"),\n    configPath: z\n      .string()\n      .meta({ description: \"Path to devcontainer.json (relative to project root)\" }),\n    shareCredentials: z.boolean().optional().meta({\n      description: \"Forward SSH agent and mount ~/.gitconfig read-only\",\n    }),\n  }),\n]);\n"]}