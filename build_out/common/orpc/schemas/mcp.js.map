{"version":3,"file":"mcp.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/mcp.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\n\n/**\n * Per-workspace MCP overrides.\n *\n * Stored per-workspace in <workspace>/.mux/mcp.local.jsonc (workspace-local, intended to be gitignored).\n * Allows workspaces to disable servers or restrict tool allowlists\n * without modifying the project-level .mux/mcp.jsonc.\n */\nexport const WorkspaceMCPOverridesSchema = z.object({\n  /** Server names to explicitly disable for this workspace. */\n  disabledServers: z.array(z.string()).optional(),\n  /** Server names to explicitly enable for this workspace (overrides project-level disabled). */\n  enabledServers: z.array(z.string()).optional(),\n\n  /**\n   * Per-server tool allowlist.\n   * Key: server name\n   * Value: raw MCP tool names (NOT namespaced)\n   *\n   * If omitted for a server => expose all tools from that server.\n   * If present but empty => expose no tools from that server.\n   */\n  toolAllowlist: z.record(z.string(), z.array(z.string())).optional(),\n});\n\nexport const MCPTransportSchema = z.enum([\"stdio\", \"http\", \"sse\", \"auto\"]);\n\nexport const MCPHeaderValueSchema = z.union([z.string(), z.object({ secret: z.string() })]);\nexport const MCPHeadersSchema = z.record(z.string(), MCPHeaderValueSchema);\n\nexport const MCPServerInfoSchema = z.discriminatedUnion(\"transport\", [\n  z.object({\n    transport: z.literal(\"stdio\"),\n    command: z.string(),\n    disabled: z.boolean(),\n    toolAllowlist: z.array(z.string()).optional(),\n  }),\n  z.object({\n    transport: z.literal(\"http\"),\n    url: z.string(),\n    headers: MCPHeadersSchema.optional(),\n    disabled: z.boolean(),\n    toolAllowlist: z.array(z.string()).optional(),\n  }),\n  z.object({\n    transport: z.literal(\"sse\"),\n    url: z.string(),\n    headers: MCPHeadersSchema.optional(),\n    disabled: z.boolean(),\n    toolAllowlist: z.array(z.string()).optional(),\n  }),\n  z.object({\n    transport: z.literal(\"auto\"),\n    url: z.string(),\n    headers: MCPHeadersSchema.optional(),\n    disabled: z.boolean(),\n    toolAllowlist: z.array(z.string()).optional(),\n  }),\n]);\n\nexport const MCPServerMapSchema = z.record(z.string(), MCPServerInfoSchema);\n\nexport const MCPListParamsSchema = z.object({\n  projectPath: z.string().optional(),\n});\n\nconst MCPAddParamsBaseSchema = z.object({\n  name: z.string(),\n\n  // Backward-compatible: if transport omitted, interpret as stdio.\n  transport: MCPTransportSchema.optional(),\n\n  command: z.string().optional(),\n  url: z.string().optional(),\n  headers: MCPHeadersSchema.optional(),\n});\n\ntype MCPAddParamsLike = z.infer<typeof MCPAddParamsBaseSchema>;\n\nfunction refineMcpAddParams(input: MCPAddParamsLike, ctx: z.RefinementCtx): void {\n  const transport = input.transport ?? \"stdio\";\n\n  if (transport === \"stdio\") {\n    if (!input.command?.trim()) {\n      ctx.addIssue({ code: z.ZodIssueCode.custom, message: \"command is required for stdio\" });\n    }\n    return;\n  }\n\n  if (!input.url?.trim()) {\n    ctx.addIssue({ code: z.ZodIssueCode.custom, message: \"url is required for http/sse/auto\" });\n  }\n}\n\n/** Global MCP config mutation (no projectPath). */\nexport const MCPAddGlobalParamsSchema = MCPAddParamsBaseSchema.superRefine(refineMcpAddParams);\n\n/** @deprecated Legacy project-scoped API shape (writes now apply to global config). */\nexport const MCPAddParamsSchema = MCPAddParamsBaseSchema.extend({\n  projectPath: z.string(),\n}).superRefine(refineMcpAddParams);\n\nconst MCPRemoveParamsBaseSchema = z.object({\n  name: z.string(),\n});\n\nexport const MCPRemoveGlobalParamsSchema = MCPRemoveParamsBaseSchema;\n\n/** @deprecated Legacy project-scoped API shape (writes now apply to global config). */\nexport const MCPRemoveParamsSchema = MCPRemoveParamsBaseSchema.extend({\n  projectPath: z.string(),\n});\n\nconst MCPSetEnabledParamsBaseSchema = z.object({\n  name: z.string(),\n  enabled: z.boolean(),\n});\n\nexport const MCPSetEnabledGlobalParamsSchema = MCPSetEnabledParamsBaseSchema;\n\n/** @deprecated Legacy project-scoped API shape (writes now apply to global config). */\nexport const MCPSetEnabledParamsSchema = MCPSetEnabledParamsBaseSchema.extend({\n  projectPath: z.string(),\n});\n\nconst MCPSetToolAllowlistParamsBaseSchema = z.object({\n  name: z.string(),\n  /** Tool names to allow. Empty array = no tools allowed. */\n  toolAllowlist: z.array(z.string()),\n});\n\nexport const MCPSetToolAllowlistGlobalParamsSchema = MCPSetToolAllowlistParamsBaseSchema;\n\n/** @deprecated Legacy project-scoped API shape (writes now apply to global config). */\nexport const MCPSetToolAllowlistParamsSchema = MCPSetToolAllowlistParamsBaseSchema.extend({\n  projectPath: z.string(),\n});\n\n/**\n * Unified test params - provide either:\n * - name (to test a configured server), OR\n * - command (to test arbitrary stdio command), OR\n * - url+transport (to test arbitrary http/sse/auto endpoint)\n *\n * For pending-server tests (e.g. add-server form), callers may also provide\n * name+url+transport so the backend can attach stored OAuth credentials.\n */\nconst MCPTestParamsBaseSchema = z.object({\n  name: z.string().optional(),\n\n  transport: MCPTransportSchema.optional(),\n  command: z.string().optional(),\n  url: z.string().optional(),\n  headers: MCPHeadersSchema.optional(),\n});\n\ntype MCPTestParamsLike = z.infer<typeof MCPTestParamsBaseSchema>;\n\nfunction refineMcpTestParams(input: MCPTestParamsLike, ctx: z.RefinementCtx): void {\n  const hasName = Boolean(input.name?.trim());\n  const hasCommand = Boolean(input.command?.trim());\n  const hasUrl = Boolean(input.url?.trim());\n\n  if (!hasName && !hasCommand && !hasUrl) {\n    ctx.addIssue({\n      code: z.ZodIssueCode.custom,\n      message: \"Either name, command, or url is required\",\n    });\n    return;\n  }\n\n  if (hasUrl) {\n    const transport = input.transport;\n    if (transport !== \"http\" && transport !== \"sse\" && transport !== \"auto\") {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"transport must be http|sse|auto when testing by url\",\n      });\n    }\n  }\n}\n\n/** Test endpoint input with optional projectPath (global-only secrets when omitted). */\nexport const MCPTestGlobalParamsSchema = MCPTestParamsBaseSchema.extend({\n  projectPath: z.string().optional(),\n}).superRefine(refineMcpTestParams);\n\n/** @deprecated Legacy project-scoped API shape. */\nexport const MCPTestParamsSchema = MCPTestParamsBaseSchema.extend({\n  projectPath: z.string(),\n}).superRefine(refineMcpTestParams);\n\nexport const BearerChallengeSchema = z.object({\n  scope: z.string().optional(),\n  resourceMetadataUrl: z.url().optional(),\n});\n\nexport const MCPTestResultSchema = z.discriminatedUnion(\"success\", [\n  z.object({ success: z.literal(true), tools: z.array(z.string()) }),\n  z.object({\n    success: z.literal(false),\n    error: z.string(),\n    oauthChallenge: BearerChallengeSchema.optional(),\n  }),\n]);\n"]}