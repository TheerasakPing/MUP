{"version":3,"file":"chatStats.test.js","sourceRoot":"","sources":["../../../../src/common/orpc/schemas/chatStats.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport type { z } from \"zod\";\r\nimport { SessionUsageFileSchema } from \"./chatStats\";\r\n\r\ntype SessionUsageFile = z.infer<typeof SessionUsageFileSchema>;\r\n\r\ndescribe(\"SessionUsageFileSchema conformance\", () => {\r\n  it(\"preserves rolledUpFrom and tokenStatsCache fields\", () => {\r\n    const full: SessionUsageFile = {\r\n      byModel: {\r\n        \"gpt-4\": {\r\n          input: { tokens: 1, cost_usd: 0.01 },\r\n          cached: { tokens: 0, cost_usd: 0 },\r\n          cacheCreate: { tokens: 0, cost_usd: 0 },\r\n          output: { tokens: 2, cost_usd: 0.02 },\r\n          reasoning: { tokens: 0, cost_usd: 0 },\r\n          model: \"gpt-4\",\r\n        },\r\n      },\r\n      lastRequest: {\r\n        model: \"gpt-4\",\r\n        usage: {\r\n          input: { tokens: 1 },\r\n          cached: { tokens: 0 },\r\n          cacheCreate: { tokens: 0 },\r\n          output: { tokens: 2 },\r\n          reasoning: { tokens: 0 },\r\n          model: \"gpt-4\",\r\n        },\r\n        timestamp: 123,\r\n      },\r\n      rolledUpFrom: { \"child-workspace\": true },\r\n      tokenStatsCache: {\r\n        version: 1,\r\n        computedAt: 123,\r\n        model: \"gpt-4\",\r\n        tokenizerName: \"cl100k\",\r\n        history: { messageCount: 2, maxHistorySequence: 42 },\r\n        consumers: [{ name: \"User\", tokens: 10, percentage: 100 }],\r\n        totalTokens: 10,\r\n        topFilePaths: [{ path: \"/tmp/file.ts\", tokens: 10 }],\r\n      },\r\n      version: 1,\r\n    };\r\n\r\n    const parsed = SessionUsageFileSchema.parse(full);\r\n\r\n    // oRPC output validation strips unknown keys; ensure we preserve everything we return.\r\n    expect(parsed).toEqual(full);\r\n    expect(Object.keys(parsed).sort()).toEqual(Object.keys(full).sort());\r\n  });\r\n\r\n  it(\"parses legacy session-usage.json without optional fields\", () => {\r\n    const legacy = {\r\n      byModel: {},\r\n      version: 1,\r\n    };\r\n\r\n    const parsed = SessionUsageFileSchema.parse(legacy);\r\n    expect(parsed.byModel).toEqual({});\r\n    expect(parsed.version).toBe(1);\r\n    expect(parsed.rolledUpFrom).toBeUndefined();\r\n    expect(parsed.tokenStatsCache).toBeUndefined();\r\n  });\r\n});\r\n"]}