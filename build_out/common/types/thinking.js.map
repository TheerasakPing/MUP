{"version":3,"file":"thinking.js","sourceRoot":"","sources":["../../../src/common/types/thinking.ts"],"names":[],"mappings":";AAAA;;;;;GAKG;;;;;;;;;;AAEU,QAAA,eAAe,GAAG,CAAC,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,KAAK,CAAU,CAAC;AAGzF;;;GAGG;AACU,QAAA,uBAAuB,GAAkC;IACpE,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,MAAM,EAAE,KAAK;IACb,IAAI,EAAE,MAAM;IACZ,KAAK,EAAE,KAAK;IACZ,GAAG,EAAE,KAAK;CACX,CAAC;AAEF;;;;GAIG;AACH,iCAAwC,KAAoB,EAAE,WAAoB,EAAU;IAC1F,0DAA0D;IAC1D,IAAI,CAAC,KAAK,KAAK,OAAO,IAAI,KAAK,KAAK,KAAK,CAAC,IAAI,WAAW,EAAE,CAAC;QAC1D,MAAM,UAAU,GAAG,WAAW,CAAC,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;QACpD,kEAAkE;QAClE,IAAI,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC;YAAE,OAAO,OAAO,CAAC;QACrD,MAAM,aAAa,GAAG,UAAU,CAAC,OAAO,CAAC,kBAAkB,EAAE,EAAE,CAAC,CAAC;QACjE,IAAI,aAAa,CAAC,UAAU,CAAC,SAAS,CAAC;YAAE,OAAO,OAAO,CAAC;IAC1D,CAAC;IACD,OAAO,QAAA,uBAAuB,CAAC,KAAK,CAAC,CAAC;AAAA,CACvC;AAED;;;;;GAKG;AACH,gCAAuC,KAAoB,EAAE,WAAoB,EAAU;IACzF,IAAI,KAAK,KAAK,OAAO,IAAI,KAAK,KAAK,KAAK,EAAE,CAAC;QACzC,OAAO,KAAK,CAAC;IACf,CAAC;IAED,OAAO,uBAAuB,CAAC,KAAK,EAAE,WAAW,CAAC,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC;AAAA,CAClF;AAED;;;GAGG;AACH,MAAM,sBAAsB,GAAkC;IAC5D,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,QAAQ;IACb,IAAI,EAAE,MAAM;IACZ,GAAG,EAAE,KAAK;IACV,KAAK,EAAE,OAAO;IACd,MAAM,EAAE,QAAQ;CACjB,CAAC;AAEF;;;GAGG;AACH,mCAA0C,KAAa,EAA6B;IAClF,MAAM,UAAU,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;IAC9C,OAAO,sBAAsB,CAAC,UAAU,CAAC,CAAC;AAAA,CAC3C;AAUD;;;;GAIG;AACU,QAAA,kBAAkB,GAAG,CAAC,CAAC;AAEpC;;;;;;;;GAQG;AACH,4BAAmC,KAAa,EAAmC;IACjF,MAAM,UAAU,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;IAE9C,wEAAwE;IACxE,MAAM,KAAK,GAAG,sBAAsB,CAAC,UAAU,CAAC,CAAC;IACjD,IAAI,KAAK;QAAE,OAAO,KAAK,CAAC;IAExB,uEAAqE;IACrE,sEAAsE;IACtE,MAAM,GAAG,GAAG,QAAQ,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;IACrC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,MAAM,CAAC,GAAG,CAAC,KAAK,UAAU,IAAI,GAAG,IAAI,CAAC,IAAI,GAAG,IAAI,QAAA,kBAAkB,EAAE,CAAC;QAC9F,OAAO,GAAG,CAAC;IACb,CAAC;IAED,OAAO,SAAS,CAAC;AAAA,CAClB;AAQD,yBAAgC,KAAc,EAA0B;IACtE,OAAO,OAAO,KAAK,KAAK,QAAQ,IAAI,QAAA,eAAe,CAAC,QAAQ,CAAC,KAAsB,CAAC,CAAC;AAAA,CACtF;AAED;;;GAGG;AACU,QAAA,uBAAuB,GAA4C;IAC9E,GAAG,EAAE,QAAQ;CACd,CAAC;AAEF,6BAAoC,KAAc,EAA6B;IAC7E,IAAI,OAAO,KAAK,KAAK,QAAQ;QAAE,OAAO,SAAS,CAAC;IAChD,MAAM,OAAO,GAAG,QAAA,uBAAuB,CAAC,KAAK,CAAC,CAAC;IAC/C,IAAI,OAAO;QAAE,OAAO,OAAO,CAAC;IAC5B,OAAO,eAAe,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC;AAAA,CACnD;AAED;;;;;;;;;;;GAWG;AACU,QAAA,0BAA0B,GAAkC;IACvE,GAAG,EAAE,CAAC;IACN,GAAG,EAAE,IAAI;IACT,MAAM,EAAE,KAAK;IACb,IAAI,EAAE,KAAK;IACX,KAAK,EAAE,KAAK,EAAE,8DAA8D;IAC5E,GAAG,EAAE,KAAK;CACX,CAAC;AAOF;;;;;;GAMG;AACH,MAAM,gBAAgB,GAAgD;IACpE,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,MAAM,EAAE,QAAQ;IAChB,IAAI,EAAE,MAAM;IACZ,KAAK,EAAE,KAAK,EAAE,wEAAwE;IACtF,GAAG,EAAE,KAAK;CACX,CAAC;AAEF,4BAAmC,KAAoB,EAAwB;IAC7E,OAAO,gBAAgB,CAAC,KAAK,CAAC,CAAC;AAAA,CAChC;AAED;;;;GAIG;AACU,QAAA,kBAAkB,GAAkB,KAAK,CAAC;AAEvD;;;GAGG;AACU,QAAA,sBAAsB,GAAoB,QAAQ,CAAC;AAEhE;;;;;GAKG;AACU,QAAA,uBAAuB,GAA8C;IAChF,GAAG,EAAE,SAAS;IACd,GAAG,EAAE,KAAK;IACV,MAAM,EAAE,QAAQ;IAChB,IAAI,EAAE,MAAM;IACZ,KAAK,EAAE,OAAO,EAAE,8CAA8C;IAC9D,GAAG,EAAE,OAAO;CACb,CAAC;AAEF;;;;;GAKG;AAEH;;GAEG;AACU,QAAA,uBAAuB,GAAkC;IACpE,GAAG,EAAE,CAAC;IACN,GAAG,EAAE,IAAI;IACT,MAAM,EAAE,IAAI;IACZ,IAAI,EAAE,KAAK,EAAE,2CAA2C;IACxD,KAAK,EAAE,KAAK,EAAE,8CAA8C;IAC5D,GAAG,EAAE,KAAK;CACF,CAAC;AACE,QAAA,2BAA2B,GAGpC;IACF,GAAG,EAAE,SAAS;IACd,GAAG,EAAE,KAAK;IACV,MAAM,EAAE,QAAQ;IAChB,IAAI,EAAE,MAAM;IACZ,KAAK,EAAE,MAAM,EAAE,sDAAsD;IACrE,GAAG,EAAE,MAAM;CACZ,CAAC","sourcesContent":["/**\r\n * Thinking/Reasoning level types and mappings for AI models\r\n *\r\n * This module provides a unified interface for controlling reasoning across\r\n * different AI providers (Anthropic, OpenAI, etc.)\r\n */\r\n\r\nexport const THINKING_LEVELS = [\"off\", \"low\", \"medium\", \"high\", \"xhigh\", \"max\"] as const;\r\nexport type ThinkingLevel = (typeof THINKING_LEVELS)[number];\r\n\r\n/**\r\n * User-facing display labels for thinking levels.\r\n * Used in CLI help text and UI display.\r\n */\r\nexport const THINKING_DISPLAY_LABELS: Record<ThinkingLevel, string> = {\r\n  off: \"OFF\",\r\n  low: \"LOW\",\r\n  medium: \"MED\",\r\n  high: \"HIGH\",\r\n  xhigh: \"MAX\",\r\n  max: \"MAX\",\r\n};\r\n\r\n/**\r\n * Display label for thinking levels, with provider-aware xhigh labeling.\r\n * OpenAI models show \"XHIGH\" (their API term); Anthropic/default show \"MAX\".\r\n * Medium always displays as \"MED\".\r\n */\r\nexport function getThinkingDisplayLabel(level: ThinkingLevel, modelString?: string): string {\r\n  // xhigh and max are synonyms; show provider-aligned label\r\n  if ((level === \"xhigh\" || level === \"max\") && modelString) {\r\n    const normalized = modelString.trim().toLowerCase();\r\n    // OpenAI models: \"openai:gpt-5.2\" or \"mux-gateway:openai/gpt-5.2\"\r\n    if (normalized.startsWith(\"openai:\")) return \"XHIGH\";\r\n    const withoutPrefix = normalized.replace(/^[a-z0-9_-]+:\\s*/, \"\");\r\n    if (withoutPrefix.startsWith(\"openai/\")) return \"XHIGH\";\r\n  }\r\n  return THINKING_DISPLAY_LABELS[level];\r\n}\r\n\r\n/**\r\n * UI option label for thinking levels.\r\n *\r\n * Settings dropdowns use lowercase labels for most levels, but xhigh/max should\r\n * remain provider-aware to match the model's terminology.\r\n */\r\nexport function getThinkingOptionLabel(level: ThinkingLevel, modelString?: string): string {\r\n  if (level !== \"xhigh\" && level !== \"max\") {\r\n    return level;\r\n  }\r\n\r\n  return getThinkingDisplayLabel(level, modelString) === \"XHIGH\" ? \"xhigh\" : \"max\";\r\n}\r\n\r\n/**\r\n * Reverse mapping from display labels/aliases to internal ThinkingLevel values.\r\n * Accepts both canonical names and shorthand aliases (e.g., \"med\" → \"medium\").\r\n */\r\nconst DISPLAY_LABEL_TO_LEVEL: Record<string, ThinkingLevel> = {\r\n  off: \"off\",\r\n  low: \"low\",\r\n  med: \"medium\",\r\n  high: \"high\",\r\n  max: \"max\",\r\n  xhigh: \"xhigh\",\r\n  medium: \"medium\",\r\n};\r\n\r\n/**\r\n * Parse a thinking level from user input (display label or legacy value)\r\n * Returns undefined if not recognized\r\n */\r\nexport function parseThinkingDisplayLabel(value: string): ThinkingLevel | undefined {\r\n  const normalized = value.trim().toLowerCase();\r\n  return DISPLAY_LABEL_TO_LEVEL[normalized];\r\n}\r\n\r\n/**\r\n * Result of parsing a thinking level input. Named levels resolve to a\r\n * ThinkingLevel string immediately; numeric indices are deferred and\r\n * resolved against the target model's thinking policy at send time\r\n * (since different models have different allowed level sets).\r\n */\r\nexport type ParsedThinkingInput = ThinkingLevel | number;\r\n\r\n/**\r\n * Maximum numeric thinking index (inclusive). Indices 0–N map to\r\n * the model's allowed levels sorted from lowest to highest.\r\n * Kept generous — out-of-range indices are clamped to the model's max.\r\n */\r\nexport const MAX_THINKING_INDEX = 9;\r\n\r\n/**\r\n * Parse a thinking level from user input — accepts both named levels\r\n * (\"off\", \"low\", \"med\", \"medium\", \"high\", \"max\", \"xhigh\") and numeric\r\n * indices (0–N). Named levels resolve immediately; numeric indices are\r\n * returned as numbers for model-aware resolution later via\r\n * `resolveThinkingInput()` in policy.ts.\r\n *\r\n * Used by both `mux run --thinking` and `/model+level` oneshot.\r\n */\r\nexport function parseThinkingInput(value: string): ParsedThinkingInput | undefined {\r\n  const normalized = value.trim().toLowerCase();\r\n\r\n  // Named level first (e.g., \"off\", \"low\", \"med\", \"high\", \"max\", \"xhigh\")\r\n  const named = DISPLAY_LABEL_TO_LEVEL[normalized];\r\n  if (named) return named;\r\n\r\n  // Numeric index — resolved later against the model's thinking policy\r\n  // (e.g., 0 = lowest allowed level, which is \"medium\" for gpt-5.2-pro)\r\n  const num = parseInt(normalized, 10);\r\n  if (!Number.isNaN(num) && String(num) === normalized && num >= 0 && num <= MAX_THINKING_INDEX) {\r\n    return num;\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Active thinking levels (excludes \"off\")\r\n * Used for storing/restoring the last-used thinking level per model\r\n */\r\nexport type ThinkingLevelOn = Exclude<ThinkingLevel, \"off\">;\r\n\r\nexport function isThinkingLevel(value: unknown): value is ThinkingLevel {\r\n  return typeof value === \"string\" && THINKING_LEVELS.includes(value as ThinkingLevel);\r\n}\r\n\r\n/**\r\n * Synonym aliases for CLI/UI input: \"med\" → \"medium\".\r\n * \"xhigh\" and \"max\" are both first-class ThinkingLevel values (not synonyms).\r\n */\r\nexport const THINKING_LEVEL_SYNONYMS: Readonly<Record<string, ThinkingLevel>> = {\r\n  med: \"medium\",\r\n};\r\n\r\nexport function coerceThinkingLevel(value: unknown): ThinkingLevel | undefined {\r\n  if (typeof value !== \"string\") return undefined;\r\n  const synonym = THINKING_LEVEL_SYNONYMS[value];\r\n  if (synonym) return synonym;\r\n  return isThinkingLevel(value) ? value : undefined;\r\n}\r\n\r\n/**\r\n * Anthropic thinking token budget mapping\r\n *\r\n * These heuristics balance thinking depth with response time and cost.\r\n * Used for models that support extended thinking with budgetTokens\r\n * (e.g., Sonnet 4.5, Haiku 4.5, Opus 4.1, etc.)\r\n *\r\n * - off: No extended thinking\r\n * - low: Quick thinking for straightforward tasks (4K tokens)\r\n * - medium: Standard thinking for moderate complexity (10K tokens)\r\n * - high: Deep thinking for complex problems (20K tokens)\r\n */\r\nexport const ANTHROPIC_THINKING_BUDGETS: Record<ThinkingLevel, number> = {\r\n  off: 0,\r\n  low: 4000,\r\n  medium: 10000,\r\n  high: 20000,\r\n  xhigh: 20000, // Same as high - budget ceiling; effort: \"max\" controls depth\r\n  max: 20000,\r\n};\r\n\r\n/**\r\n * Anthropic effort type - matches SDK's AnthropicProviderOptions[\"effort\"]\r\n */\r\nexport type AnthropicEffortLevel = \"low\" | \"medium\" | \"high\" | \"max\";\r\n\r\n/**\r\n * Anthropic effort parameter mapping (Opus 4.5+)\r\n *\r\n * The effort parameter controls how much computational work the model applies.\r\n * - Opus 4.5 supports: low, medium, high (policy clamps xhigh → high)\r\n * - Opus 4.6 supports: low, medium, high, max (xhigh maps to \"max\" effort)\r\n */\r\nconst ANTHROPIC_EFFORT: Record<ThinkingLevel, AnthropicEffortLevel> = {\r\n  off: \"low\",\r\n  low: \"low\",\r\n  medium: \"medium\",\r\n  high: \"high\",\r\n  xhigh: \"max\", // Opus 4.6; policy clamps Opus 4.5 to \"high\" so xhigh never reaches 4.5\r\n  max: \"max\",\r\n};\r\n\r\nexport function getAnthropicEffort(level: ThinkingLevel): AnthropicEffortLevel {\r\n  return ANTHROPIC_EFFORT[level];\r\n}\r\n\r\n/**\r\n * Default thinking level when no value is set (UI initial state, backend fallback).\r\n * Semantically different from DEFAULT_THINKING_LEVEL which is the level used\r\n * when a user opts *into* thinking (e.g., CLI `--thinking` with no explicit level).\r\n */\r\nexport const THINKING_LEVEL_OFF: ThinkingLevel = \"off\";\r\n\r\n/**\r\n * Default thinking level to use when toggling thinking on\r\n * if no previous value is stored for the model\r\n */\r\nexport const DEFAULT_THINKING_LEVEL: ThinkingLevelOn = \"medium\";\r\n\r\n/**\r\n * OpenAI reasoning_effort mapping\r\n *\r\n * Maps our unified levels to OpenAI's reasoningEffort parameter\r\n * (used by o1, o3-mini, gpt-5, etc.)\r\n */\r\nexport const OPENAI_REASONING_EFFORT: Record<ThinkingLevel, string | undefined> = {\r\n  off: undefined,\r\n  low: \"low\",\r\n  medium: \"medium\",\r\n  high: \"high\",\r\n  xhigh: \"xhigh\", // Maps 1:1 to OpenAI's reasoning effort value\r\n  max: \"xhigh\",\r\n};\r\n\r\n/**\r\n * OpenRouter reasoning effort mapping\r\n *\r\n * Maps our unified levels to OpenRouter's reasoning.effort parameter\r\n * (used by Claude Sonnet Thinking and other reasoning models via OpenRouter)\r\n */\r\n\r\n/**\r\n * Thinking budgets for Gemini 2.5 models (in tokens)\r\n */\r\nexport const GEMINI_THINKING_BUDGETS: Record<ThinkingLevel, number> = {\r\n  off: 0,\r\n  low: 2048,\r\n  medium: 8192,\r\n  high: 16384, // Conservative max (some models go to 32k)\r\n  xhigh: 16384, // Same as high - Gemini doesn't support xhigh\r\n  max: 16384,\r\n} as const;\r\nexport const OPENROUTER_REASONING_EFFORT: Record<\r\n  ThinkingLevel,\r\n  \"low\" | \"medium\" | \"high\" | undefined\r\n> = {\r\n  off: undefined,\r\n  low: \"low\",\r\n  medium: \"medium\",\r\n  high: \"high\",\r\n  xhigh: \"high\", // Fallback to high - OpenRouter doesn't support xhigh\r\n  max: \"high\",\r\n};\r\n"]}