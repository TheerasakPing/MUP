{"version":3,"file":"tasks.js","sourceRoot":"","sources":["../../../src/common/types/tasks.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\nimport { coerceThinkingLevel, type ThinkingLevel } from \"./thinking\";\n\nexport interface TaskSettings {\n  maxParallelAgentTasks: number;\n  maxTaskNestingDepth: number;\n\n  /**\n   * When enabled, clicking \"Implement\" in propose_plan first replaces chat history with the plan\n   * (same behavior as \"Start Here\").\n   */\n  proposePlanImplementReplacesChatHistory?: boolean;\n\n  // System 1: bash output compaction (log filtering)\n  bashOutputCompactionMinLines?: number;\n  bashOutputCompactionMinTotalBytes?: number;\n  bashOutputCompactionMaxKeptLines?: number;\n  bashOutputCompactionTimeoutMs?: number;\n  bashOutputCompactionHeuristicFallback?: boolean;\n}\n\nexport const TASK_SETTINGS_LIMITS = {\n  maxParallelAgentTasks: { min: 1, max: 256, default: 3 },\n  maxTaskNestingDepth: { min: 1, max: 5, default: 3 },\n} as const;\n\nexport const SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS = {\n  bashOutputCompactionMinLines: { min: 0, max: 1_000, default: 10 },\n  bashOutputCompactionMinTotalBytes: { min: 0, max: 16 * 1024, default: 4 * 1024 },\n  bashOutputCompactionMaxKeptLines: { min: 1, max: 1_000, default: 40 },\n  bashOutputCompactionTimeoutMs: { min: 1_000, max: 120_000, default: 5_000 },\n} as const;\n\nexport const DEFAULT_TASK_SETTINGS: TaskSettings = {\n  maxParallelAgentTasks: TASK_SETTINGS_LIMITS.maxParallelAgentTasks.default,\n  maxTaskNestingDepth: TASK_SETTINGS_LIMITS.maxTaskNestingDepth.default,\n  proposePlanImplementReplacesChatHistory: false,\n\n  bashOutputCompactionMinLines:\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default,\n  bashOutputCompactionMinTotalBytes:\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default,\n  bashOutputCompactionMaxKeptLines:\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default,\n  bashOutputCompactionTimeoutMs:\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.default,\n  bashOutputCompactionHeuristicFallback: true,\n};\n\nexport interface SubagentAiDefaultsEntry {\n  modelString?: string;\n  thinkingLevel?: ThinkingLevel;\n}\n\nexport type SubagentAiDefaults = Record<string, SubagentAiDefaultsEntry>;\n\nexport function normalizeSubagentAiDefaults(raw: unknown): SubagentAiDefaults {\n  const record = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : ({} as const);\n\n  const result: SubagentAiDefaults = {};\n\n  for (const [agentTypeRaw, entryRaw] of Object.entries(record)) {\n    const agentType = agentTypeRaw.trim().toLowerCase();\n    if (!agentType) continue;\n    if (agentType === \"exec\") continue;\n    if (!entryRaw || typeof entryRaw !== \"object\") continue;\n\n    const entry = entryRaw as Record<string, unknown>;\n\n    const modelString =\n      typeof entry.modelString === \"string\" && entry.modelString.trim().length > 0\n        ? entry.modelString.trim()\n        : undefined;\n\n    const thinkingLevel = coerceThinkingLevel(entry.thinkingLevel);\n\n    if (!modelString && !thinkingLevel) {\n      continue;\n    }\n\n    result[agentType] = { modelString, thinkingLevel };\n  }\n\n  return result;\n}\n\nfunction clampInt(value: unknown, fallback: number, min: number, max: number): number {\n  if (typeof value !== \"number\" || !Number.isFinite(value)) {\n    return fallback;\n  }\n\n  const rounded = Math.floor(value);\n  if (rounded < min) return min;\n  if (rounded > max) return max;\n  return rounded;\n}\n\nexport function normalizeTaskSettings(raw: unknown): TaskSettings {\n  const record = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : ({} as const);\n\n  const maxParallelAgentTasks = clampInt(\n    record.maxParallelAgentTasks,\n    DEFAULT_TASK_SETTINGS.maxParallelAgentTasks,\n    TASK_SETTINGS_LIMITS.maxParallelAgentTasks.min,\n    TASK_SETTINGS_LIMITS.maxParallelAgentTasks.max\n  );\n  const maxTaskNestingDepth = clampInt(\n    record.maxTaskNestingDepth,\n    DEFAULT_TASK_SETTINGS.maxTaskNestingDepth,\n    TASK_SETTINGS_LIMITS.maxTaskNestingDepth.min,\n    TASK_SETTINGS_LIMITS.maxTaskNestingDepth.max\n  );\n\n  const proposePlanImplementReplacesChatHistory =\n    typeof record.proposePlanImplementReplacesChatHistory === \"boolean\"\n      ? record.proposePlanImplementReplacesChatHistory\n      : (DEFAULT_TASK_SETTINGS.proposePlanImplementReplacesChatHistory ?? false);\n\n  const bashOutputCompactionMinLines = clampInt(\n    record.bashOutputCompactionMinLines,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.min,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.max\n  );\n  const bashOutputCompactionMinTotalBytes = clampInt(\n    record.bashOutputCompactionMinTotalBytes,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.min,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.max\n  );\n  const bashOutputCompactionMaxKeptLines = clampInt(\n    record.bashOutputCompactionMaxKeptLines,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.min,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.max\n  );\n  const bashOutputCompactionTimeoutMsRaw = clampInt(\n    record.bashOutputCompactionTimeoutMs,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.default,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.min,\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.max\n  );\n\n  const bashOutputCompactionHeuristicFallback =\n    typeof record.bashOutputCompactionHeuristicFallback === \"boolean\"\n      ? record.bashOutputCompactionHeuristicFallback\n      : (DEFAULT_TASK_SETTINGS.bashOutputCompactionHeuristicFallback ?? true);\n  const bashOutputCompactionTimeoutMs = Math.floor(bashOutputCompactionTimeoutMsRaw / 1000) * 1000;\n\n  const result: TaskSettings = {\n    maxParallelAgentTasks,\n    maxTaskNestingDepth,\n    proposePlanImplementReplacesChatHistory,\n    bashOutputCompactionMinLines,\n    bashOutputCompactionMinTotalBytes,\n    bashOutputCompactionMaxKeptLines,\n    bashOutputCompactionTimeoutMs,\n    bashOutputCompactionHeuristicFallback,\n  };\n\n  assert(\n    Number.isInteger(maxParallelAgentTasks),\n    \"normalizeTaskSettings: maxParallelAgentTasks must be an integer\"\n  );\n  assert(\n    Number.isInteger(maxTaskNestingDepth),\n    \"normalizeTaskSettings: maxTaskNestingDepth must be an integer\"\n  );\n\n  assert(\n    typeof proposePlanImplementReplacesChatHistory === \"boolean\",\n    \"normalizeTaskSettings: proposePlanImplementReplacesChatHistory must be a boolean\"\n  );\n\n  assert(\n    Number.isInteger(bashOutputCompactionMinLines),\n    \"normalizeTaskSettings: bashOutputCompactionMinLines must be an integer\"\n  );\n  assert(\n    Number.isInteger(bashOutputCompactionMinTotalBytes),\n    \"normalizeTaskSettings: bashOutputCompactionMinTotalBytes must be an integer\"\n  );\n  assert(\n    Number.isInteger(bashOutputCompactionMaxKeptLines),\n    \"normalizeTaskSettings: bashOutputCompactionMaxKeptLines must be an integer\"\n  );\n  assert(\n    Number.isInteger(bashOutputCompactionTimeoutMs),\n    \"normalizeTaskSettings: bashOutputCompactionTimeoutMs must be an integer\"\n  );\n\n  assert(\n    typeof bashOutputCompactionHeuristicFallback === \"boolean\",\n    \"normalizeTaskSettings: bashOutputCompactionHeuristicFallback must be a boolean\"\n  );\n  assert(\n    bashOutputCompactionTimeoutMs % 1000 === 0,\n    \"normalizeTaskSettings: bashOutputCompactionTimeoutMs must be a whole number of seconds\"\n  );\n\n  return result;\n}\n"]}