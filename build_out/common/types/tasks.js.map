{"version":3,"file":"tasks.js","sourceRoot":"","sources":["../../../src/common/types/tasks.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\r\nimport { coerceThinkingLevel, type ThinkingLevel } from \"./thinking\";\r\n\r\nexport interface TaskSettings {\r\n  maxParallelAgentTasks: number;\r\n  maxTaskNestingDepth: number;\r\n\r\n  /**\r\n   * When enabled, clicking \"Implement\" in propose_plan first replaces chat history with the plan\r\n   * (same behavior as \"Start Here\").\r\n   */\r\n  proposePlanImplementReplacesChatHistory?: boolean;\r\n\r\n  // System 1: bash output compaction (log filtering)\r\n  bashOutputCompactionMinLines?: number;\r\n  bashOutputCompactionMinTotalBytes?: number;\r\n  bashOutputCompactionMaxKeptLines?: number;\r\n  bashOutputCompactionTimeoutMs?: number;\r\n  bashOutputCompactionHeuristicFallback?: boolean;\r\n}\r\n\r\nexport const TASK_SETTINGS_LIMITS = {\r\n  maxParallelAgentTasks: { min: 1, max: 256, default: 3 },\r\n  maxTaskNestingDepth: { min: 1, max: 5, default: 3 },\r\n} as const;\r\n\r\nexport const SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS = {\r\n  bashOutputCompactionMinLines: { min: 0, max: 1_000, default: 10 },\r\n  bashOutputCompactionMinTotalBytes: { min: 0, max: 16 * 1024, default: 4 * 1024 },\r\n  bashOutputCompactionMaxKeptLines: { min: 1, max: 1_000, default: 40 },\r\n  bashOutputCompactionTimeoutMs: { min: 1_000, max: 120_000, default: 5_000 },\r\n} as const;\r\n\r\nexport const DEFAULT_TASK_SETTINGS: TaskSettings = {\r\n  maxParallelAgentTasks: TASK_SETTINGS_LIMITS.maxParallelAgentTasks.default,\r\n  maxTaskNestingDepth: TASK_SETTINGS_LIMITS.maxTaskNestingDepth.default,\r\n  proposePlanImplementReplacesChatHistory: false,\r\n\r\n  bashOutputCompactionMinLines:\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default,\r\n  bashOutputCompactionMinTotalBytes:\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default,\r\n  bashOutputCompactionMaxKeptLines:\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default,\r\n  bashOutputCompactionTimeoutMs:\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.default,\r\n  bashOutputCompactionHeuristicFallback: true,\r\n};\r\n\r\nexport interface SubagentAiDefaultsEntry {\r\n  modelString?: string;\r\n  thinkingLevel?: ThinkingLevel;\r\n}\r\n\r\nexport type SubagentAiDefaults = Record<string, SubagentAiDefaultsEntry>;\r\n\r\nexport function normalizeSubagentAiDefaults(raw: unknown): SubagentAiDefaults {\r\n  const record = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : ({} as const);\r\n\r\n  const result: SubagentAiDefaults = {};\r\n\r\n  for (const [agentTypeRaw, entryRaw] of Object.entries(record)) {\r\n    const agentType = agentTypeRaw.trim().toLowerCase();\r\n    if (!agentType) continue;\r\n    if (agentType === \"exec\") continue;\r\n    if (!entryRaw || typeof entryRaw !== \"object\") continue;\r\n\r\n    const entry = entryRaw as Record<string, unknown>;\r\n\r\n    const modelString =\r\n      typeof entry.modelString === \"string\" && entry.modelString.trim().length > 0\r\n        ? entry.modelString.trim()\r\n        : undefined;\r\n\r\n    const thinkingLevel = coerceThinkingLevel(entry.thinkingLevel);\r\n\r\n    if (!modelString && !thinkingLevel) {\r\n      continue;\r\n    }\r\n\r\n    result[agentType] = { modelString, thinkingLevel };\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction clampInt(value: unknown, fallback: number, min: number, max: number): number {\r\n  if (typeof value !== \"number\" || !Number.isFinite(value)) {\r\n    return fallback;\r\n  }\r\n\r\n  const rounded = Math.floor(value);\r\n  if (rounded < min) return min;\r\n  if (rounded > max) return max;\r\n  return rounded;\r\n}\r\n\r\nexport function normalizeTaskSettings(raw: unknown): TaskSettings {\r\n  const record = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : ({} as const);\r\n\r\n  const maxParallelAgentTasks = clampInt(\r\n    record.maxParallelAgentTasks,\r\n    DEFAULT_TASK_SETTINGS.maxParallelAgentTasks,\r\n    TASK_SETTINGS_LIMITS.maxParallelAgentTasks.min,\r\n    TASK_SETTINGS_LIMITS.maxParallelAgentTasks.max\r\n  );\r\n  const maxTaskNestingDepth = clampInt(\r\n    record.maxTaskNestingDepth,\r\n    DEFAULT_TASK_SETTINGS.maxTaskNestingDepth,\r\n    TASK_SETTINGS_LIMITS.maxTaskNestingDepth.min,\r\n    TASK_SETTINGS_LIMITS.maxTaskNestingDepth.max\r\n  );\r\n\r\n  const proposePlanImplementReplacesChatHistory =\r\n    typeof record.proposePlanImplementReplacesChatHistory === \"boolean\"\r\n      ? record.proposePlanImplementReplacesChatHistory\r\n      : (DEFAULT_TASK_SETTINGS.proposePlanImplementReplacesChatHistory ?? false);\r\n\r\n  const bashOutputCompactionMinLines = clampInt(\r\n    record.bashOutputCompactionMinLines,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.min,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.max\r\n  );\r\n  const bashOutputCompactionMinTotalBytes = clampInt(\r\n    record.bashOutputCompactionMinTotalBytes,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.min,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.max\r\n  );\r\n  const bashOutputCompactionMaxKeptLines = clampInt(\r\n    record.bashOutputCompactionMaxKeptLines,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.min,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.max\r\n  );\r\n  const bashOutputCompactionTimeoutMsRaw = clampInt(\r\n    record.bashOutputCompactionTimeoutMs,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.default,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.min,\r\n    SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.max\r\n  );\r\n\r\n  const bashOutputCompactionHeuristicFallback =\r\n    typeof record.bashOutputCompactionHeuristicFallback === \"boolean\"\r\n      ? record.bashOutputCompactionHeuristicFallback\r\n      : (DEFAULT_TASK_SETTINGS.bashOutputCompactionHeuristicFallback ?? true);\r\n  const bashOutputCompactionTimeoutMs = Math.floor(bashOutputCompactionTimeoutMsRaw / 1000) * 1000;\r\n\r\n  const result: TaskSettings = {\r\n    maxParallelAgentTasks,\r\n    maxTaskNestingDepth,\r\n    proposePlanImplementReplacesChatHistory,\r\n    bashOutputCompactionMinLines,\r\n    bashOutputCompactionMinTotalBytes,\r\n    bashOutputCompactionMaxKeptLines,\r\n    bashOutputCompactionTimeoutMs,\r\n    bashOutputCompactionHeuristicFallback,\r\n  };\r\n\r\n  assert(\r\n    Number.isInteger(maxParallelAgentTasks),\r\n    \"normalizeTaskSettings: maxParallelAgentTasks must be an integer\"\r\n  );\r\n  assert(\r\n    Number.isInteger(maxTaskNestingDepth),\r\n    \"normalizeTaskSettings: maxTaskNestingDepth must be an integer\"\r\n  );\r\n\r\n  assert(\r\n    typeof proposePlanImplementReplacesChatHistory === \"boolean\",\r\n    \"normalizeTaskSettings: proposePlanImplementReplacesChatHistory must be a boolean\"\r\n  );\r\n\r\n  assert(\r\n    Number.isInteger(bashOutputCompactionMinLines),\r\n    \"normalizeTaskSettings: bashOutputCompactionMinLines must be an integer\"\r\n  );\r\n  assert(\r\n    Number.isInteger(bashOutputCompactionMinTotalBytes),\r\n    \"normalizeTaskSettings: bashOutputCompactionMinTotalBytes must be an integer\"\r\n  );\r\n  assert(\r\n    Number.isInteger(bashOutputCompactionMaxKeptLines),\r\n    \"normalizeTaskSettings: bashOutputCompactionMaxKeptLines must be an integer\"\r\n  );\r\n  assert(\r\n    Number.isInteger(bashOutputCompactionTimeoutMs),\r\n    \"normalizeTaskSettings: bashOutputCompactionTimeoutMs must be an integer\"\r\n  );\r\n\r\n  assert(\r\n    typeof bashOutputCompactionHeuristicFallback === \"boolean\",\r\n    \"normalizeTaskSettings: bashOutputCompactionHeuristicFallback must be a boolean\"\r\n  );\r\n  assert(\r\n    bashOutputCompactionTimeoutMs % 1000 === 0,\r\n    \"normalizeTaskSettings: bashOutputCompactionTimeoutMs must be a whole number of seconds\"\r\n  );\r\n\r\n  return result;\r\n}\r\n"]}