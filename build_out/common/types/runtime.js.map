{"version":3,"file":"runtime.js","sourceRoot":"","sources":["../../../src/common/types/runtime.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Runtime configuration types for workspace execution environments\n */\n\nimport type { z } from \"zod\";\nimport type { RuntimeConfigSchema } from \"../orpc/schemas\";\nimport { RuntimeModeSchema } from \"../orpc/schemas\";\nimport type { CoderWorkspaceConfig } from \"../orpc/schemas/coder\";\n\n// Re-export CoderWorkspaceConfig type from schema (single source of truth)\nexport type { CoderWorkspaceConfig };\n\n/** Runtime mode type - used in UI and runtime string parsing */\nexport type RuntimeMode = z.infer<typeof RuntimeModeSchema>;\n\n/** Runtime mode constants */\nexport const RUNTIME_MODE = {\n  LOCAL: \"local\" as const,\n  WORKTREE: \"worktree\" as const,\n  SSH: \"ssh\" as const,\n  DOCKER: \"docker\" as const,\n  DEVCONTAINER: \"devcontainer\" as const,\n} as const;\n\n/** Runtime string prefix for SSH mode (e.g., \"ssh hostname\") */\nexport const SSH_RUNTIME_PREFIX = \"ssh \";\n\n/** Runtime string prefix for Docker mode (e.g., \"docker ubuntu:22.04\") */\nexport const DOCKER_RUNTIME_PREFIX = \"docker \";\n\n/** Runtime string prefix for Devcontainer mode (e.g., \"devcontainer .devcontainer/devcontainer.json\") */\nexport const DEVCONTAINER_RUNTIME_PREFIX = \"devcontainer \";\n\n/** Placeholder host for Coder SSH runtimes (where host is derived from Coder config) */\nexport const CODER_RUNTIME_PLACEHOLDER = \"coder://\";\n\nexport type RuntimeConfig = z.infer<typeof RuntimeConfigSchema>;\n\n/**\n * Parsed runtime result - discriminated union based on mode.\n * SSH requires host, Docker requires image, others have no extra args.\n */\nexport type ParsedRuntime =\n  | { mode: \"local\" }\n  | { mode: \"worktree\" }\n  | { mode: \"ssh\"; host: string; coder?: CoderWorkspaceConfig }\n  | { mode: \"docker\"; image: string; shareCredentials?: boolean }\n  | { mode: \"devcontainer\"; configPath: string; shareCredentials?: boolean };\n\n/**\n * Parse runtime string from localStorage or UI input into structured result.\n * Format: \"ssh <host>\" -> { mode: \"ssh\", host: \"<host>\" }\n *         \"docker <image>\" -> { mode: \"docker\", image: \"<image>\" }\n *         \"worktree\" -> { mode: \"worktree\" }\n *         \"local\" -> { mode: \"local\" }\n *         undefined/null -> { mode: \"worktree\" } (default)\n *\n * Note: \"ssh\" or \"docker\" without arguments returns null (invalid).\n * Use this for UI state management (localStorage, form inputs).\n */\nexport function parseRuntimeModeAndHost(runtime: string | null | undefined): ParsedRuntime | null {\n  if (!runtime) {\n    return { mode: RUNTIME_MODE.WORKTREE };\n  }\n\n  const trimmed = runtime.trim();\n  const lowerTrimmed = trimmed.toLowerCase();\n\n  if (lowerTrimmed === RUNTIME_MODE.LOCAL) {\n    return { mode: RUNTIME_MODE.LOCAL };\n  }\n\n  if (lowerTrimmed === RUNTIME_MODE.WORKTREE) {\n    return { mode: RUNTIME_MODE.WORKTREE };\n  }\n\n  // Check for \"ssh <host>\" format\n  if (lowerTrimmed.startsWith(SSH_RUNTIME_PREFIX)) {\n    const host = trimmed.substring(SSH_RUNTIME_PREFIX.length).trim();\n    if (!host) return null; // \"ssh \" without host is invalid\n    return { mode: RUNTIME_MODE.SSH, host };\n  }\n\n  // Plain \"ssh\" without host is invalid\n  if (lowerTrimmed === RUNTIME_MODE.SSH) {\n    return null;\n  }\n\n  // Check for \"docker <image>\" format\n  if (lowerTrimmed.startsWith(DOCKER_RUNTIME_PREFIX)) {\n    const image = trimmed.substring(DOCKER_RUNTIME_PREFIX.length).trim();\n    if (!image) return null; // \"docker \" without image is invalid\n    return { mode: RUNTIME_MODE.DOCKER, image };\n  }\n\n  // Plain \"docker\" without image is invalid\n  if (lowerTrimmed === RUNTIME_MODE.DOCKER) {\n    return null;\n  }\n\n  // Check for \"devcontainer <configPath>\" format (config path is optional)\n  if (lowerTrimmed.startsWith(DEVCONTAINER_RUNTIME_PREFIX)) {\n    const configPath = trimmed.substring(DEVCONTAINER_RUNTIME_PREFIX.length).trim();\n    return { mode: RUNTIME_MODE.DEVCONTAINER, configPath };\n  }\n\n  if (lowerTrimmed === RUNTIME_MODE.DEVCONTAINER) {\n    return { mode: RUNTIME_MODE.DEVCONTAINER, configPath: \"\" };\n  }\n\n  // Try to parse as a plain mode (local/worktree/devcontainer)\n  const modeResult = RuntimeModeSchema.safeParse(lowerTrimmed);\n  if (modeResult.success) {\n    const mode = modeResult.data;\n    if (mode === \"local\") return { mode: \"local\" };\n    if (mode === \"worktree\") return { mode: \"worktree\" };\n    if (mode === \"devcontainer\") return { mode: \"devcontainer\", configPath: \"\" };\n    // ssh/docker without args handled above\n  }\n\n  // Unrecognized - return null\n  return null;\n}\n\n/**\n * Build runtime string for storage/IPC from parsed runtime.\n * Returns: \"ssh <host>\" for SSH, \"docker <image>\" for Docker, \"local\" for local, undefined for worktree (default)\n */\nexport function buildRuntimeString(parsed: ParsedRuntime): string | undefined {\n  switch (parsed.mode) {\n    case RUNTIME_MODE.SSH:\n      return `${SSH_RUNTIME_PREFIX}${parsed.host}`;\n    case RUNTIME_MODE.DOCKER:\n      return `${DOCKER_RUNTIME_PREFIX}${parsed.image}`;\n    case RUNTIME_MODE.LOCAL:\n      return \"local\";\n    case RUNTIME_MODE.DEVCONTAINER: {\n      const configPath = parsed.configPath.trim();\n      return configPath.length > 0\n        ? `${DEVCONTAINER_RUNTIME_PREFIX}${configPath}`\n        : RUNTIME_MODE.DEVCONTAINER;\n    }\n    case RUNTIME_MODE.WORKTREE:\n      // Worktree is default, no string needed\n      return undefined;\n  }\n}\n\n/**\n * Convert ParsedRuntime to RuntimeConfig for workspace creation.\n * This preserves all fields (like shareCredentials for Docker) that would be lost\n * in string serialization via buildRuntimeString + parseRuntimeString.\n */\nexport function buildRuntimeConfig(parsed: ParsedRuntime): RuntimeConfig | undefined {\n  switch (parsed.mode) {\n    case RUNTIME_MODE.SSH:\n      return {\n        type: RUNTIME_MODE.SSH,\n        host: parsed.host.trim(),\n        srcBaseDir: \"~/mux\", // Default remote base directory (tilde resolved by backend)\n        coder: parsed.coder,\n      };\n    case RUNTIME_MODE.DOCKER:\n      return {\n        type: RUNTIME_MODE.DOCKER,\n        image: parsed.image.trim(),\n        shareCredentials: parsed.shareCredentials,\n      };\n    case RUNTIME_MODE.LOCAL:\n      return { type: RUNTIME_MODE.LOCAL };\n    case RUNTIME_MODE.DEVCONTAINER:\n      return {\n        type: RUNTIME_MODE.DEVCONTAINER,\n        configPath: parsed.configPath.trim(),\n        shareCredentials: parsed.shareCredentials,\n      };\n    case RUNTIME_MODE.WORKTREE:\n      // Worktree uses system default config\n      return undefined;\n  }\n}\n\n/**\n * Type guard to check if a runtime config is SSH\n */\nexport function isSSHRuntime(\n  config: RuntimeConfig | undefined\n): config is Extract<RuntimeConfig, { type: \"ssh\" }> {\n  return config?.type === \"ssh\";\n}\n\n/**\n * Type guard to check if a runtime config is Docker\n */\nexport function isDockerRuntime(\n  config: RuntimeConfig | undefined\n): config is Extract<RuntimeConfig, { type: \"docker\" }> {\n  return config?.type === \"docker\";\n}\n\n/**\n * Type guard to check if a runtime config is Devcontainer\n */\nexport function isDevcontainerRuntime(\n  config: RuntimeConfig | undefined\n): config is Extract<RuntimeConfig, { type: \"devcontainer\" }> {\n  return config?.type === \"devcontainer\";\n}\n\n/**\n * Type guard to check if a runtime config uses worktree semantics.\n * This includes both explicit \"worktree\" type AND legacy \"local\" with srcBaseDir.\n */\nexport function isWorktreeRuntime(\n  config: RuntimeConfig | undefined\n): config is\n  | Extract<RuntimeConfig, { type: \"worktree\" }>\n  | Extract<RuntimeConfig, { type: \"local\"; srcBaseDir: string }> {\n  if (!config) return false;\n  if (config.type === \"worktree\") return true;\n  // Legacy: \"local\" with srcBaseDir is treated as worktree\n  if (config.type === \"local\" && \"srcBaseDir\" in config && config.srcBaseDir) return true;\n  return false;\n}\n\n/**\n * Type guard to check if a runtime config is project-dir local (no isolation)\n */\nexport function isLocalProjectRuntime(\n  config: RuntimeConfig | undefined\n): config is Extract<RuntimeConfig, { type: \"local\"; srcBaseDir?: never }> {\n  if (!config) return false;\n  // \"local\" without srcBaseDir is project-dir runtime\n  return config.type === \"local\" && !(\"srcBaseDir\" in config && config.srcBaseDir);\n}\n\n/**\n * Type guard to check if a runtime config has srcBaseDir (worktree-style runtimes).\n * This narrows the type to allow safe access to srcBaseDir.\n */\nexport function hasSrcBaseDir(\n  config: RuntimeConfig | undefined\n): config is Extract<RuntimeConfig, { srcBaseDir: string }> {\n  if (!config) return false;\n  return \"srcBaseDir\" in config && typeof config.srcBaseDir === \"string\";\n}\n\n/**\n * Helper to safely get srcBaseDir from a runtime config.\n * Returns undefined for project-dir local configs.\n */\nexport function getSrcBaseDir(config: RuntimeConfig | undefined): string | undefined {\n  if (!config) return undefined;\n  if (hasSrcBaseDir(config)) return config.srcBaseDir;\n  return undefined;\n}\n\n/** Devcontainer config info for availability selection */\nexport interface DevcontainerConfigInfo {\n  path: string;\n  label: string;\n}\n\n/**\n * Runtime availability status - discriminated union that can carry mode-specific data.\n * Most runtimes use the simple available/unavailable shape; devcontainer carries extra\n * config info when available.\n */\nexport type RuntimeAvailabilityStatus =\n  | { available: true }\n  | { available: true; configs: DevcontainerConfigInfo[]; cliVersion?: string }\n  | { available: false; reason: string };\n\n/**\n * Helper to extract devcontainer configs from availability status.\n * Returns empty array if not a devcontainer availability or not available.\n */\nexport function getDevcontainerConfigs(\n  status: RuntimeAvailabilityStatus\n): DevcontainerConfigInfo[] {\n  if (status.available && \"configs\" in status) {\n    return status.configs;\n  }\n  return [];\n}\n"]}