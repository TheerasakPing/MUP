{"version":3,"file":"review.js","sourceRoot":"","sources":["../../../src/common/types/review.ts"],"names":[],"mappings":";AAAA;;GAEG;;;;AA8LH,SAAS,gBAAgB,CAAC,SAAiB,EAAgC;IACzE,MAAM,KAAK,GAAG,oBAAoB,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,CAAC;IAC1D,IAAI,CAAC,KAAK;QAAE,OAAO,IAAI,CAAC;IAExB,MAAM,QAAQ,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;IAClC,MAAM,MAAM,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;IACtD,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;QAAE,OAAO,IAAI,CAAC;IAExE,OAAO;QACL,KAAK,EAAE,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC;QACjC,GAAG,EAAE,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC;KAChC,CAAC;AAAA,CACH;AAED;;;;;;GAMG;AACH,8BAAqC,SAAiB,EAAgC;IACpF,MAAM,MAAM,GAAG,SAAS,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;IAC7D,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,IAAI,CAAC;IAErC,IAAI,QAA2C,CAAC;IAChD,IAAI,QAA2C,CAAC;IAEhD,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;QAC3B,IAAI,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC9C,MAAM,MAAM,GAAG,gBAAgB,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;YAChD,IAAI,MAAM;gBAAE,QAAQ,GAAG,MAAM,CAAC;YAC9B,SAAS;QACX,CAAC;QAED,IAAI,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC9C,MAAM,MAAM,GAAG,gBAAgB,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;YAChD,IAAI,MAAM;gBAAE,QAAQ,GAAG,MAAM,CAAC;YAC9B,SAAS;QACX,CAAC;QAED,sFAAsF;QACtF,MAAM,WAAW,GAAG,gBAAgB,CAAC,KAAK,CAAC,CAAC;QAC5C,IAAI,WAAW,EAAE,CAAC;YAChB,QAAQ,KAAR,QAAQ,GAAK,WAAW,EAAC;YACzB,QAAQ,KAAR,QAAQ,GAAK,WAAW,EAAC;QAC3B,CAAC;IACH,CAAC;IAED,IAAI,CAAC,QAAQ,IAAI,CAAC,QAAQ;QAAE,OAAO,IAAI,CAAC;IAExC,OAAO;QACL,GAAG,EAAE,QAAQ;QACb,GAAG,EAAE,QAAQ;KACd,CAAC;AAAA,CACH;AACD;;;GAGG;AACH,8BAAqC,IAAoB,EAAU;IACjE,OAAO,gBAAgB,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,SAAS,aAAa,IAAI,CAAC,YAAY,eAAe,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,aAAa,CAAC;AAAA,CACtI","sourcesContent":["/**\n * Types for code review system\n */\n\n/**\n * Type of change for a file in a diff\n */\nexport type FileChangeType = \"added\" | \"deleted\" | \"modified\" | \"renamed\";\n\n/**\n * Individual hunk within a file diff\n */\nexport interface DiffHunk {\n  /** Unique identifier for this hunk (hash of file path + line ranges) */\n  id: string;\n  /** Path to the file relative to workspace root */\n  filePath: string;\n  /** Starting line number in old file */\n  oldStart: number;\n  /** Number of lines in old file */\n  oldLines: number;\n  /** Starting line number in new file */\n  newStart: number;\n  /** Number of lines in new file */\n  newLines: number;\n  /** Diff content (lines starting with +/-/space) */\n  content: string;\n  /** Hunk header line (e.g., \"@@ -1,5 +1,6 @@\") */\n  header: string;\n  /** Change type from parent file */\n  changeType?: FileChangeType;\n  /** Old file path (if renamed) */\n  oldPath?: string;\n}\n\n/**\n * Parsed file diff containing multiple hunks\n */\nexport interface FileDiff {\n  /** Path to the file relative to workspace root */\n  filePath: string;\n  /** Old file path (different if renamed) */\n  oldPath?: string;\n  /** Type of change */\n  changeType: FileChangeType;\n  /** Whether this is a binary file */\n  isBinary: boolean;\n  /** Hunks in this file */\n  hunks: DiffHunk[];\n}\n\n/**\n * Read state for a single hunk\n */\nexport interface HunkReadState {\n  /** ID of the hunk */\n  hunkId: string;\n  /** Whether this hunk has been marked as read */\n  isRead: boolean;\n  /** Timestamp when read state was last updated */\n  timestamp: number;\n}\n\n/**\n * Workspace review state (persisted to localStorage)\n */\nexport interface ReviewState {\n  /** Workspace ID this review belongs to */\n  workspaceId: string;\n  /** Read state keyed by hunk ID */\n  readState: Record<string, HunkReadState>;\n  /** Timestamp of last update */\n  lastUpdated: number;\n}\n\n/**\n * Sort order options for review panel hunks\n */\nexport type ReviewSortOrder = \"file-order\" | \"last-edit\";\n\n/**\n * Filter options for review panel\n */\nexport interface ReviewFilters {\n  /** Whether to show hunks marked as read */\n  showReadHunks: boolean;\n  /** File path filter (regex or glob pattern) */\n  filePathFilter?: string;\n  /** Base reference to diff against (e.g., \"HEAD\", \"main\", \"origin/main\") */\n  diffBase: string;\n  /** Whether to include uncommitted changes (staged + unstaged) in the diff */\n  includeUncommitted: boolean;\n  /** Sort order for hunks */\n  sortOrder: ReviewSortOrder;\n}\n\n/**\n * Review statistics\n */\nexport interface ReviewStats {\n  /** Total number of hunks */\n  total: number;\n  /** Number of hunks marked as read */\n  read: number;\n  /** Number of unread hunks */\n  unread: number;\n}\n\n/**\n * Status of a review\n * - pending: In banner, not attached to chat input\n * - attached: Currently attached to chat input draft\n * - checked: Marked as done (after being sent)\n */\nexport type ReviewStatus = \"pending\" | \"attached\" | \"checked\";\n\n/**\n * Structured data for a review note.\n * Passed from DiffRenderer when user creates a review.\n * Stored as-is for rich UI display, formatted to message only when sending to chat.\n */\nexport interface ReviewNoteData {\n  /** File path being reviewed */\n  filePath: string;\n  /** Line range (e.g., \"-10-12 +14-16\", \"-10\", \"+14\", or legacy \"42-45\") */\n  lineRange: string;\n\n  /**\n   * Human-readable selected code included in the message payload.\n   * Historically this included embedded line numbers; keep for backwards compatibility.\n   */\n  selectedCode: string;\n\n  /**\n   * Raw diff snippet for UI rendering (lines start with + / - / space).\n   * When present, the UI should prefer this for consistent syntax highlighting.\n   */\n  selectedDiff?: string;\n\n  /** Starting old line number for rendering selectedDiff (if present). */\n  oldStart?: number;\n  /** Starting new line number for rendering selectedDiff (if present). */\n  newStart?: number;\n\n  /** User's review comment */\n  userNote: string;\n}\n\n/**\n * A single review note\n * Created when user adds a review note from the diff viewer\n */\nexport interface Review {\n  /** Unique identifier */\n  id: string;\n  /** Structured review data for rich UI display */\n  data: ReviewNoteData;\n  /** Current status */\n  status: ReviewStatus;\n  /** Timestamp when created */\n  createdAt: number;\n  /** Timestamp when status changed (checked/unchecked) */\n  statusChangedAt?: number;\n}\n\n/**\n * Persisted state for reviews (per workspace)\n * Contains reviews in all states: pending, attached, and checked\n */\nexport interface ReviewsState {\n  /** Workspace ID */\n  workspaceId: string;\n  /** All reviews keyed by ID */\n  reviews: Record<string, Review>;\n  /** Last update timestamp */\n  lastUpdated: number;\n}\n\n/**\n * Helpers for parsing ReviewNoteData.lineRange.\n */\n\nexport interface ReviewLineNumberRange {\n  start: number;\n  end: number;\n}\n\nexport interface ParsedReviewLineRange {\n  old?: ReviewLineNumberRange;\n  new?: ReviewLineNumberRange;\n}\n\nfunction parseNumberRange(rangeText: string): ReviewLineNumberRange | null {\n  const match = /^(\\d+)(?:-(\\d+))?$/.exec(rangeText.trim());\n  if (!match) return null;\n\n  const startNum = Number(match[1]);\n  const endNum = match[2] ? Number(match[2]) : startNum;\n  if (!Number.isFinite(startNum) || !Number.isFinite(endNum)) return null;\n\n  return {\n    start: Math.min(startNum, endNum),\n    end: Math.max(startNum, endNum),\n  };\n}\n\n/**\n * Parse a ReviewNoteData.lineRange string into numeric old/new ranges.\n *\n * Supports:\n * - Current format: \"-10-12 +14-16\", \"-10 +14\", \"-10\", \"+14-16\"\n * - Legacy format: \"42\" or \"42-45\" (treated as both old and new)\n */\nexport function parseReviewLineRange(lineRange: string): ParsedReviewLineRange | null {\n  const tokens = lineRange.trim().split(/\\s+/).filter(Boolean);\n  if (tokens.length === 0) return null;\n\n  let oldRange: ReviewLineNumberRange | undefined;\n  let newRange: ReviewLineNumberRange | undefined;\n\n  for (const token of tokens) {\n    if (token.startsWith(\"-\") && token.length > 1) {\n      const parsed = parseNumberRange(token.slice(1));\n      if (parsed) oldRange = parsed;\n      continue;\n    }\n\n    if (token.startsWith(\"+\") && token.length > 1) {\n      const parsed = parseNumberRange(token.slice(1));\n      if (parsed) newRange = parsed;\n      continue;\n    }\n\n    // Legacy: range without +/- prefix. Treat as matching either old or new line numbers.\n    const legacyRange = parseNumberRange(token);\n    if (legacyRange) {\n      oldRange ??= legacyRange;\n      newRange ??= legacyRange;\n    }\n  }\n\n  if (!oldRange && !newRange) return null;\n\n  return {\n    old: oldRange,\n    new: newRange,\n  };\n}\n/**\n * Format a ReviewNoteData into the message format for the model.\n * Used when preparing reviews for sending to chat.\n */\nexport function formatReviewForModel(data: ReviewNoteData): string {\n  return `<review>\\nRe ${data.filePath}:${data.lineRange}\\n\\`\\`\\`\\n${data.selectedCode}\\n\\`\\`\\`\\n> ${data.userNote.trim()}\\n</review>`;\n}\n"]}