{"version":3,"file":"message.test.js","sourceRoot":"","sources":["../../../src/common/types/message.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\r\nimport { buildContinueMessage, rebuildContinueMessage } from \"./message\";\r\nimport type { ReviewNoteData } from \"./review\";\r\n\r\n// Helper to create valid ReviewNoteData for tests\r\nconst makeReview = (filePath: string): ReviewNoteData => ({\r\n  filePath,\r\n  lineRange: \"1-10\",\r\n  selectedCode: \"const x = 1;\",\r\n  userNote: \"fix this\",\r\n});\r\n\r\ndescribe(\"buildContinueMessage\", () => {\r\n  test(\"returns undefined when no content provided\", () => {\r\n    const result = buildContinueMessage({\r\n      model: \"test-model\",\r\n      agentId: \"exec\",\r\n    });\r\n    expect(result).toBeUndefined();\r\n  });\r\n\r\n  test(\"returns undefined when text is empty string\", () => {\r\n    const result = buildContinueMessage({\r\n      text: \"\",\r\n      model: \"test-model\",\r\n      agentId: \"exec\",\r\n    });\r\n    expect(result).toBeUndefined();\r\n  });\r\n\r\n  test(\"returns message when text is provided\", () => {\r\n    const result = buildContinueMessage({\r\n      text: \"hello\",\r\n      model: \"test-model\",\r\n      agentId: \"exec\",\r\n    });\r\n    // Check individual fields instead of toEqual (branded type can't be matched with plain object)\r\n    expect(result?.text).toBe(\"hello\");\r\n    expect(result?.model).toBe(\"test-model\");\r\n    expect(result?.agentId).toBe(\"exec\");\r\n    expect(result?.fileParts).toBeUndefined();\r\n    expect(result?.reviews).toBeUndefined();\r\n  });\r\n\r\n  test(\"returns message when only images provided\", () => {\r\n    const result = buildContinueMessage({\r\n      fileParts: [{ url: \"data:image/png;base64,abc\", mediaType: \"image/png\" }],\r\n      model: \"test-model\",\r\n      agentId: \"plan\",\r\n    });\r\n    expect(result?.fileParts?.length).toBe(1);\r\n    expect(result?.text).toBe(\"\");\r\n    expect(result?.agentId).toBe(\"plan\");\r\n  });\r\n\r\n  test(\"preserves muxMetadata when provided\", () => {\r\n    const muxMetadata = {\r\n      type: \"agent-skill\",\r\n      rawCommand: \"/test-skill hello\",\r\n      skillName: \"test-skill\",\r\n      scope: \"project\",\r\n    } as const;\r\n\r\n    const result = buildContinueMessage({\r\n      text: \"hello\",\r\n      muxMetadata,\r\n      model: \"test-model\",\r\n      agentId: \"exec\",\r\n    });\r\n\r\n    expect(result?.muxMetadata).toEqual(muxMetadata);\r\n  });\r\n  test(\"returns message when only reviews provided\", () => {\r\n    const result = buildContinueMessage({\r\n      reviews: [makeReview(\"a.ts\")],\r\n      model: \"test-model\",\r\n      agentId: \"exec\",\r\n    });\r\n    expect(result?.reviews?.length).toBe(1);\r\n    expect(result?.text).toBe(\"\");\r\n  });\r\n});\r\n\r\ndescribe(\"rebuildContinueMessage\", () => {\r\n  test(\"returns undefined when persisted is undefined\", () => {\r\n    const result = rebuildContinueMessage(undefined, { model: \"default\", agentId: \"exec\" });\r\n    expect(result).toBeUndefined();\r\n  });\r\n\r\n  test(\"returns undefined when persisted has no content\", () => {\r\n    const result = rebuildContinueMessage({}, { model: \"default\", agentId: \"exec\" });\r\n    expect(result).toBeUndefined();\r\n  });\r\n\r\n  test(\"uses persisted values when available\", () => {\r\n    const result = rebuildContinueMessage(\r\n      { text: \"continue\", model: \"persisted-model\", agentId: \"plan\" },\r\n      { model: \"default\", agentId: \"exec\" }\r\n    );\r\n    expect(result?.text).toBe(\"continue\");\r\n    expect(result?.model).toBe(\"persisted-model\");\r\n    expect(result?.agentId).toBe(\"plan\");\r\n  });\r\n\r\n  test(\"migrates legacy mode to agentId\", () => {\r\n    const result = rebuildContinueMessage(\r\n      { text: \"continue\", mode: \"plan\" },\r\n      { model: \"default-model\", agentId: \"exec\" }\r\n    );\r\n    expect(result?.agentId).toBe(\"plan\");\r\n  });\r\n\r\n  test(\"prefers persisted agentId over legacy mode\", () => {\r\n    const result = rebuildContinueMessage(\r\n      { text: \"continue\", agentId: \"custom-agent\", mode: \"plan\" },\r\n      { model: \"default-model\", agentId: \"exec\" }\r\n    );\r\n    expect(result?.agentId).toBe(\"custom-agent\");\r\n  });\r\n  test(\"uses defaults when persisted values missing\", () => {\r\n    const result = rebuildContinueMessage(\r\n      { text: \"continue\" },\r\n      { model: \"default-model\", agentId: \"plan\" }\r\n    );\r\n    expect(result?.text).toBe(\"continue\");\r\n    expect(result?.model).toBe(\"default-model\");\r\n    expect(result?.agentId).toBe(\"plan\");\r\n  });\r\n\r\n  test(\"preserves muxMetadata from persisted data\", () => {\r\n    const muxMetadata = {\r\n      type: \"agent-skill\",\r\n      rawCommand: \"/test-skill hello\",\r\n      skillName: \"test-skill\",\r\n      scope: \"project\",\r\n    } as const;\r\n\r\n    const result = rebuildContinueMessage(\r\n      { text: \"continue\", muxMetadata },\r\n      { model: \"m\", agentId: \"exec\" }\r\n    );\r\n\r\n    expect(result?.muxMetadata).toEqual(muxMetadata);\r\n  });\r\n  test(\"preserves reviews from persisted data\", () => {\r\n    const review = makeReview(\"a.ts\");\r\n    const result = rebuildContinueMessage(\r\n      { text: \"review this\", reviews: [review] },\r\n      { model: \"m\", agentId: \"exec\" }\r\n    );\r\n    expect(result?.reviews?.length).toBe(1);\r\n    expect(result?.reviews?.[0].filePath).toBe(\"a.ts\");\r\n  });\r\n\r\n  test(\"preserves fileParts from persisted data\", () => {\r\n    const result = rebuildContinueMessage(\r\n      {\r\n        text: \"with image\",\r\n        fileParts: [{ url: \"data:image/png;base64,xyz\", mediaType: \"image/png\" }],\r\n      },\r\n      { model: \"m\", agentId: \"exec\" }\r\n    );\r\n    expect(result?.fileParts?.length).toBe(1);\r\n  });\r\n});\r\n"]}