{"version":3,"file":"cacheStrategy.test.js","sourceRoot":"","sources":["../../../../src/common/utils/ai/cacheStrategy.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\nimport { openai } from \"@ai-sdk/openai\";\nimport type { ModelMessage, Tool } from \"ai\";\nimport { tool } from \"ai\";\nimport { z } from \"zod\";\nimport {\n  supportsAnthropicCache,\n  applyCacheControl,\n  createCachedSystemMessage,\n  applyCacheControlToTools,\n} from \"./cacheStrategy\";\n\ndescribe(\"cacheStrategy\", () => {\n  describe(\"supportsAnthropicCache\", () => {\n    it(\"should return true for direct Anthropic models\", () => {\n      expect(supportsAnthropicCache(\"anthropic:claude-3-5-sonnet-20241022\")).toBe(true);\n      expect(supportsAnthropicCache(\"anthropic:claude-3-5-haiku-20241022\")).toBe(true);\n    });\n\n    it(\"should return true for gateway providers routing to Anthropic\", () => {\n      expect(supportsAnthropicCache(\"mux-gateway:anthropic/claude-opus-4-5\")).toBe(true);\n      expect(supportsAnthropicCache(\"mux-gateway:anthropic/claude-sonnet-4-5-20250514\")).toBe(true);\n      expect(supportsAnthropicCache(\"openrouter:anthropic/claude-3.5-sonnet\")).toBe(true);\n    });\n\n    it(\"should return false for non-Anthropic models\", () => {\n      expect(supportsAnthropicCache(\"openai:gpt-4\")).toBe(false);\n      expect(supportsAnthropicCache(\"google:gemini-2.0\")).toBe(false);\n      expect(supportsAnthropicCache(\"openrouter:meta-llama/llama-3.1\")).toBe(false);\n      expect(supportsAnthropicCache(\"mux-gateway:openai/gpt-5.2\")).toBe(false);\n    });\n  });\n\n  describe(\"applyCacheControl\", () => {\n    it(\"should not modify messages for non-Anthropic models\", () => {\n      const messages: ModelMessage[] = [\n        { role: \"user\", content: \"Hello\" },\n        { role: \"assistant\", content: \"Hi there!\" },\n        { role: \"user\", content: \"How are you?\" },\n      ];\n      const result = applyCacheControl(messages, \"openai:gpt-4\");\n      expect(result).toEqual(messages);\n    });\n\n    it(\"should add cache control to single message for Anthropic models\", () => {\n      const messages: ModelMessage[] = [{ role: \"user\", content: \"Hello\" }];\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\n      expect(result[0]).toEqual({\n        ...messages[0],\n        providerOptions: {\n          anthropic: {\n            cacheControl: {\n              type: \"ephemeral\",\n            },\n          },\n        },\n      });\n    });\n\n    it(\"should add cache control to last message for Anthropic models\", () => {\n      const messages: ModelMessage[] = [\n        { role: \"user\", content: \"Hello\" },\n        { role: \"assistant\", content: \"Hi there!\" },\n        { role: \"user\", content: \"How are you?\" },\n      ];\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\n\n      expect(result[0]).toEqual(messages[0]); // First message unchanged\n      expect(result[1]).toEqual(messages[1]); // Second message unchanged\n      expect(result[2]).toEqual({\n        // Last message has cache control\n        ...messages[2],\n        providerOptions: {\n          anthropic: {\n            cacheControl: {\n              type: \"ephemeral\",\n            },\n          },\n        },\n      });\n    });\n\n    it(\"should work with exactly 2 messages\", () => {\n      const messages: ModelMessage[] = [\n        { role: \"user\", content: \"Hello\" },\n        { role: \"assistant\", content: \"Hi there!\" },\n      ];\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\n\n      expect(result[0]).toEqual(messages[0]); // First message unchanged\n      expect(result[1]).toEqual({\n        // Last message gets cache control\n        ...messages[1],\n        providerOptions: {\n          anthropic: {\n            cacheControl: {\n              type: \"ephemeral\",\n            },\n          },\n        },\n      });\n    });\n\n    it(\"should add cache control to last content part for array content\", () => {\n      // Messages with array content (typical for user/assistant with multiple parts)\n      const messages: ModelMessage[] = [\n        {\n          role: \"user\",\n          content: [\n            { type: \"text\", text: \"Hello\" },\n            { type: \"text\", text: \"World\" },\n          ],\n        },\n        {\n          role: \"assistant\",\n          content: [\n            { type: \"text\", text: \"Hi there!\" },\n            { type: \"text\", text: \"How can I help?\" },\n          ],\n        },\n        {\n          role: \"user\",\n          content: [\n            { type: \"text\", text: \"Final\" },\n            { type: \"text\", text: \"question\" },\n          ],\n        },\n      ];\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\n\n      expect(result[0]).toEqual(messages[0]); // First message unchanged\n      expect(result[1]).toEqual(messages[1]); // Second message unchanged\n\n      // Last message (array content): cache control on LAST content part only\n      const lastMsg = result[2];\n      expect(lastMsg.role).toBe(\"user\");\n      expect(Array.isArray(lastMsg.content)).toBe(true);\n      const content = lastMsg.content as Array<{\n        type: string;\n        text: string;\n        providerOptions?: unknown;\n      }>;\n      expect(content[0].providerOptions).toBeUndefined(); // First part unchanged\n      expect(content[1].providerOptions).toEqual({\n        anthropic: { cacheControl: { type: \"ephemeral\" } },\n      }); // Last part has cache control\n    });\n  });\n\n  describe(\"createCachedSystemMessage\", () => {\n    describe(\"integration with streamText parameters\", () => {\n      it(\"should handle empty system message correctly\", () => {\n        // When system message is converted to cached message, the system parameter\n        // should be undefined, not empty string, to avoid Anthropic API error\n        const systemContent = \"You are a helpful assistant\";\n        const cachedMessage = createCachedSystemMessage(\n          systemContent,\n          \"anthropic:claude-3-5-sonnet\"\n        );\n\n        expect(cachedMessage).toBeDefined();\n        expect(cachedMessage?.role).toBe(\"system\");\n        expect(cachedMessage?.content).toBe(systemContent);\n\n        // When using this cached message, system parameter should be set to undefined\n        // Example: system: cachedMessage ? undefined : originalSystem\n      });\n    });\n\n    it(\"should return null for non-Anthropic models\", () => {\n      const result = createCachedSystemMessage(\"You are a helpful assistant\", \"openai:gpt-4\");\n      expect(result).toBeNull();\n    });\n\n    it(\"should return null for empty system content\", () => {\n      const result = createCachedSystemMessage(\"\", \"anthropic:claude-3-5-sonnet\");\n      expect(result).toBeNull();\n    });\n\n    it(\"should create cached system message for Anthropic models\", () => {\n      const systemContent = \"You are a helpful assistant\";\n      const result = createCachedSystemMessage(systemContent, \"anthropic:claude-3-5-sonnet\");\n\n      expect(result).toEqual({\n        role: \"system\",\n        content: systemContent,\n        providerOptions: {\n          anthropic: {\n            cacheControl: {\n              type: \"ephemeral\",\n            },\n          },\n        },\n      });\n    });\n  });\n\n  describe(\"applyCacheControlToTools\", () => {\n    const mockTools: Record<string, Tool> = {\n      readFile: tool({\n        description: \"Read a file\",\n        inputSchema: z.object({\n          path: z.string(),\n        }),\n        execute: () => Promise.resolve({ success: true }),\n      }),\n      writeFile: tool({\n        description: \"Write a file\",\n        inputSchema: z.object({\n          path: z.string(),\n          content: z.string(),\n        }),\n        execute: () => Promise.resolve({ success: true }),\n      }),\n    };\n\n    const expectProviderToolToRemainProviderNative = (cachedTool: Tool, originalTool: Tool) => {\n      const cachedProviderTool = cachedTool as Extract<Tool, { type: \"provider\" }>;\n      const originalProviderTool = originalTool as Extract<Tool, { type: \"provider\" }>;\n\n      expect(cachedProviderTool.type).toBe(\"provider\");\n      expect(cachedProviderTool.id).toBe(originalProviderTool.id);\n      expect(cachedProviderTool.args).toEqual(originalProviderTool.args);\n      expect(cachedProviderTool.providerOptions).toEqual({\n        anthropic: { cacheControl: { type: \"ephemeral\" } },\n      });\n      // Regression guard: if this ever becomes a createTool() result, execute will be defined.\n      expect((cachedProviderTool as { execute?: unknown }).execute).toBeUndefined();\n    };\n    it(\"should not modify tools for non-Anthropic models\", () => {\n      const result = applyCacheControlToTools(mockTools, \"openai:gpt-4\");\n      expect(result).toEqual(mockTools);\n    });\n\n    it(\"should return empty object for empty tools\", () => {\n      const result = applyCacheControlToTools({}, \"anthropic:claude-3-5-sonnet\");\n      expect(result).toEqual({});\n    });\n\n    it(\"should add cache control only to the last tool for Anthropic models\", () => {\n      const result = applyCacheControlToTools(mockTools, \"anthropic:claude-3-5-sonnet\");\n\n      // Get the keys to identify first and last tools\n      const keys = Object.keys(mockTools);\n      const lastKey = keys[keys.length - 1];\n\n      // Check that only the last tool has cache control\n      for (const [key, tool] of Object.entries(result)) {\n        if (key === lastKey) {\n          // Last tool should have cache control\n          expect(tool).toEqual({\n            ...mockTools[key],\n            providerOptions: {\n              anthropic: {\n                cacheControl: {\n                  type: \"ephemeral\",\n                },\n              },\n            },\n          });\n        } else {\n          // Other tools should be unchanged\n          expect(tool).toEqual(mockTools[key]);\n        }\n      }\n\n      // Verify all tools are present\n      expect(Object.keys(result)).toEqual(Object.keys(mockTools));\n    });\n\n    it(\"should not modify original tools object\", () => {\n      const originalTools = { ...mockTools };\n      applyCacheControlToTools(mockTools, \"anthropic:claude-3-5-sonnet\");\n      expect(mockTools).toEqual(originalTools);\n    });\n\n    it(\"should keep Anthropic provider-native tools as provider tools\", () => {\n      const providerTool = anthropic.tools.webSearch_20250305({ maxUses: 1000 }) as unknown as Tool;\n      const toolsWithProviderTool: Record<string, Tool> = {\n        readFile: mockTools.readFile,\n        web_search: providerTool,\n      };\n\n      const result = applyCacheControlToTools(toolsWithProviderTool, \"anthropic:claude-3-5-sonnet\");\n\n      // Verify all tools are present and non-provider tools are unchanged.\n      expect(Object.keys(result)).toEqual(Object.keys(toolsWithProviderTool));\n      expect(result.readFile).toEqual(toolsWithProviderTool.readFile);\n\n      expectProviderToolToRemainProviderNative(result.web_search, providerTool);\n    });\n\n    it(\"should avoid createTool fallback for any provider-native tool\", () => {\n      const providerTool = openai.tools.webSearch({ searchContextSize: \"high\" }) as unknown as Tool;\n      const toolsWithProviderTool: Record<string, Tool> = {\n        readFile: mockTools.readFile,\n        web_search: providerTool,\n      };\n\n      const result = applyCacheControlToTools(toolsWithProviderTool, \"anthropic:claude-3-5-sonnet\");\n\n      expect(Object.keys(result)).toEqual(Object.keys(toolsWithProviderTool));\n      expectProviderToolToRemainProviderNative(result.web_search, providerTool);\n    });\n\n    it(\"should handle execute-less dynamic tools without throwing\", () => {\n      const dynamicToolWithoutExecute = {\n        type: \"dynamic\" as const,\n        description: \"MCP dynamic tool\",\n        inputSchema: z.object({ query: z.string() }),\n      } as unknown as Tool;\n\n      const toolsWithDynamicTool: Record<string, Tool> = {\n        readFile: mockTools.readFile,\n        mcp_dynamic_tool: dynamicToolWithoutExecute,\n      };\n\n      const result = applyCacheControlToTools(toolsWithDynamicTool, \"anthropic:claude-3-5-sonnet\");\n\n      const cachedDynamicTool = result.mcp_dynamic_tool as {\n        type?: string;\n        execute?: unknown;\n        providerOptions?: unknown;\n      };\n      expect(cachedDynamicTool.type).toBe(\"dynamic\");\n      expect(cachedDynamicTool.execute).toBeUndefined();\n      expect(cachedDynamicTool.providerOptions).toEqual({\n        anthropic: { cacheControl: { type: \"ephemeral\" } },\n      });\n      expect(result.readFile).toEqual(toolsWithDynamicTool.readFile);\n    });\n  });\n});\n"]}