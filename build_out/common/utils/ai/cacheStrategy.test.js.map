{"version":3,"file":"cacheStrategy.test.js","sourceRoot":"","sources":["../../../../src/common/utils/ai/cacheStrategy.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport { anthropic } from \"@ai-sdk/anthropic\";\r\nimport { openai } from \"@ai-sdk/openai\";\r\nimport type { ModelMessage, Tool } from \"ai\";\r\nimport { tool } from \"ai\";\r\nimport { z } from \"zod\";\r\nimport {\r\n  supportsAnthropicCache,\r\n  applyCacheControl,\r\n  createCachedSystemMessage,\r\n  applyCacheControlToTools,\r\n} from \"./cacheStrategy\";\r\n\r\ndescribe(\"cacheStrategy\", () => {\r\n  describe(\"supportsAnthropicCache\", () => {\r\n    it(\"should return true for direct Anthropic models\", () => {\r\n      expect(supportsAnthropicCache(\"anthropic:claude-3-5-sonnet-20241022\")).toBe(true);\r\n      expect(supportsAnthropicCache(\"anthropic:claude-3-5-haiku-20241022\")).toBe(true);\r\n    });\r\n\r\n    it(\"should return true for gateway providers routing to Anthropic\", () => {\r\n      expect(supportsAnthropicCache(\"mux-gateway:anthropic/claude-opus-4-5\")).toBe(true);\r\n      expect(supportsAnthropicCache(\"mux-gateway:anthropic/claude-sonnet-4-5-20250514\")).toBe(true);\r\n      expect(supportsAnthropicCache(\"openrouter:anthropic/claude-3.5-sonnet\")).toBe(true);\r\n    });\r\n\r\n    it(\"should return false for non-Anthropic models\", () => {\r\n      expect(supportsAnthropicCache(\"openai:gpt-4\")).toBe(false);\r\n      expect(supportsAnthropicCache(\"google:gemini-2.0\")).toBe(false);\r\n      expect(supportsAnthropicCache(\"openrouter:meta-llama/llama-3.1\")).toBe(false);\r\n      expect(supportsAnthropicCache(\"mux-gateway:openai/gpt-5.2\")).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"applyCacheControl\", () => {\r\n    it(\"should not modify messages for non-Anthropic models\", () => {\r\n      const messages: ModelMessage[] = [\r\n        { role: \"user\", content: \"Hello\" },\r\n        { role: \"assistant\", content: \"Hi there!\" },\r\n        { role: \"user\", content: \"How are you?\" },\r\n      ];\r\n      const result = applyCacheControl(messages, \"openai:gpt-4\");\r\n      expect(result).toEqual(messages);\r\n    });\r\n\r\n    it(\"should add cache control to single message for Anthropic models\", () => {\r\n      const messages: ModelMessage[] = [{ role: \"user\", content: \"Hello\" }];\r\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\r\n      expect(result[0]).toEqual({\r\n        ...messages[0],\r\n        providerOptions: {\r\n          anthropic: {\r\n            cacheControl: {\r\n              type: \"ephemeral\",\r\n            },\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    it(\"should add cache control to last message for Anthropic models\", () => {\r\n      const messages: ModelMessage[] = [\r\n        { role: \"user\", content: \"Hello\" },\r\n        { role: \"assistant\", content: \"Hi there!\" },\r\n        { role: \"user\", content: \"How are you?\" },\r\n      ];\r\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      expect(result[0]).toEqual(messages[0]); // First message unchanged\r\n      expect(result[1]).toEqual(messages[1]); // Second message unchanged\r\n      expect(result[2]).toEqual({\r\n        // Last message has cache control\r\n        ...messages[2],\r\n        providerOptions: {\r\n          anthropic: {\r\n            cacheControl: {\r\n              type: \"ephemeral\",\r\n            },\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    it(\"should work with exactly 2 messages\", () => {\r\n      const messages: ModelMessage[] = [\r\n        { role: \"user\", content: \"Hello\" },\r\n        { role: \"assistant\", content: \"Hi there!\" },\r\n      ];\r\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      expect(result[0]).toEqual(messages[0]); // First message unchanged\r\n      expect(result[1]).toEqual({\r\n        // Last message gets cache control\r\n        ...messages[1],\r\n        providerOptions: {\r\n          anthropic: {\r\n            cacheControl: {\r\n              type: \"ephemeral\",\r\n            },\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    it(\"should add cache control to last content part for array content\", () => {\r\n      // Messages with array content (typical for user/assistant with multiple parts)\r\n      const messages: ModelMessage[] = [\r\n        {\r\n          role: \"user\",\r\n          content: [\r\n            { type: \"text\", text: \"Hello\" },\r\n            { type: \"text\", text: \"World\" },\r\n          ],\r\n        },\r\n        {\r\n          role: \"assistant\",\r\n          content: [\r\n            { type: \"text\", text: \"Hi there!\" },\r\n            { type: \"text\", text: \"How can I help?\" },\r\n          ],\r\n        },\r\n        {\r\n          role: \"user\",\r\n          content: [\r\n            { type: \"text\", text: \"Final\" },\r\n            { type: \"text\", text: \"question\" },\r\n          ],\r\n        },\r\n      ];\r\n      const result = applyCacheControl(messages, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      expect(result[0]).toEqual(messages[0]); // First message unchanged\r\n      expect(result[1]).toEqual(messages[1]); // Second message unchanged\r\n\r\n      // Last message (array content): cache control on LAST content part only\r\n      const lastMsg = result[2];\r\n      expect(lastMsg.role).toBe(\"user\");\r\n      expect(Array.isArray(lastMsg.content)).toBe(true);\r\n      const content = lastMsg.content as Array<{\r\n        type: string;\r\n        text: string;\r\n        providerOptions?: unknown;\r\n      }>;\r\n      expect(content[0].providerOptions).toBeUndefined(); // First part unchanged\r\n      expect(content[1].providerOptions).toEqual({\r\n        anthropic: { cacheControl: { type: \"ephemeral\" } },\r\n      }); // Last part has cache control\r\n    });\r\n  });\r\n\r\n  describe(\"createCachedSystemMessage\", () => {\r\n    describe(\"integration with streamText parameters\", () => {\r\n      it(\"should handle empty system message correctly\", () => {\r\n        // When system message is converted to cached message, the system parameter\r\n        // should be undefined, not empty string, to avoid Anthropic API error\r\n        const systemContent = \"You are a helpful assistant\";\r\n        const cachedMessage = createCachedSystemMessage(\r\n          systemContent,\r\n          \"anthropic:claude-3-5-sonnet\"\r\n        );\r\n\r\n        expect(cachedMessage).toBeDefined();\r\n        expect(cachedMessage?.role).toBe(\"system\");\r\n        expect(cachedMessage?.content).toBe(systemContent);\r\n\r\n        // When using this cached message, system parameter should be set to undefined\r\n        // Example: system: cachedMessage ? undefined : originalSystem\r\n      });\r\n    });\r\n\r\n    it(\"should return null for non-Anthropic models\", () => {\r\n      const result = createCachedSystemMessage(\"You are a helpful assistant\", \"openai:gpt-4\");\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it(\"should return null for empty system content\", () => {\r\n      const result = createCachedSystemMessage(\"\", \"anthropic:claude-3-5-sonnet\");\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it(\"should create cached system message for Anthropic models\", () => {\r\n      const systemContent = \"You are a helpful assistant\";\r\n      const result = createCachedSystemMessage(systemContent, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      expect(result).toEqual({\r\n        role: \"system\",\r\n        content: systemContent,\r\n        providerOptions: {\r\n          anthropic: {\r\n            cacheControl: {\r\n              type: \"ephemeral\",\r\n            },\r\n          },\r\n        },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe(\"applyCacheControlToTools\", () => {\r\n    const mockTools: Record<string, Tool> = {\r\n      readFile: tool({\r\n        description: \"Read a file\",\r\n        inputSchema: z.object({\r\n          path: z.string(),\r\n        }),\r\n        execute: () => Promise.resolve({ success: true }),\r\n      }),\r\n      writeFile: tool({\r\n        description: \"Write a file\",\r\n        inputSchema: z.object({\r\n          path: z.string(),\r\n          content: z.string(),\r\n        }),\r\n        execute: () => Promise.resolve({ success: true }),\r\n      }),\r\n    };\r\n\r\n    const expectProviderToolToRemainProviderNative = (cachedTool: Tool, originalTool: Tool) => {\r\n      const cachedProviderTool = cachedTool as Extract<Tool, { type: \"provider\" }>;\r\n      const originalProviderTool = originalTool as Extract<Tool, { type: \"provider\" }>;\r\n\r\n      expect(cachedProviderTool.type).toBe(\"provider\");\r\n      expect(cachedProviderTool.id).toBe(originalProviderTool.id);\r\n      expect(cachedProviderTool.args).toEqual(originalProviderTool.args);\r\n      expect(cachedProviderTool.providerOptions).toEqual({\r\n        anthropic: { cacheControl: { type: \"ephemeral\" } },\r\n      });\r\n      // Regression guard: if this ever becomes a createTool() result, execute will be defined.\r\n      expect((cachedProviderTool as { execute?: unknown }).execute).toBeUndefined();\r\n    };\r\n    it(\"should not modify tools for non-Anthropic models\", () => {\r\n      const result = applyCacheControlToTools(mockTools, \"openai:gpt-4\");\r\n      expect(result).toEqual(mockTools);\r\n    });\r\n\r\n    it(\"should return empty object for empty tools\", () => {\r\n      const result = applyCacheControlToTools({}, \"anthropic:claude-3-5-sonnet\");\r\n      expect(result).toEqual({});\r\n    });\r\n\r\n    it(\"should add cache control only to the last tool for Anthropic models\", () => {\r\n      const result = applyCacheControlToTools(mockTools, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      // Get the keys to identify first and last tools\r\n      const keys = Object.keys(mockTools);\r\n      const lastKey = keys[keys.length - 1];\r\n\r\n      // Check that only the last tool has cache control\r\n      for (const [key, tool] of Object.entries(result)) {\r\n        if (key === lastKey) {\r\n          // Last tool should have cache control\r\n          expect(tool).toEqual({\r\n            ...mockTools[key],\r\n            providerOptions: {\r\n              anthropic: {\r\n                cacheControl: {\r\n                  type: \"ephemeral\",\r\n                },\r\n              },\r\n            },\r\n          });\r\n        } else {\r\n          // Other tools should be unchanged\r\n          expect(tool).toEqual(mockTools[key]);\r\n        }\r\n      }\r\n\r\n      // Verify all tools are present\r\n      expect(Object.keys(result)).toEqual(Object.keys(mockTools));\r\n    });\r\n\r\n    it(\"should not modify original tools object\", () => {\r\n      const originalTools = { ...mockTools };\r\n      applyCacheControlToTools(mockTools, \"anthropic:claude-3-5-sonnet\");\r\n      expect(mockTools).toEqual(originalTools);\r\n    });\r\n\r\n    it(\"should keep Anthropic provider-native tools as provider tools\", () => {\r\n      const providerTool = anthropic.tools.webSearch_20250305({ maxUses: 1000 }) as unknown as Tool;\r\n      const toolsWithProviderTool: Record<string, Tool> = {\r\n        readFile: mockTools.readFile,\r\n        web_search: providerTool,\r\n      };\r\n\r\n      const result = applyCacheControlToTools(toolsWithProviderTool, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      // Verify all tools are present and non-provider tools are unchanged.\r\n      expect(Object.keys(result)).toEqual(Object.keys(toolsWithProviderTool));\r\n      expect(result.readFile).toEqual(toolsWithProviderTool.readFile);\r\n\r\n      expectProviderToolToRemainProviderNative(result.web_search, providerTool);\r\n    });\r\n\r\n    it(\"should avoid createTool fallback for any provider-native tool\", () => {\r\n      const providerTool = openai.tools.webSearch({ searchContextSize: \"high\" }) as unknown as Tool;\r\n      const toolsWithProviderTool: Record<string, Tool> = {\r\n        readFile: mockTools.readFile,\r\n        web_search: providerTool,\r\n      };\r\n\r\n      const result = applyCacheControlToTools(toolsWithProviderTool, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      expect(Object.keys(result)).toEqual(Object.keys(toolsWithProviderTool));\r\n      expectProviderToolToRemainProviderNative(result.web_search, providerTool);\r\n    });\r\n\r\n    it(\"should handle execute-less dynamic tools without throwing\", () => {\r\n      const dynamicToolWithoutExecute = {\r\n        type: \"dynamic\" as const,\r\n        description: \"MCP dynamic tool\",\r\n        inputSchema: z.object({ query: z.string() }),\r\n      } as unknown as Tool;\r\n\r\n      const toolsWithDynamicTool: Record<string, Tool> = {\r\n        readFile: mockTools.readFile,\r\n        mcp_dynamic_tool: dynamicToolWithoutExecute,\r\n      };\r\n\r\n      const result = applyCacheControlToTools(toolsWithDynamicTool, \"anthropic:claude-3-5-sonnet\");\r\n\r\n      const cachedDynamicTool = result.mcp_dynamic_tool as {\r\n        type?: string;\r\n        execute?: unknown;\r\n        providerOptions?: unknown;\r\n      };\r\n      expect(cachedDynamicTool.type).toBe(\"dynamic\");\r\n      expect(cachedDynamicTool.execute).toBeUndefined();\r\n      expect(cachedDynamicTool.providerOptions).toEqual({\r\n        anthropic: { cacheControl: { type: \"ephemeral\" } },\r\n      });\r\n      expect(result.readFile).toEqual(toolsWithDynamicTool.readFile);\r\n    });\r\n  });\r\n});\r\n"]}