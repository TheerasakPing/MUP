{"version":3,"file":"providerOptions.test.js","sourceRoot":"","sources":["../../../../src/common/utils/ai/providerOptions.test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Tests for provider options builder\n */\n\nimport type { OpenAIResponsesProviderOptions } from \"@ai-sdk/openai\";\nimport { createMuxMessage } from \"@/common/types/message\";\nimport { describe, test, expect, mock } from \"bun:test\";\nimport { buildProviderOptions } from \"./providerOptions\";\n\n// Mock the log module to avoid console noise\nvoid mock.module(\"@/node/services/log\", () => ({\n  log: {\n    debug: (): void => undefined,\n    info: (): void => undefined,\n    warn: (): void => undefined,\n    error: (): void => undefined,\n  },\n}));\n\ndescribe(\"buildProviderOptions - Anthropic\", () => {\n  describe(\"Opus 4.5 (effort parameter)\", () => {\n    test(\"should use effort and thinking parameters for claude-opus-4-5\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-5\", \"medium\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n          thinking: {\n            type: \"enabled\",\n            budgetTokens: 10000, // ANTHROPIC_THINKING_BUDGETS.medium\n          },\n          effort: \"medium\",\n        },\n      });\n    });\n\n    test(\"should use effort and thinking parameters for claude-opus-4-5-20251101\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-5-20251101\", \"high\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n          thinking: {\n            type: \"enabled\",\n            budgetTokens: 20000, // ANTHROPIC_THINKING_BUDGETS.high\n          },\n          effort: \"high\",\n        },\n      });\n    });\n\n    test(\"should use effort 'low' with no thinking when off for Opus 4.5\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-5\", \"off\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n          effort: \"low\", // \"off\" maps to effort: \"low\" for efficiency\n        },\n      });\n    });\n  });\n\n  describe(\"Opus 4.6 (adaptive thinking + effort)\", () => {\n    test(\"should use adaptive thinking and effort for claude-opus-4-6\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-6\", \"medium\");\n      // SDK types don't include \"adaptive\" or \"max\" yet; verify runtime values\n      const anthropic = (result as Record<string, unknown>).anthropic as Record<string, unknown>;\n\n      expect(anthropic.disableParallelToolUse).toBe(false);\n      expect(anthropic.sendReasoning).toBe(true);\n      expect(anthropic.thinking).toEqual({ type: \"adaptive\" });\n      expect(anthropic.effort).toBe(\"medium\");\n    });\n\n    test(\"should map xhigh to max effort for Opus 4.6\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-6\", \"xhigh\");\n      const anthropic = (result as Record<string, unknown>).anthropic as Record<string, unknown>;\n\n      expect(anthropic.thinking).toEqual({ type: \"adaptive\" });\n      expect(anthropic.effort).toBe(\"max\");\n    });\n\n    test(\"should use disabled thinking when off for Opus 4.6\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-6\", \"off\");\n      const anthropic = (result as Record<string, unknown>).anthropic as Record<string, unknown>;\n\n      expect(anthropic.thinking).toEqual({ type: \"disabled\" });\n      expect(anthropic.effort).toBe(\"low\");\n    });\n  });\n\n  describe(\"Other Anthropic models (thinking/budgetTokens)\", () => {\n    test(\"should use thinking.budgetTokens for claude-sonnet-4-5\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-sonnet-4-5\", \"medium\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n          thinking: {\n            type: \"enabled\",\n            budgetTokens: 10000,\n          },\n        },\n      });\n    });\n\n    test(\"should use thinking.budgetTokens for claude-opus-4-1\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-1\", \"high\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n          thinking: {\n            type: \"enabled\",\n            budgetTokens: 20000,\n          },\n        },\n      });\n    });\n\n    test(\"should use thinking.budgetTokens for claude-haiku-4-5\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-haiku-4-5\", \"low\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n          thinking: {\n            type: \"enabled\",\n            budgetTokens: 4000,\n          },\n        },\n      });\n    });\n\n    test(\"should omit thinking when thinking is off for non-Opus 4.5\", () => {\n      const result = buildProviderOptions(\"anthropic:claude-sonnet-4-5\", \"off\");\n\n      expect(result).toEqual({\n        anthropic: {\n          disableParallelToolUse: false,\n          sendReasoning: true,\n        },\n      });\n    });\n  });\n});\n\ndescribe(\"buildProviderOptions - OpenAI\", () => {\n  // Helper to extract OpenAI options from the result\n  const getOpenAIOptions = (\n    result: ReturnType<typeof buildProviderOptions>\n  ): OpenAIResponsesProviderOptions | undefined => {\n    if (\"openai\" in result) {\n      return result.openai;\n    }\n    return undefined;\n  };\n\n  describe(\"promptCacheKey derivation\", () => {\n    test(\"should derive promptCacheKey from workspaceId when provided\", () => {\n      const result = buildProviderOptions(\n        \"openai:gpt-5.2\",\n        \"off\",\n        undefined,\n        undefined,\n        undefined,\n        \"abc123\"\n      );\n      const openai = getOpenAIOptions(result);\n\n      expect(openai).toBeDefined();\n      expect(openai!.promptCacheKey).toBe(\"mux-v1-abc123\");\n      expect(openai!.truncation).toBe(\"disabled\");\n    });\n\n    test(\"should allow auto truncation when explicitly enabled\", () => {\n      const result = buildProviderOptions(\n        \"openai:gpt-5.2\",\n        \"off\",\n        undefined,\n        undefined,\n        undefined,\n        \"compaction-workspace\",\n        \"auto\"\n      );\n      const openai = getOpenAIOptions(result);\n\n      expect(openai).toBeDefined();\n      expect(openai!.truncation).toBe(\"auto\");\n    });\n    test(\"should derive promptCacheKey for gateway OpenAI model\", () => {\n      const result = buildProviderOptions(\n        \"mux-gateway:openai/gpt-5.2\",\n        \"off\",\n        undefined,\n        undefined,\n        undefined,\n        \"workspace-xyz\"\n      );\n      const openai = getOpenAIOptions(result);\n\n      expect(openai).toBeDefined();\n      expect(openai!.promptCacheKey).toBe(\"mux-v1-workspace-xyz\");\n      expect(openai!.truncation).toBe(\"disabled\");\n    });\n  });\n\n  describe(\"previousResponseId reuse\", () => {\n    test(\"should reuse previousResponseId for gateway OpenAI history\", () => {\n      const messages = [\n        createMuxMessage(\"assistant-1\", \"assistant\", \"\", {\n          model: \"mux-gateway:openai/gpt-5.2\",\n          providerMetadata: { openai: { responseId: \"resp_123\" } },\n        }),\n      ];\n      const result = buildProviderOptions(\"mux-gateway:openai/gpt-5.2\", \"medium\", messages);\n      const openai = getOpenAIOptions(result);\n\n      expect(openai).toBeDefined();\n      expect(openai!.previousResponseId).toBe(\"resp_123\");\n    });\n  });\n});\n"]}