{"version":3,"file":"providerOptions.test.js","sourceRoot":"","sources":["../../../../src/common/utils/ai/providerOptions.test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Tests for provider options builder\r\n */\r\n\r\nimport type { OpenAIResponsesProviderOptions } from \"@ai-sdk/openai\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\nimport { describe, test, expect, mock } from \"bun:test\";\r\nimport { buildProviderOptions } from \"./providerOptions\";\r\n\r\n// Mock the log module to avoid console noise\r\nvoid mock.module(\"@/node/services/log\", () => ({\r\n  log: {\r\n    debug: (): void => undefined,\r\n    info: (): void => undefined,\r\n    warn: (): void => undefined,\r\n    error: (): void => undefined,\r\n  },\r\n}));\r\n\r\ndescribe(\"buildProviderOptions - Anthropic\", () => {\r\n  describe(\"Opus 4.5 (effort parameter)\", () => {\r\n    test(\"should use effort and thinking parameters for claude-opus-4-5\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-5\", \"medium\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n          thinking: {\r\n            type: \"enabled\",\r\n            budgetTokens: 10000, // ANTHROPIC_THINKING_BUDGETS.medium\r\n          },\r\n          effort: \"medium\",\r\n        },\r\n      });\r\n    });\r\n\r\n    test(\"should use effort and thinking parameters for claude-opus-4-5-20251101\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-5-20251101\", \"high\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n          thinking: {\r\n            type: \"enabled\",\r\n            budgetTokens: 20000, // ANTHROPIC_THINKING_BUDGETS.high\r\n          },\r\n          effort: \"high\",\r\n        },\r\n      });\r\n    });\r\n\r\n    test(\"should use effort 'low' with no thinking when off for Opus 4.5\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-5\", \"off\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n          effort: \"low\", // \"off\" maps to effort: \"low\" for efficiency\r\n        },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe(\"Opus 4.6 (adaptive thinking + effort)\", () => {\r\n    test(\"should use adaptive thinking and effort for claude-opus-4-6\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-6\", \"medium\");\r\n      // SDK types don't include \"adaptive\" or \"max\" yet; verify runtime values\r\n      const anthropic = (result as Record<string, unknown>).anthropic as Record<string, unknown>;\r\n\r\n      expect(anthropic.disableParallelToolUse).toBe(false);\r\n      expect(anthropic.sendReasoning).toBe(true);\r\n      expect(anthropic.thinking).toEqual({ type: \"adaptive\" });\r\n      expect(anthropic.effort).toBe(\"medium\");\r\n    });\r\n\r\n    test(\"should map xhigh to max effort for Opus 4.6\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-6\", \"xhigh\");\r\n      const anthropic = (result as Record<string, unknown>).anthropic as Record<string, unknown>;\r\n\r\n      expect(anthropic.thinking).toEqual({ type: \"adaptive\" });\r\n      expect(anthropic.effort).toBe(\"max\");\r\n    });\r\n\r\n    test(\"should use disabled thinking when off for Opus 4.6\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-6\", \"off\");\r\n      const anthropic = (result as Record<string, unknown>).anthropic as Record<string, unknown>;\r\n\r\n      expect(anthropic.thinking).toEqual({ type: \"disabled\" });\r\n      expect(anthropic.effort).toBe(\"low\");\r\n    });\r\n  });\r\n\r\n  describe(\"Other Anthropic models (thinking/budgetTokens)\", () => {\r\n    test(\"should use thinking.budgetTokens for claude-sonnet-4-5\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-sonnet-4-5\", \"medium\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n          thinking: {\r\n            type: \"enabled\",\r\n            budgetTokens: 10000,\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    test(\"should use thinking.budgetTokens for claude-opus-4-1\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-opus-4-1\", \"high\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n          thinking: {\r\n            type: \"enabled\",\r\n            budgetTokens: 20000,\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    test(\"should use thinking.budgetTokens for claude-haiku-4-5\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-haiku-4-5\", \"low\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n          thinking: {\r\n            type: \"enabled\",\r\n            budgetTokens: 4000,\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    test(\"should omit thinking when thinking is off for non-Opus 4.5\", () => {\r\n      const result = buildProviderOptions(\"anthropic:claude-sonnet-4-5\", \"off\");\r\n\r\n      expect(result).toEqual({\r\n        anthropic: {\r\n          disableParallelToolUse: false,\r\n          sendReasoning: true,\r\n        },\r\n      });\r\n    });\r\n  });\r\n});\r\n\r\ndescribe(\"buildProviderOptions - OpenAI\", () => {\r\n  // Helper to extract OpenAI options from the result\r\n  const getOpenAIOptions = (\r\n    result: ReturnType<typeof buildProviderOptions>\r\n  ): OpenAIResponsesProviderOptions | undefined => {\r\n    if (\"openai\" in result) {\r\n      return result.openai;\r\n    }\r\n    return undefined;\r\n  };\r\n\r\n  describe(\"promptCacheKey derivation\", () => {\r\n    test(\"should derive promptCacheKey from workspaceId when provided\", () => {\r\n      const result = buildProviderOptions(\r\n        \"openai:gpt-5.2\",\r\n        \"off\",\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        \"abc123\"\r\n      );\r\n      const openai = getOpenAIOptions(result);\r\n\r\n      expect(openai).toBeDefined();\r\n      expect(openai!.promptCacheKey).toBe(\"mux-v1-abc123\");\r\n      expect(openai!.truncation).toBe(\"disabled\");\r\n    });\r\n\r\n    test(\"should allow auto truncation when explicitly enabled\", () => {\r\n      const result = buildProviderOptions(\r\n        \"openai:gpt-5.2\",\r\n        \"off\",\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        \"compaction-workspace\",\r\n        \"auto\"\r\n      );\r\n      const openai = getOpenAIOptions(result);\r\n\r\n      expect(openai).toBeDefined();\r\n      expect(openai!.truncation).toBe(\"auto\");\r\n    });\r\n    test(\"should derive promptCacheKey for gateway OpenAI model\", () => {\r\n      const result = buildProviderOptions(\r\n        \"mux-gateway:openai/gpt-5.2\",\r\n        \"off\",\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        \"workspace-xyz\"\r\n      );\r\n      const openai = getOpenAIOptions(result);\r\n\r\n      expect(openai).toBeDefined();\r\n      expect(openai!.promptCacheKey).toBe(\"mux-v1-workspace-xyz\");\r\n      expect(openai!.truncation).toBe(\"disabled\");\r\n    });\r\n  });\r\n\r\n  describe(\"previousResponseId reuse\", () => {\r\n    test(\"should reuse previousResponseId for gateway OpenAI history\", () => {\r\n      const messages = [\r\n        createMuxMessage(\"assistant-1\", \"assistant\", \"\", {\r\n          model: \"mux-gateway:openai/gpt-5.2\",\r\n          providerMetadata: { openai: { responseId: \"resp_123\" } },\r\n        }),\r\n      ];\r\n      const result = buildProviderOptions(\"mux-gateway:openai/gpt-5.2\", \"medium\", messages);\r\n      const openai = getOpenAIOptions(result);\r\n\r\n      expect(openai).toBeDefined();\r\n      expect(openai!.previousResponseId).toBe(\"resp_123\");\r\n    });\r\n  });\r\n});\r\n"]}