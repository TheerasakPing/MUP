{"version":3,"file":"schemaSanitizer.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/schemaSanitizer.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Tool } from \"ai\";\n\n/**\n * JSON Schema properties that are not permitted by OpenAI's Responses API.\n *\n * OpenAI's Structured Outputs has stricter JSON Schema validation than other providers.\n * MCP tools may have schemas with these properties which work fine with Anthropic\n * but fail with OpenAI. We strip these properties to ensure compatibility.\n *\n * @see https://platform.openai.com/docs/guides/structured-outputs\n * @see https://github.com/vercel/ai/discussions/5164\n */\nconst OPENAI_UNSUPPORTED_SCHEMA_PROPERTIES = new Set([\n  // String validation\n  \"minLength\",\n  \"maxLength\",\n  \"pattern\",\n  \"format\",\n  // Number validation\n  \"minimum\",\n  \"maximum\",\n  \"exclusiveMinimum\",\n  \"exclusiveMaximum\",\n  \"multipleOf\",\n  // Array validation\n  \"minItems\",\n  \"maxItems\",\n  \"uniqueItems\",\n  // Object validation\n  \"minProperties\",\n  \"maxProperties\",\n  // General\n  \"default\",\n  \"examples\",\n  \"deprecated\",\n  \"readOnly\",\n  \"writeOnly\",\n  // Composition (partially supported - strip from items/properties)\n  // Note: oneOf/anyOf at root level may work, but not in nested contexts\n]);\n\n/**\n * Recursively strip unsupported schema properties for OpenAI compatibility.\n * This mutates the schema in place for efficiency.\n */\nfunction stripUnsupportedProperties(schema: unknown): void {\n  if (typeof schema !== \"object\" || schema === null) {\n    return;\n  }\n\n  const obj = schema as Record<string, unknown>;\n\n  // Remove unsupported properties at this level\n  for (const prop of OPENAI_UNSUPPORTED_SCHEMA_PROPERTIES) {\n    if (prop in obj) {\n      delete obj[prop];\n    }\n  }\n\n  // Recursively process nested schemas\n  if (obj.properties && typeof obj.properties === \"object\") {\n    for (const propSchema of Object.values(obj.properties as Record<string, unknown>)) {\n      stripUnsupportedProperties(propSchema);\n    }\n  }\n\n  if (obj.items) {\n    if (Array.isArray(obj.items)) {\n      for (const itemSchema of obj.items) {\n        stripUnsupportedProperties(itemSchema);\n      }\n    } else {\n      stripUnsupportedProperties(obj.items);\n    }\n  }\n\n  if (obj.additionalProperties && typeof obj.additionalProperties === \"object\") {\n    stripUnsupportedProperties(obj.additionalProperties);\n  }\n\n  // Handle anyOf/oneOf/allOf\n  for (const keyword of [\"anyOf\", \"oneOf\", \"allOf\"]) {\n    if (Array.isArray(obj[keyword])) {\n      for (const subSchema of obj[keyword] as unknown[]) {\n        stripUnsupportedProperties(subSchema);\n      }\n    }\n  }\n\n  // Handle definitions/defs (JSON Schema draft-07 and later)\n  for (const defsKey of [\"definitions\", \"$defs\"]) {\n    if (obj[defsKey] && typeof obj[defsKey] === \"object\") {\n      for (const defSchema of Object.values(obj[defsKey] as Record<string, unknown>)) {\n        stripUnsupportedProperties(defSchema);\n      }\n    }\n  }\n}\n\n/**\n * Sanitize a tool's parameter schema for OpenAI Responses API compatibility.\n *\n * OpenAI's Responses API has stricter JSON Schema validation than other providers.\n * This function creates a new tool with sanitized parameters that strips\n * unsupported schema properties like minLength, maximum, default, etc.\n *\n * Tools can have schemas in two places:\n * - `parameters`: Used by tools created with ai SDK's `tool()` function\n * - `inputSchema`: Used by MCP tools created with `dynamicTool()` from @ai-sdk/mcp\n *\n * @param tool - The original tool to sanitize\n * @returns A new tool with sanitized parameter schema\n */\nexport function sanitizeToolSchemaForOpenAI(tool: Tool): Tool {\n  // Access tool internals - the AI SDK tool structure varies:\n  // - Regular tools have `parameters` (Zod schema)\n  // - MCP/dynamic tools have `inputSchema` (JSON Schema wrapper with getter)\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const toolRecord = tool as any as Record<string, unknown>;\n\n  // Check for inputSchema first (MCP tools use this)\n  // The inputSchema is a wrapper object with a jsonSchema getter\n  if (toolRecord.inputSchema && typeof toolRecord.inputSchema === \"object\") {\n    const inputSchemaWrapper = toolRecord.inputSchema as Record<string, unknown>;\n\n    // Get the actual JSON Schema - it's exposed via a getter\n    const rawJsonSchema = inputSchemaWrapper.jsonSchema;\n    if (rawJsonSchema && typeof rawJsonSchema === \"object\") {\n      // Deep clone and sanitize\n      const clonedSchema = JSON.parse(JSON.stringify(rawJsonSchema)) as Record<string, unknown>;\n      stripUnsupportedProperties(clonedSchema);\n\n      // Create a new inputSchema wrapper that returns our sanitized schema\n      const sanitizedInputSchema = {\n        ...inputSchemaWrapper,\n        // Override the jsonSchema getter with our sanitized version\n        get jsonSchema() {\n          return clonedSchema;\n        },\n      };\n\n      return {\n        ...tool,\n        inputSchema: sanitizedInputSchema,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      } as any as Tool;\n    }\n  }\n\n  // Fall back to parameters (regular AI SDK tools)\n  if (!toolRecord.parameters) {\n    return tool;\n  }\n\n  // Deep clone the parameters to avoid mutating the original\n  const clonedParams = JSON.parse(JSON.stringify(toolRecord.parameters)) as unknown;\n\n  // Strip unsupported properties\n  stripUnsupportedProperties(clonedParams);\n\n  // Create a new tool with sanitized parameters\n  return {\n    ...tool,\n    parameters: clonedParams,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  } as any as Tool;\n}\n\n/**\n * Sanitize all MCP tools for OpenAI compatibility.\n *\n * @param mcpTools - Record of MCP tools to sanitize\n * @returns Record of sanitized tools\n */\nexport function sanitizeMCPToolsForOpenAI(mcpTools: Record<string, Tool>): Record<string, Tool> {\n  const sanitized: Record<string, Tool> = {};\n  for (const [name, tool] of Object.entries(mcpTools)) {\n    sanitized[name] = sanitizeToolSchemaForOpenAI(tool);\n  }\n  return sanitized;\n}\n"]}