{"version":3,"file":"toolHookEnv.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/toolHookEnv.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Tool hook env helpers.\n *\n * Hooks are usually written in shell, so we provide a shell-friendly way to access\n * tool inputs without requiring JSON parsing (`jq`, Python, etc.).\n *\n * This module is shared by:\n * - production code (to populate env vars)\n * - docs generation (to list what env vars exist)\n *\n * That way the docs and runtime cannot drift.\n */\n\nexport interface FlattenToolHookEnvOptions {\n  /**\n   * Maximum length for any single env var value.\n   *\n   * If a value exceeds this limit, the env var is omitted (we do not truncate).\n   * Hooks can use `MUX_TOOL_INPUT_PATH`/`MUX_TOOL_RESULT_PATH` for full JSON.\n   */\n  maxValueLength?: number;\n\n  /** Maximum number of env vars emitted (best-effort safety limit). */\n  maxVars?: number;\n\n  /** Maximum number of array elements emitted (best-effort safety limit). */\n  maxArrayLength?: number;\n}\n\nconst DEFAULT_MAX_VALUE_LENGTH = 8_000;\nconst DEFAULT_MAX_VARS = 2_000;\nconst DEFAULT_MAX_ARRAY_LENGTH = 500;\n\nfunction sanitizeEnvVarKeyPart(part: string, options?: { allowPlaceholders?: boolean }): string {\n  const trimmed = part.trim();\n\n  // Avoid collapsing back to the prefix when a path segment is empty/whitespace.\n  // (e.g. key \" \" would otherwise become \"\", yielding env var name == prefix.)\n  if (trimmed.length === 0) {\n    return \"EMPTY\";\n  }\n\n  // For docs we sometimes want patterns like <INDEX>. Keep the angle brackets so\n  // it reads as a template rather than a literal variable name.\n  if (options?.allowPlaceholders && /^<[^>]+>$/.test(trimmed)) {\n    return trimmed.toUpperCase();\n  }\n\n  // Shell-friendly: [A-Z0-9_]. We still include underscores from the source key.\n  // Also: split camelCase/PascalCase into words (filePath -> FILE_PATH).\n  const withWordBreaks = trimmed\n    .replaceAll(/([A-Z]+)([A-Z][a-z])/g, \"$1_$2\")\n    .replaceAll(/([a-z0-9])([A-Z])/g, \"$1_$2\");\n\n  return withWordBreaks.toUpperCase().replaceAll(/[^A-Z0-9_]/g, \"_\");\n}\n\nexport function toolHookEnvVarName(\n  prefix: string,\n  keyPath: string[],\n  options?: { allowPlaceholders?: boolean }\n): string {\n  const parts = [prefix, ...keyPath].map((part) => sanitizeEnvVarKeyPart(part, options));\n  return parts.filter(Boolean).join(\"_\");\n}\n\n/**\n * Flatten a tool input/result value into env vars.\n *\n * Example:\n *   flattenToolHookValueToEnv({ file_path: \"a.ts\" }, \"MUX_TOOL_INPUT\")\n *     -> { MUX_TOOL_INPUT_FILE_PATH: \"a.ts\" }\n */\nexport function flattenToolHookValueToEnv(\n  value: unknown,\n  prefix: string,\n  options?: FlattenToolHookEnvOptions\n): Record<string, string> {\n  // Guard: Our hooks already have env vars like MUX_TOOL_INPUT/MUX_TOOL_RESULT.\n  // We only want to create prefixed sub-keys.\n  if (typeof value !== \"object\" || value === null) {\n    return {};\n  }\n  if (Array.isArray(value)) {\n    return {};\n  }\n\n  const maxValueLength = options?.maxValueLength ?? DEFAULT_MAX_VALUE_LENGTH;\n  const maxVars = options?.maxVars ?? DEFAULT_MAX_VARS;\n  const maxArrayLength = options?.maxArrayLength ?? DEFAULT_MAX_ARRAY_LENGTH;\n\n  const out: Record<string, string> = {};\n  let varCount = 0;\n\n  function trySet(key: string, rawValue: string): void {\n    if (varCount >= maxVars) return;\n\n    // We intentionally do not truncate values. If an env var doesn't fit, omit it\n    // and let hooks use the JSON file (`MUX_TOOL_INPUT_PATH`/`MUX_TOOL_RESULT_PATH`).\n    if (rawValue.length > maxValueLength) return;\n\n    out[key] = rawValue;\n    varCount += 1;\n  }\n\n  function recurse(current: unknown, keyPath: string[]): void {\n    if (varCount >= maxVars) return;\n    if (current === null || current === undefined) return;\n\n    if (typeof current === \"string\") {\n      trySet(toolHookEnvVarName(prefix, keyPath), current);\n      return;\n    }\n\n    if (\n      typeof current === \"number\" ||\n      typeof current === \"boolean\" ||\n      typeof current === \"bigint\"\n    ) {\n      trySet(toolHookEnvVarName(prefix, keyPath), String(current));\n      return;\n    }\n\n    if (Array.isArray(current)) {\n      const arrayCountKey = toolHookEnvVarName(prefix, [...keyPath, \"COUNT\"]);\n      trySet(arrayCountKey, String(current.length));\n\n      // Emit up to N elements to avoid blowing up env size.\n      const lengthToEmit = Math.min(current.length, maxArrayLength);\n      for (let i = 0; i < lengthToEmit; i += 1) {\n        recurse(current[i], [...keyPath, String(i)]);\n      }\n      return;\n    }\n\n    if (typeof current === \"object\") {\n      for (const [k, v] of Object.entries(current)) {\n        recurse(v, [...keyPath, k]);\n        if (varCount >= maxVars) return;\n      }\n    }\n  }\n\n  recurse(value, []);\n  return out;\n}\n"]}