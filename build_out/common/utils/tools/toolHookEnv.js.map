{"version":3,"file":"toolHookEnv.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/toolHookEnv.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Tool hook env helpers.\r\n *\r\n * Hooks are usually written in shell, so we provide a shell-friendly way to access\r\n * tool inputs without requiring JSON parsing (`jq`, Python, etc.).\r\n *\r\n * This module is shared by:\r\n * - production code (to populate env vars)\r\n * - docs generation (to list what env vars exist)\r\n *\r\n * That way the docs and runtime cannot drift.\r\n */\r\n\r\nexport interface FlattenToolHookEnvOptions {\r\n  /**\r\n   * Maximum length for any single env var value.\r\n   *\r\n   * If a value exceeds this limit, the env var is omitted (we do not truncate).\r\n   * Hooks can use `MUX_TOOL_INPUT_PATH`/`MUX_TOOL_RESULT_PATH` for full JSON.\r\n   */\r\n  maxValueLength?: number;\r\n\r\n  /** Maximum number of env vars emitted (best-effort safety limit). */\r\n  maxVars?: number;\r\n\r\n  /** Maximum number of array elements emitted (best-effort safety limit). */\r\n  maxArrayLength?: number;\r\n}\r\n\r\nconst DEFAULT_MAX_VALUE_LENGTH = 8_000;\r\nconst DEFAULT_MAX_VARS = 2_000;\r\nconst DEFAULT_MAX_ARRAY_LENGTH = 500;\r\n\r\nfunction sanitizeEnvVarKeyPart(part: string, options?: { allowPlaceholders?: boolean }): string {\r\n  const trimmed = part.trim();\r\n\r\n  // Avoid collapsing back to the prefix when a path segment is empty/whitespace.\r\n  // (e.g. key \" \" would otherwise become \"\", yielding env var name == prefix.)\r\n  if (trimmed.length === 0) {\r\n    return \"EMPTY\";\r\n  }\r\n\r\n  // For docs we sometimes want patterns like <INDEX>. Keep the angle brackets so\r\n  // it reads as a template rather than a literal variable name.\r\n  if (options?.allowPlaceholders && /^<[^>]+>$/.test(trimmed)) {\r\n    return trimmed.toUpperCase();\r\n  }\r\n\r\n  // Shell-friendly: [A-Z0-9_]. We still include underscores from the source key.\r\n  // Also: split camelCase/PascalCase into words (filePath -> FILE_PATH).\r\n  const withWordBreaks = trimmed\r\n    .replaceAll(/([A-Z]+)([A-Z][a-z])/g, \"$1_$2\")\r\n    .replaceAll(/([a-z0-9])([A-Z])/g, \"$1_$2\");\r\n\r\n  return withWordBreaks.toUpperCase().replaceAll(/[^A-Z0-9_]/g, \"_\");\r\n}\r\n\r\nexport function toolHookEnvVarName(\r\n  prefix: string,\r\n  keyPath: string[],\r\n  options?: { allowPlaceholders?: boolean }\r\n): string {\r\n  const parts = [prefix, ...keyPath].map((part) => sanitizeEnvVarKeyPart(part, options));\r\n  return parts.filter(Boolean).join(\"_\");\r\n}\r\n\r\n/**\r\n * Flatten a tool input/result value into env vars.\r\n *\r\n * Example:\r\n *   flattenToolHookValueToEnv({ file_path: \"a.ts\" }, \"MUX_TOOL_INPUT\")\r\n *     -> { MUX_TOOL_INPUT_FILE_PATH: \"a.ts\" }\r\n */\r\nexport function flattenToolHookValueToEnv(\r\n  value: unknown,\r\n  prefix: string,\r\n  options?: FlattenToolHookEnvOptions\r\n): Record<string, string> {\r\n  // Guard: Our hooks already have env vars like MUX_TOOL_INPUT/MUX_TOOL_RESULT.\r\n  // We only want to create prefixed sub-keys.\r\n  if (typeof value !== \"object\" || value === null) {\r\n    return {};\r\n  }\r\n  if (Array.isArray(value)) {\r\n    return {};\r\n  }\r\n\r\n  const maxValueLength = options?.maxValueLength ?? DEFAULT_MAX_VALUE_LENGTH;\r\n  const maxVars = options?.maxVars ?? DEFAULT_MAX_VARS;\r\n  const maxArrayLength = options?.maxArrayLength ?? DEFAULT_MAX_ARRAY_LENGTH;\r\n\r\n  const out: Record<string, string> = {};\r\n  let varCount = 0;\r\n\r\n  function trySet(key: string, rawValue: string): void {\r\n    if (varCount >= maxVars) return;\r\n\r\n    // We intentionally do not truncate values. If an env var doesn't fit, omit it\r\n    // and let hooks use the JSON file (`MUX_TOOL_INPUT_PATH`/`MUX_TOOL_RESULT_PATH`).\r\n    if (rawValue.length > maxValueLength) return;\r\n\r\n    out[key] = rawValue;\r\n    varCount += 1;\r\n  }\r\n\r\n  function recurse(current: unknown, keyPath: string[]): void {\r\n    if (varCount >= maxVars) return;\r\n    if (current === null || current === undefined) return;\r\n\r\n    if (typeof current === \"string\") {\r\n      trySet(toolHookEnvVarName(prefix, keyPath), current);\r\n      return;\r\n    }\r\n\r\n    if (\r\n      typeof current === \"number\" ||\r\n      typeof current === \"boolean\" ||\r\n      typeof current === \"bigint\"\r\n    ) {\r\n      trySet(toolHookEnvVarName(prefix, keyPath), String(current));\r\n      return;\r\n    }\r\n\r\n    if (Array.isArray(current)) {\r\n      const arrayCountKey = toolHookEnvVarName(prefix, [...keyPath, \"COUNT\"]);\r\n      trySet(arrayCountKey, String(current.length));\r\n\r\n      // Emit up to N elements to avoid blowing up env size.\r\n      const lengthToEmit = Math.min(current.length, maxArrayLength);\r\n      for (let i = 0; i < lengthToEmit; i += 1) {\r\n        recurse(current[i], [...keyPath, String(i)]);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (typeof current === \"object\") {\r\n      for (const [k, v] of Object.entries(current)) {\r\n        recurse(v, [...keyPath, k]);\r\n        if (varCount >= maxVars) return;\r\n      }\r\n    }\r\n  }\r\n\r\n  recurse(value, []);\r\n  return out;\r\n}\r\n"]}