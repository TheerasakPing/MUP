{"version":3,"file":"mcpToolName.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/mcpToolName.ts"],"names":[],"mappings":"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","sourcesContent":["import { uniqueSuffix } from \"@/common/utils/hasher\";\n\nconst DEFAULT_MCP_TOOL_NAME_PART = \"unknown\";\n\n// Be conservative: some providers have strict tool-name validation and limits.\nexport const MAX_MCP_TOOL_NAME_CHARS = 64;\n\nconst MCP_TOOL_NAME_PATTERN = /^[a-z0-9_]+$/;\n\n/**\n * Normalize a single component used to build an MCP tool name.\n *\n * Note: This is NOT user-facing. It's purely to ensure provider-safe tool keys.\n */\nexport function normalizeMcpToolNamePart(input: string): string {\n  const normalized = input\n    .normalize(\"NFKD\")\n    .toLowerCase()\n    // Replace whitespace and any non-[a-z0-9_] characters with underscores.\n    // (Treat '-' as '_' too for maximum provider compatibility.)\n    .replace(/[^a-z0-9_]+/g, \"_\")\n    // Collapse consecutive underscores.\n    .replace(/_+/g, \"_\")\n    // Trim leading/trailing underscores.\n    .replace(/^_+|_+$/g, \"\");\n\n  return normalized.length > 0 ? normalized : DEFAULT_MCP_TOOL_NAME_PART;\n}\n\nexport interface BuildMcpToolNameOptions {\n  serverName: string;\n  toolName: string;\n  usedNames: Set<string>;\n}\n\nexport interface BuildMcpToolNameResult {\n  toolName: string;\n  /**\n   * The normalized tool name without any collision/truncation suffix.\n   * Useful for debugging/logging.\n   */\n  baseName: string;\n  /** True when we added a hash suffix due to collision or length constraints. */\n  wasSuffixed: boolean;\n}\n\nfunction buildMcpToolNameWithSuffix(baseName: string, suffix: string): string {\n  // Ensure we always fit the suffix + separator.\n  const trimmedSuffix = suffix.slice(0, 8);\n  const suffixWithSeparator = `_${trimmedSuffix}`;\n\n  const maxBaseLength = MAX_MCP_TOOL_NAME_CHARS - suffixWithSeparator.length;\n  if (maxBaseLength <= 0) {\n    return `tool${suffixWithSeparator}`.slice(0, MAX_MCP_TOOL_NAME_CHARS);\n  }\n\n  const trimmedBase = baseName.slice(0, maxBaseLength).replace(/_+$/g, \"\") || \"tool\";\n  return `${trimmedBase}${suffixWithSeparator}`;\n}\n\n/**\n * Build a provider-safe, collision-resistant MCP tool name.\n *\n * The tool name is derived from `${serverName}_${toolName}`, but normalized to:\n * - lowercase\n * - underscore-delimited\n * - <= 64 characters\n * - [a-z0-9_]+ only\n *\n * If the normalized name collides with an existing tool name (or exceeds 64 chars),\n * a stable hash suffix is appended.\n */\nexport function buildMcpToolName(options: BuildMcpToolNameOptions): BuildMcpToolNameResult | null {\n  const serverPart = normalizeMcpToolNamePart(options.serverName);\n  const toolPart = normalizeMcpToolNamePart(options.toolName);\n  const baseName = `${serverPart}_${toolPart}`;\n\n  if (!MCP_TOOL_NAME_PATTERN.test(baseName)) {\n    return null;\n  }\n\n  let finalName = baseName;\n  let wasSuffixed = false;\n\n  if (finalName.length > MAX_MCP_TOOL_NAME_CHARS || options.usedNames.has(finalName)) {\n    wasSuffixed = true;\n\n    // Use a stable suffix derived from the *original* server/tool names so that renaming\n    // only happens when necessary (collisions/length), and remains deterministic.\n    const suffix = uniqueSuffix([options.serverName, options.toolName]);\n    finalName = buildMcpToolNameWithSuffix(baseName, suffix);\n\n    // Extremely defensive: in the astronomically unlikely case of a hash collision,\n    // attempt a second derivation before giving up.\n    if (options.usedNames.has(finalName)) {\n      const suffix2 = uniqueSuffix([options.serverName, options.toolName, \"2\"]);\n      finalName = buildMcpToolNameWithSuffix(baseName, suffix2);\n\n      if (options.usedNames.has(finalName)) {\n        return null;\n      }\n    }\n  }\n\n  if (!MCP_TOOL_NAME_PATTERN.test(finalName) || finalName.length > MAX_MCP_TOOL_NAME_CHARS) {\n    return null;\n  }\n\n  options.usedNames.add(finalName);\n\n  return { toolName: finalName, baseName, wasSuffixed };\n}\n"]}