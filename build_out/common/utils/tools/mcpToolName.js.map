{"version":3,"file":"mcpToolName.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/mcpToolName.ts"],"names":[],"mappings":";;;;;AAAA,kDAAqD;AAErD,MAAM,0BAA0B,GAAG,SAAS,CAAC;AAE7C,+EAA+E;AAClE,QAAA,uBAAuB,GAAG,EAAE,CAAC;AAE1C,MAAM,qBAAqB,GAAG,cAAc,CAAC;AAE7C;;;;GAIG;AACH,kCAAyC,KAAa,EAAU;IAC9D,MAAM,UAAU,GAAG,KAAK;SACrB,SAAS,CAAC,MAAM,CAAC;SACjB,WAAW,EAAE;QACd,wEAAwE;QACxE,6DAA6D;SAC5D,OAAO,CAAC,cAAc,EAAE,GAAG,CAAC;QAC7B,oCAAoC;SACnC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC;QACpB,qCAAqC;SACpC,OAAO,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;IAE3B,OAAO,UAAU,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,0BAA0B,CAAC;AAAA,CACxE;AAmBD,SAAS,0BAA0B,CAAC,QAAgB,EAAE,MAAc,EAAU;IAC5E,+CAA+C;IAC/C,MAAM,aAAa,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;IACzC,MAAM,mBAAmB,GAAG,IAAI,aAAa,EAAE,CAAC;IAEhD,MAAM,aAAa,GAAG,QAAA,uBAAuB,GAAG,mBAAmB,CAAC,MAAM,CAAC;IAC3E,IAAI,aAAa,IAAI,CAAC,EAAE,CAAC;QACvB,OAAO,OAAO,mBAAmB,EAAE,CAAC,KAAK,CAAC,CAAC,EAAE,QAAA,uBAAuB,CAAC,CAAC;IACxE,CAAC;IAED,MAAM,WAAW,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,IAAI,MAAM,CAAC;IACnF,OAAO,GAAG,WAAW,GAAG,mBAAmB,EAAE,CAAC;AAAA,CAC/C;AAED;;;;;;;;;;;GAWG;AACH,0BAAiC,OAAgC,EAAiC;IAChG,MAAM,UAAU,GAAG,wBAAwB,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;IAChE,MAAM,QAAQ,GAAG,wBAAwB,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;IAC5D,MAAM,QAAQ,GAAG,GAAG,UAAU,IAAI,QAAQ,EAAE,CAAC;IAE7C,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC1C,OAAO,IAAI,CAAC;IACd,CAAC;IAED,IAAI,SAAS,GAAG,QAAQ,CAAC;IACzB,IAAI,WAAW,GAAG,KAAK,CAAC;IAExB,IAAI,SAAS,CAAC,MAAM,GAAG,QAAA,uBAAuB,IAAI,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC;QACnF,WAAW,GAAG,IAAI,CAAC;QAEnB,qFAAqF;QACrF,8EAA8E;QAC9E,MAAM,MAAM,GAAG,IAAA,qBAAY,EAAC,CAAC,OAAO,CAAC,UAAU,EAAE,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC;QACpE,SAAS,GAAG,0BAA0B,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAEzD,gFAAgF;QAChF,gDAAgD;QAChD,IAAI,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC;YACrC,MAAM,OAAO,GAAG,IAAA,qBAAY,EAAC,CAAC,OAAO,CAAC,UAAU,EAAE,OAAO,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,CAAC;YAC1E,SAAS,GAAG,0BAA0B,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YAE1D,IAAI,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC;gBACrC,OAAO,IAAI,CAAC;YACd,CAAC;QACH,CAAC;IACH,CAAC;IAED,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,SAAS,CAAC,MAAM,GAAG,QAAA,uBAAuB,EAAE,CAAC;QACzF,OAAO,IAAI,CAAC;IACd,CAAC;IAED,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;IAEjC,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,EAAE,WAAW,EAAE,CAAC;AAAA,CACvD","sourcesContent":["import { uniqueSuffix } from \"@/common/utils/hasher\";\r\n\r\nconst DEFAULT_MCP_TOOL_NAME_PART = \"unknown\";\r\n\r\n// Be conservative: some providers have strict tool-name validation and limits.\r\nexport const MAX_MCP_TOOL_NAME_CHARS = 64;\r\n\r\nconst MCP_TOOL_NAME_PATTERN = /^[a-z0-9_]+$/;\r\n\r\n/**\r\n * Normalize a single component used to build an MCP tool name.\r\n *\r\n * Note: This is NOT user-facing. It's purely to ensure provider-safe tool keys.\r\n */\r\nexport function normalizeMcpToolNamePart(input: string): string {\r\n  const normalized = input\r\n    .normalize(\"NFKD\")\r\n    .toLowerCase()\r\n    // Replace whitespace and any non-[a-z0-9_] characters with underscores.\r\n    // (Treat '-' as '_' too for maximum provider compatibility.)\r\n    .replace(/[^a-z0-9_]+/g, \"_\")\r\n    // Collapse consecutive underscores.\r\n    .replace(/_+/g, \"_\")\r\n    // Trim leading/trailing underscores.\r\n    .replace(/^_+|_+$/g, \"\");\r\n\r\n  return normalized.length > 0 ? normalized : DEFAULT_MCP_TOOL_NAME_PART;\r\n}\r\n\r\nexport interface BuildMcpToolNameOptions {\r\n  serverName: string;\r\n  toolName: string;\r\n  usedNames: Set<string>;\r\n}\r\n\r\nexport interface BuildMcpToolNameResult {\r\n  toolName: string;\r\n  /**\r\n   * The normalized tool name without any collision/truncation suffix.\r\n   * Useful for debugging/logging.\r\n   */\r\n  baseName: string;\r\n  /** True when we added a hash suffix due to collision or length constraints. */\r\n  wasSuffixed: boolean;\r\n}\r\n\r\nfunction buildMcpToolNameWithSuffix(baseName: string, suffix: string): string {\r\n  // Ensure we always fit the suffix + separator.\r\n  const trimmedSuffix = suffix.slice(0, 8);\r\n  const suffixWithSeparator = `_${trimmedSuffix}`;\r\n\r\n  const maxBaseLength = MAX_MCP_TOOL_NAME_CHARS - suffixWithSeparator.length;\r\n  if (maxBaseLength <= 0) {\r\n    return `tool${suffixWithSeparator}`.slice(0, MAX_MCP_TOOL_NAME_CHARS);\r\n  }\r\n\r\n  const trimmedBase = baseName.slice(0, maxBaseLength).replace(/_+$/g, \"\") || \"tool\";\r\n  return `${trimmedBase}${suffixWithSeparator}`;\r\n}\r\n\r\n/**\r\n * Build a provider-safe, collision-resistant MCP tool name.\r\n *\r\n * The tool name is derived from `${serverName}_${toolName}`, but normalized to:\r\n * - lowercase\r\n * - underscore-delimited\r\n * - <= 64 characters\r\n * - [a-z0-9_]+ only\r\n *\r\n * If the normalized name collides with an existing tool name (or exceeds 64 chars),\r\n * a stable hash suffix is appended.\r\n */\r\nexport function buildMcpToolName(options: BuildMcpToolNameOptions): BuildMcpToolNameResult | null {\r\n  const serverPart = normalizeMcpToolNamePart(options.serverName);\r\n  const toolPart = normalizeMcpToolNamePart(options.toolName);\r\n  const baseName = `${serverPart}_${toolPart}`;\r\n\r\n  if (!MCP_TOOL_NAME_PATTERN.test(baseName)) {\r\n    return null;\r\n  }\r\n\r\n  let finalName = baseName;\r\n  let wasSuffixed = false;\r\n\r\n  if (finalName.length > MAX_MCP_TOOL_NAME_CHARS || options.usedNames.has(finalName)) {\r\n    wasSuffixed = true;\r\n\r\n    // Use a stable suffix derived from the *original* server/tool names so that renaming\r\n    // only happens when necessary (collisions/length), and remains deterministic.\r\n    const suffix = uniqueSuffix([options.serverName, options.toolName]);\r\n    finalName = buildMcpToolNameWithSuffix(baseName, suffix);\r\n\r\n    // Extremely defensive: in the astronomically unlikely case of a hash collision,\r\n    // attempt a second derivation before giving up.\r\n    if (options.usedNames.has(finalName)) {\r\n      const suffix2 = uniqueSuffix([options.serverName, options.toolName, \"2\"]);\r\n      finalName = buildMcpToolNameWithSuffix(baseName, suffix2);\r\n\r\n      if (options.usedNames.has(finalName)) {\r\n        return null;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!MCP_TOOL_NAME_PATTERN.test(finalName) || finalName.length > MAX_MCP_TOOL_NAME_CHARS) {\r\n    return null;\r\n  }\r\n\r\n  options.usedNames.add(finalName);\r\n\r\n  return { toolName: finalName, baseName, wasSuffixed };\r\n}\r\n"]}