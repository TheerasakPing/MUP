{"version":3,"file":"tools.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/tools.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Tool } from \"ai\";\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\nimport { cloneToolPreservingDescriptors } from \"@/common/utils/tools/cloneToolPreservingDescriptors\";\nimport { createFileReadTool } from \"@/node/services/tools/file_read\";\nimport { createBashTool } from \"@/node/services/tools/bash\";\nimport { createBashOutputTool } from \"@/node/services/tools/bash_output\";\nimport { createBashBackgroundListTool } from \"@/node/services/tools/bash_background_list\";\nimport { createBashBackgroundTerminateTool } from \"@/node/services/tools/bash_background_terminate\";\nimport { createFileEditReplaceStringTool } from \"@/node/services/tools/file_edit_replace_string\";\n// DISABLED: import { createFileEditReplaceLinesTool } from \"@/node/services/tools/file_edit_replace_lines\";\nimport { createFileEditInsertTool } from \"@/node/services/tools/file_edit_insert\";\nimport { createAskUserQuestionTool } from \"@/node/services/tools/ask_user_question\";\nimport { createProposePlanTool } from \"@/node/services/tools/propose_plan\";\nimport { createTodoWriteTool, createTodoReadTool } from \"@/node/services/tools/todo\";\nimport { createStatusSetTool } from \"@/node/services/tools/status_set\";\nimport { createNotifyTool } from \"@/node/services/tools/notify\";\nimport { createTaskTool } from \"@/node/services/tools/task\";\nimport { createTaskApplyGitPatchTool } from \"@/node/services/tools/task_apply_git_patch\";\nimport { createTaskAwaitTool } from \"@/node/services/tools/task_await\";\nimport { createTaskTerminateTool } from \"@/node/services/tools/task_terminate\";\nimport { createTaskListTool } from \"@/node/services/tools/task_list\";\nimport { createAgentSkillReadTool } from \"@/node/services/tools/agent_skill_read\";\nimport { createAgentSkillReadFileTool } from \"@/node/services/tools/agent_skill_read_file\";\nimport { createMuxGlobalAgentsReadTool } from \"@/node/services/tools/mux_global_agents_read\";\nimport { createMuxGlobalAgentsWriteTool } from \"@/node/services/tools/mux_global_agents_write\";\nimport { createAgentReportTool } from \"@/node/services/tools/agent_report\";\nimport { createSystem1KeepRangesTool } from \"@/node/services/tools/system1_keep_ranges\";\nimport { wrapWithInitWait } from \"@/node/services/tools/wrapWithInitWait\";\nimport { withHooks, type HookConfig } from \"@/node/services/tools/withHooks\";\nimport { log } from \"@/node/services/log\";\nimport { attachModelOnlyToolNotifications } from \"@/common/utils/tools/internalToolResultFields\";\nimport { NotificationEngine } from \"@/node/services/agentNotifications/NotificationEngine\";\nimport { TodoListReminderSource } from \"@/node/services/agentNotifications/sources/TodoListReminderSource\";\nimport { getAvailableTools } from \"@/common/utils/tools/toolDefinitions\";\nimport { sanitizeMCPToolsForOpenAI } from \"@/common/utils/tools/schemaSanitizer\";\n\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\nimport type { TaskService } from \"@/node/services/taskService\";\nimport type { WorkspaceChatMessage } from \"@/common/orpc/types\";\nimport type { FileState } from \"@/node/services/agentSession\";\nimport type { AgentDefinitionDescriptor } from \"@/common/types/agentDefinition\";\nimport type { AgentSkillDescriptor } from \"@/common/types/agentSkill\";\n\n/**\n * Configuration for tools that need runtime context\n */\nexport interface ToolConfiguration {\n  /** Working directory for command execution - actual path in runtime's context (local or remote) */\n  cwd: string;\n  /** Runtime environment for executing commands and file operations */\n  runtime: Runtime;\n  /** Environment secrets to inject (optional) */\n  secrets?: Record<string, string>;\n  /** MUX_ environment variables (MUX_PROJECT_PATH, MUX_RUNTIME) - set from init hook env */\n  muxEnv?: Record<string, string>;\n  /** Temporary directory for tool outputs in runtime's context (local or remote) */\n  runtimeTempDir: string;\n  /** Overflow policy for bash tool output (optional, not exposed to AI) */\n  overflow_policy?: \"truncate\" | \"tmpfile\";\n  /** Background process manager for bash tool (optional, AI-only) */\n  backgroundProcessManager?: BackgroundProcessManager;\n  /** When true, restrict edits to the plan file (plan agent behavior). */\n  planFileOnly?: boolean;\n  /** Plan file path - only this file can be edited when planFileOnly is true. */\n  planFilePath?: string;\n  /**\n   * Optional callback for emitting UI-only workspace chat events.\n   * Used for streaming bash stdout/stderr to the UI without sending it to the model.\n   */\n  emitChatEvent?: (event: WorkspaceChatMessage) => void;\n  /** Workspace session directory (e.g. ~/.mux/sessions/<workspaceId>) for persistent tool state */\n  workspaceSessionDir?: string;\n  /** Workspace ID for tracking background processes and plan storage */\n  workspaceId?: string;\n  /** Callback to record file state for external edit detection (plan files) */\n  recordFileState?: (filePath: string, state: FileState) => void;\n  /** Task orchestration for sub-agent tasks */\n  taskService?: TaskService;\n  /** Enable agent_report tool (only valid for child task workspaces) */\n  enableAgentReport?: boolean;\n  /** Experiments inherited from parent (for subagent spawning) */\n  experiments?: {\n    programmaticToolCalling?: boolean;\n    programmaticToolCallingExclusive?: boolean;\n    execSubagentHardRestart?: boolean;\n  };\n  /** Available sub-agents for the task tool description (dynamic context) */\n  availableSubagents?: AgentDefinitionDescriptor[];\n  /** Available skills for the agent_skill_read tool description (dynamic context) */\n  availableSkills?: AgentSkillDescriptor[];\n}\n\n/**\n * Factory function interface for creating tools with configuration\n */\nexport type ToolFactory = (config: ToolConfiguration) => Tool;\n\n/**\n * Augment a tool's description with additional instructions from \"Tool: <name>\" sections\n * Mutates the base tool in place to append the instructions to its description.\n * This preserves any provider-specific metadata or internal state on the tool object.\n * @param baseTool The original tool to augment\n * @param additionalInstructions Additional instructions to append to the description\n * @returns The same tool instance with the augmented description\n */\nfunction augmentToolDescription(baseTool: Tool, additionalInstructions: string): Tool {\n  // Access the tool as a record to get its properties\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const baseToolRecord = baseTool as any as Record<string, unknown>;\n  const originalDescription =\n    typeof baseToolRecord.description === \"string\" ? baseToolRecord.description : \"\";\n  const augmentedDescription = `${originalDescription}\\n\\n${additionalInstructions}`;\n\n  // Mutate the description in place to preserve other properties (e.g. provider metadata)\n  baseToolRecord.description = augmentedDescription;\n\n  return baseTool;\n}\n\nfunction wrapToolExecuteWithModelOnlyNotifications(\n  toolName: string,\n  baseTool: Tool,\n  engine: NotificationEngine\n): Tool {\n  // Access the tool as a record to get its properties.\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const baseToolRecord = baseTool as any as Record<string, unknown>;\n  const originalExecute = baseToolRecord.execute;\n\n  if (typeof originalExecute !== \"function\") {\n    return baseTool;\n  }\n\n  const executeFn = originalExecute as (this: unknown, args: unknown, options: unknown) => unknown;\n\n  // Avoid mutating cached tools in place (e.g. MCP tools cached per workspace).\n  // Repeated getToolsForModel() calls should not stack wrappers.\n  const wrappedTool = cloneToolPreservingDescriptors(baseTool);\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const wrappedToolRecord = wrappedTool as any as Record<string, unknown>;\n\n  wrappedToolRecord.execute = async (args: unknown, options: unknown) => {\n    try {\n      const result: unknown = await executeFn.call(baseTool, args, options);\n\n      let notifications: string[] = [];\n      try {\n        notifications = await engine.pollAfterToolCall({\n          toolName,\n          toolSucceeded: true,\n          now: Date.now(),\n        });\n      } catch (error) {\n        log.debug(\"[getToolsForModel] notification poll failed\", { error, toolName });\n      }\n\n      return attachModelOnlyToolNotifications(result, notifications);\n    } catch (error) {\n      try {\n        await engine.pollAfterToolCall({\n          toolName,\n          toolSucceeded: false,\n          now: Date.now(),\n        });\n      } catch (pollError) {\n        log.debug(\"[getToolsForModel] notification poll failed\", { pollError, toolName });\n      }\n\n      throw error;\n    }\n  };\n\n  return wrappedTool;\n}\n\nfunction wrapToolsWithModelOnlyNotifications(\n  tools: Record<string, Tool>,\n  config: ToolConfiguration\n): Record<string, Tool> {\n  if (!config.workspaceSessionDir) {\n    return tools;\n  }\n\n  const engine = new NotificationEngine([\n    new TodoListReminderSource({ workspaceSessionDir: config.workspaceSessionDir }),\n  ]);\n\n  const wrappedTools: Record<string, Tool> = {};\n  for (const [toolName, tool] of Object.entries(tools)) {\n    wrappedTools[toolName] = wrapToolExecuteWithModelOnlyNotifications(toolName, tool, engine);\n  }\n\n  return wrappedTools;\n}\n\n/**\n * Wrap tools with hook support.\n *\n * If any of these exist, each tool execution is wrapped:\n * - `.mux/tool_pre` (pre-hook)\n * - `.mux/tool_post` (post-hook)\n * - `.mux/tool_hook` (legacy pre+post)\n */\nfunction wrapToolsWithHooks(\n  tools: Record<string, Tool>,\n  config: ToolConfiguration\n): Record<string, Tool> {\n  // Hooks require workspaceId, cwd, and runtime\n  if (!config.workspaceId || !config.cwd || !config.runtime) {\n    return tools;\n  }\n\n  const hookConfig: HookConfig = {\n    runtime: config.runtime,\n    cwd: config.cwd,\n    runtimeTempDir: config.runtimeTempDir,\n    workspaceId: config.workspaceId,\n    // Match bash tool behavior: muxEnv is present and secrets override it.\n    env: {\n      ...(config.muxEnv ?? {}),\n      ...(config.secrets ?? {}),\n    },\n  };\n\n  const wrappedTools: Record<string, Tool> = {};\n  for (const [toolName, tool] of Object.entries(tools)) {\n    wrappedTools[toolName] = withHooks(toolName, tool, hookConfig);\n  }\n\n  return wrappedTools;\n}\n\n/**\n * Get tools available for a specific model with configuration\n *\n * Providers are lazy-loaded to reduce startup time. AI SDK providers are only\n * imported when actually needed for a specific model.\n *\n * @param modelString The model string in format \"provider:model-id\"\n * @param config Required configuration for tools\n * @param workspaceId Workspace ID for init state tracking (required for runtime tools)\n * @param initStateManager Init state manager for runtime tools to wait for initialization\n * @param toolInstructions Optional map of tool names to additional instructions from \"Tool: <name>\" sections\n * @returns Promise resolving to record of tools available for the model\n */\nexport async function getToolsForModel(\n  modelString: string,\n  config: ToolConfiguration,\n  workspaceId: string,\n  initStateManager: InitStateManager,\n  toolInstructions?: Record<string, string>,\n  mcpTools?: Record<string, Tool>\n): Promise<Record<string, Tool>> {\n  const [provider, modelId] = modelString.split(\":\");\n\n  // Helper to reduce repetition when wrapping runtime tools\n  const wrap = <TParameters, TResult>(tool: Tool<TParameters, TResult>) =>\n    wrapWithInitWait(tool, workspaceId, initStateManager);\n\n  // Lazy-load web_fetch to avoid loading jsdom (ESM-only) at Jest setup time\n  // This allows integration tests to run without transforming jsdom's dependencies\n  const { createWebFetchTool } = await import(\"@/node/services/tools/web_fetch\");\n\n  // Runtime-dependent tools need to wait for workspace initialization\n  // Wrap them to handle init waiting centrally instead of in each tool\n  const runtimeTools: Record<string, Tool> = {\n    file_read: wrap(createFileReadTool(config)),\n    agent_skill_read: wrap(createAgentSkillReadTool(config)),\n    agent_skill_read_file: wrap(createAgentSkillReadFileTool(config)),\n    file_edit_replace_string: wrap(createFileEditReplaceStringTool(config)),\n    file_edit_insert: wrap(createFileEditInsertTool(config)),\n    // DISABLED: file_edit_replace_lines - causes models (particularly GPT-5-Codex)\n    // to leave repository in broken state due to issues with concurrent file modifications\n    // and line number miscalculations. Use file_edit_replace_string instead.\n    // file_edit_replace_lines: wrap(createFileEditReplaceLinesTool(config)),\n\n    // Sub-agent task orchestration (child workspaces)\n    task: wrap(createTaskTool(config)),\n    task_await: wrap(createTaskAwaitTool(config)),\n    task_apply_git_patch: wrap(createTaskApplyGitPatchTool(config)),\n    task_terminate: wrap(createTaskTerminateTool(config)),\n    task_list: wrap(createTaskListTool(config)),\n\n    // Bash execution (foreground/background). Manage background output via task_await/task_list/task_terminate.\n    bash: wrap(createBashTool(config)),\n\n    // Legacy bash process tools (deprecated)\n    bash_output: wrap(createBashOutputTool(config)),\n    bash_background_list: wrap(createBashBackgroundListTool(config)),\n    bash_background_terminate: wrap(createBashBackgroundTerminateTool(config)),\n\n    web_fetch: wrap(createWebFetchTool(config)),\n  };\n\n  // Non-runtime tools execute immediately (no init wait needed)\n  // Note: Tool availability is controlled by agent tool policy (allowlist), not mode checks here.\n  const nonRuntimeTools: Record<string, Tool> = {\n    mux_global_agents_read: createMuxGlobalAgentsReadTool(config),\n    mux_global_agents_write: createMuxGlobalAgentsWriteTool(config),\n    ask_user_question: createAskUserQuestionTool(config),\n    propose_plan: createProposePlanTool(config),\n    ...(config.enableAgentReport ? { agent_report: createAgentReportTool(config) } : {}),\n    system1_keep_ranges: createSystem1KeepRangesTool(config),\n    todo_write: createTodoWriteTool(config),\n    todo_read: createTodoReadTool(config),\n    status_set: createStatusSetTool(config),\n    notify: createNotifyTool(config),\n  };\n\n  // Base tools available for all models\n  const baseTools: Record<string, Tool> = {\n    ...runtimeTools,\n    ...nonRuntimeTools,\n  };\n\n  // Try to add provider-specific web search tools if available\n  // Lazy-load providers to avoid loading all AI SDKs at startup\n  let allTools = { ...baseTools, ...(mcpTools ?? {}) };\n  try {\n    switch (provider) {\n      case \"anthropic\": {\n        const { anthropic } = await import(\"@ai-sdk/anthropic\");\n        allTools = {\n          ...baseTools,\n          ...(mcpTools ?? {}),\n          // Provider-specific tool types are compatible with Tool at runtime\n          web_search: anthropic.tools.webSearch_20250305({ maxUses: 1000 }) as Tool,\n        };\n        break;\n      }\n\n      case \"openai\": {\n        // Sanitize MCP tools for OpenAI's stricter JSON Schema validation.\n        // OpenAI's Responses API doesn't support certain schema properties like\n        // minLength, maximum, default, etc. that are valid JSON Schema but not\n        // accepted by OpenAI's Structured Outputs implementation.\n        const sanitizedMcpTools = mcpTools ? sanitizeMCPToolsForOpenAI(mcpTools) : {};\n\n        // Only add web search for models that support it\n        if (modelId.includes(\"gpt-5\") || modelId.includes(\"gpt-4\")) {\n          const { openai } = await import(\"@ai-sdk/openai\");\n          allTools = {\n            ...baseTools,\n            ...sanitizedMcpTools,\n            // Provider-specific tool types are compatible with Tool at runtime\n            web_search: openai.tools.webSearch({\n              searchContextSize: \"high\",\n            }) as Tool,\n          };\n        } else {\n          // For other OpenAI models (o1, o3, etc.), still use sanitized MCP tools\n          allTools = {\n            ...baseTools,\n            ...sanitizedMcpTools,\n          };\n        }\n        break;\n      }\n\n      // Note: Gemini 3 tool support:\n      // Combining native tools with function calling is currently only\n      // supported in the Live API. Thus no `google_search` or `url_context` added here.\n      // - https://ai.google.dev/gemini-api/docs/function-calling?example=meeting#native-tools\n    }\n  } catch (error) {\n    // If tools aren't available, just use base tools\n    log.error(`No web search tools available for ${provider}:`, error);\n  }\n\n  // Filter tools to the canonical allowlist so system prompt + toolset stay in sync.\n  // Include MCP tools even if they're not in getAvailableTools().\n  const allowlistedToolNames = new Set(\n    getAvailableTools(modelString, {\n      enableAgentReport: config.enableAgentReport,\n      enableMuxGlobalAgentsTools: workspaceId === MUX_HELP_CHAT_WORKSPACE_ID,\n    })\n  );\n  for (const toolName of Object.keys(mcpTools ?? {})) {\n    allowlistedToolNames.add(toolName);\n  }\n\n  allTools = Object.fromEntries(\n    Object.entries(allTools).filter(([toolName]) => allowlistedToolNames.has(toolName))\n  );\n\n  let finalTools = allTools;\n  // Apply tool-specific instructions if provided\n  if (toolInstructions) {\n    const augmentedTools: Record<string, Tool> = {};\n    for (const [toolName, baseTool] of Object.entries(allTools)) {\n      const instructions = toolInstructions[toolName];\n      if (instructions) {\n        augmentedTools[toolName] = augmentToolDescription(baseTool, instructions);\n      } else {\n        augmentedTools[toolName] = baseTool;\n      }\n    }\n    finalTools = augmentedTools;\n  }\n\n  // Apply hook wrapping first (hooks wrap each tool execution)\n  finalTools = wrapToolsWithHooks(finalTools, config);\n\n  // Then apply model-only notifications (adds notifications to results)\n  finalTools = wrapToolsWithModelOnlyNotifications(finalTools, config);\n\n  return finalTools;\n}\n"]}