{"version":3,"file":"tools.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/tools.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Tool } from \"ai\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { cloneToolPreservingDescriptors } from \"@/common/utils/tools/cloneToolPreservingDescriptors\";\r\nimport { createFileReadTool } from \"@/node/services/tools/file_read\";\r\nimport { createBashTool } from \"@/node/services/tools/bash\";\r\nimport { createBashOutputTool } from \"@/node/services/tools/bash_output\";\r\nimport { createBashBackgroundListTool } from \"@/node/services/tools/bash_background_list\";\r\nimport { createBashBackgroundTerminateTool } from \"@/node/services/tools/bash_background_terminate\";\r\nimport { createFileEditReplaceStringTool } from \"@/node/services/tools/file_edit_replace_string\";\r\n// DISABLED: import { createFileEditReplaceLinesTool } from \"@/node/services/tools/file_edit_replace_lines\";\r\nimport { createFileEditInsertTool } from \"@/node/services/tools/file_edit_insert\";\r\nimport { createAskUserQuestionTool } from \"@/node/services/tools/ask_user_question\";\r\nimport { createProposePlanTool } from \"@/node/services/tools/propose_plan\";\r\nimport { createTodoWriteTool, createTodoReadTool } from \"@/node/services/tools/todo\";\r\nimport { createStatusSetTool } from \"@/node/services/tools/status_set\";\r\nimport { createNotifyTool } from \"@/node/services/tools/notify\";\r\nimport { createTaskTool } from \"@/node/services/tools/task\";\r\nimport { createTaskApplyGitPatchTool } from \"@/node/services/tools/task_apply_git_patch\";\r\nimport { createTaskAwaitTool } from \"@/node/services/tools/task_await\";\r\nimport { createTaskTerminateTool } from \"@/node/services/tools/task_terminate\";\r\nimport { createTaskListTool } from \"@/node/services/tools/task_list\";\r\nimport { createAgentSkillReadTool } from \"@/node/services/tools/agent_skill_read\";\r\nimport { createAgentSkillReadFileTool } from \"@/node/services/tools/agent_skill_read_file\";\r\nimport { createMuxGlobalAgentsReadTool } from \"@/node/services/tools/mux_global_agents_read\";\r\nimport { createMuxGlobalAgentsWriteTool } from \"@/node/services/tools/mux_global_agents_write\";\r\nimport { createAgentReportTool } from \"@/node/services/tools/agent_report\";\r\nimport { createSystem1KeepRangesTool } from \"@/node/services/tools/system1_keep_ranges\";\r\nimport { wrapWithInitWait } from \"@/node/services/tools/wrapWithInitWait\";\r\nimport { withHooks, type HookConfig } from \"@/node/services/tools/withHooks\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { attachModelOnlyToolNotifications } from \"@/common/utils/tools/internalToolResultFields\";\r\nimport { NotificationEngine } from \"@/node/services/agentNotifications/NotificationEngine\";\r\nimport { TodoListReminderSource } from \"@/node/services/agentNotifications/sources/TodoListReminderSource\";\r\nimport { getAvailableTools } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { sanitizeMCPToolsForOpenAI } from \"@/common/utils/tools/schemaSanitizer\";\r\n\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport type { TaskService } from \"@/node/services/taskService\";\r\nimport type { WorkspaceChatMessage } from \"@/common/orpc/types\";\r\nimport type { FileState } from \"@/node/services/agentSession\";\r\nimport type { AgentDefinitionDescriptor } from \"@/common/types/agentDefinition\";\r\nimport type { AgentSkillDescriptor } from \"@/common/types/agentSkill\";\r\n\r\n/**\r\n * Configuration for tools that need runtime context\r\n */\r\nexport interface ToolConfiguration {\r\n  /** Working directory for command execution - actual path in runtime's context (local or remote) */\r\n  cwd: string;\r\n  /** Runtime environment for executing commands and file operations */\r\n  runtime: Runtime;\r\n  /** Environment secrets to inject (optional) */\r\n  secrets?: Record<string, string>;\r\n  /** MUX_ environment variables (MUX_PROJECT_PATH, MUX_RUNTIME) - set from init hook env */\r\n  muxEnv?: Record<string, string>;\r\n  /** Temporary directory for tool outputs in runtime's context (local or remote) */\r\n  runtimeTempDir: string;\r\n  /** Overflow policy for bash tool output (optional, not exposed to AI) */\r\n  overflow_policy?: \"truncate\" | \"tmpfile\";\r\n  /** Background process manager for bash tool (optional, AI-only) */\r\n  backgroundProcessManager?: BackgroundProcessManager;\r\n  /** When true, restrict edits to the plan file (plan agent behavior). */\r\n  planFileOnly?: boolean;\r\n  /** Plan file path - only this file can be edited when planFileOnly is true. */\r\n  planFilePath?: string;\r\n  /**\r\n   * Optional callback for emitting UI-only workspace chat events.\r\n   * Used for streaming bash stdout/stderr to the UI without sending it to the model.\r\n   */\r\n  emitChatEvent?: (event: WorkspaceChatMessage) => void;\r\n  /** Workspace session directory (e.g. ~/.mux/sessions/<workspaceId>) for persistent tool state */\r\n  workspaceSessionDir?: string;\r\n  /** Workspace ID for tracking background processes and plan storage */\r\n  workspaceId?: string;\r\n  /** Callback to record file state for external edit detection (plan files) */\r\n  recordFileState?: (filePath: string, state: FileState) => void;\r\n  /** Task orchestration for sub-agent tasks */\r\n  taskService?: TaskService;\r\n  /** Enable agent_report tool (only valid for child task workspaces) */\r\n  enableAgentReport?: boolean;\r\n  /** Experiments inherited from parent (for subagent spawning) */\r\n  experiments?: {\r\n    programmaticToolCalling?: boolean;\r\n    programmaticToolCallingExclusive?: boolean;\r\n    execSubagentHardRestart?: boolean;\r\n  };\r\n  /** Available sub-agents for the task tool description (dynamic context) */\r\n  availableSubagents?: AgentDefinitionDescriptor[];\r\n  /** Available skills for the agent_skill_read tool description (dynamic context) */\r\n  availableSkills?: AgentSkillDescriptor[];\r\n}\r\n\r\n/**\r\n * Factory function interface for creating tools with configuration\r\n */\r\nexport type ToolFactory = (config: ToolConfiguration) => Tool;\r\n\r\n/**\r\n * Augment a tool's description with additional instructions from \"Tool: <name>\" sections\r\n * Mutates the base tool in place to append the instructions to its description.\r\n * This preserves any provider-specific metadata or internal state on the tool object.\r\n * @param baseTool The original tool to augment\r\n * @param additionalInstructions Additional instructions to append to the description\r\n * @returns The same tool instance with the augmented description\r\n */\r\nfunction augmentToolDescription(baseTool: Tool, additionalInstructions: string): Tool {\r\n  // Access the tool as a record to get its properties\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const baseToolRecord = baseTool as any as Record<string, unknown>;\r\n  const originalDescription =\r\n    typeof baseToolRecord.description === \"string\" ? baseToolRecord.description : \"\";\r\n  const augmentedDescription = `${originalDescription}\\n\\n${additionalInstructions}`;\r\n\r\n  // Mutate the description in place to preserve other properties (e.g. provider metadata)\r\n  baseToolRecord.description = augmentedDescription;\r\n\r\n  return baseTool;\r\n}\r\n\r\nfunction wrapToolExecuteWithModelOnlyNotifications(\r\n  toolName: string,\r\n  baseTool: Tool,\r\n  engine: NotificationEngine\r\n): Tool {\r\n  // Access the tool as a record to get its properties.\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const baseToolRecord = baseTool as any as Record<string, unknown>;\r\n  const originalExecute = baseToolRecord.execute;\r\n\r\n  if (typeof originalExecute !== \"function\") {\r\n    return baseTool;\r\n  }\r\n\r\n  const executeFn = originalExecute as (this: unknown, args: unknown, options: unknown) => unknown;\r\n\r\n  // Avoid mutating cached tools in place (e.g. MCP tools cached per workspace).\r\n  // Repeated getToolsForModel() calls should not stack wrappers.\r\n  const wrappedTool = cloneToolPreservingDescriptors(baseTool);\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const wrappedToolRecord = wrappedTool as any as Record<string, unknown>;\r\n\r\n  wrappedToolRecord.execute = async (args: unknown, options: unknown) => {\r\n    try {\r\n      const result: unknown = await executeFn.call(baseTool, args, options);\r\n\r\n      let notifications: string[] = [];\r\n      try {\r\n        notifications = await engine.pollAfterToolCall({\r\n          toolName,\r\n          toolSucceeded: true,\r\n          now: Date.now(),\r\n        });\r\n      } catch (error) {\r\n        log.debug(\"[getToolsForModel] notification poll failed\", { error, toolName });\r\n      }\r\n\r\n      return attachModelOnlyToolNotifications(result, notifications);\r\n    } catch (error) {\r\n      try {\r\n        await engine.pollAfterToolCall({\r\n          toolName,\r\n          toolSucceeded: false,\r\n          now: Date.now(),\r\n        });\r\n      } catch (pollError) {\r\n        log.debug(\"[getToolsForModel] notification poll failed\", { pollError, toolName });\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  return wrappedTool;\r\n}\r\n\r\nfunction wrapToolsWithModelOnlyNotifications(\r\n  tools: Record<string, Tool>,\r\n  config: ToolConfiguration\r\n): Record<string, Tool> {\r\n  if (!config.workspaceSessionDir) {\r\n    return tools;\r\n  }\r\n\r\n  const engine = new NotificationEngine([\r\n    new TodoListReminderSource({ workspaceSessionDir: config.workspaceSessionDir }),\r\n  ]);\r\n\r\n  const wrappedTools: Record<string, Tool> = {};\r\n  for (const [toolName, tool] of Object.entries(tools)) {\r\n    wrappedTools[toolName] = wrapToolExecuteWithModelOnlyNotifications(toolName, tool, engine);\r\n  }\r\n\r\n  return wrappedTools;\r\n}\r\n\r\n/**\r\n * Wrap tools with hook support.\r\n *\r\n * If any of these exist, each tool execution is wrapped:\r\n * - `.mux/tool_pre` (pre-hook)\r\n * - `.mux/tool_post` (post-hook)\r\n * - `.mux/tool_hook` (legacy pre+post)\r\n */\r\nfunction wrapToolsWithHooks(\r\n  tools: Record<string, Tool>,\r\n  config: ToolConfiguration\r\n): Record<string, Tool> {\r\n  // Hooks require workspaceId, cwd, and runtime\r\n  if (!config.workspaceId || !config.cwd || !config.runtime) {\r\n    return tools;\r\n  }\r\n\r\n  const hookConfig: HookConfig = {\r\n    runtime: config.runtime,\r\n    cwd: config.cwd,\r\n    runtimeTempDir: config.runtimeTempDir,\r\n    workspaceId: config.workspaceId,\r\n    // Match bash tool behavior: muxEnv is present and secrets override it.\r\n    env: {\r\n      ...(config.muxEnv ?? {}),\r\n      ...(config.secrets ?? {}),\r\n    },\r\n  };\r\n\r\n  const wrappedTools: Record<string, Tool> = {};\r\n  for (const [toolName, tool] of Object.entries(tools)) {\r\n    wrappedTools[toolName] = withHooks(toolName, tool, hookConfig);\r\n  }\r\n\r\n  return wrappedTools;\r\n}\r\n\r\n/**\r\n * Get tools available for a specific model with configuration\r\n *\r\n * Providers are lazy-loaded to reduce startup time. AI SDK providers are only\r\n * imported when actually needed for a specific model.\r\n *\r\n * @param modelString The model string in format \"provider:model-id\"\r\n * @param config Required configuration for tools\r\n * @param workspaceId Workspace ID for init state tracking (required for runtime tools)\r\n * @param initStateManager Init state manager for runtime tools to wait for initialization\r\n * @param toolInstructions Optional map of tool names to additional instructions from \"Tool: <name>\" sections\r\n * @returns Promise resolving to record of tools available for the model\r\n */\r\nexport async function getToolsForModel(\r\n  modelString: string,\r\n  config: ToolConfiguration,\r\n  workspaceId: string,\r\n  initStateManager: InitStateManager,\r\n  toolInstructions?: Record<string, string>,\r\n  mcpTools?: Record<string, Tool>\r\n): Promise<Record<string, Tool>> {\r\n  const [provider, modelId] = modelString.split(\":\");\r\n\r\n  // Helper to reduce repetition when wrapping runtime tools\r\n  const wrap = <TParameters, TResult>(tool: Tool<TParameters, TResult>) =>\r\n    wrapWithInitWait(tool, workspaceId, initStateManager);\r\n\r\n  // Lazy-load web_fetch to avoid loading jsdom (ESM-only) at Jest setup time\r\n  // This allows integration tests to run without transforming jsdom's dependencies\r\n  const { createWebFetchTool } = await import(\"@/node/services/tools/web_fetch\");\r\n\r\n  // Runtime-dependent tools need to wait for workspace initialization\r\n  // Wrap them to handle init waiting centrally instead of in each tool\r\n  const runtimeTools: Record<string, Tool> = {\r\n    file_read: wrap(createFileReadTool(config)),\r\n    agent_skill_read: wrap(createAgentSkillReadTool(config)),\r\n    agent_skill_read_file: wrap(createAgentSkillReadFileTool(config)),\r\n    file_edit_replace_string: wrap(createFileEditReplaceStringTool(config)),\r\n    file_edit_insert: wrap(createFileEditInsertTool(config)),\r\n    // DISABLED: file_edit_replace_lines - causes models (particularly GPT-5-Codex)\r\n    // to leave repository in broken state due to issues with concurrent file modifications\r\n    // and line number miscalculations. Use file_edit_replace_string instead.\r\n    // file_edit_replace_lines: wrap(createFileEditReplaceLinesTool(config)),\r\n\r\n    // Sub-agent task orchestration (child workspaces)\r\n    task: wrap(createTaskTool(config)),\r\n    task_await: wrap(createTaskAwaitTool(config)),\r\n    task_apply_git_patch: wrap(createTaskApplyGitPatchTool(config)),\r\n    task_terminate: wrap(createTaskTerminateTool(config)),\r\n    task_list: wrap(createTaskListTool(config)),\r\n\r\n    // Bash execution (foreground/background). Manage background output via task_await/task_list/task_terminate.\r\n    bash: wrap(createBashTool(config)),\r\n\r\n    // Legacy bash process tools (deprecated)\r\n    bash_output: wrap(createBashOutputTool(config)),\r\n    bash_background_list: wrap(createBashBackgroundListTool(config)),\r\n    bash_background_terminate: wrap(createBashBackgroundTerminateTool(config)),\r\n\r\n    web_fetch: wrap(createWebFetchTool(config)),\r\n  };\r\n\r\n  // Non-runtime tools execute immediately (no init wait needed)\r\n  // Note: Tool availability is controlled by agent tool policy (allowlist), not mode checks here.\r\n  const nonRuntimeTools: Record<string, Tool> = {\r\n    mux_global_agents_read: createMuxGlobalAgentsReadTool(config),\r\n    mux_global_agents_write: createMuxGlobalAgentsWriteTool(config),\r\n    ask_user_question: createAskUserQuestionTool(config),\r\n    propose_plan: createProposePlanTool(config),\r\n    ...(config.enableAgentReport ? { agent_report: createAgentReportTool(config) } : {}),\r\n    system1_keep_ranges: createSystem1KeepRangesTool(config),\r\n    todo_write: createTodoWriteTool(config),\r\n    todo_read: createTodoReadTool(config),\r\n    status_set: createStatusSetTool(config),\r\n    notify: createNotifyTool(config),\r\n  };\r\n\r\n  // Base tools available for all models\r\n  const baseTools: Record<string, Tool> = {\r\n    ...runtimeTools,\r\n    ...nonRuntimeTools,\r\n  };\r\n\r\n  // Try to add provider-specific web search tools if available\r\n  // Lazy-load providers to avoid loading all AI SDKs at startup\r\n  let allTools = { ...baseTools, ...(mcpTools ?? {}) };\r\n  try {\r\n    switch (provider) {\r\n      case \"anthropic\": {\r\n        const { anthropic } = await import(\"@ai-sdk/anthropic\");\r\n        allTools = {\r\n          ...baseTools,\r\n          ...(mcpTools ?? {}),\r\n          // Provider-specific tool types are compatible with Tool at runtime\r\n          web_search: anthropic.tools.webSearch_20250305({ maxUses: 1000 }) as Tool,\r\n        };\r\n        break;\r\n      }\r\n\r\n      case \"openai\": {\r\n        // Sanitize MCP tools for OpenAI's stricter JSON Schema validation.\r\n        // OpenAI's Responses API doesn't support certain schema properties like\r\n        // minLength, maximum, default, etc. that are valid JSON Schema but not\r\n        // accepted by OpenAI's Structured Outputs implementation.\r\n        const sanitizedMcpTools = mcpTools ? sanitizeMCPToolsForOpenAI(mcpTools) : {};\r\n\r\n        // Only add web search for models that support it\r\n        if (modelId.includes(\"gpt-5\") || modelId.includes(\"gpt-4\")) {\r\n          const { openai } = await import(\"@ai-sdk/openai\");\r\n          allTools = {\r\n            ...baseTools,\r\n            ...sanitizedMcpTools,\r\n            // Provider-specific tool types are compatible with Tool at runtime\r\n            web_search: openai.tools.webSearch({\r\n              searchContextSize: \"high\",\r\n            }) as Tool,\r\n          };\r\n        } else {\r\n          // For other OpenAI models (o1, o3, etc.), still use sanitized MCP tools\r\n          allTools = {\r\n            ...baseTools,\r\n            ...sanitizedMcpTools,\r\n          };\r\n        }\r\n        break;\r\n      }\r\n\r\n      // Note: Gemini 3 tool support:\r\n      // Combining native tools with function calling is currently only\r\n      // supported in the Live API. Thus no `google_search` or `url_context` added here.\r\n      // - https://ai.google.dev/gemini-api/docs/function-calling?example=meeting#native-tools\r\n    }\r\n  } catch (error) {\r\n    // If tools aren't available, just use base tools\r\n    log.error(`No web search tools available for ${provider}:`, error);\r\n  }\r\n\r\n  // Filter tools to the canonical allowlist so system prompt + toolset stay in sync.\r\n  // Include MCP tools even if they're not in getAvailableTools().\r\n  const allowlistedToolNames = new Set(\r\n    getAvailableTools(modelString, {\r\n      enableAgentReport: config.enableAgentReport,\r\n      enableMuxGlobalAgentsTools: workspaceId === MUX_HELP_CHAT_WORKSPACE_ID,\r\n    })\r\n  );\r\n  for (const toolName of Object.keys(mcpTools ?? {})) {\r\n    allowlistedToolNames.add(toolName);\r\n  }\r\n\r\n  allTools = Object.fromEntries(\r\n    Object.entries(allTools).filter(([toolName]) => allowlistedToolNames.has(toolName))\r\n  );\r\n\r\n  let finalTools = allTools;\r\n  // Apply tool-specific instructions if provided\r\n  if (toolInstructions) {\r\n    const augmentedTools: Record<string, Tool> = {};\r\n    for (const [toolName, baseTool] of Object.entries(allTools)) {\r\n      const instructions = toolInstructions[toolName];\r\n      if (instructions) {\r\n        augmentedTools[toolName] = augmentToolDescription(baseTool, instructions);\r\n      } else {\r\n        augmentedTools[toolName] = baseTool;\r\n      }\r\n    }\r\n    finalTools = augmentedTools;\r\n  }\r\n\r\n  // Apply hook wrapping first (hooks wrap each tool execution)\r\n  finalTools = wrapToolsWithHooks(finalTools, config);\r\n\r\n  // Then apply model-only notifications (adds notifications to results)\r\n  finalTools = wrapToolsWithModelOnlyNotifications(finalTools, config);\r\n\r\n  return finalTools;\r\n}\r\n"]}