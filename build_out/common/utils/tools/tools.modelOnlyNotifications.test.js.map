{"version":3,"file":"tools.modelOnlyNotifications.test.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/tools.modelOnlyNotifications.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\nimport type { Tool } from \"ai\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\nimport { setTodosForSessionDir } from \"@/node/services/tools/todo\";\n\nimport { MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD } from \"./internalToolResultFields\";\nimport { getToolsForModel } from \"./tools\";\n\ntype ToolExecuteFn = (args?: unknown, options?: unknown) => Promise<unknown>;\n\nfunction getExecute(tool: unknown): ToolExecuteFn {\n  if (!tool || typeof tool !== \"object\" || !(\"execute\" in tool)) {\n    throw new Error(\"Tool is missing execute()\");\n  }\n\n  const execute = (tool as { execute?: unknown }).execute;\n  if (typeof execute !== \"function\") {\n    throw new Error(\"Tool execute() is not a function\");\n  }\n\n  return execute as ToolExecuteFn;\n}\n\nfunction asRecord(value: unknown): Record<string, unknown> {\n  if (!value || typeof value !== \"object\" || Array.isArray(value)) {\n    throw new Error(\"Expected a plain object tool result\");\n  }\n\n  return value as Record<string, unknown>;\n}\n\ndescribe(\"getToolsForModel - model-only notifications\", () => {\n  test(\"injects __mux_notifications into tool results after 5 tool calls\", async () => {\n    const workspaceSessionDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-ws-\"));\n\n    try {\n      await setTodosForSessionDir(\"ws-1\", workspaceSessionDir, [\n        { content: \"Completed\", status: \"completed\" },\n        { content: \"In progress\", status: \"in_progress\" },\n        { content: \"Pending\", status: \"pending\" },\n      ]);\n\n      const runtime = new LocalRuntime(process.cwd());\n      const initStateManager = {\n        waitForInit: () => Promise.resolve(),\n      } as unknown as InitStateManager;\n\n      const tools = await getToolsForModel(\n        \"noop:model\",\n        {\n          cwd: process.cwd(),\n          runtime,\n          runtimeTempDir: \"/tmp\",\n          workspaceSessionDir,\n        },\n        \"ws-1\",\n        initStateManager\n      );\n\n      const todoReadExecute = getExecute(tools.todo_read);\n\n      for (let i = 0; i < 4; i += 1) {\n        const result = asRecord(await todoReadExecute());\n        expect(MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD in result).toBe(false);\n      }\n\n      const fifth = asRecord(await todoReadExecute());\n      expect(Array.isArray(fifth[MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD])).toBe(true);\n      expect(String((fifth[MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD] as unknown[])[0])).toContain(\n        \"Current TODO List\"\n      );\n    } finally {\n      await fs.rm(workspaceSessionDir, { recursive: true, force: true });\n    }\n  });\n\n  test(\"does not re-wrap cached MCP tools across getToolsForModel() calls\", async () => {\n    const workspaceSessionDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-ws-\"));\n\n    try {\n      await setTodosForSessionDir(\"ws-1\", workspaceSessionDir, [\n        { content: \"In progress\", status: \"in_progress\" },\n      ]);\n\n      const runtime = new LocalRuntime(process.cwd());\n      const initStateManager = {\n        waitForInit: () => Promise.resolve(),\n      } as unknown as InitStateManager;\n\n      const cachedMcpTool = {\n        // eslint-disable-next-line @typescript-eslint/require-await\n        execute: async () => ({ ok: true }),\n      } as unknown as Tool;\n\n      const tools1 = await getToolsForModel(\n        \"noop:model\",\n        {\n          cwd: process.cwd(),\n          runtime,\n          runtimeTempDir: \"/tmp\",\n          workspaceSessionDir,\n        },\n        \"ws-1\",\n        initStateManager,\n        undefined,\n        { mcp_dummy: cachedMcpTool }\n      );\n\n      const execute1 = getExecute(tools1.mcp_dummy);\n      for (let i = 0; i < 4; i += 1) {\n        const result = asRecord(await execute1());\n        expect(MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD in result).toBe(false);\n      }\n\n      const tools2 = await getToolsForModel(\n        \"noop:model\",\n        {\n          cwd: process.cwd(),\n          runtime,\n          runtimeTempDir: \"/tmp\",\n          workspaceSessionDir,\n        },\n        \"ws-1\",\n        initStateManager,\n        undefined,\n        { mcp_dummy: cachedMcpTool }\n      );\n\n      const execute2 = getExecute(tools2.mcp_dummy);\n      for (let i = 0; i < 4; i += 1) {\n        const result = asRecord(await execute2());\n        expect(MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD in result).toBe(false);\n      }\n\n      const fifth = asRecord(await execute2());\n      expect(Array.isArray(fifth[MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD])).toBe(true);\n    } finally {\n      await fs.rm(workspaceSessionDir, { recursive: true, force: true });\n    }\n  });\n\n  test(\"does not enable notification injection when workspaceSessionDir is missing\", async () => {\n    const runtime = new LocalRuntime(process.cwd());\n    const initStateManager = {\n      waitForInit: () => Promise.resolve(),\n    } as unknown as InitStateManager;\n\n    const dummyTool = {\n      // eslint-disable-next-line @typescript-eslint/require-await\n      execute: async () => ({ ok: true }),\n    } as unknown as Tool;\n\n    const tools = await getToolsForModel(\n      \"noop:model\",\n      {\n        cwd: process.cwd(),\n        runtime,\n        runtimeTempDir: \"/tmp\",\n      },\n      \"ws-1\",\n      initStateManager,\n      undefined,\n      { dummy: dummyTool }\n    );\n\n    const dummyExecute = getExecute(tools.dummy);\n\n    for (let i = 0; i < 5; i += 1) {\n      const result = asRecord(await dummyExecute());\n      expect(MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD in result).toBe(false);\n    }\n  });\n\n  test(\"only attaches notifications to plain-object tool results\", async () => {\n    const workspaceSessionDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-ws-\"));\n\n    try {\n      await setTodosForSessionDir(\"ws-1\", workspaceSessionDir, [\n        { content: \"In progress\", status: \"in_progress\" },\n      ]);\n\n      const runtime = new LocalRuntime(process.cwd());\n      const initStateManager = {\n        waitForInit: () => Promise.resolve(),\n      } as unknown as InitStateManager;\n\n      const stringTool = {\n        // eslint-disable-next-line @typescript-eslint/require-await\n        execute: async () => \"ok\",\n      } as unknown as Tool;\n\n      const tools = await getToolsForModel(\n        \"noop:model\",\n        {\n          cwd: process.cwd(),\n          runtime,\n          runtimeTempDir: \"/tmp\",\n          workspaceSessionDir,\n        },\n        \"ws-1\",\n        initStateManager,\n        undefined,\n        { string_tool: stringTool }\n      );\n\n      const stringExecute = getExecute(tools.string_tool);\n      const todoReadExecute = getExecute(tools.todo_read);\n\n      for (let i = 0; i < 4; i += 1) {\n        const result = await stringExecute();\n        expect(result).toBe(\"ok\");\n      }\n\n      const fifth = asRecord(await todoReadExecute());\n      expect(Array.isArray(fifth[MODEL_ONLY_TOOL_NOTIFICATIONS_FIELD])).toBe(true);\n    } finally {\n      await fs.rm(workspaceSessionDir, { recursive: true, force: true });\n    }\n  });\n});\n"]}