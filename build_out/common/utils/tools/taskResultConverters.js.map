{"version":3,"file":"taskResultConverters.js","sourceRoot":"","sources":["../../../../src/common/utils/tools/taskResultConverters.ts"],"names":[],"mappings":"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","sourcesContent":["// Shared helpers for coercing / converting tool results.\n//\n// These are primarily used by the mobile renderer, which needs to display tool calls\n// that may have been produced by older Mux versions.\n\nimport type { BashToolResult, TaskToolResult } from \"@/common/types/tools\";\n\nconst BASH_TASK_ID_PREFIX = \"bash:\";\n\nfunction fromBashTaskId(taskId: string): string | null {\n  if (typeof taskId !== \"string\") {\n    return null;\n  }\n\n  if (!taskId.startsWith(BASH_TASK_ID_PREFIX)) {\n    return null;\n  }\n\n  const processId = taskId.slice(BASH_TASK_ID_PREFIX.length).trim();\n  return processId.length > 0 ? processId : null;\n}\n\nexport function coerceBashToolResult(value: unknown): BashToolResult | null {\n  if (!value || typeof value !== \"object\") {\n    return null;\n  }\n\n  const success = (value as { success?: unknown }).success;\n  if (typeof success !== \"boolean\") {\n    return null;\n  }\n\n  if (success) {\n    const output = (value as { output?: unknown }).output;\n    const exitCode = (value as { exitCode?: unknown }).exitCode;\n    const wallDurationMs = (value as { wall_duration_ms?: unknown }).wall_duration_ms;\n\n    if (typeof output !== \"string\") {\n      return null;\n    }\n\n    if (exitCode !== 0) {\n      return null;\n    }\n\n    if (typeof wallDurationMs !== \"number\" || !Number.isFinite(wallDurationMs)) {\n      return null;\n    }\n\n    // Background spawn success includes taskId/backgroundProcessId.\n    // Older histories sometimes stored only one of these fields, so we derive the\n    // other when possible.\n    const taskIdRaw = (value as { taskId?: unknown }).taskId;\n    const backgroundProcessIdRaw = (value as { backgroundProcessId?: unknown }).backgroundProcessId;\n\n    if (taskIdRaw === undefined && backgroundProcessIdRaw === undefined) {\n      return value as BashToolResult;\n    }\n\n    if (typeof taskIdRaw === \"string\" && typeof backgroundProcessIdRaw === \"string\") {\n      return value as BashToolResult;\n    }\n\n    if (typeof backgroundProcessIdRaw === \"string\" && taskIdRaw === undefined) {\n      const processId = backgroundProcessIdRaw.trim();\n      if (processId.length === 0) {\n        return null;\n      }\n\n      const derived: BashToolResult = {\n        success: true,\n        output,\n        exitCode: 0,\n        wall_duration_ms: wallDurationMs,\n        taskId: `${BASH_TASK_ID_PREFIX}${processId}`,\n        backgroundProcessId: processId,\n      };\n\n      return derived;\n    }\n\n    if (typeof taskIdRaw === \"string\" && backgroundProcessIdRaw === undefined) {\n      const processId = fromBashTaskId(taskIdRaw);\n      if (!processId) {\n        return null;\n      }\n\n      const derived: BashToolResult = {\n        success: true,\n        output,\n        exitCode: 0,\n        wall_duration_ms: wallDurationMs,\n        taskId: taskIdRaw,\n        backgroundProcessId: processId,\n      };\n\n      return derived;\n    }\n\n    return null;\n  }\n\n  const error = (value as { error?: unknown }).error;\n  const exitCode = (value as { exitCode?: unknown }).exitCode;\n  const wallDurationMs = (value as { wall_duration_ms?: unknown }).wall_duration_ms;\n  const output = (value as { output?: unknown }).output;\n\n  if (typeof error !== \"string\") {\n    return null;\n  }\n\n  if (typeof exitCode !== \"number\" || !Number.isFinite(exitCode)) {\n    return null;\n  }\n\n  if (typeof wallDurationMs !== \"number\" || !Number.isFinite(wallDurationMs)) {\n    return null;\n  }\n\n  if (output !== undefined && typeof output !== \"string\") {\n    return null;\n  }\n\n  return value as BashToolResult;\n}\n\nfunction maybeApplyLegacySuccessCheck(\n  bashResult: BashToolResult,\n  options?: { legacySuccessCheckInclErrorLine?: boolean }\n): BashToolResult {\n  if (!options?.legacySuccessCheckInclErrorLine) {\n    return bashResult;\n  }\n\n  if (!bashResult.success) {\n    return bashResult;\n  }\n\n  // Don't drop background task identifiers.\n  if (\"taskId\" in bashResult) {\n    return bashResult;\n  }\n\n  const lines = bashResult.output.split(/\\r?\\n/).map((line) => line.trim());\n  const errorLine = lines.find((line) => /^error:/i.test(line));\n  if (!errorLine) {\n    return bashResult;\n  }\n\n  return {\n    success: false,\n    error: errorLine,\n    exitCode: 1,\n    wall_duration_ms: bashResult.wall_duration_ms,\n    output: bashResult.output,\n    truncated: \"truncated\" in bashResult ? bashResult.truncated : undefined,\n    note: \"note\" in bashResult ? bashResult.note : undefined,\n  };\n}\n\nexport function convertTaskBashResult(\n  taskResult: TaskToolResult | null,\n  options?: { legacySuccessCheckInclErrorLine?: boolean }\n): BashToolResult | null {\n  if (!taskResult || typeof taskResult !== \"object\") {\n    return null;\n  }\n\n  // Some historical `task(kind=\"bash\")` tool calls stored the raw BashToolResult.\n  const maybeDirect = coerceBashToolResult(taskResult);\n  if (maybeDirect) {\n    return maybeApplyLegacySuccessCheck(maybeDirect, options);\n  }\n\n  // Task tool error shape: { success: false, error }\n  if ((taskResult as { success?: unknown }).success === false) {\n    const error = (taskResult as { error?: unknown }).error;\n    return {\n      success: false,\n      error: typeof error === \"string\" ? error : \"Task failed\",\n      exitCode: -1,\n      wall_duration_ms: 0,\n    };\n  }\n\n  // Task tool success shapes: { status: \"queued\"|\"running\"|\"completed\", ... }\n  const status = (taskResult as { status?: unknown }).status;\n  if (typeof status !== \"string\") {\n    return null;\n  }\n\n  if (status === \"queued\" || status === \"running\") {\n    const taskId = (taskResult as { taskId?: unknown }).taskId;\n    if (typeof taskId !== \"string\") {\n      return null;\n    }\n\n    const processId = fromBashTaskId(taskId);\n    if (!processId) {\n      return null;\n    }\n\n    return {\n      success: true,\n      output: `Background process started with ID: ${processId}`,\n      exitCode: 0,\n      wall_duration_ms: 0,\n      taskId,\n      backgroundProcessId: processId,\n    };\n  }\n\n  if (status === \"completed\") {\n    // Legacy `task(kind=\"bash\")` results sometimes store a nested bash result or explicit\n    // exit/error fields. Preserve them so old histories don't render failures as successes.\n    const nestedRaw =\n      (taskResult as { result?: unknown; bashResult?: unknown }).result ??\n      (taskResult as { bashResult?: unknown }).bashResult;\n\n    const nested = coerceBashToolResult(nestedRaw);\n    if (nested) {\n      return maybeApplyLegacySuccessCheck(nested, options);\n    }\n\n    const exitCodeRaw = (taskResult as { exitCode?: unknown }).exitCode;\n    const exitCode =\n      typeof exitCodeRaw === \"number\" && Number.isFinite(exitCodeRaw) ? exitCodeRaw : undefined;\n\n    const errorRaw = (taskResult as { error?: unknown }).error;\n    const error = typeof errorRaw === \"string\" ? errorRaw : undefined;\n\n    const wallDurationRaw = (taskResult as { wall_duration_ms?: unknown }).wall_duration_ms;\n    const wall_duration_ms =\n      typeof wallDurationRaw === \"number\" && Number.isFinite(wallDurationRaw) ? wallDurationRaw : 0;\n\n    const outputRaw = (taskResult as { output?: unknown }).output;\n    const reportMarkdown = (taskResult as { reportMarkdown?: unknown }).reportMarkdown;\n    const title = (taskResult as { title?: unknown }).title;\n\n    const output =\n      typeof outputRaw === \"string\"\n        ? outputRaw\n        : typeof reportMarkdown === \"string\" && reportMarkdown.trim().length > 0\n          ? reportMarkdown\n          : typeof title === \"string\"\n            ? title\n            : \"\";\n\n    if (exitCode !== undefined && exitCode !== 0) {\n      return {\n        success: false,\n        error: error?.trim().length ? error : `Command failed with exit code ${exitCode}`,\n        exitCode,\n        wall_duration_ms,\n        output: output.trim().length ? output : undefined,\n      };\n    }\n\n    if (error?.trim().length) {\n      return {\n        success: false,\n        error,\n        exitCode: exitCode ?? 1,\n        wall_duration_ms,\n        output: output.trim().length ? output : undefined,\n      };\n    }\n\n    return maybeApplyLegacySuccessCheck(\n      {\n        success: true,\n        output,\n        exitCode: 0,\n        wall_duration_ms,\n      },\n      options\n    );\n  }\n\n  return null;\n}\n"]}