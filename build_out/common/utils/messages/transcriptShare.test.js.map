{"version":3,"file":"transcriptShare.test.js","sourceRoot":"","sources":["../../../../src/common/utils/messages/transcriptShare.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport type { MuxMessage } from \"@/common/types/message\";\nimport { buildChatJsonlForSharing } from \"./transcriptShare\";\n\nfunction splitJsonlLines(jsonl: string): string[] {\n  return jsonl.split(\"\\n\").filter((line) => line.trim().length > 0);\n}\n\ndescribe(\"buildChatJsonlForSharing\", () => {\n  it(\"strips tool output and sets state to output-redacted when includeToolOutput=false\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"bash\",\n            state: \"output-available\",\n            input: { script: \"echo hi\" },\n            output: { success: true, output: \"hi\" },\n          },\n        ],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, { includeToolOutput: false });\n    expect(jsonl.endsWith(\"\\n\")).toBe(true);\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n    expect(part.type).toBe(\"dynamic-tool\");\n\n    if (part.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n\n    expect(part.state).toBe(\"output-redacted\");\n    expect(part).not.toHaveProperty(\"output\");\n\n    // Original messages should be unchanged (no mutation during stripping)\n    const originalPart = messages[0].parts[0];\n    if (originalPart.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n    expect(originalPart.state).toBe(\"output-available\");\n    expect(originalPart).toHaveProperty(\"output\");\n  });\n\n  it(\"strips nestedCalls output and sets nestedCalls state to output-redacted when includeToolOutput=false\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"code_execution\",\n            state: \"input-available\",\n            input: { code: \"console.log('hi')\" },\n            nestedCalls: [\n              {\n                toolCallId: \"nested-1\",\n                toolName: \"bash\",\n                input: { script: \"echo nested\" },\n                output: { success: true, output: \"nested\" },\n                state: \"output-available\",\n              },\n            ],\n          },\n        ],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, { includeToolOutput: false });\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n\n    if (part.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n\n    expect(part.state).toBe(\"input-available\");\n    expect(part.nestedCalls?.[0].state).toBe(\"output-redacted\");\n    expect(part.nestedCalls?.[0]).not.toHaveProperty(\"output\");\n\n    // Original nested call should still include output\n    const originalPart = messages[0].parts[0];\n    if (originalPart.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n    expect(originalPart.nestedCalls?.[0].state).toBe(\"output-available\");\n    expect(originalPart.nestedCalls?.[0]).toHaveProperty(\"output\");\n  });\n\n  it(\"leaves messages unchanged when includeToolOutput=true\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"bash\",\n            state: \"output-available\",\n            input: { script: \"echo hi\" },\n            output: { success: true, output: \"hi\" },\n            nestedCalls: [\n              {\n                toolCallId: \"nested-1\",\n                toolName: \"file_read\",\n                input: { file_path: \"/tmp/demo.txt\" },\n                output: { success: true, content: \"hello\" },\n                state: \"output-available\",\n              },\n            ],\n          },\n        ],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, { includeToolOutput: true });\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n\n    expect(parsed).toEqual(messages[0]);\n  });\n\n  it(\"inlines planContent into propose_plan tool output when planSnapshot matches\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"propose_plan\",\n            state: \"output-available\",\n            input: { title: \"My Plan\" },\n            output: { success: true, planPath: \"/tmp/plan.md\", message: \"Plan saved\" },\n          },\n        ],\n      },\n    ];\n\n    const planSnapshot = { path: \"/tmp/plan.md\", content: \"# My Plan\\n\\n- Step 1\" };\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: true,\n      planSnapshot,\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n\n    if (part.type !== \"dynamic-tool\" || part.state !== \"output-available\") {\n      throw new Error(\"Expected completed tool part\");\n    }\n\n    const output = part.output;\n    if (output === null || typeof output !== \"object\") {\n      throw new Error(\"Expected tool output object\");\n    }\n\n    expect((output as Record<string, unknown>).planContent).toBe(planSnapshot.content);\n\n    // Original messages should be unchanged (no mutation during injection)\n    const originalPart = messages[0].parts[0];\n    if (originalPart.type !== \"dynamic-tool\" || originalPart.state !== \"output-available\") {\n      throw new Error(\"Expected completed tool part\");\n    }\n\n    const originalOutput = originalPart.output;\n    if (originalOutput === null || typeof originalOutput !== \"object\") {\n      throw new Error(\"Expected tool output object\");\n    }\n\n    expect((originalOutput as Record<string, unknown>).planContent).toBeUndefined();\n  });\n\n  it(\"inlines planContent even when propose_plan planPath uses ~ but planSnapshot.path is resolved\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"propose_plan\",\n            state: \"output-available\",\n            input: { title: \"My Plan\" },\n            output: {\n              success: true,\n              planPath: \"~/.mux/plans/p/w.md\",\n              message: \"Plan saved\",\n            },\n          },\n        ],\n      },\n    ];\n\n    const planSnapshot = {\n      path: \"/home/user/.mux/plans/p/w.md\",\n      content: \"# My Plan\\n\\n- Step 1\",\n    };\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: true,\n      planSnapshot,\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n\n    if (part.type !== \"dynamic-tool\" || part.state !== \"output-available\") {\n      throw new Error(\"Expected completed tool part\");\n    }\n\n    const output = part.output;\n    if (output === null || typeof output !== \"object\") {\n      throw new Error(\"Expected tool output object\");\n    }\n\n    expect((output as Record<string, unknown>).planContent).toBe(planSnapshot.content);\n  });\n\n  it(\"inlines planContent even when propose_plan planPath uses Windows-style slashes\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"propose_plan\",\n            state: \"output-available\",\n            input: { title: \"My Plan\" },\n            output: {\n              success: true,\n              planPath: \"~\\\\.mux\\\\plans\\\\p\\\\w.md\",\n              message: \"Plan saved\",\n            },\n          },\n        ],\n      },\n    ];\n\n    const planSnapshot = {\n      path: \"C:\\\\Users\\\\user\\\\.mux\\\\plans\\\\p\\\\w.md\",\n      content: \"# My Plan\\n\\n- Step 1\",\n    };\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: true,\n      planSnapshot,\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n\n    if (part.type !== \"dynamic-tool\" || part.state !== \"output-available\") {\n      throw new Error(\"Expected completed tool part\");\n    }\n\n    const output = part.output;\n    if (output === null || typeof output !== \"object\") {\n      throw new Error(\"Expected tool output object\");\n    }\n\n    expect((output as Record<string, unknown>).planContent).toBe(planSnapshot.content);\n  });\n\n  it(\"inlines planContent even when planSnapshot.path differs from propose_plan planPath\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"propose_plan\",\n            state: \"output-available\",\n            input: { title: \"My Plan\" },\n            output: { success: true, planPath: \"/tmp/plan.md\", message: \"Plan saved\" },\n          },\n        ],\n      },\n    ];\n\n    const planSnapshot = {\n      path: \"/completely/different/plan.md\",\n      content: \"# My Plan\\n\\n- Step 1\",\n    };\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: true,\n      planSnapshot,\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n\n    if (part.type !== \"dynamic-tool\" || part.state !== \"output-available\") {\n      throw new Error(\"Expected completed tool part\");\n    }\n\n    const output = part.output;\n    if (output === null || typeof output !== \"object\") {\n      throw new Error(\"Expected tool output object\");\n    }\n\n    expect((output as Record<string, unknown>).planContent).toBe(planSnapshot.content);\n  });\n\n  it(\"preserves propose_plan output (with planContent) while stripping other tool outputs when includeToolOutput=false\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-plan\",\n            toolName: \"propose_plan\",\n            state: \"output-available\",\n            input: { title: \"My Plan\" },\n            output: { success: true, planPath: \"/tmp/plan.md\", message: \"Plan saved\" },\n          },\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-bash\",\n            toolName: \"bash\",\n            state: \"output-available\",\n            input: { script: \"echo hi\" },\n            output: { success: true, output: \"hi\" },\n          },\n        ],\n      },\n    ];\n\n    const planSnapshot = { path: \"/tmp/plan.md\", content: \"# My Plan\\n\\n- Step 1\" };\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: false,\n      planSnapshot,\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n\n    const planPart = parsed.parts[0];\n    if (planPart.type !== \"dynamic-tool\" || planPart.state !== \"output-available\") {\n      throw new Error(\"Expected completed propose_plan tool part\");\n    }\n\n    const planOutput = planPart.output;\n    if (planOutput === null || typeof planOutput !== \"object\") {\n      throw new Error(\"Expected propose_plan output object\");\n    }\n\n    expect((planOutput as Record<string, unknown>).planContent).toBe(planSnapshot.content);\n\n    const strippedPart = parsed.parts[1];\n    if (strippedPart.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n\n    expect(strippedPart.state).toBe(\"output-redacted\");\n    expect(strippedPart).not.toHaveProperty(\"output\");\n\n    // Original messages should be unchanged (no mutation during injection/stripping)\n    const originalPlanPart = messages[0].parts[0];\n    if (originalPlanPart.type !== \"dynamic-tool\" || originalPlanPart.state !== \"output-available\") {\n      throw new Error(\"Expected completed propose_plan tool part\");\n    }\n\n    const originalPlanOutput = originalPlanPart.output;\n    if (originalPlanOutput === null || typeof originalPlanOutput !== \"object\") {\n      throw new Error(\"Expected propose_plan output object\");\n    }\n\n    expect((originalPlanOutput as Record<string, unknown>).planContent).toBeUndefined();\n\n    const originalStrippedPart = messages[0].parts[1];\n    if (originalStrippedPart.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n\n    expect(originalStrippedPart.state).toBe(\"output-available\");\n    expect(originalStrippedPart).toHaveProperty(\"output\");\n  });\n  it(\"preserves task tool outputs while stripping other tool outputs when includeToolOutput=false\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-task\",\n            toolName: \"task\",\n            state: \"output-available\",\n            input: { prompt: \"Fix the bug\", title: \"Bug fix\" },\n            output: {\n              status: \"completed\",\n              taskId: \"task-123\",\n              reportMarkdown: \"## Report\\n\\nFixed the bug in foo.ts\",\n            },\n          },\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-bash\",\n            toolName: \"bash\",\n            state: \"output-available\",\n            input: { script: \"echo hi\" },\n            output: { success: true, output: \"hi\" },\n          },\n        ],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: false,\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n\n    // task output should be preserved\n    const taskPart = parsed.parts[0];\n    if (taskPart.type !== \"dynamic-tool\" || taskPart.state !== \"output-available\") {\n      throw new Error(\"Expected completed task tool part\");\n    }\n\n    const taskOutput = taskPart.output;\n    if (taskOutput === null || typeof taskOutput !== \"object\") {\n      throw new Error(\"Expected task output object\");\n    }\n\n    expect((taskOutput as Record<string, unknown>).reportMarkdown).toBe(\n      \"## Report\\n\\nFixed the bug in foo.ts\"\n    );\n\n    // bash output should be stripped\n    const strippedPart = parsed.parts[1];\n    if (strippedPart.type !== \"dynamic-tool\") {\n      throw new Error(\"Expected tool part\");\n    }\n\n    expect(strippedPart.state).toBe(\"output-redacted\");\n    expect(strippedPart).not.toHaveProperty(\"output\");\n  });\n\n  it(\"does not overwrite propose_plan planContent when already present\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"propose_plan\",\n            state: \"output-available\",\n            input: { title: \"My Plan\" },\n            output: {\n              success: true,\n              planPath: \"/tmp/plan.md\",\n              message: \"Plan saved\",\n              planContent: \"# Existing Plan\\n\\nDo the thing.\",\n            },\n          },\n        ],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, {\n      includeToolOutput: true,\n      planSnapshot: { path: \"/tmp/plan.md\", content: \"# New Plan\" },\n    });\n\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n    const part = parsed.parts[0];\n\n    if (part.type !== \"dynamic-tool\" || part.state !== \"output-available\") {\n      throw new Error(\"Expected completed tool part\");\n    }\n\n    const output = part.output;\n    if (output === null || typeof output !== \"object\") {\n      throw new Error(\"Expected tool output object\");\n    }\n\n    expect((output as Record<string, unknown>).planContent).toBe(\n      \"# Existing Plan\\n\\nDo the thing.\"\n    );\n  });\n\n  it(\"injects workspaceId into each message when provided\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"user-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"hello\" }],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, { workspaceId: \"ws-123\" });\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage & { workspaceId?: string };\n\n    expect(parsed.workspaceId).toBe(\"ws-123\");\n    expect((messages[0] as MuxMessage & { workspaceId?: string }).workspaceId).toBeUndefined();\n  });\n\n  it(\"returns empty string for empty messages array\", () => {\n    expect(buildChatJsonlForSharing([])).toBe(\"\");\n  });\n\n  it(\"merges adjacent text/reasoning parts to keep transcripts small\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [\n          { type: \"reasoning\", text: \"a\", timestamp: 1 },\n          { type: \"reasoning\", text: \"b\", timestamp: 2 },\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"tc-1\",\n            toolName: \"bash\",\n            state: \"input-available\",\n            input: { script: \"echo hi\" },\n          },\n          { type: \"text\", text: \"hello\", timestamp: 3 },\n          { type: \"text\", text: \" world\", timestamp: 4 },\n          { type: \"reasoning\", text: \"c\" },\n        ],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages, { includeToolOutput: true });\n    const parsed = JSON.parse(splitJsonlLines(jsonl)[0]) as MuxMessage;\n\n    expect(parsed.parts).toEqual([\n      { type: \"reasoning\", text: \"ab\", timestamp: 1 },\n      {\n        type: \"dynamic-tool\",\n        toolCallId: \"tc-1\",\n        toolName: \"bash\",\n        state: \"input-available\",\n        input: { script: \"echo hi\" },\n      },\n      { type: \"text\", text: \"hello world\", timestamp: 3 },\n      { type: \"reasoning\", text: \"c\" },\n    ]);\n\n    // Original messages should be unchanged (no mutation during compaction)\n    expect(messages[0].parts).toHaveLength(6);\n  });\n\n  it(\"produces valid JSONL (each line parses, trailing newline)\", () => {\n    const messages: MuxMessage[] = [\n      {\n        id: \"user-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"hello\" }],\n      },\n      {\n        id: \"assistant-1\",\n        role: \"assistant\",\n        parts: [{ type: \"text\", text: \"world\" }],\n      },\n    ];\n\n    const jsonl = buildChatJsonlForSharing(messages);\n    expect(jsonl.endsWith(\"\\n\")).toBe(true);\n\n    const lines = splitJsonlLines(jsonl);\n    expect(lines).toHaveLength(messages.length);\n\n    const parsed = lines.map((line) => JSON.parse(line) as MuxMessage);\n    expect(parsed).toEqual(messages);\n  });\n});\n"]}