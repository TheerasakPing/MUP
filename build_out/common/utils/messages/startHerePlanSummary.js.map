{"version":3,"file":"startHerePlanSummary.js","sourceRoot":"","sources":["../../../../src/common/utils/messages/startHerePlanSummary.ts"],"names":[],"mappings":";;;;AAEA,MAAM,gCAAgC,GAAG,2BAA2B,CAAC;AACrE,MAAM,kCAAkC,GAAG,iBAAiB,CAAC;AAE7D,SAAS,cAAc,CAAC,OAAmB,EAAU;IACnD,OAAO,CACL,OAAO,CAAC,KAAK;QACX,EAAE,MAAM,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,MAAM,CAAC;SACvC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC;SACxB,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,CACpB,CAAC;AAAA,CACH;AAED,SAAS,eAAe,CAAC,aAAqB,EAAU;IACtD,qFAAqF;IACrF,+BAA+B;IAC/B,MAAM,iBAAiB,GAAG,aAAa,CAAC,KAAK,CAAC,gCAAgC,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;IAEzF,0EAA0E;IAC1E,MAAM,2BAA2B,GAAG,iBAAiB,CAAC,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;IAE7E,iFAAiF;IACjF,iFAAiF;IACjF,0BAA0B;IAC1B,MAAM,eAAe,GAAG,2BAA2B,CAAC,OAAO,CACzD,uDAAuD,EACvD,EAAE,CACH,CAAC;IAEF,OAAO,eAAe,CAAC,IAAI,EAAE,CAAC;AAAA,CAC/B;AAED;;;;;;;GAOG;AACH,uCAA8C,OAAmB,EAAW;IAC1E,IAAI,OAAO,CAAC,IAAI,KAAK,WAAW;QAAE,OAAO,KAAK,CAAC;IAE/C,4EAA4E;IAC5E,iFAAiF;IACjF,IAAI,OAAO,CAAC,QAAQ,EAAE,SAAS,KAAK,MAAM;QAAE,OAAO,KAAK,CAAC;IACzD,IAAI,OAAO,CAAC,QAAQ,EAAE,OAAO,KAAK,MAAM;QAAE,OAAO,KAAK,CAAC;IAEvD,oFAAoF;IACpF,qFAAqF;IACrF,gDAAgD;IAChD,MAAM,IAAI,GAAG,cAAc,CAAC,OAAO,CAAC,CAAC;IACrC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,gCAAgC,CAAC;QAAE,OAAO,KAAK,CAAC;IAEnE,kFAAkF;IAClF,mFAAiF;IACjF,kFAAkF;IAClF,sCAAsC;IACtC,MAAM,QAAQ,GAAG,eAAe,CAAC,IAAI,CAAC,CAAC;IACvC,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,KAAK,CAAC;IACxC,IAAI,QAAQ,CAAC,UAAU,CAAC,kCAAkC,CAAC;QAAE,OAAO,KAAK,CAAC;IAE1E,OAAO,IAAI,CAAC;AAAA,CACb;AAED,iCAAwC,QAAsB,EAAW;IACvE,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;QAC9C,IAAI,6BAA6B,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;YAAE,OAAO,IAAI,CAAC;IAC9D,CAAC;IAED,OAAO,KAAK,CAAC;AAAA,CACd","sourcesContent":["import type { MuxMessage } from \"@/common/types/message\";\r\n\r\nconst START_HERE_PLAN_PATH_NOTE_MARKER = \"*Plan file preserved at:*\";\r\nconst START_HERE_PLAN_PLACEHOLDER_PREFIX = \"*Plan saved to \";\r\n\r\nfunction getTextContent(message: MuxMessage): string {\r\n  return (\r\n    message.parts\r\n      ?.filter((part) => part.type === \"text\")\r\n      .map((part) => part.text)\r\n      .join(\"\\n\") ?? \"\"\r\n  );\r\n}\r\n\r\nfunction getPlanBodyText(startHereText: string): string {\r\n  // The footer marker is the most stable, explicit signal that the ProposePlanToolCall\r\n  // Start Here summary was used.\r\n  const textWithoutFooter = startHereText.split(START_HERE_PLAN_PATH_NOTE_MARKER)[0] ?? \"\";\r\n\r\n  // The Start Here content always prefixes the plan with a single H1 title.\r\n  const textWithoutStartHereHeading = textWithoutFooter.replace(/^#.*\\n+/, \"\");\r\n\r\n  // ProposePlanToolCall adds a short note to discourage redundant plan-file reads.\r\n  // If the plan content was missing (placeholder-only), we don't want that note to\r\n  // cause a false positive.\r\n  const textWithoutNote = textWithoutStartHereHeading.replace(\r\n    /Note: This chat already contains the full plan[^\\n]*/g,\r\n    \"\"\r\n  );\r\n\r\n  return textWithoutNote.trim();\r\n}\r\n\r\n/**\r\n * The ProposePlanToolCall \"Start Here\" flow replaces chat history with a single\r\n * assistant message that contains the full plan and a plan-path footer.\r\n *\r\n * We detect that message so we can avoid re-injecting the plan (and avoid telling\r\n * the exec agent to re-read the plan file), which would waste tokens and often\r\n * results in redundant file reads.\r\n */\r\nexport function isStartHerePlanSummaryMessage(message: MuxMessage): boolean {\r\n  if (message.role !== \"assistant\") return false;\r\n\r\n  // The Start Here summary is stored as a user-compaction-style message so it\r\n  // survives history replacement and can be distinguished from normal plan output.\r\n  if (message.metadata?.compacted !== \"user\") return false;\r\n  if (message.metadata?.agentId !== \"plan\") return false;\r\n\r\n  // The Start Here id prefix isn't enough by itself, since Start Here can be used for\r\n  // arbitrary messages. The ProposePlanToolCall Start Here summary always includes the\r\n  // plan-path footer, which is a stronger signal.\r\n  const text = getTextContent(message);\r\n  if (!text.includes(START_HERE_PLAN_PATH_NOTE_MARKER)) return false;\r\n\r\n  // ProposePlanToolCall can render Start Here for results without embedded content.\r\n  // In that case, the \"plan\" body is just a placeholder like: \"*Plan saved to â€¦*\".\r\n  // We should *not* treat that as a full in-chat plan summary, otherwise exec won't\r\n  // get prompted to read the plan file.\r\n  const planBody = getPlanBodyText(text);\r\n  if (planBody.length === 0) return false;\r\n  if (planBody.startsWith(START_HERE_PLAN_PLACEHOLDER_PREFIX)) return false;\r\n\r\n  return true;\r\n}\r\n\r\nexport function hasStartHerePlanSummary(messages: MuxMessage[]): boolean {\r\n  for (let i = messages.length - 1; i >= 0; i--) {\r\n    if (isStartHerePlanSummaryMessage(messages[i])) return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n"]}