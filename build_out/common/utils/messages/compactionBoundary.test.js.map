{"version":3,"file":"compactionBoundary.test.js","sourceRoot":"","sources":["../../../../src/common/utils/messages/compactionBoundary.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\n\nimport { createMuxMessage } from \"@/common/types/message\";\n\nimport {\n  findLatestCompactionBoundaryIndex,\n  sliceMessagesFromLatestCompactionBoundary,\n} from \"./compactionBoundary\";\n\ndescribe(\"findLatestCompactionBoundaryIndex\", () => {\n  it(\"returns the newest compaction boundary via reverse scan\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-1\", \"assistant\", \"first summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"middle\"),\n      createMuxMessage(\"summary-2\", \"assistant\", \"second summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }),\n      createMuxMessage(\"u2\", \"user\", \"latest\"),\n    ];\n\n    expect(findLatestCompactionBoundaryIndex(messages)).toBe(3);\n  });\n\n  it(\"returns -1 when only legacy compacted summaries exist\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"legacy-summary\", \"assistant\", \"legacy summary\", {\n        compacted: \"user\",\n      }),\n      createMuxMessage(\"u1\", \"user\", \"after\"),\n    ];\n\n    expect(findLatestCompactionBoundaryIndex(messages)).toBe(-1);\n  });\n\n  it(\"ignores boundary markers that are missing compactionEpoch\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-valid\", \"assistant\", \"valid summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"middle\"),\n      createMuxMessage(\"summary-missing-epoch\", \"assistant\", \"malformed summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        // Corrupted/normalized persisted metadata: missing epoch must not be durable.\n      }),\n      createMuxMessage(\"u2\", \"user\", \"after\"),\n    ];\n\n    expect(findLatestCompactionBoundaryIndex(messages)).toBe(1);\n  });\n\n  it(\"skips malformed boundary markers and keeps scanning for the latest durable boundary\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-valid\", \"assistant\", \"valid summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"middle\"),\n      createMuxMessage(\"summary-malformed\", \"assistant\", \"malformed summary\", {\n        // Corrupted persisted metadata: looks like a boundary but is not a compacted summary.\n        compacted: false,\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }),\n      createMuxMessage(\"u2\", \"user\", \"after\"),\n    ];\n\n    expect(findLatestCompactionBoundaryIndex(messages)).toBe(1);\n  });\n  it(\"ignores boundary markers with malformed compacted values\", () => {\n    const malformedCompactedBoundary = createMuxMessage(\n      \"summary-malformed-compacted\",\n      \"assistant\",\n      \"malformed summary\",\n      {\n        compactionBoundary: true,\n        compactionEpoch: 99,\n      }\n    );\n    if (malformedCompactedBoundary.metadata) {\n      (malformedCompactedBoundary.metadata as Record<string, unknown>).compacted = \"corrupt\";\n    }\n\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-valid\", \"assistant\", \"valid summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      malformedCompactedBoundary,\n      createMuxMessage(\"u1\", \"user\", \"after\"),\n    ];\n\n    expect(findLatestCompactionBoundaryIndex(messages)).toBe(1);\n  });\n\n  it(\"ignores user-role messages with boundary-like metadata\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-valid\", \"assistant\", \"valid summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"not-a-summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }),\n      createMuxMessage(\"u2\", \"user\", \"after\"),\n    ];\n\n    expect(findLatestCompactionBoundaryIndex(messages)).toBe(1);\n  });\n});\n\ndescribe(\"sliceMessagesFromLatestCompactionBoundary\", () => {\n  it(\"slices request payload history from the latest compaction boundary\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-1\", \"assistant\", \"first summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"middle\"),\n      createMuxMessage(\"summary-2\", \"assistant\", \"second summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }),\n      createMuxMessage(\"u2\", \"user\", \"latest\"),\n      createMuxMessage(\"a2\", \"assistant\", \"reply\"),\n    ];\n\n    const sliced = sliceMessagesFromLatestCompactionBoundary(messages);\n\n    expect(sliced.map((msg) => msg.id)).toEqual([\"summary-2\", \"u2\", \"a2\"]);\n    expect(sliced[0]?.metadata?.compactionBoundary).toBe(true);\n  });\n\n  it(\"falls back to full history when no durable boundary exists\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"legacy-summary\", \"assistant\", \"legacy summary\", {\n        compacted: \"user\",\n      }),\n      createMuxMessage(\"u1\", \"user\", \"after\"),\n    ];\n\n    const sliced = sliceMessagesFromLatestCompactionBoundary(messages);\n\n    expect(sliced).toBe(messages);\n    expect(sliced.map((msg) => msg.id)).toEqual([\"u0\", \"legacy-summary\", \"u1\"]);\n  });\n\n  it(\"treats missing compactionEpoch boundary markers as non-boundaries\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-missing-epoch\", \"assistant\", \"malformed summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        // Schema normalization can drop malformed epochs to undefined.\n      }),\n      createMuxMessage(\"u1\", \"user\", \"after\"),\n    ];\n\n    const sliced = sliceMessagesFromLatestCompactionBoundary(messages);\n\n    expect(sliced).toBe(messages);\n    expect(sliced.map((msg) => msg.id)).toEqual([\"u0\", \"summary-missing-epoch\", \"u1\"]);\n  });\n\n  it(\"treats malformed compacted boundary markers as non-boundaries\", () => {\n    const malformedCompactedBoundary = createMuxMessage(\n      \"summary-malformed-compacted\",\n      \"assistant\",\n      \"malformed summary\",\n      {\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }\n    );\n    if (malformedCompactedBoundary.metadata) {\n      (malformedCompactedBoundary.metadata as Record<string, unknown>).compacted = \"corrupt\";\n    }\n\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      malformedCompactedBoundary,\n      createMuxMessage(\"u1\", \"user\", \"after\"),\n    ];\n\n    const sliced = sliceMessagesFromLatestCompactionBoundary(messages);\n\n    expect(sliced).toBe(messages);\n    expect(sliced.map((msg) => msg.id)).toEqual([\"u0\", \"summary-malformed-compacted\", \"u1\"]);\n  });\n\n  it(\"does not slice from user-role messages with boundary-like metadata\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-valid\", \"assistant\", \"valid summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"not-a-summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }),\n      createMuxMessage(\"a1\", \"assistant\", \"after\"),\n    ];\n\n    const sliced = sliceMessagesFromLatestCompactionBoundary(messages);\n\n    expect(sliced.map((msg) => msg.id)).toEqual([\"summary-valid\", \"u1\", \"a1\"]);\n    expect(sliced[0]?.id).toBe(\"summary-valid\");\n  });\n\n  it(\"treats malformed boundary markers as non-boundaries instead of crashing\", () => {\n    const messages = [\n      createMuxMessage(\"u0\", \"user\", \"before\"),\n      createMuxMessage(\"summary-malformed\", \"assistant\", \"malformed summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        // Corrupted persisted metadata: invalid epoch should not brick request assembly.\n        compactionEpoch: 0,\n      }),\n      createMuxMessage(\"u1\", \"user\", \"after\"),\n    ];\n\n    const sliced = sliceMessagesFromLatestCompactionBoundary(messages);\n\n    expect(sliced).toBe(messages);\n    expect(sliced.map((msg) => msg.id)).toEqual([\"u0\", \"summary-malformed\", \"u1\"]);\n  });\n});\n"]}