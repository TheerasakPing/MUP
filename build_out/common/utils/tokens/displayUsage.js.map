{"version":3,"file":"displayUsage.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/displayUsage.ts"],"names":[],"mappings":";AAAA;;;;;GAKG;;;AAGH,6CAA6C;AAI7C;;;;;GAKG;AACH,4BACE,KAAuC,EACvC,KAAa,EACb,gBAA0C,EAC1C,iBAAqC,EACP;IAC9B,IAAI,CAAC,KAAK;QAAE,OAAO,SAAS,CAAC;IAE7B,8EAA8E;IAC9E,iFAAiF;IACjF,kFAAkF;IAClF,2EAA2E;IAC3E,4DAA4D;IAC5D,MAAM,YAAY,GAAG,KAAK,CAAC,iBAAiB,IAAI,CAAC,CAAC;IAClD,MAAM,cAAc,GAAG,KAAK,CAAC,WAAW,IAAI,CAAC,CAAC;IAE9C,4EAA4E;IAC5E,2EAA2E;IAC3E,MAAM,iBAAiB,GACpB,gBAAgB,EAAE,SAA+D;QAChF,EAAE,wBAAwB,IAAI,CAAC,CAAC;IAEpC,gFAAgF;IAChF,oFAAoF;IACpF,gDAAgD;IAChD,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,cAAc,GAAG,YAAY,GAAG,iBAAiB,CAAC,CAAC;IAEnF,gFAAgF;IAChF,MAAM,eAAe,GACnB,KAAK,CAAC,eAAe;QACpB,gBAAgB,EAAE,MAAmD,EAAE,eAAe;QACvF,CAAC,CAAC;IAEJ,8CAA8C;IAC9C,MAAM,sBAAsB,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,YAAY,IAAI,CAAC,CAAC,GAAG,eAAe,CAAC,CAAC;IAExF,uCAAuC;IACvC,MAAM,UAAU,GAAG,IAAA,0BAAa,EAAC,KAAK,EAAE,iBAAiB,CAAC,CAAC;IAE3D,MAAM,aAAa,GAChB,gBAAgB,EAAE,GAA+C,EAAE,aAAa,KAAK,IAAI,CAAC;IAE7F,oEAAoE;IACpE,IAAI,SAA6B,CAAC;IAClC,IAAI,UAA8B,CAAC;IACnC,IAAI,eAAmC,CAAC;IACxC,IAAI,UAA8B,CAAC;IACnC,IAAI,aAAiC,CAAC;IAEtC,IAAI,UAAU,EAAE,CAAC;QACf,SAAS,GAAG,WAAW,GAAG,UAAU,CAAC,oBAAoB,CAAC;QAC1D,UAAU,GAAG,YAAY,GAAG,CAAC,UAAU,CAAC,2BAA2B,IAAI,CAAC,CAAC,CAAC;QAC1E,eAAe,GAAG,iBAAiB,GAAG,CAAC,UAAU,CAAC,+BAA+B,IAAI,CAAC,CAAC,CAAC;QACxF,UAAU,GAAG,sBAAsB,GAAG,UAAU,CAAC,qBAAqB,CAAC;QACvE,aAAa,GAAG,eAAe,GAAG,UAAU,CAAC,qBAAqB,CAAC;IACrE,CAAC;IAED,IAAI,aAAa,EAAE,CAAC;QAClB,SAAS,GAAG,CAAC,CAAC;QACd,UAAU,GAAG,CAAC,CAAC;QACf,eAAe,GAAG,CAAC,CAAC;QACpB,UAAU,GAAG,CAAC,CAAC;QACf,aAAa,GAAG,CAAC,CAAC;IACpB,CAAC;IACD,OAAO;QACL,KAAK,EAAE;YACL,MAAM,EAAE,WAAW;YACnB,QAAQ,EAAE,SAAS;SACpB;QACD,MAAM,EAAE;YACN,MAAM,EAAE,YAAY;YACpB,QAAQ,EAAE,UAAU;SACrB;QACD,WAAW,EAAE;YACX,MAAM,EAAE,iBAAiB;YACzB,QAAQ,EAAE,eAAe;SAC1B;QACD,MAAM,EAAE;YACN,MAAM,EAAE,sBAAsB;YAC9B,QAAQ,EAAE,UAAU;SACrB;QACD,SAAS,EAAE;YACT,MAAM,EAAE,eAAe;YACvB,QAAQ,EAAE,aAAa;SACxB;QACD,KAAK,EAAE,qCAAqC;KAC7C,CAAC;AAAA,CACH","sourcesContent":["/**\r\n * Display usage utilities for renderer\r\n *\r\n * IMPORTANT: This file must NOT import tokenizer to avoid pulling Node.js\r\n * dependencies into the renderer bundle.\r\n */\r\n\r\nimport type { LanguageModelV2Usage } from \"@ai-sdk/provider\";\r\nimport { getModelStats } from \"./modelStats\";\r\nimport type { CustomModelConfig } from \"@/common/types/project\";\r\nimport type { ChatUsageDisplay } from \"./usageAggregator\";\r\n\r\n/**\r\n * Create a display-friendly usage object from AI SDK usage\r\n *\r\n * This function transforms raw AI SDK usage data into a format suitable\r\n * for display in the UI. It does NOT require the tokenizer.\r\n */\r\nexport function createDisplayUsage(\r\n  usage: LanguageModelV2Usage | undefined,\r\n  model: string,\r\n  providerMetadata?: Record<string, unknown>,\r\n  customModelConfig?: CustomModelConfig\r\n): ChatUsageDisplay | undefined {\r\n  if (!usage) return undefined;\r\n\r\n  // AI SDK v6 unified semantics: ALL providers now report inputTokens INCLUSIVE\r\n  // of cached tokens. Previously Anthropic excluded cached tokens from inputTokens\r\n  // but v6 changed this to match OpenAI/Google (inputTokens = total input including\r\n  // cache_read + cache_write). We always subtract both cachedInputTokens and\r\n  // cacheCreateTokens to get the true non-cached input count.\r\n  const cachedTokens = usage.cachedInputTokens ?? 0;\r\n  const rawInputTokens = usage.inputTokens ?? 0;\r\n\r\n  // Extract cache creation tokens from provider metadata (Anthropic-specific)\r\n  // Needed before computing inputTokens since we subtract it from the total.\r\n  const cacheCreateTokens =\r\n    (providerMetadata?.anthropic as { cacheCreationInputTokens?: number } | undefined)\r\n      ?.cacheCreationInputTokens ?? 0;\r\n\r\n  // Subtract both cache-read and cache-create tokens to isolate non-cached input.\r\n  // Math.max guards against pre-v6 historical data where inputTokens already excluded\r\n  // cache tokens (subtraction would go negative).\r\n  const inputTokens = Math.max(0, rawInputTokens - cachedTokens - cacheCreateTokens);\r\n\r\n  // Extract reasoning tokens with fallback to provider metadata (OpenAI-specific)\r\n  const reasoningTokens =\r\n    usage.reasoningTokens ??\r\n    (providerMetadata?.openai as { reasoningTokens?: number } | undefined)?.reasoningTokens ??\r\n    0;\r\n\r\n  // Calculate output tokens excluding reasoning\r\n  const outputWithoutReasoning = Math.max(0, (usage.outputTokens ?? 0) - reasoningTokens);\r\n\r\n  // Get model stats for cost calculation\r\n  const modelStats = getModelStats(model, customModelConfig);\r\n\r\n  const costsIncluded =\r\n    (providerMetadata?.mux as { costsIncluded?: boolean } | undefined)?.costsIncluded === true;\r\n\r\n  // Calculate costs based on model stats (undefined if model unknown)\r\n  let inputCost: number | undefined;\r\n  let cachedCost: number | undefined;\r\n  let cacheCreateCost: number | undefined;\r\n  let outputCost: number | undefined;\r\n  let reasoningCost: number | undefined;\r\n\r\n  if (modelStats) {\r\n    inputCost = inputTokens * modelStats.input_cost_per_token;\r\n    cachedCost = cachedTokens * (modelStats.cache_read_input_token_cost ?? 0);\r\n    cacheCreateCost = cacheCreateTokens * (modelStats.cache_creation_input_token_cost ?? 0);\r\n    outputCost = outputWithoutReasoning * modelStats.output_cost_per_token;\r\n    reasoningCost = reasoningTokens * modelStats.output_cost_per_token;\r\n  }\r\n\r\n  if (costsIncluded) {\r\n    inputCost = 0;\r\n    cachedCost = 0;\r\n    cacheCreateCost = 0;\r\n    outputCost = 0;\r\n    reasoningCost = 0;\r\n  }\r\n  return {\r\n    input: {\r\n      tokens: inputTokens,\r\n      cost_usd: inputCost,\r\n    },\r\n    cached: {\r\n      tokens: cachedTokens,\r\n      cost_usd: cachedCost,\r\n    },\r\n    cacheCreate: {\r\n      tokens: cacheCreateTokens,\r\n      cost_usd: cacheCreateCost,\r\n    },\r\n    output: {\r\n      tokens: outputWithoutReasoning,\r\n      cost_usd: outputCost,\r\n    },\r\n    reasoning: {\r\n      tokens: reasoningTokens,\r\n      cost_usd: reasoningCost,\r\n    },\r\n    model, // Include model for display purposes\r\n  };\r\n}\r\n"]}