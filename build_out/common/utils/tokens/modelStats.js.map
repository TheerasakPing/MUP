{"version":3,"file":"modelStats.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/modelStats.ts"],"names":[],"mappings":"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","sourcesContent":["import modelsData from \"./models.json\";\nimport { modelsExtra } from \"./models-extra\";\nimport { normalizeGatewayModel } from \"../ai/models\";\n\nexport interface ModelStats {\n  max_input_tokens: number;\n  max_output_tokens?: number;\n  input_cost_per_token: number;\n  output_cost_per_token: number;\n  cache_creation_input_token_cost?: number;\n  cache_read_input_token_cost?: number;\n}\n\ninterface RawModelData {\n  max_input_tokens?: number | string | null;\n  max_output_tokens?: number | string | null;\n  input_cost_per_token?: number;\n  output_cost_per_token?: number;\n  cache_creation_input_token_cost?: number;\n  cache_read_input_token_cost?: number;\n  [key: string]: unknown;\n}\n\n/**\n * Validates raw model data has required fields\n */\nfunction isValidModelData(data: RawModelData): boolean {\n  return (\n    typeof data.max_input_tokens === \"number\" &&\n    typeof data.input_cost_per_token === \"number\" &&\n    typeof data.output_cost_per_token === \"number\"\n  );\n}\n\n/**\n * Extracts ModelStats from validated raw data\n */\nfunction extractModelStats(data: RawModelData): ModelStats {\n  // Type assertions are safe here because isValidModelData() already validated these fields\n  /* eslint-disable @typescript-eslint/non-nullable-type-assertion-style */\n  return {\n    max_input_tokens: data.max_input_tokens as number,\n    max_output_tokens:\n      typeof data.max_output_tokens === \"number\" ? data.max_output_tokens : undefined,\n    input_cost_per_token: data.input_cost_per_token as number,\n    output_cost_per_token: data.output_cost_per_token as number,\n    cache_creation_input_token_cost:\n      typeof data.cache_creation_input_token_cost === \"number\"\n        ? data.cache_creation_input_token_cost\n        : undefined,\n    cache_read_input_token_cost:\n      typeof data.cache_read_input_token_cost === \"number\"\n        ? data.cache_read_input_token_cost\n        : undefined,\n  };\n  /* eslint-enable @typescript-eslint/non-nullable-type-assertion-style */\n}\n\n/**\n * Generates lookup keys for a model string with multiple naming patterns\n * Handles LiteLLM conventions like \"ollama/model-cloud\" and \"provider/model\"\n */\nfunction generateLookupKeys(modelString: string): string[] {\n  const colonIndex = modelString.indexOf(\":\");\n  const provider = colonIndex !== -1 ? modelString.slice(0, colonIndex) : \"\";\n  const modelName = colonIndex !== -1 ? modelString.slice(colonIndex + 1) : modelString;\n\n  const keys: string[] = [\n    modelName, // Direct model name (e.g., \"claude-opus-4-1\")\n  ];\n\n  // Add provider-prefixed variants for Ollama and other providers\n  if (provider) {\n    keys.push(\n      `${provider}/${modelName}`, // \"ollama/gpt-oss:20b\"\n      `${provider}/${modelName}-cloud` // \"ollama/gpt-oss:20b-cloud\" (LiteLLM convention)\n    );\n\n    // Fallback: strip size suffix for base model lookup\n    // \"ollama:gpt-oss:20b\" â†’ \"ollama/gpt-oss\"\n    if (modelName.includes(\":\")) {\n      const baseModel = modelName.split(\":\")[0];\n      keys.push(`${provider}/${baseModel}`);\n    }\n  }\n\n  return keys;\n}\n\n/**\n * Gets model statistics for a given Vercel AI SDK model string\n * @param modelString - Format: \"provider:model-name\" (e.g., \"anthropic:claude-opus-4-1\", \"ollama:gpt-oss:20b\")\n * @returns ModelStats or null if model not found\n */\nexport function getModelStats(\n  modelString: string,\n  customConfig?: {\n    maxInputTokens?: number;\n    maxOutputTokens?: number;\n    inputCostPerToken?: number;\n    outputCostPerToken?: number;\n    cacheCreationInputTokenCost?: number;\n    cacheReadInputTokenCost?: number;\n  }\n): ModelStats | null {\n  const normalized = normalizeGatewayModel(modelString);\n  const lookupKeys = generateLookupKeys(normalized);\n\n  let stats: ModelStats | null = null;\n\n  // 1. Check models-extra.ts\n  for (const key of lookupKeys) {\n    const data = (modelsExtra as Record<string, RawModelData>)[key];\n    if (data && isValidModelData(data)) {\n      stats = extractModelStats(data);\n      break;\n    }\n  }\n\n  // 2. Fall back to main models.json\n  if (!stats) {\n    for (const key of lookupKeys) {\n      const data = (modelsData as Record<string, RawModelData>)[key];\n      if (data && isValidModelData(data)) {\n        stats = extractModelStats(data);\n        break;\n      }\n    }\n  }\n\n  // 3. Apply custom config overrides\n  if (customConfig) {\n    if (!stats) {\n      // If we don't have base stats, we can construct one if custom config is sufficient\n      if (\n        typeof customConfig.maxInputTokens === \"number\" &&\n        typeof customConfig.inputCostPerToken === \"number\" &&\n        typeof customConfig.outputCostPerToken === \"number\"\n      ) {\n        return {\n          max_input_tokens: customConfig.maxInputTokens,\n          max_output_tokens: customConfig.maxOutputTokens,\n          input_cost_per_token: customConfig.inputCostPerToken,\n          output_cost_per_token: customConfig.outputCostPerToken,\n          cache_creation_input_token_cost: customConfig.cacheCreationInputTokenCost,\n          cache_read_input_token_cost: customConfig.cacheReadInputTokenCost,\n        };\n      }\n      return null;\n    }\n\n    // Override existing stats\n    return {\n      ...stats,\n      max_input_tokens: customConfig.maxInputTokens ?? stats.max_input_tokens,\n      max_output_tokens: customConfig.maxOutputTokens ?? stats.max_output_tokens,\n      input_cost_per_token: customConfig.inputCostPerToken ?? stats.input_cost_per_token,\n      output_cost_per_token: customConfig.outputCostPerToken ?? stats.output_cost_per_token,\n      cache_creation_input_token_cost:\n        customConfig.cacheCreationInputTokenCost ?? stats.cache_creation_input_token_cost,\n      cache_read_input_token_cost:\n        customConfig.cacheReadInputTokenCost ?? stats.cache_read_input_token_cost,\n    };\n  }\n\n  return stats;\n}\n"]}