{"version":3,"file":"modelStats.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/modelStats.ts"],"names":[],"mappings":"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","sourcesContent":["import modelsData from \"./models.json\";\r\nimport { modelsExtra } from \"./models-extra\";\r\nimport { normalizeGatewayModel } from \"../ai/models\";\r\n\r\nexport interface ModelStats {\r\n  max_input_tokens: number;\r\n  max_output_tokens?: number;\r\n  input_cost_per_token: number;\r\n  output_cost_per_token: number;\r\n  cache_creation_input_token_cost?: number;\r\n  cache_read_input_token_cost?: number;\r\n}\r\n\r\ninterface RawModelData {\r\n  max_input_tokens?: number | string | null;\r\n  max_output_tokens?: number | string | null;\r\n  input_cost_per_token?: number;\r\n  output_cost_per_token?: number;\r\n  cache_creation_input_token_cost?: number;\r\n  cache_read_input_token_cost?: number;\r\n  [key: string]: unknown;\r\n}\r\n\r\n/**\r\n * Validates raw model data has required fields\r\n */\r\nfunction isValidModelData(data: RawModelData): boolean {\r\n  return (\r\n    typeof data.max_input_tokens === \"number\" &&\r\n    typeof data.input_cost_per_token === \"number\" &&\r\n    typeof data.output_cost_per_token === \"number\"\r\n  );\r\n}\r\n\r\n/**\r\n * Extracts ModelStats from validated raw data\r\n */\r\nfunction extractModelStats(data: RawModelData): ModelStats {\r\n  // Type assertions are safe here because isValidModelData() already validated these fields\r\n  /* eslint-disable @typescript-eslint/non-nullable-type-assertion-style */\r\n  return {\r\n    max_input_tokens: data.max_input_tokens as number,\r\n    max_output_tokens:\r\n      typeof data.max_output_tokens === \"number\" ? data.max_output_tokens : undefined,\r\n    input_cost_per_token: data.input_cost_per_token as number,\r\n    output_cost_per_token: data.output_cost_per_token as number,\r\n    cache_creation_input_token_cost:\r\n      typeof data.cache_creation_input_token_cost === \"number\"\r\n        ? data.cache_creation_input_token_cost\r\n        : undefined,\r\n    cache_read_input_token_cost:\r\n      typeof data.cache_read_input_token_cost === \"number\"\r\n        ? data.cache_read_input_token_cost\r\n        : undefined,\r\n  };\r\n  /* eslint-enable @typescript-eslint/non-nullable-type-assertion-style */\r\n}\r\n\r\n/**\r\n * Generates lookup keys for a model string with multiple naming patterns\r\n * Handles LiteLLM conventions like \"ollama/model-cloud\" and \"provider/model\"\r\n */\r\nfunction generateLookupKeys(modelString: string): string[] {\r\n  const colonIndex = modelString.indexOf(\":\");\r\n  const provider = colonIndex !== -1 ? modelString.slice(0, colonIndex) : \"\";\r\n  const modelName = colonIndex !== -1 ? modelString.slice(colonIndex + 1) : modelString;\r\n\r\n  const keys: string[] = [\r\n    modelName, // Direct model name (e.g., \"claude-opus-4-1\")\r\n  ];\r\n\r\n  // Add provider-prefixed variants for Ollama and other providers\r\n  if (provider) {\r\n    keys.push(\r\n      `${provider}/${modelName}`, // \"ollama/gpt-oss:20b\"\r\n      `${provider}/${modelName}-cloud` // \"ollama/gpt-oss:20b-cloud\" (LiteLLM convention)\r\n    );\r\n\r\n    // Fallback: strip size suffix for base model lookup\r\n    // \"ollama:gpt-oss:20b\" â†’ \"ollama/gpt-oss\"\r\n    if (modelName.includes(\":\")) {\r\n      const baseModel = modelName.split(\":\")[0];\r\n      keys.push(`${provider}/${baseModel}`);\r\n    }\r\n  }\r\n\r\n  return keys;\r\n}\r\n\r\n/**\r\n * Gets model statistics for a given Vercel AI SDK model string\r\n * @param modelString - Format: \"provider:model-name\" (e.g., \"anthropic:claude-opus-4-1\", \"ollama:gpt-oss:20b\")\r\n * @returns ModelStats or null if model not found\r\n */\r\nexport function getModelStats(\r\n  modelString: string,\r\n  customConfig?: {\r\n    maxInputTokens?: number;\r\n    maxOutputTokens?: number;\r\n    inputCostPerToken?: number;\r\n    outputCostPerToken?: number;\r\n    cacheCreationInputTokenCost?: number;\r\n    cacheReadInputTokenCost?: number;\r\n  }\r\n): ModelStats | null {\r\n  const normalized = normalizeGatewayModel(modelString);\r\n  const lookupKeys = generateLookupKeys(normalized);\r\n\r\n  let stats: ModelStats | null = null;\r\n\r\n  // 1. Check models-extra.ts\r\n  for (const key of lookupKeys) {\r\n    const data = (modelsExtra as Record<string, RawModelData>)[key];\r\n    if (data && isValidModelData(data)) {\r\n      stats = extractModelStats(data);\r\n      break;\r\n    }\r\n  }\r\n\r\n  // 2. Fall back to main models.json\r\n  if (!stats) {\r\n    for (const key of lookupKeys) {\r\n      const data = (modelsData as Record<string, RawModelData>)[key];\r\n      if (data && isValidModelData(data)) {\r\n        stats = extractModelStats(data);\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // 3. Apply custom config overrides\r\n  if (customConfig) {\r\n    if (!stats) {\r\n      // If we don't have base stats, we can construct one if custom config is sufficient\r\n      if (\r\n        typeof customConfig.maxInputTokens === \"number\" &&\r\n        typeof customConfig.inputCostPerToken === \"number\" &&\r\n        typeof customConfig.outputCostPerToken === \"number\"\r\n      ) {\r\n        return {\r\n          max_input_tokens: customConfig.maxInputTokens,\r\n          max_output_tokens: customConfig.maxOutputTokens,\r\n          input_cost_per_token: customConfig.inputCostPerToken,\r\n          output_cost_per_token: customConfig.outputCostPerToken,\r\n          cache_creation_input_token_cost: customConfig.cacheCreationInputTokenCost,\r\n          cache_read_input_token_cost: customConfig.cacheReadInputTokenCost,\r\n        };\r\n      }\r\n      return null;\r\n    }\r\n\r\n    // Override existing stats\r\n    return {\r\n      ...stats,\r\n      max_input_tokens: customConfig.maxInputTokens ?? stats.max_input_tokens,\r\n      max_output_tokens: customConfig.maxOutputTokens ?? stats.max_output_tokens,\r\n      input_cost_per_token: customConfig.inputCostPerToken ?? stats.input_cost_per_token,\r\n      output_cost_per_token: customConfig.outputCostPerToken ?? stats.output_cost_per_token,\r\n      cache_creation_input_token_cost:\r\n        customConfig.cacheCreationInputTokenCost ?? stats.cache_creation_input_token_cost,\r\n      cache_read_input_token_cost:\r\n        customConfig.cacheReadInputTokenCost ?? stats.cache_read_input_token_cost,\r\n    };\r\n  }\r\n\r\n  return stats;\r\n}\r\n"]}