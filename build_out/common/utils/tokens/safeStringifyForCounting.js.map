{"version":3,"file":"safeStringifyForCounting.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/safeStringifyForCounting.ts"],"names":[],"mappings":";AAAA;;;;;;;;GAQG;;;AAEH,MAAM,sBAAsB,GAAG,UAAU,CAAC;AAE1C,SAAS,aAAa,CAAC,KAAa,EAAiB;IACnD,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE,CAAC;QAC/B,OAAO,IAAI,CAAC;IACd,CAAC;IAED,MAAM,WAAW,GAAG,KAAK,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAC;IAC1D,IAAI,WAAW,KAAK,CAAC,CAAC,EAAE,CAAC;QACvB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,MAAM,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,WAAW,CAAC,IAAI,WAAW,CAAC;IACrE,MAAM,SAAS,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,WAAW,GAAG,sBAAsB,CAAC,MAAM,CAAC,CAAC;IAE/E,OAAO,QAAQ,IAAI,GAAG,sBAAsB,gBAAgB,SAAS,GAAG,CAAC;AAAA,CAC1E;AAED,SAAS,iBAAiB,CACxB,KAAc,EAC+C;IAC7D,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;QAChD,OAAO,KAAK,CAAC;IACf,CAAC;IAED,MAAM,MAAM,GAAG,KAAgC,CAAC;IAChD,OAAO,CACL,MAAM,CAAC,IAAI,KAAK,OAAO;QACvB,OAAO,MAAM,CAAC,IAAI,KAAK,QAAQ;QAC/B,OAAO,MAAM,CAAC,SAAS,KAAK,QAAQ,CACrC,CAAC;AAAA,CACH;AAED,kCAAyC,IAAa,EAAU;IAC9D,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,IAAI,OAAO,EAAU,CAAC;QAEnC,OAAO,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,IAAI,EAAE,KAAc,EAAE,EAAE,CAAC;YACpD,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;gBAC9B,OAAO,aAAa,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC;YACvC,CAAC;YAED,IAAI,iBAAiB,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC7B,OAAO;oBACL,GAAG,KAAK;oBACR,IAAI,EAAE,uBAAuB,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG;iBAClD,CAAC;YACJ,CAAC;YAED,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;gBAChD,IAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC;oBACpB,OAAO,YAAY,CAAC;gBACtB,CAAC;gBACD,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAClB,CAAC;YAED,OAAO,KAAK,CAAC;QAAA,CACd,CAAC,CAAC;IACL,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,kBAAkB,CAAC;IAC5B,CAAC;AAAA,CACF","sourcesContent":["/**\r\n * Safe JSON.stringify variant for *local* token counting.\r\n *\r\n * This is used for UI stats/weighting (Tokenizer tab, truncation heuristics),\r\n * not for provider payloads.\r\n *\r\n * The goal is to keep the serialized output stable-ish while redacting heavy\r\n * blobs (notably base64-encoded screenshots).\r\n */\r\n\r\nconst DATA_URL_BASE64_MARKER = \";base64,\";\r\n\r\nfunction redactDataUrl(value: string): string | null {\r\n  if (!value.startsWith(\"data:\")) {\r\n    return null;\r\n  }\r\n\r\n  const markerIndex = value.indexOf(DATA_URL_BASE64_MARKER);\r\n  if (markerIndex === -1) {\r\n    return null;\r\n  }\r\n\r\n  const mime = value.slice(\"data:\".length, markerIndex) || \"<unknown>\";\r\n  const base64Len = value.length - (markerIndex + DATA_URL_BASE64_MARKER.length);\r\n\r\n  return `data:${mime}${DATA_URL_BASE64_MARKER}[omitted len=${base64Len}]`;\r\n}\r\n\r\nfunction isAiSdkMediaBlock(\r\n  value: unknown\r\n): value is { type: \"media\"; data: string; mediaType: string } {\r\n  if (value === null || typeof value !== \"object\") {\r\n    return false;\r\n  }\r\n\r\n  const record = value as Record<string, unknown>;\r\n  return (\r\n    record.type === \"media\" &&\r\n    typeof record.data === \"string\" &&\r\n    typeof record.mediaType === \"string\"\r\n  );\r\n}\r\n\r\nexport function safeStringifyForCounting(data: unknown): string {\r\n  try {\r\n    const seen = new WeakSet<object>();\r\n\r\n    return JSON.stringify(data, (_key, value: unknown) => {\r\n      if (typeof value === \"string\") {\r\n        return redactDataUrl(value) ?? value;\r\n      }\r\n\r\n      if (isAiSdkMediaBlock(value)) {\r\n        return {\r\n          ...value,\r\n          data: `[omitted base64 len=${value.data.length}]`,\r\n        };\r\n      }\r\n\r\n      if (value !== null && typeof value === \"object\") {\r\n        if (seen.has(value)) {\r\n          return \"[circular]\";\r\n        }\r\n        seen.add(value);\r\n      }\r\n\r\n      return value;\r\n    });\r\n  } catch {\r\n    return \"[unserializable]\";\r\n  }\r\n}\r\n"]}