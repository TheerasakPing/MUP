{"version":3,"file":"safeStringifyForCounting.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/safeStringifyForCounting.ts"],"names":[],"mappings":";AAAA;;;;;;;;GAQG;;;AAEH,MAAM,sBAAsB,GAAG,UAAU,CAAC;AAE1C,SAAS,aAAa,CAAC,KAAa,EAAiB;IACnD,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE,CAAC;QAC/B,OAAO,IAAI,CAAC;IACd,CAAC;IAED,MAAM,WAAW,GAAG,KAAK,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAC;IAC1D,IAAI,WAAW,KAAK,CAAC,CAAC,EAAE,CAAC;QACvB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,MAAM,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,WAAW,CAAC,IAAI,WAAW,CAAC;IACrE,MAAM,SAAS,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,WAAW,GAAG,sBAAsB,CAAC,MAAM,CAAC,CAAC;IAE/E,OAAO,QAAQ,IAAI,GAAG,sBAAsB,gBAAgB,SAAS,GAAG,CAAC;AAAA,CAC1E;AAED,SAAS,iBAAiB,CACxB,KAAc,EAC+C;IAC7D,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;QAChD,OAAO,KAAK,CAAC;IACf,CAAC;IAED,MAAM,MAAM,GAAG,KAAgC,CAAC;IAChD,OAAO,CACL,MAAM,CAAC,IAAI,KAAK,OAAO;QACvB,OAAO,MAAM,CAAC,IAAI,KAAK,QAAQ;QAC/B,OAAO,MAAM,CAAC,SAAS,KAAK,QAAQ,CACrC,CAAC;AAAA,CACH;AAED,kCAAyC,IAAa,EAAU;IAC9D,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,IAAI,OAAO,EAAU,CAAC;QAEnC,OAAO,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,IAAI,EAAE,KAAc,EAAE,EAAE,CAAC;YACpD,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;gBAC9B,OAAO,aAAa,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC;YACvC,CAAC;YAED,IAAI,iBAAiB,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC7B,OAAO;oBACL,GAAG,KAAK;oBACR,IAAI,EAAE,uBAAuB,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG;iBAClD,CAAC;YACJ,CAAC;YAED,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;gBAChD,IAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC;oBACpB,OAAO,YAAY,CAAC;gBACtB,CAAC;gBACD,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAClB,CAAC;YAED,OAAO,KAAK,CAAC;QAAA,CACd,CAAC,CAAC;IACL,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,kBAAkB,CAAC;IAC5B,CAAC;AAAA,CACF","sourcesContent":["/**\n * Safe JSON.stringify variant for *local* token counting.\n *\n * This is used for UI stats/weighting (Tokenizer tab, truncation heuristics),\n * not for provider payloads.\n *\n * The goal is to keep the serialized output stable-ish while redacting heavy\n * blobs (notably base64-encoded screenshots).\n */\n\nconst DATA_URL_BASE64_MARKER = \";base64,\";\n\nfunction redactDataUrl(value: string): string | null {\n  if (!value.startsWith(\"data:\")) {\n    return null;\n  }\n\n  const markerIndex = value.indexOf(DATA_URL_BASE64_MARKER);\n  if (markerIndex === -1) {\n    return null;\n  }\n\n  const mime = value.slice(\"data:\".length, markerIndex) || \"<unknown>\";\n  const base64Len = value.length - (markerIndex + DATA_URL_BASE64_MARKER.length);\n\n  return `data:${mime}${DATA_URL_BASE64_MARKER}[omitted len=${base64Len}]`;\n}\n\nfunction isAiSdkMediaBlock(\n  value: unknown\n): value is { type: \"media\"; data: string; mediaType: string } {\n  if (value === null || typeof value !== \"object\") {\n    return false;\n  }\n\n  const record = value as Record<string, unknown>;\n  return (\n    record.type === \"media\" &&\n    typeof record.data === \"string\" &&\n    typeof record.mediaType === \"string\"\n  );\n}\n\nexport function safeStringifyForCounting(data: unknown): string {\n  try {\n    const seen = new WeakSet<object>();\n\n    return JSON.stringify(data, (_key, value: unknown) => {\n      if (typeof value === \"string\") {\n        return redactDataUrl(value) ?? value;\n      }\n\n      if (isAiSdkMediaBlock(value)) {\n        return {\n          ...value,\n          data: `[omitted base64 len=${value.data.length}]`,\n        };\n      }\n\n      if (value !== null && typeof value === \"object\") {\n        if (seen.has(value)) {\n          return \"[circular]\";\n        }\n        seen.add(value);\n      }\n\n      return value;\n    });\n  } catch {\n    return \"[unserializable]\";\n  }\n}\n"]}