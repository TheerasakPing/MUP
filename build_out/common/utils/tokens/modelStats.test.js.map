{"version":3,"file":"modelStats.test.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/modelStats.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, it } from \"bun:test\";\nimport { getModelStats } from \"./modelStats\";\nimport { KNOWN_MODELS } from \"@/common/constants/knownModels\";\n\ndescribe(\"getModelStats\", () => {\n  describe(\"direct model lookups\", () => {\n    test(\"should find anthropic models by direct name\", () => {\n      const stats = getModelStats(KNOWN_MODELS.OPUS.id);\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n      expect(stats?.input_cost_per_token).toBeGreaterThan(0);\n    });\n\n    test(\"should find openai models by direct name\", () => {\n      const stats = getModelStats(KNOWN_MODELS.GPT.id);\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n\n    test(\"should find models in models-extra.ts\", () => {\n      const stats = getModelStats(\"openai:gpt-5.2-pro\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBe(272000);\n      expect(stats?.input_cost_per_token).toBe(0.000021);\n    });\n\n    test(\"models-extra.ts should override models.json\", () => {\n      // gpt-5.2-codex exists in both files - models-extra.ts has correct 272k, models.json has incorrect 400k\n      const stats = getModelStats(\"openai:gpt-5.2-codex\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBe(272000); // models-extra.ts override\n    });\n  });\n\n  describe(\"ollama model lookups with cloud suffix\", () => {\n    test(\"should find ollama gpt-oss:20b with cloud suffix\", () => {\n      const stats = getModelStats(\"ollama:gpt-oss:20b\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBe(131072);\n      expect(stats?.input_cost_per_token).toBe(0); // Local models are free\n      expect(stats?.output_cost_per_token).toBe(0);\n    });\n\n    test(\"should find ollama gpt-oss:120b with cloud suffix\", () => {\n      const stats = getModelStats(\"ollama:gpt-oss:120b\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBe(131072);\n    });\n\n    test(\"should find ollama deepseek-v3.1:671b with cloud suffix\", () => {\n      const stats = getModelStats(\"ollama:deepseek-v3.1:671b\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"ollama model lookups without cloud suffix\", () => {\n    test(\"should find ollama llama3.1 directly\", () => {\n      const stats = getModelStats(\"ollama:llama3.1\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n\n    test(\"should find ollama llama3:8b with size variant\", () => {\n      const stats = getModelStats(\"ollama:llama3:8b\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n\n    test(\"should find ollama codellama\", () => {\n      const stats = getModelStats(\"ollama:codellama\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"provider-prefixed lookups\", () => {\n    test(\"should find models with provider/ prefix\", () => {\n      // Some models in models.json use provider/ prefix\n      const stats = getModelStats(\"ollama:llama2\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"unknown models\", () => {\n    test(\"should return null for completely unknown model\", () => {\n      const stats = getModelStats(\"unknown:fake-model-9000\");\n      expect(stats).toBeNull();\n    });\n\n    test(\"should return null for known provider but unknown model\", () => {\n      const stats = getModelStats(\"ollama:this-model-does-not-exist\");\n      expect(stats).toBeNull();\n    });\n  });\n\n  describe(\"mux-gateway models\", () => {\n    test(\"should handle mux-gateway:anthropic/model format\", () => {\n      const stats = getModelStats(\"mux-gateway:anthropic/claude-sonnet-4-5\");\n      expect(stats).not.toBeNull();\n      expect(stats?.input_cost_per_token).toBe(0.000003);\n      expect(stats?.output_cost_per_token).toBe(0.000015);\n    });\n\n    test(\"should handle mux-gateway:openai/model format\", () => {\n      const stats = getModelStats(\"mux-gateway:openai/gpt-4o\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n\n    test(\"should return null for mux-gateway with unknown model\", () => {\n      const stats = getModelStats(\"mux-gateway:anthropic/unknown-model-xyz\");\n      expect(stats).toBeNull();\n    });\n  });\n\n  describe(\"model without provider prefix\", () => {\n    test(\"should handle model string without provider\", () => {\n      const stats = getModelStats(\"gpt-5.2\");\n      expect(stats).not.toBeNull();\n      expect(stats?.max_input_tokens).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"existing test cases\", () => {\n    it(\"should return model stats for claude-sonnet-4-5\", () => {\n      const stats = getModelStats(KNOWN_MODELS.SONNET.id);\n\n      expect(stats).not.toBeNull();\n      expect(stats?.input_cost_per_token).toBe(0.000003);\n      expect(stats?.output_cost_per_token).toBe(0.000015);\n      expect(stats?.max_input_tokens).toBe(200000);\n    });\n\n    it(\"should handle model without provider prefix\", () => {\n      const stats = getModelStats(\"claude-sonnet-4-5\");\n\n      expect(stats).not.toBeNull();\n      expect(stats?.input_cost_per_token).toBe(0.000003);\n    });\n\n    it(\"should return cache pricing when available\", () => {\n      const stats = getModelStats(KNOWN_MODELS.SONNET.id);\n\n      expect(stats?.cache_creation_input_token_cost).toBe(0.00000375);\n      expect(stats?.cache_read_input_token_cost).toBe(3e-7);\n    });\n\n    it(\"should return null for unknown models\", () => {\n      const stats = getModelStats(\"unknown:model\");\n\n      expect(stats).toBeNull();\n    });\n  });\n\n  describe(\"model data validation\", () => {\n    test(\"should include cache costs when available\", () => {\n      const stats = getModelStats(KNOWN_MODELS.OPUS.id);\n      // Anthropic models have cache costs\n      if (stats) {\n        expect(stats.cache_creation_input_token_cost).toBeDefined();\n        expect(stats.cache_read_input_token_cost).toBeDefined();\n      }\n    });\n\n    test(\"should not include cache costs when unavailable\", () => {\n      const stats = getModelStats(\"ollama:llama3.1\");\n      // Ollama models don't have cache costs in models.json\n      if (stats) {\n        expect(stats.cache_creation_input_token_cost).toBeUndefined();\n        expect(stats.cache_read_input_token_cost).toBeUndefined();\n      }\n    });\n  });\n});\n"]}