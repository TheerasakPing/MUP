{"version":3,"file":"tokenStatsCalculator.test.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/tokenStatsCalculator.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\r\n\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport type { LanguageModelV2Usage } from \"@ai-sdk/provider\";\r\nimport {\r\n  collectUniqueToolNames,\r\n  countEncryptedWebSearchTokens,\r\n  createDisplayUsage,\r\n  extractSyncMetadata,\r\n  extractToolOutputData,\r\n  getConsumerInfoForToolCall,\r\n  isEncryptedWebSearch,\r\n  mergeResults,\r\n  type TokenCountJob,\r\n} from \"./tokenStatsCalculator\";\r\n\r\ndescribe(\"createDisplayUsage\", () => {\r\n  test(\"uses usage.reasoningTokens when available\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n      reasoningTokens: 100,\r\n    };\r\n\r\n    const result = createDisplayUsage(usage, \"openai:gpt-5-pro\");\r\n\r\n    expect(result?.reasoning.tokens).toBe(100);\r\n    expect(result?.output.tokens).toBe(400); // 500 - 100\r\n  });\r\n\r\n  test(\"falls back to providerMetadata.openai.reasoningTokens when usage.reasoningTokens is undefined\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n      // reasoningTokens not provided\r\n    };\r\n\r\n    const providerMetadata = {\r\n      openai: {\r\n        reasoningTokens: 150,\r\n        responseId: \"resp_123\",\r\n        serviceTier: \"default\",\r\n      },\r\n    };\r\n\r\n    const result = createDisplayUsage(usage, \"openai:gpt-5-pro\", providerMetadata);\r\n\r\n    expect(result?.reasoning.tokens).toBe(150);\r\n    expect(result?.output.tokens).toBe(350); // 500 - 150\r\n  });\r\n\r\n  test(\"uses 0 when both usage.reasoningTokens and providerMetadata.openai.reasoningTokens are undefined\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n    };\r\n\r\n    const providerMetadata = {\r\n      openai: {\r\n        responseId: \"resp_123\",\r\n        serviceTier: \"default\",\r\n      },\r\n    };\r\n\r\n    const result = createDisplayUsage(usage, \"openai:gpt-5-pro\", providerMetadata);\r\n\r\n    expect(result?.reasoning.tokens).toBe(0);\r\n    expect(result?.output.tokens).toBe(500); // All output tokens\r\n  });\r\n\r\n  test(\"prefers usage.reasoningTokens over providerMetadata when both exist\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n      reasoningTokens: 100,\r\n    };\r\n\r\n    const providerMetadata = {\r\n      openai: {\r\n        reasoningTokens: 999, // Should be ignored\r\n        responseId: \"resp_123\",\r\n        serviceTier: \"default\",\r\n      },\r\n    };\r\n\r\n    const result = createDisplayUsage(usage, \"openai:gpt-5-pro\", providerMetadata);\r\n\r\n    expect(result?.reasoning.tokens).toBe(100); // Uses usage, not providerMetadata\r\n    expect(result?.output.tokens).toBe(400); // 500 - 100\r\n  });\r\n\r\n  test(\"works with non-OpenAI providers that don't have providerMetadata.openai\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n      reasoningTokens: 200,\r\n    };\r\n\r\n    const providerMetadata = {\r\n      anthropic: {\r\n        cacheCreationInputTokens: 50,\r\n      },\r\n    };\r\n\r\n    const result = createDisplayUsage(\r\n      usage,\r\n      \"anthropic:claude-sonnet-4-20250514\",\r\n      providerMetadata\r\n    );\r\n\r\n    expect(result?.reasoning.tokens).toBe(200);\r\n    expect(result?.output.tokens).toBe(300); // 500 - 200\r\n    expect(result?.cacheCreate.tokens).toBe(50); // Anthropic metadata still works\r\n  });\r\n});\r\n\r\ndescribe(\"extractToolOutputData\", () => {\r\n  test(\"extracts value from nested structure\", () => {\r\n    const output = { type: \"json\", value: { foo: \"bar\" } };\r\n    expect(extractToolOutputData(output)).toEqual({ foo: \"bar\" });\r\n  });\r\n\r\n  test(\"returns output as-is if not nested\", () => {\r\n    const output = { foo: \"bar\" };\r\n    expect(extractToolOutputData(output)).toEqual({ foo: \"bar\" });\r\n  });\r\n\r\n  test(\"handles null\", () => {\r\n    expect(extractToolOutputData(null)).toBeNull();\r\n  });\r\n\r\n  test(\"handles primitives\", () => {\r\n    expect(extractToolOutputData(\"string\")).toBe(\"string\");\r\n    expect(extractToolOutputData(123)).toBe(123);\r\n  });\r\n});\r\n\r\ndescribe(\"isEncryptedWebSearch\", () => {\r\n  test(\"returns false for non-web_search tools\", () => {\r\n    const data = [{ encryptedContent: \"abc\" }];\r\n    expect(isEncryptedWebSearch(\"Read\", data)).toBe(false);\r\n  });\r\n\r\n  test(\"returns false for non-array data\", () => {\r\n    expect(isEncryptedWebSearch(\"web_search\", { foo: \"bar\" })).toBe(false);\r\n  });\r\n\r\n  test(\"returns false for web_search without encrypted content\", () => {\r\n    const data = [{ title: \"foo\", url: \"bar\" }];\r\n    expect(isEncryptedWebSearch(\"web_search\", data)).toBe(false);\r\n  });\r\n\r\n  test(\"returns true for web_search with encrypted content\", () => {\r\n    const data = [{ encryptedContent: \"abc123\" }];\r\n    expect(isEncryptedWebSearch(\"web_search\", data)).toBe(true);\r\n  });\r\n\r\n  test(\"returns true if at least one item has encrypted content\", () => {\r\n    const data = [{ title: \"foo\" }, { encryptedContent: \"abc123\" }];\r\n    expect(isEncryptedWebSearch(\"web_search\", data)).toBe(true);\r\n  });\r\n});\r\n\r\ndescribe(\"countEncryptedWebSearchTokens\", () => {\r\n  test(\"calculates tokens using heuristic\", () => {\r\n    const data = [{ encryptedContent: \"a\".repeat(100) }];\r\n    // 100 chars * 0.75 = 75\r\n    expect(countEncryptedWebSearchTokens(data)).toBe(75);\r\n  });\r\n\r\n  test(\"handles multiple items\", () => {\r\n    const data = [{ encryptedContent: \"a\".repeat(50) }, { encryptedContent: \"b\".repeat(50) }];\r\n    // 100 chars * 0.75 = 75\r\n    expect(countEncryptedWebSearchTokens(data)).toBe(75);\r\n  });\r\n\r\n  test(\"ignores items without encryptedContent\", () => {\r\n    const data = [{ title: \"foo\" }, { encryptedContent: \"a\".repeat(100) }];\r\n    // Only counts encrypted content: 100 chars * 0.75 = 75\r\n    expect(countEncryptedWebSearchTokens(data)).toBe(75);\r\n  });\r\n\r\n  test(\"rounds up\", () => {\r\n    const data = [{ encryptedContent: \"abc\" }];\r\n    // 3 chars * 0.75 = 2.25, rounded up to 3\r\n    expect(countEncryptedWebSearchTokens(data)).toBe(3);\r\n  });\r\n});\r\n\r\ndescribe(\"collectUniqueToolNames\", () => {\r\n  test(\"collects tool names from assistant messages\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"1\",\r\n        role: \"assistant\",\r\n        parts: [\r\n          {\r\n            type: \"dynamic-tool\",\r\n            toolName: \"Read\",\r\n            toolCallId: \"1\",\r\n            state: \"input-available\",\r\n            input: {},\r\n          },\r\n          {\r\n            type: \"dynamic-tool\",\r\n            toolName: \"Bash\",\r\n            toolCallId: \"2\",\r\n            state: \"input-available\",\r\n            input: {},\r\n          },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const toolNames = collectUniqueToolNames(messages);\r\n    expect(toolNames.size).toBe(2);\r\n    expect(toolNames.has(\"Read\")).toBe(true);\r\n    expect(toolNames.has(\"Bash\")).toBe(true);\r\n  });\r\n\r\n  test(\"deduplicates tool names\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"1\",\r\n        role: \"assistant\",\r\n        parts: [\r\n          {\r\n            type: \"dynamic-tool\",\r\n            toolName: \"Read\",\r\n            toolCallId: \"1\",\r\n            state: \"input-available\",\r\n            input: {},\r\n          },\r\n          {\r\n            type: \"dynamic-tool\",\r\n            toolName: \"Read\",\r\n            toolCallId: \"2\",\r\n            state: \"input-available\",\r\n            input: {},\r\n          },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const toolNames = collectUniqueToolNames(messages);\r\n    expect(toolNames.size).toBe(1);\r\n    expect(toolNames.has(\"Read\")).toBe(true);\r\n  });\r\n\r\n  test(\"ignores user messages\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"hello\" }],\r\n      },\r\n    ];\r\n\r\n    const toolNames = collectUniqueToolNames(messages);\r\n    expect(toolNames.size).toBe(0);\r\n  });\r\n\r\n  test(\"returns empty set for empty messages\", () => {\r\n    const toolNames = collectUniqueToolNames([]);\r\n    expect(toolNames.size).toBe(0);\r\n  });\r\n});\r\n\r\ndescribe(\"extractSyncMetadata\", () => {\r\n  test(\"accumulates system message tokens\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"1\",\r\n        role: \"assistant\",\r\n        parts: [],\r\n        metadata: { systemMessageTokens: 100 },\r\n      },\r\n      {\r\n        id: \"2\",\r\n        role: \"assistant\",\r\n        parts: [],\r\n        metadata: { systemMessageTokens: 200 },\r\n      },\r\n    ];\r\n\r\n    const result = extractSyncMetadata(messages, \"anthropic:claude-opus-4-1\");\r\n    expect(result.systemMessageTokens).toBe(300);\r\n  });\r\n\r\n  test(\"extracts usage history\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"1\",\r\n        role: \"assistant\",\r\n        parts: [],\r\n        metadata: {\r\n          usage: {\r\n            inputTokens: 100,\r\n            outputTokens: 50,\r\n            totalTokens: 150,\r\n          },\r\n          model: \"anthropic:claude-opus-4-1\",\r\n        },\r\n      },\r\n    ];\r\n\r\n    const result = extractSyncMetadata(messages, \"anthropic:claude-opus-4-1\");\r\n    expect(result.usageHistory.length).toBe(1);\r\n    expect(result.usageHistory[0].input.tokens).toBe(100);\r\n    expect(result.usageHistory[0].output.tokens).toBe(50);\r\n  });\r\n\r\n  test(\"ignores user messages\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"hello\" }],\r\n      },\r\n    ];\r\n\r\n    const result = extractSyncMetadata(messages, \"anthropic:claude-opus-4-1\");\r\n    expect(result.systemMessageTokens).toBe(0);\r\n    expect(result.usageHistory.length).toBe(0);\r\n  });\r\n});\r\n\r\ndescribe(\"getConsumerInfoForToolCall\", () => {\r\n  test(\"labels task tool calls as task\", () => {\r\n    expect(\r\n      getConsumerInfoForToolCall(\"task\", { subagent_type: \"exec\", prompt: \"hi\", title: \"t\" })\r\n    ).toEqual({\r\n      consumer: \"task\",\r\n      toolNameForDefinition: \"task\",\r\n    });\r\n  });\r\n\r\n  test(\"defaults to tool name for other tools\", () => {\r\n    expect(\r\n      getConsumerInfoForToolCall(\"file_edit_insert\", { file_path: \"x\", content: \"y\" })\r\n    ).toEqual({\r\n      consumer: \"file_edit_insert\",\r\n      toolNameForDefinition: \"file_edit_insert\",\r\n    });\r\n  });\r\n});\r\n\r\ndescribe(\"mergeResults\", () => {\r\n  test(\"merges job results into consumer map\", () => {\r\n    const jobs: TokenCountJob[] = [\r\n      { consumer: \"User\", promise: Promise.resolve(100) },\r\n      { consumer: \"Assistant\", promise: Promise.resolve(200) },\r\n    ];\r\n    const results = [100, 200];\r\n    const toolDefinitions = new Map<string, number>();\r\n    const systemMessageTokens = 0;\r\n\r\n    const consumerMap = mergeResults(jobs, results, toolDefinitions, systemMessageTokens);\r\n\r\n    expect(consumerMap.get(\"User\")).toMatchObject({ fixed: 0, variable: 100 });\r\n    expect(consumerMap.get(\"Assistant\")).toMatchObject({ fixed: 0, variable: 200 });\r\n  });\r\n\r\n  test(\"accumulates tokens for same consumer\", () => {\r\n    const jobs: TokenCountJob[] = [\r\n      { consumer: \"User\", promise: Promise.resolve(100) },\r\n      { consumer: \"User\", promise: Promise.resolve(50) },\r\n    ];\r\n    const results = [100, 50];\r\n    const toolDefinitions = new Map<string, number>();\r\n    const systemMessageTokens = 0;\r\n\r\n    const consumerMap = mergeResults(jobs, results, toolDefinitions, systemMessageTokens);\r\n\r\n    expect(consumerMap.get(\"User\")).toMatchObject({ fixed: 0, variable: 150 });\r\n  });\r\n\r\n  test(\"adds tool definition tokens only once\", () => {\r\n    const jobs: TokenCountJob[] = [\r\n      { consumer: \"Read\", promise: Promise.resolve(100) },\r\n      { consumer: \"Read\", promise: Promise.resolve(50) },\r\n    ];\r\n    const results = [100, 50];\r\n    const toolDefinitions = new Map<string, number>([[\"Read\", 25]]);\r\n    const systemMessageTokens = 0;\r\n\r\n    const consumerMap = mergeResults(jobs, results, toolDefinitions, systemMessageTokens);\r\n\r\n    // Fixed tokens added only once, variable tokens accumulated\r\n    expect(consumerMap.get(\"Read\")).toMatchObject({ fixed: 25, variable: 150 });\r\n  });\r\n\r\n  test(\"adds system message tokens\", () => {\r\n    const jobs: TokenCountJob[] = [];\r\n    const results: number[] = [];\r\n    const toolDefinitions = new Map<string, number>();\r\n    const systemMessageTokens = 300;\r\n\r\n    const consumerMap = mergeResults(jobs, results, toolDefinitions, systemMessageTokens);\r\n\r\n    expect(consumerMap.get(\"System\")).toMatchObject({ fixed: 0, variable: 300 });\r\n  });\r\n\r\n  test(\"skips zero token results\", () => {\r\n    const jobs: TokenCountJob[] = [\r\n      { consumer: \"User\", promise: Promise.resolve(0) },\r\n      { consumer: \"Assistant\", promise: Promise.resolve(100) },\r\n    ];\r\n    const results = [0, 100];\r\n    const toolDefinitions = new Map<string, number>();\r\n    const systemMessageTokens = 0;\r\n\r\n    const consumerMap = mergeResults(jobs, results, toolDefinitions, systemMessageTokens);\r\n\r\n    expect(consumerMap.has(\"User\")).toBe(false);\r\n    expect(consumerMap.get(\"Assistant\")).toMatchObject({ fixed: 0, variable: 100 });\r\n  });\r\n});\r\n"]}