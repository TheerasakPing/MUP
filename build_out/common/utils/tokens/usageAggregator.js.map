{"version":3,"file":"usageAggregator.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/usageAggregator.ts"],"names":[],"mappings":";AAAA;;;;;;;GAOG;;;;;AA6BH;;;GAGG;AACH,yBAAgC,YAAgC,EAAgC;IAC9F,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,SAAS,CAAC;IAEhD,2DAA2D;IAC3D,IAAI,iBAAiB,GAAG,KAAK,CAAC;IAE9B,MAAM,GAAG,GAAqB;QAC5B,KAAK,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QACjC,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QAClC,WAAW,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QACvC,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QAClC,SAAS,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;KACtC,CAAC;IAEF,KAAK,MAAM,KAAK,IAAI,YAAY,EAAE,CAAC;QACjC,uDAAuD;QACvD,MAAM,aAAa,GAAuE;YACxF,OAAO;YACP,QAAQ;YACR,aAAa;YACb,QAAQ;YACR,WAAW;SACZ,CAAC;QACF,KAAK,MAAM,GAAG,IAAI,aAAa,EAAE,CAAC;YAChC,GAAG,CAAC,GAAG,CAAC,CAAC,MAAM,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC;YACrC,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,KAAK,SAAS,EAAE,CAAC;gBACtC,iBAAiB,GAAG,IAAI,CAAC;YAC3B,CAAC;iBAAM,CAAC;gBACN,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,CAAC;YAC5E,CAAC;QACH,CAAC;IACH,CAAC;IAED,8DAA8D;IAC9D,IAAI,iBAAiB,EAAE,CAAC;QACtB,GAAG,CAAC,eAAe,GAAG,IAAI,CAAC;IAC7B,CAAC;IAED,OAAO,GAAG,CAAC;AAAA,CACZ;AAED;;;GAGG;AACH,sBAA6B,KAAmC,EAAsB;IACpF,IAAI,CAAC,KAAK;QAAE,OAAO,SAAS,CAAC;IAC7B,MAAM,UAAU,GAAG,CAAC,OAAO,EAAE,QAAQ,EAAE,aAAa,EAAE,QAAQ,EAAE,WAAW,CAAU,CAAC;IACtF,IAAI,KAAK,GAAG,CAAC,CAAC;IACd,IAAI,UAAU,GAAG,KAAK,CAAC;IACvB,KAAK,MAAM,GAAG,IAAI,UAAU,EAAE,CAAC;QAC7B,MAAM,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC;QACjC,IAAI,IAAI,KAAK,SAAS,EAAE,CAAC;YACvB,KAAK,IAAI,IAAI,CAAC;YACd,UAAU,GAAG,IAAI,CAAC;QACpB,CAAC;IACH,CAAC;IACD,OAAO,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC;AAAA,CACvC;AAED;;;GAGG;AACH,8BAAqC,IAAwB,EAAU;IACrE,IAAI,IAAI,KAAK,SAAS;QAAE,OAAO,EAAE,CAAC;IAClC,IAAI,IAAI,KAAK,CAAC;QAAE,OAAO,OAAO,CAAC;IAC/B,IAAI,IAAI,GAAG,IAAI;QAAE,OAAO,QAAQ,CAAC;IACjC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;AAAA,CAC9B","sourcesContent":["/**\n * Usage aggregation utilities for cost calculation\n *\n * IMPORTANT: This file must NOT import tokenizer to avoid pulling\n * 2MB+ of encoding data into the renderer process.\n *\n * Separated from tokenStatsCalculator.ts to keep tokenizer in main process only.\n */\n\nexport interface ChatUsageComponent {\n  tokens: number;\n  cost_usd?: number; // undefined if model pricing unknown\n}\n\n/**\n * Enhanced usage type for display that includes provider-specific cache stats\n */\nexport interface ChatUsageDisplay {\n  // Input is the part of the input that was not cached. So,\n  // totalInput = input + cached (cacheCreate is separate for billing)\n  input: ChatUsageComponent;\n  cached: ChatUsageComponent;\n  cacheCreate: ChatUsageComponent; // Cache creation tokens (separate billing concept)\n\n  // Output is the part of the output excluding reasoning, so\n  // totalOutput = output + reasoning\n  output: ChatUsageComponent;\n  reasoning: ChatUsageComponent;\n\n  // Optional model field for display purposes (context window calculation, etc.)\n  model?: string;\n\n  // True if any model in the sum had unknown pricing (costs are partial/incomplete)\n  hasUnknownCosts?: boolean;\n}\n\n/**\n * Sum multiple ChatUsageDisplay objects into a single cumulative display\n * Used for showing total costs across multiple API responses\n */\nexport function sumUsageHistory(usageHistory: ChatUsageDisplay[]): ChatUsageDisplay | undefined {\n  if (usageHistory.length === 0) return undefined;\n\n  // Track if any costs are undefined (model pricing unknown)\n  let hasUndefinedCosts = false;\n\n  const sum: ChatUsageDisplay = {\n    input: { tokens: 0, cost_usd: 0 },\n    cached: { tokens: 0, cost_usd: 0 },\n    cacheCreate: { tokens: 0, cost_usd: 0 },\n    output: { tokens: 0, cost_usd: 0 },\n    reasoning: { tokens: 0, cost_usd: 0 },\n  };\n\n  for (const usage of usageHistory) {\n    // Iterate over each component and sum tokens and costs\n    const componentKeys: Array<\"input\" | \"cached\" | \"cacheCreate\" | \"output\" | \"reasoning\"> = [\n      \"input\",\n      \"cached\",\n      \"cacheCreate\",\n      \"output\",\n      \"reasoning\",\n    ];\n    for (const key of componentKeys) {\n      sum[key].tokens += usage[key].tokens;\n      if (usage[key].cost_usd === undefined) {\n        hasUndefinedCosts = true;\n      } else {\n        sum[key].cost_usd = (sum[key].cost_usd ?? 0) + (usage[key].cost_usd ?? 0);\n      }\n    }\n  }\n\n  // Flag if any costs were undefined (partial/incomplete total)\n  if (hasUndefinedCosts) {\n    sum.hasUnknownCosts = true;\n  }\n\n  return sum;\n}\n\n/**\n * Calculate total cost from a ChatUsageDisplay object.\n * Returns undefined if no cost data is available.\n */\nexport function getTotalCost(usage: ChatUsageDisplay | undefined): number | undefined {\n  if (!usage) return undefined;\n  const components = [\"input\", \"cached\", \"cacheCreate\", \"output\", \"reasoning\"] as const;\n  let total = 0;\n  let hasAnyCost = false;\n  for (const key of components) {\n    const cost = usage[key].cost_usd;\n    if (cost !== undefined) {\n      total += cost;\n      hasAnyCost = true;\n    }\n  }\n  return hasAnyCost ? total : undefined;\n}\n\n/**\n * Format cost for display with dollar sign.\n * Returns \"~$0.00\" for very small values, \"$X.XX\" otherwise.\n */\nexport function formatCostWithDollar(cost: number | undefined): string {\n  if (cost === undefined) return \"\";\n  if (cost === 0) return \"$0.00\";\n  if (cost < 0.01) return \"~$0.00\";\n  return `$${cost.toFixed(2)}`;\n}\n"]}