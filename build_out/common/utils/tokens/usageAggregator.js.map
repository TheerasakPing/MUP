{"version":3,"file":"usageAggregator.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/usageAggregator.ts"],"names":[],"mappings":";AAAA;;;;;;;GAOG;;;;;AA6BH;;;GAGG;AACH,yBAAgC,YAAgC,EAAgC;IAC9F,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,SAAS,CAAC;IAEhD,2DAA2D;IAC3D,IAAI,iBAAiB,GAAG,KAAK,CAAC;IAE9B,MAAM,GAAG,GAAqB;QAC5B,KAAK,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QACjC,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QAClC,WAAW,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QACvC,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;QAClC,SAAS,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;KACtC,CAAC;IAEF,KAAK,MAAM,KAAK,IAAI,YAAY,EAAE,CAAC;QACjC,uDAAuD;QACvD,MAAM,aAAa,GAAuE;YACxF,OAAO;YACP,QAAQ;YACR,aAAa;YACb,QAAQ;YACR,WAAW;SACZ,CAAC;QACF,KAAK,MAAM,GAAG,IAAI,aAAa,EAAE,CAAC;YAChC,GAAG,CAAC,GAAG,CAAC,CAAC,MAAM,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC;YACrC,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,KAAK,SAAS,EAAE,CAAC;gBACtC,iBAAiB,GAAG,IAAI,CAAC;YAC3B,CAAC;iBAAM,CAAC;gBACN,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,CAAC;YAC5E,CAAC;QACH,CAAC;IACH,CAAC;IAED,8DAA8D;IAC9D,IAAI,iBAAiB,EAAE,CAAC;QACtB,GAAG,CAAC,eAAe,GAAG,IAAI,CAAC;IAC7B,CAAC;IAED,OAAO,GAAG,CAAC;AAAA,CACZ;AAED;;;GAGG;AACH,sBAA6B,KAAmC,EAAsB;IACpF,IAAI,CAAC,KAAK;QAAE,OAAO,SAAS,CAAC;IAC7B,MAAM,UAAU,GAAG,CAAC,OAAO,EAAE,QAAQ,EAAE,aAAa,EAAE,QAAQ,EAAE,WAAW,CAAU,CAAC;IACtF,IAAI,KAAK,GAAG,CAAC,CAAC;IACd,IAAI,UAAU,GAAG,KAAK,CAAC;IACvB,KAAK,MAAM,GAAG,IAAI,UAAU,EAAE,CAAC;QAC7B,MAAM,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC;QACjC,IAAI,IAAI,KAAK,SAAS,EAAE,CAAC;YACvB,KAAK,IAAI,IAAI,CAAC;YACd,UAAU,GAAG,IAAI,CAAC;QACpB,CAAC;IACH,CAAC;IACD,OAAO,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC;AAAA,CACvC;AAED;;;GAGG;AACH,8BAAqC,IAAwB,EAAU;IACrE,IAAI,IAAI,KAAK,SAAS;QAAE,OAAO,EAAE,CAAC;IAClC,IAAI,IAAI,KAAK,CAAC;QAAE,OAAO,OAAO,CAAC;IAC/B,IAAI,IAAI,GAAG,IAAI;QAAE,OAAO,QAAQ,CAAC;IACjC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;AAAA,CAC9B","sourcesContent":["/**\r\n * Usage aggregation utilities for cost calculation\r\n *\r\n * IMPORTANT: This file must NOT import tokenizer to avoid pulling\r\n * 2MB+ of encoding data into the renderer process.\r\n *\r\n * Separated from tokenStatsCalculator.ts to keep tokenizer in main process only.\r\n */\r\n\r\nexport interface ChatUsageComponent {\r\n  tokens: number;\r\n  cost_usd?: number; // undefined if model pricing unknown\r\n}\r\n\r\n/**\r\n * Enhanced usage type for display that includes provider-specific cache stats\r\n */\r\nexport interface ChatUsageDisplay {\r\n  // Input is the part of the input that was not cached. So,\r\n  // totalInput = input + cached (cacheCreate is separate for billing)\r\n  input: ChatUsageComponent;\r\n  cached: ChatUsageComponent;\r\n  cacheCreate: ChatUsageComponent; // Cache creation tokens (separate billing concept)\r\n\r\n  // Output is the part of the output excluding reasoning, so\r\n  // totalOutput = output + reasoning\r\n  output: ChatUsageComponent;\r\n  reasoning: ChatUsageComponent;\r\n\r\n  // Optional model field for display purposes (context window calculation, etc.)\r\n  model?: string;\r\n\r\n  // True if any model in the sum had unknown pricing (costs are partial/incomplete)\r\n  hasUnknownCosts?: boolean;\r\n}\r\n\r\n/**\r\n * Sum multiple ChatUsageDisplay objects into a single cumulative display\r\n * Used for showing total costs across multiple API responses\r\n */\r\nexport function sumUsageHistory(usageHistory: ChatUsageDisplay[]): ChatUsageDisplay | undefined {\r\n  if (usageHistory.length === 0) return undefined;\r\n\r\n  // Track if any costs are undefined (model pricing unknown)\r\n  let hasUndefinedCosts = false;\r\n\r\n  const sum: ChatUsageDisplay = {\r\n    input: { tokens: 0, cost_usd: 0 },\r\n    cached: { tokens: 0, cost_usd: 0 },\r\n    cacheCreate: { tokens: 0, cost_usd: 0 },\r\n    output: { tokens: 0, cost_usd: 0 },\r\n    reasoning: { tokens: 0, cost_usd: 0 },\r\n  };\r\n\r\n  for (const usage of usageHistory) {\r\n    // Iterate over each component and sum tokens and costs\r\n    const componentKeys: Array<\"input\" | \"cached\" | \"cacheCreate\" | \"output\" | \"reasoning\"> = [\r\n      \"input\",\r\n      \"cached\",\r\n      \"cacheCreate\",\r\n      \"output\",\r\n      \"reasoning\",\r\n    ];\r\n    for (const key of componentKeys) {\r\n      sum[key].tokens += usage[key].tokens;\r\n      if (usage[key].cost_usd === undefined) {\r\n        hasUndefinedCosts = true;\r\n      } else {\r\n        sum[key].cost_usd = (sum[key].cost_usd ?? 0) + (usage[key].cost_usd ?? 0);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Flag if any costs were undefined (partial/incomplete total)\r\n  if (hasUndefinedCosts) {\r\n    sum.hasUnknownCosts = true;\r\n  }\r\n\r\n  return sum;\r\n}\r\n\r\n/**\r\n * Calculate total cost from a ChatUsageDisplay object.\r\n * Returns undefined if no cost data is available.\r\n */\r\nexport function getTotalCost(usage: ChatUsageDisplay | undefined): number | undefined {\r\n  if (!usage) return undefined;\r\n  const components = [\"input\", \"cached\", \"cacheCreate\", \"output\", \"reasoning\"] as const;\r\n  let total = 0;\r\n  let hasAnyCost = false;\r\n  for (const key of components) {\r\n    const cost = usage[key].cost_usd;\r\n    if (cost !== undefined) {\r\n      total += cost;\r\n      hasAnyCost = true;\r\n    }\r\n  }\r\n  return hasAnyCost ? total : undefined;\r\n}\r\n\r\n/**\r\n * Format cost for display with dollar sign.\r\n * Returns \"~$0.00\" for very small values, \"$X.XX\" otherwise.\r\n */\r\nexport function formatCostWithDollar(cost: number | undefined): string {\r\n  if (cost === undefined) return \"\";\r\n  if (cost === 0) return \"$0.00\";\r\n  if (cost < 0.01) return \"~$0.00\";\r\n  return `$${cost.toFixed(2)}`;\r\n}\r\n"]}