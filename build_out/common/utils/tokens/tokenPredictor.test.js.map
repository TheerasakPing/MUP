{"version":3,"file":"tokenPredictor.test.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/tokenPredictor.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport { predictTokenUsage } from \"@/common/utils/tokens/tokenPredictor\";\r\n\r\ndescribe(\"predictTokenUsage\", () => {\r\n  it(\"should predict token usage for simple message\", () => {\r\n    const result = predictTokenUsage({\r\n      messageContent: \"Hello, world!\",\r\n      attachedFiles: [],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    expect(result.estimatedInputTokens).toBeGreaterThan(0);\r\n    expect(result.estimatedOutputTokens).toBe(500); // Default fallback\r\n    expect(result.estimatedTotalTokens).toBeGreaterThan(0);\r\n    expect(result.estimatedCostUsd).toBeGreaterThan(0);\r\n    expect(result.warningLevel).toBe(\"none\");\r\n    expect(result.suggestions).toHaveLength(0);\r\n  });\r\n\r\n  it(\"should use historical average for output tokens\", () => {\r\n    const result = predictTokenUsage({\r\n      messageContent: \"Test message\",\r\n      attachedFiles: [],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n      historicalAvgOutput: 1000,\r\n    });\r\n\r\n    expect(result.estimatedOutputTokens).toBe(1000);\r\n  });\r\n\r\n  it(\"should include attached files in token count\", () => {\r\n    const withoutFiles = predictTokenUsage({\r\n      messageContent: \"Test\",\r\n      attachedFiles: [],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    const withFiles = predictTokenUsage({\r\n      messageContent: \"Test\",\r\n      attachedFiles: [\"file content here that is quite long\"],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    expect(withFiles.estimatedInputTokens).toBeGreaterThan(withoutFiles.estimatedInputTokens);\r\n  });\r\n\r\n  it(\"should include current context in token count\", () => {\r\n    const withoutContext = predictTokenUsage({\r\n      messageContent: \"Test\",\r\n      attachedFiles: [],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    const withContext = predictTokenUsage({\r\n      messageContent: \"Test\",\r\n      attachedFiles: [],\r\n      currentContext: 10000,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    expect(withContext.estimatedInputTokens).toBeGreaterThan(withoutContext.estimatedInputTokens);\r\n  });\r\n\r\n  it(\"should set high warning level for 50k-100k tokens\", () => {\r\n    const result = predictTokenUsage({\r\n      messageContent: \"x\".repeat(200000), // ~50k tokens\r\n      attachedFiles: [],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    expect(result.warningLevel).toBe(\"high\");\r\n    expect(result.suggestions.length).toBeGreaterThan(0);\r\n  });\r\n\r\n  it(\"should set critical warning level for >100k tokens\", () => {\r\n    const result = predictTokenUsage({\r\n      messageContent: \"x\".repeat(400000), // ~100k tokens\r\n      attachedFiles: [],\r\n      currentContext: 0,\r\n      model: \"claude-3.5-sonnet\",\r\n    });\r\n\r\n    expect(result.warningLevel).toBe(\"critical\");\r\n    expect(result.suggestions).toContain(\"Consider splitting into multiple smaller requests\");\r\n  });\r\n\r\n  it(\"should estimate cost correctly\", () => {\r\n    const result = predictTokenUsage({\r\n      messageContent: \"Test message\",\r\n      attachedFiles: [],\r\n      currentContext: 1000,\r\n      model: \"claude-3.5-sonnet\",\r\n      historicalAvgOutput: 500,\r\n    });\r\n\r\n    // Cost should be input tokens * input rate + output tokens * output rate\r\n    expect(result.estimatedCostUsd).toBeGreaterThan(0);\r\n    expect(result.estimatedCostUsd).toBeLessThan(1); // Should be very small for this test\r\n  });\r\n});\r\n"]}