{"version":3,"file":"displayUsage.test.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/displayUsage.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect } from \"bun:test\";\r\nimport { createDisplayUsage } from \"./displayUsage\";\r\nimport type { LanguageModelV2Usage } from \"@ai-sdk/provider\";\r\n\r\ndescribe(\"createDisplayUsage\", () => {\r\n  describe(\"AI SDK v6: unified cached token subtraction\", () => {\r\n    // AI SDK v6 changed semantics: ALL providers now report inputTokens INCLUSIVE\r\n    // of cached tokens. We always subtract cachedInputTokens + cacheCreateTokens\r\n    // to get the true non-cached input.\r\n\r\n    test(\"subtracts cached tokens for OpenAI model\", () => {\r\n      const openAIUsage: LanguageModelV2Usage = {\r\n        inputTokens: 108200, // Includes 71600 cached\r\n        outputTokens: 227,\r\n        totalTokens: 108427,\r\n        cachedInputTokens: 71600,\r\n      };\r\n\r\n      const result = createDisplayUsage(openAIUsage, \"openai:gpt-5.2\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cached.tokens).toBe(71600);\r\n      // Input = raw minus cached: 108200 - 71600 = 36600\r\n      expect(result!.input.tokens).toBe(36600);\r\n    });\r\n\r\n    test(\"subtracts cached tokens for gateway OpenAI model\", () => {\r\n      const openAIUsage: LanguageModelV2Usage = {\r\n        inputTokens: 108200,\r\n        outputTokens: 227,\r\n        totalTokens: 108427,\r\n        cachedInputTokens: 71600,\r\n      };\r\n\r\n      const result = createDisplayUsage(openAIUsage, \"mux-gateway:openai/gpt-5.2\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cached.tokens).toBe(71600);\r\n      // Input = raw minus cached: 108200 - 71600 = 36600\r\n      expect(result!.input.tokens).toBe(36600);\r\n    });\r\n\r\n    test(\"subtracts cached tokens for Anthropic model (v6 semantics)\", () => {\r\n      // In v6, Anthropic now reports inputTokens INCLUSIVE of cached tokens\r\n      // (matching OpenAI/Google behavior). inputTokens = input + cache_read + cache_write.\r\n      const anthropicUsage: LanguageModelV2Usage = {\r\n        inputTokens: 108200, // 36600 non-cached + 71600 cache_read\r\n        outputTokens: 227,\r\n        totalTokens: 108427,\r\n        cachedInputTokens: 71600,\r\n      };\r\n\r\n      const result = createDisplayUsage(anthropicUsage, \"anthropic:claude-opus-4-6\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cached.tokens).toBe(71600);\r\n      // Input = raw minus cached: 108200 - 71600 = 36600 (non-cached only)\r\n      expect(result!.input.tokens).toBe(36600);\r\n    });\r\n\r\n    test(\"subtracts cached tokens for gateway Anthropic model\", () => {\r\n      const anthropicUsage: LanguageModelV2Usage = {\r\n        inputTokens: 108200,\r\n        outputTokens: 227,\r\n        totalTokens: 108427,\r\n        cachedInputTokens: 71600,\r\n      };\r\n\r\n      const result = createDisplayUsage(anthropicUsage, \"mux-gateway:anthropic/claude-opus-4-6\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cached.tokens).toBe(71600);\r\n      // Input = raw minus cached: 108200 - 71600 = 36600\r\n      expect(result!.input.tokens).toBe(36600);\r\n    });\r\n\r\n    test(\"subtracts both cached and cache-create for Anthropic with cache creation\", () => {\r\n      // Anthropic with both cache_read and cache_creation tokens\r\n      // inputTokens = 500 non-cached + 100000 cache_read + 5000 cache_write = 105500\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 105500,\r\n        outputTokens: 1000,\r\n        totalTokens: 106500,\r\n        cachedInputTokens: 100000,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"anthropic:claude-opus-4-6\", {\r\n        anthropic: { cacheCreationInputTokens: 5000 },\r\n      });\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.input.tokens).toBe(500); // 105500 - 100000 - 5000\r\n      expect(result!.cached.tokens).toBe(100000);\r\n      expect(result!.cacheCreate.tokens).toBe(5000);\r\n      expect(result!.output.tokens).toBe(1000);\r\n\r\n      // Total should match actual context (no double counting)\r\n      const total =\r\n        result!.input.tokens +\r\n        result!.cached.tokens +\r\n        result!.cacheCreate.tokens +\r\n        result!.output.tokens;\r\n      expect(total).toBe(106500);\r\n    });\r\n\r\n    test(\"subtracts cached tokens for Google model\", () => {\r\n      const googleUsage: LanguageModelV2Usage = {\r\n        inputTokens: 74300, // Includes 42600 cached\r\n        outputTokens: 1600,\r\n        totalTokens: 75900,\r\n        cachedInputTokens: 42600,\r\n      };\r\n\r\n      const result = createDisplayUsage(googleUsage, \"google:gemini-3-pro-preview\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cached.tokens).toBe(42600);\r\n      // Input = raw minus cached: 74300 - 42600 = 31700\r\n      expect(result!.input.tokens).toBe(31700);\r\n    });\r\n\r\n    test(\"subtracts cached tokens for gateway Google model\", () => {\r\n      const googleUsage: LanguageModelV2Usage = {\r\n        inputTokens: 74300,\r\n        outputTokens: 1600,\r\n        totalTokens: 75900,\r\n        cachedInputTokens: 42600,\r\n      };\r\n\r\n      const result = createDisplayUsage(googleUsage, \"mux-gateway:google/gemini-3-pro-preview\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cached.tokens).toBe(42600);\r\n      // Input = raw minus cached: 74300 - 42600 = 31700\r\n      expect(result!.input.tokens).toBe(31700);\r\n    });\r\n  });\r\n\r\n  describe(\"backward compatibility with pre-v6 data\", () => {\r\n    test(\"clamps to 0 when pre-v6 Anthropic data has inputTokens excluding cache\", () => {\r\n      // Pre-v6 historical data: inputTokens excluded cache, so subtracting\r\n      // would go negative. Math.max(0, ...) ensures no negative values.\r\n      const oldFormatUsage: LanguageModelV2Usage = {\r\n        inputTokens: 500, // Pre-v6: non-cached only\r\n        outputTokens: 227,\r\n        totalTokens: 72327,\r\n        cachedInputTokens: 71600,\r\n      };\r\n\r\n      const result = createDisplayUsage(oldFormatUsage, \"anthropic:claude-sonnet-4-5\");\r\n\r\n      expect(result).toBeDefined();\r\n      // Input clamps to 0 (500 - 71600 would be negative)\r\n      expect(result!.input.tokens).toBe(0);\r\n      expect(result!.cached.tokens).toBe(71600);\r\n      // Total is approximately correct (off by 500 non-cached, acceptable for old data)\r\n    });\r\n  });\r\n\r\n  test(\"returns undefined for undefined usage\", () => {\r\n    expect(createDisplayUsage(undefined, \"openai:gpt-5.2\")).toBeUndefined();\r\n  });\r\n\r\n  test(\"handles zero cached tokens\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n      cachedInputTokens: 0,\r\n    };\r\n\r\n    const result = createDisplayUsage(usage, \"openai:gpt-5.2\");\r\n\r\n    expect(result).toBeDefined();\r\n    expect(result!.input.tokens).toBe(1000);\r\n    expect(result!.cached.tokens).toBe(0);\r\n  });\r\n\r\n  test(\"handles missing cachedInputTokens field\", () => {\r\n    const usage: LanguageModelV2Usage = {\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      totalTokens: 1500,\r\n    };\r\n\r\n    const result = createDisplayUsage(usage, \"openai:gpt-5.2\");\r\n\r\n    expect(result).toBeDefined();\r\n    expect(result!.input.tokens).toBe(1000);\r\n    expect(result!.cached.tokens).toBe(0);\r\n  });\r\n\r\n  describe(\"Subscription-covered usage costs\", () => {\r\n    test(\"returns $0 costs when providerMetadata.mux.costsIncluded is true\", () => {\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 1000, // OpenAI includes cached tokens\r\n        outputTokens: 500,\r\n        totalTokens: 1500,\r\n        cachedInputTokens: 200,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"openai:gpt-5.2\", {\r\n        mux: { costsIncluded: true },\r\n      });\r\n\r\n      expect(result).toBeDefined();\r\n      // Token handling remains unchanged\r\n      expect(result!.input.tokens).toBe(800);\r\n      expect(result!.cached.tokens).toBe(200);\r\n\r\n      expect(result!.input.cost_usd).toBe(0);\r\n      expect(result!.cached.cost_usd).toBe(0);\r\n      expect(result!.cacheCreate.cost_usd).toBe(0);\r\n      expect(result!.output.cost_usd).toBe(0);\r\n      expect(result!.reasoning.cost_usd).toBe(0);\r\n    });\r\n\r\n    test(\"returns $0 costs even when model pricing is unknown\", () => {\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 100,\r\n        outputTokens: 50,\r\n        totalTokens: 150,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"openai:some-unknown-model\", {\r\n        mux: { costsIncluded: true },\r\n      });\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.input.cost_usd).toBe(0);\r\n      expect(result!.cached.cost_usd).toBe(0);\r\n      expect(result!.cacheCreate.cost_usd).toBe(0);\r\n      expect(result!.output.cost_usd).toBe(0);\r\n      expect(result!.reasoning.cost_usd).toBe(0);\r\n    });\r\n  });\r\n  describe(\"Anthropic cache creation tokens from providerMetadata\", () => {\r\n    // Cache creation tokens are Anthropic-specific and only available in\r\n    // providerMetadata.anthropic.cacheCreationInputTokens, not in LanguageModelV2Usage.\r\n    // This is critical for liveUsage display during streaming.\r\n\r\n    test(\"extracts cacheCreationInputTokens from providerMetadata\", () => {\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 1000,\r\n        outputTokens: 50,\r\n        totalTokens: 1050,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"anthropic:claude-sonnet-4-20250514\", {\r\n        anthropic: { cacheCreationInputTokens: 800 },\r\n      });\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cacheCreate.tokens).toBe(800);\r\n    });\r\n\r\n    test(\"cacheCreate is 0 when providerMetadata is undefined\", () => {\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 1000,\r\n        outputTokens: 50,\r\n        totalTokens: 1050,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"anthropic:claude-sonnet-4-20250514\");\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cacheCreate.tokens).toBe(0);\r\n    });\r\n\r\n    test(\"cacheCreate is 0 when anthropic metadata lacks cacheCreationInputTokens\", () => {\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 1000,\r\n        outputTokens: 50,\r\n        totalTokens: 1050,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"anthropic:claude-sonnet-4-20250514\", {\r\n        anthropic: { someOtherField: 123 },\r\n      });\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cacheCreate.tokens).toBe(0);\r\n    });\r\n\r\n    test(\"handles gateway Anthropic model with cache creation\", () => {\r\n      const usage: LanguageModelV2Usage = {\r\n        inputTokens: 2000,\r\n        outputTokens: 100,\r\n        totalTokens: 2100,\r\n      };\r\n\r\n      const result = createDisplayUsage(usage, \"mux-gateway:anthropic/claude-sonnet-4-5\", {\r\n        anthropic: { cacheCreationInputTokens: 1500 },\r\n      });\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result!.cacheCreate.tokens).toBe(1500);\r\n    });\r\n  });\r\n});\r\n"]}