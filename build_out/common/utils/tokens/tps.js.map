{"version":3,"file":"tps.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/tps.ts"],"names":[],"mappings":";AAAA;;;;GAIG;;;;;AAQH,MAAM,qBAAqB,GAAG,KAAK,CAAC,CAAC,4BAA4B;AAEjE;;GAEG;AACH,sBAA6B,MAAqB,EAAE,GAAG,GAAW,IAAI,CAAC,GAAG,EAAE,EAAU;IACpF,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,CAAC,CAAC;IAElC,MAAM,WAAW,GAAG,GAAG,GAAG,qBAAqB,CAAC;IAChD,MAAM,YAAY,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,IAAI,WAAW,CAAC,CAAC;IACtE,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,CAAC,CAAC;IAExC,MAAM,WAAW,GAAG,YAAY,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;IAC9E,MAAM,UAAU,GAAG,GAAG,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;IACnD,MAAM,WAAW,GAAG,UAAU,GAAG,IAAI,CAAC;IACtC,IAAI,WAAW,IAAI,CAAC;QAAE,OAAO,CAAC,CAAC;IAE/B,OAAO,IAAI,CAAC,KAAK,CAAC,WAAW,GAAG,WAAW,CAAC,CAAC;AAAA,CAC9C;AAED,6BAAoC,MAAqB,EAAU;IACjE,IAAI,CAAC,MAAM,EAAE,MAAM,IAAI,CAAC,CAAC,KAAK,CAAC;QAAE,OAAO,CAAC,CAAC;IAC1C,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;AAAA,CAC5D;AASD,4BAAmC,QAAQ,GAAW,qBAAqB,EAAsB;IAC/F,IAAI,YAAY,GAAkB,EAAE,CAAC;IACrC,IAAI,eAAe,GAAG,CAAC,CAAC;IAExB,MAAM,KAAK,GAAG,CAAC,GAAW,EAAQ,EAAE,CAAC;QACnC,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;YAAE,OAAO;QACtC,MAAM,SAAS,GAAG,GAAG,GAAG,QAAQ,CAAC;QAEjC,IAAI,UAAU,GAAG,CAAC,CAAC;QACnB,KAAK,MAAM,KAAK,IAAI,YAAY,EAAE,CAAC;YACjC,IAAI,KAAK,CAAC,SAAS,GAAG,SAAS,EAAE,CAAC;gBAChC,eAAe,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,CAAC;gBACrC,UAAU,IAAI,CAAC,CAAC;YAClB,CAAC;iBAAM,CAAC;gBACN,MAAM;YACR,CAAC;QACH,CAAC;QAED,IAAI,UAAU,GAAG,CAAC,EAAE,CAAC;YACnB,YAAY,GAAG,YAAY,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;QAChD,CAAC;IAAA,CACF,CAAC;IAEF,OAAO;QACL,QAAQ,CAAC,MAAmB,EAAE;YAC5B,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC1B,KAAK,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QAAA,CACzB;QACD,aAAa,GAAG;YACd,OAAO,eAAe,GAAG,mBAAmB,CAAC,YAAY,CAAC,CAAC;QAAA,CAC5D;QACD,YAAY,CAAC,GAAG,GAAW,IAAI,CAAC,GAAG,EAAE,EAAE;YACrC,KAAK,CAAC,GAAG,CAAC,CAAC;YACX,OAAO,YAAY,CAAC,YAAY,EAAE,GAAG,CAAC,CAAC;QAAA,CACxC;QACD,eAAe,GAAG;YAChB,OAAO,YAAY,CAAC;QAAA,CACrB;KACF,CAAC;AAAA,CACH","sourcesContent":["/**\n * Shared TPS + token counting utilities.\n *\n * Used by both backend (stats subscription) and frontend (streaming UI).\n */\n\nexport interface DeltaRecord {\n  tokens: number;\n  timestamp: number;\n  type: \"text\" | \"reasoning\" | \"tool-args\";\n}\n\nconst DEFAULT_TPS_WINDOW_MS = 60000; // 60 second trailing window\n\n/**\n * Calculate tokens-per-second from a history of delta records.\n */\nexport function calculateTPS(deltas: DeltaRecord[], now: number = Date.now()): number {\n  if (deltas.length === 0) return 0;\n\n  const windowStart = now - DEFAULT_TPS_WINDOW_MS;\n  const recentDeltas = deltas.filter((d) => d.timestamp >= windowStart);\n  if (recentDeltas.length === 0) return 0;\n\n  const totalTokens = recentDeltas.reduce((sum, d) => sum + (d.tokens || 0), 0);\n  const timeSpanMs = now - recentDeltas[0].timestamp;\n  const timeSpanSec = timeSpanMs / 1000;\n  if (timeSpanSec <= 0) return 0;\n\n  return Math.round(totalTokens / timeSpanSec);\n}\n\nexport function calculateTokenCount(deltas: DeltaRecord[]): number {\n  if ((deltas?.length ?? 0) === 0) return 0;\n  return deltas.reduce((sum, d) => sum + (d.tokens || 0), 0);\n}\n\nexport interface DeltaRecordStorage {\n  addDelta(record: DeltaRecord): void;\n  getTokenCount(): number;\n  calculateTPS(now?: number): number;\n  getRecentDeltas(): DeltaRecord[];\n}\n\nexport function createDeltaStorage(windowMs: number = DEFAULT_TPS_WINDOW_MS): DeltaRecordStorage {\n  let recentDeltas: DeltaRecord[] = [];\n  let olderTokenCount = 0;\n\n  const prune = (now: number): void => {\n    if (recentDeltas.length === 0) return;\n    const threshold = now - windowMs;\n\n    let pruneCount = 0;\n    for (const delta of recentDeltas) {\n      if (delta.timestamp < threshold) {\n        olderTokenCount += delta.tokens || 0;\n        pruneCount += 1;\n      } else {\n        break;\n      }\n    }\n\n    if (pruneCount > 0) {\n      recentDeltas = recentDeltas.slice(pruneCount);\n    }\n  };\n\n  return {\n    addDelta(record: DeltaRecord) {\n      recentDeltas.push(record);\n      prune(record.timestamp);\n    },\n    getTokenCount() {\n      return olderTokenCount + calculateTokenCount(recentDeltas);\n    },\n    calculateTPS(now: number = Date.now()) {\n      prune(now);\n      return calculateTPS(recentDeltas, now);\n    },\n    getRecentDeltas() {\n      return recentDeltas;\n    },\n  };\n}\n"]}