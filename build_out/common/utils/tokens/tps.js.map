{"version":3,"file":"tps.js","sourceRoot":"","sources":["../../../../src/common/utils/tokens/tps.ts"],"names":[],"mappings":";AAAA;;;;GAIG;;;;;AAQH,MAAM,qBAAqB,GAAG,KAAK,CAAC,CAAC,4BAA4B;AAEjE;;GAEG;AACH,sBAA6B,MAAqB,EAAE,GAAG,GAAW,IAAI,CAAC,GAAG,EAAE,EAAU;IACpF,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,CAAC,CAAC;IAElC,MAAM,WAAW,GAAG,GAAG,GAAG,qBAAqB,CAAC;IAChD,MAAM,YAAY,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,IAAI,WAAW,CAAC,CAAC;IACtE,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,CAAC,CAAC;IAExC,MAAM,WAAW,GAAG,YAAY,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;IAC9E,MAAM,UAAU,GAAG,GAAG,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;IACnD,MAAM,WAAW,GAAG,UAAU,GAAG,IAAI,CAAC;IACtC,IAAI,WAAW,IAAI,CAAC;QAAE,OAAO,CAAC,CAAC;IAE/B,OAAO,IAAI,CAAC,KAAK,CAAC,WAAW,GAAG,WAAW,CAAC,CAAC;AAAA,CAC9C;AAED,6BAAoC,MAAqB,EAAU;IACjE,IAAI,CAAC,MAAM,EAAE,MAAM,IAAI,CAAC,CAAC,KAAK,CAAC;QAAE,OAAO,CAAC,CAAC;IAC1C,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;AAAA,CAC5D;AASD,4BAAmC,QAAQ,GAAW,qBAAqB,EAAsB;IAC/F,IAAI,YAAY,GAAkB,EAAE,CAAC;IACrC,IAAI,eAAe,GAAG,CAAC,CAAC;IAExB,MAAM,KAAK,GAAG,CAAC,GAAW,EAAQ,EAAE,CAAC;QACnC,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;YAAE,OAAO;QACtC,MAAM,SAAS,GAAG,GAAG,GAAG,QAAQ,CAAC;QAEjC,IAAI,UAAU,GAAG,CAAC,CAAC;QACnB,KAAK,MAAM,KAAK,IAAI,YAAY,EAAE,CAAC;YACjC,IAAI,KAAK,CAAC,SAAS,GAAG,SAAS,EAAE,CAAC;gBAChC,eAAe,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,CAAC;gBACrC,UAAU,IAAI,CAAC,CAAC;YAClB,CAAC;iBAAM,CAAC;gBACN,MAAM;YACR,CAAC;QACH,CAAC;QAED,IAAI,UAAU,GAAG,CAAC,EAAE,CAAC;YACnB,YAAY,GAAG,YAAY,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;QAChD,CAAC;IAAA,CACF,CAAC;IAEF,OAAO;QACL,QAAQ,CAAC,MAAmB,EAAE;YAC5B,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC1B,KAAK,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QAAA,CACzB;QACD,aAAa,GAAG;YACd,OAAO,eAAe,GAAG,mBAAmB,CAAC,YAAY,CAAC,CAAC;QAAA,CAC5D;QACD,YAAY,CAAC,GAAG,GAAW,IAAI,CAAC,GAAG,EAAE,EAAE;YACrC,KAAK,CAAC,GAAG,CAAC,CAAC;YACX,OAAO,YAAY,CAAC,YAAY,EAAE,GAAG,CAAC,CAAC;QAAA,CACxC;QACD,eAAe,GAAG;YAChB,OAAO,YAAY,CAAC;QAAA,CACrB;KACF,CAAC;AAAA,CACH","sourcesContent":["/**\r\n * Shared TPS + token counting utilities.\r\n *\r\n * Used by both backend (stats subscription) and frontend (streaming UI).\r\n */\r\n\r\nexport interface DeltaRecord {\r\n  tokens: number;\r\n  timestamp: number;\r\n  type: \"text\" | \"reasoning\" | \"tool-args\";\r\n}\r\n\r\nconst DEFAULT_TPS_WINDOW_MS = 60000; // 60 second trailing window\r\n\r\n/**\r\n * Calculate tokens-per-second from a history of delta records.\r\n */\r\nexport function calculateTPS(deltas: DeltaRecord[], now: number = Date.now()): number {\r\n  if (deltas.length === 0) return 0;\r\n\r\n  const windowStart = now - DEFAULT_TPS_WINDOW_MS;\r\n  const recentDeltas = deltas.filter((d) => d.timestamp >= windowStart);\r\n  if (recentDeltas.length === 0) return 0;\r\n\r\n  const totalTokens = recentDeltas.reduce((sum, d) => sum + (d.tokens || 0), 0);\r\n  const timeSpanMs = now - recentDeltas[0].timestamp;\r\n  const timeSpanSec = timeSpanMs / 1000;\r\n  if (timeSpanSec <= 0) return 0;\r\n\r\n  return Math.round(totalTokens / timeSpanSec);\r\n}\r\n\r\nexport function calculateTokenCount(deltas: DeltaRecord[]): number {\r\n  if ((deltas?.length ?? 0) === 0) return 0;\r\n  return deltas.reduce((sum, d) => sum + (d.tokens || 0), 0);\r\n}\r\n\r\nexport interface DeltaRecordStorage {\r\n  addDelta(record: DeltaRecord): void;\r\n  getTokenCount(): number;\r\n  calculateTPS(now?: number): number;\r\n  getRecentDeltas(): DeltaRecord[];\r\n}\r\n\r\nexport function createDeltaStorage(windowMs: number = DEFAULT_TPS_WINDOW_MS): DeltaRecordStorage {\r\n  let recentDeltas: DeltaRecord[] = [];\r\n  let olderTokenCount = 0;\r\n\r\n  const prune = (now: number): void => {\r\n    if (recentDeltas.length === 0) return;\r\n    const threshold = now - windowMs;\r\n\r\n    let pruneCount = 0;\r\n    for (const delta of recentDeltas) {\r\n      if (delta.timestamp < threshold) {\r\n        olderTokenCount += delta.tokens || 0;\r\n        pruneCount += 1;\r\n      } else {\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (pruneCount > 0) {\r\n      recentDeltas = recentDeltas.slice(pruneCount);\r\n    }\r\n  };\r\n\r\n  return {\r\n    addDelta(record: DeltaRecord) {\r\n      recentDeltas.push(record);\r\n      prune(record.timestamp);\r\n    },\r\n    getTokenCount() {\r\n      return olderTokenCount + calculateTokenCount(recentDeltas);\r\n    },\r\n    calculateTPS(now: number = Date.now()) {\r\n      prune(now);\r\n      return calculateTPS(recentDeltas, now);\r\n    },\r\n    getRecentDeltas() {\r\n      return recentDeltas;\r\n    },\r\n  };\r\n}\r\n"]}