{"version":3,"file":"policy.js","sourceRoot":"","sources":["../../../../src/common/utils/thinking/policy.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Thinking policy per model\n *\n * Represents allowed thinking levels for a model as a simple subset.\n * The policy naturally expresses model capabilities:\n * - [\"high\"] = Fixed policy (e.g., gpt-5-pro only supports HIGH)\n * - [\"off\"] = No reasoning capability\n * - [\"off\", \"low\", \"medium\", \"high\"] = Fully selectable\n *\n * UI behavior derives from the subset:\n * - Single element = Non-interactive display\n * - Multiple elements = User can select from options\n */\n\nimport {\n  THINKING_LEVELS,\n  type ThinkingLevel,\n  type ParsedThinkingInput,\n} from \"@/common/types/thinking\";\n\n/**\n * Thinking policy is simply the set of allowed thinking levels for a model.\n * Pure subset design - no wrapper object, no discriminated union.\n */\nexport type ThinkingPolicy = readonly ThinkingLevel[];\n\n/**\n * Returns the thinking policy for a given model.\n *\n * Rules:\n * - openai:gpt-5.1-codex-max → [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"] (5 levels including xhigh)\n * - openai:gpt-5.2-codex → [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"] (5 levels including xhigh)\n * - openai:gpt-5.3-codex → [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"] (5 levels including xhigh)\n * - openai:gpt-5.2 → [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"] (5 levels including xhigh)\n * - openai:gpt-5.2-pro → [\"medium\", \"high\", \"xhigh\"] (3 levels)\n * - openai:gpt-5-pro → [\"high\"] (only supported level, legacy)\n * - gemini-3 → [\"low\", \"high\"] (thinking level only)\n * - default → [\"off\", \"low\", \"medium\", \"high\"] (standard 4 levels; xhigh is opt-in per model)\n *\n * Tolerates version suffixes (e.g., gpt-5-pro-2025-10-06).\n * Does NOT match gpt-5-pro-mini (uses negative lookahead).\n */\nexport function getThinkingPolicyForModel(modelString: string): ThinkingPolicy {\n  // Normalize to be robust to provider prefixes, whitespace, gateway wrappers, and version suffixes\n  const normalized = modelString.trim().toLowerCase();\n  const withoutPrefix = normalized.replace(/^[a-z0-9_-]+:\\s*/, \"\");\n\n  // Many providers/proxies encode the upstream provider as a path segment:\n  //   mux-gateway:openai/gpt-5.2-pro -> openai/gpt-5.2-pro -> gpt-5.2-pro\n  const withoutProviderNamespace = withoutPrefix.replace(/^[a-z0-9_-]+\\//, \"\");\n\n  // Claude Opus 4.6 supports 5 levels including xhigh (mapped to \"max\" effort)\n  if (withoutProviderNamespace.includes(\"opus-4-6\")) {\n    return [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"];\n  }\n\n  // GPT-5.1-Codex-Max supports 5 reasoning levels including xhigh (Extra High)\n  if (\n    withoutProviderNamespace.startsWith(\"gpt-5.1-codex-max\") ||\n    withoutProviderNamespace.startsWith(\"codex-max\")\n  ) {\n    return [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"];\n  }\n\n  // GPT-5.2-Codex and GPT-5.3-Codex support 5 reasoning levels including xhigh (Extra High)\n  if (/^gpt-5\\.[23]-codex(?!-[a-z])/.test(withoutProviderNamespace)) {\n    return [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"];\n  }\n\n  // gpt-5.2-pro supports medium, high, xhigh reasoning levels\n  if (/^gpt-5\\.2-pro(?!-[a-z])/.test(withoutProviderNamespace)) {\n    return [\"medium\", \"high\", \"xhigh\"];\n  }\n\n  // gpt-5.2 supports 5 reasoning levels including xhigh (Extra High)\n  if (/^gpt-5\\.2(?!-[a-z])/.test(withoutProviderNamespace)) {\n    return [\"off\", \"low\", \"medium\", \"high\", \"xhigh\"];\n  }\n\n  // gpt-5-pro (legacy) only supports high\n  if (/^gpt-5-pro(?!-[a-z])/.test(withoutProviderNamespace)) {\n    return [\"high\"];\n  }\n\n  // Gemini 3 Flash supports 4 levels: off (minimal), low, medium, high\n  if (withoutProviderNamespace.includes(\"gemini-3-flash\")) {\n    return [\"off\", \"low\", \"medium\", \"high\"];\n  }\n\n  // Gemini 3 Pro only supports \"low\" and \"high\" reasoning levels\n  if (withoutProviderNamespace.includes(\"gemini-3\")) {\n    return [\"low\", \"high\"];\n  }\n\n  // Default policy: standard 4 levels (off/low/medium/high). Models with xhigh must opt in above.\n  return [\"off\", \"low\", \"medium\", \"high\"];\n}\n\n/**\n * Enforce thinking policy by clamping requested level to allowed set.\n *\n * Fallback strategy:\n * 1. If requested level is allowed, use it.\n * 2. If the request is above the model's maximum, clamp to the highest allowed level.\n * 3. If the request is below the model's minimum, clamp to the lowest allowed level.\n * 4. Otherwise, pick the closest allowed level by order.\n */\nexport function enforceThinkingPolicy(\n  modelString: string,\n  requested: ThinkingLevel\n): ThinkingLevel {\n  const allowed = getThinkingPolicyForModel(modelString);\n\n  if (allowed.includes(requested)) {\n    return requested;\n  }\n\n  const orderedAllowed = [...allowed].sort(\n    (left, right) => THINKING_LEVELS.indexOf(left) - THINKING_LEVELS.indexOf(right)\n  );\n  const minAllowed = orderedAllowed[0] ?? \"off\";\n  const maxAllowed = orderedAllowed[orderedAllowed.length - 1] ?? minAllowed;\n  const requestedIndex = THINKING_LEVELS.indexOf(requested);\n\n  if (requestedIndex <= THINKING_LEVELS.indexOf(minAllowed)) {\n    return minAllowed;\n  }\n\n  if (requestedIndex >= THINKING_LEVELS.indexOf(maxAllowed)) {\n    return maxAllowed;\n  }\n\n  const closest = orderedAllowed.reduce((nearest, level) => {\n    const nearestIndex = THINKING_LEVELS.indexOf(nearest);\n    const levelIndex = THINKING_LEVELS.indexOf(level);\n    return Math.abs(levelIndex - requestedIndex) < Math.abs(nearestIndex - requestedIndex)\n      ? level\n      : nearest;\n  }, minAllowed);\n\n  return closest;\n}\n/**\n * Resolve a parsed thinking input to a concrete ThinkingLevel for a given model.\n *\n * Named levels are returned as-is (the backend's enforceThinkingPolicy will\n * clamp if needed). Numeric indices are mapped into the model's sorted allowed\n * levels — so 0 always means the model's lowest allowed level (e.g., \"medium\"\n * for gpt-5.2-pro, \"off\" for most other models), and the highest index means\n * the model's highest level. Out-of-range indices clamp to min/max.\n */\nexport function resolveThinkingInput(\n  input: ParsedThinkingInput,\n  modelString: string\n): ThinkingLevel {\n  // Named levels pass through directly\n  if (typeof input === \"string\") return input;\n\n  // Numeric: index into the model's allowed levels (sorted lowest → highest)\n  const policy = getThinkingPolicyForModel(modelString);\n  const sorted = [...policy].sort(\n    (a, b) => THINKING_LEVELS.indexOf(a) - THINKING_LEVELS.indexOf(b)\n  );\n  const clamped = Math.max(0, Math.min(input, sorted.length - 1));\n  return sorted[clamped] ?? sorted[0] ?? \"off\";\n}\n"]}