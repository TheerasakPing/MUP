{"version":3,"file":"codexOAuth.js","sourceRoot":"","sources":["../../../src/common/constants/codexOAuth.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Codex OAuth constants and helpers.\n *\n * Codex (ChatGPT subscription) authentication uses ChatGPT OAuth tokens rather\n * than a standard OpenAI API key.\n *\n * This module is intentionally shared (common/) so both the backend and future\n * UI can reference the same endpoints and model gating rules.\n */\n\n// NOTE: These endpoints + params follow the OpenCode Codex OAuth guide.\n// If OpenAI changes them, keep all updates centralized here.\n\nexport const CODEX_OAUTH_ORIGIN = \"https://auth.openai.com\";\n\n// Public OAuth client id for ChatGPT/Codex flows.\n//\n// The exact value is not a secret, but it is intentionally centralized so we\n// can update it without hunting through backend/UI code.\nexport const CODEX_OAUTH_CLIENT_ID = \"app_EMoamEEZ73f0CkXaXp7hrann\";\n\nexport const CODEX_OAUTH_AUTHORIZE_URL = `${CODEX_OAUTH_ORIGIN}/oauth/authorize`;\nexport const CODEX_OAUTH_TOKEN_URL = `${CODEX_OAUTH_ORIGIN}/oauth/token`;\n\n// ChatGPT subscription endpoint for Codex-flavored requests.\n//\n// IMPORTANT: This is *not* the public OpenAI platform endpoint (api.openai.com).\n// Codex OAuth tokens are only valid against this ChatGPT backend.\nexport const CODEX_ENDPOINT = \"https://chatgpt.com/backend-api/codex/responses\";\n\n// We request offline_access to receive refresh tokens.\nexport const CODEX_OAUTH_SCOPE = \"openid profile email offline_access\";\n\n// Desktop browser redirect URI used by the simplified flow.\nexport const CODEX_OAUTH_BROWSER_REDIRECT_URI = \"http://localhost:1455/auth/callback\";\n\n// Codex-specific device auth endpoints.\nexport const CODEX_OAUTH_DEVICE_USERCODE_URL = `${CODEX_OAUTH_ORIGIN}/api/accounts/deviceauth/usercode`;\nexport const CODEX_OAUTH_DEVICE_TOKEN_POLL_URL = `${CODEX_OAUTH_ORIGIN}/api/accounts/deviceauth/token`;\nexport const CODEX_OAUTH_DEVICE_VERIFY_URL = `${CODEX_OAUTH_ORIGIN}/codex/device`;\n\nexport function buildCodexAuthorizeUrl(input: {\n  redirectUri: string;\n  state: string;\n  codeChallenge: string;\n}): string {\n  const url = new URL(CODEX_OAUTH_AUTHORIZE_URL);\n  url.searchParams.set(\"response_type\", \"code\");\n  url.searchParams.set(\"client_id\", CODEX_OAUTH_CLIENT_ID);\n  url.searchParams.set(\"redirect_uri\", input.redirectUri);\n  url.searchParams.set(\"scope\", CODEX_OAUTH_SCOPE);\n  url.searchParams.set(\"state\", input.state);\n  url.searchParams.set(\"code_challenge\", input.codeChallenge);\n  url.searchParams.set(\"code_challenge_method\", \"S256\");\n\n  // Extra authorize params required by the Codex flow.\n  url.searchParams.set(\"id_token_add_organizations\", \"true\");\n  url.searchParams.set(\"codex_cli_simplified_flow\", \"true\");\n  url.searchParams.set(\"originator\", \"mux\");\n\n  return url.toString();\n}\n\nexport function buildCodexTokenExchangeBody(input: {\n  code: string;\n  redirectUri: string;\n  codeVerifier: string;\n}): URLSearchParams {\n  const body = new URLSearchParams();\n  body.set(\"grant_type\", \"authorization_code\");\n  body.set(\"client_id\", CODEX_OAUTH_CLIENT_ID);\n  body.set(\"code\", input.code);\n  body.set(\"redirect_uri\", input.redirectUri);\n  body.set(\"code_verifier\", input.codeVerifier);\n  return body;\n}\n\nexport function buildCodexRefreshBody(input: { refreshToken: string }): URLSearchParams {\n  const body = new URLSearchParams();\n  body.set(\"grant_type\", \"refresh_token\");\n  body.set(\"client_id\", CODEX_OAUTH_CLIENT_ID);\n  body.set(\"refresh_token\", input.refreshToken);\n  return body;\n}\n\n/**\n * Models that may be routed through the Codex OAuth path.\n *\n * The values in this set are providerModelIds (no `openai:` prefix).\n */\nexport const CODEX_OAUTH_ALLOWED_MODELS = new Set<string>([\n  \"gpt-5.1-codex-max\",\n  \"gpt-5.1-codex-mini\",\n  \"gpt-5.2\",\n  \"gpt-5.2-codex\",\n  \"gpt-5.3-codex\",\n  \"gpt-5.1-codex\",\n]);\n\n/**\n * Models that *prefer* Codex OAuth routing.\n *\n * These models are initially gated behind OAuth but eventually become available\n * via regular API keys.  When the user has OAuth connected, we route through it;\n * otherwise we fall back to their API key and let OpenAI decide whether the\n * model is accessible.\n */\nexport const CODEX_OAUTH_REQUIRED_MODELS = new Set<string>([\n  \"gpt-5.1-codex-max\",\n  \"gpt-5.1-codex-mini\",\n  \"gpt-5.2-codex\",\n  \"gpt-5.3-codex\",\n  \"gpt-5.1-codex\",\n]);\n\nfunction normalizeCodexOauthModelId(modelId: string): string {\n  // Accept either provider:model or bare model ids and normalize to providerModelId.\n  const colonIndex = modelId.indexOf(\":\");\n  if (colonIndex !== -1) {\n    return modelId.slice(colonIndex + 1);\n  }\n\n  return modelId;\n}\n\nexport function isCodexOauthAllowedModelId(modelId: string): boolean {\n  return CODEX_OAUTH_ALLOWED_MODELS.has(normalizeCodexOauthModelId(modelId));\n}\n\nexport function isCodexOauthRequiredModelId(modelId: string): boolean {\n  return CODEX_OAUTH_REQUIRED_MODELS.has(normalizeCodexOauthModelId(modelId));\n}\n"]}