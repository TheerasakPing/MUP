{"version":3,"file":"storage.test.js","sourceRoot":"","sources":["../../../src/common/constants/storage.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { afterEach, beforeEach, describe, expect, test } from \"bun:test\";\nimport {\n  copyWorkspaceStorage,\n  deleteWorkspaceStorage,\n  getDraftScopeId,\n  getInputAttachmentsKey,\n} from \"@/common/constants/storage\";\n\nclass MemoryStorage implements Storage {\n  private readonly map = new Map<string, string>();\n\n  get length(): number {\n    return this.map.size;\n  }\n\n  clear(): void {\n    this.map.clear();\n  }\n\n  getItem(key: string): string | null {\n    return this.map.get(key) ?? null;\n  }\n\n  key(index: number): string | null {\n    const keys = Array.from(this.map.keys());\n    return keys[index] ?? null;\n  }\n\n  removeItem(key: string): void {\n    this.map.delete(key);\n  }\n\n  setItem(key: string, value: string): void {\n    this.map.set(key, value);\n  }\n}\n\ndescribe(\"storage workspace-scoped keys\", () => {\n  let originalLocalStorage: Storage | undefined;\n\n  beforeEach(() => {\n    // The helpers in src/common/constants/storage.ts rely on global localStorage.\n    // In tests we install a minimal in-memory implementation.\n    originalLocalStorage = globalThis.localStorage;\n    globalThis.localStorage = new MemoryStorage();\n  });\n\n  afterEach(() => {\n    if (originalLocalStorage) {\n      globalThis.localStorage = originalLocalStorage;\n    } else {\n      delete (globalThis as { localStorage?: unknown }).localStorage;\n    }\n  });\n\n  test(\"getDraftScopeId formats scope id\", () => {\n    expect(getDraftScopeId(\"/Users/me/repo\", \"draft-123\")).toBe(\n      \"__draft__//Users/me/repo/draft-123\"\n    );\n  });\n\n  test(\"getInputAttachmentsKey formats key\", () => {\n    expect(getInputAttachmentsKey(\"ws-123\")).toBe(\"inputAttachments:ws-123\");\n  });\n\n  test(\"copyWorkspaceStorage copies inputAttachments key\", () => {\n    const source = \"ws-source\";\n    const dest = \"ws-dest\";\n\n    const sourceKey = getInputAttachmentsKey(source);\n    const destKey = getInputAttachmentsKey(dest);\n\n    const value = JSON.stringify([\n      { id: \"img-1\", url: \"data:image/png;base64,AAA\", mediaType: \"image/png\" },\n    ]);\n    localStorage.setItem(sourceKey, value);\n\n    copyWorkspaceStorage(source, dest);\n\n    expect(localStorage.getItem(destKey)).toBe(value);\n  });\n\n  test(\"deleteWorkspaceStorage removes inputAttachments key\", () => {\n    const workspaceId = \"ws-delete\";\n    const key = getInputAttachmentsKey(workspaceId);\n\n    localStorage.setItem(key, \"value\");\n    deleteWorkspaceStorage(workspaceId);\n\n    expect(localStorage.getItem(key)).toBeNull();\n  });\n});\n"]}