{"version":3,"file":"payload.js","sourceRoot":"","sources":["../../../src/common/telemetry/payload.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;;;;;;;GAoBG","sourcesContent":["/**\r\n * Telemetry Payload Definitions\r\n *\r\n * This file defines all data structures sent to PostHog for user transparency.\r\n * Users can inspect this file to understand exactly what telemetry data is collected.\r\n *\r\n * PRIVACY GUIDELINES:\r\n * - Randomly generated IDs (e.g., workspace IDs, session IDs) can be sent verbatim\r\n *   as they contain no user information and are not guessable.\r\n * - Display names, project names, file paths, or anything that could reveal the\r\n *   nature of the user's work MUST NOT be sent, even if hashed.\r\n *   Hashing is vulnerable to rainbow table attacks and brute-force, especially\r\n *   for common project names or predictable patterns.\r\n * - For numerical metrics that could leak information (like message lengths), use\r\n *   base-2 rounding (e.g., 128, 256, 512) to preserve privacy while enabling analysis.\r\n * - When in doubt, don't send it. Privacy is paramount.\r\n *\r\n * NOTE: Base properties (version, backend_platform, electronVersion, nodeVersion,\r\n * bunVersion) are automatically added by the backend TelemetryService. Frontend\r\n * code only needs to provide event-specific properties.\r\n */\r\n\r\nimport type { RuntimeMode } from \"@/common/types/runtime\";\r\n\r\n/**\r\n * Base properties included with all telemetry events\r\n * These are added by the backend, not the frontend\r\n */\r\nexport interface BaseTelemetryProperties {\r\n  /** Application version */\r\n  version: string;\r\n  /** Backend operating system platform (darwin, win32, linux) - where Node.js/backend runs */\r\n  backend_platform: NodeJS.Platform | \"unknown\";\r\n  /** Electron version (if running in Electron) */\r\n  electronVersion: string;\r\n  /** Node.js version */\r\n  nodeVersion: string;\r\n  /** Bun version (if running in Bun) */\r\n  bunVersion: string;\r\n}\r\n\r\n/**\r\n * Application lifecycle events\r\n */\r\nexport interface AppStartedPayload {\r\n  /** Whether this is the first app launch */\r\n  isFirstLaunch: boolean;\r\n  /** Whether vim mode is enabled at startup */\r\n  vimModeEnabled: boolean;\r\n}\r\n\r\n/**\r\n * Runtime type for telemetry - derived from RuntimeMode to stay in sync.\r\n * Values: 'local' (project-dir), 'worktree' (git worktree isolation), 'ssh' (remote), 'docker' (container)\r\n */\r\nexport type TelemetryRuntimeType = RuntimeMode;\r\n\r\n/**\r\n * Frontend platform info - browser/client environment\r\n * Useful when backend runs on different machine (e.g., mux server mode)\r\n */\r\nexport interface FrontendPlatformInfo {\r\n  /** Browser user agent string (safe, widely shared) */\r\n  userAgent: string;\r\n  /** Client platform from navigator.platform */\r\n  platform: string;\r\n}\r\n\r\n/**\r\n * Workspace events\r\n */\r\nexport interface WorkspaceCreatedPayload {\r\n  /** Workspace ID (randomly generated, safe to send) */\r\n  workspaceId: string;\r\n  /** Runtime type for the workspace */\r\n  runtimeType: TelemetryRuntimeType;\r\n  /** Frontend platform info */\r\n  frontendPlatform: FrontendPlatformInfo;\r\n}\r\n\r\nexport interface WorkspaceSwitchedPayload {\r\n  /** Previous workspace ID (randomly generated, safe to send) */\r\n  fromWorkspaceId: string;\r\n  /** New workspace ID (randomly generated, safe to send) */\r\n  toWorkspaceId: string;\r\n}\r\n\r\n/**\r\n * Thinking level for extended thinking feature\r\n */\r\nexport type TelemetryThinkingLevel = \"off\" | \"low\" | \"medium\" | \"high\" | \"xhigh\" | \"max\";\r\n\r\n/**\r\n * Chat/AI interaction events\r\n */\r\nexport interface MessageSentPayload {\r\n  /** Workspace ID (randomly generated, safe to send) */\r\n  workspaceId: string;\r\n  /** Full model identifier (e.g., 'anthropic/claude-3-5-sonnet-20241022') */\r\n  model: string;\r\n  /** Agent id (e.g., 'plan', 'exec', 'explore'). Optional for legacy clients. */\r\n  agentId?: string;\r\n  /** Message length rounded to nearest power of 2 (e.g., 128, 256, 512, 1024) */\r\n  message_length_b2: number;\r\n  /** Runtime type for the workspace */\r\n  runtimeType: TelemetryRuntimeType;\r\n  /** Frontend platform info */\r\n  frontendPlatform: FrontendPlatformInfo;\r\n  /** Extended thinking level */\r\n  thinkingLevel: TelemetryThinkingLevel;\r\n}\r\n\r\n/**\r\n * MCP usage events\r\n */\r\nexport type TelemetryMCPTransportMode = \"none\" | \"stdio_only\" | \"http_only\" | \"sse_only\" | \"mixed\";\r\n\r\nexport interface MCPContextInjectedPayload {\r\n  /** Workspace ID (randomly generated, safe to send) */\r\n  workspaceId: string;\r\n  /** Full model identifier */\r\n  model: string;\r\n  /** Active agent definition id (e.g. \"plan\", \"exec\", \"explore\"). Optional for backwards compatibility. */\r\n  agentId?: string;\r\n  /** Runtime type for the workspace */\r\n  runtimeType: TelemetryRuntimeType;\r\n\r\n  /** How many servers are enabled for this workspace message */\r\n  mcp_server_enabled_count: number;\r\n  /** How many servers successfully started (client created + tools fetched) */\r\n  mcp_server_started_count: number;\r\n  /** How many enabled servers failed to start */\r\n  mcp_server_failed_count: number;\r\n\r\n  /** MCP tools injected into the model request */\r\n  mcp_tool_count: number;\r\n  /** Total tools injected into the model request (built-in + MCP) */\r\n  total_tool_count: number;\r\n  /** Built-in tool count injected into the model request */\r\n  builtin_tool_count: number;\r\n\r\n  /** Effective transport mix for *started* servers (auto transport is resolved to http/sse) */\r\n  mcp_transport_mode: TelemetryMCPTransportMode;\r\n  /** Whether any started server uses HTTP (auto transport resolves to http/sse at runtime) */\r\n  mcp_has_http: boolean;\r\n  /** Whether any started server uses legacy SSE */\r\n  mcp_has_sse: boolean;\r\n  /** Whether any started server uses stdio */\r\n  mcp_has_stdio: boolean;\r\n\r\n  /** Number of servers that required auto-fallback from HTTP to SSE */\r\n  mcp_auto_fallback_count: number;\r\n\r\n  /** Time spent preparing MCP servers/tools (ms, rounded to nearest power of 2) */\r\n  mcp_setup_duration_ms_b2: number;\r\n}\r\n\r\nexport type TelemetryMCPServerTransport = \"stdio\" | \"http\" | \"sse\" | \"auto\";\r\nexport type TelemetryMCPTestErrorCategory = \"timeout\" | \"connect\" | \"http_status\" | \"unknown\";\r\n\r\nexport interface MCPServerTestedPayload {\r\n  transport: TelemetryMCPServerTransport;\r\n  success: boolean;\r\n  duration_ms_b2: number;\r\n  /** Error category when success=false (no raw error messages for privacy) */\r\n  error_category?: TelemetryMCPTestErrorCategory;\r\n}\r\n\r\nexport type TelemetryMCPServerConfigAction =\r\n  | \"add\"\r\n  | \"edit\"\r\n  | \"remove\"\r\n  | \"enable\"\r\n  | \"disable\"\r\n  | \"set_tool_allowlist\"\r\n  | \"set_headers\";\r\n\r\nexport interface MCPServerConfigChangedPayload {\r\n  action: TelemetryMCPServerConfigAction;\r\n  transport: TelemetryMCPServerTransport;\r\n  has_headers: boolean;\r\n  uses_secret_headers: boolean;\r\n  /** Only set when action=set_tool_allowlist */\r\n  tool_allowlist_size_b2?: number;\r\n}\r\n\r\nexport type TelemetryMCPOAuthFlowErrorCategory =\r\n  | \"timeout\"\r\n  | \"cancelled\"\r\n  | \"state_mismatch\"\r\n  | \"provider_error\"\r\n  | \"unknown\";\r\n\r\nexport interface MCPOAuthFlowStartedPayload {\r\n  transport: TelemetryMCPServerTransport;\r\n  has_scope_hint: boolean;\r\n  has_resource_metadata_hint: boolean;\r\n}\r\n\r\nexport interface MCPOAuthFlowCompletedPayload {\r\n  transport: TelemetryMCPServerTransport;\r\n  duration_ms_b2: number;\r\n  has_scope_hint: boolean;\r\n  has_resource_metadata_hint: boolean;\r\n}\r\n\r\nexport interface MCPOAuthFlowFailedPayload {\r\n  transport: TelemetryMCPServerTransport;\r\n  duration_ms_b2: number;\r\n  has_scope_hint: boolean;\r\n  has_resource_metadata_hint: boolean;\r\n  error_category: TelemetryMCPOAuthFlowErrorCategory;\r\n}\r\n/**\r\n * Stats tab event - tracks when users view timing stats.\r\n */\r\nexport interface StatsTabOpenedPayload {\r\n  viewMode: \"session\" | \"last-request\";\r\n  showModeBreakdown: boolean;\r\n}\r\n\r\n/**\r\n * Stream timing computed - emitted by backend timing pipeline.\r\n *\r\n * All numeric metrics are base-2 rounded or bucketed to preserve privacy.\r\n */\r\nexport interface StreamTimingComputedPayload {\r\n  model: string;\r\n  agentId?: string;\r\n  duration_b2: number;\r\n  ttft_ms_b2: number;\r\n  tool_ms_b2: number;\r\n  streaming_ms_b2: number;\r\n  tool_percent_bucket: number;\r\n  invalid: boolean;\r\n}\r\n\r\n/**\r\n * Stream timing invalid - emitted when any computed % would exceed 100%,\r\n * durations are negative, or values are NaN.\r\n */\r\nexport interface StreamTimingInvalidPayload {\r\n  reason: string;\r\n}\r\n\r\n/**\r\n * Stream completion event - tracks when AI responses finish\r\n */\r\nexport interface StreamCompletedPayload {\r\n  /** Model used for generation */\r\n  model: string;\r\n  /** Whether the stream was interrupted by user vs natural completion */\r\n  wasInterrupted: boolean;\r\n  /** Duration in seconds, rounded to nearest power of 2 */\r\n  duration_b2: number;\r\n  /** Output tokens, rounded to nearest power of 2 */\r\n  output_tokens_b2: number;\r\n}\r\n\r\n/**\r\n * Compaction completion event - tracks when history compaction finishes\r\n */\r\nexport interface CompactionCompletedPayload {\r\n  /** Model used for compaction */\r\n  model: string;\r\n  /** Duration in seconds, rounded to nearest power of 2 */\r\n  duration_b2: number;\r\n  /** Input tokens (pre-compaction history size), rounded to nearest power of 2 */\r\n  input_tokens_b2: number;\r\n  /** Output tokens (post-compaction summary size), rounded to nearest power of 2 */\r\n  output_tokens_b2: number;\r\n  /** Whether this compaction was user-triggered vs idle */\r\n  compaction_source: \"manual\" | \"idle\";\r\n}\r\n\r\n/**\r\n * Provider configuration event - tracks when users set up providers\r\n * Note: Only tracks that a key was set, never the actual value\r\n */\r\nexport interface ProviderConfiguredPayload {\r\n  /** Provider name (e.g., 'anthropic', 'openai', 'mux-gateway') */\r\n  provider: string;\r\n  /** Key type that was configured (e.g., 'apiKey', 'couponCode', 'baseUrl') */\r\n  keyType: string;\r\n}\r\n\r\n/**\r\n * Slash command types for telemetry (no arguments/values)\r\n */\r\nexport type TelemetryCommandType =\r\n  | \"clear\"\r\n  | \"compact\"\r\n  | \"new\"\r\n  | \"fork\"\r\n  | \"vim\"\r\n  | \"model\"\r\n  | \"mode\"\r\n  | \"plan\"\r\n  | \"providers\";\r\n\r\n/**\r\n * Command usage event - tracks slash command usage patterns\r\n */\r\nexport interface CommandUsedPayload {\r\n  /** Command type (without arguments for privacy) */\r\n  command: TelemetryCommandType;\r\n}\r\n\r\n/**\r\n * Voice transcription event - tracks voice input usage\r\n */\r\nexport interface VoiceTranscriptionPayload {\r\n  /** Duration of audio in seconds, rounded to nearest power of 2 */\r\n  audio_duration_b2: number;\r\n  /** Whether the transcription succeeded */\r\n  success: boolean;\r\n}\r\n\r\n/**\r\n * Error tracking context types (explicit enum for transparency)\r\n */\r\nexport type ErrorContext =\r\n  | \"workspace-creation\"\r\n  | \"workspace-deletion\"\r\n  | \"workspace-switch\"\r\n  | \"message-send\"\r\n  | \"message-stream\"\r\n  | \"project-add\"\r\n  | \"project-remove\"\r\n  | \"git-operation\";\r\n\r\n/**\r\n * Error tracking events\r\n */\r\nexport interface ErrorOccurredPayload {\r\n  /** Error type/name */\r\n  errorType: string;\r\n  /** Error context - where the error occurred */\r\n  context: ErrorContext;\r\n}\r\n\r\n/**\r\n * Experiment override event - tracks when users manually toggle experiments\r\n * This helps measure opt-out rates and understand user preferences\r\n */\r\nexport interface ExperimentOverriddenPayload {\r\n  /** Experiment identifier (e.g., 'system-1') */\r\n  experimentId: string;\r\n  /** The variant PostHog assigned (null if not remote-controlled) */\r\n  assignedVariant: string | boolean | null;\r\n  /** What the user chose (true = enabled, false = disabled) */\r\n  userChoice: boolean;\r\n}\r\n\r\n/**\r\n * Union type of all telemetry event payloads\r\n * Frontend sends these; backend adds BaseTelemetryProperties before forwarding to PostHog\r\n */\r\nexport type TelemetryEventPayload =\r\n  | { event: \"app_started\"; properties: AppStartedPayload }\r\n  | { event: \"workspace_created\"; properties: WorkspaceCreatedPayload }\r\n  | { event: \"workspace_switched\"; properties: WorkspaceSwitchedPayload }\r\n  | { event: \"message_sent\"; properties: MessageSentPayload }\r\n  | { event: \"mcp_context_injected\"; properties: MCPContextInjectedPayload }\r\n  | { event: \"mcp_server_tested\"; properties: MCPServerTestedPayload }\r\n  | { event: \"mcp_server_config_changed\"; properties: MCPServerConfigChangedPayload }\r\n  | { event: \"mcp_oauth_flow_started\"; properties: MCPOAuthFlowStartedPayload }\r\n  | { event: \"mcp_oauth_flow_completed\"; properties: MCPOAuthFlowCompletedPayload }\r\n  | { event: \"mcp_oauth_flow_failed\"; properties: MCPOAuthFlowFailedPayload }\r\n  | { event: \"stats_tab_opened\"; properties: StatsTabOpenedPayload }\r\n  | { event: \"stream_timing_computed\"; properties: StreamTimingComputedPayload }\r\n  | { event: \"stream_timing_invalid\"; properties: StreamTimingInvalidPayload }\r\n  | { event: \"stream_completed\"; properties: StreamCompletedPayload }\r\n  | { event: \"compaction_completed\"; properties: CompactionCompletedPayload }\r\n  | { event: \"provider_configured\"; properties: ProviderConfiguredPayload }\r\n  | { event: \"command_used\"; properties: CommandUsedPayload }\r\n  | { event: \"voice_transcription\"; properties: VoiceTranscriptionPayload }\r\n  | { event: \"error_occurred\"; properties: ErrorOccurredPayload }\r\n  | { event: \"experiment_overridden\"; properties: ExperimentOverriddenPayload };\r\n"]}