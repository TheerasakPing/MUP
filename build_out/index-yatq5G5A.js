import{w as J,N as V,f as _,e as x,h as O,g as b,T as A,p as $,U as k,D,o as W,J as L,q as F}from"./index-CGwOAdyT.js";import{o as y,s as f,b as w,n as c,a as R,u as z,f as P,r as B}from"./main-B2XpWmPF.js";import"./types-CUi3gq4E.js";import"./TerminalRouterContext-CeKE7fio.js";function G({prompt:e,user:t="user",assistant:a="assistant"}){let o="";e[0].role==="system"&&(o+=`${e[0].content}

`,e=e.slice(1));for(const{role:i,content:n}of e)switch(i){case"system":throw new D({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{const s=n.map(r=>{switch(r.type){case"text":return r.text}}).filter(Boolean).join("");o+=`${t}:
${s}

`;break}case"assistant":{const s=n.map(r=>{switch(r.type){case"text":return r.text;case"tool-call":throw new k({functionality:"tool-call messages"})}}).join("");o+=`${a}:
${s}

`;break}case"tool":throw new k({functionality:"tool messages"});default:{const s=i;throw new Error(`Unsupported role: ${s}`)}}return o+=`${a}:
`,{prompt:o,stopSequences:[`
${t}:`]}}function T(e){switch(e){case"stop":return{raw:e,unified:"stop"};case"length":return{raw:e,unified:"length"};case"content_filter":return{raw:e,unified:"content-filter"};case"function_call":case"tool_calls":return{raw:e,unified:"tool-calls"};default:return{raw:e,unified:"other"}}}function I({model:e,created_at:t}){return{id:void 0,modelId:e??void 0,timestamp:t!=null?new Date(t):void 0}}function N(e){return async({response:t})=>{const a=L(t);if(t.body==null)throw new Error("Response body is null");const o=t.body.getReader(),i=new TextDecoder;let n="";const s=new ReadableStream({async pull(r){for(;;){const{done:l,value:h}=await o.read();if(l){if(n.trim())try{const d=JSON.parse(n.trim()),p=e.parse(d);r.enqueue({success:!0,value:p,rawValue:p})}catch{}r.close();return}n+=i.decode(h,{stream:!0});const u=n.split(`
`);n=u.pop()||"";for(const d of u){const p=d.trim();if(p)try{const m=JSON.parse(p),g=e.parse(m);r.enqueue({success:!0,value:g,rawValue:g})}catch(m){console.warn("Failed to parse NDJSON line:",m)}}}},cancel(){o.cancel()}});return{responseHeaders:a,value:s}}}var K=y({error:y({message:f(),type:f().nullish(),param:P().nullish(),code:z([f(),c()]).nullish()})}),S=W({errorSchema:K,errorToMessage:e=>e.error.message});y({think:w().optional(),user:f().optional(),suffix:f().optional(),echo:w().optional()});var Q=class{constructor(e,t,a){this.specificationVersion="v3",this.defaultObjectGenerationMode=void 0,this.supportsImageUrls=!1,this.supportedUrls={},this.modelId=e,this.settings=t,this.config=a,this.provider=a.provider}getArgs({prompt:e,maxOutputTokens:t,temperature:a,topP:o,topK:i,frequencyPenalty:n,presencePenalty:s,stopSequences:r,responseFormat:l,tools:h,toolChoice:u,seed:d}){const p=[];i!=null&&p.push({type:"unsupported",feature:"topK"}),h?.length&&p.push({type:"unsupported",feature:"tools"}),u!=null&&p.push({type:"unsupported",feature:"toolChoice"}),l!=null&&l.type!=="text"&&p.push({type:"unsupported",feature:"responseFormat (JSON)"});const{prompt:m,stopSequences:g}=G({prompt:e}),v=[...g??[],...r??[]];return{args:{model:this.modelId,user:this.settings.user,think:this.settings.think,max_tokens:t,temperature:a,top_p:o,frequency_penalty:n,presence_penalty:s,stop:v,prompt:m,suffix:this.settings.suffix,echo:this.settings.echo,stream:!1},warnings:p}}async doGenerate(e){var t,a;const{args:o,warnings:i}=this.getArgs(e),{responseHeaders:n,value:s,rawValue:r}=await _({url:this.config.url({path:"/generate",modelId:this.modelId}),headers:x(this.config.headers(),e.headers),body:{...o,stream:!1},failedResponseHandler:S,successfulResponseHandler:O(E),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:l,...h}=o,u=s;return{content:[{type:"text",text:u.response}],usage:{inputTokens:{total:(t=u.prompt_eval_count)!=null?t:0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:(a=u.eval_count)!=null?a:0,text:void 0,reasoning:void 0}},finishReason:T("stop"),request:{body:JSON.stringify(o)},response:{...I(u),headers:n,body:r},warnings:i}}async doStream(e){const{args:t,warnings:a}=this.getArgs(e),o={...t,stream:!0},{responseHeaders:i,value:n}=await _({url:this.config.url({path:"/generate",modelId:this.modelId}),headers:x(this.config.headers(),e.headers),body:o,failedResponseHandler:S,successfulResponseHandler:N(E),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:s,...r}=t;let l="other",h={inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0}},u=!0,d=!1;const p=b();return{stream:n.pipeThrough(new TransformStream({transform(m,g){if(!m.success){g.enqueue({type:"error",error:m.rawValue});return}const v=m.value;if("error"in v){l="error",g.enqueue({type:"error",error:v.error});return}u&&(u=!1,g.enqueue({type:"response-metadata",...I(v)})),v.done&&(l="stop"),v.response!=null&&(d||(g.enqueue({type:"text-start",id:p}),d=!0),g.enqueue({type:"text-delta",id:p,delta:v.response}))},flush(m){d&&m.enqueue({type:"text-end",id:p}),m.enqueue({type:"finish",finishReason:T(l),usage:h})}})),request:{body:JSON.stringify(o)},response:{headers:i},warnings:a}}},E=y({model:f(),created_at:f(),response:f(),done:w(),context:R(c()),eval_count:c().optional(),eval_duration:c().optional(),load_duration:c().optional(),total_duration:c().optional(),prompt_eval_count:c().optional(),prompt_eval_duration:c().optional()}),X=y({dimensions:c().optional(),truncate:w().optional(),keepAlive:f().optional()}),Y=class{constructor(e,t,a){this.specificationVersion="v3";var o,i;this.modelId=e,this.settings=t,this.config=a,this.provider=a.provider,this.maxEmbeddingsPerCall=(o=t.maxEmbeddingsPerCall)!=null?o:2048,this.supportsParallelCalls=(i=t.supportsParallelCalls)!=null?i:!0}getArgs({values:e}){return{model:this.modelId,input:e,dimensions:this.settings.dimensions,truncate:this.settings.truncate,keep_alive:this.settings.keepAlive}}async doEmbed({values:e,headers:t,abortSignal:a,providerOptions:o}){var i,n,s;if(this.maxEmbeddingsPerCall&&e.length>this.maxEmbeddingsPerCall)throw new A({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const r=await $({provider:"ollama",providerOptions:o,schema:X}),l=(i=r?.dimensions)!=null?i:this.settings.dimensions,h=(n=r?.truncate)!=null?n:this.settings.truncate,u=(s=r?.keepAlive)!=null?s:this.settings.keepAlive,d={model:this.modelId,input:e};l!==void 0&&(d.dimensions=l),h!==void 0&&(d.truncate=h),u!==void 0&&(d.keep_alive=u);const{responseHeaders:p,value:m,rawValue:g}=await _({url:this.config.url({path:"/embed",modelId:this.modelId}),headers:x(this.config.headers(),t),body:{...d},failedResponseHandler:S,successfulResponseHandler:O(Z),abortSignal:a,fetch:this.config.fetch}),v=m;return{embeddings:v.embeddings.map(C=>C),usage:{tokens:v.prompt_eval_count},response:{headers:p,body:g},warnings:[]}}},Z=y({model:f(),embeddings:R(R(c())),total_duration:c(),load_duration:c(),prompt_eval_count:c()}),q=y({model:f(),created_at:f(),done:w(),message:y({content:f(),role:f(),thinking:f().optional(),tool_calls:R(y({function:y({name:f(),arguments:B(f(),P())}),id:f().optional()})).optional().nullable()}),done_reason:f().optional(),eval_count:c().optional(),eval_duration:c().optional(),load_duration:c().optional(),prompt_eval_count:c().optional(),prompt_eval_duration:c().optional(),total_duration:c().optional()}),ee=class{constructor(e){this.config=e}processGenerateResponse(e){const t=this.extractContent(e),a=T(e.done_reason),o=this.extractUsage(e);return{content:t,finishReason:a,usage:o,providerMetadata:{ollama:{}}}}extractContent(e){var t,a,o,i,n;const s=[],r=e.message.content;r!=null&&r.length>0&&s.push({type:"text",text:r});const l=e.message.thinking;l!=null&&l.length>0&&s.push({type:"reasoning",text:l});for(const h of(t=e.message.tool_calls)!=null?t:[])s.push({type:"tool-call",toolCallId:(n=h.id)!=null?n:(i=(o=(a=this.config).generateId)==null?void 0:o.call(a))!=null?i:b(),toolName:h.function.name,input:JSON.stringify(h.function.arguments)});return s}extractUsage(e){var t,a;return{inputTokens:{total:(t=e.prompt_eval_count)!=null?t:0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:(a=e.eval_count)!=null?a:0,text:void 0,reasoning:void 0}}}};function te(e){var t;if(e.success)return[e.value];const a=[],o=(t=e.error)==null?void 0:t.text;if(typeof o!="string"||o.length===0)return a;const i=o.split(/\r?\n/);for(const n of i){const s=n.trim();if(s!=="")try{const r=JSON.parse(s),l=q.safeParse(r);l.success&&a.push(l.data)}catch{}}return a}function se({prompt:e,systemMessageMode:t="system"}){const a=[];for(const{role:o,content:i}of e)switch(o){case"system":{switch(t){case"system":{a.push({role:"system",content:i});break}case"developer":{a.push({role:"developer",content:i});break}case"remove":break;default:{const n=t;throw new Error(`Unsupported system message mode: ${n}`)}}break}case"user":{if(i.length===1&&i[0].type==="text"){a.push({role:"user",content:i[0].text});break}const n=i.filter(r=>r.type==="text").map(r=>r.text).join(""),s=i.filter(r=>r.type==="file"&&r.mediaType.startsWith("image/")).map(r=>r.data);a.push({role:"user",content:n.length>0?n:[],images:s.length>0?s:void 0});break}case"assistant":{let n="",s="";const r=[];for(const l of i)switch(l.type){case"text":{n+=l.text;break}case"tool-call":{r.push({id:l.toolCallId,type:"function",function:{name:l.toolName,arguments:l.input}});break}case"reasoning":{s+=l.text;break}default:throw new Error(`Unsupported part: ${l}`)}a.push({role:"assistant",content:n,...s&&{thinking:s},tool_calls:r.length>0?r:void 0});break}case"tool":{for(const n of i){const s=n.output;let r;switch(s.type){case"text":case"error-text":r=s.value;break;case"content":case"json":case"error-json":r=JSON.stringify(s.value);break}a.push({role:"tool",tool_call_id:n.toolCallId,content:r})}break}default:{const n=o;throw new Error(`Unsupported role: ${n}`)}}return a}var ae=y({think:w().optional(),options:y({num_ctx:c().optional(),repeat_last_n:c().optional(),repeat_penalty:c().optional(),temperature:c().optional(),seed:c().optional(),stop:R(f()).optional(),num_predict:c().optional(),top_k:c().optional(),top_p:c().optional(),min_p:c().optional()}).optional()});function ne({prompt:e,systemMessageMode:t}){const a=[],o=[];for(const{role:i,content:n}of e)switch(i){case"system":{switch(t){case"system":{a.push({role:"system",content:n});break}case"developer":{a.push({role:"developer",content:n});break}case"remove":{o.push({type:"other",message:"system messages are removed for this model"});break}default:{const s=t;throw new Error(`Unsupported system message mode: ${s}`)}}break}case"user":{a.push({role:"user",content:n.map((s,r)=>{var l,h,u;switch(s.type){case"text":return{type:"input_text",text:s.text};case"file":if(s.mediaType.startsWith("image/")){const d=s.mediaType==="image/*"?"image/jpeg":s.mediaType;return{type:"input_image",image_url:s.data instanceof URL?s.data.toString():`data:${d};base64,${s.data}`,detail:(h=(l=s.providerOptions)==null?void 0:l.ollama)==null?void 0:h.imageDetail}}else if(s.mediaType==="application/pdf"){if(s.data instanceof URL)throw new k({functionality:"PDF file parts with URLs"});return{type:"input_file",filename:(u=s.filename)!=null?u:`part-${r}.pdf`,file_data:`data:application/pdf;base64,${s.data}`}}else throw new k({functionality:`file part media type ${s.mediaType}`})}})});break}case"assistant":{for(const s of n)switch(s.type){case"text":{a.push({role:"assistant",content:[{type:"output_text",text:s.text}]});break}case"tool-call":{if(s.providerExecuted)break;a.push({type:"function_call",call_id:s.toolCallId,name:s.toolName,arguments:JSON.stringify(s.input)});break}case"tool-result":{o.push({type:"other",message:"tool result parts in assistant messages are not supported for Ollama responses"});break}}break}case"tool":{for(const s of n){const r=s.output;let l;switch(r.type){case"text":case"error-text":l=r.value;break;case"content":case"json":case"error-json":l=JSON.stringify(r.value);break}a.push({type:"function_call_output",call_id:s.toolCallId,output:l})}break}default:{const s=i;throw new Error(`Unsupported role: ${s}`)}}return{messages:a,warnings:o}}function oe({tools:e,toolChoice:t}){e=e?.length?e:void 0;const a=[];if(e==null)return{tools:void 0,toolChoice:void 0,toolWarnings:a};const o=[];for(const n of e)switch(n.type){case"function":{let s=n.inputSchema;s?s&&typeof s=="object"&&s.type==="object"&&s.properties&&Object.keys(s.properties).length===0&&(s={...s,properties:{},required:[]}):s={type:"object",properties:{},required:[]},o.push({type:"function",function:{name:n.name,description:n.description,parameters:s}});break}default:a.push({type:"unsupported",feature:"tool",details:n.name});break}if(t==null)return{tools:o,toolChoice:void 0,toolWarnings:a};const i=t.type;switch(i){case"auto":case"none":case"required":return{tools:o,toolChoice:i,toolWarnings:a};case"tool":return{tools:o,toolChoice:t.toolName=="web_search_preview"?{type:"web_search_preview"}:{type:"function",name:t.toolName},toolWarnings:a};default:{const n=i;throw new k({functionality:`tool choice type: ${n}`})}}}var re=class{async buildRequest({modelId:e,maxOutputTokens:t,temperature:a,stopSequences:o,topP:i,topK:n,presencePenalty:s,frequencyPenalty:r,seed:l,prompt:h,providerOptions:u,tools:d,toolChoice:p,responseFormat:m}){const g=this.collectUnsupportedSettingsWarnings({topK:n,seed:l,presencePenalty:s,frequencyPenalty:r,stopSequences:o}),{warnings:v}=ne({prompt:h,systemMessageMode:"system"});g.push(...v);const C=await this.parseProviderOptions(u),M=this.buildBaseArgs({modelId:e,prompt:h,temperature:a,topP:i,maxOutputTokens:t,responseFormat:m,ollamaOptions:C}),{tools:H,toolChoice:j,toolWarnings:U}=oe({tools:d,toolChoice:p});return{args:{...M,tools:H,tool_choice:j},warnings:[...g,...U]}}collectUnsupportedSettingsWarnings({topK:e,seed:t,presencePenalty:a,frequencyPenalty:o,stopSequences:i}){const n=[],s=[{value:e,name:"topK"},{value:t,name:"seed"},{value:a,name:"presencePenalty"},{value:o,name:"frequencyPenalty"},{value:i,name:"stopSequences"}];for(const{value:r,name:l}of s)r!=null&&n.push({type:"unsupported",feature:"setting",details:l});return n}async parseProviderOptions(e){const t=await $({provider:"ollama",providerOptions:e,schema:ae});return t??null}buildBaseArgs({modelId:e,prompt:t,temperature:a,topP:o,maxOutputTokens:i,responseFormat:n,ollamaOptions:s}){var r,l;return{model:e,messages:se({prompt:t,systemMessageMode:"system"}),temperature:a,top_p:o,max_output_tokens:i,...n?.type==="json"&&{format:n.schema!=null?n.schema:"json"},think:(r=s?.think)!=null?r:!1,options:(l=s?.options)!=null?l:void 0}}},ie=class{constructor(e){this.config=e,this.state=this.initializeState()}createTransformStream(e,t){return new TransformStream({transform:(a,o)=>{this.processChunk(a,o,t)},flush:a=>{this.finalizeStream(a)}})}initializeState(){return{finishReason:{unified:"other",raw:void 0},usage:{inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0}},responseId:null,ongoingToolCalls:{},hasToolCalls:!1,isFirstChunk:!0,hasTextStarted:!1,hasReasoningStarted:!1,textEnded:!1,reasoningEnded:!1,textId:b(),reasoningId:b()}}processChunk(e,t,a){a?.includeRawChunks&&t.enqueue({type:"raw",rawValue:e.rawValue});const o=te(e);if(o.length===0){e.success||(this.state.finishReason={unified:"error",raw:void 0},t.enqueue({type:"error",error:e.error}));return}for(const i of o)this.processResponseValue(i,t)}processResponseValue(e,t){if(e&&typeof e=="object"&&"error"in e){this.state.finishReason={unified:"error",raw:void 0},t.enqueue({type:"error",error:e.error});return}this.state.isFirstChunk&&(this.state.isFirstChunk=!1,t.enqueue({type:"response-metadata",...I(e)})),e.done&&this.handleDoneChunk(e,t);const a=e?.message;a&&this.processDelta(a,t)}handleDoneChunk(e,t){this.state.finishReason=T(e.done_reason),this.state.usage={inputTokens:{total:e.prompt_eval_count||0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:e.eval_count||0,text:void 0,reasoning:void 0}},this.state.hasTextStarted&&!this.state.textEnded&&(t.enqueue({type:"text-end",id:this.state.textId}),this.state.textEnded=!0),this.state.hasReasoningStarted&&!this.state.reasoningEnded&&(t.enqueue({type:"reasoning-end",id:this.state.reasoningId}),this.state.reasoningEnded=!0)}processDelta(e,t){this.processTextContent(e,t),this.processThinking(e,t),this.processToolCalls(e,t)}processTextContent(e,t){e?.content!=null&&(this.state.hasTextStarted||(t.enqueue({type:"text-start",id:this.state.textId}),this.state.hasTextStarted=!0),t.enqueue({type:"text-delta",id:this.state.textId,delta:e.content}))}processThinking(e,t){e?.thinking&&(this.state.hasReasoningStarted||(t.enqueue({type:"reasoning-start",id:this.state.reasoningId}),this.state.hasReasoningStarted=!0),t.enqueue({type:"reasoning-delta",id:this.state.reasoningId,delta:e.thinking}))}processToolCalls(e,t){var a,o,i,n;for(const s of(a=e.tool_calls)!=null?a:[]){if(((o=s.function)==null?void 0:o.name)==null)throw new F({data:s,message:"Expected 'function.name' to be a string."});((i=s.function)==null?void 0:i.name)!=null&&((n=s.function)==null?void 0:n.arguments)!=null&&this.emitToolCall(s,t)}}emitToolCall(e,t){var a,o,i,n;const s=(n=e.id)!=null?n:(i=(o=(a=this.config).generateId)==null?void 0:o.call(a))!=null?i:b();t.enqueue({type:"tool-input-start",id:s,toolName:e.function.name}),t.enqueue({type:"tool-input-delta",id:s,delta:JSON.stringify(e.function.arguments)}),t.enqueue({type:"tool-input-end",id:s}),t.enqueue({type:"tool-call",toolCallId:s,toolName:e.function.name,input:JSON.stringify(e.function.arguments)}),this.state.hasToolCalls=!0}finalizeStream(e){this.state.hasTextStarted&&!this.state.textEnded&&e.enqueue({type:"text-end",id:this.state.textId}),this.state.hasReasoningStarted&&!this.state.reasoningEnded&&e.enqueue({type:"reasoning-end",id:this.state.reasoningId}),e.enqueue({type:"finish",finishReason:this.state.finishReason,usage:this.state.usage,providerMetadata:{ollama:{responseId:this.state.responseId}}})}},le=class{constructor(e,t){this.specificationVersion="v3",this.defaultObjectGenerationMode=void 0,this.supportsImageUrls=!0,this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t,this.provider=t.provider,this.requestBuilder=new re,this.responseProcessor=new ee(t)}async doGenerate(e){const{args:t,warnings:a}=await this.prepareRequest(e),{responseHeaders:o,value:i,rawValue:n}=await _({url:this.config.url({path:"/chat",modelId:this.modelId}),headers:x(this.config.headers(),e.headers),body:{...t,stream:!1},failedResponseHandler:S,successfulResponseHandler:O(q),abortSignal:e.abortSignal,fetch:this.config.fetch});return{...this.responseProcessor.processGenerateResponse(i),request:{body:JSON.stringify(t)},response:{modelId:this.modelId,timestamp:new Date,headers:o,body:n},warnings:a}}async doStream(e){const{args:t,warnings:a}=await this.prepareRequest(e),{responseHeaders:o,value:i}=await _({url:this.config.url({path:"/chat",modelId:this.modelId}),headers:x(this.config.headers(),e.headers),body:{...t,stream:!0},failedResponseHandler:S,successfulResponseHandler:N(q),abortSignal:e.abortSignal,fetch:this.config.fetch}),n=new ie(this.config);return{stream:i.pipeThrough(n.createTransformStream(a,e)),request:{body:t},response:{headers:o},warnings:a}}async prepareRequest(e){return await this.requestBuilder.buildRequest({modelId:this.modelId,...e})}};function ue(e={}){var t,a;const o=(t=J(e.baseURL))!=null?t:"http://127.0.0.1:11434/api",i=(a=e.name)!=null?a:"ollama",n=()=>({"Ollama-Organization":e.organization,"Ollama-Project":e.project,...e.headers}),s=(d,p={})=>new Q(d,p,{provider:`${i}.completion`,url:({path:m})=>`${o}${m}`,headers:n,fetch:e.fetch}),r=(d,p={})=>new Y(d,p,{provider:`${i}.embedding`,url:({path:m})=>`${o}${m}`,headers:n,fetch:e.fetch}),l=d=>{if(new.target)throw new Error("The Ollama model function cannot be called with the new keyword.");return h(d)},h=d=>new le(d,{provider:`${i}.responses`,url:({path:p})=>`${o}${p}`,headers:n,fetch:e.fetch}),u=function(d){return l(d)};return u.specificationVersion="v3",u.languageModel=l,u.chat=l,u.completion=s,u.embedding=r,u.textEmbedding=r,u.textEmbeddingModel=r,u.embeddingModel=r,u.imageModel=d=>{throw new V({modelId:d,modelType:"imageModel",message:"Image generation is unsupported with Ollama"})},u}var me=ue();export{ue as createOllama,me as ollama};
