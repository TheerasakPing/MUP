{"version":3,"file":"server.test.js","sourceRoot":"","sources":["../../../src/node/orpc/server.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\nimport { createOrpcServer } from \"./server\";\nimport type { ORPCContext } from \"./context\";\n\nfunction getErrorCode(error: unknown): string | null {\n  if (typeof error !== \"object\" || error === null) {\n    return null;\n  }\n\n  if (!(\"code\" in error)) {\n    return null;\n  }\n\n  const code = (error as { code?: unknown }).code;\n  return typeof code === \"string\" ? code : null;\n}\n\ndescribe(\"createOrpcServer\", () => {\n  test(\"serveStatic fallback does not swallow /api routes\", async () => {\n    // Minimal context stub - router won't be exercised by this test.\n    const stubContext: Partial<ORPCContext> = {};\n\n    const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-static-\"));\n    const indexHtml =\n      \"<!doctype html><html><head><title>mux</title></head><body><div>ok</div></body></html>\";\n\n    let server: Awaited<ReturnType<typeof createOrpcServer>> | null = null;\n\n    try {\n      await fs.writeFile(path.join(tempDir, \"index.html\"), indexHtml, \"utf-8\");\n\n      server = await createOrpcServer({\n        host: \"127.0.0.1\",\n        port: 0,\n        context: stubContext as ORPCContext,\n        authToken: \"test-token\",\n        serveStatic: true,\n        staticDir: tempDir,\n      });\n\n      const uiRes = await fetch(`${server.baseUrl}/some/spa/route`);\n      expect(uiRes.status).toBe(200);\n      const uiText = await uiRes.text();\n      expect(uiText).toContain(\"mux\");\n      expect(uiText).toContain('<base href=\"/\"');\n\n      const apiRes = await fetch(`${server.baseUrl}/api/not-a-real-route`);\n      expect(apiRes.status).toBe(404);\n    } finally {\n      await server?.close();\n      await fs.rm(tempDir, { recursive: true, force: true });\n    }\n  });\n\n  test(\"OAuth callback routes accept POST redirects (query + form_post)\", async () => {\n    const stubContext: Partial<ORPCContext> = {\n      muxGovernorOauthService: {\n        handleServerCallbackAndExchange: () => Promise.resolve({ success: true, data: undefined }),\n      } as unknown as ORPCContext[\"muxGovernorOauthService\"],\n    };\n\n    let server: Awaited<ReturnType<typeof createOrpcServer>> | null = null;\n\n    try {\n      server = await createOrpcServer({\n        host: \"127.0.0.1\",\n        port: 0,\n        context: stubContext as ORPCContext,\n      });\n\n      // Some OAuth providers issue 307/308 redirects which preserve POST.\n      const queryRes = await fetch(\n        `${server.baseUrl}/auth/mux-governor/callback?state=test-state&code=test-code`,\n        { method: \"POST\" }\n      );\n      expect(queryRes.status).toBe(200);\n      const queryText = await queryRes.text();\n      expect(queryText).toContain(\"Enrollment complete\");\n\n      // response_mode=form_post delivers params in the request body.\n      const formRes = await fetch(`${server.baseUrl}/auth/mux-governor/callback`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n        body: \"state=test-state&code=test-code\",\n      });\n      expect(formRes.status).toBe(200);\n      const formText = await formRes.text();\n      expect(formText).toContain(\"Enrollment complete\");\n    } finally {\n      await server?.close();\n    }\n  });\n\n  test(\"brackets IPv6 hosts in returned URLs\", async () => {\n    // Minimal context stub - router won't be exercised by this test.\n    const stubContext: Partial<ORPCContext> = {};\n\n    let server: Awaited<ReturnType<typeof createOrpcServer>> | null = null;\n\n    try {\n      server = await createOrpcServer({\n        host: \"::1\",\n        port: 0,\n        context: stubContext as ORPCContext,\n        authToken: \"test-token\",\n      });\n    } catch (error) {\n      const code = getErrorCode(error);\n\n      // Some CI environments may not have IPv6 enabled.\n      if (code === \"EAFNOSUPPORT\" || code === \"EADDRNOTAVAIL\") {\n        return;\n      }\n\n      throw error;\n    }\n\n    try {\n      expect(server.baseUrl).toMatch(/^http:\\/\\/\\[::1\\]:\\d+$/);\n      expect(server.wsUrl).toMatch(/^ws:\\/\\/\\[::1\\]:\\d+\\/orpc\\/ws$/);\n      expect(server.specUrl).toMatch(/^http:\\/\\/\\[::1\\]:\\d+\\/api\\/spec\\.json$/);\n      expect(server.docsUrl).toMatch(/^http:\\/\\/\\[::1\\]:\\d+\\/api\\/docs$/);\n    } finally {\n      await server.close();\n    }\n  });\n});\n"]}