{"version":3,"file":"server.test.js","sourceRoot":"","sources":["../../../src/node/orpc/server.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport { createOrpcServer } from \"./server\";\r\nimport type { ORPCContext } from \"./context\";\r\n\r\nfunction getErrorCode(error: unknown): string | null {\r\n  if (typeof error !== \"object\" || error === null) {\r\n    return null;\r\n  }\r\n\r\n  if (!(\"code\" in error)) {\r\n    return null;\r\n  }\r\n\r\n  const code = (error as { code?: unknown }).code;\r\n  return typeof code === \"string\" ? code : null;\r\n}\r\n\r\ndescribe(\"createOrpcServer\", () => {\r\n  test(\"serveStatic fallback does not swallow /api routes\", async () => {\r\n    // Minimal context stub - router won't be exercised by this test.\r\n    const stubContext: Partial<ORPCContext> = {};\r\n\r\n    const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-static-\"));\r\n    const indexHtml =\r\n      \"<!doctype html><html><head><title>mux</title></head><body><div>ok</div></body></html>\";\r\n\r\n    let server: Awaited<ReturnType<typeof createOrpcServer>> | null = null;\r\n\r\n    try {\r\n      await fs.writeFile(path.join(tempDir, \"index.html\"), indexHtml, \"utf-8\");\r\n\r\n      server = await createOrpcServer({\r\n        host: \"127.0.0.1\",\r\n        port: 0,\r\n        context: stubContext as ORPCContext,\r\n        authToken: \"test-token\",\r\n        serveStatic: true,\r\n        staticDir: tempDir,\r\n      });\r\n\r\n      const uiRes = await fetch(`${server.baseUrl}/some/spa/route`);\r\n      expect(uiRes.status).toBe(200);\r\n      const uiText = await uiRes.text();\r\n      expect(uiText).toContain(\"mux\");\r\n      expect(uiText).toContain('<base href=\"/\"');\r\n\r\n      const apiRes = await fetch(`${server.baseUrl}/api/not-a-real-route`);\r\n      expect(apiRes.status).toBe(404);\r\n    } finally {\r\n      await server?.close();\r\n      await fs.rm(tempDir, { recursive: true, force: true });\r\n    }\r\n  });\r\n\r\n  test(\"OAuth callback routes accept POST redirects (query + form_post)\", async () => {\r\n    const stubContext: Partial<ORPCContext> = {\r\n      muxGovernorOauthService: {\r\n        handleServerCallbackAndExchange: () => Promise.resolve({ success: true, data: undefined }),\r\n      } as unknown as ORPCContext[\"muxGovernorOauthService\"],\r\n    };\r\n\r\n    let server: Awaited<ReturnType<typeof createOrpcServer>> | null = null;\r\n\r\n    try {\r\n      server = await createOrpcServer({\r\n        host: \"127.0.0.1\",\r\n        port: 0,\r\n        context: stubContext as ORPCContext,\r\n      });\r\n\r\n      // Some OAuth providers issue 307/308 redirects which preserve POST.\r\n      const queryRes = await fetch(\r\n        `${server.baseUrl}/auth/mux-governor/callback?state=test-state&code=test-code`,\r\n        { method: \"POST\" }\r\n      );\r\n      expect(queryRes.status).toBe(200);\r\n      const queryText = await queryRes.text();\r\n      expect(queryText).toContain(\"Enrollment complete\");\r\n\r\n      // response_mode=form_post delivers params in the request body.\r\n      const formRes = await fetch(`${server.baseUrl}/auth/mux-governor/callback`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n        body: \"state=test-state&code=test-code\",\r\n      });\r\n      expect(formRes.status).toBe(200);\r\n      const formText = await formRes.text();\r\n      expect(formText).toContain(\"Enrollment complete\");\r\n    } finally {\r\n      await server?.close();\r\n    }\r\n  });\r\n\r\n  test(\"brackets IPv6 hosts in returned URLs\", async () => {\r\n    // Minimal context stub - router won't be exercised by this test.\r\n    const stubContext: Partial<ORPCContext> = {};\r\n\r\n    let server: Awaited<ReturnType<typeof createOrpcServer>> | null = null;\r\n\r\n    try {\r\n      server = await createOrpcServer({\r\n        host: \"::1\",\r\n        port: 0,\r\n        context: stubContext as ORPCContext,\r\n        authToken: \"test-token\",\r\n      });\r\n    } catch (error) {\r\n      const code = getErrorCode(error);\r\n\r\n      // Some CI environments may not have IPv6 enabled.\r\n      if (code === \"EAFNOSUPPORT\" || code === \"EADDRNOTAVAIL\") {\r\n        return;\r\n      }\r\n\r\n      throw error;\r\n    }\r\n\r\n    try {\r\n      expect(server.baseUrl).toMatch(/^http:\\/\\/\\[::1\\]:\\d+$/);\r\n      expect(server.wsUrl).toMatch(/^ws:\\/\\/\\[::1\\]:\\d+\\/orpc\\/ws$/);\r\n      expect(server.specUrl).toMatch(/^http:\\/\\/\\[::1\\]:\\d+\\/api\\/spec\\.json$/);\r\n      expect(server.docsUrl).toMatch(/^http:\\/\\/\\[::1\\]:\\d+\\/api\\/docs$/);\r\n    } finally {\r\n      await server.close();\r\n    }\r\n  });\r\n});\r\n"]}