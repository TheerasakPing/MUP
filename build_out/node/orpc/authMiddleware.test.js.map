{"version":3,"file":"authMiddleware.test.js","sourceRoot":"","sources":["../../../src/node/orpc/authMiddleware.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport { safeEq } from \"./authMiddleware\";\n\n// Timing microbenchmarks are inherently noisy and can be flaky under parallel\n// test execution. Run these locally with MUX_TEST_TIMING=1 when you want to\n// sanity-check constant-time behavior.\nconst describeTiming = process.env.MUX_TEST_TIMING === \"1\" ? describe : describe.skip;\n\ndescribe(\"safeEq\", () => {\n  it(\"returns true for equal strings\", () => {\n    expect(safeEq(\"secret\", \"secret\")).toBe(true);\n    expect(safeEq(\"\", \"\")).toBe(true);\n    expect(safeEq(\"a\", \"a\")).toBe(true);\n  });\n\n  it(\"returns false for different strings of same length\", () => {\n    expect(safeEq(\"secret\", \"secreT\")).toBe(false);\n    expect(safeEq(\"aaaaaa\", \"aaaaab\")).toBe(false);\n    expect(safeEq(\"a\", \"b\")).toBe(false);\n  });\n\n  it(\"returns false for different length strings\", () => {\n    expect(safeEq(\"short\", \"longer\")).toBe(false);\n    expect(safeEq(\"\", \"a\")).toBe(false);\n    expect(safeEq(\"abc\", \"ab\")).toBe(false);\n  });\n\n  it(\"handles unicode strings\", () => {\n    expect(safeEq(\"hÃ©llo\", \"hÃ©llo\")).toBe(true);\n    expect(safeEq(\"hÃ©llo\", \"hello\")).toBe(false);\n    expect(safeEq(\"ðŸ”\", \"ðŸ”\")).toBe(true);\n  });\n\n  describeTiming(\"timing consistency\", () => {\n    // Use a longer secret to make timing comparisons less noisy.\n    const ITERATIONS = 2000;\n    const secret = \"a\".repeat(256);\n\n    function measureAvgTime(fn: () => void, iterations: number): number {\n      const start = process.hrtime.bigint();\n      for (let i = 0; i < iterations; i++) {\n        fn();\n      }\n      const end = process.hrtime.bigint();\n      return Number(end - start) / iterations;\n    }\n\n    it(\"takes similar time for matching vs non-matching strings of same length\", () => {\n      const matching = secret;\n      const nonMatching = \"b\" + \"a\".repeat(secret.length - 1); // differs at first char\n\n      const matchTime = measureAvgTime(() => safeEq(secret, matching), ITERATIONS);\n      const nonMatchTime = measureAvgTime(() => safeEq(secret, nonMatching), ITERATIONS);\n\n      const ratio = Math.max(matchTime, nonMatchTime) / Math.min(matchTime, nonMatchTime);\n      // Timing microbenchmarks can be extremely noisy in CI and local dev environments.\n      // This is a regression guard (against early-exit), not a strict performance spec.\n      expect(ratio).toBeLessThan(2.0);\n    });\n\n    it(\"takes similar time regardless of where mismatch occurs\", () => {\n      const earlyMismatch = \"b\" + \"a\".repeat(secret.length - 1); // first char\n      const lateMismatch = \"a\".repeat(secret.length - 1) + \"b\"; // last char\n\n      const earlyTime = measureAvgTime(() => safeEq(secret, earlyMismatch), ITERATIONS);\n      const lateTime = measureAvgTime(() => safeEq(secret, lateMismatch), ITERATIONS);\n\n      const ratio = Math.max(earlyTime, lateTime) / Math.min(earlyTime, lateTime);\n      // Timing microbenchmarks can be extremely noisy in CI and local dev environments.\n      // This is a regression guard (against early-exit), not a strict performance spec.\n      expect(ratio).toBeLessThan(2.0);\n    });\n\n    it(\"length mismatch takes comparable time to same-length comparison\", () => {\n      const sameLength = \"b\" + \"a\".repeat(secret.length - 1);\n      const diffLength = \"a\".repeat(64);\n\n      const sameLenTime = measureAvgTime(() => safeEq(secret, sameLength), ITERATIONS);\n      const diffLenTime = measureAvgTime(() => safeEq(secret, diffLength), ITERATIONS);\n\n      // Length mismatch should not be significantly faster (no early-exit)\n      const ratio = Math.max(sameLenTime, diffLenTime) / Math.min(sameLenTime, diffLenTime);\n      expect(ratio).toBeLessThan(2.0);\n    });\n  });\n});\n"]}