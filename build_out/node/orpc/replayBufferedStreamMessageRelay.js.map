{"version":3,"file":"replayBufferedStreamMessageRelay.js","sourceRoot":"","sources":["../../../src/node/orpc/replayBufferedStreamMessageRelay.ts"],"names":[],"mappings":"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","sourcesContent":["import type { WorkspaceChatMessage } from \"@/common/orpc/types\";\r\n\r\ntype ReplayBufferedStreamMessage = Extract<\r\n  WorkspaceChatMessage,\r\n  {\r\n    type: \"stream-delta\" | \"reasoning-delta\" | \"stream-end\" | \"stream-abort\" | \"stream-error\";\r\n  }\r\n>;\r\n\r\ntype ReplayBufferedDeltaMessage = Extract<\r\n  ReplayBufferedStreamMessage,\r\n  { type: \"stream-delta\" | \"reasoning-delta\" }\r\n>;\r\n\r\nfunction isReplayBufferedStreamMessage(\r\n  message: WorkspaceChatMessage\r\n): message is ReplayBufferedStreamMessage {\r\n  return (\r\n    message.type === \"stream-delta\" ||\r\n    message.type === \"reasoning-delta\" ||\r\n    message.type === \"stream-end\" ||\r\n    message.type === \"stream-abort\" ||\r\n    message.type === \"stream-error\"\r\n  );\r\n}\r\n\r\nfunction isReplayBufferedDeltaMessage(\r\n  message: ReplayBufferedStreamMessage\r\n): message is ReplayBufferedDeltaMessage {\r\n  return message.type === \"stream-delta\" || message.type === \"reasoning-delta\";\r\n}\r\n\r\nfunction isReplayMessage(message: WorkspaceChatMessage): boolean {\r\n  return (message as { replay?: unknown }).replay === true;\r\n}\r\n\r\nfunction replayBufferedDeltaKey(message: ReplayBufferedDeltaMessage): string {\r\n  return JSON.stringify([message.type, message.messageId, message.timestamp, message.delta]);\r\n}\r\n\r\nexport function createReplayBufferedStreamMessageRelay(\r\n  push: (message: WorkspaceChatMessage) => void\r\n): {\r\n  handleSessionMessage: (message: WorkspaceChatMessage) => void;\r\n  finishReplay: () => void;\r\n} {\r\n  let isReplaying = true;\r\n  const bufferedLiveStreamMessages: ReplayBufferedStreamMessage[] = [];\r\n\r\n  // Counter (not a Set) so we don't drop more buffered events than were replayed.\r\n  const replayedDeltaKeyCounts = new Map<string, number>();\r\n\r\n  const noteReplayedDelta = (message: ReplayBufferedDeltaMessage) => {\r\n    const key = replayBufferedDeltaKey(message);\r\n    replayedDeltaKeyCounts.set(key, (replayedDeltaKeyCounts.get(key) ?? 0) + 1);\r\n  };\r\n\r\n  const shouldDropBufferedDelta = (message: ReplayBufferedDeltaMessage): boolean => {\r\n    const key = replayBufferedDeltaKey(message);\r\n    const remaining = replayedDeltaKeyCounts.get(key) ?? 0;\r\n    if (remaining <= 0) {\r\n      return false;\r\n    }\r\n    if (remaining === 1) {\r\n      replayedDeltaKeyCounts.delete(key);\r\n    } else {\r\n      replayedDeltaKeyCounts.set(key, remaining - 1);\r\n    }\r\n    return true;\r\n  };\r\n\r\n  const handleSessionMessage = (message: WorkspaceChatMessage) => {\r\n    if (isReplaying && isReplayBufferedStreamMessage(message)) {\r\n      if (!isReplayMessage(message)) {\r\n        // Preserve stream event order during replay buffering (P1): if we buffer only deltas,\r\n        // terminal events like stream-end can overtake them and flip the message back to partial\r\n        // in the frontend event processor.\r\n        bufferedLiveStreamMessages.push(message);\r\n        return;\r\n      }\r\n\r\n      // Track replayed deltas so we can skip replay/live duplicates (P2).\r\n      if (isReplayBufferedDeltaMessage(message)) {\r\n        noteReplayedDelta(message);\r\n      }\r\n    }\r\n\r\n    push(message);\r\n  };\r\n\r\n  const finishReplay = () => {\r\n    // Flush buffered live stream messages after replay (`caught-up` already queued by replayHistory).\r\n    for (const message of bufferedLiveStreamMessages) {\r\n      if (isReplayBufferedDeltaMessage(message) && shouldDropBufferedDelta(message)) {\r\n        continue;\r\n      }\r\n      push(message);\r\n    }\r\n\r\n    isReplaying = false;\r\n\r\n    // Avoid retaining replay delta keys (including delta text) for the lifetime of the subscription.\r\n    replayedDeltaKeyCounts.clear();\r\n    bufferedLiveStreamMessages.length = 0;\r\n  };\r\n\r\n  return { handleSessionMessage, finishReplay };\r\n}\r\n"]}