{"version":3,"file":"server.js","sourceRoot":"","sources":["../../../src/node/orpc/server.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * oRPC Server factory for mux.\n * Serves oRPC router over HTTP and WebSocket.\n *\n * This module exports the server creation logic so it can be tested.\n * The CLI entry point (server.ts) uses this to start the server.\n */\nimport cors from \"cors\";\nimport express, { type Express } from \"express\";\nimport * as fs from \"fs/promises\";\nimport * as http from \"http\";\nimport * as path from \"path\";\nimport { WebSocketServer, type WebSocket } from \"ws\";\nimport { RPCHandler } from \"@orpc/server/node\";\nimport { RPCHandler as ORPCWebSocketServerHandler } from \"@orpc/server/ws\";\nimport { ORPCError, onError } from \"@orpc/server\";\nimport { OpenAPIGenerator } from \"@orpc/openapi\";\nimport { OpenAPIHandler } from \"@orpc/openapi/node\";\nimport { ZodToJsonSchemaConverter } from \"@orpc/zod/zod4\";\nimport { router, type AppRouter } from \"@/node/orpc/router\";\nimport type { ORPCContext } from \"@/node/orpc/context\";\nimport { extractWsHeaders, safeEq } from \"@/node/orpc/authMiddleware\";\nimport { VERSION } from \"@/version\";\nimport { formatOrpcError } from \"@/node/orpc/formatOrpcError\";\nimport { log } from \"@/node/services/log\";\nimport { attachStreamErrorHandler, isIgnorableStreamError } from \"@/node/utils/streamErrors\";\n\ntype AliveWebSocket = WebSocket & { isAlive?: boolean };\n\nconst WS_HEARTBEAT_INTERVAL_MS = 30_000;\n\n// --- Types ---\n\nexport interface OrpcServerOptions {\n  /** Host to bind to (default: \"127.0.0.1\") */\n  host?: string;\n  /** Port to bind to (default: 0 for random available port) */\n  port?: number;\n  /** oRPC context with services */\n  context: ORPCContext;\n  /** Whether to serve static files and SPA fallback (default: false) */\n  serveStatic?: boolean;\n  /** Directory to serve static files from (default: dist/ relative to dist/node/orpc/) */\n  staticDir?: string;\n  /** Custom error handler for oRPC errors */\n  onOrpcError?: (error: unknown, options: unknown) => void;\n  /** Optional bearer token for HTTP auth (used if router not provided) */\n  authToken?: string;\n  /** Optional pre-created router (if not provided, creates router(authToken)) */\n  router?: AppRouter;\n}\n\nexport interface OrpcServer {\n  /** The HTTP server instance */\n  httpServer: http.Server;\n  /** The WebSocket server instance */\n  wsServer: WebSocketServer;\n  /** The Express app instance */\n  app: Express;\n  /** The port the server is listening on */\n  port: number;\n  /** Base URL for HTTP requests */\n  baseUrl: string;\n  /** WebSocket URL for WS connections */\n  wsUrl: string;\n  /** URL for OpenAPI spec JSON */\n  specUrl: string;\n  /** URL for Scalar API docs */\n  docsUrl: string;\n  /** Close the server and cleanup resources */\n  close: () => Promise<void>;\n}\n\n// --- Server Factory ---\n\nfunction formatHostForUrl(host: string): string {\n  const trimmed = host.trim();\n\n  // IPv6 URLs must be bracketed: http://[::1]:1234\n  if (trimmed.includes(\":\")) {\n    if (trimmed.startsWith(\"[\") && trimmed.endsWith(\"]\")) {\n      return trimmed;\n    }\n\n    // If the host contains a zone index (e.g. fe80::1%en0), percent must be encoded.\n    const escaped = trimmed.replaceAll(\"%\", \"%25\");\n    return `[${escaped}]`;\n  }\n\n  return trimmed;\n}\n\nfunction extractBearerToken(header: string | undefined): string | null {\n  if (!header?.toLowerCase().startsWith(\"bearer \")) return null;\n  const token = header.slice(7).trim();\n  return token.length ? token : null;\n}\nfunction injectBaseHref(indexHtml: string, baseHref: string): string {\n  // Avoid double-injecting if the HTML already has a base tag.\n  if (/<base\\b/i.test(indexHtml)) {\n    return indexHtml;\n  }\n\n  // Insert immediately after the opening <head> tag (supports <head> and <head ...attrs>).\n  return indexHtml.replace(/<head[^>]*>/i, (match) => `${match}\\n    <base href=\"${baseHref}\" />`);\n}\n\nfunction escapeJsonForHtmlScript(value: unknown): string {\n  // Prevent `</script>` injection when embedding untrusted strings in an inline <script>.\n  return JSON.stringify(value).replaceAll(\"<\", \"\\\\u003c\");\n}\nfunction escapeHtml(input: string): string {\n  return input\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#39;\");\n}\n\n/**\n * Create an oRPC server with HTTP and WebSocket endpoints.\n *\n * HTTP endpoint: /orpc\n * WebSocket endpoint: /orpc/ws\n * Health check: /health\n * Version: /version\n */\nexport async function createOrpcServer({\n  host = \"127.0.0.1\",\n  port = 0,\n  authToken,\n  context,\n  serveStatic = false,\n  // From dist/node/orpc/, go up 2 levels to reach dist/ where index.html lives\n  staticDir = path.join(__dirname, \"../..\"),\n  onOrpcError = (error, options) => {\n    // Auth failures are expected in browser mode while the user enters the token.\n    // Avoid spamming error logs with stack traces on every unauthenticated request.\n    if (error instanceof ORPCError && error.code === \"UNAUTHORIZED\") {\n      log.debug(\"ORPC unauthorized request\");\n      return;\n    }\n\n    const formatted = formatOrpcError(error, options);\n    log.error(formatted.message);\n\n    if (log.isDebugMode()) {\n      const suffix = Math.random().toString(16).slice(2);\n      log.debug_obj(`orpc/${Date.now()}_${suffix}.json`, formatted.debugDump);\n    }\n  },\n  router: existingRouter,\n}: OrpcServerOptions): Promise<OrpcServer> {\n  // Express app setup\n  const app = express();\n  app.use(cors());\n  // OAuth providers may use POST redirects (307/308) or response_mode=form_post.\n  // Support both JSON API requests and form-encoded callback payloads.\n  app.use(express.json({ limit: \"50mb\" }));\n  app.use(express.urlencoded({ extended: false }));\n\n  let spaIndexHtml: string | null = null;\n\n  // Static file serving (optional)\n  if (serveStatic) {\n    try {\n      const indexHtmlPath = path.join(staticDir, \"index.html\");\n      const indexHtml = await fs.readFile(indexHtmlPath, \"utf8\");\n      spaIndexHtml = injectBaseHref(indexHtml, \"/\");\n    } catch (error) {\n      log.error(\"Failed to read index.html for SPA fallback:\", error);\n    }\n\n    app.use(express.static(staticDir));\n  }\n\n  // Serve icon theme files (SVG, PNG, etc.) from ~/.mux/icon-themes/\n  {\n    const iconThemesDir = context.iconThemeService.getIconThemesDir();\n    app.use(\"/icon-themes\", express.static(iconThemesDir, {\n      maxAge: \"1d\",\n      immutable: true,\n      setHeaders: (res, filePath) => {\n        // Set correct Content-Type for SVGs\n        if (filePath.endsWith(\".svg\")) {\n          res.setHeader(\"Content-Type\", \"image/svg+xml\");\n        }\n      },\n    }));\n  }\n\n  // Health check endpoint\n  app.get(\"/health\", (_req, res) => {\n    res.json({ status: \"ok\" });\n  });\n\n  // Version endpoint\n  app.get(\"/version\", (_req, res) => {\n    res.json({ ...VERSION, mode: \"server\" });\n  });\n\n  function getStringParamFromQueryOrBody(req: express.Request, key: string): string | null {\n    const queryValue = req.query[key];\n    if (typeof queryValue === \"string\") return queryValue;\n\n    const bodyRecord = req.body as Record<string, unknown> | undefined;\n    const bodyValue = bodyRecord?.[key];\n    return typeof bodyValue === \"string\" ? bodyValue : null;\n  }\n  // --- Mux Gateway OAuth (unauthenticated bootstrap routes) ---\n  // These are raw Express routes (not oRPC) because the OAuth provider cannot\n  // send a mux Bearer token during the redirect callback.\n  app.get(\"/auth/mux-gateway/start\", (req, res) => {\n    if (authToken?.trim()) {\n      const expectedToken = authToken.trim();\n      const presentedToken = extractBearerToken(req.header(\"authorization\"));\n      if (!presentedToken || !safeEq(presentedToken, expectedToken)) {\n        res.status(401).json({ error: \"Invalid or missing auth token\" });\n        return;\n      }\n    }\n\n    const hostHeader = req.get(\"x-forwarded-host\") ?? req.get(\"host\");\n    const host = hostHeader?.split(\",\")[0]?.trim();\n    if (!host) {\n      res.status(400).json({ error: \"Missing Host header\" });\n      return;\n    }\n\n    // When mux is running behind a reverse proxy, the terminating proxy may set\n    // X-Forwarded-Proto / X-Forwarded-Host, while the direct connection to mux\n    // is plain HTTP.\n    const protoHeader = req.get(\"x-forwarded-proto\");\n    const forwardedProto = protoHeader?.split(\",\")[0]?.trim();\n    const proto = forwardedProto?.length ? forwardedProto : req.protocol;\n\n    const redirectUri = `${proto}://${host}/auth/mux-gateway/callback`;\n    const { authorizeUrl, state } = context.muxGatewayOauthService.startServerFlow({ redirectUri });\n    res.json({ authorizeUrl, state });\n  });\n\n  app.all(\"/auth/mux-gateway/callback\", async (req, res) => {\n    // Some providers use 307/308 redirects that preserve POST, or response_mode=form_post.\n    if (req.method !== \"GET\" && req.method !== \"POST\") {\n      res.sendStatus(405);\n      return;\n    }\n\n    const state = getStringParamFromQueryOrBody(req, \"state\");\n    const code = getStringParamFromQueryOrBody(req, \"code\");\n    const error = getStringParamFromQueryOrBody(req, \"error\");\n    const errorDescription = getStringParamFromQueryOrBody(req, \"error_description\") ?? undefined;\n\n    const result = await context.muxGatewayOauthService.handleServerCallbackAndExchange({\n      state,\n      code,\n      error,\n      errorDescription,\n    });\n\n    const payload = {\n      type: \"mux-gateway-oauth\",\n      state,\n      ok: result.success,\n      error: result.success ? null : result.error,\n    };\n\n    const payloadJson = escapeJsonForHtmlScript(payload);\n\n    const title = result.success ? \"Login complete\" : \"Login failed\";\n    const description = result.success\n      ? \"You can return to Mux. You may now close this tab.\"\n      : payload.error\n        ? escapeHtml(payload.error)\n        : \"An unknown error occurred.\";\n\n    const html = `<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"dark light\" />\n    <meta name=\"theme-color\" content=\"#0e0e0e\" />\n    <title>${title}</title>\n    <link rel=\"stylesheet\" href=\"https://gateway.mux.coder.com/static/css/site.css\" />\n  </head>\n  <body>\n    <div class=\"page\">\n      <header class=\"site-header\">\n        <div class=\"container\">\n          <div class=\"header-title\">mux</div>\n        </div>\n      </header>\n\n      <main class=\"site-main\">\n        <div class=\"container\">\n          <div class=\"content-surface\">\n            <h1>${title}</h1>\n            <p>${description}</p>\n            ${result.success ? '<p class=\"muted\">This tab should close automatically.</p>' : \"\"}\n            <p><a class=\"btn primary\" href=\"/\">Return to Mux</a></p>\n          </div>\n        </div>\n      </main>\n    </div>\n\n    <script>\n      (() => {\n        const payload = ${payloadJson};\n        const ok = payload.ok === true;\n\n        try {\n          if (window.opener && typeof window.opener.postMessage === \"function\") {\n            window.opener.postMessage(payload, \"*\");\n          }\n        } catch {\n          // Ignore postMessage failures.\n        }\n\n        if (!ok) {\n          return;\n        }\n\n        try {\n          if (window.opener && typeof window.opener.focus === \"function\") {\n            window.opener.focus();\n          }\n        } catch {\n          // Ignore focus failures.\n        }\n\n        try {\n          window.close();\n        } catch {\n          // Ignore close failures.\n        }\n\n        setTimeout(() => {\n          try {\n            window.close();\n          } catch {\n            // Ignore close failures.\n          }\n        }, 50);\n\n        setTimeout(() => {\n          try {\n            window.location.replace(\"/\");\n          } catch {\n            // Ignore navigation failures.\n          }\n        }, 150);\n      })();\n    </script>\n  </body>\n</html>`;\n\n    res.status(result.success ? 200 : 400);\n    res.setHeader(\"Content-Type\", \"text/html\");\n    res.send(html);\n  });\n\n  // --- Mux Governor OAuth (unauthenticated bootstrap routes) ---\n  // Similar to Mux Gateway OAuth but accepts user-provided governorUrl.\n  app.get(\"/auth/mux-governor/start\", (req, res) => {\n    if (authToken?.trim()) {\n      const expectedToken = authToken.trim();\n      const presentedToken = extractBearerToken(req.header(\"authorization\"));\n      if (!presentedToken || !safeEq(presentedToken, expectedToken)) {\n        res.status(401).json({ error: \"Invalid or missing auth token\" });\n        return;\n      }\n    }\n\n    const governorUrl = typeof req.query.governorUrl === \"string\" ? req.query.governorUrl : null;\n    if (!governorUrl) {\n      res.status(400).json({ error: \"Missing governorUrl query parameter\" });\n      return;\n    }\n\n    const hostHeader = req.get(\"x-forwarded-host\") ?? req.get(\"host\");\n    const host = hostHeader?.split(\",\")[0]?.trim();\n    if (!host) {\n      res.status(400).json({ error: \"Missing Host header\" });\n      return;\n    }\n\n    const protoHeader = req.get(\"x-forwarded-proto\");\n    const forwardedProto = protoHeader?.split(\",\")[0]?.trim();\n    const proto = forwardedProto?.length ? forwardedProto : req.protocol;\n\n    const redirectUri = `${proto}://${host}/auth/mux-governor/callback`;\n    const result = context.muxGovernorOauthService.startServerFlow({\n      governorOrigin: governorUrl,\n      redirectUri,\n    });\n\n    if (!result.success) {\n      res.status(400).json({ error: result.error });\n      return;\n    }\n\n    res.json({ authorizeUrl: result.data.authorizeUrl, state: result.data.state });\n  });\n\n  app.all(\"/auth/mux-governor/callback\", async (req, res) => {\n    // Some providers use 307/308 redirects that preserve POST, or response_mode=form_post.\n    if (req.method !== \"GET\" && req.method !== \"POST\") {\n      res.sendStatus(405);\n      return;\n    }\n\n    const state = getStringParamFromQueryOrBody(req, \"state\");\n    const code = getStringParamFromQueryOrBody(req, \"code\");\n    const error = getStringParamFromQueryOrBody(req, \"error\");\n    const errorDescription = getStringParamFromQueryOrBody(req, \"error_description\") ?? undefined;\n\n    log.debug(\"Governor OAuth callback received\", {\n      method: req.method,\n      state,\n      hasCode: typeof code === \"string\" && code.length > 0,\n      hasError: typeof error === \"string\" && error.length > 0,\n    });\n\n    const result = await context.muxGovernorOauthService.handleServerCallbackAndExchange({\n      state,\n      code,\n      error,\n      errorDescription,\n    });\n\n    const payload = {\n      type: \"mux-governor-oauth\",\n      state,\n      ok: result.success,\n      error: result.success ? null : result.error,\n    };\n\n    const payloadJson = escapeJsonForHtmlScript(payload);\n\n    const title = result.success ? \"Enrollment complete\" : \"Enrollment failed\";\n    const description = result.success\n      ? \"You can return to Mux. You may now close this tab.\"\n      : payload.error\n        ? escapeHtml(payload.error)\n        : \"An unknown error occurred.\";\n\n    const html = `<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"dark light\" />\n    <title>${title}</title>\n    <style>\n      body { font-family: system-ui, sans-serif; max-width: 600px; margin: 4rem auto; padding: 1rem; }\n      h1 { margin-bottom: 1rem; }\n      .muted { color: #666; }\n      .btn { display: inline-block; padding: 0.5rem 1rem; background: #333; color: #fff; text-decoration: none; border-radius: 4px; }\n    </style>\n  </head>\n  <body>\n    <h1>${title}</h1>\n    <p>${description}</p>\n    ${result.success ? '<p class=\"muted\">This tab should close automatically.</p>' : \"\"}\n    <p><a class=\"btn\" href=\"/\">Return to Mux</a></p>\n\n    <script>\n      (() => {\n        const payload = ${payloadJson};\n        const ok = payload.ok === true;\n\n        try {\n          if (window.opener && typeof window.opener.postMessage === \"function\") {\n            window.opener.postMessage(payload, \"*\");\n          }\n        } catch {\n          // Ignore postMessage failures.\n        }\n\n        if (!ok) {\n          return;\n        }\n\n        try {\n          if (window.opener && typeof window.opener.focus === \"function\") {\n            window.opener.focus();\n          }\n        } catch {\n          // Ignore focus failures.\n        }\n\n        try {\n          window.close();\n        } catch {\n          // Ignore close failures.\n        }\n\n        setTimeout(() => {\n          try {\n            window.close();\n          } catch {\n            // Ignore close failures.\n          }\n        }, 50);\n\n        setTimeout(() => {\n          try {\n            window.location.replace(\"/\");\n          } catch {\n            // Ignore navigation failures.\n          }\n        }, 150);\n      })();\n    </script>\n  </body>\n</html>`;\n\n    res.status(result.success ? 200 : 400);\n    res.setHeader(\"Content-Type\", \"text/html\");\n    res.send(html);\n  });\n\n  // --- MCP OAuth (unauthenticated redirect callback) ---\n  // The OAuth provider cannot attach a mux Bearer token during redirects.\n  app.all(\"/auth/mcp-oauth/callback\", async (req, res) => {\n    // Some providers use 307/308 redirects that preserve POST, or response_mode=form_post.\n    if (req.method !== \"GET\" && req.method !== \"POST\") {\n      res.sendStatus(405);\n      return;\n    }\n\n    const state = getStringParamFromQueryOrBody(req, \"state\");\n    const code = getStringParamFromQueryOrBody(req, \"code\");\n    const error = getStringParamFromQueryOrBody(req, \"error\");\n    const errorDescription = getStringParamFromQueryOrBody(req, \"error_description\") ?? undefined;\n\n    const result = await context.mcpOauthService.handleServerCallbackAndExchange({\n      state,\n      code,\n      error,\n      errorDescription,\n    });\n\n    const payload = {\n      type: \"mcp-oauth\",\n      state,\n      ok: result.success,\n      error: result.success ? null : result.error,\n    };\n\n    const payloadJson = escapeJsonForHtmlScript(payload);\n\n    const title = result.success ? \"Login complete\" : \"Login failed\";\n    const description = result.success\n      ? \"You can return to Mux. You may now close this tab.\"\n      : payload.error\n        ? escapeHtml(payload.error)\n        : \"An unknown error occurred.\";\n\n    const html = `<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"dark light\" />\n    <meta name=\"theme-color\" content=\"#0e0e0e\" />\n    <title>${title}</title>\n    <link rel=\"stylesheet\" href=\"https://gateway.mux.coder.com/static/css/site.css\" />\n  </head>\n  <body>\n    <div class=\"page\">\n      <header class=\"site-header\">\n        <div class=\"container\">\n          <div class=\"header-title\">mux</div>\n        </div>\n      </header>\n\n      <main class=\"site-main\">\n        <div class=\"container\">\n          <div class=\"content-surface\">\n            <h1>${title}</h1>\n            <p>${description}</p>\n            ${result.success ? '<p class=\"muted\">This tab should close automatically.</p>' : \"\"}\n            <p><a class=\"btn primary\" href=\"/\">Return to Mux</a></p>\n          </div>\n        </div>\n      </main>\n    </div>\n\n    <script>\n      (() => {\n        const payload = ${payloadJson};\n        const ok = payload.ok === true;\n\n        try {\n          if (window.opener && typeof window.opener.postMessage === \"function\") {\n            window.opener.postMessage(payload, \"*\");\n          }\n        } catch {\n          // Ignore postMessage failures.\n        }\n\n        if (!ok) {\n          return;\n        }\n\n        try {\n          if (window.opener && typeof window.opener.focus === \"function\") {\n            window.opener.focus();\n          }\n        } catch {\n          // Ignore focus failures.\n        }\n\n        try {\n          window.close();\n        } catch {\n          // Ignore close failures.\n        }\n\n        setTimeout(() => {\n          try {\n            window.close();\n          } catch {\n            // Ignore close failures.\n          }\n        }, 50);\n\n        setTimeout(() => {\n          try {\n            window.location.replace(\"/\");\n          } catch {\n            // Ignore navigation failures.\n          }\n        }, 150);\n      })();\n    </script>\n  </body>\n</html>`;\n\n    res.status(result.success ? 200 : 400);\n    res.setHeader(\"Content-Type\", \"text/html\");\n    res.send(html);\n  });\n\n  const orpcRouter = existingRouter ?? router(authToken);\n\n  // OpenAPI generator for spec endpoint\n  const openAPIGenerator = new OpenAPIGenerator({\n    schemaConverters: [new ZodToJsonSchemaConverter()],\n  });\n\n  // OpenAPI spec endpoint\n  app.get(\"/api/spec.json\", async (_req, res) => {\n    const versionRecord = VERSION as Record<string, unknown>;\n    const gitDescribe =\n      typeof versionRecord.git_describe === \"string\" ? versionRecord.git_describe : \"unknown\";\n\n    const spec = await openAPIGenerator.generate(orpcRouter, {\n      info: {\n        title: \"Mux API\",\n        version: gitDescribe,\n        description: \"API for Mux\",\n      },\n      servers: [{ url: \"/api\" }],\n      security: authToken ? [{ bearerAuth: [] }] : undefined,\n      components: authToken\n        ? {\n          securitySchemes: {\n            bearerAuth: {\n              type: \"http\",\n              scheme: \"bearer\",\n            },\n          },\n        }\n        : undefined,\n    });\n    res.json(spec);\n  });\n\n  // Scalar API reference UI\n  app.get(\"/api/docs\", (_req, res) => {\n    const html = `<!doctype html>\n<html>\n  <head>\n    <title>mux API Reference</title>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  </head>\n  <body>\n    <div id=\"app\"></div>\n    <script src=\"https://cdn.jsdelivr.net/npm/@scalar/api-reference\"></script>\n    <script>\n      Scalar.createApiReference('#app', {\n        url: '/api/spec.json',\n        ${authToken ? \"authentication: { securitySchemes: { bearerAuth: { token: '' } } },\" : \"\"}\n      })\n    </script>\n  </body>\n</html>`;\n    res.setHeader(\"Content-Type\", \"text/html\");\n    res.send(html);\n  });\n\n  // OpenAPI REST handler (for Scalar/OpenAPI clients)\n  const openAPIHandler = new OpenAPIHandler(orpcRouter, {\n    interceptors: [onError(onOrpcError)],\n  });\n\n  app.use(\"/api\", async (req, res, next) => {\n    // Skip spec.json and docs routes - they're handled above\n    if (req.path === \"/spec.json\" || req.path === \"/docs\") {\n      return next();\n    }\n    const { matched } = await openAPIHandler.handle(req, res, {\n      prefix: \"/api\",\n      context: { ...context, headers: req.headers },\n    });\n    if (matched) return;\n    next();\n  });\n\n  // oRPC HTTP handler\n  const orpcHandler = new RPCHandler(orpcRouter, {\n    interceptors: [onError(onOrpcError)],\n  });\n\n  // Mount ORPC handler on /orpc and all subpaths\n  app.use(\"/orpc\", async (req, res, next) => {\n    const { matched } = await orpcHandler.handle(req, res, {\n      prefix: \"/orpc\",\n      context: { ...context, headers: req.headers },\n    });\n    if (matched) return;\n    next();\n  });\n\n  // SPA fallback (optional, only for non-API routes)\n  if (serveStatic) {\n    app.use((req, res, next) => {\n      // Don't swallow API/ORPC routes with index.html.\n      if (req.path.startsWith(\"/orpc\") || req.path.startsWith(\"/api\")) {\n        return next();\n      }\n\n      if (spaIndexHtml !== null) {\n        res.setHeader(\"Content-Type\", \"text/html\");\n        res.send(spaIndexHtml);\n        return;\n      }\n\n      // If the server was started with serveStatic enabled but the frontend build\n      // hasn't been generated (common in `make dev-server`), avoid throwing noisy\n      // NotFoundError stack traces. Let the request fall through to a normal 404.\n      next();\n    });\n  }\n\n  // Create HTTP server\n  const httpServer = http.createServer(app);\n\n  // Avoid process crashes from unhandled socket/server errors.\n  attachStreamErrorHandler(httpServer, \"orpc-http-server\", { logger: log });\n\n  httpServer.on(\"clientError\", (error, socket) => {\n    if (isIgnorableStreamError(error)) {\n      socket.destroy();\n      return;\n    }\n\n    const message = error instanceof Error ? error.message : String(error);\n    const code =\n      error && typeof error === \"object\" && \"code\" in error && typeof error.code === \"string\"\n        ? error.code\n        : undefined;\n\n    log.warn(\"ORPC HTTP client error\", { code, message });\n\n    try {\n      socket.end(\"HTTP/1.1 400 Bad Request\\r\\n\\r\\n\");\n    } catch {\n      socket.destroy();\n    }\n  });\n\n  // oRPC WebSocket handler\n  const wsServer = new WebSocketServer({ server: httpServer, path: \"/orpc/ws\" });\n\n  attachStreamErrorHandler(wsServer, \"orpc-ws-server\", { logger: log });\n\n  // WebSocket heartbeat: proactively terminate half-open connections (common with NAT/proxy setups).\n  // When a client is unresponsive, closing the socket forces the browser to reconnect.\n  const heartbeatInterval = setInterval(() => {\n    for (const ws of wsServer.clients) {\n      const socket = ws as AliveWebSocket;\n      if (socket.isAlive === false) {\n        ws.terminate();\n        continue;\n      }\n\n      socket.isAlive = false;\n      try {\n        ws.ping();\n      } catch {\n        // Best-effort - ws may already be closing.\n      }\n    }\n  }, WS_HEARTBEAT_INTERVAL_MS);\n\n  const orpcWsHandler = new ORPCWebSocketServerHandler(orpcRouter, {\n    interceptors: [onError(onOrpcError)],\n  });\n\n  wsServer.on(\"connection\", (ws, req) => {\n    const terminate = () => {\n      try {\n        ws.terminate();\n      } catch {\n        // Best-effort.\n      }\n    };\n\n    attachStreamErrorHandler(ws, \"orpc-ws-connection\", {\n      logger: log,\n      onIgnorable: terminate,\n      onUnexpected: terminate,\n    });\n    const socket = ws as AliveWebSocket;\n    socket.isAlive = true;\n    ws.on(\"pong\", () => {\n      socket.isAlive = true;\n    });\n\n    const headers = extractWsHeaders(req);\n    void orpcWsHandler.upgrade(ws, { context: { ...context, headers } });\n  });\n\n  // Start listening\n  await new Promise<void>((resolve, reject) => {\n    const onListenError = (error: Error) => {\n      httpServer.removeListener(\"error\", onListenError);\n      reject(error);\n    };\n\n    httpServer.once(\"error\", onListenError);\n    httpServer.listen(port, host, () => {\n      httpServer.removeListener(\"error\", onListenError);\n      resolve();\n    });\n  });\n\n  // Get actual port (useful when port=0)\n  const address = httpServer.address();\n  if (!address || typeof address === \"string\") {\n    throw new Error(\"Failed to get server address\");\n  }\n  const actualPort = address.port;\n\n  // Wildcard addresses (0.0.0.0, ::) are not routable - convert to loopback for lockfile\n  const connectableHost = host === \"0.0.0.0\" || host === \"::\" ? \"127.0.0.1\" : host;\n  const connectableHostForUrl = formatHostForUrl(connectableHost);\n\n  return {\n    httpServer,\n    wsServer,\n    app,\n    port: actualPort,\n    baseUrl: `http://${connectableHostForUrl}:${actualPort}`,\n    wsUrl: `ws://${connectableHostForUrl}:${actualPort}/orpc/ws`,\n    specUrl: `http://${connectableHostForUrl}:${actualPort}/api/spec.json`,\n    docsUrl: `http://${connectableHostForUrl}:${actualPort}/api/docs`,\n    close: async () => {\n      clearInterval(heartbeatInterval);\n      for (const ws of wsServer.clients) {\n        ws.terminate();\n      }\n\n      // Close WebSocket server first\n      await new Promise<void>((resolve) => {\n        wsServer.close(() => resolve());\n      });\n      // Then close HTTP server\n      httpServer.closeIdleConnections?.();\n      httpServer.closeAllConnections?.();\n      if (httpServer.listening) {\n        await new Promise<void>((resolve, reject) => {\n          httpServer.close((err) => (err ? reject(err) : resolve()));\n        });\n      }\n    },\n  };\n}\n"]}