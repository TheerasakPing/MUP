{"version":3,"file":"server.js","sourceRoot":"","sources":["../../../src/node/orpc/server.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * oRPC Server factory for mux.\r\n * Serves oRPC router over HTTP and WebSocket.\r\n *\r\n * This module exports the server creation logic so it can be tested.\r\n * The CLI entry point (server.ts) uses this to start the server.\r\n */\r\nimport cors from \"cors\";\r\nimport express, { type Express } from \"express\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as http from \"http\";\r\nimport * as path from \"path\";\r\nimport { WebSocketServer, type WebSocket } from \"ws\";\r\nimport { RPCHandler } from \"@orpc/server/node\";\r\nimport { RPCHandler as ORPCWebSocketServerHandler } from \"@orpc/server/ws\";\r\nimport { ORPCError, onError } from \"@orpc/server\";\r\nimport { OpenAPIGenerator } from \"@orpc/openapi\";\r\nimport { OpenAPIHandler } from \"@orpc/openapi/node\";\r\nimport { ZodToJsonSchemaConverter } from \"@orpc/zod/zod4\";\r\nimport { router, type AppRouter } from \"@/node/orpc/router\";\r\nimport type { ORPCContext } from \"@/node/orpc/context\";\r\nimport { extractWsHeaders, safeEq } from \"@/node/orpc/authMiddleware\";\r\nimport { VERSION } from \"@/version\";\r\nimport { formatOrpcError } from \"@/node/orpc/formatOrpcError\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { attachStreamErrorHandler, isIgnorableStreamError } from \"@/node/utils/streamErrors\";\r\n\r\ntype AliveWebSocket = WebSocket & { isAlive?: boolean };\r\n\r\nconst WS_HEARTBEAT_INTERVAL_MS = 30_000;\r\n\r\n// --- Types ---\r\n\r\nexport interface OrpcServerOptions {\r\n  /** Host to bind to (default: \"127.0.0.1\") */\r\n  host?: string;\r\n  /** Port to bind to (default: 0 for random available port) */\r\n  port?: number;\r\n  /** oRPC context with services */\r\n  context: ORPCContext;\r\n  /** Whether to serve static files and SPA fallback (default: false) */\r\n  serveStatic?: boolean;\r\n  /** Directory to serve static files from (default: dist/ relative to dist/node/orpc/) */\r\n  staticDir?: string;\r\n  /** Custom error handler for oRPC errors */\r\n  onOrpcError?: (error: unknown, options: unknown) => void;\r\n  /** Optional bearer token for HTTP auth (used if router not provided) */\r\n  authToken?: string;\r\n  /** Optional pre-created router (if not provided, creates router(authToken)) */\r\n  router?: AppRouter;\r\n}\r\n\r\nexport interface OrpcServer {\r\n  /** The HTTP server instance */\r\n  httpServer: http.Server;\r\n  /** The WebSocket server instance */\r\n  wsServer: WebSocketServer;\r\n  /** The Express app instance */\r\n  app: Express;\r\n  /** The port the server is listening on */\r\n  port: number;\r\n  /** Base URL for HTTP requests */\r\n  baseUrl: string;\r\n  /** WebSocket URL for WS connections */\r\n  wsUrl: string;\r\n  /** URL for OpenAPI spec JSON */\r\n  specUrl: string;\r\n  /** URL for Scalar API docs */\r\n  docsUrl: string;\r\n  /** Close the server and cleanup resources */\r\n  close: () => Promise<void>;\r\n}\r\n\r\n// --- Server Factory ---\r\n\r\nfunction formatHostForUrl(host: string): string {\r\n  const trimmed = host.trim();\r\n\r\n  // IPv6 URLs must be bracketed: http://[::1]:1234\r\n  if (trimmed.includes(\":\")) {\r\n    if (trimmed.startsWith(\"[\") && trimmed.endsWith(\"]\")) {\r\n      return trimmed;\r\n    }\r\n\r\n    // If the host contains a zone index (e.g. fe80::1%en0), percent must be encoded.\r\n    const escaped = trimmed.replaceAll(\"%\", \"%25\");\r\n    return `[${escaped}]`;\r\n  }\r\n\r\n  return trimmed;\r\n}\r\n\r\nfunction extractBearerToken(header: string | undefined): string | null {\r\n  if (!header?.toLowerCase().startsWith(\"bearer \")) return null;\r\n  const token = header.slice(7).trim();\r\n  return token.length ? token : null;\r\n}\r\nfunction injectBaseHref(indexHtml: string, baseHref: string): string {\r\n  // Avoid double-injecting if the HTML already has a base tag.\r\n  if (/<base\\b/i.test(indexHtml)) {\r\n    return indexHtml;\r\n  }\r\n\r\n  // Insert immediately after the opening <head> tag (supports <head> and <head ...attrs>).\r\n  return indexHtml.replace(/<head[^>]*>/i, (match) => `${match}\\n    <base href=\"${baseHref}\" />`);\r\n}\r\n\r\nfunction escapeJsonForHtmlScript(value: unknown): string {\r\n  // Prevent `</script>` injection when embedding untrusted strings in an inline <script>.\r\n  return JSON.stringify(value).replaceAll(\"<\", \"\\\\u003c\");\r\n}\r\nfunction escapeHtml(input: string): string {\r\n  return input\r\n    .replaceAll(\"&\", \"&amp;\")\r\n    .replaceAll(\"<\", \"&lt;\")\r\n    .replaceAll(\">\", \"&gt;\")\r\n    .replaceAll('\"', \"&quot;\")\r\n    .replaceAll(\"'\", \"&#39;\");\r\n}\r\n\r\n/**\r\n * Create an oRPC server with HTTP and WebSocket endpoints.\r\n *\r\n * HTTP endpoint: /orpc\r\n * WebSocket endpoint: /orpc/ws\r\n * Health check: /health\r\n * Version: /version\r\n */\r\nexport async function createOrpcServer({\r\n  host = \"127.0.0.1\",\r\n  port = 0,\r\n  authToken,\r\n  context,\r\n  serveStatic = false,\r\n  // From dist/node/orpc/, go up 2 levels to reach dist/ where index.html lives\r\n  staticDir = path.join(__dirname, \"../..\"),\r\n  onOrpcError = (error, options) => {\r\n    // Auth failures are expected in browser mode while the user enters the token.\r\n    // Avoid spamming error logs with stack traces on every unauthenticated request.\r\n    if (error instanceof ORPCError && error.code === \"UNAUTHORIZED\") {\r\n      log.debug(\"ORPC unauthorized request\");\r\n      return;\r\n    }\r\n\r\n    const formatted = formatOrpcError(error, options);\r\n    log.error(formatted.message);\r\n\r\n    if (log.isDebugMode()) {\r\n      const suffix = Math.random().toString(16).slice(2);\r\n      log.debug_obj(`orpc/${Date.now()}_${suffix}.json`, formatted.debugDump);\r\n    }\r\n  },\r\n  router: existingRouter,\r\n}: OrpcServerOptions): Promise<OrpcServer> {\r\n  // Express app setup\r\n  const app = express();\r\n  app.use(cors());\r\n  // OAuth providers may use POST redirects (307/308) or response_mode=form_post.\r\n  // Support both JSON API requests and form-encoded callback payloads.\r\n  app.use(express.json({ limit: \"50mb\" }));\r\n  app.use(express.urlencoded({ extended: false }));\r\n\r\n  let spaIndexHtml: string | null = null;\r\n\r\n  // Static file serving (optional)\r\n  if (serveStatic) {\r\n    try {\r\n      const indexHtmlPath = path.join(staticDir, \"index.html\");\r\n      const indexHtml = await fs.readFile(indexHtmlPath, \"utf8\");\r\n      spaIndexHtml = injectBaseHref(indexHtml, \"/\");\r\n    } catch (error) {\r\n      log.error(\"Failed to read index.html for SPA fallback:\", error);\r\n    }\r\n\r\n    app.use(express.static(staticDir));\r\n  }\r\n\r\n  // Serve icon theme files (SVG, PNG, etc.) from ~/.mux/icon-themes/\r\n  {\r\n    const iconThemesDir = context.iconThemeService.getIconThemesDir();\r\n    app.use(\"/icon-themes\", express.static(iconThemesDir, {\r\n      maxAge: \"1d\",\r\n      immutable: true,\r\n      setHeaders: (res, filePath) => {\r\n        // Set correct Content-Type for SVGs\r\n        if (filePath.endsWith(\".svg\")) {\r\n          res.setHeader(\"Content-Type\", \"image/svg+xml\");\r\n        }\r\n      },\r\n    }));\r\n  }\r\n\r\n  // Health check endpoint\r\n  app.get(\"/health\", (_req, res) => {\r\n    res.json({ status: \"ok\" });\r\n  });\r\n\r\n  // Version endpoint\r\n  app.get(\"/version\", (_req, res) => {\r\n    res.json({ ...VERSION, mode: \"server\" });\r\n  });\r\n\r\n  function getStringParamFromQueryOrBody(req: express.Request, key: string): string | null {\r\n    const queryValue = req.query[key];\r\n    if (typeof queryValue === \"string\") return queryValue;\r\n\r\n    const bodyRecord = req.body as Record<string, unknown> | undefined;\r\n    const bodyValue = bodyRecord?.[key];\r\n    return typeof bodyValue === \"string\" ? bodyValue : null;\r\n  }\r\n  // --- Mux Gateway OAuth (unauthenticated bootstrap routes) ---\r\n  // These are raw Express routes (not oRPC) because the OAuth provider cannot\r\n  // send a mux Bearer token during the redirect callback.\r\n  app.get(\"/auth/mux-gateway/start\", (req, res) => {\r\n    if (authToken?.trim()) {\r\n      const expectedToken = authToken.trim();\r\n      const presentedToken = extractBearerToken(req.header(\"authorization\"));\r\n      if (!presentedToken || !safeEq(presentedToken, expectedToken)) {\r\n        res.status(401).json({ error: \"Invalid or missing auth token\" });\r\n        return;\r\n      }\r\n    }\r\n\r\n    const hostHeader = req.get(\"x-forwarded-host\") ?? req.get(\"host\");\r\n    const host = hostHeader?.split(\",\")[0]?.trim();\r\n    if (!host) {\r\n      res.status(400).json({ error: \"Missing Host header\" });\r\n      return;\r\n    }\r\n\r\n    // When mux is running behind a reverse proxy, the terminating proxy may set\r\n    // X-Forwarded-Proto / X-Forwarded-Host, while the direct connection to mux\r\n    // is plain HTTP.\r\n    const protoHeader = req.get(\"x-forwarded-proto\");\r\n    const forwardedProto = protoHeader?.split(\",\")[0]?.trim();\r\n    const proto = forwardedProto?.length ? forwardedProto : req.protocol;\r\n\r\n    const redirectUri = `${proto}://${host}/auth/mux-gateway/callback`;\r\n    const { authorizeUrl, state } = context.muxGatewayOauthService.startServerFlow({ redirectUri });\r\n    res.json({ authorizeUrl, state });\r\n  });\r\n\r\n  app.all(\"/auth/mux-gateway/callback\", async (req, res) => {\r\n    // Some providers use 307/308 redirects that preserve POST, or response_mode=form_post.\r\n    if (req.method !== \"GET\" && req.method !== \"POST\") {\r\n      res.sendStatus(405);\r\n      return;\r\n    }\r\n\r\n    const state = getStringParamFromQueryOrBody(req, \"state\");\r\n    const code = getStringParamFromQueryOrBody(req, \"code\");\r\n    const error = getStringParamFromQueryOrBody(req, \"error\");\r\n    const errorDescription = getStringParamFromQueryOrBody(req, \"error_description\") ?? undefined;\r\n\r\n    const result = await context.muxGatewayOauthService.handleServerCallbackAndExchange({\r\n      state,\r\n      code,\r\n      error,\r\n      errorDescription,\r\n    });\r\n\r\n    const payload = {\r\n      type: \"mux-gateway-oauth\",\r\n      state,\r\n      ok: result.success,\r\n      error: result.success ? null : result.error,\r\n    };\r\n\r\n    const payloadJson = escapeJsonForHtmlScript(payload);\r\n\r\n    const title = result.success ? \"Login complete\" : \"Login failed\";\r\n    const description = result.success\r\n      ? \"You can return to Mux. You may now close this tab.\"\r\n      : payload.error\r\n        ? escapeHtml(payload.error)\r\n        : \"An unknown error occurred.\";\r\n\r\n    const html = `<!doctype html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <meta name=\"color-scheme\" content=\"dark light\" />\r\n    <meta name=\"theme-color\" content=\"#0e0e0e\" />\r\n    <title>${title}</title>\r\n    <link rel=\"stylesheet\" href=\"https://gateway.mux.coder.com/static/css/site.css\" />\r\n  </head>\r\n  <body>\r\n    <div class=\"page\">\r\n      <header class=\"site-header\">\r\n        <div class=\"container\">\r\n          <div class=\"header-title\">mux</div>\r\n        </div>\r\n      </header>\r\n\r\n      <main class=\"site-main\">\r\n        <div class=\"container\">\r\n          <div class=\"content-surface\">\r\n            <h1>${title}</h1>\r\n            <p>${description}</p>\r\n            ${result.success ? '<p class=\"muted\">This tab should close automatically.</p>' : \"\"}\r\n            <p><a class=\"btn primary\" href=\"/\">Return to Mux</a></p>\r\n          </div>\r\n        </div>\r\n      </main>\r\n    </div>\r\n\r\n    <script>\r\n      (() => {\r\n        const payload = ${payloadJson};\r\n        const ok = payload.ok === true;\r\n\r\n        try {\r\n          if (window.opener && typeof window.opener.postMessage === \"function\") {\r\n            window.opener.postMessage(payload, \"*\");\r\n          }\r\n        } catch {\r\n          // Ignore postMessage failures.\r\n        }\r\n\r\n        if (!ok) {\r\n          return;\r\n        }\r\n\r\n        try {\r\n          if (window.opener && typeof window.opener.focus === \"function\") {\r\n            window.opener.focus();\r\n          }\r\n        } catch {\r\n          // Ignore focus failures.\r\n        }\r\n\r\n        try {\r\n          window.close();\r\n        } catch {\r\n          // Ignore close failures.\r\n        }\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.close();\r\n          } catch {\r\n            // Ignore close failures.\r\n          }\r\n        }, 50);\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.location.replace(\"/\");\r\n          } catch {\r\n            // Ignore navigation failures.\r\n          }\r\n        }, 150);\r\n      })();\r\n    </script>\r\n  </body>\r\n</html>`;\r\n\r\n    res.status(result.success ? 200 : 400);\r\n    res.setHeader(\"Content-Type\", \"text/html\");\r\n    res.send(html);\r\n  });\r\n\r\n  // --- Mux Governor OAuth (unauthenticated bootstrap routes) ---\r\n  // Similar to Mux Gateway OAuth but accepts user-provided governorUrl.\r\n  app.get(\"/auth/mux-governor/start\", (req, res) => {\r\n    if (authToken?.trim()) {\r\n      const expectedToken = authToken.trim();\r\n      const presentedToken = extractBearerToken(req.header(\"authorization\"));\r\n      if (!presentedToken || !safeEq(presentedToken, expectedToken)) {\r\n        res.status(401).json({ error: \"Invalid or missing auth token\" });\r\n        return;\r\n      }\r\n    }\r\n\r\n    const governorUrl = typeof req.query.governorUrl === \"string\" ? req.query.governorUrl : null;\r\n    if (!governorUrl) {\r\n      res.status(400).json({ error: \"Missing governorUrl query parameter\" });\r\n      return;\r\n    }\r\n\r\n    const hostHeader = req.get(\"x-forwarded-host\") ?? req.get(\"host\");\r\n    const host = hostHeader?.split(\",\")[0]?.trim();\r\n    if (!host) {\r\n      res.status(400).json({ error: \"Missing Host header\" });\r\n      return;\r\n    }\r\n\r\n    const protoHeader = req.get(\"x-forwarded-proto\");\r\n    const forwardedProto = protoHeader?.split(\",\")[0]?.trim();\r\n    const proto = forwardedProto?.length ? forwardedProto : req.protocol;\r\n\r\n    const redirectUri = `${proto}://${host}/auth/mux-governor/callback`;\r\n    const result = context.muxGovernorOauthService.startServerFlow({\r\n      governorOrigin: governorUrl,\r\n      redirectUri,\r\n    });\r\n\r\n    if (!result.success) {\r\n      res.status(400).json({ error: result.error });\r\n      return;\r\n    }\r\n\r\n    res.json({ authorizeUrl: result.data.authorizeUrl, state: result.data.state });\r\n  });\r\n\r\n  app.all(\"/auth/mux-governor/callback\", async (req, res) => {\r\n    // Some providers use 307/308 redirects that preserve POST, or response_mode=form_post.\r\n    if (req.method !== \"GET\" && req.method !== \"POST\") {\r\n      res.sendStatus(405);\r\n      return;\r\n    }\r\n\r\n    const state = getStringParamFromQueryOrBody(req, \"state\");\r\n    const code = getStringParamFromQueryOrBody(req, \"code\");\r\n    const error = getStringParamFromQueryOrBody(req, \"error\");\r\n    const errorDescription = getStringParamFromQueryOrBody(req, \"error_description\") ?? undefined;\r\n\r\n    log.debug(\"Governor OAuth callback received\", {\r\n      method: req.method,\r\n      state,\r\n      hasCode: typeof code === \"string\" && code.length > 0,\r\n      hasError: typeof error === \"string\" && error.length > 0,\r\n    });\r\n\r\n    const result = await context.muxGovernorOauthService.handleServerCallbackAndExchange({\r\n      state,\r\n      code,\r\n      error,\r\n      errorDescription,\r\n    });\r\n\r\n    const payload = {\r\n      type: \"mux-governor-oauth\",\r\n      state,\r\n      ok: result.success,\r\n      error: result.success ? null : result.error,\r\n    };\r\n\r\n    const payloadJson = escapeJsonForHtmlScript(payload);\r\n\r\n    const title = result.success ? \"Enrollment complete\" : \"Enrollment failed\";\r\n    const description = result.success\r\n      ? \"You can return to Mux. You may now close this tab.\"\r\n      : payload.error\r\n        ? escapeHtml(payload.error)\r\n        : \"An unknown error occurred.\";\r\n\r\n    const html = `<!doctype html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <meta name=\"color-scheme\" content=\"dark light\" />\r\n    <title>${title}</title>\r\n    <style>\r\n      body { font-family: system-ui, sans-serif; max-width: 600px; margin: 4rem auto; padding: 1rem; }\r\n      h1 { margin-bottom: 1rem; }\r\n      .muted { color: #666; }\r\n      .btn { display: inline-block; padding: 0.5rem 1rem; background: #333; color: #fff; text-decoration: none; border-radius: 4px; }\r\n    </style>\r\n  </head>\r\n  <body>\r\n    <h1>${title}</h1>\r\n    <p>${description}</p>\r\n    ${result.success ? '<p class=\"muted\">This tab should close automatically.</p>' : \"\"}\r\n    <p><a class=\"btn\" href=\"/\">Return to Mux</a></p>\r\n\r\n    <script>\r\n      (() => {\r\n        const payload = ${payloadJson};\r\n        const ok = payload.ok === true;\r\n\r\n        try {\r\n          if (window.opener && typeof window.opener.postMessage === \"function\") {\r\n            window.opener.postMessage(payload, \"*\");\r\n          }\r\n        } catch {\r\n          // Ignore postMessage failures.\r\n        }\r\n\r\n        if (!ok) {\r\n          return;\r\n        }\r\n\r\n        try {\r\n          if (window.opener && typeof window.opener.focus === \"function\") {\r\n            window.opener.focus();\r\n          }\r\n        } catch {\r\n          // Ignore focus failures.\r\n        }\r\n\r\n        try {\r\n          window.close();\r\n        } catch {\r\n          // Ignore close failures.\r\n        }\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.close();\r\n          } catch {\r\n            // Ignore close failures.\r\n          }\r\n        }, 50);\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.location.replace(\"/\");\r\n          } catch {\r\n            // Ignore navigation failures.\r\n          }\r\n        }, 150);\r\n      })();\r\n    </script>\r\n  </body>\r\n</html>`;\r\n\r\n    res.status(result.success ? 200 : 400);\r\n    res.setHeader(\"Content-Type\", \"text/html\");\r\n    res.send(html);\r\n  });\r\n\r\n  // --- MCP OAuth (unauthenticated redirect callback) ---\r\n  // The OAuth provider cannot attach a mux Bearer token during redirects.\r\n  app.all(\"/auth/mcp-oauth/callback\", async (req, res) => {\r\n    // Some providers use 307/308 redirects that preserve POST, or response_mode=form_post.\r\n    if (req.method !== \"GET\" && req.method !== \"POST\") {\r\n      res.sendStatus(405);\r\n      return;\r\n    }\r\n\r\n    const state = getStringParamFromQueryOrBody(req, \"state\");\r\n    const code = getStringParamFromQueryOrBody(req, \"code\");\r\n    const error = getStringParamFromQueryOrBody(req, \"error\");\r\n    const errorDescription = getStringParamFromQueryOrBody(req, \"error_description\") ?? undefined;\r\n\r\n    const result = await context.mcpOauthService.handleServerCallbackAndExchange({\r\n      state,\r\n      code,\r\n      error,\r\n      errorDescription,\r\n    });\r\n\r\n    const payload = {\r\n      type: \"mcp-oauth\",\r\n      state,\r\n      ok: result.success,\r\n      error: result.success ? null : result.error,\r\n    };\r\n\r\n    const payloadJson = escapeJsonForHtmlScript(payload);\r\n\r\n    const title = result.success ? \"Login complete\" : \"Login failed\";\r\n    const description = result.success\r\n      ? \"You can return to Mux. You may now close this tab.\"\r\n      : payload.error\r\n        ? escapeHtml(payload.error)\r\n        : \"An unknown error occurred.\";\r\n\r\n    const html = `<!doctype html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <meta name=\"color-scheme\" content=\"dark light\" />\r\n    <meta name=\"theme-color\" content=\"#0e0e0e\" />\r\n    <title>${title}</title>\r\n    <link rel=\"stylesheet\" href=\"https://gateway.mux.coder.com/static/css/site.css\" />\r\n  </head>\r\n  <body>\r\n    <div class=\"page\">\r\n      <header class=\"site-header\">\r\n        <div class=\"container\">\r\n          <div class=\"header-title\">mux</div>\r\n        </div>\r\n      </header>\r\n\r\n      <main class=\"site-main\">\r\n        <div class=\"container\">\r\n          <div class=\"content-surface\">\r\n            <h1>${title}</h1>\r\n            <p>${description}</p>\r\n            ${result.success ? '<p class=\"muted\">This tab should close automatically.</p>' : \"\"}\r\n            <p><a class=\"btn primary\" href=\"/\">Return to Mux</a></p>\r\n          </div>\r\n        </div>\r\n      </main>\r\n    </div>\r\n\r\n    <script>\r\n      (() => {\r\n        const payload = ${payloadJson};\r\n        const ok = payload.ok === true;\r\n\r\n        try {\r\n          if (window.opener && typeof window.opener.postMessage === \"function\") {\r\n            window.opener.postMessage(payload, \"*\");\r\n          }\r\n        } catch {\r\n          // Ignore postMessage failures.\r\n        }\r\n\r\n        if (!ok) {\r\n          return;\r\n        }\r\n\r\n        try {\r\n          if (window.opener && typeof window.opener.focus === \"function\") {\r\n            window.opener.focus();\r\n          }\r\n        } catch {\r\n          // Ignore focus failures.\r\n        }\r\n\r\n        try {\r\n          window.close();\r\n        } catch {\r\n          // Ignore close failures.\r\n        }\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.close();\r\n          } catch {\r\n            // Ignore close failures.\r\n          }\r\n        }, 50);\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.location.replace(\"/\");\r\n          } catch {\r\n            // Ignore navigation failures.\r\n          }\r\n        }, 150);\r\n      })();\r\n    </script>\r\n  </body>\r\n</html>`;\r\n\r\n    res.status(result.success ? 200 : 400);\r\n    res.setHeader(\"Content-Type\", \"text/html\");\r\n    res.send(html);\r\n  });\r\n\r\n  const orpcRouter = existingRouter ?? router(authToken);\r\n\r\n  // OpenAPI generator for spec endpoint\r\n  const openAPIGenerator = new OpenAPIGenerator({\r\n    schemaConverters: [new ZodToJsonSchemaConverter()],\r\n  });\r\n\r\n  // OpenAPI spec endpoint\r\n  app.get(\"/api/spec.json\", async (_req, res) => {\r\n    const versionRecord = VERSION as Record<string, unknown>;\r\n    const gitDescribe =\r\n      typeof versionRecord.git_describe === \"string\" ? versionRecord.git_describe : \"unknown\";\r\n\r\n    const spec = await openAPIGenerator.generate(orpcRouter, {\r\n      info: {\r\n        title: \"Mux API\",\r\n        version: gitDescribe,\r\n        description: \"API for Mux\",\r\n      },\r\n      servers: [{ url: \"/api\" }],\r\n      security: authToken ? [{ bearerAuth: [] }] : undefined,\r\n      components: authToken\r\n        ? {\r\n          securitySchemes: {\r\n            bearerAuth: {\r\n              type: \"http\",\r\n              scheme: \"bearer\",\r\n            },\r\n          },\r\n        }\r\n        : undefined,\r\n    });\r\n    res.json(spec);\r\n  });\r\n\r\n  // Scalar API reference UI\r\n  app.get(\"/api/docs\", (_req, res) => {\r\n    const html = `<!doctype html>\r\n<html>\r\n  <head>\r\n    <title>mux API Reference</title>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n  </head>\r\n  <body>\r\n    <div id=\"app\"></div>\r\n    <script src=\"https://cdn.jsdelivr.net/npm/@scalar/api-reference\"></script>\r\n    <script>\r\n      Scalar.createApiReference('#app', {\r\n        url: '/api/spec.json',\r\n        ${authToken ? \"authentication: { securitySchemes: { bearerAuth: { token: '' } } },\" : \"\"}\r\n      })\r\n    </script>\r\n  </body>\r\n</html>`;\r\n    res.setHeader(\"Content-Type\", \"text/html\");\r\n    res.send(html);\r\n  });\r\n\r\n  // OpenAPI REST handler (for Scalar/OpenAPI clients)\r\n  const openAPIHandler = new OpenAPIHandler(orpcRouter, {\r\n    interceptors: [onError(onOrpcError)],\r\n  });\r\n\r\n  app.use(\"/api\", async (req, res, next) => {\r\n    // Skip spec.json and docs routes - they're handled above\r\n    if (req.path === \"/spec.json\" || req.path === \"/docs\") {\r\n      return next();\r\n    }\r\n    const { matched } = await openAPIHandler.handle(req, res, {\r\n      prefix: \"/api\",\r\n      context: { ...context, headers: req.headers },\r\n    });\r\n    if (matched) return;\r\n    next();\r\n  });\r\n\r\n  // oRPC HTTP handler\r\n  const orpcHandler = new RPCHandler(orpcRouter, {\r\n    interceptors: [onError(onOrpcError)],\r\n  });\r\n\r\n  // Mount ORPC handler on /orpc and all subpaths\r\n  app.use(\"/orpc\", async (req, res, next) => {\r\n    const { matched } = await orpcHandler.handle(req, res, {\r\n      prefix: \"/orpc\",\r\n      context: { ...context, headers: req.headers },\r\n    });\r\n    if (matched) return;\r\n    next();\r\n  });\r\n\r\n  // SPA fallback (optional, only for non-API routes)\r\n  if (serveStatic) {\r\n    app.use((req, res, next) => {\r\n      // Don't swallow API/ORPC routes with index.html.\r\n      if (req.path.startsWith(\"/orpc\") || req.path.startsWith(\"/api\")) {\r\n        return next();\r\n      }\r\n\r\n      if (spaIndexHtml !== null) {\r\n        res.setHeader(\"Content-Type\", \"text/html\");\r\n        res.send(spaIndexHtml);\r\n        return;\r\n      }\r\n\r\n      // If the server was started with serveStatic enabled but the frontend build\r\n      // hasn't been generated (common in `make dev-server`), avoid throwing noisy\r\n      // NotFoundError stack traces. Let the request fall through to a normal 404.\r\n      next();\r\n    });\r\n  }\r\n\r\n  // Create HTTP server\r\n  const httpServer = http.createServer(app);\r\n\r\n  // Avoid process crashes from unhandled socket/server errors.\r\n  attachStreamErrorHandler(httpServer, \"orpc-http-server\", { logger: log });\r\n\r\n  httpServer.on(\"clientError\", (error, socket) => {\r\n    if (isIgnorableStreamError(error)) {\r\n      socket.destroy();\r\n      return;\r\n    }\r\n\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    const code =\r\n      error && typeof error === \"object\" && \"code\" in error && typeof error.code === \"string\"\r\n        ? error.code\r\n        : undefined;\r\n\r\n    log.warn(\"ORPC HTTP client error\", { code, message });\r\n\r\n    try {\r\n      socket.end(\"HTTP/1.1 400 Bad Request\\r\\n\\r\\n\");\r\n    } catch {\r\n      socket.destroy();\r\n    }\r\n  });\r\n\r\n  // oRPC WebSocket handler\r\n  const wsServer = new WebSocketServer({ server: httpServer, path: \"/orpc/ws\" });\r\n\r\n  attachStreamErrorHandler(wsServer, \"orpc-ws-server\", { logger: log });\r\n\r\n  // WebSocket heartbeat: proactively terminate half-open connections (common with NAT/proxy setups).\r\n  // When a client is unresponsive, closing the socket forces the browser to reconnect.\r\n  const heartbeatInterval = setInterval(() => {\r\n    for (const ws of wsServer.clients) {\r\n      const socket = ws as AliveWebSocket;\r\n      if (socket.isAlive === false) {\r\n        ws.terminate();\r\n        continue;\r\n      }\r\n\r\n      socket.isAlive = false;\r\n      try {\r\n        ws.ping();\r\n      } catch {\r\n        // Best-effort - ws may already be closing.\r\n      }\r\n    }\r\n  }, WS_HEARTBEAT_INTERVAL_MS);\r\n\r\n  const orpcWsHandler = new ORPCWebSocketServerHandler(orpcRouter, {\r\n    interceptors: [onError(onOrpcError)],\r\n  });\r\n\r\n  wsServer.on(\"connection\", (ws, req) => {\r\n    const terminate = () => {\r\n      try {\r\n        ws.terminate();\r\n      } catch {\r\n        // Best-effort.\r\n      }\r\n    };\r\n\r\n    attachStreamErrorHandler(ws, \"orpc-ws-connection\", {\r\n      logger: log,\r\n      onIgnorable: terminate,\r\n      onUnexpected: terminate,\r\n    });\r\n    const socket = ws as AliveWebSocket;\r\n    socket.isAlive = true;\r\n    ws.on(\"pong\", () => {\r\n      socket.isAlive = true;\r\n    });\r\n\r\n    const headers = extractWsHeaders(req);\r\n    void orpcWsHandler.upgrade(ws, { context: { ...context, headers } });\r\n  });\r\n\r\n  // Start listening\r\n  await new Promise<void>((resolve, reject) => {\r\n    const onListenError = (error: Error) => {\r\n      httpServer.removeListener(\"error\", onListenError);\r\n      reject(error);\r\n    };\r\n\r\n    httpServer.once(\"error\", onListenError);\r\n    httpServer.listen(port, host, () => {\r\n      httpServer.removeListener(\"error\", onListenError);\r\n      resolve();\r\n    });\r\n  });\r\n\r\n  // Get actual port (useful when port=0)\r\n  const address = httpServer.address();\r\n  if (!address || typeof address === \"string\") {\r\n    throw new Error(\"Failed to get server address\");\r\n  }\r\n  const actualPort = address.port;\r\n\r\n  // Wildcard addresses (0.0.0.0, ::) are not routable - convert to loopback for lockfile\r\n  const connectableHost = host === \"0.0.0.0\" || host === \"::\" ? \"127.0.0.1\" : host;\r\n  const connectableHostForUrl = formatHostForUrl(connectableHost);\r\n\r\n  return {\r\n    httpServer,\r\n    wsServer,\r\n    app,\r\n    port: actualPort,\r\n    baseUrl: `http://${connectableHostForUrl}:${actualPort}`,\r\n    wsUrl: `ws://${connectableHostForUrl}:${actualPort}/orpc/ws`,\r\n    specUrl: `http://${connectableHostForUrl}:${actualPort}/api/spec.json`,\r\n    docsUrl: `http://${connectableHostForUrl}:${actualPort}/api/docs`,\r\n    close: async () => {\r\n      clearInterval(heartbeatInterval);\r\n      for (const ws of wsServer.clients) {\r\n        ws.terminate();\r\n      }\r\n\r\n      // Close WebSocket server first\r\n      await new Promise<void>((resolve) => {\r\n        wsServer.close(() => resolve());\r\n      });\r\n      // Then close HTTP server\r\n      httpServer.closeIdleConnections?.();\r\n      httpServer.closeAllConnections?.();\r\n      if (httpServer.listening) {\r\n        await new Promise<void>((resolve, reject) => {\r\n          httpServer.close((err) => (err ? reject(err) : resolve()));\r\n        });\r\n      }\r\n    },\r\n  };\r\n}\r\n"]}