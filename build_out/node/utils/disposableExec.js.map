{"version":3,"file":"disposableExec.js","sourceRoot":"","sources":["../../../src/node/utils/disposableExec.ts"],"names":[],"mappings":"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","sourcesContent":["import { exec, execFileSync } from \"child_process\";\r\nimport type { ChildProcess } from \"child_process\";\r\n\r\nexport function killProcessTree(pid: number): void {\r\n  if (!Number.isFinite(pid) || pid <= 0) {\r\n    return;\r\n  }\r\n\r\n  // process.kill(-pid) is Unix-only; on Windows we must use taskkill to kill the full tree.\r\n  if (process.platform === \"win32\") {\r\n    try {\r\n      execFileSync(\"taskkill\", [\"/PID\", String(pid), \"/T\", \"/F\"], {\r\n        stdio: \"ignore\",\r\n        windowsHide: true,\r\n      });\r\n    } catch {\r\n      // Ignore errors - process may already have exited.\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  // Prefer killing the entire process group. This requires the target process to be a group leader.\r\n  try {\r\n    process.kill(-pid, \"SIGKILL\");\r\n  } catch {\r\n    // Fall back to just the individual process.\r\n    try {\r\n      process.kill(pid, \"SIGKILL\");\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Disposable wrapper for child processes that ensures immediate cleanup.\r\n * Implements TypeScript's explicit resource management (using) for process lifecycle.\r\n *\r\n * All registered cleanup callbacks execute immediately when disposed, either:\r\n * - Explicitly via Symbol.dispose\r\n * - Automatically when exiting a `using` block\r\n * - On process exit\r\n *\r\n * Usage:\r\n *   const process = spawn(\"command\");\r\n *   const disposable = new DisposableProcess(process);\r\n *   disposable.addCleanup(() => stream.destroy());\r\n *   // Cleanup runs automatically on process exit\r\n */\r\nexport class DisposableProcess implements Disposable {\r\n  private cleanupCallbacks: Array<() => void> = [];\r\n  private disposed = false;\r\n\r\n  constructor(private readonly process: ChildProcess) {\r\n    // No auto-cleanup - callers explicitly dispose via timeout/abort handlers\r\n    // Process streams close naturally when process exits\r\n  }\r\n\r\n  /**\r\n   * Register cleanup callback to run when process is disposed.\r\n   * If already disposed, runs immediately.\r\n   */\r\n  addCleanup(callback: () => void): void {\r\n    if (this.disposed) {\r\n      // Already disposed, run immediately\r\n      try {\r\n        callback();\r\n      } catch {\r\n        // Ignore errors during cleanup\r\n      }\r\n    } else {\r\n      this.cleanupCallbacks.push(callback);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the underlying child process\r\n   */\r\n  get underlying(): ChildProcess {\r\n    return this.process;\r\n  }\r\n\r\n  /**\r\n   * Cleanup: kill process + run all cleanup callbacks immediately.\r\n   * Safe to call multiple times (idempotent).\r\n   */\r\n  [Symbol.dispose](): void {\r\n    if (this.disposed) return;\r\n    this.disposed = true;\r\n\r\n    // Kill process if still running\r\n    // Check both exitCode and signalCode to avoid calling kill() on already-dead processes\r\n    // When a process exits via signal (e.g., segfault, kill $$), exitCode is null but signalCode is set\r\n    if (\r\n      !this.process.killed &&\r\n      this.process.exitCode === null &&\r\n      this.process.signalCode === null\r\n    ) {\r\n      // On Windows, childProcess.kill() does not terminate the full process tree.\r\n      // Use taskkill /T to avoid leaking child processes (e.g., spawned by Git Bash).\r\n      const pid = this.process.pid;\r\n      if (pid !== undefined && pid > 0) {\r\n        killProcessTree(pid);\r\n      } else {\r\n        try {\r\n          this.process.kill(\"SIGKILL\");\r\n        } catch {\r\n          // Ignore ESRCH errors - process may have exited between check and kill\r\n        }\r\n      }\r\n    }\r\n\r\n    // Run all cleanup callbacks\r\n    for (const callback of this.cleanupCallbacks) {\r\n      try {\r\n        callback();\r\n      } catch {\r\n        // Ignore cleanup errors - we're tearing down anyway\r\n      }\r\n    }\r\n\r\n    this.cleanupCallbacks = [];\r\n  }\r\n}\r\n\r\n/**\r\n * Disposable wrapper for exec that ensures child process cleanup.\r\n * Prevents zombie processes by killing child when scope exits.\r\n *\r\n * Usage:\r\n *   using proc = execAsync(\"git status\");\r\n *   const { stdout } = await proc.result;\r\n */\r\nclass DisposableExec implements Disposable {\r\n  constructor(\r\n    private readonly promise: Promise<{ stdout: string; stderr: string }>,\r\n    private readonly child: ChildProcess\r\n  ) {}\r\n\r\n  [Symbol.dispose](): void {\r\n    // Only kill if process hasn't exited naturally\r\n    // Check the child's actual exit state, not promise state (avoids async timing issues)\r\n    const hasExited = this.child.exitCode !== null || this.child.signalCode !== null;\r\n    if (!hasExited && !this.child.killed) {\r\n      this.child.kill();\r\n    }\r\n  }\r\n\r\n  get result() {\r\n    return this.promise;\r\n  }\r\n}\r\n\r\n/**\r\n * Options for execAsync.\r\n */\r\nexport interface ExecAsyncOptions {\r\n  /** Shell to use for command execution. If not specified, uses system default (cmd.exe on Windows). */\r\n  shell?: string;\r\n}\r\n\r\n/**\r\n * Execute command with automatic cleanup via `using` declaration.\r\n * Prevents zombie processes by ensuring child is reaped even on error.\r\n *\r\n * @example\r\n * using proc = execAsync(\"git status\");\r\n * const { stdout } = await proc.result;\r\n *\r\n * // With explicit shell (needed for POSIX commands on Windows)\r\n * using proc = execAsync(\"nohup bash -c ...\", { shell: getBashPath() });\r\n */\r\nexport function execAsync(command: string, options?: ExecAsyncOptions): DisposableExec {\r\n  // Child processes inherit process.env automatically, which includes\r\n  // the enriched PATH set by initShellEnv() at startup\r\n  const child = exec(command, { shell: options?.shell });\r\n  const promise = new Promise<{ stdout: string; stderr: string }>((resolve, reject) => {\r\n    let stdout = \"\";\r\n    let stderr = \"\";\r\n    let exitCode: number | null = null;\r\n    let exitSignal: string | null = null;\r\n\r\n    child.stdout?.on(\"data\", (data) => {\r\n      stdout += data;\r\n    });\r\n    child.stderr?.on(\"data\", (data) => {\r\n      stderr += data;\r\n    });\r\n\r\n    // Use 'close' event instead of 'exit' - close fires after all stdio streams are closed\r\n    // This ensures we've received all buffered output before resolving/rejecting\r\n    child.on(\"exit\", (code, signal) => {\r\n      exitCode = code;\r\n      exitSignal = signal;\r\n    });\r\n\r\n    child.on(\"close\", () => {\r\n      // Only resolve if process exited cleanly (code 0, no signal)\r\n      if (exitCode === 0 && exitSignal === null) {\r\n        resolve({ stdout, stderr });\r\n      } else {\r\n        // Include stderr in error message for better debugging\r\n        const errorMsg =\r\n          stderr.trim() ||\r\n          (exitSignal\r\n            ? `Command killed by signal ${exitSignal}`\r\n            : `Command failed with exit code ${exitCode ?? \"unknown\"}`);\r\n        const error = new Error(errorMsg) as Error & {\r\n          code: number | null;\r\n          signal: string | null;\r\n          stdout: string;\r\n          stderr: string;\r\n        };\r\n        error.code = exitCode;\r\n        error.signal = exitSignal;\r\n        error.stdout = stdout;\r\n        error.stderr = stderr;\r\n        reject(error);\r\n      }\r\n    });\r\n\r\n    child.on(\"error\", reject);\r\n  });\r\n\r\n  return new DisposableExec(promise, child);\r\n}\r\n"]}