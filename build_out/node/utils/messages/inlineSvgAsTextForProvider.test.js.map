{"version":3,"file":"inlineSvgAsTextForProvider.test.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/inlineSvgAsTextForProvider.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"@jest/globals\";\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport { inlineSvgAsTextForProvider } from \"./inlineSvgAsTextForProvider\";\r\n\r\ndescribe(\"inlineSvgAsTextForProvider\", () => {\r\n  it(\"replaces base64 SVG file parts with text parts\", () => {\r\n    const svg = '<svg xmlns=\"http://www.w3.org/2000/svg\"><rect width=\"10\" height=\"10\"/></svg>';\r\n    const b64 = Buffer.from(svg, \"utf8\").toString(\"base64\");\r\n\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"user-1\",\r\n        role: \"user\",\r\n        metadata: { timestamp: 1, historySequence: 1 },\r\n        parts: [\r\n          { type: \"text\", text: \"hi\" },\r\n          { type: \"file\", mediaType: \"image/svg+xml\", url: `data:image/svg+xml;base64,${b64}` },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const result = inlineSvgAsTextForProvider(messages);\r\n\r\n    expect(result[0].parts.some((p) => p.type === \"file\")).toBe(false);\r\n\r\n    const textParts = result[0].parts.filter((p) => p.type === \"text\");\r\n    expect(textParts).toHaveLength(2);\r\n    expect(textParts[1].text).toContain(\"```svg\");\r\n    expect(textParts[1].text).toContain(svg);\r\n  });\r\n\r\n  it(\"supports URL-encoded SVG data URLs\", () => {\r\n    const svg = '<svg xmlns=\"http://www.w3.org/2000/svg\"><text>Hello</text></svg>';\r\n    const encoded = encodeURIComponent(svg);\r\n\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"user-2\",\r\n        role: \"user\",\r\n        metadata: { timestamp: 1, historySequence: 1 },\r\n        parts: [\r\n          { type: \"text\", text: \"hi\" },\r\n          { type: \"file\", mediaType: \"image/svg+xml\", url: `data:image/svg+xml,${encoded}` },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const result = inlineSvgAsTextForProvider(messages);\r\n\r\n    const inlined = result[0].parts.filter((p) => p.type === \"text\")[1];\r\n    expect(inlined.text).toContain(svg);\r\n  });\r\n\r\n  it(\"omits SVG when decoded SVG exceeds max bytes\", () => {\r\n    const svg = '<svg xmlns=\"http://www.w3.org/2000/svg\">' + \"a\".repeat(100) + \"</svg>\";\r\n    const b64 = Buffer.from(svg, \"utf8\").toString(\"base64\");\r\n\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"user-3\",\r\n        role: \"user\",\r\n        metadata: { timestamp: 1, historySequence: 1 },\r\n        parts: [\r\n          { type: \"text\", text: \"hi\" },\r\n          { type: \"file\", mediaType: \"image/svg+xml\", url: `data:image/svg+xml;base64,${b64}` },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const result = inlineSvgAsTextForProvider(messages, { maxSvgTextBytes: 10 });\r\n    const inlined = result[0].parts.filter((p) => p.type === \"text\")[1];\r\n\r\n    expect(inlined.text).toContain(\"omitted\");\r\n    expect(inlined.text).toContain(\"too large\");\r\n  });\r\n\r\n  it(\"omits SVG when decoded SVG exceeds max chars\", () => {\r\n    const svg = '<svg xmlns=\"http://www.w3.org/2000/svg\">' + \"a\".repeat(100) + \"</svg>\";\r\n    const b64 = Buffer.from(svg, \"utf8\").toString(\"base64\");\r\n\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"user-3b\",\r\n        role: \"user\",\r\n        metadata: { timestamp: 1, historySequence: 1 },\r\n        parts: [\r\n          { type: \"text\", text: \"hi\" },\r\n          { type: \"file\", mediaType: \"image/svg+xml\", url: `data:image/svg+xml;base64,${b64}` },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const result = inlineSvgAsTextForProvider(messages, { maxSvgTextChars: 10 });\r\n    const inlined = result[0].parts.filter((p) => p.type === \"text\")[1];\r\n\r\n    expect(inlined.text).toContain(\"omitted\");\r\n    expect(inlined.text).toContain(\"too long\");\r\n  });\r\n\r\n  it(\"returns the same array when there are no SVG parts\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"user-4\",\r\n        role: \"user\",\r\n        metadata: { timestamp: 1, historySequence: 1 },\r\n        parts: [{ type: \"text\", text: \"hi\" }],\r\n      },\r\n    ];\r\n\r\n    const result = inlineSvgAsTextForProvider(messages);\r\n    expect(result).toBe(messages);\r\n  });\r\n});\r\n"]}