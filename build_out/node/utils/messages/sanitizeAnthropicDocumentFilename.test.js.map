{"version":3,"file":"sanitizeAnthropicDocumentFilename.test.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/sanitizeAnthropicDocumentFilename.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport {\r\n  sanitizeAnthropicDocumentFilename,\r\n  sanitizeAnthropicPdfFilenames,\r\n} from \"./sanitizeAnthropicDocumentFilename\";\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\n\r\ndescribe(\"sanitizeAnthropicDocumentFilename\", () => {\r\n  it(\"replaces periods with spaces\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(\"file.pdf\")).toBe(\"file pdf\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"report.v2.pdf\")).toBe(\"report v2 pdf\");\r\n  });\r\n\r\n  it(\"preserves allowed characters\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(\"my-file\")).toBe(\"my-file\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"file (1)\")).toBe(\"file (1)\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"file [draft]\")).toBe(\"file [draft]\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"Document 2024\")).toBe(\"Document 2024\");\r\n  });\r\n\r\n  it(\"replaces underscores with spaces\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(\"my_file_name\")).toBe(\"my file name\");\r\n  });\r\n\r\n  it(\"collapses consecutive whitespace\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(\"file...name\")).toBe(\"file name\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"a  b  c\")).toBe(\"a b c\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"file___name\")).toBe(\"file name\");\r\n  });\r\n\r\n  it(\"trims leading and trailing whitespace\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(\".file.\")).toBe(\"file\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"  spaced  \")).toBe(\"spaced\");\r\n  });\r\n\r\n  it(\"returns fallback for undefined input\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(undefined)).toBe(\"Document\");\r\n    expect(sanitizeAnthropicDocumentFilename(undefined, \"PDF\")).toBe(\"PDF\");\r\n  });\r\n\r\n  it(\"returns fallback for empty result after sanitization\", () => {\r\n    expect(sanitizeAnthropicDocumentFilename(\"...\")).toBe(\"Document\");\r\n    expect(sanitizeAnthropicDocumentFilename(\"___\", \"Attachment\")).toBe(\"Attachment\");\r\n  });\r\n\r\n  it(\"handles realistic filenames from the reported issue\", () => {\r\n    // Original filename that triggered the error\r\n    expect(sanitizeAnthropicDocumentFilename(\"D19910350Lj.pdf\")).toBe(\"D19910350Lj pdf\");\r\n  });\r\n});\r\n\r\ndescribe(\"sanitizeAnthropicPdfFilenames\", () => {\r\n  const createUserMessageWithPdf = (filename: string): MuxMessage => ({\r\n    id: \"msg-1\",\r\n    role: \"user\",\r\n    parts: [\r\n      { type: \"text\", text: \"Check this document\" },\r\n      {\r\n        type: \"file\",\r\n        url: \"data:application/pdf;base64,JVBERi0...\",\r\n        mediaType: \"application/pdf\",\r\n        filename,\r\n      },\r\n    ],\r\n  });\r\n\r\n  it(\"sanitizes PDF filenames in user messages\", () => {\r\n    const messages: MuxMessage[] = [createUserMessageWithPdf(\"report.pdf\")];\r\n\r\n    const result = sanitizeAnthropicPdfFilenames(messages);\r\n\r\n    expect(result[0].parts[1]).toEqual({\r\n      type: \"file\",\r\n      url: \"data:application/pdf;base64,JVBERi0...\",\r\n      mediaType: \"application/pdf\",\r\n      filename: \"report pdf\",\r\n    });\r\n  });\r\n\r\n  it(\"does not mutate original messages\", () => {\r\n    const messages: MuxMessage[] = [createUserMessageWithPdf(\"original.pdf\")];\r\n    const originalFilename = (messages[0].parts[1] as { filename: string }).filename;\r\n\r\n    sanitizeAnthropicPdfFilenames(messages);\r\n\r\n    expect((messages[0].parts[1] as { filename: string }).filename).toBe(originalFilename);\r\n  });\r\n\r\n  it(\"passes through assistant messages unchanged\", () => {\r\n    const assistantMessage: MuxMessage = {\r\n      id: \"msg-2\",\r\n      role: \"assistant\",\r\n      parts: [{ type: \"text\", text: \"Response\" }],\r\n    };\r\n\r\n    const result = sanitizeAnthropicPdfFilenames([assistantMessage]);\r\n\r\n    expect(result).toHaveLength(1);\r\n    expect(result[0]).toBe(assistantMessage); // Same reference\r\n  });\r\n\r\n  it(\"does not sanitize non-PDF files\", () => {\r\n    const imageMessage: MuxMessage = {\r\n      id: \"msg-3\",\r\n      role: \"user\",\r\n      parts: [\r\n        {\r\n          type: \"file\",\r\n          url: \"data:image/png;base64,...\",\r\n          mediaType: \"image/png\",\r\n          filename: \"screenshot.png\",\r\n        },\r\n      ],\r\n    };\r\n\r\n    const result = sanitizeAnthropicPdfFilenames([imageMessage]);\r\n\r\n    expect(result[0]).toBe(imageMessage); // Same reference - no change\r\n  });\r\n\r\n  it(\"handles case-insensitive media type matching\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"msg-4\",\r\n        role: \"user\",\r\n        parts: [\r\n          {\r\n            type: \"file\",\r\n            url: \"data:application/pdf;base64,...\",\r\n            mediaType: \"APPLICATION/PDF\", // uppercase\r\n            filename: \"test.pdf\",\r\n          },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const result = sanitizeAnthropicPdfFilenames(messages);\r\n\r\n    expect((result[0].parts[0] as { filename: string }).filename).toBe(\"test pdf\");\r\n  });\r\n\r\n  it(\"returns original array if no changes needed\", () => {\r\n    const messages: MuxMessage[] = [\r\n      {\r\n        id: \"msg-5\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"No attachments here\" }],\r\n      },\r\n    ];\r\n\r\n    const result = sanitizeAnthropicPdfFilenames(messages);\r\n\r\n    expect(result).toBe(messages); // Same array reference\r\n  });\r\n});\r\n"]}