{"version":3,"file":"legacy.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/legacy.ts"],"names":[],"mappings":";;;AAOA;;;;;;GAMG;AACH,oCAA2C,OAAmB,EAAc;IAC1E,MAAM,QAAQ,GAAG,OAAO,CAAC,QAAyC,CAAC;IACnE,IAAI,CAAC,QAAQ;QAAE,OAAO,OAAO,CAAC;IAE9B,IAAI,UAAU,GAAgB,EAAE,GAAG,QAAQ,EAAE,CAAC;IAC9C,IAAI,OAAO,GAAG,KAAK,CAAC;IAEpB,uCAAqC;IACrC,IAAI,QAAQ,CAAC,YAAY,KAAK,SAAS,EAAE,CAAC;QACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,EAAE,GAAG,UAA+B,CAAC;QAClE,UAAU,GAAG,IAAI,CAAC;QAClB,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;YAC1B,UAAU,CAAC,WAAW,GAAG,YAAY,CAAC;QACxC,CAAC;QACD,OAAO,GAAG,IAAI,CAAC;IACjB,CAAC;IAED,oDAAkD;IAClD,IAAI,QAAQ,CAAC,aAAa,KAAK,IAAI,EAAE,CAAC;QACpC,MAAM,EAAE,aAAa,EAAE,GAAG,IAAI,EAAE,GAAG,UAA+B,CAAC;QACnE,UAAU,GAAG,EAAE,GAAG,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,CAAC;QAC5C,OAAO,GAAG,IAAI,CAAC;IACjB,CAAC;IAED,OAAO,OAAO,CAAC,CAAC,CAAC,EAAE,GAAG,OAAO,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC;AAAA,CACjE","sourcesContent":["import type { MuxFrontendMetadata, MuxMessage, MuxMetadata } from \"@/common/types/message\";\r\n\r\ninterface LegacyMuxMetadata extends MuxMetadata {\r\n  cmuxMetadata?: MuxFrontendMetadata;\r\n  idleCompacted?: boolean;\r\n}\r\n\r\n/**\r\n * Normalize persisted messages from older builds.\r\n *\r\n * Migrations:\r\n * - `cmuxMetadata` → `muxMetadata` (mux rename)\r\n * - `{ compacted: true, idleCompacted: true }` → `{ compacted: \"idle\" }`\r\n */\r\nexport function normalizeLegacyMuxMetadata(message: MuxMessage): MuxMessage {\r\n  const metadata = message.metadata as LegacyMuxMetadata | undefined;\r\n  if (!metadata) return message;\r\n\r\n  let normalized: MuxMetadata = { ...metadata };\r\n  let changed = false;\r\n\r\n  // Migrate cmuxMetadata → muxMetadata\r\n  if (metadata.cmuxMetadata !== undefined) {\r\n    const { cmuxMetadata, ...rest } = normalized as LegacyMuxMetadata;\r\n    normalized = rest;\r\n    if (!metadata.muxMetadata) {\r\n      normalized.muxMetadata = cmuxMetadata;\r\n    }\r\n    changed = true;\r\n  }\r\n\r\n  // Migrate idleCompacted: true → compacted: \"idle\"\r\n  if (metadata.idleCompacted === true) {\r\n    const { idleCompacted, ...rest } = normalized as LegacyMuxMetadata;\r\n    normalized = { ...rest, compacted: \"idle\" };\r\n    changed = true;\r\n  }\r\n\r\n  return changed ? { ...message, metadata: normalized } : message;\r\n}\r\n"]}