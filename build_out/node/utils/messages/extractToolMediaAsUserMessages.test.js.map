{"version":3,"file":"extractToolMediaAsUserMessages.test.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/extractToolMediaAsUserMessages.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"@jest/globals\";\nimport type { MuxMessage } from \"@/common/types/message\";\nimport { extractToolMediaAsUserMessages } from \"./extractToolMediaAsUserMessages\";\n\ndescribe(\"extractToolMediaAsUserMessages\", () => {\n  it(\"moves base64 media out of tool output and into a synthetic user file part\", () => {\n    const base64 = \"A\".repeat(50_000);\n\n    const input: MuxMessage[] = [\n      {\n        id: \"a1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"call1\",\n            toolName: \"mcp_chrome_devtools_screenshot\",\n            input: { tabId: 1 },\n            state: \"output-available\",\n            output: {\n              type: \"content\",\n              value: [{ type: \"media\", mediaType: \"image/png\", data: base64 }],\n            },\n          },\n        ],\n        metadata: { timestamp: 1 },\n      },\n    ];\n\n    const rewritten = extractToolMediaAsUserMessages(input);\n    expect(rewritten).toHaveLength(2);\n\n    const rewrittenAssistant = rewritten[0];\n    expect(rewrittenAssistant.role).toBe(\"assistant\");\n\n    const toolPart = rewrittenAssistant.parts[0];\n    expect(toolPart.type).toBe(\"dynamic-tool\");\n    if (toolPart.type === \"dynamic-tool\" && toolPart.state === \"output-available\") {\n      const outputText = JSON.stringify(toolPart.output);\n      expect(outputText).toContain(\"[Image attached:\");\n      expect(outputText).not.toMatch(/[A]{1000,}/);\n    }\n\n    const syntheticUser = rewritten[1];\n    expect(syntheticUser.role).toBe(\"user\");\n    expect(syntheticUser.metadata?.synthetic).toBe(true);\n\n    const filePart = syntheticUser.parts.find((p) => p.type === \"file\");\n    expect(filePart).toBeDefined();\n    if (filePart?.type === \"file\") {\n      expect(filePart.mediaType).toBe(\"image/png\");\n      expect(filePart.url.startsWith(\"data:image/png;base64,\")).toBe(true);\n      // Full base64 is expected in the file url, but NOT in tool output JSON.\n      expect(filePart.url).toContain(base64.slice(0, 100));\n    }\n  });\n\n  it(\"is a no-op when tool outputs have no media\", () => {\n    const input: MuxMessage[] = [\n      {\n        id: \"a1\",\n        role: \"assistant\",\n        parts: [\n          {\n            type: \"dynamic-tool\",\n            toolCallId: \"call1\",\n            toolName: \"bash\",\n            input: { script: \"pwd\" },\n            state: \"output-available\",\n            output: { type: \"json\", value: { stdout: \"/tmp\" } },\n          },\n        ],\n        metadata: { timestamp: 1 },\n      },\n    ];\n\n    const rewritten = extractToolMediaAsUserMessages(input);\n    expect(rewritten).toEqual(input);\n  });\n});\n"]}