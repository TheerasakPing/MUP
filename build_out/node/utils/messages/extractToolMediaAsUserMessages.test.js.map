{"version":3,"file":"extractToolMediaAsUserMessages.test.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/extractToolMediaAsUserMessages.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"@jest/globals\";\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport { extractToolMediaAsUserMessages } from \"./extractToolMediaAsUserMessages\";\r\n\r\ndescribe(\"extractToolMediaAsUserMessages\", () => {\r\n  it(\"moves base64 media out of tool output and into a synthetic user file part\", () => {\r\n    const base64 = \"A\".repeat(50_000);\r\n\r\n    const input: MuxMessage[] = [\r\n      {\r\n        id: \"a1\",\r\n        role: \"assistant\",\r\n        parts: [\r\n          {\r\n            type: \"dynamic-tool\",\r\n            toolCallId: \"call1\",\r\n            toolName: \"mcp_chrome_devtools_screenshot\",\r\n            input: { tabId: 1 },\r\n            state: \"output-available\",\r\n            output: {\r\n              type: \"content\",\r\n              value: [{ type: \"media\", mediaType: \"image/png\", data: base64 }],\r\n            },\r\n          },\r\n        ],\r\n        metadata: { timestamp: 1 },\r\n      },\r\n    ];\r\n\r\n    const rewritten = extractToolMediaAsUserMessages(input);\r\n    expect(rewritten).toHaveLength(2);\r\n\r\n    const rewrittenAssistant = rewritten[0];\r\n    expect(rewrittenAssistant.role).toBe(\"assistant\");\r\n\r\n    const toolPart = rewrittenAssistant.parts[0];\r\n    expect(toolPart.type).toBe(\"dynamic-tool\");\r\n    if (toolPart.type === \"dynamic-tool\" && toolPart.state === \"output-available\") {\r\n      const outputText = JSON.stringify(toolPart.output);\r\n      expect(outputText).toContain(\"[Image attached:\");\r\n      expect(outputText).not.toMatch(/[A]{1000,}/);\r\n    }\r\n\r\n    const syntheticUser = rewritten[1];\r\n    expect(syntheticUser.role).toBe(\"user\");\r\n    expect(syntheticUser.metadata?.synthetic).toBe(true);\r\n\r\n    const filePart = syntheticUser.parts.find((p) => p.type === \"file\");\r\n    expect(filePart).toBeDefined();\r\n    if (filePart?.type === \"file\") {\r\n      expect(filePart.mediaType).toBe(\"image/png\");\r\n      expect(filePart.url.startsWith(\"data:image/png;base64,\")).toBe(true);\r\n      // Full base64 is expected in the file url, but NOT in tool output JSON.\r\n      expect(filePart.url).toContain(base64.slice(0, 100));\r\n    }\r\n  });\r\n\r\n  it(\"is a no-op when tool outputs have no media\", () => {\r\n    const input: MuxMessage[] = [\r\n      {\r\n        id: \"a1\",\r\n        role: \"assistant\",\r\n        parts: [\r\n          {\r\n            type: \"dynamic-tool\",\r\n            toolCallId: \"call1\",\r\n            toolName: \"bash\",\r\n            input: { script: \"pwd\" },\r\n            state: \"output-available\",\r\n            output: { type: \"json\", value: { stdout: \"/tmp\" } },\r\n          },\r\n        ],\r\n        metadata: { timestamp: 1 },\r\n      },\r\n    ];\r\n\r\n    const rewritten = extractToolMediaAsUserMessages(input);\r\n    expect(rewritten).toEqual(input);\r\n  });\r\n});\r\n"]}