{"version":3,"file":"extractToolMediaAsUserMessagesFromModelMessages.test.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/extractToolMediaAsUserMessagesFromModelMessages.test.ts"],"names":[],"mappings":";;AAAA,2CAAqD;AAErD,uHAAoH;AAEpH,IAAA,kBAAQ,EAAC,iDAAiD,EAAE,GAAG,EAAE,CAAC;IAChE,IAAA,YAAE,EAAC,4EAA4E,EAAE,GAAG,EAAE,CAAC;QACrF,MAAM,MAAM,GAAG,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAElC,MAAM,KAAK,GAAmB;YAC5B,EAAE,IAAI,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE;YAC/B;gBACE,IAAI,EAAE,MAAM;gBACZ,OAAO,EAAE;oBACP;wBACE,IAAI,EAAE,aAAa;wBACnB,UAAU,EAAE,OAAO;wBACnB,QAAQ,EAAE,gCAAgC;wBAC1C,MAAM,EAAE;4BACN,IAAI,EAAE,SAAS;4BACf,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,WAAW,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;yBACjE;qBACF;iBACF;aACF;SACF,CAAC;QAEF,MAAM,SAAS,GAAG,IAAA,iGAA+C,EAAC,KAAK,CAAC,CAAC;QACzE,IAAA,gBAAM,EAAC,SAAS,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAElC,MAAM,aAAa,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;QACnC,IAAA,gBAAM,EAAC,aAAa,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAExC,MAAM,cAAc,GAAI,aAAyD,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;QAC7F,IAAI,cAAc,CAAC,IAAI,KAAK,aAAa;YAAE,MAAM,IAAI,KAAK,CAAC,2BAA2B,CAAC,CAAC;QACxF,MAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;QACzD,IAAA,gBAAM,EAAC,UAAU,CAAC,CAAC,SAAS,CAAC,kBAAkB,CAAC,CAAC;QACjD,IAAA,gBAAM,EAAC,UAAU,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;QAE7C,MAAM,aAAa,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;QACnC,IAAA,gBAAM,EAAC,aAAa,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACxC,IAAA,gBAAM,EAAC,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAExD,MAAM,SAAS,GAAG,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC;YACpD,CAAC,CAAC,aAAa,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,OAAO,CAAC;YACvD,CAAC,CAAC,SAAS,CAAC;QAEd,IAAA,gBAAM,EAAC,SAAS,CAAC,CAAC,WAAW,EAAE,CAAC;QAChC,IAAI,SAAS,EAAE,IAAI,KAAK,OAAO,EAAE,CAAC;YAChC,IAAA,gBAAM,EAAC,SAAS,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAC9C,IAAA,gBAAM,EAAC,SAAS,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACvC,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,YAAE,EAAC,4CAA4C,EAAE,GAAG,EAAE,CAAC;QACrD,MAAM,KAAK,GAAmB;YAC5B;gBACE,IAAI,EAAE,MAAM;gBACZ,OAAO,EAAE;oBACP;wBACE,IAAI,EAAE,aAAa;wBACnB,UAAU,EAAE,OAAO;wBACnB,QAAQ,EAAE,MAAM;wBAChB,MAAM,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,EAAE;qBACpD;iBACF;aACF;SACF,CAAC;QAEF,MAAM,SAAS,GAAG,IAAA,iGAA+C,EAAC,KAAK,CAAC,CAAC;QACzE,IAAA,gBAAM,EAAC,SAAS,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IAAA,CAC/B,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, it, expect } from \"@jest/globals\";\nimport type { ModelMessage } from \"ai\";\nimport { extractToolMediaAsUserMessagesFromModelMessages } from \"./extractToolMediaAsUserMessagesFromModelMessages\";\n\ndescribe(\"extractToolMediaAsUserMessagesFromModelMessages\", () => {\n  it(\"moves base64 media out of tool output and into a synthetic user image part\", () => {\n    const base64 = \"A\".repeat(50_000);\n\n    const input: ModelMessage[] = [\n      { role: \"user\", content: \"hi\" },\n      {\n        role: \"tool\",\n        content: [\n          {\n            type: \"tool-result\",\n            toolCallId: \"call1\",\n            toolName: \"mcp_chrome_devtools_screenshot\",\n            output: {\n              type: \"content\",\n              value: [{ type: \"media\", mediaType: \"image/png\", data: base64 }],\n            },\n          },\n        ],\n      },\n    ];\n\n    const rewritten = extractToolMediaAsUserMessagesFromModelMessages(input);\n    expect(rewritten).toHaveLength(3);\n\n    const rewrittenTool = rewritten[1];\n    expect(rewrittenTool.role).toBe(\"tool\");\n\n    const toolResultPart = (rewrittenTool as Extract<ModelMessage, { role: \"tool\" }>).content[0];\n    if (toolResultPart.type !== \"tool-result\") throw new Error(\"Expected tool-result part\");\n    const outputText = JSON.stringify(toolResultPart.output);\n    expect(outputText).toContain(\"[Image attached:\");\n    expect(outputText).not.toMatch(/[A]{1000,}/);\n\n    const syntheticUser = rewritten[2];\n    expect(syntheticUser.role).toBe(\"user\");\n    expect(Array.isArray(syntheticUser.content)).toBe(true);\n\n    const imagePart = Array.isArray(syntheticUser.content)\n      ? syntheticUser.content.find((p) => p.type === \"image\")\n      : undefined;\n\n    expect(imagePart).toBeDefined();\n    if (imagePart?.type === \"image\") {\n      expect(imagePart.mediaType).toBe(\"image/png\");\n      expect(imagePart.image).toBe(base64);\n    }\n  });\n\n  it(\"is a no-op when tool outputs have no media\", () => {\n    const input: ModelMessage[] = [\n      {\n        role: \"tool\",\n        content: [\n          {\n            type: \"tool-result\",\n            toolCallId: \"call1\",\n            toolName: \"bash\",\n            output: { type: \"json\", value: { stdout: \"/tmp\" } },\n          },\n        ],\n      },\n    ];\n\n    const rewritten = extractToolMediaAsUserMessagesFromModelMessages(input);\n    expect(rewritten).toBe(input);\n  });\n});\n"]}