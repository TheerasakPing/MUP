{"version":3,"file":"sanitizeAnthropicDocumentFilename.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/sanitizeAnthropicDocumentFilename.ts"],"names":[],"mappings":";;;;AAEA,MAAM,cAAc,GAAG,iBAAiB,CAAC;AAEzC;;;;;;;;;;;GAWG;AACH,2CACE,QAA4B,EAC5B,QAAQ,GAAG,UAAU,EACb;IACR,IAAI,CAAC,QAAQ,EAAE,CAAC;QACd,OAAO,QAAQ,CAAC;IAClB,CAAC;IAED,2CAA2C;IAC3C,gFAAgF;IAChF,MAAM,SAAS,GAAG,QAAQ,CAAC,OAAO,CAAC,wBAAwB,EAAE,GAAG,CAAC,CAAC;IAElE,2DAA2D;IAC3D,MAAM,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,IAAI,EAAE,CAAC;IAExD,8CAA8C;IAC9C,OAAO,SAAS,IAAI,QAAQ,CAAC;AAAA,CAC9B;AAED;;;;;;;;;;;;;GAaG;AACH,uCAA8C,QAAsB,EAAgB;IAClF,IAAI,SAAS,GAAG,KAAK,CAAC;IAEtB,MAAM,MAAM,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;QACnC,IAAI,GAAG,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;YACxB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,uCAAuC;QACvC,MAAM,kBAAkB,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,CACvC,CAAC,IAAI,EAAE,EAAE,CACP,IAAI,CAAC,IAAI,KAAK,MAAM;YACpB,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,KAAK,cAAc;YAC/C,IAAI,CAAC,QAAQ,KAAK,SAAS,CAC9B,CAAC;QAEF,IAAI,CAAC,kBAAkB,EAAE,CAAC;YACxB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,SAAS,GAAG,IAAI,CAAC;QAEjB,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC;YACvC,IACE,IAAI,CAAC,IAAI,KAAK,MAAM;gBACpB,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,KAAK,cAAc;gBAC/C,IAAI,CAAC,QAAQ,KAAK,SAAS,EAC3B,CAAC;gBACD,OAAO;oBACL,GAAG,IAAI;oBACP,QAAQ,EAAE,iCAAiC,CAAC,IAAI,CAAC,QAAQ,CAAC;iBAC3D,CAAC;YACJ,CAAC;YACD,OAAO,IAAI,CAAC;QAAA,CACb,CAAC,CAAC;QAEH,OAAO;YACL,GAAG,GAAG;YACN,KAAK,EAAE,QAAQ;SAChB,CAAC;IAAA,CACH,CAAC,CAAC;IAEH,0DAA0D;IAC1D,OAAO,SAAS,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,CAAC;AAAA,CACtC","sourcesContent":["import type { MuxMessage } from \"@/common/types/message\";\r\n\r\nconst PDF_MEDIA_TYPE = \"application/pdf\";\r\n\r\n/**\r\n * Sanitize a document filename to comply with Anthropic's validation rules.\r\n *\r\n * Anthropic enforces strict character set validation on document block metadata:\r\n * - Allowed: alphanumeric, whitespace, hyphen (-), parentheses, square brackets\r\n * - Disallowed: periods (.), underscores (_), slashes, etc.\r\n * - No consecutive whitespace allowed\r\n *\r\n * @param filename - Original filename (e.g., \"D19910350Lj.pdf\")\r\n * @param fallback - Fallback if result would be empty (default: \"Document\")\r\n * @returns Sanitized filename (e.g., \"D19910350Lj [pdf]\")\r\n */\r\nexport function sanitizeAnthropicDocumentFilename(\r\n  filename: string | undefined,\r\n  fallback = \"Document\"\r\n): string {\r\n  if (!filename) {\r\n    return fallback;\r\n  }\r\n\r\n  // Replace disallowed characters with space\r\n  // Allowed: alphanumeric, whitespace, hyphen, parentheses (), square brackets []\r\n  const sanitized = filename.replace(/[^a-zA-Z0-9\\s\\-()[\\]]/g, \" \");\r\n\r\n  // Collapse consecutive whitespace to single space and trim\r\n  const collapsed = sanitized.replace(/\\s+/g, \" \").trim();\r\n\r\n  // Return fallback if empty after sanitization\r\n  return collapsed || fallback;\r\n}\r\n\r\n/**\r\n * Sanitize PDF document filenames in user messages for Anthropic API requests.\r\n *\r\n * This is a request-only transformation - the original filenames are preserved in\r\n * persisted history and the UI. Only the outgoing API request gets sanitized names.\r\n *\r\n * Why: Anthropic validates document \"file name/title\" with a strict character set that\r\n * rejects common filename characters like periods (.). This causes uploads to fail with:\r\n * \"The document file name can only contain alphanumeric characters, whitespace characters,\r\n * hyphens, parentheses, and square brackets.\"\r\n *\r\n * @param messages - MuxMessage array to process\r\n * @returns New array with sanitized PDF filenames (does not mutate input)\r\n */\r\nexport function sanitizeAnthropicPdfFilenames(messages: MuxMessage[]): MuxMessage[] {\r\n  let didChange = false;\r\n\r\n  const result = messages.map((msg) => {\r\n    if (msg.role !== \"user\") {\r\n      return msg;\r\n    }\r\n\r\n    // Check if any part needs sanitization\r\n    const hasPdfWithFilename = msg.parts.some(\r\n      (part) =>\r\n        part.type === \"file\" &&\r\n        part.mediaType.toLowerCase() === PDF_MEDIA_TYPE &&\r\n        part.filename !== undefined\r\n    );\r\n\r\n    if (!hasPdfWithFilename) {\r\n      return msg;\r\n    }\r\n\r\n    didChange = true;\r\n\r\n    const newParts = msg.parts.map((part) => {\r\n      if (\r\n        part.type === \"file\" &&\r\n        part.mediaType.toLowerCase() === PDF_MEDIA_TYPE &&\r\n        part.filename !== undefined\r\n      ) {\r\n        return {\r\n          ...part,\r\n          filename: sanitizeAnthropicDocumentFilename(part.filename),\r\n        };\r\n      }\r\n      return part;\r\n    });\r\n\r\n    return {\r\n      ...msg,\r\n      parts: newParts,\r\n    };\r\n  });\r\n\r\n  // Return original array if nothing changed (optimization)\r\n  return didChange ? result : messages;\r\n}\r\n"]}