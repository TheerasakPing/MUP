{"version":3,"file":"sanitizeAnthropicDocumentFilename.js","sourceRoot":"","sources":["../../../../src/node/utils/messages/sanitizeAnthropicDocumentFilename.ts"],"names":[],"mappings":";;;;AAEA,MAAM,cAAc,GAAG,iBAAiB,CAAC;AAEzC;;;;;;;;;;;GAWG;AACH,2CACE,QAA4B,EAC5B,QAAQ,GAAG,UAAU,EACb;IACR,IAAI,CAAC,QAAQ,EAAE,CAAC;QACd,OAAO,QAAQ,CAAC;IAClB,CAAC;IAED,2CAA2C;IAC3C,gFAAgF;IAChF,MAAM,SAAS,GAAG,QAAQ,CAAC,OAAO,CAAC,wBAAwB,EAAE,GAAG,CAAC,CAAC;IAElE,2DAA2D;IAC3D,MAAM,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,IAAI,EAAE,CAAC;IAExD,8CAA8C;IAC9C,OAAO,SAAS,IAAI,QAAQ,CAAC;AAAA,CAC9B;AAED;;;;;;;;;;;;;GAaG;AACH,uCAA8C,QAAsB,EAAgB;IAClF,IAAI,SAAS,GAAG,KAAK,CAAC;IAEtB,MAAM,MAAM,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;QACnC,IAAI,GAAG,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;YACxB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,uCAAuC;QACvC,MAAM,kBAAkB,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,CACvC,CAAC,IAAI,EAAE,EAAE,CACP,IAAI,CAAC,IAAI,KAAK,MAAM;YACpB,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,KAAK,cAAc;YAC/C,IAAI,CAAC,QAAQ,KAAK,SAAS,CAC9B,CAAC;QAEF,IAAI,CAAC,kBAAkB,EAAE,CAAC;YACxB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,SAAS,GAAG,IAAI,CAAC;QAEjB,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC;YACvC,IACE,IAAI,CAAC,IAAI,KAAK,MAAM;gBACpB,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,KAAK,cAAc;gBAC/C,IAAI,CAAC,QAAQ,KAAK,SAAS,EAC3B,CAAC;gBACD,OAAO;oBACL,GAAG,IAAI;oBACP,QAAQ,EAAE,iCAAiC,CAAC,IAAI,CAAC,QAAQ,CAAC;iBAC3D,CAAC;YACJ,CAAC;YACD,OAAO,IAAI,CAAC;QAAA,CACb,CAAC,CAAC;QAEH,OAAO;YACL,GAAG,GAAG;YACN,KAAK,EAAE,QAAQ;SAChB,CAAC;IAAA,CACH,CAAC,CAAC;IAEH,0DAA0D;IAC1D,OAAO,SAAS,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,CAAC;AAAA,CACtC","sourcesContent":["import type { MuxMessage } from \"@/common/types/message\";\n\nconst PDF_MEDIA_TYPE = \"application/pdf\";\n\n/**\n * Sanitize a document filename to comply with Anthropic's validation rules.\n *\n * Anthropic enforces strict character set validation on document block metadata:\n * - Allowed: alphanumeric, whitespace, hyphen (-), parentheses, square brackets\n * - Disallowed: periods (.), underscores (_), slashes, etc.\n * - No consecutive whitespace allowed\n *\n * @param filename - Original filename (e.g., \"D19910350Lj.pdf\")\n * @param fallback - Fallback if result would be empty (default: \"Document\")\n * @returns Sanitized filename (e.g., \"D19910350Lj [pdf]\")\n */\nexport function sanitizeAnthropicDocumentFilename(\n  filename: string | undefined,\n  fallback = \"Document\"\n): string {\n  if (!filename) {\n    return fallback;\n  }\n\n  // Replace disallowed characters with space\n  // Allowed: alphanumeric, whitespace, hyphen, parentheses (), square brackets []\n  const sanitized = filename.replace(/[^a-zA-Z0-9\\s\\-()[\\]]/g, \" \");\n\n  // Collapse consecutive whitespace to single space and trim\n  const collapsed = sanitized.replace(/\\s+/g, \" \").trim();\n\n  // Return fallback if empty after sanitization\n  return collapsed || fallback;\n}\n\n/**\n * Sanitize PDF document filenames in user messages for Anthropic API requests.\n *\n * This is a request-only transformation - the original filenames are preserved in\n * persisted history and the UI. Only the outgoing API request gets sanitized names.\n *\n * Why: Anthropic validates document \"file name/title\" with a strict character set that\n * rejects common filename characters like periods (.). This causes uploads to fail with:\n * \"The document file name can only contain alphanumeric characters, whitespace characters,\n * hyphens, parentheses, and square brackets.\"\n *\n * @param messages - MuxMessage array to process\n * @returns New array with sanitized PDF filenames (does not mutate input)\n */\nexport function sanitizeAnthropicPdfFilenames(messages: MuxMessage[]): MuxMessage[] {\n  let didChange = false;\n\n  const result = messages.map((msg) => {\n    if (msg.role !== \"user\") {\n      return msg;\n    }\n\n    // Check if any part needs sanitization\n    const hasPdfWithFilename = msg.parts.some(\n      (part) =>\n        part.type === \"file\" &&\n        part.mediaType.toLowerCase() === PDF_MEDIA_TYPE &&\n        part.filename !== undefined\n    );\n\n    if (!hasPdfWithFilename) {\n      return msg;\n    }\n\n    didChange = true;\n\n    const newParts = msg.parts.map((part) => {\n      if (\n        part.type === \"file\" &&\n        part.mediaType.toLowerCase() === PDF_MEDIA_TYPE &&\n        part.filename !== undefined\n      ) {\n        return {\n          ...part,\n          filename: sanitizeAnthropicDocumentFilename(part.filename),\n        };\n      }\n      return part;\n    });\n\n    return {\n      ...msg,\n      parts: newParts,\n    };\n  });\n\n  // Return original array if nothing changed (optimization)\n  return didChange ? result : messages;\n}\n"]}