{"version":3,"file":"codexOauthAuth.test.js","sourceRoot":"","sources":["../../../src/node/utils/codexOauthAuth.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\n\nimport {\n  parseCodexOauthAuth,\n  isCodexOauthAuthExpired,\n  parseJwtClaims,\n  extractAccountIdFromClaims,\n  extractAccountIdFromToken,\n  extractAccountIdFromTokens,\n} from \"./codexOauthAuth\";\n\n// ---------------------------------------------------------------------------\n// Helpers\n// ---------------------------------------------------------------------------\n\n/** Encode a claims object into a fake JWT (header.payload.signature). */\nfunction fakeJwt(claims: Record<string, unknown>): string {\n  const header = Buffer.from(JSON.stringify({ alg: \"none\" })).toString(\"base64url\");\n  const payload = Buffer.from(JSON.stringify(claims)).toString(\"base64url\");\n  return `${header}.${payload}.fakesig`;\n}\n\n// ---------------------------------------------------------------------------\n// parseCodexOauthAuth\n// ---------------------------------------------------------------------------\n\ndescribe(\"parseCodexOauthAuth\", () => {\n  it(\"accepts a valid object with all required fields\", () => {\n    const input = {\n      type: \"oauth\" as const,\n      access: \"at_123\",\n      refresh: \"rt_456\",\n      expires: Date.now() + 60_000,\n    };\n    const result = parseCodexOauthAuth(input);\n    expect(result).toEqual(input);\n  });\n\n  it(\"accepts a valid object with optional accountId\", () => {\n    const input = {\n      type: \"oauth\" as const,\n      access: \"at_123\",\n      refresh: \"rt_456\",\n      expires: Date.now() + 60_000,\n      accountId: \"acct_abc\",\n    };\n    const result = parseCodexOauthAuth(input);\n    expect(result).toEqual(input);\n  });\n\n  it(\"returns null for non-object values\", () => {\n    expect(parseCodexOauthAuth(null)).toBeNull();\n    expect(parseCodexOauthAuth(undefined)).toBeNull();\n    expect(parseCodexOauthAuth(\"string\")).toBeNull();\n    expect(parseCodexOauthAuth(42)).toBeNull();\n    expect(parseCodexOauthAuth([])).toBeNull();\n  });\n\n  it(\"returns null when type is not 'oauth'\", () => {\n    expect(\n      parseCodexOauthAuth({ type: \"api-key\", access: \"a\", refresh: \"r\", expires: 123 })\n    ).toBeNull();\n  });\n\n  it(\"returns null when access is missing or empty\", () => {\n    expect(\n      parseCodexOauthAuth({ type: \"oauth\", access: \"\", refresh: \"r\", expires: 123 })\n    ).toBeNull();\n    expect(parseCodexOauthAuth({ type: \"oauth\", refresh: \"r\", expires: 123 })).toBeNull();\n  });\n\n  it(\"returns null when refresh is missing or empty\", () => {\n    expect(\n      parseCodexOauthAuth({ type: \"oauth\", access: \"a\", refresh: \"\", expires: 123 })\n    ).toBeNull();\n  });\n\n  it(\"returns null when expires is not a finite number\", () => {\n    expect(\n      parseCodexOauthAuth({ type: \"oauth\", access: \"a\", refresh: \"r\", expires: NaN })\n    ).toBeNull();\n    expect(\n      parseCodexOauthAuth({ type: \"oauth\", access: \"a\", refresh: \"r\", expires: Infinity })\n    ).toBeNull();\n    expect(\n      parseCodexOauthAuth({ type: \"oauth\", access: \"a\", refresh: \"r\", expires: \"soon\" })\n    ).toBeNull();\n  });\n\n  it(\"returns null when accountId is present but empty string\", () => {\n    expect(\n      parseCodexOauthAuth({\n        type: \"oauth\",\n        access: \"a\",\n        refresh: \"r\",\n        expires: 123,\n        accountId: \"\",\n      })\n    ).toBeNull();\n  });\n});\n\n// ---------------------------------------------------------------------------\n// isCodexOauthAuthExpired\n// ---------------------------------------------------------------------------\n\ndescribe(\"isCodexOauthAuthExpired\", () => {\n  const base = { type: \"oauth\" as const, access: \"a\", refresh: \"r\" };\n\n  it(\"returns false when token is not yet expired (with default skew)\", () => {\n    // Token expires 60s from now, default skew is 30s → not expired\n    const auth = { ...base, expires: Date.now() + 60_000 };\n    expect(isCodexOauthAuthExpired(auth)).toBe(false);\n  });\n\n  it(\"returns true when token is within the skew window\", () => {\n    // Token expires in 20s, default skew 30s → expired\n    const now = Date.now();\n    const auth = { ...base, expires: now + 20_000 };\n    expect(isCodexOauthAuthExpired(auth, { nowMs: now })).toBe(true);\n  });\n\n  it(\"returns true when token is already past expiry\", () => {\n    const auth = { ...base, expires: Date.now() - 1000 };\n    expect(isCodexOauthAuthExpired(auth)).toBe(true);\n  });\n\n  it(\"respects custom skew\", () => {\n    const now = 1_000_000;\n    const auth = { ...base, expires: now + 5_000 };\n    // With 0 skew, not expired\n    expect(isCodexOauthAuthExpired(auth, { nowMs: now, skewMs: 0 })).toBe(false);\n    // With 10s skew, expired\n    expect(isCodexOauthAuthExpired(auth, { nowMs: now, skewMs: 10_000 })).toBe(true);\n  });\n});\n\n// ---------------------------------------------------------------------------\n// parseJwtClaims\n// ---------------------------------------------------------------------------\n\ndescribe(\"parseJwtClaims\", () => {\n  it(\"decodes a valid JWT payload\", () => {\n    const claims = { sub: \"user_123\", iss: \"https://auth.openai.com\" };\n    const token = fakeJwt(claims);\n    expect(parseJwtClaims(token)).toEqual(claims);\n  });\n\n  it(\"returns null for tokens with wrong number of parts\", () => {\n    expect(parseJwtClaims(\"\")).toBeNull();\n    expect(parseJwtClaims(\"one.two\")).toBeNull();\n    expect(parseJwtClaims(\"a.b.c.d\")).toBeNull();\n  });\n\n  it(\"returns null for non-object payloads\", () => {\n    const header = Buffer.from(\"{}\").toString(\"base64url\");\n    const payload = Buffer.from('\"just a string\"').toString(\"base64url\");\n    expect(parseJwtClaims(`${header}.${payload}.sig`)).toBeNull();\n  });\n\n  it(\"returns null for invalid base64\", () => {\n    expect(parseJwtClaims(\"a.!!!invalid!!!.c\")).toBeNull();\n  });\n});\n\n// ---------------------------------------------------------------------------\n// extractAccountIdFromClaims\n// ---------------------------------------------------------------------------\n\ndescribe(\"extractAccountIdFromClaims\", () => {\n  it(\"prefers direct chatgpt_account_id claim\", () => {\n    const claims = {\n      chatgpt_account_id: \"direct_id\",\n      \"https://api.openai.com/auth\": { chatgpt_account_id: \"nested_id\" },\n      organizations: [{ id: \"org_id\" }],\n    };\n    expect(extractAccountIdFromClaims(claims)).toBe(\"direct_id\");\n  });\n\n  it(\"falls back to nested auth namespace\", () => {\n    const claims = {\n      \"https://api.openai.com/auth\": { chatgpt_account_id: \"nested_id\" },\n      organizations: [{ id: \"org_id\" }],\n    };\n    expect(extractAccountIdFromClaims(claims)).toBe(\"nested_id\");\n  });\n\n  it(\"falls back to organizations[0].id\", () => {\n    const claims = {\n      organizations: [{ id: \"org_id\" }],\n    };\n    expect(extractAccountIdFromClaims(claims)).toBe(\"org_id\");\n  });\n\n  it(\"returns null when no account id is found\", () => {\n    expect(extractAccountIdFromClaims({})).toBeNull();\n    expect(extractAccountIdFromClaims({ organizations: [] })).toBeNull();\n    expect(\n      extractAccountIdFromClaims({ \"https://api.openai.com/auth\": \"not an object\" })\n    ).toBeNull();\n  });\n\n  it(\"skips empty string values\", () => {\n    expect(extractAccountIdFromClaims({ chatgpt_account_id: \"\" })).toBeNull();\n  });\n});\n\n// ---------------------------------------------------------------------------\n// extractAccountIdFromToken / extractAccountIdFromTokens\n// ---------------------------------------------------------------------------\n\ndescribe(\"extractAccountIdFromToken\", () => {\n  it(\"extracts account id from a JWT\", () => {\n    const token = fakeJwt({ chatgpt_account_id: \"from_jwt\" });\n    expect(extractAccountIdFromToken(token)).toBe(\"from_jwt\");\n  });\n\n  it(\"returns null for an invalid token\", () => {\n    expect(extractAccountIdFromToken(\"not-a-jwt\")).toBeNull();\n  });\n});\n\ndescribe(\"extractAccountIdFromTokens\", () => {\n  it(\"prefers id_token over access token\", () => {\n    const idToken = fakeJwt({ chatgpt_account_id: \"from_id_token\" });\n    const accessToken = fakeJwt({ chatgpt_account_id: \"from_access_token\" });\n    expect(extractAccountIdFromTokens({ accessToken, idToken })).toBe(\"from_id_token\");\n  });\n\n  it(\"falls back to access token when id_token is missing\", () => {\n    const accessToken = fakeJwt({ chatgpt_account_id: \"from_access_token\" });\n    expect(extractAccountIdFromTokens({ accessToken })).toBe(\"from_access_token\");\n  });\n\n  it(\"falls back to access token when id_token has no account id\", () => {\n    const idToken = fakeJwt({ sub: \"user\" });\n    const accessToken = fakeJwt({ chatgpt_account_id: \"from_access_token\" });\n    expect(extractAccountIdFromTokens({ accessToken, idToken })).toBe(\"from_access_token\");\n  });\n});\n"]}