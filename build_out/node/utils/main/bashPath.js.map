{"version":3,"file":"bashPath.js","sourceRoot":"","sources":["../../../../src/node/utils/main/bashPath.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Platform-specific bash path resolution\n *\n * On Unix/Linux/macOS, bash is in PATH by default.\n * On Windows, mux requires Git for Windows' Git Bash (WSL is not supported).\n */\n\nimport { execSync, type ExecSyncOptionsWithStringEncoding } from \"child_process\";\nimport { existsSync } from \"fs\";\nimport path from \"path\";\n\nconst WIN_PATH = path.win32;\n\nconst BASH_PATH_ERROR_COOLDOWN_MS = 30_000;\n\nlet cachedBashPath: string | null = null;\nlet cachedBashPathError: { message: string; lastCheckedMs: number } | null = null;\n\ntype ExecSyncFn = (command: string, options: ExecSyncOptionsWithStringEncoding) => string;\ntype ExistsSyncFn = (path: string) => boolean;\n\ninterface FindWindowsBashParams {\n  env: NodeJS.ProcessEnv;\n  execSyncFn: ExecSyncFn;\n  existsSyncFn: ExistsSyncFn;\n}\n\nconst defaultExecSync: ExecSyncFn = (command, options) => execSync(command, options);\n\nfunction parseWhereOutput(output: string): string[] {\n  return output\n    .split(/\\r?\\n/)\n    .map((line) => line.trim())\n    .filter((line) => line.length > 0);\n}\n\nfunction isWslLauncherPath(p: string): boolean {\n  const normalized = WIN_PATH.normalize(p).toLowerCase();\n  return (\n    normalized.endsWith(\"\\\\windows\\\\system32\\\\bash.exe\") ||\n    normalized.endsWith(\"\\\\windows\\\\system32\\\\wsl.exe\")\n  );\n}\n\n/**\n * Ensure the bash we found appears to come from a Git for Windows install.\n *\n * (We avoid launching WSL shells via `C:\\\\Windows\\\\System32\\\\bash.exe`.)\n */\nfunction looksLikeGitForWindowsBash(bashPath: string, existsSyncFn: ExistsSyncFn): boolean {\n  if (isWslLauncherPath(bashPath)) {\n    return false;\n  }\n\n  const normalized = WIN_PATH.normalize(bashPath);\n  const lower = normalized.toLowerCase();\n\n  if (lower.endsWith(\"\\\\usr\\\\bin\\\\bash.exe\")) {\n    const root = WIN_PATH.dirname(WIN_PATH.dirname(WIN_PATH.dirname(normalized)));\n    return existsSyncFn(WIN_PATH.join(root, \"cmd\", \"git.exe\"));\n  }\n\n  if (lower.endsWith(\"\\\\bin\\\\bash.exe\")) {\n    const root = WIN_PATH.dirname(WIN_PATH.dirname(normalized));\n    return existsSyncFn(WIN_PATH.join(root, \"cmd\", \"git.exe\"));\n  }\n\n  // Best-effort: walk up a few levels looking for `cmd/git.exe`.\n  let dir = WIN_PATH.dirname(normalized);\n  for (let i = 0; i < 4; i++) {\n    if (existsSyncFn(WIN_PATH.join(dir, \"cmd\", \"git.exe\"))) {\n      return true;\n    }\n\n    const parent = WIN_PATH.dirname(dir);\n    if (parent === dir) {\n      break;\n    }\n    dir = parent;\n  }\n\n  return false;\n}\n\nfunction findGitRootFromGitExePath(gitExePath: string, existsSyncFn: ExistsSyncFn): string | null {\n  let dir = WIN_PATH.dirname(WIN_PATH.dirname(WIN_PATH.normalize(gitExePath)));\n\n  for (let i = 0; i < 4; i++) {\n    if (existsSyncFn(WIN_PATH.join(dir, \"cmd\", \"git.exe\"))) {\n      return dir;\n    }\n\n    const parent = WIN_PATH.dirname(dir);\n    if (parent === dir) {\n      break;\n    }\n    dir = parent;\n  }\n\n  return null;\n}\n\n/**\n * Find bash executable path on Windows.\n *\n * We strongly prefer Git Bash (Git for Windows) and explicitly avoid WSL launchers.\n */\nfunction findWindowsBash(params: FindWindowsBashParams): string | null {\n  const { env, execSyncFn, existsSyncFn } = params;\n\n  const gitRoots: string[] = [\n    // Git for Windows default paths\n    \"C:\\\\Program Files\\\\Git\",\n    \"C:\\\\Program Files (x86)\\\\Git\",\n    // Chocolatey installation\n    \"C:\\\\tools\\\\git\",\n  ];\n\n  // User-local Git installation\n  if (env.LOCALAPPDATA) {\n    gitRoots.push(WIN_PATH.join(env.LOCALAPPDATA, \"Programs\", \"Git\"));\n  }\n\n  // Scoop installation\n  if (env.USERPROFILE) {\n    gitRoots.push(WIN_PATH.join(env.USERPROFILE, \"scoop\", \"apps\", \"git\", \"current\"));\n  }\n\n  // Prefer known Git for Windows install locations.\n  const commonPaths = gitRoots.flatMap((root) => [\n    WIN_PATH.join(root, \"bin\", \"bash.exe\"),\n    WIN_PATH.join(root, \"usr\", \"bin\", \"bash.exe\"),\n  ]);\n\n  for (const bashPath of commonPaths) {\n    if (existsSyncFn(bashPath) && looksLikeGitForWindowsBash(bashPath, existsSyncFn)) {\n      return bashPath;\n    }\n  }\n\n  // Also check if Git is in PATH and derive bash path from it.\n  try {\n    const result = execSyncFn(\"where git\", {\n      encoding: \"utf8\",\n      stdio: [\"pipe\", \"pipe\", \"ignore\"],\n      windowsHide: true,\n    });\n    for (const gitExePath of parseWhereOutput(result)) {\n      if (!existsSyncFn(gitExePath)) {\n        continue;\n      }\n\n      const gitRoot = findGitRootFromGitExePath(gitExePath, existsSyncFn);\n      if (!gitRoot) {\n        continue;\n      }\n\n      const candidateBashPaths = [\n        WIN_PATH.join(gitRoot, \"bin\", \"bash.exe\"),\n        WIN_PATH.join(gitRoot, \"usr\", \"bin\", \"bash.exe\"),\n      ];\n\n      for (const bashPath of candidateBashPaths) {\n        if (existsSyncFn(bashPath) && looksLikeGitForWindowsBash(bashPath, existsSyncFn)) {\n          return bashPath;\n        }\n      }\n    }\n  } catch {\n    // Git not in PATH\n  }\n\n  // Fall back to searching for bash in PATH, skipping WSL.\n  try {\n    const result = execSyncFn(\"where bash\", {\n      encoding: \"utf8\",\n      stdio: [\"pipe\", \"pipe\", \"ignore\"],\n      windowsHide: true,\n    });\n    for (const bashPath of parseWhereOutput(result)) {\n      if (!existsSyncFn(bashPath)) {\n        continue;\n      }\n\n      if (looksLikeGitForWindowsBash(bashPath, existsSyncFn)) {\n        return bashPath;\n      }\n    }\n  } catch {\n    // Not in PATH\n  }\n\n  return null;\n}\n\nexport interface GetBashPathForPlatformParams {\n  platform: NodeJS.Platform;\n  env?: NodeJS.ProcessEnv;\n  execSyncFn?: ExecSyncFn;\n  existsSyncFn?: ExistsSyncFn;\n}\n\nexport function getBashPathForPlatform(params: GetBashPathForPlatformParams): string {\n  if (params.platform !== \"win32\") {\n    return \"bash\";\n  }\n\n  const bashPath = findWindowsBash({\n    env: params.env ?? process.env,\n    execSyncFn: params.execSyncFn ?? defaultExecSync,\n    existsSyncFn: params.existsSyncFn ?? existsSync,\n  });\n\n  if (!bashPath) {\n    throw new Error(\n      \"Git Bash not found. On Windows, mux requires Git for Windows (Git Bash). WSL is not supported. Install Git for Windows from https://git-scm.com/download/win\"\n    );\n  }\n\n  return bashPath;\n}\n\n/**\n * Get the bash executable path for the current platform\n *\n * @returns Path to bash executable. On Unix/macOS returns \"bash\",\n *          on Windows returns full path to Git Bash if found.\n * @throws Error if Git Bash cannot be found on Windows\n */\nexport function getBashPath(\n  params: {\n    platform?: NodeJS.Platform;\n    env?: NodeJS.ProcessEnv;\n    execSyncFn?: (command: string, options: ExecSyncOptionsWithStringEncoding) => string;\n    existsSyncFn?: (path: string) => boolean;\n    nowFn?: () => number;\n  } = {}\n): string {\n  const platform = params.platform ?? process.platform;\n\n  // On Unix/Linux/macOS, bash is in PATH\n  if (platform !== \"win32\") {\n    return \"bash\";\n  }\n\n  // Use cached path if available\n  if (cachedBashPath !== null) {\n    return cachedBashPath;\n  }\n\n  const nowFn = params.nowFn ?? Date.now;\n  const now = nowFn();\n  if (\n    cachedBashPathError &&\n    now - cachedBashPathError.lastCheckedMs < BASH_PATH_ERROR_COOLDOWN_MS\n  ) {\n    throw new Error(cachedBashPathError.message);\n  }\n\n  try {\n    cachedBashPath = getBashPathForPlatform({\n      platform,\n      env: params.env,\n      execSyncFn: params.execSyncFn,\n      existsSyncFn: params.existsSyncFn,\n    });\n    cachedBashPathError = null;\n    return cachedBashPath;\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    cachedBashPathError = { message, lastCheckedMs: now };\n    throw error;\n  }\n}\n\n/** Reset cached bash path (used by tests). */\nexport function resetBashPathCache(): void {\n  cachedBashPath = null;\n  cachedBashPathError = null;\n}\n\n/**\n * Check if bash is available on the system\n *\n * @returns true if bash is available, false otherwise\n */\nexport function isBashAvailable(): boolean {\n  try {\n    getBashPath();\n    return true;\n  } catch {\n    return false;\n  }\n}\n"]}