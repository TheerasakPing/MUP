{"version":3,"file":"instructionFiles.test.js","sourceRoot":"","sources":["../../../../src/node/utils/main/instructionFiles.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { readInstructionSet, gatherInstructionSets } from \"./instructionFiles\";\r\n\r\ndescribe(\"instructionFiles\", () => {\r\n  let tempDir: string;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"instruction-test-\"));\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  describe(\"readInstructionSet\", () => {\r\n    it(\"should return null when no instruction files exist\", async () => {\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it(\"should return base instruction file content\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.md\"), \"base instructions\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBe(\"base instructions\");\r\n    });\r\n\r\n    it(\"should append AGENTS.local.md to base instructions\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.md\"), \"base instructions\");\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.local.md\"), \"local overrides\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBe(\"base instructions\\n\\nlocal overrides\");\r\n    });\r\n\r\n    it(\"should work with AGENT.md + AGENTS.local.md\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENT.md\"), \"base content\");\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.local.md\"), \"local content\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBe(\"base content\\n\\nlocal content\");\r\n    });\r\n\r\n    it(\"should work with CLAUDE.md + AGENTS.local.md\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"CLAUDE.md\"), \"base content\");\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.local.md\"), \"local content\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBe(\"base content\\n\\nlocal content\");\r\n    });\r\n\r\n    it(\"should ignore AGENTS.local.md if no base file exists\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.local.md\"), \"local only\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it(\"should strip markdown comments from instructions\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.md\"), \"<!-- secret -->\\nVisible directive\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBe(\"Visible directive\");\r\n    });\r\n\r\n    it(\"should return null if stripping comments leaves no content\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.md\"), \"<!-- only comments -->\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBeNull();\r\n    });\r\n    it(\"should prefer AGENTS.md even if AGENT.md and AGENTS.local.md exist\", async () => {\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.md\"), \"agents base\");\r\n      await fs.writeFile(path.join(tempDir, \"AGENT.md\"), \"agent base\");\r\n      await fs.writeFile(path.join(tempDir, \"AGENTS.local.md\"), \"local\");\r\n\r\n      const result = await readInstructionSet(tempDir);\r\n      expect(result).toBe(\"agents base\\n\\nlocal\");\r\n    });\r\n  });\r\n\r\n  describe(\"gatherInstructionSets\", () => {\r\n    it(\"should return empty array when no instructions exist\", async () => {\r\n      const dir1 = path.join(tempDir, \"dir1\");\r\n      const dir2 = path.join(tempDir, \"dir2\");\r\n      await fs.mkdir(dir1);\r\n      await fs.mkdir(dir2);\r\n\r\n      const result = await gatherInstructionSets([dir1, dir2]);\r\n      expect(result).toEqual([]);\r\n    });\r\n\r\n    it(\"should gather instructions from multiple directories\", async () => {\r\n      const dir1 = path.join(tempDir, \"dir1\");\r\n      const dir2 = path.join(tempDir, \"dir2\");\r\n      await fs.mkdir(dir1);\r\n      await fs.mkdir(dir2);\r\n\r\n      await fs.writeFile(path.join(dir1, \"AGENTS.md\"), \"global instructions\");\r\n      await fs.writeFile(path.join(dir2, \"AGENTS.md\"), \"workspace instructions\");\r\n\r\n      const result = await gatherInstructionSets([dir1, dir2]);\r\n      expect(result).toEqual([\"global instructions\", \"workspace instructions\"]);\r\n    });\r\n\r\n    it(\"should include local files in gathered instructions\", async () => {\r\n      const dir1 = path.join(tempDir, \"dir1\");\r\n      const dir2 = path.join(tempDir, \"dir2\");\r\n      await fs.mkdir(dir1);\r\n      await fs.mkdir(dir2);\r\n\r\n      await fs.writeFile(path.join(dir1, \"AGENTS.md\"), \"global base\");\r\n      await fs.writeFile(path.join(dir1, \"AGENTS.local.md\"), \"global local\");\r\n      await fs.writeFile(path.join(dir2, \"AGENTS.md\"), \"workspace base\");\r\n      await fs.writeFile(path.join(dir2, \"AGENTS.local.md\"), \"workspace local\");\r\n\r\n      const result = await gatherInstructionSets([dir1, dir2]);\r\n      expect(result).toEqual([\"global base\\n\\nglobal local\", \"workspace base\\n\\nworkspace local\"]);\r\n    });\r\n\r\n    it(\"should skip directories without instruction files\", async () => {\r\n      const dir1 = path.join(tempDir, \"dir1\");\r\n      const dir2 = path.join(tempDir, \"dir2\");\r\n      const dir3 = path.join(tempDir, \"dir3\");\r\n      await fs.mkdir(dir1);\r\n      await fs.mkdir(dir2);\r\n      await fs.mkdir(dir3);\r\n\r\n      await fs.writeFile(path.join(dir1, \"AGENTS.md\"), \"dir1 content\");\r\n      await fs.writeFile(path.join(dir3, \"AGENTS.md\"), \"dir3 content\");\r\n      // dir2 has no instruction files\r\n\r\n      const result = await gatherInstructionSets([dir1, dir2, dir3]);\r\n      expect(result).toEqual([\"dir1 content\", \"dir3 content\"]);\r\n    });\r\n  });\r\n});\r\n"]}