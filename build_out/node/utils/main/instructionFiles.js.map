{"version":3,"file":"instructionFiles.js","sourceRoot":"","sources":["../../../../src/node/utils/main/instructionFiles.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport { readFileString } from \"@/node/utils/runtime/helpers\";\n\nconst MARKDOWN_COMMENT_REGEX = /<!--[\\s\\S]*?-->/g;\n\nfunction stripMarkdownComments(content: string): string {\n  return content.replace(MARKDOWN_COMMENT_REGEX, \"\").trim();\n}\n\n/**\n * Instruction file names to search for, in priority order.\n * The first file found in a directory is used as the base instruction set.\n */\nexport const INSTRUCTION_FILE_NAMES = [\"AGENTS.md\", \"AGENT.md\", \"CLAUDE.md\"] as const;\n\n/**\n * Local instruction file suffix. If a base instruction file is found,\n * we also look for a matching .local.md variant in the same directory.\n *\n * Example: If AGENTS.md exists, we also check for AGENTS.local.md\n */\nexport const LOCAL_INSTRUCTION_FILENAME = \"AGENTS.local.md\";\n\n/**\n * File reader abstraction for reading files from either local fs or Runtime.\n */\ninterface FileReader {\n  readFile(filePath: string): Promise<string>;\n}\n\n/**\n * Create a FileReader for local filesystem access.\n */\nfunction createLocalFileReader(): FileReader {\n  return {\n    readFile: (filePath: string) => fs.readFile(filePath, \"utf-8\"),\n  };\n}\n\n/**\n * Create a FileReader for Runtime-based access (supports SSH).\n */\nfunction createRuntimeFileReader(runtime: Runtime): FileReader {\n  return {\n    readFile: (filePath: string) => readFileString(runtime, filePath),\n  };\n}\n\n/**\n * Read the first available file from a list using the provided file reader.\n *\n * @param reader - FileReader abstraction (local or runtime)\n * @param directory - Directory to search in\n * @param filenames - List of filenames to try, in priority order\n * @returns Content of the first file found, or null if none exist\n */\nasync function readFirstAvailableFile(\n  reader: FileReader,\n  directory: string,\n  filenames: readonly string[]\n): Promise<string | null> {\n  for (const filename of filenames) {\n    try {\n      return await reader.readFile(path.join(directory, filename));\n    } catch {\n      continue; // File doesn't exist, try next\n    }\n  }\n  return null;\n}\n\n/**\n * Read a base file with optional local variant using the provided file reader.\n *\n * @param reader - FileReader abstraction (local or runtime)\n * @param directory - Directory to search\n * @param baseFilenames - Base filenames to try in priority order\n * @param localFilename - Optional local filename to append if present\n * @returns Combined content or null if no base file exists\n */\nasync function readFileWithLocalVariant(\n  reader: FileReader,\n  directory: string,\n  baseFilenames: readonly string[],\n  localFilename?: string\n): Promise<string | null> {\n  const baseContent = await readFirstAvailableFile(reader, directory, baseFilenames);\n  if (!baseContent) return null;\n\n  let combinedContent = baseContent;\n\n  if (localFilename) {\n    try {\n      const localContent = await reader.readFile(path.join(directory, localFilename));\n      combinedContent = `${combinedContent}\\n\\n${localContent}`;\n    } catch {\n      // Local variant missing, keep base only\n    }\n  }\n\n  const sanitized = stripMarkdownComments(combinedContent);\n  return sanitized.length > 0 ? sanitized : null;\n}\n\n/**\n * Read an instruction set from a local directory.\n *\n * An instruction set consists of:\n * 1. A base instruction file (AGENTS.md → AGENT.md → CLAUDE.md, first found wins)\n * 2. An optional local instruction file (AGENTS.local.md)\n *\n * If both exist, they are concatenated with a blank line separator.\n *\n * @param directory - Directory to search for instruction files\n * @returns Combined instruction content, or null if no base file exists\n */\nexport async function readInstructionSet(\n  directory: string | null | undefined\n): Promise<string | null> {\n  if (!directory) return null;\n  const reader = createLocalFileReader();\n  return readFileWithLocalVariant(\n    reader,\n    path.resolve(directory),\n    INSTRUCTION_FILE_NAMES,\n    LOCAL_INSTRUCTION_FILENAME\n  );\n}\n\n/**\n * Read an instruction set from a workspace using Runtime abstraction.\n * Supports both local and remote (SSH) workspaces.\n *\n * @param runtime - Runtime instance (may be local or SSH)\n * @param directory - Directory to search for instruction files\n * @returns Combined instruction content, or null if no base file exists\n */\nexport async function readInstructionSetFromRuntime(\n  runtime: Runtime,\n  directory: string\n): Promise<string | null> {\n  const reader = createRuntimeFileReader(runtime);\n  return readFileWithLocalVariant(\n    reader,\n    directory,\n    INSTRUCTION_FILE_NAMES,\n    LOCAL_INSTRUCTION_FILENAME\n  );\n}\n\n/**\n * Searches for instruction files across multiple directories in priority order.\n *\n * Each directory is searched for a complete instruction set (base + local).\n * All found instruction sets are returned as separate segments.\n *\n * This allows for layered instructions where:\n * - Global instructions (~/.mux/AGENTS.md) apply to all projects\n * - Project instructions (workspace/AGENTS.md) add project-specific context\n *\n * @param directories - List of directories to search, in priority order\n * @returns Array of instruction segments (one per directory with instructions)\n */\nexport async function gatherInstructionSets(directories: string[]): Promise<string[]> {\n  const segments: string[] = [];\n\n  for (const directory of directories) {\n    const instructionSet = await readInstructionSet(directory);\n    if (instructionSet) {\n      segments.push(instructionSet);\n    }\n  }\n\n  return segments;\n}\n"]}