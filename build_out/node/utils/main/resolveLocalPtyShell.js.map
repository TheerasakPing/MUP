{"version":3,"file":"resolveLocalPtyShell.js","sourceRoot":"","sources":["../../../../src/node/utils/main/resolveLocalPtyShell.ts"],"names":[],"mappings":"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","sourcesContent":["import { spawnSync } from \"child_process\";\nimport path from \"path\";\n\nimport { getBashPath } from \"@/node/utils/main/bashPath\";\n\nexport interface ResolvedPtyShell {\n  command: string;\n  args: string[];\n}\n\nexport interface ResolveLocalPtyShellParams {\n  platform: NodeJS.Platform;\n  env: NodeJS.ProcessEnv;\n  isCommandAvailable: (command: string) => boolean;\n  getBashPath: () => string;\n}\n\nfunction defaultIsCommandAvailable(platform: NodeJS.Platform): (command: string) => boolean {\n  return (command: string) => {\n    if (!command) return false;\n\n    try {\n      const result = spawnSync(platform === \"win32\" ? \"where\" : \"which\", [command], {\n        stdio: \"ignore\",\n      });\n      return result.status === 0;\n    } catch {\n      return false;\n    }\n  };\n}\n\nfunction looksLikeWslShell(envShell: string): boolean {\n  // WSL (and other Unix-like environments) often surface POSIX-y paths like `/bin/bash`.\n  // Those paths don't exist on Windows hosts, so treat them as WSL and ignore.\n  if (envShell.startsWith(\"/\")) {\n    return true;\n  }\n\n  const normalized = envShell.replace(/\\//g, \"\\\\\").toLowerCase();\n  const base = path.win32.basename(normalized);\n  return (\n    normalized === \"wsl\" ||\n    base === \"wsl.exe\" ||\n    normalized === \"bash\" ||\n    normalized === \"bash.exe\" ||\n    normalized.endsWith(\"\\\\windows\\\\system32\\\\bash.exe\")\n  );\n}\n\n/**\n * Resolve the best shell to use for a *local* PTY session.\n *\n * We keep this as a small, mostly-pure helper so it can be unit-tested without\n * mutating `process.platform` / `process.env`.\n */\nexport function resolveLocalPtyShell(\n  params: Partial<ResolveLocalPtyShellParams> = {}\n): ResolvedPtyShell {\n  const platform = params.platform ?? process.platform;\n  const env = params.env ?? process.env;\n  const isCommandAvailable = params.isCommandAvailable ?? defaultIsCommandAvailable(platform);\n  const getBashPathFn = params.getBashPath ?? getBashPath;\n\n  // `process.env.SHELL` can be present-but-empty (\"\"), especially in packaged apps.\n  // Treat empty/whitespace as \"unset\".\n  const envShell = env.SHELL?.trim();\n  if (envShell) {\n    // On Windows, `SHELL=bash` often routes to WSL (via System32\\\\bash.exe).\n    // Ignore WSL shells and fall back to Git Bash/pwsh/cmd selection below.\n    if (platform !== \"win32\" || !looksLikeWslShell(envShell)) {\n      return { command: envShell, args: [] };\n    }\n  }\n\n  if (platform === \"win32\") {\n    // Prefer Git Bash when available (works well with repo tooling).\n    try {\n      const bashPath = getBashPathFn().trim();\n      if (bashPath) {\n        return { command: bashPath, args: [\"--login\", \"-i\"] };\n      }\n    } catch {\n      // Git Bash not available; fall back to PowerShell / cmd.\n    }\n\n    if (isCommandAvailable(\"pwsh\")) {\n      return { command: \"pwsh\", args: [] };\n    }\n\n    if (isCommandAvailable(\"powershell\")) {\n      return { command: \"powershell\", args: [] };\n    }\n\n    const comspec = env.COMSPEC?.trim();\n    return { command: comspec && comspec.length > 0 ? comspec : \"cmd.exe\", args: [] };\n  }\n\n  if (platform === \"darwin\") {\n    return { command: \"/bin/zsh\", args: [] };\n  }\n\n  return { command: \"/bin/bash\", args: [] };\n}\n"]}