{"version":3,"file":"tokenizer.worker.js","sourceRoot":"","sources":["../../../../src/node/utils/main/tokenizer.worker.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,8DAAiC;AACjC,6DAAiD;AACjD,+CAAiD;AAEjD,MAAY,QAAQ,kDAA8B;AAOlD,MAAM,cAAc,GAAG,IAAI,GAAG,EAAwB,CAAC;AAEvD,SAAS,YAAY,CAAC,SAAoB,EAAa;IACrD,MAAM,MAAM,GAAG,cAAc,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;IAC7C,IAAI,MAAM,EAAE,CAAC;QACX,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,MAAM,KAAK,GAAG,qBAAM,CAAC,SAAS,CAAC,CAAC;IAChC,IAAA,qBAAM,EAAC,KAAK,EAAE,4BAA4B,SAAS,GAAG,CAAC,CAAC;IAExD,MAAM,cAAc,GAAG,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;IAChD,IAAA,qBAAM,EAAC,cAAc,EAAE,+BAA+B,KAAK,CAAC,QAAQ,GAAG,CAAC,CAAC;IAEzE,MAAM,SAAS,GAAG,IAAI,wBAAS,CAAC,cAAc,CAAC,CAAC;IAChD,cAAc,CAAC,GAAG,CAAC,SAAS,EAAE,SAAS,CAAC,CAAC;IACzC,OAAO,SAAS,CAAC;AAAA,CAClB;AAED,qBAA4B,EAAE,SAAS,EAAE,KAAK,EAAoB,EAAU;IAC1E,MAAM,SAAS,GAAG,YAAY,CAAC,SAAS,CAAC,CAAC;IAC1C,MAAM,KAAK,GAAG,SAAS,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IACrC,OAAO,KAAK,CAAC;AAAA,CACd;AAED,sBAA6B,SAAoB,EAAU;IACzD,MAAM,KAAK,GAAG,qBAAM,CAAC,SAAS,CAAC,CAAC;IAChC,IAAA,qBAAM,EAAC,KAAK,EAAE,4BAA4B,SAAS,GAAG,CAAC,CAAC;IACxD,OAAO,KAAK,CAAC,QAAQ,CAAC;AAAA,CACvB;AAED,mCAAmC;AACnC,IAAI,gCAAU,EAAE,CAAC;IACf,gCAAU,CAAC,EAAE,CAAC,SAAS,EAAE,CAAC,OAA+D,EAAE,EAAE,CAAC;QAC5F,IAAI,CAAC;YACH,IAAI,MAAe,CAAC;YAEpB,QAAQ,OAAO,CAAC,QAAQ,EAAE,CAAC;gBACzB,KAAK,aAAa;oBAChB,MAAM,GAAG,WAAW,CAAC,OAAO,CAAC,IAAwB,CAAC,CAAC;oBACvD,MAAM;gBACR,KAAK,cAAc;oBACjB,MAAM,GAAG,YAAY,CAAC,OAAO,CAAC,IAAiB,CAAC,CAAC;oBACjD,MAAM;gBACR;oBACE,MAAM,IAAI,KAAK,CAAC,iBAAiB,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC;YACzD,CAAC;YAED,gCAAW,CAAC,WAAW,CAAC;gBACtB,SAAS,EAAE,OAAO,CAAC,SAAS;gBAC5B,MAAM;aACP,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,gCAAW,CAAC,WAAW,CAAC;gBACtB,SAAS,EAAE,OAAO,CAAC,SAAS;gBAC5B,KAAK,EAAE;oBACL,OAAO,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;oBAC/D,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS;iBACxD;aACF,CAAC,CAAC;QACL,CAAC;IAAA,CACF,CAAC,CAAC;AACL,CAAC","sourcesContent":["import assert from \"node:assert\";\nimport { parentPort } from \"node:worker_threads\";\nimport { Tokenizer, models } from \"ai-tokenizer\";\nimport type { ModelName } from \"ai-tokenizer\";\nimport * as encoding from \"ai-tokenizer/encoding\";\n\nexport interface CountTokensInput {\n  modelName: ModelName;\n  input: string;\n}\n\nconst tokenizerCache = new Map<ModelName, Tokenizer>();\n\nfunction getTokenizer(modelName: ModelName): Tokenizer {\n  const cached = tokenizerCache.get(modelName);\n  if (cached) {\n    return cached;\n  }\n\n  const model = models[modelName];\n  assert(model, `Unknown tokenizer model '${modelName}'`);\n\n  const encodingModule = encoding[model.encoding];\n  assert(encodingModule, `Unknown tokenizer encoding '${model.encoding}'`);\n\n  const tokenizer = new Tokenizer(encodingModule);\n  tokenizerCache.set(modelName, tokenizer);\n  return tokenizer;\n}\n\nexport function countTokens({ modelName, input }: CountTokensInput): number {\n  const tokenizer = getTokenizer(modelName);\n  const count = tokenizer.count(input);\n  return count;\n}\n\nexport function encodingName(modelName: ModelName): string {\n  const model = models[modelName];\n  assert(model, `Unknown tokenizer model '${modelName}'`);\n  return model.encoding;\n}\n\n// Handle messages from main thread\nif (parentPort) {\n  parentPort.on(\"message\", (message: { messageId: number; taskName: string; data: unknown }) => {\n    try {\n      let result: unknown;\n\n      switch (message.taskName) {\n        case \"countTokens\":\n          result = countTokens(message.data as CountTokensInput);\n          break;\n        case \"encodingName\":\n          result = encodingName(message.data as ModelName);\n          break;\n        default:\n          throw new Error(`Unknown task: ${message.taskName}`);\n      }\n\n      parentPort!.postMessage({\n        messageId: message.messageId,\n        result,\n      });\n    } catch (error) {\n      parentPort!.postMessage({\n        messageId: message.messageId,\n        error: {\n          message: error instanceof Error ? error.message : String(error),\n          stack: error instanceof Error ? error.stack : undefined,\n        },\n      });\n    }\n  });\n}\n"]}