{"version":3,"file":"tokenizer.worker.js","sourceRoot":"","sources":["../../../../src/node/utils/main/tokenizer.worker.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,8DAAiC;AACjC,6DAAiD;AACjD,+CAAiD;AAEjD,MAAY,QAAQ,kDAA8B;AAOlD,MAAM,cAAc,GAAG,IAAI,GAAG,EAAwB,CAAC;AAEvD,SAAS,YAAY,CAAC,SAAoB,EAAa;IACrD,MAAM,MAAM,GAAG,cAAc,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;IAC7C,IAAI,MAAM,EAAE,CAAC;QACX,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,MAAM,KAAK,GAAG,qBAAM,CAAC,SAAS,CAAC,CAAC;IAChC,IAAA,qBAAM,EAAC,KAAK,EAAE,4BAA4B,SAAS,GAAG,CAAC,CAAC;IAExD,MAAM,cAAc,GAAG,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;IAChD,IAAA,qBAAM,EAAC,cAAc,EAAE,+BAA+B,KAAK,CAAC,QAAQ,GAAG,CAAC,CAAC;IAEzE,MAAM,SAAS,GAAG,IAAI,wBAAS,CAAC,cAAc,CAAC,CAAC;IAChD,cAAc,CAAC,GAAG,CAAC,SAAS,EAAE,SAAS,CAAC,CAAC;IACzC,OAAO,SAAS,CAAC;AAAA,CAClB;AAED,qBAA4B,EAAE,SAAS,EAAE,KAAK,EAAoB,EAAU;IAC1E,MAAM,SAAS,GAAG,YAAY,CAAC,SAAS,CAAC,CAAC;IAC1C,MAAM,KAAK,GAAG,SAAS,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IACrC,OAAO,KAAK,CAAC;AAAA,CACd;AAED,sBAA6B,SAAoB,EAAU;IACzD,MAAM,KAAK,GAAG,qBAAM,CAAC,SAAS,CAAC,CAAC;IAChC,IAAA,qBAAM,EAAC,KAAK,EAAE,4BAA4B,SAAS,GAAG,CAAC,CAAC;IACxD,OAAO,KAAK,CAAC,QAAQ,CAAC;AAAA,CACvB;AAED,mCAAmC;AACnC,IAAI,gCAAU,EAAE,CAAC;IACf,gCAAU,CAAC,EAAE,CAAC,SAAS,EAAE,CAAC,OAA+D,EAAE,EAAE,CAAC;QAC5F,IAAI,CAAC;YACH,IAAI,MAAe,CAAC;YAEpB,QAAQ,OAAO,CAAC,QAAQ,EAAE,CAAC;gBACzB,KAAK,aAAa;oBAChB,MAAM,GAAG,WAAW,CAAC,OAAO,CAAC,IAAwB,CAAC,CAAC;oBACvD,MAAM;gBACR,KAAK,cAAc;oBACjB,MAAM,GAAG,YAAY,CAAC,OAAO,CAAC,IAAiB,CAAC,CAAC;oBACjD,MAAM;gBACR;oBACE,MAAM,IAAI,KAAK,CAAC,iBAAiB,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC;YACzD,CAAC;YAED,gCAAW,CAAC,WAAW,CAAC;gBACtB,SAAS,EAAE,OAAO,CAAC,SAAS;gBAC5B,MAAM;aACP,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,gCAAW,CAAC,WAAW,CAAC;gBACtB,SAAS,EAAE,OAAO,CAAC,SAAS;gBAC5B,KAAK,EAAE;oBACL,OAAO,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;oBAC/D,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS;iBACxD;aACF,CAAC,CAAC;QACL,CAAC;IAAA,CACF,CAAC,CAAC;AACL,CAAC","sourcesContent":["import assert from \"node:assert\";\r\nimport { parentPort } from \"node:worker_threads\";\r\nimport { Tokenizer, models } from \"ai-tokenizer\";\r\nimport type { ModelName } from \"ai-tokenizer\";\r\nimport * as encoding from \"ai-tokenizer/encoding\";\r\n\r\nexport interface CountTokensInput {\r\n  modelName: ModelName;\r\n  input: string;\r\n}\r\n\r\nconst tokenizerCache = new Map<ModelName, Tokenizer>();\r\n\r\nfunction getTokenizer(modelName: ModelName): Tokenizer {\r\n  const cached = tokenizerCache.get(modelName);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n\r\n  const model = models[modelName];\r\n  assert(model, `Unknown tokenizer model '${modelName}'`);\r\n\r\n  const encodingModule = encoding[model.encoding];\r\n  assert(encodingModule, `Unknown tokenizer encoding '${model.encoding}'`);\r\n\r\n  const tokenizer = new Tokenizer(encodingModule);\r\n  tokenizerCache.set(modelName, tokenizer);\r\n  return tokenizer;\r\n}\r\n\r\nexport function countTokens({ modelName, input }: CountTokensInput): number {\r\n  const tokenizer = getTokenizer(modelName);\r\n  const count = tokenizer.count(input);\r\n  return count;\r\n}\r\n\r\nexport function encodingName(modelName: ModelName): string {\r\n  const model = models[modelName];\r\n  assert(model, `Unknown tokenizer model '${modelName}'`);\r\n  return model.encoding;\r\n}\r\n\r\n// Handle messages from main thread\r\nif (parentPort) {\r\n  parentPort.on(\"message\", (message: { messageId: number; taskName: string; data: unknown }) => {\r\n    try {\r\n      let result: unknown;\r\n\r\n      switch (message.taskName) {\r\n        case \"countTokens\":\r\n          result = countTokens(message.data as CountTokensInput);\r\n          break;\r\n        case \"encodingName\":\r\n          result = encodingName(message.data as ModelName);\r\n          break;\r\n        default:\r\n          throw new Error(`Unknown task: ${message.taskName}`);\r\n      }\r\n\r\n      parentPort!.postMessage({\r\n        messageId: message.messageId,\r\n        result,\r\n      });\r\n    } catch (error) {\r\n      parentPort!.postMessage({\r\n        messageId: message.messageId,\r\n        error: {\r\n          message: error instanceof Error ? error.message : String(error),\r\n          stack: error instanceof Error ? error.stack : undefined,\r\n        },\r\n      });\r\n    }\r\n  });\r\n}\r\n"]}