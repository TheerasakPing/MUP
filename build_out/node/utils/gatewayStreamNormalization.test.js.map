{"version":3,"file":"gatewayStreamNormalization.test.js","sourceRoot":"","sources":["../../../src/node/utils/gatewayStreamNormalization.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport {\r\n  isV3Usage,\r\n  flatUsageToV3,\r\n  normalizeFinishReason,\r\n  normalizeGatewayGenerateResult,\r\n  normalizeGatewayStreamUsage,\r\n  type V3Usage,\r\n} from \"./gatewayStreamNormalization\";\r\n\r\ndescribe(\"isV3Usage\", () => {\r\n  it(\"returns true for v3 nested usage\", () => {\r\n    expect(\r\n      isV3Usage({\r\n        inputTokens: { total: 100 },\r\n        outputTokens: { total: 50 },\r\n      })\r\n    ).toBe(true);\r\n  });\r\n\r\n  it(\"returns false for flat v2 usage\", () => {\r\n    expect(isV3Usage({ inputTokens: 100, outputTokens: 50 })).toBe(false);\r\n  });\r\n\r\n  it(\"returns false for null\", () => {\r\n    expect(isV3Usage(null)).toBe(false);\r\n  });\r\n\r\n  it(\"returns false for undefined\", () => {\r\n    expect(isV3Usage(undefined)).toBe(false);\r\n  });\r\n\r\n  it(\"returns false for non-object\", () => {\r\n    expect(isV3Usage(\"string\")).toBe(false);\r\n    expect(isV3Usage(42)).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe(\"flatUsageToV3\", () => {\r\n  it(\"converts basic flat usage to v3 nested format\", () => {\r\n    const result = flatUsageToV3({\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n    });\r\n\r\n    expect(result.inputTokens.total).toBe(1000);\r\n    expect(result.outputTokens.total).toBe(500);\r\n    expect(result.raw).toEqual({ inputTokens: 1000, outputTokens: 500 });\r\n  });\r\n\r\n  it(\"handles cached input tokens\", () => {\r\n    const result = flatUsageToV3({\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      cachedInputTokens: 300,\r\n    });\r\n\r\n    expect(result.inputTokens.total).toBe(1000);\r\n    expect(result.inputTokens.cacheRead).toBe(300);\r\n    expect(result.inputTokens.noCache).toBe(700); // 1000 - 300\r\n  });\r\n\r\n  it(\"handles reasoning tokens\", () => {\r\n    const result = flatUsageToV3({\r\n      inputTokens: 1000,\r\n      outputTokens: 500,\r\n      reasoningTokens: 200,\r\n    });\r\n\r\n    expect(result.outputTokens.total).toBe(500);\r\n    expect(result.outputTokens.reasoning).toBe(200);\r\n    expect(result.outputTokens.text).toBe(300); // 500 - 200\r\n  });\r\n\r\n  it(\"handles all token types together\", () => {\r\n    const result = flatUsageToV3({\r\n      inputTokens: 2000,\r\n      outputTokens: 800,\r\n      cachedInputTokens: 500,\r\n      reasoningTokens: 100,\r\n    });\r\n\r\n    expect(result.inputTokens.total).toBe(2000);\r\n    expect(result.inputTokens.noCache).toBe(1500);\r\n    expect(result.inputTokens.cacheRead).toBe(500);\r\n    expect(result.outputTokens.total).toBe(800);\r\n    expect(result.outputTokens.text).toBe(700);\r\n    expect(result.outputTokens.reasoning).toBe(100);\r\n  });\r\n\r\n  it(\"handles missing fields gracefully\", () => {\r\n    const result = flatUsageToV3({});\r\n\r\n    expect(result.inputTokens.total).toBeUndefined();\r\n    expect(result.inputTokens.noCache).toBeUndefined();\r\n    expect(result.outputTokens.total).toBeUndefined();\r\n    expect(result.outputTokens.text).toBeUndefined();\r\n  });\r\n\r\n  it(\"preserves raw original usage\", () => {\r\n    const original = { inputTokens: 42, outputTokens: 17, totalTokens: 59 };\r\n    const result = flatUsageToV3(original);\r\n    expect(result.raw).toEqual(original);\r\n  });\r\n});\r\n\r\ndescribe(\"normalizeFinishReason\", () => {\r\n  it(\"returns undefined for null/undefined\", () => {\r\n    expect(normalizeFinishReason(null)).toBeUndefined();\r\n    expect(normalizeFinishReason(undefined)).toBeUndefined();\r\n  });\r\n\r\n  it(\"passes through v3 format unchanged\", () => {\r\n    const v3 = { unified: \"stop\", raw: \"stop\" };\r\n    expect(normalizeFinishReason(v3)).toBe(v3);\r\n  });\r\n\r\n  it(\"converts plain string to v3 format\", () => {\r\n    expect(normalizeFinishReason(\"stop\")).toEqual({ unified: \"stop\", raw: \"stop\" });\r\n    expect(normalizeFinishReason(\"length\")).toEqual({ unified: \"length\", raw: \"length\" });\r\n    expect(normalizeFinishReason(\"tool-calls\")).toEqual({\r\n      unified: \"tool-calls\",\r\n      raw: \"tool-calls\",\r\n    });\r\n  });\r\n\r\n  it('converts \"unknown\" to \"other\"', () => {\r\n    expect(normalizeFinishReason(\"unknown\")).toEqual({ unified: \"other\", raw: \"unknown\" });\r\n  });\r\n\r\n  it(\"handles non-string non-object as 'other'\", () => {\r\n    expect(normalizeFinishReason(42)).toEqual({ unified: \"other\", raw: \"other\" });\r\n  });\r\n});\r\n\r\ndescribe(\"normalizeGatewayGenerateResult\", () => {\r\n  it(\"converts flat usage in generate result\", () => {\r\n    const result = normalizeGatewayGenerateResult({\r\n      content: [{ type: \"text\", text: \"hello\" }],\r\n      usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\r\n      finishReason: \"stop\",\r\n    });\r\n\r\n    // Usage should be v3 nested\r\n    const usage = result.usage as V3Usage;\r\n    expect(usage.inputTokens.total).toBe(100);\r\n    expect(usage.outputTokens.total).toBe(50);\r\n\r\n    // finishReason should be v3 object (cast because generic return type\r\n    // preserves the input shape, but the value is actually transformed)\r\n    expect(result.finishReason as unknown).toEqual({ unified: \"stop\", raw: \"stop\" });\r\n  });\r\n\r\n  it(\"preserves already-v3 usage\", () => {\r\n    const v3Usage: V3Usage = {\r\n      inputTokens: { total: 100, noCache: 80, cacheRead: 20, cacheWrite: undefined },\r\n      outputTokens: { total: 50, text: 40, reasoning: 10 },\r\n    };\r\n    const result = normalizeGatewayGenerateResult({\r\n      usage: v3Usage,\r\n      finishReason: { unified: \"stop\", raw: \"stop\" },\r\n    });\r\n\r\n    // Should not be modified\r\n    expect(result.usage).toBe(v3Usage);\r\n  });\r\n\r\n  it(\"preserves other result fields\", () => {\r\n    const result = normalizeGatewayGenerateResult({\r\n      content: [{ type: \"text\", text: \"hello\" }],\r\n      usage: { inputTokens: 10, outputTokens: 5 },\r\n      providerMetadata: { openai: { foo: \"bar\" } },\r\n    });\r\n\r\n    expect(result.content).toEqual([{ type: \"text\", text: \"hello\" }]);\r\n    expect(result.providerMetadata).toEqual({ openai: { foo: \"bar\" } });\r\n  });\r\n});\r\n\r\ndescribe(\"normalizeGatewayStreamUsage\", () => {\r\n  async function collectStream(chunks: unknown[]): Promise<unknown[]> {\r\n    const stream = new ReadableStream({\r\n      start(controller) {\r\n        for (const chunk of chunks) {\r\n          controller.enqueue(chunk);\r\n        }\r\n        controller.close();\r\n      },\r\n    });\r\n\r\n    const result: unknown[] = [];\r\n    const transformed: ReadableStream<unknown> = stream.pipeThrough(normalizeGatewayStreamUsage());\r\n    const reader = transformed.getReader();\r\n    for (;;) {\r\n      const chunk = await reader.read();\r\n      if (chunk.done) break;\r\n      result.push(chunk.value);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  it(\"passes non-finish events through unchanged\", async () => {\r\n    const chunks = [\r\n      { type: \"text-delta\", text: \"hello\" },\r\n      { type: \"reasoning-delta\", text: \"thinking\" },\r\n      { type: \"tool-input-start\", toolName: \"bash\" },\r\n    ];\r\n\r\n    const result = await collectStream(chunks);\r\n    expect(result).toEqual(chunks);\r\n  });\r\n\r\n  it(\"converts flat usage in finish events to v3 format\", async () => {\r\n    const chunks = [\r\n      { type: \"text-delta\", text: \"hello\" },\r\n      {\r\n        type: \"finish\",\r\n        finishReason: \"stop\",\r\n        usage: { inputTokens: 1000, outputTokens: 500, totalTokens: 1500 },\r\n      },\r\n    ];\r\n\r\n    const result = await collectStream(chunks);\r\n\r\n    // First chunk unchanged\r\n    expect(result[0]).toEqual({ type: \"text-delta\", text: \"hello\" });\r\n\r\n    // Finish chunk should have v3 usage\r\n    const finish = result[1] as Record<string, unknown>;\r\n    expect(finish.type).toBe(\"finish\");\r\n\r\n    const usage = finish.usage as V3Usage;\r\n    expect(usage.inputTokens.total).toBe(1000);\r\n    expect(usage.outputTokens.total).toBe(500);\r\n\r\n    // finishReason should be v3 object\r\n    expect(finish.finishReason).toEqual({ unified: \"stop\", raw: \"stop\" });\r\n  });\r\n\r\n  it(\"preserves already-v3 finish events\", async () => {\r\n    const v3Finish = {\r\n      type: \"finish\",\r\n      finishReason: { unified: \"stop\", raw: \"stop\" },\r\n      usage: {\r\n        inputTokens: { total: 100, noCache: 80, cacheRead: 20, cacheWrite: undefined },\r\n        outputTokens: { total: 50, text: 40, reasoning: 10 },\r\n      },\r\n    };\r\n\r\n    const result = await collectStream([v3Finish]);\r\n    const finish = result[0] as Record<string, unknown>;\r\n    // Usage should be the same v3 object (not re-wrapped)\r\n    expect(finish.usage).toBe(v3Finish.usage);\r\n  });\r\n\r\n  it(\"handles null/undefined values gracefully\", async () => {\r\n    const result = await collectStream([null, undefined, \"string\", 42]);\r\n    // Non-objects pass through\r\n    expect(result).toEqual([null, undefined, \"string\", 42]);\r\n  });\r\n\r\n  it(\"handles finish events with no usage\", async () => {\r\n    const chunks = [{ type: \"finish\", finishReason: \"stop\" }];\r\n    const result = await collectStream(chunks);\r\n    const finish = result[0] as Record<string, unknown>;\r\n    expect(finish.type).toBe(\"finish\");\r\n    // No usage field, just finishReason normalized\r\n    expect(finish.finishReason).toEqual({ unified: \"stop\", raw: \"stop\" });\r\n  });\r\n\r\n  it(\"handles finish with cached and reasoning tokens\", async () => {\r\n    const chunks = [\r\n      {\r\n        type: \"finish\",\r\n        finishReason: \"stop\",\r\n        usage: {\r\n          inputTokens: 2000,\r\n          outputTokens: 800,\r\n          cachedInputTokens: 500,\r\n          reasoningTokens: 200,\r\n          totalTokens: 2800,\r\n        },\r\n      },\r\n    ];\r\n\r\n    const result = await collectStream(chunks);\r\n    const finish = result[0] as Record<string, unknown>;\r\n    const usage = finish.usage as V3Usage;\r\n\r\n    expect(usage.inputTokens.total).toBe(2000);\r\n    expect(usage.inputTokens.cacheRead).toBe(500);\r\n    expect(usage.inputTokens.noCache).toBe(1500);\r\n    expect(usage.outputTokens.total).toBe(800);\r\n    expect(usage.outputTokens.reasoning).toBe(200);\r\n    expect(usage.outputTokens.text).toBe(600);\r\n  });\r\n});\r\n"]}