{"version":3,"file":"eventStore.test.js","sourceRoot":"","sources":["../../../src/node/utils/eventStore.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"@jest/globals\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport { EventStore } from \"./eventStore\";\r\nimport type { Config } from \"@/node/config\";\r\n\r\n// Test types\r\ninterface TestState {\r\n  id: string;\r\n  value: number;\r\n  items: string[];\r\n}\r\n\r\ninterface TestEvent {\r\n  type: \"start\" | \"item\" | \"end\";\r\n  id: string;\r\n  data?: string | number;\r\n}\r\n\r\ndescribe(\"EventStore\", () => {\r\n  const testSessionDir = path.join(__dirname, \"../../test-sessions\");\r\n  const testWorkspaceId = \"test-workspace-123\";\r\n  const testFilename = \"test-state.json\";\r\n\r\n  let mockConfig: Config;\r\n  let store: EventStore<TestState, TestEvent>;\r\n  let emittedEvents: TestEvent[] = [];\r\n\r\n  // Test serializer: converts state into events\r\n  const serializeState = (state: TestState & { workspaceId?: string }): TestEvent[] => {\r\n    const events: TestEvent[] = [];\r\n    events.push({ type: \"start\", id: state.workspaceId ?? state.id, data: state.value });\r\n    for (const item of state.items) {\r\n      events.push({ type: \"item\", id: state.workspaceId ?? state.id, data: item });\r\n    }\r\n    events.push({ type: \"end\", id: state.workspaceId ?? state.id, data: state.items.length });\r\n    return events;\r\n  };\r\n\r\n  // Test emitter: captures events\r\n  const emitEvent = (event: TestEvent): void => {\r\n    emittedEvents.push(event);\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    // Create test session directory\r\n    try {\r\n      await fs.access(testSessionDir);\r\n    } catch {\r\n      await fs.mkdir(testSessionDir, { recursive: true });\r\n    }\r\n\r\n    mockConfig = {\r\n      muxDir: path.join(__dirname, \"../..\"),\r\n      sessionsDir: testSessionDir,\r\n      getSessionDir: (workspaceId: string) => path.join(testSessionDir, workspaceId),\r\n    } as unknown as Config;\r\n\r\n    emittedEvents = [];\r\n\r\n    store = new EventStore(mockConfig, testFilename, serializeState, emitEvent, \"TestStore\");\r\n  });\r\n\r\n  afterEach(async () => {\r\n    // Clean up test files\r\n    try {\r\n      await fs.access(testSessionDir);\r\n      await fs.rm(testSessionDir, { recursive: true, force: true });\r\n    } catch {\r\n      // Directory doesn't exist, nothing to clean up\r\n    }\r\n  });\r\n\r\n  describe(\"State Management\", () => {\r\n    it(\"should store and retrieve in-memory state\", () => {\r\n      const state: TestState = { id: \"test\", value: 42, items: [\"a\", \"b\"] };\r\n\r\n      store.setState(testWorkspaceId, state);\r\n      const retrieved = store.getState(testWorkspaceId);\r\n\r\n      expect(retrieved).toEqual(state);\r\n    });\r\n\r\n    it(\"should return undefined for non-existent state\", () => {\r\n      const retrieved = store.getState(\"non-existent\");\r\n      expect(retrieved).toBeUndefined();\r\n    });\r\n\r\n    it(\"should delete in-memory state\", () => {\r\n      const state: TestState = { id: \"test\", value: 42, items: [] };\r\n\r\n      store.setState(testWorkspaceId, state);\r\n      expect(store.hasState(testWorkspaceId)).toBe(true);\r\n\r\n      store.deleteState(testWorkspaceId);\r\n      expect(store.hasState(testWorkspaceId)).toBe(false);\r\n      expect(store.getState(testWorkspaceId)).toBeUndefined();\r\n    });\r\n\r\n    it(\"should check if state exists\", () => {\r\n      expect(store.hasState(testWorkspaceId)).toBe(false);\r\n\r\n      store.setState(testWorkspaceId, { id: \"test\", value: 1, items: [] });\r\n      expect(store.hasState(testWorkspaceId)).toBe(true);\r\n    });\r\n\r\n    it(\"should get all active workspace IDs\", () => {\r\n      store.setState(\"workspace-1\", { id: \"1\", value: 1, items: [] });\r\n      store.setState(\"workspace-2\", { id: \"2\", value: 2, items: [] });\r\n\r\n      const ids = store.getActiveWorkspaceIds();\r\n      expect(ids).toHaveLength(2);\r\n      expect(ids).toContain(\"workspace-1\");\r\n      expect(ids).toContain(\"workspace-2\");\r\n    });\r\n  });\r\n\r\n  describe(\"Persistence\", () => {\r\n    it(\"should persist state to disk\", async () => {\r\n      const state: TestState = { id: \"test\", value: 99, items: [\"x\", \"y\", \"z\"] };\r\n\r\n      await store.persist(testWorkspaceId, state);\r\n\r\n      // Verify file exists\r\n      const workspaceDir = path.join(testSessionDir, testWorkspaceId);\r\n      const filePath = path.join(workspaceDir, testFilename);\r\n      try {\r\n        await fs.access(filePath);\r\n      } catch {\r\n        throw new Error(`File ${filePath} does not exist`);\r\n      }\r\n\r\n      // Verify content\r\n      const content = await fs.readFile(filePath, \"utf-8\");\r\n      const parsed = JSON.parse(content) as TestState;\r\n      expect(parsed).toEqual(state);\r\n    });\r\n\r\n    it(\"should read persisted state from disk\", async () => {\r\n      const state: TestState = { id: \"test\", value: 123, items: [\"foo\", \"bar\"] };\r\n\r\n      await store.persist(testWorkspaceId, state);\r\n      const retrieved = await store.readPersisted(testWorkspaceId);\r\n\r\n      expect(retrieved).toEqual(state);\r\n    });\r\n\r\n    it(\"should return null for non-existent persisted state\", async () => {\r\n      const retrieved = await store.readPersisted(\"non-existent\");\r\n      expect(retrieved).toBeNull();\r\n    });\r\n\r\n    it(\"should delete persisted state from disk\", async () => {\r\n      const state: TestState = { id: \"test\", value: 456, items: [] };\r\n\r\n      await store.persist(testWorkspaceId, state);\r\n      await store.deletePersisted(testWorkspaceId);\r\n\r\n      const retrieved = await store.readPersisted(testWorkspaceId);\r\n      expect(retrieved).toBeNull();\r\n    });\r\n\r\n    it(\"should not throw when deleting non-existent persisted state\", async () => {\r\n      // Should complete without throwing (logs error but doesn't throw)\r\n      await store.deletePersisted(\"non-existent\");\r\n      // If we get here, it didn't throw\r\n      expect(true).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe(\"Replay\", () => {\r\n    it(\"should replay events from in-memory state\", async () => {\r\n      const state: TestState = { id: \"mem\", value: 10, items: [\"a\", \"b\", \"c\"] };\r\n      store.setState(testWorkspaceId, state);\r\n\r\n      await store.replay(testWorkspaceId, { workspaceId: testWorkspaceId });\r\n\r\n      expect(emittedEvents).toHaveLength(5); // start + 3 items + end\r\n      expect(emittedEvents[0]).toEqual({ type: \"start\", id: testWorkspaceId, data: 10 });\r\n      expect(emittedEvents[1]).toEqual({ type: \"item\", id: testWorkspaceId, data: \"a\" });\r\n      expect(emittedEvents[2]).toEqual({ type: \"item\", id: testWorkspaceId, data: \"b\" });\r\n      expect(emittedEvents[3]).toEqual({ type: \"item\", id: testWorkspaceId, data: \"c\" });\r\n      expect(emittedEvents[4]).toEqual({ type: \"end\", id: testWorkspaceId, data: 3 });\r\n    });\r\n\r\n    it(\"should replay events from disk state when not in memory\", async () => {\r\n      const state: TestState = { id: \"disk\", value: 20, items: [\"x\"] };\r\n\r\n      await store.persist(testWorkspaceId, state);\r\n      // Don't set in-memory state\r\n\r\n      await store.replay(testWorkspaceId, { workspaceId: testWorkspaceId });\r\n\r\n      expect(emittedEvents).toHaveLength(3); // start + 1 item + end\r\n      expect(emittedEvents[0]).toEqual({ type: \"start\", id: testWorkspaceId, data: 20 });\r\n      expect(emittedEvents[1]).toEqual({ type: \"item\", id: testWorkspaceId, data: \"x\" });\r\n      expect(emittedEvents[2]).toEqual({ type: \"end\", id: testWorkspaceId, data: 1 });\r\n    });\r\n\r\n    it(\"should prefer in-memory state over disk state\", async () => {\r\n      const diskState: TestState = { id: \"disk\", value: 1, items: [] };\r\n      const memState: TestState = { id: \"mem\", value: 2, items: [] };\r\n\r\n      await store.persist(testWorkspaceId, diskState);\r\n      store.setState(testWorkspaceId, memState);\r\n\r\n      await store.replay(testWorkspaceId, { workspaceId: testWorkspaceId });\r\n\r\n      expect(emittedEvents[0]).toEqual({ type: \"start\", id: testWorkspaceId, data: 2 }); // Memory value\r\n    });\r\n\r\n    it(\"should do nothing when replaying non-existent state\", async () => {\r\n      await store.replay(\"non-existent\", { workspaceId: \"non-existent\" });\r\n      expect(emittedEvents).toHaveLength(0);\r\n    });\r\n\r\n    it(\"should pass context to serializer\", async () => {\r\n      const state: TestState = { id: \"original\", value: 100, items: [] };\r\n      store.setState(testWorkspaceId, state);\r\n\r\n      await store.replay(testWorkspaceId, { workspaceId: \"override-id\" });\r\n\r\n      // Serializer should use workspaceId from context\r\n      expect(emittedEvents[0]).toEqual({ type: \"start\", id: \"override-id\", data: 100 });\r\n    });\r\n  });\r\n\r\n  describe(\"Integration\", () => {\r\n    it(\"should handle full lifecycle: set → persist → delete memory → replay from disk\", async () => {\r\n      const state: TestState = { id: \"lifecycle\", value: 777, items: [\"test\"] };\r\n\r\n      // Set in memory\r\n      store.setState(testWorkspaceId, state);\r\n      expect(store.hasState(testWorkspaceId)).toBe(true);\r\n\r\n      // Persist to disk\r\n      await store.persist(testWorkspaceId, state);\r\n\r\n      // Clear memory\r\n      store.deleteState(testWorkspaceId);\r\n      expect(store.hasState(testWorkspaceId)).toBe(false);\r\n\r\n      // Replay from disk\r\n      await store.replay(testWorkspaceId, { workspaceId: testWorkspaceId });\r\n\r\n      // Verify events were emitted\r\n      expect(emittedEvents).toHaveLength(3);\r\n      expect(emittedEvents[0].data).toBe(777);\r\n    });\r\n  });\r\n});\r\n"]}