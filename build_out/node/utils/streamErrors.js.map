{"version":3,"file":"streamErrors.js","sourceRoot":"","sources":["../../../src/node/utils/streamErrors.ts"],"names":[],"mappings":";;;;AAQA,SAAS,cAAc,CAAC,KAAc,EAAS;IAC7C,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;QAC3B,OAAO,KAAK,CAAC;IACf,CAAC;IAED,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;QAC9B,OAAO,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC;IAC1B,CAAC;IAED,OAAO,IAAI,KAAK,CAAC,eAAe,CAAC,CAAC;AAAA,CACnC;AAED,SAAS,YAAY,CAAC,KAAc,EAAsB;IACxD,IAAI,CAAC,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;QACxC,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,IAAI,MAAM,IAAI,KAAK,IAAI,OAAO,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;QACtD,OAAO,KAAK,CAAC,IAAI,CAAC;IACpB,CAAC;IAED,OAAO,SAAS,CAAC;AAAA,CAClB;AAED,gCAAuC,KAAc,EAAW;IAC9D,MAAM,IAAI,GAAG,YAAY,CAAC,KAAK,CAAC,CAAC;IACjC,OAAO,IAAI,KAAK,OAAO,IAAI,IAAI,KAAK,YAAY,CAAC;AAAA,CAClD;AAQD,kCACE,OAA4B,EAC5B,KAAa,EACb,OAAO,GAA8B,EAAE,EAC3B;IACZ,MAAM,OAAO,GAAG,CAAC,KAAc,EAAE,EAAE,CAAC;QAClC,MAAM,UAAU,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;QACzC,MAAM,IAAI,GAAoB;YAC5B,KAAK;YACL,IAAI,EAAE,YAAY,CAAC,KAAK,CAAC;YACzB,OAAO,EAAE,UAAU,CAAC,OAAO;SAC5B,CAAC;QAEF,IAAI,sBAAsB,CAAC,KAAK,CAAC,EAAE,CAAC;YAClC,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC,sBAAsB,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;YAChE,OAAO,CAAC,WAAW,EAAE,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;YACxC,OAAO;QACT,CAAC;QAED,OAAO,CAAC,MAAM,EAAE,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;QACvD,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;IAAA,CAC1C,CAAC;IAEF,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAE7B,OAAO,GAAG,EAAE,CAAC;QACX,OAAO,CAAC,cAAc,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAAA,CAC1C,CAAC;AAAA,CACH","sourcesContent":["import type { Logger } from \"@/node/services/log\";\n\nexport interface StreamErrorInfo {\n  label: string;\n  code?: string;\n  message: string;\n}\n\nfunction normalizeError(error: unknown): Error {\n  if (error instanceof Error) {\n    return error;\n  }\n\n  if (typeof error === \"string\") {\n    return new Error(error);\n  }\n\n  return new Error(\"Unknown error\");\n}\n\nfunction getErrorCode(error: unknown): string | undefined {\n  if (!error || typeof error !== \"object\") {\n    return undefined;\n  }\n\n  if (\"code\" in error && typeof error.code === \"string\") {\n    return error.code;\n  }\n\n  return undefined;\n}\n\nexport function isIgnorableStreamError(error: unknown): boolean {\n  const code = getErrorCode(error);\n  return code === \"EPIPE\" || code === \"ECONNRESET\";\n}\n\nexport interface StreamErrorHandlerOptions {\n  logger?: Pick<Logger, \"debug\" | \"warn\">;\n  onIgnorable?: (error: Error, info: StreamErrorInfo) => void;\n  onUnexpected?: (error: Error, info: StreamErrorInfo) => void;\n}\n\nexport function attachStreamErrorHandler(\n  emitter: NodeJS.EventEmitter,\n  label: string,\n  options: StreamErrorHandlerOptions = {}\n): () => void {\n  const handler = (error: unknown) => {\n    const normalized = normalizeError(error);\n    const info: StreamErrorInfo = {\n      label,\n      code: getErrorCode(error),\n      message: normalized.message,\n    };\n\n    if (isIgnorableStreamError(error)) {\n      options.logger?.debug(\"Ignored stream error\", info, normalized);\n      options.onIgnorable?.(normalized, info);\n      return;\n    }\n\n    options.logger?.warn(\"Stream error\", info, normalized);\n    options.onUnexpected?.(normalized, info);\n  };\n\n  emitter.on(\"error\", handler);\n\n  return () => {\n    emitter.removeListener(\"error\", handler);\n  };\n}\n"]}