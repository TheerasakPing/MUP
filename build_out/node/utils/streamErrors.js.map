{"version":3,"file":"streamErrors.js","sourceRoot":"","sources":["../../../src/node/utils/streamErrors.ts"],"names":[],"mappings":";;;;AAQA,SAAS,cAAc,CAAC,KAAc,EAAS;IAC7C,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;QAC3B,OAAO,KAAK,CAAC;IACf,CAAC;IAED,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;QAC9B,OAAO,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC;IAC1B,CAAC;IAED,OAAO,IAAI,KAAK,CAAC,eAAe,CAAC,CAAC;AAAA,CACnC;AAED,SAAS,YAAY,CAAC,KAAc,EAAsB;IACxD,IAAI,CAAC,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;QACxC,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,IAAI,MAAM,IAAI,KAAK,IAAI,OAAO,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;QACtD,OAAO,KAAK,CAAC,IAAI,CAAC;IACpB,CAAC;IAED,OAAO,SAAS,CAAC;AAAA,CAClB;AAED,gCAAuC,KAAc,EAAW;IAC9D,MAAM,IAAI,GAAG,YAAY,CAAC,KAAK,CAAC,CAAC;IACjC,OAAO,IAAI,KAAK,OAAO,IAAI,IAAI,KAAK,YAAY,CAAC;AAAA,CAClD;AAQD,kCACE,OAA4B,EAC5B,KAAa,EACb,OAAO,GAA8B,EAAE,EAC3B;IACZ,MAAM,OAAO,GAAG,CAAC,KAAc,EAAE,EAAE,CAAC;QAClC,MAAM,UAAU,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;QACzC,MAAM,IAAI,GAAoB;YAC5B,KAAK;YACL,IAAI,EAAE,YAAY,CAAC,KAAK,CAAC;YACzB,OAAO,EAAE,UAAU,CAAC,OAAO;SAC5B,CAAC;QAEF,IAAI,sBAAsB,CAAC,KAAK,CAAC,EAAE,CAAC;YAClC,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC,sBAAsB,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;YAChE,OAAO,CAAC,WAAW,EAAE,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;YACxC,OAAO;QACT,CAAC;QAED,OAAO,CAAC,MAAM,EAAE,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;QACvD,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;IAAA,CAC1C,CAAC;IAEF,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAE7B,OAAO,GAAG,EAAE,CAAC;QACX,OAAO,CAAC,cAAc,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAAA,CAC1C,CAAC;AAAA,CACH","sourcesContent":["import type { Logger } from \"@/node/services/log\";\r\n\r\nexport interface StreamErrorInfo {\r\n  label: string;\r\n  code?: string;\r\n  message: string;\r\n}\r\n\r\nfunction normalizeError(error: unknown): Error {\r\n  if (error instanceof Error) {\r\n    return error;\r\n  }\r\n\r\n  if (typeof error === \"string\") {\r\n    return new Error(error);\r\n  }\r\n\r\n  return new Error(\"Unknown error\");\r\n}\r\n\r\nfunction getErrorCode(error: unknown): string | undefined {\r\n  if (!error || typeof error !== \"object\") {\r\n    return undefined;\r\n  }\r\n\r\n  if (\"code\" in error && typeof error.code === \"string\") {\r\n    return error.code;\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport function isIgnorableStreamError(error: unknown): boolean {\r\n  const code = getErrorCode(error);\r\n  return code === \"EPIPE\" || code === \"ECONNRESET\";\r\n}\r\n\r\nexport interface StreamErrorHandlerOptions {\r\n  logger?: Pick<Logger, \"debug\" | \"warn\">;\r\n  onIgnorable?: (error: Error, info: StreamErrorInfo) => void;\r\n  onUnexpected?: (error: Error, info: StreamErrorInfo) => void;\r\n}\r\n\r\nexport function attachStreamErrorHandler(\r\n  emitter: NodeJS.EventEmitter,\r\n  label: string,\r\n  options: StreamErrorHandlerOptions = {}\r\n): () => void {\r\n  const handler = (error: unknown) => {\r\n    const normalized = normalizeError(error);\r\n    const info: StreamErrorInfo = {\r\n      label,\r\n      code: getErrorCode(error),\r\n      message: normalized.message,\r\n    };\r\n\r\n    if (isIgnorableStreamError(error)) {\r\n      options.logger?.debug(\"Ignored stream error\", info, normalized);\r\n      options.onIgnorable?.(normalized, info);\r\n      return;\r\n    }\r\n\r\n    options.logger?.warn(\"Stream error\", info, normalized);\r\n    options.onUnexpected?.(normalized, info);\r\n  };\r\n\r\n  emitter.on(\"error\", handler);\r\n\r\n  return () => {\r\n    emitter.removeListener(\"error\", handler);\r\n  };\r\n}\r\n"]}