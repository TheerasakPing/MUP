{"version":3,"file":"providerRequirements.js","sourceRoot":"","sources":["../../../src/node/utils/providerRequirements.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Provider credential resolution - single source of truth for provider authentication.\n *\n * Used by:\n * - providerService.ts: UI status (isConfigured flag for frontend)\n * - aiService.ts: runtime credential resolution before making API calls\n * - CLI bootstrap: buildProvidersFromEnv() to create initial providers.jsonc\n */\n\nimport { PROVIDER_DEFINITIONS, type ProviderName } from \"@/common/constants/providers\";\nimport type { ProviderConfig, ProvidersConfig } from \"@/node/config\";\nimport { parseCodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\n\n// ============================================================================\n// Environment variable mappings - single source of truth\n// ============================================================================\n\n/** Env var names for each provider credential type (checked in order, first non-empty wins) */\nexport const PROVIDER_ENV_VARS: Partial<\n  Record<\n    ProviderName,\n    {\n      apiKey?: string[];\n      baseUrl?: string[];\n      organization?: string[];\n      region?: string[];\n    }\n  >\n> = {\n  anthropic: {\n    apiKey: [\"ANTHROPIC_API_KEY\", \"ANTHROPIC_AUTH_TOKEN\"],\n    baseUrl: [\"ANTHROPIC_BASE_URL\"],\n  },\n  openai: {\n    apiKey: [\"OPENAI_API_KEY\"],\n    baseUrl: [\"OPENAI_BASE_URL\", \"OPENAI_API_BASE\"],\n    organization: [\"OPENAI_ORG_ID\"],\n  },\n  google: {\n    apiKey: [\"GOOGLE_GENERATIVE_AI_API_KEY\", \"GOOGLE_API_KEY\"],\n    baseUrl: [\"GOOGLE_BASE_URL\"],\n  },\n  xai: {\n    apiKey: [\"XAI_API_KEY\"],\n    baseUrl: [\"XAI_BASE_URL\"],\n  },\n  openrouter: {\n    apiKey: [\"OPENROUTER_API_KEY\"],\n  },\n  deepseek: {\n    apiKey: [\"DEEPSEEK_API_KEY\"],\n  },\n  \"github-copilot\": {\n    apiKey: [\"GITHUB_COPILOT_TOKEN\"],\n  },\n  bedrock: {\n    region: [\"AWS_REGION\", \"AWS_DEFAULT_REGION\"],\n  },\n};\n\n/** Azure OpenAI env vars (special case: maps to \"openai\" provider) */\nexport const AZURE_OPENAI_ENV_VARS = {\n  apiKey: \"AZURE_OPENAI_API_KEY\",\n  endpoint: \"AZURE_OPENAI_ENDPOINT\",\n  deployment: \"AZURE_OPENAI_DEPLOYMENT\",\n  apiVersion: \"AZURE_OPENAI_API_VERSION\",\n};\n\n/** Resolve first non-empty env var from a list of candidates */\nfunction resolveEnv(\n  keys: string[] | undefined,\n  env: Record<string, string | undefined>\n): string | undefined {\n  for (const key of keys ?? []) {\n    const val = env[key]?.trim();\n    if (val) return val;\n  }\n  return undefined;\n}\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/** Raw provider config shape (subset of providers.jsonc entry) */\nexport interface ProviderConfigRaw {\n  apiKey?: string;\n  baseUrl?: string;\n  baseURL?: string; // Anthropic uses baseURL\n  models?: string[];\n  region?: string;\n  bearerToken?: string;\n  accessKeyId?: string;\n  secretAccessKey?: string;\n  couponCode?: string;\n  voucher?: string; // legacy mux-gateway field\n  organization?: string; // OpenAI org ID\n}\n\n/** Result of resolving provider credentials */\nexport interface ResolvedCredentials {\n  isConfigured: boolean;\n  /** What's missing, if not configured (for error messages) */\n  missingRequirement?: \"api_key\" | \"region\" | \"coupon_code\";\n\n  // Resolved credential values - aiService uses these directly\n  apiKey?: string; // anthropic, openai, etc.\n  region?: string; // bedrock\n  couponCode?: string; // mux-gateway\n  baseUrl?: string; // from config or env\n  organization?: string; // openai\n}\n\n/** Legacy alias for backward compatibility */\nexport type ProviderConfigCheck = Pick<ResolvedCredentials, \"isConfigured\" | \"missingRequirement\">;\n\n// ============================================================================\n// Credential resolution\n// ============================================================================\n\n/**\n * Resolve provider credentials from config and environment.\n * Returns both configuration status AND resolved credential values.\n *\n * @param provider - Provider name\n * @param config - Raw config from providers.jsonc (or empty object)\n * @param env - Environment variables (defaults to process.env)\n */\nexport function resolveProviderCredentials(\n  provider: ProviderName,\n  config: ProviderConfigRaw,\n  env: Record<string, string | undefined> = process.env\n): ResolvedCredentials {\n  // Bedrock: region required (credentials via AWS SDK chain)\n  if (provider === \"bedrock\") {\n    const configRegion = typeof config.region === \"string\" && config.region ? config.region : null;\n    const region = configRegion ?? resolveEnv(PROVIDER_ENV_VARS.bedrock?.region, env);\n    return region\n      ? { isConfigured: true, region }\n      : { isConfigured: false, missingRequirement: \"region\" };\n  }\n\n  // Mux Gateway: coupon code required (no env var support)\n  if (provider === \"mux-gateway\") {\n    const couponCode = config.couponCode ?? config.voucher;\n    return couponCode\n      ? { isConfigured: true, couponCode }\n      : { isConfigured: false, missingRequirement: \"coupon_code\" };\n  }\n\n  // Keyless providers (e.g., ollama): require explicit opt-in via baseUrl or models\n  const def = PROVIDER_DEFINITIONS[provider];\n  if (!def.requiresApiKey) {\n    const hasExplicitConfig = Boolean(config.baseUrl ?? (config.models?.length ?? 0) > 0);\n    return { isConfigured: hasExplicitConfig };\n  }\n\n  // Standard API key providers: check config first, then env vars\n  const envMapping = PROVIDER_ENV_VARS[provider];\n  // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing -- empty string should be treated as unset\n  const configKey = config.apiKey || null;\n  const apiKey = configKey ?? resolveEnv(envMapping?.apiKey, env);\n  const baseUrl = config.baseURL ?? config.baseUrl ?? resolveEnv(envMapping?.baseUrl, env);\n  // Config organization takes precedence over env var (user's explicit choice)\n  const organization = config.organization ?? resolveEnv(envMapping?.organization, env);\n\n  if (apiKey) {\n    return { isConfigured: true, apiKey, baseUrl, organization };\n  }\n\n  return { isConfigured: false, missingRequirement: \"api_key\" };\n}\n\n/**\n * Check if a provider is configured (has necessary credentials).\n * Convenience wrapper around resolveProviderCredentials for UI status checks.\n */\nexport function checkProviderConfigured(\n  provider: ProviderName,\n  config: ProviderConfigRaw,\n  env: Record<string, string | undefined> = process.env\n): ProviderConfigCheck {\n  const { isConfigured, missingRequirement } = resolveProviderCredentials(provider, config, env);\n  return { isConfigured, missingRequirement };\n}\n\n// ============================================================================\n// Bootstrap: build providers config from environment variables\n// ============================================================================\n\n/**\n * Build a ProvidersConfig from environment variables.\n * Used during CLI bootstrap when no providers.jsonc exists.\n *\n * @param env - Environment variables (defaults to process.env)\n * @returns ProvidersConfig with all providers that have credentials in env\n */\nexport function buildProvidersFromEnv(\n  env: Record<string, string | undefined> = process.env\n): ProvidersConfig {\n  const providers: ProvidersConfig = {};\n\n  // Check each provider that has env var mappings\n  for (const provider of Object.keys(PROVIDER_ENV_VARS) as ProviderName[]) {\n    // Skip bedrock - it uses AWS credential chain, not simple API key\n    if (provider === \"bedrock\") continue;\n\n    const creds = resolveProviderCredentials(provider, {}, env);\n    if (creds.isConfigured && creds.apiKey) {\n      const entry: ProviderConfig = { apiKey: creds.apiKey };\n      if (creds.baseUrl) entry.baseUrl = creds.baseUrl;\n      if (creds.organization) entry.organization = creds.organization;\n      providers[provider] = entry;\n    }\n  }\n\n  // Azure OpenAI special case: maps to \"openai\" provider if not already set\n  if (!providers.openai) {\n    const azureKey = env[AZURE_OPENAI_ENV_VARS.apiKey]?.trim();\n    const azureEndpoint = env[AZURE_OPENAI_ENV_VARS.endpoint]?.trim();\n\n    if (azureKey && azureEndpoint) {\n      const entry: ProviderConfig = {\n        apiKey: azureKey,\n        baseUrl: azureEndpoint,\n      };\n\n      const deployment = env[AZURE_OPENAI_ENV_VARS.deployment]?.trim();\n      if (deployment) entry.defaultModel = deployment;\n\n      const apiVersion = env[AZURE_OPENAI_ENV_VARS.apiVersion]?.trim();\n      if (apiVersion) entry.apiVersion = apiVersion;\n\n      providers.openai = entry;\n    }\n  }\n\n  return providers;\n}\n\n/**\n * Check whether any provider is configured well enough for the CLI to start.\n *\n * This intentionally mirrors runtime/provider status checks instead of only\n * looking for API keys so keyless providers (e.g. Ollama) and OpenAI Codex\n * OAuth-only setups are treated as valid.\n */\nexport function hasAnyConfiguredProvider(providers: ProvidersConfig | null | undefined): boolean {\n  if (!providers) return false;\n\n  for (const [providerKey, rawConfig] of Object.entries(providers)) {\n    if (!rawConfig || typeof rawConfig !== \"object\") {\n      continue;\n    }\n\n    // OpenAI Codex OAuth is a valid credential path even without apiKey.\n    if (\n      providerKey === \"openai\" &&\n      parseCodexOauthAuth((rawConfig as { codexOauth?: unknown }).codexOauth) !== null\n    ) {\n      return true;\n    }\n\n    if (!(providerKey in PROVIDER_DEFINITIONS)) {\n      // Be permissive for unknown providers written by future versions.\n      const apiKey = (rawConfig as { apiKey?: unknown }).apiKey;\n      if (typeof apiKey === \"string\" && apiKey.trim().length > 0) {\n        return true;\n      }\n      continue;\n    }\n\n    if (\n      checkProviderConfigured(providerKey as ProviderName, rawConfig as ProviderConfigRaw)\n        .isConfigured\n    ) {\n      return true;\n    }\n  }\n\n  return false;\n}\n"]}