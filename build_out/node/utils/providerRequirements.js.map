{"version":3,"file":"providerRequirements.js","sourceRoot":"","sources":["../../../src/node/utils/providerRequirements.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Provider credential resolution - single source of truth for provider authentication.\r\n *\r\n * Used by:\r\n * - providerService.ts: UI status (isConfigured flag for frontend)\r\n * - aiService.ts: runtime credential resolution before making API calls\r\n * - CLI bootstrap: buildProvidersFromEnv() to create initial providers.jsonc\r\n */\r\n\r\nimport { PROVIDER_DEFINITIONS, type ProviderName } from \"@/common/constants/providers\";\r\nimport type { ProviderConfig, ProvidersConfig } from \"@/node/config\";\r\nimport { parseCodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\r\n\r\n// ============================================================================\r\n// Environment variable mappings - single source of truth\r\n// ============================================================================\r\n\r\n/** Env var names for each provider credential type (checked in order, first non-empty wins) */\r\nexport const PROVIDER_ENV_VARS: Partial<\r\n  Record<\r\n    ProviderName,\r\n    {\r\n      apiKey?: string[];\r\n      baseUrl?: string[];\r\n      organization?: string[];\r\n      region?: string[];\r\n    }\r\n  >\r\n> = {\r\n  anthropic: {\r\n    apiKey: [\"ANTHROPIC_API_KEY\", \"ANTHROPIC_AUTH_TOKEN\"],\r\n    baseUrl: [\"ANTHROPIC_BASE_URL\"],\r\n  },\r\n  openai: {\r\n    apiKey: [\"OPENAI_API_KEY\"],\r\n    baseUrl: [\"OPENAI_BASE_URL\", \"OPENAI_API_BASE\"],\r\n    organization: [\"OPENAI_ORG_ID\"],\r\n  },\r\n  google: {\r\n    apiKey: [\"GOOGLE_GENERATIVE_AI_API_KEY\", \"GOOGLE_API_KEY\"],\r\n    baseUrl: [\"GOOGLE_BASE_URL\"],\r\n  },\r\n  xai: {\r\n    apiKey: [\"XAI_API_KEY\"],\r\n    baseUrl: [\"XAI_BASE_URL\"],\r\n  },\r\n  openrouter: {\r\n    apiKey: [\"OPENROUTER_API_KEY\"],\r\n  },\r\n  deepseek: {\r\n    apiKey: [\"DEEPSEEK_API_KEY\"],\r\n  },\r\n  \"github-copilot\": {\r\n    apiKey: [\"GITHUB_COPILOT_TOKEN\"],\r\n  },\r\n  bedrock: {\r\n    region: [\"AWS_REGION\", \"AWS_DEFAULT_REGION\"],\r\n  },\r\n};\r\n\r\n/** Azure OpenAI env vars (special case: maps to \"openai\" provider) */\r\nexport const AZURE_OPENAI_ENV_VARS = {\r\n  apiKey: \"AZURE_OPENAI_API_KEY\",\r\n  endpoint: \"AZURE_OPENAI_ENDPOINT\",\r\n  deployment: \"AZURE_OPENAI_DEPLOYMENT\",\r\n  apiVersion: \"AZURE_OPENAI_API_VERSION\",\r\n};\r\n\r\n/** Resolve first non-empty env var from a list of candidates */\r\nfunction resolveEnv(\r\n  keys: string[] | undefined,\r\n  env: Record<string, string | undefined>\r\n): string | undefined {\r\n  for (const key of keys ?? []) {\r\n    const val = env[key]?.trim();\r\n    if (val) return val;\r\n  }\r\n  return undefined;\r\n}\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\n/** Raw provider config shape (subset of providers.jsonc entry) */\r\nexport interface ProviderConfigRaw {\r\n  apiKey?: string;\r\n  baseUrl?: string;\r\n  baseURL?: string; // Anthropic uses baseURL\r\n  models?: string[];\r\n  region?: string;\r\n  bearerToken?: string;\r\n  accessKeyId?: string;\r\n  secretAccessKey?: string;\r\n  couponCode?: string;\r\n  voucher?: string; // legacy mux-gateway field\r\n  organization?: string; // OpenAI org ID\r\n}\r\n\r\n/** Result of resolving provider credentials */\r\nexport interface ResolvedCredentials {\r\n  isConfigured: boolean;\r\n  /** What's missing, if not configured (for error messages) */\r\n  missingRequirement?: \"api_key\" | \"region\" | \"coupon_code\";\r\n\r\n  // Resolved credential values - aiService uses these directly\r\n  apiKey?: string; // anthropic, openai, etc.\r\n  region?: string; // bedrock\r\n  couponCode?: string; // mux-gateway\r\n  baseUrl?: string; // from config or env\r\n  organization?: string; // openai\r\n}\r\n\r\n/** Legacy alias for backward compatibility */\r\nexport type ProviderConfigCheck = Pick<ResolvedCredentials, \"isConfigured\" | \"missingRequirement\">;\r\n\r\n// ============================================================================\r\n// Credential resolution\r\n// ============================================================================\r\n\r\n/**\r\n * Resolve provider credentials from config and environment.\r\n * Returns both configuration status AND resolved credential values.\r\n *\r\n * @param provider - Provider name\r\n * @param config - Raw config from providers.jsonc (or empty object)\r\n * @param env - Environment variables (defaults to process.env)\r\n */\r\nexport function resolveProviderCredentials(\r\n  provider: ProviderName,\r\n  config: ProviderConfigRaw,\r\n  env: Record<string, string | undefined> = process.env\r\n): ResolvedCredentials {\r\n  // Bedrock: region required (credentials via AWS SDK chain)\r\n  if (provider === \"bedrock\") {\r\n    const configRegion = typeof config.region === \"string\" && config.region ? config.region : null;\r\n    const region = configRegion ?? resolveEnv(PROVIDER_ENV_VARS.bedrock?.region, env);\r\n    return region\r\n      ? { isConfigured: true, region }\r\n      : { isConfigured: false, missingRequirement: \"region\" };\r\n  }\r\n\r\n  // Mux Gateway: coupon code required (no env var support)\r\n  if (provider === \"mux-gateway\") {\r\n    const couponCode = config.couponCode ?? config.voucher;\r\n    return couponCode\r\n      ? { isConfigured: true, couponCode }\r\n      : { isConfigured: false, missingRequirement: \"coupon_code\" };\r\n  }\r\n\r\n  // Keyless providers (e.g., ollama): require explicit opt-in via baseUrl or models\r\n  const def = PROVIDER_DEFINITIONS[provider];\r\n  if (!def.requiresApiKey) {\r\n    const hasExplicitConfig = Boolean(config.baseUrl ?? (config.models?.length ?? 0) > 0);\r\n    return { isConfigured: hasExplicitConfig };\r\n  }\r\n\r\n  // Standard API key providers: check config first, then env vars\r\n  const envMapping = PROVIDER_ENV_VARS[provider];\r\n  // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing -- empty string should be treated as unset\r\n  const configKey = config.apiKey || null;\r\n  const apiKey = configKey ?? resolveEnv(envMapping?.apiKey, env);\r\n  const baseUrl = config.baseURL ?? config.baseUrl ?? resolveEnv(envMapping?.baseUrl, env);\r\n  // Config organization takes precedence over env var (user's explicit choice)\r\n  const organization = config.organization ?? resolveEnv(envMapping?.organization, env);\r\n\r\n  if (apiKey) {\r\n    return { isConfigured: true, apiKey, baseUrl, organization };\r\n  }\r\n\r\n  return { isConfigured: false, missingRequirement: \"api_key\" };\r\n}\r\n\r\n/**\r\n * Check if a provider is configured (has necessary credentials).\r\n * Convenience wrapper around resolveProviderCredentials for UI status checks.\r\n */\r\nexport function checkProviderConfigured(\r\n  provider: ProviderName,\r\n  config: ProviderConfigRaw,\r\n  env: Record<string, string | undefined> = process.env\r\n): ProviderConfigCheck {\r\n  const { isConfigured, missingRequirement } = resolveProviderCredentials(provider, config, env);\r\n  return { isConfigured, missingRequirement };\r\n}\r\n\r\n// ============================================================================\r\n// Bootstrap: build providers config from environment variables\r\n// ============================================================================\r\n\r\n/**\r\n * Build a ProvidersConfig from environment variables.\r\n * Used during CLI bootstrap when no providers.jsonc exists.\r\n *\r\n * @param env - Environment variables (defaults to process.env)\r\n * @returns ProvidersConfig with all providers that have credentials in env\r\n */\r\nexport function buildProvidersFromEnv(\r\n  env: Record<string, string | undefined> = process.env\r\n): ProvidersConfig {\r\n  const providers: ProvidersConfig = {};\r\n\r\n  // Check each provider that has env var mappings\r\n  for (const provider of Object.keys(PROVIDER_ENV_VARS) as ProviderName[]) {\r\n    // Skip bedrock - it uses AWS credential chain, not simple API key\r\n    if (provider === \"bedrock\") continue;\r\n\r\n    const creds = resolveProviderCredentials(provider, {}, env);\r\n    if (creds.isConfigured && creds.apiKey) {\r\n      const entry: ProviderConfig = { apiKey: creds.apiKey };\r\n      if (creds.baseUrl) entry.baseUrl = creds.baseUrl;\r\n      if (creds.organization) entry.organization = creds.organization;\r\n      providers[provider] = entry;\r\n    }\r\n  }\r\n\r\n  // Azure OpenAI special case: maps to \"openai\" provider if not already set\r\n  if (!providers.openai) {\r\n    const azureKey = env[AZURE_OPENAI_ENV_VARS.apiKey]?.trim();\r\n    const azureEndpoint = env[AZURE_OPENAI_ENV_VARS.endpoint]?.trim();\r\n\r\n    if (azureKey && azureEndpoint) {\r\n      const entry: ProviderConfig = {\r\n        apiKey: azureKey,\r\n        baseUrl: azureEndpoint,\r\n      };\r\n\r\n      const deployment = env[AZURE_OPENAI_ENV_VARS.deployment]?.trim();\r\n      if (deployment) entry.defaultModel = deployment;\r\n\r\n      const apiVersion = env[AZURE_OPENAI_ENV_VARS.apiVersion]?.trim();\r\n      if (apiVersion) entry.apiVersion = apiVersion;\r\n\r\n      providers.openai = entry;\r\n    }\r\n  }\r\n\r\n  return providers;\r\n}\r\n\r\n/**\r\n * Check whether any provider is configured well enough for the CLI to start.\r\n *\r\n * This intentionally mirrors runtime/provider status checks instead of only\r\n * looking for API keys so keyless providers (e.g. Ollama) and OpenAI Codex\r\n * OAuth-only setups are treated as valid.\r\n */\r\nexport function hasAnyConfiguredProvider(providers: ProvidersConfig | null | undefined): boolean {\r\n  if (!providers) return false;\r\n\r\n  for (const [providerKey, rawConfig] of Object.entries(providers)) {\r\n    if (!rawConfig || typeof rawConfig !== \"object\") {\r\n      continue;\r\n    }\r\n\r\n    // OpenAI Codex OAuth is a valid credential path even without apiKey.\r\n    if (\r\n      providerKey === \"openai\" &&\r\n      parseCodexOauthAuth((rawConfig as { codexOauth?: unknown }).codexOauth) !== null\r\n    ) {\r\n      return true;\r\n    }\r\n\r\n    if (!(providerKey in PROVIDER_DEFINITIONS)) {\r\n      // Be permissive for unknown providers written by future versions.\r\n      const apiKey = (rawConfig as { apiKey?: unknown }).apiKey;\r\n      if (typeof apiKey === \"string\" && apiKey.trim().length > 0) {\r\n        return true;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    if (\r\n      checkProviderConfigured(providerKey as ProviderName, rawConfig as ProviderConfigRaw)\r\n        .isConfigured\r\n    ) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n"]}