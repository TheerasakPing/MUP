{"version":3,"file":"WorktreeManager.test.js","sourceRoot":"","sources":["../../../src/node/worktree/WorktreeManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport { execSync } from \"node:child_process\";\r\nimport type { InitLogger } from \"@/node/runtime/Runtime\";\r\nimport { WorktreeManager } from \"./WorktreeManager\";\r\n\r\nfunction initGitRepo(projectPath: string): void {\r\n  execSync(\"git init -b main\", { cwd: projectPath, stdio: \"ignore\" });\r\n  execSync('git config user.email \"test@example.com\"', { cwd: projectPath, stdio: \"ignore\" });\r\n  execSync('git config user.name \"test\"', { cwd: projectPath, stdio: \"ignore\" });\r\n  // Ensure tests don't hang when developers have global commit signing enabled.\r\n  execSync(\"git config commit.gpgsign false\", { cwd: projectPath, stdio: \"ignore\" });\r\n  execSync(\"bash -lc 'echo \\\"hello\\\" > README.md'\", { cwd: projectPath, stdio: \"ignore\" });\r\n  execSync(\"git add README.md\", { cwd: projectPath, stdio: \"ignore\" });\r\n  execSync('git commit -m \"init\"', { cwd: projectPath, stdio: \"ignore\" });\r\n}\r\n\r\nfunction createNullInitLogger(): InitLogger {\r\n  return {\r\n    logStep: (_message: string) => undefined,\r\n    logStdout: (_line: string) => undefined,\r\n    logStderr: (_line: string) => undefined,\r\n    logComplete: (_exitCode: number) => undefined,\r\n  };\r\n}\r\n\r\ndescribe(\"WorktreeManager constructor\", () => {\r\n  it(\"should expand tilde in srcBaseDir\", () => {\r\n    const manager = new WorktreeManager(\"~/workspace\");\r\n    const workspacePath = manager.getWorkspacePath(\"/home/user/project\", \"branch\");\r\n\r\n    // The workspace path should use the expanded home directory\r\n    const expected = path.join(os.homedir(), \"workspace\", \"project\", \"branch\");\r\n    expect(workspacePath).toBe(expected);\r\n  });\r\n\r\n  it(\"should handle absolute paths without expansion\", () => {\r\n    const manager = new WorktreeManager(\"/absolute/path\");\r\n    const workspacePath = manager.getWorkspacePath(\"/home/user/project\", \"branch\");\r\n\r\n    const expected = path.join(\"/absolute/path\", \"project\", \"branch\");\r\n    expect(workspacePath).toBe(expected);\r\n  });\r\n\r\n  it(\"should handle bare tilde\", () => {\r\n    const manager = new WorktreeManager(\"~\");\r\n    const workspacePath = manager.getWorkspacePath(\"/home/user/project\", \"branch\");\r\n\r\n    const expected = path.join(os.homedir(), \"project\", \"branch\");\r\n    expect(workspacePath).toBe(expected);\r\n  });\r\n});\r\n\r\ndescribe(\"WorktreeManager.deleteWorkspace\", () => {\r\n  it(\"deletes non-agent branches when removing worktrees (force)\", async () => {\r\n    const rootDir = await fsPromises.realpath(\r\n      await fsPromises.mkdtemp(path.join(os.tmpdir(), \"worktree-manager-delete-\"))\r\n    );\r\n\r\n    try {\r\n      const projectPath = path.join(rootDir, \"repo\");\r\n      await fsPromises.mkdir(projectPath, { recursive: true });\r\n      initGitRepo(projectPath);\r\n\r\n      const srcBaseDir = path.join(rootDir, \"src\");\r\n      await fsPromises.mkdir(srcBaseDir, { recursive: true });\r\n\r\n      const manager = new WorktreeManager(srcBaseDir);\r\n      const initLogger = createNullInitLogger();\r\n\r\n      const branchName = \"feature_aaaaaaaaaa\";\r\n      const createResult = await manager.createWorkspace({\r\n        projectPath,\r\n        branchName,\r\n        trunkBranch: \"main\",\r\n        initLogger,\r\n      });\r\n      expect(createResult.success).toBe(true);\r\n      if (!createResult.success) return;\r\n      if (!createResult.workspacePath) {\r\n        throw new Error(\"Expected workspacePath from createWorkspace\");\r\n      }\r\n      const workspacePath = createResult.workspacePath;\r\n\r\n      // Make the branch unmerged (so -d would fail); force delete should still delete it.\r\n      execSync(\"bash -lc 'echo \\\"change\\\" >> README.md'\", {\r\n        cwd: workspacePath,\r\n        stdio: \"ignore\",\r\n      });\r\n      execSync(\"git add README.md\", { cwd: workspacePath, stdio: \"ignore\" });\r\n      execSync('git commit -m \"change\"', { cwd: workspacePath, stdio: \"ignore\" });\r\n\r\n      const deleteResult = await manager.deleteWorkspace(projectPath, branchName, true);\r\n      expect(deleteResult.success).toBe(true);\r\n\r\n      const after = execSync(`git branch --list \"${branchName}\"`, {\r\n        cwd: projectPath,\r\n        stdio: [\"ignore\", \"pipe\", \"ignore\"],\r\n      })\r\n        .toString()\r\n        .trim();\r\n      expect(after).toBe(\"\");\r\n    } finally {\r\n      await fsPromises.rm(rootDir, { recursive: true, force: true });\r\n    }\r\n  }, 20_000);\r\n\r\n  it(\"deletes merged branches when removing worktrees (safe delete)\", async () => {\r\n    const rootDir = await fsPromises.realpath(\r\n      await fsPromises.mkdtemp(path.join(os.tmpdir(), \"worktree-manager-delete-\"))\r\n    );\r\n\r\n    try {\r\n      const projectPath = path.join(rootDir, \"repo\");\r\n      await fsPromises.mkdir(projectPath, { recursive: true });\r\n      initGitRepo(projectPath);\r\n\r\n      const srcBaseDir = path.join(rootDir, \"src\");\r\n      await fsPromises.mkdir(srcBaseDir, { recursive: true });\r\n\r\n      const manager = new WorktreeManager(srcBaseDir);\r\n      const initLogger = createNullInitLogger();\r\n\r\n      const branchName = \"feature_merge_aaaaaaaaaa\";\r\n      const createResult = await manager.createWorkspace({\r\n        projectPath,\r\n        branchName,\r\n        trunkBranch: \"main\",\r\n        initLogger,\r\n      });\r\n      expect(createResult.success).toBe(true);\r\n      if (!createResult.success) return;\r\n      if (!createResult.workspacePath) {\r\n        throw new Error(\"Expected workspacePath from createWorkspace\");\r\n      }\r\n      const workspacePath = createResult.workspacePath;\r\n\r\n      // Commit on the workspace branch.\r\n      execSync(\"bash -lc 'echo \\\"merged-change\\\" >> README.md'\", {\r\n        cwd: workspacePath,\r\n        stdio: \"ignore\",\r\n      });\r\n      execSync(\"git add README.md\", { cwd: workspacePath, stdio: \"ignore\" });\r\n      execSync('git commit -m \"merged-change\"', {\r\n        cwd: workspacePath,\r\n        stdio: \"ignore\",\r\n      });\r\n\r\n      // Merge into main so `git branch -d` succeeds.\r\n      execSync(`git merge \"${branchName}\"`, { cwd: projectPath, stdio: \"ignore\" });\r\n\r\n      const deleteResult = await manager.deleteWorkspace(projectPath, branchName, false);\r\n      expect(deleteResult.success).toBe(true);\r\n\r\n      const after = execSync(`git branch --list \"${branchName}\"`, {\r\n        cwd: projectPath,\r\n        stdio: [\"ignore\", \"pipe\", \"ignore\"],\r\n      })\r\n        .toString()\r\n        .trim();\r\n      expect(after).toBe(\"\");\r\n    } finally {\r\n      await fsPromises.rm(rootDir, { recursive: true, force: true });\r\n    }\r\n  }, 20_000);\r\n\r\n  it(\"does not delete protected branches\", async () => {\r\n    const rootDir = await fsPromises.realpath(\r\n      await fsPromises.mkdtemp(path.join(os.tmpdir(), \"worktree-manager-delete-\"))\r\n    );\r\n\r\n    try {\r\n      const projectPath = path.join(rootDir, \"repo\");\r\n      await fsPromises.mkdir(projectPath, { recursive: true });\r\n      initGitRepo(projectPath);\r\n\r\n      // Move the main worktree off main so we can add a separate worktree on main.\r\n      execSync(\"git checkout -b other\", { cwd: projectPath, stdio: \"ignore\" });\r\n\r\n      const srcBaseDir = path.join(rootDir, \"src\");\r\n      await fsPromises.mkdir(srcBaseDir, { recursive: true });\r\n\r\n      const manager = new WorktreeManager(srcBaseDir);\r\n      const initLogger = createNullInitLogger();\r\n\r\n      const branchName = \"main\";\r\n      const createResult = await manager.createWorkspace({\r\n        projectPath,\r\n        branchName,\r\n        trunkBranch: \"main\",\r\n        initLogger,\r\n      });\r\n      expect(createResult.success).toBe(true);\r\n      if (!createResult.success) return;\r\n      if (!createResult.workspacePath) {\r\n        throw new Error(\"Expected workspacePath from createWorkspace\");\r\n      }\r\n      const workspacePath = createResult.workspacePath;\r\n\r\n      const deleteResult = await manager.deleteWorkspace(projectPath, branchName, true);\r\n      expect(deleteResult.success).toBe(true);\r\n\r\n      // The worktree directory should be removed.\r\n      let worktreeExists = true;\r\n      try {\r\n        await fsPromises.access(workspacePath);\r\n      } catch {\r\n        worktreeExists = false;\r\n      }\r\n      expect(worktreeExists).toBe(false);\r\n\r\n      // But protected branches (like main) should never be deleted.\r\n      const after = execSync(`git branch --list \"${branchName}\"`, {\r\n        cwd: projectPath,\r\n        stdio: [\"ignore\", \"pipe\", \"ignore\"],\r\n      })\r\n        .toString()\r\n        .trim();\r\n      expect(after).toBe(\"main\");\r\n    } finally {\r\n      await fsPromises.rm(rootDir, { recursive: true, force: true });\r\n    }\r\n  }, 20_000);\r\n});\r\n"]}