{"version":3,"file":"codexOauthService.js","sourceRoot":"","sources":["../../../src/node/services/codexOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as crypto from \"crypto\";\r\nimport * as http from \"http\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Err, Ok } from \"@/common/types/result\";\r\nimport {\r\n  buildCodexAuthorizeUrl,\r\n  buildCodexRefreshBody,\r\n  buildCodexTokenExchangeBody,\r\n  CODEX_OAUTH_BROWSER_REDIRECT_URI,\r\n  CODEX_OAUTH_CLIENT_ID,\r\n  CODEX_OAUTH_DEVICE_TOKEN_POLL_URL,\r\n  CODEX_OAUTH_DEVICE_USERCODE_URL,\r\n  CODEX_OAUTH_DEVICE_VERIFY_URL,\r\n  CODEX_OAUTH_TOKEN_URL,\r\n} from \"@/common/constants/codexOAuth\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { ProviderService } from \"@/node/services/providerService\";\r\nimport type { WindowService } from \"@/node/services/windowService\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { AsyncMutex } from \"@/node/utils/concurrency/asyncMutex\";\r\nimport {\r\n  extractChatGptAccountIdFromTokens,\r\n  isCodexOauthAuthExpired,\r\n  parseCodexOauthAuth,\r\n  type CodexOauthAuth,\r\n} from \"@/node/utils/codexOauthAuth\";\r\n\r\nconst DEFAULT_DESKTOP_TIMEOUT_MS = 5 * 60 * 1000;\r\nconst DEFAULT_DEVICE_TIMEOUT_MS = 15 * 60 * 1000;\r\nconst COMPLETED_FLOW_TTL_MS = 60 * 1000;\r\n\r\ninterface DesktopFlow {\r\n  flowId: string;\r\n  authorizeUrl: string;\r\n  redirectUri: string;\r\n  codeVerifier: string;\r\n\r\n  server: http.Server;\r\n  timeout: ReturnType<typeof setTimeout>;\r\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\r\n\r\n  resultPromise: Promise<Result<void, string>>;\r\n  resolveResult: (result: Result<void, string>) => void;\r\n  settled: boolean;\r\n}\r\n\r\ninterface DeviceFlow {\r\n  flowId: string;\r\n  deviceAuthId: string;\r\n  userCode: string;\r\n  verifyUrl: string;\r\n  intervalSeconds: number;\r\n  expiresAtMs: number;\r\n\r\n  abortController: AbortController;\r\n  pollingStarted: boolean;\r\n\r\n  timeout: ReturnType<typeof setTimeout>;\r\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\r\n\r\n  resultPromise: Promise<Result<void, string>>;\r\n  resolveResult: (result: Result<void, string>) => void;\r\n  settled: boolean;\r\n}\r\n\r\nfunction closeServer(server: http.Server): Promise<void> {\r\n  return new Promise((resolve) => {\r\n    server.close(() => resolve());\r\n  });\r\n}\r\n\r\nfunction createDeferred<T>(): { promise: Promise<T>; resolve: (value: T) => void } {\r\n  let resolve!: (value: T) => void;\r\n  const promise = new Promise<T>((res) => {\r\n    resolve = res;\r\n  });\r\n  return { promise, resolve };\r\n}\r\n\r\nfunction sha256Base64Url(value: string): string {\r\n  return crypto.createHash(\"sha256\").update(value).digest().toString(\"base64url\");\r\n}\r\n\r\nfunction randomBase64Url(bytes = 32): string {\r\n  return crypto.randomBytes(bytes).toString(\"base64url\");\r\n}\r\n\r\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\r\n  return Boolean(value) && typeof value === \"object\" && !Array.isArray(value);\r\n}\r\n\r\nfunction isLoopbackAddress(address: string | undefined): boolean {\r\n  if (!address) return false;\r\n\r\n  // Node may normalize IPv4 loopback to an IPv6-mapped address.\r\n  if (address === \"::ffff:127.0.0.1\") {\r\n    return true;\r\n  }\r\n\r\n  return address === \"127.0.0.1\" || address === \"::1\";\r\n}\r\n\r\nfunction parseOptionalNumber(value: unknown): number | null {\r\n  if (typeof value === \"number\" && Number.isFinite(value)) {\r\n    return value;\r\n  }\r\n\r\n  if (typeof value === \"string\") {\r\n    const n = Number(value);\r\n    return Number.isFinite(n) ? n : null;\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction isInvalidGrantError(errorText: string): boolean {\r\n  const trimmed = errorText.trim();\r\n  if (trimmed.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const json = JSON.parse(trimmed) as unknown;\r\n    if (isPlainObject(json) && json.error === \"invalid_grant\") {\r\n      return true;\r\n    }\r\n  } catch {\r\n    // Ignore parse failures - fall back to substring checks.\r\n  }\r\n\r\n  const lower = trimmed.toLowerCase();\r\n  return lower.includes(\"invalid_grant\") || lower.includes(\"revoked\");\r\n}\r\n\r\nexport class CodexOauthService {\r\n  private readonly desktopFlows = new Map<string, DesktopFlow>();\r\n  private readonly deviceFlows = new Map<string, DeviceFlow>();\r\n\r\n  private readonly refreshMutex = new AsyncMutex();\r\n\r\n  // In-memory cache so getValidAuth() skips disk reads when tokens are valid.\r\n  // Invalidated on every write (exchange, refresh, disconnect).\r\n  private cachedAuth: CodexOauthAuth | null = null;\r\n\r\n  constructor(\r\n    private readonly config: Config,\r\n    private readonly providerService: ProviderService,\r\n    private readonly windowService?: WindowService\r\n  ) {}\r\n\r\n  disconnect(): Result<void, string> {\r\n    // Clear stored ChatGPT OAuth tokens so Codex-only models are hidden again.\r\n    this.cachedAuth = null;\r\n    return this.providerService.setConfigValue(\"openai\", [\"codexOauth\"], undefined);\r\n  }\r\n\r\n  async startDesktopFlow(): Promise<Result<{ flowId: string; authorizeUrl: string }, string>> {\r\n    const flowId = randomBase64Url();\r\n\r\n    const codeVerifier = randomBase64Url();\r\n    const codeChallenge = sha256Base64Url(codeVerifier);\r\n\r\n    const { promise: resultPromise, resolve: resolveResult } =\r\n      createDeferred<Result<void, string>>();\r\n\r\n    const redirectUri = CODEX_OAUTH_BROWSER_REDIRECT_URI;\r\n\r\n    const server = http.createServer((req, res) => {\r\n      if (!isLoopbackAddress(req.socket.remoteAddress)) {\r\n        res.statusCode = 403;\r\n        res.end(\"Forbidden\");\r\n        return;\r\n      }\r\n\r\n      const reqUrl = req.url ?? \"/\";\r\n      const url = new URL(reqUrl, \"http://localhost\");\r\n\r\n      if (req.method !== \"GET\" || url.pathname !== \"/auth/callback\") {\r\n        res.statusCode = 404;\r\n        res.end(\"Not found\");\r\n        return;\r\n      }\r\n\r\n      const state = url.searchParams.get(\"state\");\r\n      if (!state || state !== flowId) {\r\n        res.statusCode = 400;\r\n        res.setHeader(\"Content-Type\", \"text/html\");\r\n        res.end(\"<h1>Invalid OAuth state</h1>\");\r\n        return;\r\n      }\r\n\r\n      const code = url.searchParams.get(\"code\");\r\n      const error = url.searchParams.get(\"error\");\r\n      const errorDescription = url.searchParams.get(\"error_description\") ?? undefined;\r\n\r\n      void this.handleDesktopCallback({\r\n        flowId,\r\n        code,\r\n        error,\r\n        errorDescription,\r\n        res,\r\n      });\r\n    });\r\n\r\n    try {\r\n      await new Promise<void>((resolve, reject) => {\r\n        server.once(\"error\", reject);\r\n        server.listen(1455, \"localhost\", () => resolve());\r\n      });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to start OAuth callback listener: ${message}`);\r\n    }\r\n\r\n    const authorizeUrl = buildCodexAuthorizeUrl({\r\n      redirectUri,\r\n      state: flowId,\r\n      codeChallenge,\r\n    });\r\n\r\n    const timeout = setTimeout(() => {\r\n      void this.finishDesktopFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\r\n    }, DEFAULT_DESKTOP_TIMEOUT_MS);\r\n\r\n    this.desktopFlows.set(flowId, {\r\n      flowId,\r\n      authorizeUrl,\r\n      redirectUri,\r\n      codeVerifier,\r\n      server,\r\n      timeout,\r\n      cleanupTimeout: null,\r\n      resultPromise,\r\n      resolveResult,\r\n      settled: false,\r\n    });\r\n\r\n    log.debug(`[Codex OAuth] Desktop flow started (flowId=${flowId})`);\r\n\r\n    return Ok({ flowId, authorizeUrl });\r\n  }\r\n\r\n  async waitForDesktopFlow(\r\n    flowId: string,\r\n    opts?: { timeoutMs?: number }\r\n  ): Promise<Result<void, string>> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow) {\r\n      return Err(\"OAuth flow not found\");\r\n    }\r\n\r\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DESKTOP_TIMEOUT_MS;\r\n\r\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\r\n      timeoutHandle = setTimeout(() => {\r\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\r\n      }, timeoutMs);\r\n    });\r\n\r\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\r\n\r\n    if (timeoutHandle !== null) {\r\n      clearTimeout(timeoutHandle);\r\n    }\r\n\r\n    if (!result.success) {\r\n      // Ensure listener is closed on timeout/errors.\r\n      void this.finishDesktopFlow(flowId, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  async cancelDesktopFlow(flowId: string): Promise<void> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow) return;\r\n\r\n    log.debug(`[Codex OAuth] Desktop flow cancelled (flowId=${flowId})`);\r\n    await this.finishDesktopFlow(flowId, Err(\"OAuth flow cancelled\"));\r\n  }\r\n\r\n  async startDeviceFlow(): Promise<\r\n    Result<\r\n      {\r\n        flowId: string;\r\n        userCode: string;\r\n        verifyUrl: string;\r\n        intervalSeconds: number;\r\n      },\r\n      string\r\n    >\r\n  > {\r\n    const flowId = randomBase64Url();\r\n\r\n    const deviceAuthResult = await this.requestDeviceUserCode();\r\n    if (!deviceAuthResult.success) {\r\n      return Err(deviceAuthResult.error);\r\n    }\r\n\r\n    const { deviceAuthId, userCode, intervalSeconds, expiresAtMs } = deviceAuthResult.data;\r\n    const verifyUrl = CODEX_OAUTH_DEVICE_VERIFY_URL;\r\n\r\n    const { promise: resultPromise, resolve: resolveResult } =\r\n      createDeferred<Result<void, string>>();\r\n\r\n    const abortController = new AbortController();\r\n\r\n    const timeoutMs = Math.min(DEFAULT_DEVICE_TIMEOUT_MS, Math.max(0, expiresAtMs - Date.now()));\r\n    const timeout = setTimeout(() => {\r\n      void this.finishDeviceFlow(flowId, Err(\"Device code expired\"));\r\n    }, timeoutMs);\r\n\r\n    this.deviceFlows.set(flowId, {\r\n      flowId,\r\n      deviceAuthId,\r\n      userCode,\r\n      verifyUrl,\r\n      intervalSeconds,\r\n      expiresAtMs,\r\n      abortController,\r\n      pollingStarted: false,\r\n      timeout,\r\n      cleanupTimeout: null,\r\n      resultPromise,\r\n      resolveResult,\r\n      settled: false,\r\n    });\r\n\r\n    log.debug(`[Codex OAuth] Device flow started (flowId=${flowId})`);\r\n\r\n    return Ok({ flowId, userCode, verifyUrl, intervalSeconds });\r\n  }\r\n\r\n  async waitForDeviceFlow(\r\n    flowId: string,\r\n    opts?: { timeoutMs?: number }\r\n  ): Promise<Result<void, string>> {\r\n    const flow = this.deviceFlows.get(flowId);\r\n    if (!flow) {\r\n      return Err(\"OAuth flow not found\");\r\n    }\r\n\r\n    if (!flow.pollingStarted) {\r\n      flow.pollingStarted = true;\r\n      this.pollDeviceFlow(flowId).catch((error) => {\r\n        // The polling loop is responsible for resolving the flow; if we reach\r\n        // here something unexpected happened.\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        log.warn(`[Codex OAuth] Device polling crashed (flowId=${flowId}): ${message}`);\r\n        void this.finishDeviceFlow(flowId, Err(`Device polling crashed: ${message}`));\r\n      });\r\n    }\r\n\r\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DEVICE_TIMEOUT_MS;\r\n\r\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\r\n      timeoutHandle = setTimeout(() => {\r\n        resolve(Err(\"Timed out waiting for device authorization\"));\r\n      }, timeoutMs);\r\n    });\r\n\r\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\r\n\r\n    if (timeoutHandle !== null) {\r\n      clearTimeout(timeoutHandle);\r\n    }\r\n\r\n    if (!result.success) {\r\n      // Ensure polling is cancelled on timeout/errors.\r\n      void this.finishDeviceFlow(flowId, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  async cancelDeviceFlow(flowId: string): Promise<void> {\r\n    const flow = this.deviceFlows.get(flowId);\r\n    if (!flow) return;\r\n\r\n    log.debug(`[Codex OAuth] Device flow cancelled (flowId=${flowId})`);\r\n    await this.finishDeviceFlow(flowId, Err(\"OAuth flow cancelled\"));\r\n  }\r\n\r\n  async getValidAuth(): Promise<Result<CodexOauthAuth, string>> {\r\n    const stored = this.readStoredAuth();\r\n    if (!stored) {\r\n      return Err(\"Codex OAuth is not configured\");\r\n    }\r\n\r\n    if (!isCodexOauthAuthExpired(stored)) {\r\n      return Ok(stored);\r\n    }\r\n\r\n    await using _lock = await this.refreshMutex.acquire();\r\n\r\n    // Re-read after acquiring lock in case another caller refreshed first.\r\n    const latest = this.readStoredAuth();\r\n    if (!latest) {\r\n      return Err(\"Codex OAuth is not configured\");\r\n    }\r\n\r\n    if (!isCodexOauthAuthExpired(latest)) {\r\n      return Ok(latest);\r\n    }\r\n\r\n    const refreshed = await this.refreshTokens(latest);\r\n    if (!refreshed.success) {\r\n      return Err(refreshed.error);\r\n    }\r\n\r\n    return Ok(refreshed.data);\r\n  }\r\n\r\n  async dispose(): Promise<void> {\r\n    const desktopIds = [...this.desktopFlows.keys()];\r\n    await Promise.all(desktopIds.map((id) => this.finishDesktopFlow(id, Err(\"App shutting down\"))));\r\n\r\n    const deviceIds = [...this.deviceFlows.keys()];\r\n    await Promise.all(deviceIds.map((id) => this.finishDeviceFlow(id, Err(\"App shutting down\"))));\r\n\r\n    for (const flow of this.desktopFlows.values()) {\r\n      clearTimeout(flow.timeout);\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n    }\r\n\r\n    for (const flow of this.deviceFlows.values()) {\r\n      clearTimeout(flow.timeout);\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n    }\r\n\r\n    this.desktopFlows.clear();\r\n    this.deviceFlows.clear();\r\n  }\r\n\r\n  private readStoredAuth(): CodexOauthAuth | null {\r\n    if (this.cachedAuth) {\r\n      return this.cachedAuth;\r\n    }\r\n    const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n    const openaiConfig = providersConfig.openai as Record<string, unknown> | undefined;\r\n    const auth = parseCodexOauthAuth(openaiConfig?.codexOauth);\r\n    this.cachedAuth = auth;\r\n    return auth;\r\n  }\r\n\r\n  private persistAuth(auth: CodexOauthAuth): Result<void, string> {\r\n    const result = this.providerService.setConfigValue(\"openai\", [\"codexOauth\"], auth);\r\n    // Invalidate cache so the next readStoredAuth() picks up the persisted value from disk.\r\n    // We clear rather than set because setConfigValue may have side-effects (e.g. file-write\r\n    // failures) and we want the next read to be authoritative.\r\n    this.cachedAuth = null;\r\n    return result;\r\n  }\r\n\r\n  private async handleDesktopCallback(input: {\r\n    flowId: string;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n    res: http.ServerResponse;\r\n  }): Promise<void> {\r\n    const flow = this.desktopFlows.get(input.flowId);\r\n    if (!flow || flow.settled) {\r\n      input.res.statusCode = 409;\r\n      input.res.setHeader(\"Content-Type\", \"text/html\");\r\n      input.res.end(\"<h1>OAuth flow already completed</h1>\");\r\n      return;\r\n    }\r\n\r\n    log.debug(`[Codex OAuth] Desktop callback received (flowId=${input.flowId})`);\r\n\r\n    const result = await this.handleDesktopCallbackAndExchange({\r\n      flowId: input.flowId,\r\n      redirectUri: flow.redirectUri,\r\n      codeVerifier: flow.codeVerifier,\r\n      code: input.code,\r\n      error: input.error,\r\n      errorDescription: input.errorDescription,\r\n    });\r\n\r\n    const title = result.success ? \"Login complete\" : \"Login failed\";\r\n    const description = result.success\r\n      ? \"You can return to Mux. You may now close this tab.\"\r\n      : escapeHtml(result.error);\r\n\r\n    input.res.setHeader(\"Content-Type\", \"text/html\");\r\n    if (!result.success) {\r\n      input.res.statusCode = 400;\r\n    }\r\n\r\n    input.res.end(`<!doctype html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <meta name=\"color-scheme\" content=\"dark light\" />\r\n    <title>${title}</title>\r\n  </head>\r\n  <body>\r\n    <h1>${title}</h1>\r\n    <p>${description}</p>\r\n    <script>\r\n      (() => {\r\n        const ok = ${result.success ? \"true\" : \"false\"};\r\n        if (!ok) return;\r\n        try { window.close(); } catch {}\r\n        setTimeout(() => { try { window.close(); } catch {} }, 50);\r\n      })();\r\n    </script>\r\n  </body>\r\n</html>`);\r\n\r\n    await this.finishDesktopFlow(input.flowId, result);\r\n  }\r\n\r\n  private async handleDesktopCallbackAndExchange(input: {\r\n    flowId: string;\r\n    redirectUri: string;\r\n    codeVerifier: string;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n  }): Promise<Result<void, string>> {\r\n    if (input.error) {\r\n      const message = input.errorDescription\r\n        ? `${input.error}: ${input.errorDescription}`\r\n        : input.error;\r\n      return Err(`Codex OAuth error: ${message}`);\r\n    }\r\n\r\n    if (!input.code) {\r\n      return Err(\"Missing OAuth code\");\r\n    }\r\n\r\n    const tokenResult = await this.exchangeCodeForTokens({\r\n      code: input.code,\r\n      redirectUri: input.redirectUri,\r\n      codeVerifier: input.codeVerifier,\r\n    });\r\n    if (!tokenResult.success) {\r\n      return Err(tokenResult.error);\r\n    }\r\n\r\n    const persistResult = this.persistAuth(tokenResult.data);\r\n    if (!persistResult.success) {\r\n      return Err(persistResult.error);\r\n    }\r\n\r\n    log.debug(`[Codex OAuth] Desktop exchange completed (flowId=${input.flowId})`);\r\n\r\n    this.windowService?.focusMainWindow();\r\n\r\n    return Ok(undefined);\r\n  }\r\n\r\n  private async exchangeCodeForTokens(input: {\r\n    code: string;\r\n    redirectUri: string;\r\n    codeVerifier: string;\r\n  }): Promise<Result<CodexOauthAuth, string>> {\r\n    try {\r\n      const response = await fetch(CODEX_OAUTH_TOKEN_URL, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n        body: buildCodexTokenExchangeBody({\r\n          code: input.code,\r\n          redirectUri: input.redirectUri,\r\n          codeVerifier: input.codeVerifier,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text().catch(() => \"\");\r\n        const prefix = `Codex OAuth exchange failed (${response.status})`;\r\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\r\n      }\r\n\r\n      const json = (await response.json()) as unknown;\r\n      if (!isPlainObject(json)) {\r\n        return Err(\"Codex OAuth exchange returned an invalid JSON payload\");\r\n      }\r\n\r\n      const accessToken = typeof json.access_token === \"string\" ? json.access_token : null;\r\n      const refreshToken = typeof json.refresh_token === \"string\" ? json.refresh_token : null;\r\n      const expiresIn = parseOptionalNumber(json.expires_in);\r\n      const idToken = typeof json.id_token === \"string\" ? json.id_token : undefined;\r\n\r\n      if (!accessToken) {\r\n        return Err(\"Codex OAuth exchange response missing access_token\");\r\n      }\r\n\r\n      if (!refreshToken) {\r\n        return Err(\"Codex OAuth exchange response missing refresh_token\");\r\n      }\r\n\r\n      if (expiresIn === null) {\r\n        return Err(\"Codex OAuth exchange response missing expires_in\");\r\n      }\r\n\r\n      const accountId = extractChatGptAccountIdFromTokens({ accessToken, idToken }) ?? undefined;\r\n\r\n      return Ok({\r\n        type: \"oauth\",\r\n        access: accessToken,\r\n        refresh: refreshToken,\r\n        expires: Date.now() + Math.max(0, Math.floor(expiresIn * 1000)),\r\n        accountId,\r\n      });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Codex OAuth exchange failed: ${message}`);\r\n    }\r\n  }\r\n\r\n  private async refreshTokens(current: CodexOauthAuth): Promise<Result<CodexOauthAuth, string>> {\r\n    try {\r\n      const response = await fetch(CODEX_OAUTH_TOKEN_URL, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n        body: buildCodexRefreshBody({ refreshToken: current.refresh }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text().catch(() => \"\");\r\n\r\n        // When the refresh token is invalid/revoked, clear persisted auth so subsequent\r\n        // requests fall back to the existing \"not connected\" behavior.\r\n        if (isInvalidGrantError(errorText)) {\r\n          log.debug(\"[Codex OAuth] Refresh token rejected; clearing stored auth\");\r\n          const disconnectResult = this.disconnect();\r\n          if (!disconnectResult.success) {\r\n            log.warn(\r\n              `[Codex OAuth] Failed to clear stored auth after refresh failure: ${disconnectResult.error}`\r\n            );\r\n          }\r\n        }\r\n\r\n        const prefix = `Codex OAuth refresh failed (${response.status})`;\r\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\r\n      }\r\n\r\n      const json = (await response.json()) as unknown;\r\n      if (!isPlainObject(json)) {\r\n        return Err(\"Codex OAuth refresh returned an invalid JSON payload\");\r\n      }\r\n\r\n      const accessToken = typeof json.access_token === \"string\" ? json.access_token : null;\r\n      const refreshToken = typeof json.refresh_token === \"string\" ? json.refresh_token : null;\r\n      const expiresIn = parseOptionalNumber(json.expires_in);\r\n      const idToken = typeof json.id_token === \"string\" ? json.id_token : undefined;\r\n\r\n      if (!accessToken) {\r\n        return Err(\"Codex OAuth refresh response missing access_token\");\r\n      }\r\n\r\n      if (expiresIn === null) {\r\n        return Err(\"Codex OAuth refresh response missing expires_in\");\r\n      }\r\n\r\n      const accountId =\r\n        extractChatGptAccountIdFromTokens({ accessToken, idToken }) ?? current.accountId;\r\n\r\n      const next: CodexOauthAuth = {\r\n        type: \"oauth\",\r\n        access: accessToken,\r\n        refresh: refreshToken ?? current.refresh,\r\n        expires: Date.now() + Math.max(0, Math.floor(expiresIn * 1000)),\r\n        accountId,\r\n      };\r\n\r\n      const persistResult = this.persistAuth(next);\r\n      if (!persistResult.success) {\r\n        return Err(persistResult.error);\r\n      }\r\n\r\n      return Ok(next);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Codex OAuth refresh failed: ${message}`);\r\n    }\r\n  }\r\n\r\n  private async requestDeviceUserCode(): Promise<\r\n    Result<\r\n      {\r\n        deviceAuthId: string;\r\n        userCode: string;\r\n        intervalSeconds: number;\r\n        expiresAtMs: number;\r\n      },\r\n      string\r\n    >\r\n  > {\r\n    try {\r\n      const response = await fetch(CODEX_OAUTH_DEVICE_USERCODE_URL, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ client_id: CODEX_OAUTH_CLIENT_ID }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text().catch(() => \"\");\r\n        const prefix = `Codex OAuth device auth request failed (${response.status})`;\r\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\r\n      }\r\n\r\n      const json = (await response.json()) as unknown;\r\n      if (!isPlainObject(json)) {\r\n        return Err(\"Codex OAuth device auth response returned an invalid JSON payload\");\r\n      }\r\n\r\n      const deviceAuthId = typeof json.device_auth_id === \"string\" ? json.device_auth_id : null;\r\n      const userCode = typeof json.user_code === \"string\" ? json.user_code : null;\r\n      const interval = parseOptionalNumber(json.interval);\r\n      const expiresIn = parseOptionalNumber(json.expires_in);\r\n\r\n      if (!deviceAuthId || !userCode) {\r\n        return Err(\"Codex OAuth device auth response missing required fields\");\r\n      }\r\n\r\n      const intervalSeconds = interval !== null ? Math.max(1, Math.floor(interval)) : 5;\r\n      const expiresAtMs =\r\n        expiresIn !== null\r\n          ? Date.now() + Math.max(0, Math.floor(expiresIn * 1000))\r\n          : Date.now() + DEFAULT_DEVICE_TIMEOUT_MS;\r\n\r\n      return Ok({ deviceAuthId, userCode, intervalSeconds, expiresAtMs });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Codex OAuth device auth request failed: ${message}`);\r\n    }\r\n  }\r\n\r\n  private async pollDeviceFlow(flowId: string): Promise<void> {\r\n    const flow = this.deviceFlows.get(flowId);\r\n    if (!flow || flow.settled) {\r\n      return;\r\n    }\r\n\r\n    const intervalSeconds = flow.intervalSeconds;\r\n\r\n    while (Date.now() < flow.expiresAtMs) {\r\n      if (flow.abortController.signal.aborted) {\r\n        await this.finishDeviceFlow(flowId, Err(\"OAuth flow cancelled\"));\r\n        return;\r\n      }\r\n\r\n      const attempt = await this.pollDeviceTokenOnce(flow);\r\n      if (attempt.kind === \"success\") {\r\n        const persistResult = this.persistAuth(attempt.auth);\r\n        if (!persistResult.success) {\r\n          await this.finishDeviceFlow(flowId, Err(persistResult.error));\r\n          return;\r\n        }\r\n\r\n        log.debug(`[Codex OAuth] Device authorization completed (flowId=${flowId})`);\r\n        this.windowService?.focusMainWindow();\r\n        await this.finishDeviceFlow(flowId, Ok(undefined));\r\n        return;\r\n      }\r\n\r\n      if (attempt.kind === \"fatal\") {\r\n        await this.finishDeviceFlow(flowId, Err(attempt.message));\r\n        return;\r\n      }\r\n\r\n      try {\r\n        // OpenCode guide: intervalSeconds * 1000 + 3000\r\n        await sleepWithAbort(intervalSeconds * 1000 + 3000, flow.abortController.signal);\r\n      } catch {\r\n        // Abort is handled via cancelDeviceFlow()/finishDeviceFlow().\r\n        return;\r\n      }\r\n    }\r\n\r\n    await this.finishDeviceFlow(flowId, Err(\"Device code expired\"));\r\n  }\r\n\r\n  private async pollDeviceTokenOnce(\r\n    flow: DeviceFlow\r\n  ): Promise<\r\n    | { kind: \"success\"; auth: CodexOauthAuth }\r\n    | { kind: \"pending\" }\r\n    | { kind: \"fatal\"; message: string }\r\n  > {\r\n    try {\r\n      const response = await fetch(CODEX_OAUTH_DEVICE_TOKEN_POLL_URL, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ device_auth_id: flow.deviceAuthId, user_code: flow.userCode }),\r\n        signal: flow.abortController.signal,\r\n      });\r\n\r\n      if (response.status === 403 || response.status === 404) {\r\n        return { kind: \"pending\" };\r\n      }\r\n\r\n      if (response.status !== 200) {\r\n        const errorText = await response.text().catch(() => \"\");\r\n        const prefix = `Codex OAuth device token poll failed (${response.status})`;\r\n        return { kind: \"fatal\", message: errorText ? `${prefix}: ${errorText}` : prefix };\r\n      }\r\n\r\n      const json = (await response.json().catch(() => null)) as unknown;\r\n      if (!isPlainObject(json)) {\r\n        return { kind: \"fatal\", message: \"Codex OAuth device token poll returned invalid JSON\" };\r\n      }\r\n\r\n      const authorizationCode =\r\n        typeof json.authorization_code === \"string\" ? json.authorization_code : null;\r\n      const codeVerifier = typeof json.code_verifier === \"string\" ? json.code_verifier : null;\r\n\r\n      if (!authorizationCode || !codeVerifier) {\r\n        return {\r\n          kind: \"fatal\",\r\n          message: \"Codex OAuth device token poll response missing required fields\",\r\n        };\r\n      }\r\n\r\n      const tokenResult = await this.exchangeCodeForTokens({\r\n        code: authorizationCode,\r\n        redirectUri: \"https://auth.openai.com/deviceauth/callback\",\r\n        codeVerifier,\r\n      });\r\n\r\n      if (!tokenResult.success) {\r\n        return { kind: \"fatal\", message: tokenResult.error };\r\n      }\r\n\r\n      return { kind: \"success\", auth: tokenResult.data };\r\n    } catch (error) {\r\n      // Abort is treated as cancellation.\r\n      if (flow.abortController.signal.aborted) {\r\n        return { kind: \"fatal\", message: \"OAuth flow cancelled\" };\r\n      }\r\n\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return { kind: \"fatal\", message: `Device authorization failed: ${message}` };\r\n    }\r\n  }\r\n\r\n  private async finishDesktopFlow(flowId: string, result: Result<void, string>): Promise<void> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow || flow.settled) return;\r\n\r\n    flow.settled = true;\r\n    clearTimeout(flow.timeout);\r\n\r\n    try {\r\n      flow.resolveResult(result);\r\n      await closeServer(flow.server);\r\n    } catch (error) {\r\n      log.debug(\"[Codex OAuth] Failed to close OAuth callback listener:\", error);\r\n    } finally {\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n      flow.cleanupTimeout = setTimeout(() => {\r\n        this.desktopFlows.delete(flowId);\r\n      }, COMPLETED_FLOW_TTL_MS);\r\n    }\r\n  }\r\n\r\n  private finishDeviceFlow(flowId: string, result: Result<void, string>): Promise<void> {\r\n    const flow = this.deviceFlows.get(flowId);\r\n    if (!flow || flow.settled) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    flow.settled = true;\r\n    clearTimeout(flow.timeout);\r\n    flow.abortController.abort();\r\n\r\n    try {\r\n      flow.resolveResult(result);\r\n    } finally {\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n      flow.cleanupTimeout = setTimeout(() => {\r\n        this.deviceFlows.delete(flowId);\r\n      }, COMPLETED_FLOW_TTL_MS);\r\n    }\r\n\r\n    return Promise.resolve();\r\n  }\r\n}\r\n\r\nasync function sleepWithAbort(ms: number, signal: AbortSignal): Promise<void> {\r\n  if (ms <= 0) {\r\n    return;\r\n  }\r\n\r\n  if (signal.aborted) {\r\n    throw new Error(\"aborted\");\r\n  }\r\n\r\n  await new Promise<void>((resolve, reject) => {\r\n    const timeout = setTimeout(() => {\r\n      cleanup();\r\n      resolve();\r\n    }, ms);\r\n\r\n    const onAbort = () => {\r\n      cleanup();\r\n      reject(new Error(\"aborted\"));\r\n    };\r\n\r\n    const cleanup = () => {\r\n      clearTimeout(timeout);\r\n      signal.removeEventListener(\"abort\", onAbort);\r\n    };\r\n\r\n    signal.addEventListener(\"abort\", onAbort);\r\n  });\r\n}\r\n\r\nfunction escapeHtml(input: string): string {\r\n  return input\r\n    .replaceAll(\"&\", \"&amp;\")\r\n    .replaceAll(\"<\", \"&lt;\")\r\n    .replaceAll(\">\", \"&gt;\")\r\n    .replaceAll('\"', \"&quot;\")\r\n    .replaceAll(\"'\", \"&#39;\");\r\n}\r\n"]}