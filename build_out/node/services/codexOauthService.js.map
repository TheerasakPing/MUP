{"version":3,"file":"codexOauthService.js","sourceRoot":"","sources":["../../../src/node/services/codexOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as crypto from \"crypto\";\nimport * as http from \"http\";\nimport type { Result } from \"@/common/types/result\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport {\n  buildCodexAuthorizeUrl,\n  buildCodexRefreshBody,\n  buildCodexTokenExchangeBody,\n  CODEX_OAUTH_BROWSER_REDIRECT_URI,\n  CODEX_OAUTH_CLIENT_ID,\n  CODEX_OAUTH_DEVICE_TOKEN_POLL_URL,\n  CODEX_OAUTH_DEVICE_USERCODE_URL,\n  CODEX_OAUTH_DEVICE_VERIFY_URL,\n  CODEX_OAUTH_TOKEN_URL,\n} from \"@/common/constants/codexOAuth\";\nimport type { Config } from \"@/node/config\";\nimport type { ProviderService } from \"@/node/services/providerService\";\nimport type { WindowService } from \"@/node/services/windowService\";\nimport { log } from \"@/node/services/log\";\nimport { AsyncMutex } from \"@/node/utils/concurrency/asyncMutex\";\nimport {\n  extractChatGptAccountIdFromTokens,\n  isCodexOauthAuthExpired,\n  parseCodexOauthAuth,\n  type CodexOauthAuth,\n} from \"@/node/utils/codexOauthAuth\";\n\nconst DEFAULT_DESKTOP_TIMEOUT_MS = 5 * 60 * 1000;\nconst DEFAULT_DEVICE_TIMEOUT_MS = 15 * 60 * 1000;\nconst COMPLETED_FLOW_TTL_MS = 60 * 1000;\n\ninterface DesktopFlow {\n  flowId: string;\n  authorizeUrl: string;\n  redirectUri: string;\n  codeVerifier: string;\n\n  server: http.Server;\n  timeout: ReturnType<typeof setTimeout>;\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\n\n  resultPromise: Promise<Result<void, string>>;\n  resolveResult: (result: Result<void, string>) => void;\n  settled: boolean;\n}\n\ninterface DeviceFlow {\n  flowId: string;\n  deviceAuthId: string;\n  userCode: string;\n  verifyUrl: string;\n  intervalSeconds: number;\n  expiresAtMs: number;\n\n  abortController: AbortController;\n  pollingStarted: boolean;\n\n  timeout: ReturnType<typeof setTimeout>;\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\n\n  resultPromise: Promise<Result<void, string>>;\n  resolveResult: (result: Result<void, string>) => void;\n  settled: boolean;\n}\n\nfunction closeServer(server: http.Server): Promise<void> {\n  return new Promise((resolve) => {\n    server.close(() => resolve());\n  });\n}\n\nfunction createDeferred<T>(): { promise: Promise<T>; resolve: (value: T) => void } {\n  let resolve!: (value: T) => void;\n  const promise = new Promise<T>((res) => {\n    resolve = res;\n  });\n  return { promise, resolve };\n}\n\nfunction sha256Base64Url(value: string): string {\n  return crypto.createHash(\"sha256\").update(value).digest().toString(\"base64url\");\n}\n\nfunction randomBase64Url(bytes = 32): string {\n  return crypto.randomBytes(bytes).toString(\"base64url\");\n}\n\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\n  return Boolean(value) && typeof value === \"object\" && !Array.isArray(value);\n}\n\nfunction isLoopbackAddress(address: string | undefined): boolean {\n  if (!address) return false;\n\n  // Node may normalize IPv4 loopback to an IPv6-mapped address.\n  if (address === \"::ffff:127.0.0.1\") {\n    return true;\n  }\n\n  return address === \"127.0.0.1\" || address === \"::1\";\n}\n\nfunction parseOptionalNumber(value: unknown): number | null {\n  if (typeof value === \"number\" && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === \"string\") {\n    const n = Number(value);\n    return Number.isFinite(n) ? n : null;\n  }\n\n  return null;\n}\n\nfunction isInvalidGrantError(errorText: string): boolean {\n  const trimmed = errorText.trim();\n  if (trimmed.length === 0) {\n    return false;\n  }\n\n  try {\n    const json = JSON.parse(trimmed) as unknown;\n    if (isPlainObject(json) && json.error === \"invalid_grant\") {\n      return true;\n    }\n  } catch {\n    // Ignore parse failures - fall back to substring checks.\n  }\n\n  const lower = trimmed.toLowerCase();\n  return lower.includes(\"invalid_grant\") || lower.includes(\"revoked\");\n}\n\nexport class CodexOauthService {\n  private readonly desktopFlows = new Map<string, DesktopFlow>();\n  private readonly deviceFlows = new Map<string, DeviceFlow>();\n\n  private readonly refreshMutex = new AsyncMutex();\n\n  // In-memory cache so getValidAuth() skips disk reads when tokens are valid.\n  // Invalidated on every write (exchange, refresh, disconnect).\n  private cachedAuth: CodexOauthAuth | null = null;\n\n  constructor(\n    private readonly config: Config,\n    private readonly providerService: ProviderService,\n    private readonly windowService?: WindowService\n  ) {}\n\n  disconnect(): Result<void, string> {\n    // Clear stored ChatGPT OAuth tokens so Codex-only models are hidden again.\n    this.cachedAuth = null;\n    return this.providerService.setConfigValue(\"openai\", [\"codexOauth\"], undefined);\n  }\n\n  async startDesktopFlow(): Promise<Result<{ flowId: string; authorizeUrl: string }, string>> {\n    const flowId = randomBase64Url();\n\n    const codeVerifier = randomBase64Url();\n    const codeChallenge = sha256Base64Url(codeVerifier);\n\n    const { promise: resultPromise, resolve: resolveResult } =\n      createDeferred<Result<void, string>>();\n\n    const redirectUri = CODEX_OAUTH_BROWSER_REDIRECT_URI;\n\n    const server = http.createServer((req, res) => {\n      if (!isLoopbackAddress(req.socket.remoteAddress)) {\n        res.statusCode = 403;\n        res.end(\"Forbidden\");\n        return;\n      }\n\n      const reqUrl = req.url ?? \"/\";\n      const url = new URL(reqUrl, \"http://localhost\");\n\n      if (req.method !== \"GET\" || url.pathname !== \"/auth/callback\") {\n        res.statusCode = 404;\n        res.end(\"Not found\");\n        return;\n      }\n\n      const state = url.searchParams.get(\"state\");\n      if (!state || state !== flowId) {\n        res.statusCode = 400;\n        res.setHeader(\"Content-Type\", \"text/html\");\n        res.end(\"<h1>Invalid OAuth state</h1>\");\n        return;\n      }\n\n      const code = url.searchParams.get(\"code\");\n      const error = url.searchParams.get(\"error\");\n      const errorDescription = url.searchParams.get(\"error_description\") ?? undefined;\n\n      void this.handleDesktopCallback({\n        flowId,\n        code,\n        error,\n        errorDescription,\n        res,\n      });\n    });\n\n    try {\n      await new Promise<void>((resolve, reject) => {\n        server.once(\"error\", reject);\n        server.listen(1455, \"localhost\", () => resolve());\n      });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Failed to start OAuth callback listener: ${message}`);\n    }\n\n    const authorizeUrl = buildCodexAuthorizeUrl({\n      redirectUri,\n      state: flowId,\n      codeChallenge,\n    });\n\n    const timeout = setTimeout(() => {\n      void this.finishDesktopFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\n    }, DEFAULT_DESKTOP_TIMEOUT_MS);\n\n    this.desktopFlows.set(flowId, {\n      flowId,\n      authorizeUrl,\n      redirectUri,\n      codeVerifier,\n      server,\n      timeout,\n      cleanupTimeout: null,\n      resultPromise,\n      resolveResult,\n      settled: false,\n    });\n\n    log.debug(`[Codex OAuth] Desktop flow started (flowId=${flowId})`);\n\n    return Ok({ flowId, authorizeUrl });\n  }\n\n  async waitForDesktopFlow(\n    flowId: string,\n    opts?: { timeoutMs?: number }\n  ): Promise<Result<void, string>> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow) {\n      return Err(\"OAuth flow not found\");\n    }\n\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DESKTOP_TIMEOUT_MS;\n\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\n      timeoutHandle = setTimeout(() => {\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\n      }, timeoutMs);\n    });\n\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\n\n    if (timeoutHandle !== null) {\n      clearTimeout(timeoutHandle);\n    }\n\n    if (!result.success) {\n      // Ensure listener is closed on timeout/errors.\n      void this.finishDesktopFlow(flowId, result);\n    }\n\n    return result;\n  }\n\n  async cancelDesktopFlow(flowId: string): Promise<void> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow) return;\n\n    log.debug(`[Codex OAuth] Desktop flow cancelled (flowId=${flowId})`);\n    await this.finishDesktopFlow(flowId, Err(\"OAuth flow cancelled\"));\n  }\n\n  async startDeviceFlow(): Promise<\n    Result<\n      {\n        flowId: string;\n        userCode: string;\n        verifyUrl: string;\n        intervalSeconds: number;\n      },\n      string\n    >\n  > {\n    const flowId = randomBase64Url();\n\n    const deviceAuthResult = await this.requestDeviceUserCode();\n    if (!deviceAuthResult.success) {\n      return Err(deviceAuthResult.error);\n    }\n\n    const { deviceAuthId, userCode, intervalSeconds, expiresAtMs } = deviceAuthResult.data;\n    const verifyUrl = CODEX_OAUTH_DEVICE_VERIFY_URL;\n\n    const { promise: resultPromise, resolve: resolveResult } =\n      createDeferred<Result<void, string>>();\n\n    const abortController = new AbortController();\n\n    const timeoutMs = Math.min(DEFAULT_DEVICE_TIMEOUT_MS, Math.max(0, expiresAtMs - Date.now()));\n    const timeout = setTimeout(() => {\n      void this.finishDeviceFlow(flowId, Err(\"Device code expired\"));\n    }, timeoutMs);\n\n    this.deviceFlows.set(flowId, {\n      flowId,\n      deviceAuthId,\n      userCode,\n      verifyUrl,\n      intervalSeconds,\n      expiresAtMs,\n      abortController,\n      pollingStarted: false,\n      timeout,\n      cleanupTimeout: null,\n      resultPromise,\n      resolveResult,\n      settled: false,\n    });\n\n    log.debug(`[Codex OAuth] Device flow started (flowId=${flowId})`);\n\n    return Ok({ flowId, userCode, verifyUrl, intervalSeconds });\n  }\n\n  async waitForDeviceFlow(\n    flowId: string,\n    opts?: { timeoutMs?: number }\n  ): Promise<Result<void, string>> {\n    const flow = this.deviceFlows.get(flowId);\n    if (!flow) {\n      return Err(\"OAuth flow not found\");\n    }\n\n    if (!flow.pollingStarted) {\n      flow.pollingStarted = true;\n      this.pollDeviceFlow(flowId).catch((error) => {\n        // The polling loop is responsible for resolving the flow; if we reach\n        // here something unexpected happened.\n        const message = error instanceof Error ? error.message : String(error);\n        log.warn(`[Codex OAuth] Device polling crashed (flowId=${flowId}): ${message}`);\n        void this.finishDeviceFlow(flowId, Err(`Device polling crashed: ${message}`));\n      });\n    }\n\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DEVICE_TIMEOUT_MS;\n\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\n      timeoutHandle = setTimeout(() => {\n        resolve(Err(\"Timed out waiting for device authorization\"));\n      }, timeoutMs);\n    });\n\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\n\n    if (timeoutHandle !== null) {\n      clearTimeout(timeoutHandle);\n    }\n\n    if (!result.success) {\n      // Ensure polling is cancelled on timeout/errors.\n      void this.finishDeviceFlow(flowId, result);\n    }\n\n    return result;\n  }\n\n  async cancelDeviceFlow(flowId: string): Promise<void> {\n    const flow = this.deviceFlows.get(flowId);\n    if (!flow) return;\n\n    log.debug(`[Codex OAuth] Device flow cancelled (flowId=${flowId})`);\n    await this.finishDeviceFlow(flowId, Err(\"OAuth flow cancelled\"));\n  }\n\n  async getValidAuth(): Promise<Result<CodexOauthAuth, string>> {\n    const stored = this.readStoredAuth();\n    if (!stored) {\n      return Err(\"Codex OAuth is not configured\");\n    }\n\n    if (!isCodexOauthAuthExpired(stored)) {\n      return Ok(stored);\n    }\n\n    await using _lock = await this.refreshMutex.acquire();\n\n    // Re-read after acquiring lock in case another caller refreshed first.\n    const latest = this.readStoredAuth();\n    if (!latest) {\n      return Err(\"Codex OAuth is not configured\");\n    }\n\n    if (!isCodexOauthAuthExpired(latest)) {\n      return Ok(latest);\n    }\n\n    const refreshed = await this.refreshTokens(latest);\n    if (!refreshed.success) {\n      return Err(refreshed.error);\n    }\n\n    return Ok(refreshed.data);\n  }\n\n  async dispose(): Promise<void> {\n    const desktopIds = [...this.desktopFlows.keys()];\n    await Promise.all(desktopIds.map((id) => this.finishDesktopFlow(id, Err(\"App shutting down\"))));\n\n    const deviceIds = [...this.deviceFlows.keys()];\n    await Promise.all(deviceIds.map((id) => this.finishDeviceFlow(id, Err(\"App shutting down\"))));\n\n    for (const flow of this.desktopFlows.values()) {\n      clearTimeout(flow.timeout);\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n    }\n\n    for (const flow of this.deviceFlows.values()) {\n      clearTimeout(flow.timeout);\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n    }\n\n    this.desktopFlows.clear();\n    this.deviceFlows.clear();\n  }\n\n  private readStoredAuth(): CodexOauthAuth | null {\n    if (this.cachedAuth) {\n      return this.cachedAuth;\n    }\n    const providersConfig = this.config.loadProvidersConfig() ?? {};\n    const openaiConfig = providersConfig.openai as Record<string, unknown> | undefined;\n    const auth = parseCodexOauthAuth(openaiConfig?.codexOauth);\n    this.cachedAuth = auth;\n    return auth;\n  }\n\n  private persistAuth(auth: CodexOauthAuth): Result<void, string> {\n    const result = this.providerService.setConfigValue(\"openai\", [\"codexOauth\"], auth);\n    // Invalidate cache so the next readStoredAuth() picks up the persisted value from disk.\n    // We clear rather than set because setConfigValue may have side-effects (e.g. file-write\n    // failures) and we want the next read to be authoritative.\n    this.cachedAuth = null;\n    return result;\n  }\n\n  private async handleDesktopCallback(input: {\n    flowId: string;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n    res: http.ServerResponse;\n  }): Promise<void> {\n    const flow = this.desktopFlows.get(input.flowId);\n    if (!flow || flow.settled) {\n      input.res.statusCode = 409;\n      input.res.setHeader(\"Content-Type\", \"text/html\");\n      input.res.end(\"<h1>OAuth flow already completed</h1>\");\n      return;\n    }\n\n    log.debug(`[Codex OAuth] Desktop callback received (flowId=${input.flowId})`);\n\n    const result = await this.handleDesktopCallbackAndExchange({\n      flowId: input.flowId,\n      redirectUri: flow.redirectUri,\n      codeVerifier: flow.codeVerifier,\n      code: input.code,\n      error: input.error,\n      errorDescription: input.errorDescription,\n    });\n\n    const title = result.success ? \"Login complete\" : \"Login failed\";\n    const description = result.success\n      ? \"You can return to Mux. You may now close this tab.\"\n      : escapeHtml(result.error);\n\n    input.res.setHeader(\"Content-Type\", \"text/html\");\n    if (!result.success) {\n      input.res.statusCode = 400;\n    }\n\n    input.res.end(`<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"dark light\" />\n    <title>${title}</title>\n  </head>\n  <body>\n    <h1>${title}</h1>\n    <p>${description}</p>\n    <script>\n      (() => {\n        const ok = ${result.success ? \"true\" : \"false\"};\n        if (!ok) return;\n        try { window.close(); } catch {}\n        setTimeout(() => { try { window.close(); } catch {} }, 50);\n      })();\n    </script>\n  </body>\n</html>`);\n\n    await this.finishDesktopFlow(input.flowId, result);\n  }\n\n  private async handleDesktopCallbackAndExchange(input: {\n    flowId: string;\n    redirectUri: string;\n    codeVerifier: string;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n  }): Promise<Result<void, string>> {\n    if (input.error) {\n      const message = input.errorDescription\n        ? `${input.error}: ${input.errorDescription}`\n        : input.error;\n      return Err(`Codex OAuth error: ${message}`);\n    }\n\n    if (!input.code) {\n      return Err(\"Missing OAuth code\");\n    }\n\n    const tokenResult = await this.exchangeCodeForTokens({\n      code: input.code,\n      redirectUri: input.redirectUri,\n      codeVerifier: input.codeVerifier,\n    });\n    if (!tokenResult.success) {\n      return Err(tokenResult.error);\n    }\n\n    const persistResult = this.persistAuth(tokenResult.data);\n    if (!persistResult.success) {\n      return Err(persistResult.error);\n    }\n\n    log.debug(`[Codex OAuth] Desktop exchange completed (flowId=${input.flowId})`);\n\n    this.windowService?.focusMainWindow();\n\n    return Ok(undefined);\n  }\n\n  private async exchangeCodeForTokens(input: {\n    code: string;\n    redirectUri: string;\n    codeVerifier: string;\n  }): Promise<Result<CodexOauthAuth, string>> {\n    try {\n      const response = await fetch(CODEX_OAUTH_TOKEN_URL, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n        body: buildCodexTokenExchangeBody({\n          code: input.code,\n          redirectUri: input.redirectUri,\n          codeVerifier: input.codeVerifier,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => \"\");\n        const prefix = `Codex OAuth exchange failed (${response.status})`;\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\n      }\n\n      const json = (await response.json()) as unknown;\n      if (!isPlainObject(json)) {\n        return Err(\"Codex OAuth exchange returned an invalid JSON payload\");\n      }\n\n      const accessToken = typeof json.access_token === \"string\" ? json.access_token : null;\n      const refreshToken = typeof json.refresh_token === \"string\" ? json.refresh_token : null;\n      const expiresIn = parseOptionalNumber(json.expires_in);\n      const idToken = typeof json.id_token === \"string\" ? json.id_token : undefined;\n\n      if (!accessToken) {\n        return Err(\"Codex OAuth exchange response missing access_token\");\n      }\n\n      if (!refreshToken) {\n        return Err(\"Codex OAuth exchange response missing refresh_token\");\n      }\n\n      if (expiresIn === null) {\n        return Err(\"Codex OAuth exchange response missing expires_in\");\n      }\n\n      const accountId = extractChatGptAccountIdFromTokens({ accessToken, idToken }) ?? undefined;\n\n      return Ok({\n        type: \"oauth\",\n        access: accessToken,\n        refresh: refreshToken,\n        expires: Date.now() + Math.max(0, Math.floor(expiresIn * 1000)),\n        accountId,\n      });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Codex OAuth exchange failed: ${message}`);\n    }\n  }\n\n  private async refreshTokens(current: CodexOauthAuth): Promise<Result<CodexOauthAuth, string>> {\n    try {\n      const response = await fetch(CODEX_OAUTH_TOKEN_URL, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n        body: buildCodexRefreshBody({ refreshToken: current.refresh }),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => \"\");\n\n        // When the refresh token is invalid/revoked, clear persisted auth so subsequent\n        // requests fall back to the existing \"not connected\" behavior.\n        if (isInvalidGrantError(errorText)) {\n          log.debug(\"[Codex OAuth] Refresh token rejected; clearing stored auth\");\n          const disconnectResult = this.disconnect();\n          if (!disconnectResult.success) {\n            log.warn(\n              `[Codex OAuth] Failed to clear stored auth after refresh failure: ${disconnectResult.error}`\n            );\n          }\n        }\n\n        const prefix = `Codex OAuth refresh failed (${response.status})`;\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\n      }\n\n      const json = (await response.json()) as unknown;\n      if (!isPlainObject(json)) {\n        return Err(\"Codex OAuth refresh returned an invalid JSON payload\");\n      }\n\n      const accessToken = typeof json.access_token === \"string\" ? json.access_token : null;\n      const refreshToken = typeof json.refresh_token === \"string\" ? json.refresh_token : null;\n      const expiresIn = parseOptionalNumber(json.expires_in);\n      const idToken = typeof json.id_token === \"string\" ? json.id_token : undefined;\n\n      if (!accessToken) {\n        return Err(\"Codex OAuth refresh response missing access_token\");\n      }\n\n      if (expiresIn === null) {\n        return Err(\"Codex OAuth refresh response missing expires_in\");\n      }\n\n      const accountId =\n        extractChatGptAccountIdFromTokens({ accessToken, idToken }) ?? current.accountId;\n\n      const next: CodexOauthAuth = {\n        type: \"oauth\",\n        access: accessToken,\n        refresh: refreshToken ?? current.refresh,\n        expires: Date.now() + Math.max(0, Math.floor(expiresIn * 1000)),\n        accountId,\n      };\n\n      const persistResult = this.persistAuth(next);\n      if (!persistResult.success) {\n        return Err(persistResult.error);\n      }\n\n      return Ok(next);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Codex OAuth refresh failed: ${message}`);\n    }\n  }\n\n  private async requestDeviceUserCode(): Promise<\n    Result<\n      {\n        deviceAuthId: string;\n        userCode: string;\n        intervalSeconds: number;\n        expiresAtMs: number;\n      },\n      string\n    >\n  > {\n    try {\n      const response = await fetch(CODEX_OAUTH_DEVICE_USERCODE_URL, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ client_id: CODEX_OAUTH_CLIENT_ID }),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => \"\");\n        const prefix = `Codex OAuth device auth request failed (${response.status})`;\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\n      }\n\n      const json = (await response.json()) as unknown;\n      if (!isPlainObject(json)) {\n        return Err(\"Codex OAuth device auth response returned an invalid JSON payload\");\n      }\n\n      const deviceAuthId = typeof json.device_auth_id === \"string\" ? json.device_auth_id : null;\n      const userCode = typeof json.user_code === \"string\" ? json.user_code : null;\n      const interval = parseOptionalNumber(json.interval);\n      const expiresIn = parseOptionalNumber(json.expires_in);\n\n      if (!deviceAuthId || !userCode) {\n        return Err(\"Codex OAuth device auth response missing required fields\");\n      }\n\n      const intervalSeconds = interval !== null ? Math.max(1, Math.floor(interval)) : 5;\n      const expiresAtMs =\n        expiresIn !== null\n          ? Date.now() + Math.max(0, Math.floor(expiresIn * 1000))\n          : Date.now() + DEFAULT_DEVICE_TIMEOUT_MS;\n\n      return Ok({ deviceAuthId, userCode, intervalSeconds, expiresAtMs });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Codex OAuth device auth request failed: ${message}`);\n    }\n  }\n\n  private async pollDeviceFlow(flowId: string): Promise<void> {\n    const flow = this.deviceFlows.get(flowId);\n    if (!flow || flow.settled) {\n      return;\n    }\n\n    const intervalSeconds = flow.intervalSeconds;\n\n    while (Date.now() < flow.expiresAtMs) {\n      if (flow.abortController.signal.aborted) {\n        await this.finishDeviceFlow(flowId, Err(\"OAuth flow cancelled\"));\n        return;\n      }\n\n      const attempt = await this.pollDeviceTokenOnce(flow);\n      if (attempt.kind === \"success\") {\n        const persistResult = this.persistAuth(attempt.auth);\n        if (!persistResult.success) {\n          await this.finishDeviceFlow(flowId, Err(persistResult.error));\n          return;\n        }\n\n        log.debug(`[Codex OAuth] Device authorization completed (flowId=${flowId})`);\n        this.windowService?.focusMainWindow();\n        await this.finishDeviceFlow(flowId, Ok(undefined));\n        return;\n      }\n\n      if (attempt.kind === \"fatal\") {\n        await this.finishDeviceFlow(flowId, Err(attempt.message));\n        return;\n      }\n\n      try {\n        // OpenCode guide: intervalSeconds * 1000 + 3000\n        await sleepWithAbort(intervalSeconds * 1000 + 3000, flow.abortController.signal);\n      } catch {\n        // Abort is handled via cancelDeviceFlow()/finishDeviceFlow().\n        return;\n      }\n    }\n\n    await this.finishDeviceFlow(flowId, Err(\"Device code expired\"));\n  }\n\n  private async pollDeviceTokenOnce(\n    flow: DeviceFlow\n  ): Promise<\n    | { kind: \"success\"; auth: CodexOauthAuth }\n    | { kind: \"pending\" }\n    | { kind: \"fatal\"; message: string }\n  > {\n    try {\n      const response = await fetch(CODEX_OAUTH_DEVICE_TOKEN_POLL_URL, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ device_auth_id: flow.deviceAuthId, user_code: flow.userCode }),\n        signal: flow.abortController.signal,\n      });\n\n      if (response.status === 403 || response.status === 404) {\n        return { kind: \"pending\" };\n      }\n\n      if (response.status !== 200) {\n        const errorText = await response.text().catch(() => \"\");\n        const prefix = `Codex OAuth device token poll failed (${response.status})`;\n        return { kind: \"fatal\", message: errorText ? `${prefix}: ${errorText}` : prefix };\n      }\n\n      const json = (await response.json().catch(() => null)) as unknown;\n      if (!isPlainObject(json)) {\n        return { kind: \"fatal\", message: \"Codex OAuth device token poll returned invalid JSON\" };\n      }\n\n      const authorizationCode =\n        typeof json.authorization_code === \"string\" ? json.authorization_code : null;\n      const codeVerifier = typeof json.code_verifier === \"string\" ? json.code_verifier : null;\n\n      if (!authorizationCode || !codeVerifier) {\n        return {\n          kind: \"fatal\",\n          message: \"Codex OAuth device token poll response missing required fields\",\n        };\n      }\n\n      const tokenResult = await this.exchangeCodeForTokens({\n        code: authorizationCode,\n        redirectUri: \"https://auth.openai.com/deviceauth/callback\",\n        codeVerifier,\n      });\n\n      if (!tokenResult.success) {\n        return { kind: \"fatal\", message: tokenResult.error };\n      }\n\n      return { kind: \"success\", auth: tokenResult.data };\n    } catch (error) {\n      // Abort is treated as cancellation.\n      if (flow.abortController.signal.aborted) {\n        return { kind: \"fatal\", message: \"OAuth flow cancelled\" };\n      }\n\n      const message = error instanceof Error ? error.message : String(error);\n      return { kind: \"fatal\", message: `Device authorization failed: ${message}` };\n    }\n  }\n\n  private async finishDesktopFlow(flowId: string, result: Result<void, string>): Promise<void> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow || flow.settled) return;\n\n    flow.settled = true;\n    clearTimeout(flow.timeout);\n\n    try {\n      flow.resolveResult(result);\n      await closeServer(flow.server);\n    } catch (error) {\n      log.debug(\"[Codex OAuth] Failed to close OAuth callback listener:\", error);\n    } finally {\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n      flow.cleanupTimeout = setTimeout(() => {\n        this.desktopFlows.delete(flowId);\n      }, COMPLETED_FLOW_TTL_MS);\n    }\n  }\n\n  private finishDeviceFlow(flowId: string, result: Result<void, string>): Promise<void> {\n    const flow = this.deviceFlows.get(flowId);\n    if (!flow || flow.settled) {\n      return Promise.resolve();\n    }\n\n    flow.settled = true;\n    clearTimeout(flow.timeout);\n    flow.abortController.abort();\n\n    try {\n      flow.resolveResult(result);\n    } finally {\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n      flow.cleanupTimeout = setTimeout(() => {\n        this.deviceFlows.delete(flowId);\n      }, COMPLETED_FLOW_TTL_MS);\n    }\n\n    return Promise.resolve();\n  }\n}\n\nasync function sleepWithAbort(ms: number, signal: AbortSignal): Promise<void> {\n  if (ms <= 0) {\n    return;\n  }\n\n  if (signal.aborted) {\n    throw new Error(\"aborted\");\n  }\n\n  await new Promise<void>((resolve, reject) => {\n    const timeout = setTimeout(() => {\n      cleanup();\n      resolve();\n    }, ms);\n\n    const onAbort = () => {\n      cleanup();\n      reject(new Error(\"aborted\"));\n    };\n\n    const cleanup = () => {\n      clearTimeout(timeout);\n      signal.removeEventListener(\"abort\", onAbort);\n    };\n\n    signal.addEventListener(\"abort\", onAbort);\n  });\n}\n\nfunction escapeHtml(input: string): string {\n  return input\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#39;\");\n}\n"]}