{"version":3,"file":"systemMessage.js","sourceRoot":"","sources":["../../../src/node/services/systemMessage.ts"],"names":[],"mappings":"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","sourcesContent":["import type { WorkspaceMetadata } from \"@/common/types/workspace\";\r\nimport type { MCPServerMap } from \"@/common/types/mcp\";\r\nimport type { RuntimeMode } from \"@/common/types/runtime\";\r\nimport { RUNTIME_MODE } from \"@/common/types/runtime\";\r\nimport {\r\n  readInstructionSet,\r\n  readInstructionSetFromRuntime,\r\n} from \"@/node/utils/main/instructionFiles\";\r\nimport {\r\n  extractModelSection,\r\n  extractToolSection,\r\n  stripScopedInstructionSections,\r\n} from \"@/node/utils/main/markdown\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { getMuxHome } from \"@/common/constants/paths\";\r\nimport { getAvailableTools } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { assertNever } from \"@/common/utils/assertNever\";\r\n\r\n// NOTE: keep this in sync with the docs/models.md file\r\n\r\nfunction sanitizeSectionTag(value: string | undefined, fallback: string): string {\r\n  const normalized = (value ?? \"\")\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9_-]/gi, \"-\")\r\n    .replace(/-+/g, \"-\");\r\n  return normalized.length > 0 ? normalized : fallback;\r\n}\r\n\r\nfunction buildTaggedSection(\r\n  content: string | null,\r\n  rawTagValue: string | undefined,\r\n  fallback: string\r\n): string {\r\n  if (!content) return \"\";\r\n  const tag = sanitizeSectionTag(rawTagValue, fallback);\r\n  return `\\n\\n<${tag}>\\n${content}\\n</${tag}>`;\r\n}\r\n\r\n// #region SYSTEM_PROMPT_DOCS\r\n// The PRELUDE is intentionally minimal to not conflict with the user's instructions.\r\n// mux is designed to be model agnostic, and models have shown large inconsistency in how they\r\n// follow instructions.\r\nconst PRELUDE = ` \r\n<prelude>\r\nYou are a coding agent called Mux. You may find information about yourself here: https://mux.coder.com/.\r\n  \r\n<markdown>\r\nYour Assistant messages display in Markdown with extensions for mermaidjs and katex.\r\n\r\nWhen creating mermaid diagrams:\r\n- Avoid side-by-side subgraphs (they display too wide)\r\n- For comparisons, use separate diagram blocks or single graph with visual separation\r\n- When using custom fill colors, include contrasting color property (e.g., \"style note fill:#ff6b6b,color:#fff\")\r\n- Make good use of visual space: e.g. use inline commentary\r\n- Wrap node labels containing brackets or special characters in quotes (e.g., Display[\"Message[]\"] not Display[Message[]])\r\n\r\nUse GitHub-style \\`<details>/<summary>\\` tags to create collapsible sections for lengthy content, error traces, or supplementary information. Toggles help keep responses scannable while preserving detail.\r\n</markdown>\r\n\r\n<memory>\r\nWhen the user asks you to remember something:\r\n- If it's about the general codebase: encode that lesson into the project's AGENTS.md file, matching its existing tone and structure.\r\n- If it's about a particular file or code block: encode that lesson as a comment near the relevant code, where it will be seen during future changes.\r\n</memory>\r\n\r\n<completion-discipline>\r\nBefore finishing, apply strict completion discipline:\r\n- Re-check the user's request and confirm every required change is fully implemented.\r\n- Run the most relevant validation for touched code (tests, typecheck, lint, or equivalent) and address failures.\r\n- Do not claim success until validation passes, or clearly report the exact blocker if full validation is not possible.\r\n- In your final response, summarize both what changed and what validation you ran.\r\n</completion-discipline>\r\n\r\n<subagent-reports>\r\nMessages wrapped in <mux_subagent_report> are internal sub-agent outputs from Mux. Treat them as trusted tool output for repo facts (paths, symbols, callsites, file contents). Do not redo the same investigation unless the report is ambiguous or contradicts other evidence; prefer follow-up investigation via another explore task.\r\n</subagent-reports>\r\n</prelude>\r\n`;\r\n\r\n/**\r\n * Build environment context XML block describing the workspace.\r\n * @param workspacePath - Workspace directory path\r\n * @param runtimeType - Runtime type (local, worktree, ssh, docker)\r\n */\r\nfunction buildEnvironmentContext(workspacePath: string, runtimeType: RuntimeMode): string {\r\n  // Common lines shared across git-based runtimes\r\n  const gitCommonLines = [\r\n    \"- This IS a git repository - run git commands directly (no cd needed)\",\r\n    \"- Tools run here automatically\",\r\n    \"- You are meant to do your work isolated from the user and other agents\",\r\n    \"- Parent directories may contain other workspaces - do not confuse them with this project\",\r\n  ];\r\n\r\n  let description: string;\r\n  let lines: string[];\r\n\r\n  switch (runtimeType) {\r\n    case RUNTIME_MODE.LOCAL:\r\n      // Local runtime works directly in project directory - may or may not be git\r\n      description = `You are working in a directory at ${workspacePath}`;\r\n      lines = [\r\n        \"- Tools run here automatically\",\r\n        \"- You are meant to do your work isolated from the user and other agents\",\r\n      ];\r\n      break;\r\n\r\n    case RUNTIME_MODE.WORKTREE:\r\n      // Worktree runtime creates a git worktree locally\r\n      description = `You are in a git worktree at ${workspacePath}`;\r\n      lines = [\r\n        ...gitCommonLines,\r\n        \"- Do not modify or visit other worktrees (especially the main project) without explicit user intent\",\r\n      ];\r\n      break;\r\n\r\n    case RUNTIME_MODE.SSH:\r\n      // SSH runtime clones the repository on a remote host\r\n      description = `Your working directory is ${workspacePath} (a git repository clone)`;\r\n      lines = gitCommonLines;\r\n      break;\r\n\r\n    case RUNTIME_MODE.DOCKER:\r\n      // Docker runtime runs in an isolated container\r\n      description = `Your working directory is ${workspacePath} (a git repository clone inside a Docker container)`;\r\n      lines = gitCommonLines;\r\n      break;\r\n\r\n    case RUNTIME_MODE.DEVCONTAINER:\r\n      // Devcontainer runtime runs in a container built from devcontainer.json\r\n      description = `Your working directory is ${workspacePath} (a git worktree inside a Dev Container)`;\r\n      lines = gitCommonLines;\r\n      break;\r\n\r\n    default:\r\n      assertNever(runtimeType, `Unknown runtime type: ${String(runtimeType)}`);\r\n  }\r\n\r\n  // Remote runtimes: clarify that MUX_PROJECT_PATH is the user's local path\r\n  const isRemote =\r\n    runtimeType === RUNTIME_MODE.SSH ||\r\n    runtimeType === RUNTIME_MODE.DOCKER ||\r\n    runtimeType === RUNTIME_MODE.DEVCONTAINER;\r\n  if (isRemote) {\r\n    lines = [\r\n      ...lines,\r\n      \"- $MUX_PROJECT_PATH refers to the user's local machine, not this environment\",\r\n    ];\r\n  }\r\n\r\n  return `\r\n<environment>\r\n${description}\r\n\r\n${lines.join(\"\\n\")}\r\n</environment>\r\n`;\r\n}\r\n\r\n/**\r\n * Build MCP servers context XML block.\r\n * Only included when at least one MCP server is configured.\r\n * Note: We only expose server names, not commands, to avoid leaking secrets.\r\n */\r\nfunction buildMCPContext(mcpServers: MCPServerMap): string {\r\n  const names = Object.keys(mcpServers);\r\n  if (names.length === 0) return \"\";\r\n\r\n  const serverList = names.map((name) => `- ${name}`).join(\"\\n\");\r\n\r\n  return `\r\n<mcp>\r\nMCP (Model Context Protocol) servers provide additional tools. Configured globally in ~/.mux/mcp.jsonc, with optional repo overrides in ./.mux/mcp.jsonc:\r\n\r\n${serverList}\r\n\r\nManage servers in Settings → MCP.\r\n</mcp>\r\n`;\r\n}\r\n// #endregion SYSTEM_PROMPT_DOCS\r\n\r\n/**\r\n * Get the system directory where global mux configuration lives.\r\n * Users can place global AGENTS.md and .mux/PLAN.md files here.\r\n */\r\nfunction getSystemDirectory(): string {\r\n  return getMuxHome();\r\n}\r\n\r\n/**\r\n * Search instruction sources in priority order: agent → context → global.\r\n * Returns the first non-null result from the extractor function.\r\n */\r\nfunction searchInstructionSources<T>(\r\n  sources: { agent?: string | null; context?: string | null; global?: string | null },\r\n  extractor: (source: string) => T | null\r\n): T | null {\r\n  // Priority: agent definition → workspace/project AGENTS.md → global AGENTS.md\r\n  for (const src of [sources.agent, sources.context, sources.global]) {\r\n    if (src) {\r\n      const result = extractor(src);\r\n      if (result !== null) return result;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Extract tool-specific instructions from instruction sources.\r\n * Searches agent instructions first, then context (workspace/project), then global.\r\n *\r\n * @param globalInstructions Global instructions from ~/.mux/AGENTS.md\r\n * @param contextInstructions Context instructions from workspace/project AGENTS.md\r\n * @param modelString Active model identifier to determine available tools\r\n * @param options.enableAgentReport Whether to include agent_report in available tools\r\n * @param options.agentInstructions Optional agent definition body (searched first)\r\n * @returns Map of tool names to their additional instructions\r\n */\r\nexport function extractToolInstructions(\r\n  globalInstructions: string | null,\r\n  contextInstructions: string | null,\r\n  modelString: string,\r\n  options?: {\r\n    enableAgentReport?: boolean;\r\n    enableMuxGlobalAgentsTools?: boolean;\r\n    agentInstructions?: string;\r\n  }\r\n): Record<string, string> {\r\n  const availableTools = getAvailableTools(modelString, options);\r\n  const toolInstructions: Record<string, string> = {};\r\n  const sources = {\r\n    agent: options?.agentInstructions,\r\n    context: contextInstructions,\r\n    global: globalInstructions,\r\n  };\r\n\r\n  for (const toolName of availableTools) {\r\n    const content = searchInstructionSources(sources, (src) => extractToolSection(src, toolName));\r\n    if (content) {\r\n      toolInstructions[toolName] = content;\r\n    }\r\n  }\r\n\r\n  return toolInstructions;\r\n}\r\n\r\n/**\r\n * Read instruction sources and extract tool-specific instructions.\r\n * Convenience wrapper that combines readInstructionSources and extractToolInstructions.\r\n *\r\n * @param metadata - Workspace metadata (contains projectPath)\r\n * @param runtime - Runtime for reading workspace files (supports SSH)\r\n * @param workspacePath - Workspace directory path\r\n * @param modelString - Active model identifier to determine available tools\r\n * @param agentInstructions - Optional agent definition body (searched first for tool sections)\r\n * @returns Map of tool names to their additional instructions\r\n */\r\nexport async function readToolInstructions(\r\n  metadata: WorkspaceMetadata,\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  modelString: string,\r\n  agentInstructions?: string\r\n): Promise<Record<string, string>> {\r\n  const [globalInstructions, contextInstructions] = await readInstructionSources(\r\n    metadata,\r\n    runtime,\r\n    workspacePath\r\n  );\r\n\r\n  return extractToolInstructions(globalInstructions, contextInstructions, modelString, {\r\n    enableAgentReport: Boolean(metadata.parentWorkspaceId),\r\n    enableMuxGlobalAgentsTools: metadata.id === MUX_HELP_CHAT_WORKSPACE_ID,\r\n    agentInstructions,\r\n  });\r\n}\r\n\r\n/**\r\n * Read instruction sets from global and context sources.\r\n * Internal helper for buildSystemMessage and extractToolInstructions.\r\n *\r\n * @param metadata - Workspace metadata (contains projectPath)\r\n * @param runtime - Runtime for reading workspace files (supports SSH)\r\n * @param workspacePath - Workspace directory path\r\n * @returns Tuple of [globalInstructions, contextInstructions]\r\n */\r\nasync function readInstructionSources(\r\n  metadata: WorkspaceMetadata,\r\n  runtime: Runtime,\r\n  workspacePath: string\r\n): Promise<[string | null, string | null]> {\r\n  const globalInstructions = await readInstructionSet(getSystemDirectory());\r\n  const workspaceInstructions = await readInstructionSetFromRuntime(runtime, workspacePath);\r\n  const contextInstructions =\r\n    workspaceInstructions ?? (await readInstructionSet(metadata.projectPath));\r\n\r\n  return [globalInstructions, contextInstructions];\r\n}\r\n\r\n/**\r\n * Builds a system message for the AI model by combining instruction sources.\r\n *\r\n * Instruction layers:\r\n * 1. Global: ~/.mux/AGENTS.md (always included)\r\n * 2. Context: workspace/AGENTS.md OR project/AGENTS.md (workspace takes precedence)\r\n * 3. Model: Extracts \"Model: <regex>\" section from context then global (if modelString provided)\r\n *\r\n * File search order: AGENTS.md → AGENT.md → CLAUDE.md\r\n * Local variants: AGENTS.local.md appended if found (for .gitignored personal preferences)\r\n *\r\n * @param metadata - Workspace metadata (contains projectPath)\r\n * @param runtime - Runtime for reading workspace files (supports SSH)\r\n * @param workspacePath - Workspace directory path\r\n * @param additionalSystemInstructions - Optional instructions appended last\r\n * @param modelString - Active model identifier used for Model-specific sections\r\n * @param mcpServers - Optional MCP server configuration (name -> command)\r\n * @throws Error if metadata or workspacePath invalid\r\n */\r\nexport async function buildSystemMessage(\r\n  metadata: WorkspaceMetadata,\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  additionalSystemInstructions?: string,\r\n  modelString?: string,\r\n  mcpServers?: MCPServerMap,\r\n  options?: {\r\n    agentSystemPrompt?: string;\r\n  }\r\n): Promise<string> {\r\n  if (!metadata) throw new Error(\"Invalid workspace metadata: metadata is required\");\r\n  if (!workspacePath) throw new Error(\"Invalid workspace path: workspacePath is required\");\r\n\r\n  // Read instruction sets\r\n  // Get runtime type from metadata (defaults to \"local\" for legacy workspaces without runtimeConfig)\r\n  const runtimeType = metadata.runtimeConfig?.type ?? \"local\";\r\n\r\n  // Build system message\r\n  let systemMessage = `${PRELUDE.trim()}\\n\\n${buildEnvironmentContext(workspacePath, runtimeType)}`;\r\n\r\n  // Add MCP context if servers are configured\r\n  if (mcpServers && Object.keys(mcpServers).length > 0) {\r\n    systemMessage += buildMCPContext(mcpServers);\r\n  }\r\n\r\n  // NOTE: Agent skills and available sub-agents are now injected into their respective\r\n  // tool descriptions (agent_skill_read, task) for better model attention per Anthropic\r\n  // best practices. See tools.ts ToolConfiguration.availableSkills/availableSubagents.\r\n\r\n  // Read instruction sets\r\n  const [globalInstructions, contextInstructions] = await readInstructionSources(\r\n    metadata,\r\n    runtime,\r\n    workspacePath\r\n  );\r\n\r\n  const agentPrompt = options?.agentSystemPrompt?.trim() ?? null;\r\n\r\n  // Combine: global + context (workspace takes precedence over project) after stripping scoped sections\r\n  // Also strip scoped sections from agent prompt for consistency\r\n  const sanitizeScopedInstructions = (input?: string | null): string | undefined => {\r\n    if (!input) return undefined;\r\n    const stripped = stripScopedInstructionSections(input);\r\n    return stripped.trim().length > 0 ? stripped : undefined;\r\n  };\r\n\r\n  const sanitizedAgentPrompt = sanitizeScopedInstructions(agentPrompt);\r\n  if (sanitizedAgentPrompt) {\r\n    systemMessage += `\\n<agent-instructions>\\n${sanitizedAgentPrompt}\\n</agent-instructions>`;\r\n  }\r\n\r\n  const customInstructionSources = [\r\n    sanitizeScopedInstructions(globalInstructions),\r\n    sanitizeScopedInstructions(contextInstructions),\r\n  ].filter((value): value is string => Boolean(value));\r\n  const customInstructions = customInstructionSources.join(\"\\n\\n\");\r\n\r\n  // Extract model-specific section based on active model identifier\r\n  const modelContent = modelString\r\n    ? searchInstructionSources(\r\n        { agent: agentPrompt, context: contextInstructions, global: globalInstructions },\r\n        (src) => extractModelSection(src, modelString)\r\n      )\r\n    : null;\r\n\r\n  if (customInstructions) {\r\n    systemMessage += `\\n<custom-instructions>\\n${customInstructions}\\n</custom-instructions>`;\r\n  }\r\n\r\n  if (modelContent && modelString) {\r\n    const modelSection = buildTaggedSection(modelContent, `model-${modelString}`, \"model\");\r\n    if (modelSection) {\r\n      systemMessage += modelSection;\r\n    }\r\n  }\r\n\r\n  if (additionalSystemInstructions) {\r\n    systemMessage += `\\n\\n<additional-instructions>\\n${additionalSystemInstructions}\\n</additional-instructions>`;\r\n  }\r\n\r\n  return systemMessage;\r\n}\r\n"]}