{"version":3,"file":"workspaceService.js","sourceRoot":"","sources":["../../../src/node/services/workspaceService.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from \"events\";\r\nimport * as path from \"path\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport assert from \"@/common/utils/assert\";\r\nimport { isWorkspaceArchived } from \"@/common/utils/archive\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { getMuxHelpChatProjectPath } from \"@/node/constants/muxChat\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport { askUserQuestionManager } from \"@/node/services/askUserQuestionManager\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { AgentSession } from \"@/node/services/agentSession\";\r\nimport type { HistoryService } from \"@/node/services/historyService\";\r\nimport type { PartialService } from \"@/node/services/partialService\";\r\nimport type { AIService } from \"@/node/services/aiService\";\r\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport type { ExtensionMetadataService } from \"@/node/services/ExtensionMetadataService\";\r\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\r\nimport type { ExperimentsService } from \"@/node/services/experimentsService\";\r\nimport { EXPERIMENT_IDS, EXPERIMENTS } from \"@/common/constants/experiments\";\r\nimport type { PolicyService } from \"@/node/services/policyService\";\r\nimport type { MCPServerManager } from \"@/node/services/mcpServerManager\";\r\nimport {\r\n  createRuntime,\r\n  IncompatibleRuntimeError,\r\n  runBackgroundInit,\r\n} from \"@/node/runtime/runtimeFactory\";\r\nimport { createRuntimeForWorkspace } from \"@/node/runtime/runtimeHelpers\";\r\nimport { validateWorkspaceName } from \"@/common/utils/validation/workspaceValidation\";\r\nimport { getPlanFilePath, getLegacyPlanFilePath } from \"@/common/utils/planStorage\";\r\nimport { shellQuote } from \"@/node/runtime/backgroundCommands\";\r\nimport { extractEditedFilePaths } from \"@/common/utils/messages/extractEditedFiles\";\r\nimport { fileExists } from \"@/node/utils/runtime/fileExists\";\r\nimport { applyForkRuntimeUpdates } from \"@/node/services/utils/forkRuntimeUpdates\";\r\nimport type { DevcontainerRuntime } from \"@/node/runtime/DevcontainerRuntime\";\r\nimport { getDevcontainerContainerName } from \"@/node/runtime/devcontainerCli\";\r\nimport { expandTilde, expandTildeForSSH } from \"@/node/runtime/tildeExpansion\";\r\n\r\nimport type { PostCompactionExclusions } from \"@/common/types/attachment\";\r\nimport type {\r\n  SendMessageOptions,\r\n  DeleteMessage,\r\n  FilePart,\r\n  WorkspaceChatMessage,\r\n} from \"@/common/orpc/types\";\r\n\r\nimport type { z } from \"zod\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport type {\r\n  FrontendWorkspaceMetadata,\r\n  WorkspaceActivitySnapshot,\r\n  WorkspaceMetadata,\r\n} from \"@/common/types/workspace\";\r\nimport { isDynamicToolPart } from \"@/common/types/toolParts\";\r\nimport { buildAskUserQuestionSummary } from \"@/common/utils/tools/askUserQuestionSummary\";\r\nimport {\r\n  AskUserQuestionToolArgsSchema,\r\n  AskUserQuestionToolResultSchema,\r\n} from \"@/common/utils/tools/toolDefinitions\";\r\nimport type { UIMode } from \"@/common/types/mode\";\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\r\nimport {\r\n  hasSrcBaseDir,\r\n  getSrcBaseDir,\r\n  isSSHRuntime,\r\n  isDockerRuntime,\r\n} from \"@/common/types/runtime\";\r\nimport { isValidModelFormat, normalizeGatewayModel } from \"@/common/utils/ai/models\";\r\nimport { coerceThinkingLevel, type ThinkingLevel } from \"@/common/types/thinking\";\r\nimport { WORKSPACE_DEFAULTS } from \"@/constants/workspaceDefaults\";\r\nimport type { StreamEndEvent, StreamAbortEvent } from \"@/common/types/stream\";\r\nimport type { TerminalService } from \"@/node/services/terminalService\";\r\nimport type { WorkspaceAISettingsSchema } from \"@/common/orpc/schemas\";\r\nimport type { SessionTimingService } from \"@/node/services/sessionTimingService\";\r\nimport type { SessionUsageService } from \"@/node/services/sessionUsageService\";\r\nimport type { CostTrackingService } from \"@/node/services/costTrackingService\";\r\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport type { WorkspaceLifecycleHooks } from \"@/node/services/workspaceLifecycleHooks\";\r\nimport type { TaskService } from \"@/node/services/taskService\";\r\n\r\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\r\nimport { createBashTool } from \"@/node/services/tools/bash\";\r\nimport type { AskUserQuestionToolSuccessResult, BashToolResult } from \"@/common/types/tools\";\r\nimport { secretsToRecord } from \"@/common/types/secrets\";\r\n\r\nimport { execBuffered, movePlanFile, copyPlanFile } from \"@/node/utils/runtime/helpers\";\r\nimport {\r\n  buildFileCompletionsIndex,\r\n  EMPTY_FILE_COMPLETIONS_INDEX,\r\n  searchFileCompletions,\r\n  type FileCompletionsIndex,\r\n} from \"@/node/services/fileCompletionsIndex\";\r\nimport { taskQueueDebug } from \"@/node/services/taskQueueDebug\";\r\nimport {\r\n  getSubagentGitPatchMboxPath,\r\n  readSubagentGitPatchArtifactsFile,\r\n  updateSubagentGitPatchArtifactsFile,\r\n} from \"@/node/services/subagentGitPatchArtifacts\";\r\nimport {\r\n  getSubagentReportArtifactPath,\r\n  readSubagentReportArtifactsFile,\r\n  updateSubagentReportArtifactsFile,\r\n} from \"@/node/services/subagentReportArtifacts\";\r\nimport {\r\n  getSubagentTranscriptChatPath,\r\n  getSubagentTranscriptPartialPath,\r\n  readSubagentTranscriptArtifactsFile,\r\n  updateSubagentTranscriptArtifactsFile,\r\n  upsertSubagentTranscriptArtifactIndexEntry,\r\n} from \"@/node/services/subagentTranscriptArtifacts\";\r\n\r\n/** Maximum number of retry attempts when workspace name collides */\r\nconst MAX_WORKSPACE_NAME_COLLISION_RETRIES = 3;\r\n\r\n// Keep short to feel instant, but debounce bursts of file_edit_* tool calls.\r\n\r\n// Shared type for workspace-scoped AI settings (model + thinking)\r\ntype WorkspaceAISettings = z.infer<typeof WorkspaceAISettingsSchema>;\r\nconst POST_COMPACTION_METADATA_REFRESH_DEBOUNCE_MS = 100;\r\n\r\ninterface FileCompletionsCacheEntry {\r\n  index: FileCompletionsIndex;\r\n  fetchedAt: number;\r\n  refreshing?: Promise<void>;\r\n}\r\n\r\ninterface ArchiveMergedInProjectResult {\r\n  archivedWorkspaceIds: string[];\r\n  skippedWorkspaceIds: string[];\r\n  errors: Array<{ workspaceId: string; error: string }>;\r\n}\r\n\r\n/**\r\n * Checks if an error indicates a workspace name collision\r\n */\r\nfunction isWorkspaceNameCollision(error: string | undefined): boolean {\r\n  return error?.includes(\"Workspace already exists\") ?? false;\r\n}\r\n\r\n/**\r\n * Generates a unique workspace name by appending a random suffix\r\n */\r\nfunction appendCollisionSuffix(baseName: string): string {\r\n  const suffix = Math.random().toString(36).substring(2, 6);\r\n  return `${baseName}-${suffix}`;\r\n}\r\n\r\nfunction isErrnoWithCode(error: unknown, code: string): boolean {\r\n  return Boolean(error && typeof error === \"object\" && \"code\" in error && error.code === code);\r\n}\r\n\r\nfunction isPathInsideDir(dirPath: string, filePath: string): boolean {\r\n  const resolvedDir = path.resolve(dirPath);\r\n  const resolvedFile = path.resolve(filePath);\r\n  const relative = path.relative(resolvedDir, resolvedFile);\r\n\r\n  return relative === \"\" || (!relative.startsWith(\"..\") && !path.isAbsolute(relative));\r\n}\r\n\r\nfunction isPositiveInteger(value: unknown): value is number {\r\n  return (\r\n    typeof value === \"number\" && Number.isFinite(value) && Number.isInteger(value) && value > 0\r\n  );\r\n}\r\n\r\nfunction hasDurableCompactedMarker(value: unknown): value is true | \"user\" | \"idle\" {\r\n  return value === true || value === \"user\" || value === \"idle\";\r\n}\r\n\r\nfunction isCompactedSummaryMessage(message: MuxMessage): boolean {\r\n  return hasDurableCompactedMarker(message.metadata?.compacted);\r\n}\r\n\r\nfunction getNextCompactionEpochForAppendBoundary(\r\n  workspaceId: string,\r\n  messages: MuxMessage[]\r\n): number {\r\n  let epochCursor = 0;\r\n\r\n  for (const message of messages) {\r\n    const metadata = message.metadata;\r\n    if (!metadata) {\r\n      continue;\r\n    }\r\n\r\n    const isCompactedSummary = isCompactedSummaryMessage(message);\r\n    const hasBoundaryMarker = metadata.compactionBoundary === true;\r\n    const epoch = metadata.compactionEpoch;\r\n\r\n    if (hasBoundaryMarker && !isCompactedSummary) {\r\n      // Self-healing read path: skip malformed persisted boundary markers.\r\n      // Boundary markers are only valid on compacted summaries.\r\n      log.warn(\"Skipping malformed compaction boundary while deriving next epoch\", {\r\n        workspaceId,\r\n        messageId: message.id,\r\n        reason: \"compactionBoundary set on non-compacted message\",\r\n      });\r\n      continue;\r\n    }\r\n\r\n    if (!isCompactedSummary) {\r\n      continue;\r\n    }\r\n\r\n    if (hasBoundaryMarker) {\r\n      if (!isPositiveInteger(epoch)) {\r\n        // Self-healing read path: invalid boundary metadata should not brick compaction.\r\n        log.warn(\"Skipping malformed compaction boundary while deriving next epoch\", {\r\n          workspaceId,\r\n          messageId: message.id,\r\n          reason: \"compactionBoundary missing positive integer compactionEpoch\",\r\n        });\r\n        continue;\r\n      }\r\n      epochCursor = Math.max(epochCursor, epoch);\r\n      continue;\r\n    }\r\n\r\n    if (epoch === undefined) {\r\n      // Legacy compacted summaries predate compactionEpoch metadata.\r\n      epochCursor += 1;\r\n      continue;\r\n    }\r\n\r\n    if (!isPositiveInteger(epoch)) {\r\n      // Self-healing read path: malformed compactionEpoch should not crash compaction.\r\n      log.warn(\"Skipping malformed compactionEpoch while deriving next epoch\", {\r\n        workspaceId,\r\n        messageId: message.id,\r\n        reason: \"compactionEpoch must be a positive integer when present\",\r\n      });\r\n      continue;\r\n    }\r\n\r\n    epochCursor = Math.max(epochCursor, epoch);\r\n  }\r\n\r\n  const nextEpoch = epochCursor + 1;\r\n  assert(nextEpoch > 0, \"next compaction epoch must be positive\");\r\n  return nextEpoch;\r\n}\r\n\r\nasync function copyFileBestEffort(params: {\r\n  srcPath: string;\r\n  destPath: string;\r\n  logContext: Record<string, unknown>;\r\n}): Promise<boolean> {\r\n  try {\r\n    await fsPromises.mkdir(path.dirname(params.destPath), { recursive: true });\r\n    await fsPromises.copyFile(params.srcPath, params.destPath);\r\n    return true;\r\n  } catch (error: unknown) {\r\n    if (isErrnoWithCode(error, \"ENOENT\")) {\r\n      return false;\r\n    }\r\n\r\n    log.error(\"Failed to copy session artifact file\", {\r\n      ...params.logContext,\r\n      srcPath: params.srcPath,\r\n      destPath: params.destPath,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function copyDirIfMissingBestEffort(params: {\r\n  srcDir: string;\r\n  destDir: string;\r\n  logContext: Record<string, unknown>;\r\n}): Promise<void> {\r\n  try {\r\n    try {\r\n      const stat = await fsPromises.stat(params.destDir);\r\n      if (stat.isDirectory()) {\r\n        return;\r\n      }\r\n      // If it's a file, fall through and try to copy (will likely fail).\r\n    } catch (error: unknown) {\r\n      if (!isErrnoWithCode(error, \"ENOENT\")) {\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    await fsPromises.mkdir(path.dirname(params.destDir), { recursive: true });\r\n    await fsPromises.cp(params.srcDir, params.destDir, { recursive: true });\r\n  } catch (error: unknown) {\r\n    if (isErrnoWithCode(error, \"ENOENT\")) {\r\n      return;\r\n    }\r\n\r\n    log.error(\"Failed to copy session artifact directory\", {\r\n      ...params.logContext,\r\n      srcDir: params.srcDir,\r\n      destDir: params.destDir,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n}\r\n\r\nfunction coerceUpdatedAtMs(entry: { createdAtMs?: number; updatedAtMs?: number }): number {\r\n  if (typeof entry.updatedAtMs === \"number\" && Number.isFinite(entry.updatedAtMs)) {\r\n    return entry.updatedAtMs;\r\n  }\r\n\r\n  if (typeof entry.createdAtMs === \"number\" && Number.isFinite(entry.createdAtMs)) {\r\n    return entry.createdAtMs;\r\n  }\r\n\r\n  return 0;\r\n}\r\n\r\nfunction rollUpAncestorWorkspaceIds(params: {\r\n  ancestorWorkspaceIds: string[];\r\n  removedWorkspaceId: string;\r\n  newParentWorkspaceId: string;\r\n}): string[] {\r\n  const filtered = params.ancestorWorkspaceIds.filter((id) => id !== params.removedWorkspaceId);\r\n\r\n  // Ensure the roll-up target is first (parent-first ordering).\r\n  if (filtered[0] === params.newParentWorkspaceId) {\r\n    return filtered;\r\n  }\r\n\r\n  return [\r\n    params.newParentWorkspaceId,\r\n    ...filtered.filter((id) => id !== params.newParentWorkspaceId),\r\n  ];\r\n}\r\n\r\nasync function archiveChildSessionArtifactsIntoParentSessionDir(params: {\r\n  parentWorkspaceId: string;\r\n  parentSessionDir: string;\r\n  childWorkspaceId: string;\r\n  childSessionDir: string;\r\n  /** Task-level model string for the child workspace (optional; persists into transcript artifacts). */\r\n  childTaskModelString?: string;\r\n  /** Task-level thinking/reasoning level for the child workspace (optional; persists into transcript artifacts). */\r\n  childTaskThinkingLevel?: ThinkingLevel;\r\n}): Promise<void> {\r\n  if (params.parentWorkspaceId.length === 0) {\r\n    return;\r\n  }\r\n\r\n  if (params.childWorkspaceId.length === 0) {\r\n    return;\r\n  }\r\n\r\n  if (params.parentSessionDir.length === 0 || params.childSessionDir.length === 0) {\r\n    return;\r\n  }\r\n\r\n  // 1) Archive the child session transcript (chat.jsonl + partial.json) into the parent session dir\r\n  // BEFORE deleting ~/.mux/sessions/<childWorkspaceId>.\r\n  try {\r\n    const childChatPath = path.join(params.childSessionDir, \"chat.jsonl\");\r\n    const childPartialPath = path.join(params.childSessionDir, \"partial.json\");\r\n\r\n    const archivedChatPath = getSubagentTranscriptChatPath(\r\n      params.parentSessionDir,\r\n      params.childWorkspaceId\r\n    );\r\n    const archivedPartialPath = getSubagentTranscriptPartialPath(\r\n      params.parentSessionDir,\r\n      params.childWorkspaceId\r\n    );\r\n\r\n    // Defensive: avoid path traversal in workspace IDs.\r\n    if (!isPathInsideDir(params.parentSessionDir, archivedChatPath)) {\r\n      log.error(\"Refusing to archive session transcript outside parent session dir\", {\r\n        parentWorkspaceId: params.parentWorkspaceId,\r\n        childWorkspaceId: params.childWorkspaceId,\r\n        parentSessionDir: params.parentSessionDir,\r\n        archivedChatPath,\r\n      });\r\n    } else {\r\n      const didCopyChat = await copyFileBestEffort({\r\n        srcPath: childChatPath,\r\n        destPath: archivedChatPath,\r\n        logContext: {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          artifact: \"chat.jsonl\",\r\n        },\r\n      });\r\n\r\n      const didCopyPartial = await copyFileBestEffort({\r\n        srcPath: childPartialPath,\r\n        destPath: archivedPartialPath,\r\n        logContext: {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          artifact: \"partial.json\",\r\n        },\r\n      });\r\n\r\n      if (didCopyChat || didCopyPartial) {\r\n        const nowMs = Date.now();\r\n\r\n        const model =\r\n          typeof params.childTaskModelString === \"string\" &&\r\n            params.childTaskModelString.trim().length > 0\r\n            ? params.childTaskModelString.trim()\r\n            : undefined;\r\n        const thinkingLevel = coerceThinkingLevel(params.childTaskThinkingLevel);\r\n\r\n        await upsertSubagentTranscriptArtifactIndexEntry({\r\n          workspaceId: params.parentWorkspaceId,\r\n          workspaceSessionDir: params.parentSessionDir,\r\n          childTaskId: params.childWorkspaceId,\r\n          updater: (existing) => ({\r\n            childTaskId: params.childWorkspaceId,\r\n            parentWorkspaceId: params.parentWorkspaceId,\r\n            createdAtMs: existing?.createdAtMs ?? nowMs,\r\n            updatedAtMs: nowMs,\r\n            model: model ?? existing?.model,\r\n            thinkingLevel: thinkingLevel ?? existing?.thinkingLevel,\r\n            chatPath: didCopyChat ? archivedChatPath : existing?.chatPath,\r\n            partialPath: didCopyPartial ? archivedPartialPath : existing?.partialPath,\r\n          }),\r\n        });\r\n      }\r\n    }\r\n  } catch (error: unknown) {\r\n    log.error(\"Failed to archive child transcript into parent session dir\", {\r\n      parentWorkspaceId: params.parentWorkspaceId,\r\n      childWorkspaceId: params.childWorkspaceId,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n\r\n  // 2) Roll up nested subagent artifacts from the child session dir into the parent session dir.\r\n  // This preserves grandchild artifacts when intermediate subagent workspaces are cleaned up.\r\n\r\n  // --- subagent-patches.json + subagent-patches/<taskId>/...\r\n  try {\r\n    const childArtifacts = await readSubagentGitPatchArtifactsFile(params.childSessionDir);\r\n    const childEntries = Object.entries(childArtifacts.artifactsByChildTaskId);\r\n\r\n    for (const [taskId] of childEntries) {\r\n      if (!taskId) continue;\r\n\r\n      const srcDir = path.dirname(getSubagentGitPatchMboxPath(params.childSessionDir, taskId));\r\n      const destDir = path.dirname(getSubagentGitPatchMboxPath(params.parentSessionDir, taskId));\r\n\r\n      if (!isPathInsideDir(params.childSessionDir, srcDir)) {\r\n        log.error(\"Refusing to roll up patch artifact outside child session dir\", {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          taskId,\r\n          childSessionDir: params.childSessionDir,\r\n          srcDir,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      if (!isPathInsideDir(params.parentSessionDir, destDir)) {\r\n        log.error(\"Refusing to roll up patch artifact outside parent session dir\", {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          taskId,\r\n          parentSessionDir: params.parentSessionDir,\r\n          destDir,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      await copyDirIfMissingBestEffort({\r\n        srcDir,\r\n        destDir,\r\n        logContext: {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          artifact: \"subagent-patches\",\r\n          taskId,\r\n        },\r\n      });\r\n    }\r\n\r\n    if (childEntries.length > 0) {\r\n      await updateSubagentGitPatchArtifactsFile({\r\n        workspaceId: params.parentWorkspaceId,\r\n        workspaceSessionDir: params.parentSessionDir,\r\n        update: (parentFile) => {\r\n          for (const [taskId, childEntry] of childEntries) {\r\n            if (!taskId) continue;\r\n            const existing = parentFile.artifactsByChildTaskId[taskId] ?? null;\r\n\r\n            const childUpdated = coerceUpdatedAtMs(childEntry);\r\n            const existingUpdated = existing ? coerceUpdatedAtMs(existing) : -1;\r\n\r\n            if (!existing || childUpdated > existingUpdated) {\r\n              parentFile.artifactsByChildTaskId[taskId] = {\r\n                ...childEntry,\r\n                childTaskId: taskId,\r\n                parentWorkspaceId: params.parentWorkspaceId,\r\n                mboxPath: getSubagentGitPatchMboxPath(params.parentSessionDir, taskId),\r\n              };\r\n            }\r\n          }\r\n        },\r\n      });\r\n    }\r\n  } catch (error: unknown) {\r\n    log.error(\"Failed to roll up subagent patch artifacts into parent\", {\r\n      parentWorkspaceId: params.parentWorkspaceId,\r\n      childWorkspaceId: params.childWorkspaceId,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n\r\n  // --- subagent-reports.json + subagent-reports/<taskId>/...\r\n  try {\r\n    const childArtifacts = await readSubagentReportArtifactsFile(params.childSessionDir);\r\n    const childEntries = Object.entries(childArtifacts.artifactsByChildTaskId);\r\n\r\n    for (const [taskId] of childEntries) {\r\n      if (!taskId) continue;\r\n\r\n      const srcDir = path.dirname(getSubagentReportArtifactPath(params.childSessionDir, taskId));\r\n      const destDir = path.dirname(getSubagentReportArtifactPath(params.parentSessionDir, taskId));\r\n\r\n      if (!isPathInsideDir(params.childSessionDir, srcDir)) {\r\n        log.error(\"Refusing to roll up report artifact outside child session dir\", {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          taskId,\r\n          childSessionDir: params.childSessionDir,\r\n          srcDir,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      if (!isPathInsideDir(params.parentSessionDir, destDir)) {\r\n        log.error(\"Refusing to roll up report artifact outside parent session dir\", {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          taskId,\r\n          parentSessionDir: params.parentSessionDir,\r\n          destDir,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      await copyDirIfMissingBestEffort({\r\n        srcDir,\r\n        destDir,\r\n        logContext: {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          artifact: \"subagent-reports\",\r\n          taskId,\r\n        },\r\n      });\r\n    }\r\n\r\n    if (childEntries.length > 0) {\r\n      await updateSubagentReportArtifactsFile({\r\n        workspaceId: params.parentWorkspaceId,\r\n        workspaceSessionDir: params.parentSessionDir,\r\n        update: (parentFile) => {\r\n          for (const [taskId, childEntry] of childEntries) {\r\n            if (!taskId) continue;\r\n\r\n            const existing = parentFile.artifactsByChildTaskId[taskId] ?? null;\r\n            const childUpdated = coerceUpdatedAtMs(childEntry);\r\n            const existingUpdated = existing ? coerceUpdatedAtMs(existing) : -1;\r\n\r\n            if (!existing || childUpdated > existingUpdated) {\r\n              parentFile.artifactsByChildTaskId[taskId] = {\r\n                ...childEntry,\r\n                childTaskId: taskId,\r\n                parentWorkspaceId: params.parentWorkspaceId,\r\n                ancestorWorkspaceIds: rollUpAncestorWorkspaceIds({\r\n                  ancestorWorkspaceIds: childEntry.ancestorWorkspaceIds,\r\n                  removedWorkspaceId: params.childWorkspaceId,\r\n                  newParentWorkspaceId: params.parentWorkspaceId,\r\n                }),\r\n              };\r\n            }\r\n          }\r\n        },\r\n      });\r\n    }\r\n  } catch (error: unknown) {\r\n    log.error(\"Failed to roll up subagent report artifacts into parent\", {\r\n      parentWorkspaceId: params.parentWorkspaceId,\r\n      childWorkspaceId: params.childWorkspaceId,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n\r\n  // --- subagent-transcripts.json + subagent-transcripts/<taskId>/...\r\n  try {\r\n    const childArtifacts = await readSubagentTranscriptArtifactsFile(params.childSessionDir);\r\n    const childEntries = Object.entries(childArtifacts.artifactsByChildTaskId);\r\n\r\n    for (const [taskId] of childEntries) {\r\n      if (!taskId) continue;\r\n\r\n      const srcDir = path.dirname(getSubagentTranscriptChatPath(params.childSessionDir, taskId));\r\n      const destDir = path.dirname(getSubagentTranscriptChatPath(params.parentSessionDir, taskId));\r\n\r\n      if (!isPathInsideDir(params.childSessionDir, srcDir)) {\r\n        log.error(\"Refusing to roll up transcript artifact outside child session dir\", {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          taskId,\r\n          childSessionDir: params.childSessionDir,\r\n          srcDir,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      if (!isPathInsideDir(params.parentSessionDir, destDir)) {\r\n        log.error(\"Refusing to roll up transcript artifact outside parent session dir\", {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          taskId,\r\n          parentSessionDir: params.parentSessionDir,\r\n          destDir,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      await copyDirIfMissingBestEffort({\r\n        srcDir,\r\n        destDir,\r\n        logContext: {\r\n          parentWorkspaceId: params.parentWorkspaceId,\r\n          childWorkspaceId: params.childWorkspaceId,\r\n          artifact: \"subagent-transcripts\",\r\n          taskId,\r\n        },\r\n      });\r\n    }\r\n\r\n    if (childEntries.length > 0) {\r\n      await updateSubagentTranscriptArtifactsFile({\r\n        workspaceId: params.parentWorkspaceId,\r\n        workspaceSessionDir: params.parentSessionDir,\r\n        update: (parentFile) => {\r\n          for (const [taskId, childEntry] of childEntries) {\r\n            if (!taskId) continue;\r\n\r\n            const existing = parentFile.artifactsByChildTaskId[taskId] ?? null;\r\n            const childUpdated = coerceUpdatedAtMs(childEntry);\r\n            const existingUpdated = existing ? coerceUpdatedAtMs(existing) : -1;\r\n\r\n            if (!existing || childUpdated > existingUpdated) {\r\n              parentFile.artifactsByChildTaskId[taskId] = {\r\n                ...childEntry,\r\n                childTaskId: taskId,\r\n                parentWorkspaceId: params.parentWorkspaceId,\r\n                chatPath: childEntry.chatPath\r\n                  ? getSubagentTranscriptChatPath(params.parentSessionDir, taskId)\r\n                  : undefined,\r\n                partialPath: childEntry.partialPath\r\n                  ? getSubagentTranscriptPartialPath(params.parentSessionDir, taskId)\r\n                  : undefined,\r\n              };\r\n            }\r\n          }\r\n        },\r\n      });\r\n    }\r\n  } catch (error: unknown) {\r\n    log.error(\"Failed to roll up subagent transcript artifacts into parent\", {\r\n      parentWorkspaceId: params.parentWorkspaceId,\r\n      childWorkspaceId: params.childWorkspaceId,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n}\r\n\r\nasync function forEachWithConcurrencyLimit<T>(\r\n  items: readonly T[],\r\n  limit: number,\r\n  fn: (item: T) => Promise<void>\r\n): Promise<void> {\r\n  assert(Number.isInteger(limit) && limit > 0, \"Concurrency limit must be a positive integer\");\r\n\r\n  let nextIndex = 0;\r\n  const workerCount = Math.min(limit, items.length);\r\n\r\n  const workers = Array.from({ length: workerCount }, async () => {\r\n    while (true) {\r\n      const index = nextIndex++;\r\n      if (index >= items.length) {\r\n        return;\r\n      }\r\n      await fn(items[index]);\r\n    }\r\n  });\r\n\r\n  await Promise.all(workers);\r\n}\r\n\r\nexport interface WorkspaceServiceEvents {\r\n  chat: (event: { workspaceId: string; message: WorkspaceChatMessage }) => void;\r\n  metadata: (event: { workspaceId: string; metadata: FrontendWorkspaceMetadata | null }) => void;\r\n  activity: (event: { workspaceId: string; activity: WorkspaceActivitySnapshot | null }) => void;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-unsafe-declaration-merging\r\nexport declare interface WorkspaceService {\r\n  on<U extends keyof WorkspaceServiceEvents>(event: U, listener: WorkspaceServiceEvents[U]): this;\r\n  emit<U extends keyof WorkspaceServiceEvents>(\r\n    event: U,\r\n    ...args: Parameters<WorkspaceServiceEvents[U]>\r\n  ): boolean;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-unsafe-declaration-merging\r\nexport class WorkspaceService extends EventEmitter {\r\n  private readonly sessions = new Map<string, AgentSession>();\r\n  private readonly sessionSubscriptions = new Map<\r\n    string,\r\n    { chat: () => void; metadata: () => void }\r\n  >();\r\n\r\n  // Debounce post-compaction metadata refreshes (file_edit_* can fire rapidly)\r\n  private readonly postCompactionRefreshTimers = new Map<string, ReturnType<typeof setTimeout>>();\r\n  // Tracks workspaces currently being renamed to prevent streaming during rename\r\n  private readonly renamingWorkspaces = new Set<string>();\r\n\r\n  // Cache for @file mention autocomplete (git ls-files output).\r\n  private readonly fileCompletionsCache = new Map<string, FileCompletionsCacheEntry>();\r\n  // Tracks workspaces currently being removed to prevent new sessions/streams during deletion.\r\n  private readonly removingWorkspaces = new Set<string>();\r\n\r\n  // Tracks workspaces currently being archived to prevent runtime-affecting operations (e.g. SSH)\r\n  // from waking a dedicated workspace during archive().\r\n  private readonly archivingWorkspaces = new Set<string>();\r\n\r\n  // AbortControllers for in-progress workspace initialization (postCreateSetup + initWorkspace).\r\n  //\r\n  // Why this lives here: archive/remove are the user-facing lifecycle operations that should\r\n  // cancel any fire-and-forget init work to avoid orphaned processes (e.g., SSH sync, .mux/init).\r\n  private readonly initAbortControllers = new Map<string, AbortController>();\r\n\r\n  /** Check if a workspace is currently being removed. */\r\n  isRemoving(workspaceId: string): boolean {\r\n    return this.removingWorkspaces.has(workspaceId);\r\n  }\r\n\r\n  constructor(\r\n    private readonly config: Config,\r\n    private readonly historyService: HistoryService,\r\n    private readonly partialService: PartialService,\r\n    private readonly aiService: AIService,\r\n    private readonly initStateManager: InitStateManager,\r\n    private readonly extensionMetadata: ExtensionMetadataService,\r\n    private readonly backgroundProcessManager: BackgroundProcessManager,\r\n    private readonly sessionUsageService: SessionUsageService,\r\n    private readonly costTrackingService: CostTrackingService,\r\n    private readonly policyService?: PolicyService,\r\n    telemetryService?: TelemetryService,\r\n    experimentsService?: ExperimentsService,\r\n    sessionTimingService?: SessionTimingService\r\n  ) {\r\n    super();\r\n    this.policyService = policyService;\r\n    this.sessionUsageService = sessionUsageService;\r\n    this.telemetryService = telemetryService;\r\n    this.experimentsService = experimentsService;\r\n    this.sessionTimingService = sessionTimingService;\r\n    this.setupMetadataListeners();\r\n    this.setupInitMetadataListeners();\r\n  }\r\n\r\n  private readonly telemetryService?: TelemetryService;\r\n  private readonly experimentsService?: ExperimentsService;\r\n  private mcpServerManager?: MCPServerManager;\r\n  // Optional terminal service for cleanup on workspace removal\r\n  private terminalService?: TerminalService;\r\n  private readonly sessionTimingService?: SessionTimingService;\r\n  private workspaceLifecycleHooks?: WorkspaceLifecycleHooks;\r\n  private taskService?: TaskService;\r\n\r\n  /**\r\n   * Set the MCP server manager for tool access.\r\n   * Called after construction due to circular dependency.\r\n   */\r\n  setMCPServerManager(manager: MCPServerManager): void {\r\n    this.mcpServerManager = manager;\r\n  }\r\n\r\n  /**\r\n   * Set the terminal service for cleanup on workspace removal.\r\n   */\r\n  setTerminalService(terminalService: TerminalService): void {\r\n    this.terminalService = terminalService;\r\n  }\r\n\r\n  setWorkspaceLifecycleHooks(hooks: WorkspaceLifecycleHooks): void {\r\n    this.workspaceLifecycleHooks = hooks;\r\n  }\r\n\r\n  /**\r\n   * Set the task service for auto-resume counter resets.\r\n   * Called after construction due to circular dependency.\r\n   */\r\n  setTaskService(taskService: TaskService): void {\r\n    this.taskService = taskService;\r\n  }\r\n\r\n  /**\r\n   * DEBUG ONLY: Trigger an artificial stream error for testing.\r\n   * This is used by integration tests to simulate network errors mid-stream.\r\n   * @returns true if an active stream was found and error was triggered\r\n   */\r\n  debugTriggerStreamError(workspaceId: string, errorMessage?: string): Promise<boolean> {\r\n    return this.aiService.debugTriggerStreamError(workspaceId, errorMessage);\r\n  }\r\n\r\n  /**\r\n   * Setup listeners to update metadata store based on AIService events.\r\n   * This tracks workspace recency and streaming status for VS Code extension integration.\r\n   */\r\n  private setupMetadataListeners(): void {\r\n    const isObj = (v: unknown): v is Record<string, unknown> => typeof v === \"object\" && v !== null;\r\n    const isWorkspaceEvent = (v: unknown): v is { workspaceId: string } =>\r\n      isObj(v) && \"workspaceId\" in v && typeof v.workspaceId === \"string\";\r\n    const isStreamStartEvent = (\r\n      v: unknown\r\n    ): v is { workspaceId: string; model: string; agentId?: string } =>\r\n      isWorkspaceEvent(v) && \"model\" in v && typeof v.model === \"string\";\r\n    const isStreamEndEvent = (v: unknown): v is StreamEndEvent =>\r\n      isWorkspaceEvent(v) &&\r\n      (!(\"metadata\" in (v as Record<string, unknown>)) || isObj((v as StreamEndEvent).metadata));\r\n    const isStreamAbortEvent = (v: unknown): v is StreamAbortEvent => isWorkspaceEvent(v);\r\n    const extractTimestamp = (event: StreamEndEvent | { metadata?: { timestamp?: number } }) => {\r\n      const raw = event.metadata?.timestamp;\r\n      return typeof raw === \"number\" && Number.isFinite(raw) ? raw : Date.now();\r\n    };\r\n\r\n    // Update streaming status and recency on stream start\r\n    this.aiService.on(\"stream-start\", (data: unknown) => {\r\n      if (isStreamStartEvent(data)) {\r\n        void this.updateStreamingStatus(data.workspaceId, true, data.model, data.agentId);\r\n      }\r\n    });\r\n\r\n    this.aiService.on(\"stream-end\", (data: unknown) => {\r\n      if (isStreamEndEvent(data)) {\r\n        void this.handleStreamCompletion(data.workspaceId, extractTimestamp(data));\r\n      }\r\n    });\r\n\r\n    this.aiService.on(\"stream-abort\", (data: unknown) => {\r\n      if (isStreamAbortEvent(data)) {\r\n        void this.updateStreamingStatus(data.workspaceId, false);\r\n      }\r\n    });\r\n  }\r\n\r\n  private setupInitMetadataListeners(): void {\r\n    const isObj = (v: unknown): v is Record<string, unknown> => typeof v === \"object\" && v !== null;\r\n    const isWorkspaceEvent = (v: unknown): v is { workspaceId: string } =>\r\n      isObj(v) && \"workspaceId\" in v && typeof v.workspaceId === \"string\";\r\n\r\n    // When init completes, refresh metadata so the UI can clear isInitializing and swap\r\n    // \"Cancel creation\" back to the normal archive affordance.\r\n    this.initStateManager.on(\"init-end\", (event: unknown) => {\r\n      if (!isWorkspaceEvent(event)) {\r\n        return;\r\n      }\r\n      void this.refreshAndEmitMetadata(event.workspaceId);\r\n    });\r\n  }\r\n\r\n  private emitWorkspaceActivity(\r\n    workspaceId: string,\r\n    snapshot: WorkspaceActivitySnapshot | null\r\n  ): void {\r\n    this.emit(\"activity\", { workspaceId, activity: snapshot });\r\n  }\r\n\r\n  private async updateRecencyTimestamp(workspaceId: string, timestamp?: number): Promise<void> {\r\n    try {\r\n      const snapshot = await this.extensionMetadata.updateRecency(\r\n        workspaceId,\r\n        timestamp ?? Date.now()\r\n      );\r\n      this.emitWorkspaceActivity(workspaceId, snapshot);\r\n    } catch (error) {\r\n      log.error(\"Failed to update workspace recency\", { workspaceId, error });\r\n    }\r\n  }\r\n\r\n  private async updateStreamingStatus(\r\n    workspaceId: string,\r\n    streaming: boolean,\r\n    model?: string,\r\n    agentId?: string\r\n  ): Promise<void> {\r\n    try {\r\n      let thinkingLevel: WorkspaceAISettings[\"thinkingLevel\"] | undefined;\r\n      if (model) {\r\n        const found = this.config.findWorkspace(workspaceId);\r\n        if (found) {\r\n          const config = this.config.loadConfigOrDefault();\r\n          const project = config.projects.get(found.projectPath);\r\n          const workspace =\r\n            project?.workspaces.find((w) => w.id === workspaceId) ??\r\n            project?.workspaces.find((w) => w.path === found.workspacePath);\r\n          const normalizedAgentId =\r\n            typeof agentId === \"string\" && agentId.trim().length > 0\r\n              ? agentId.trim().toLowerCase()\r\n              : WORKSPACE_DEFAULTS.agentId;\r\n          const aiSettings =\r\n            workspace?.aiSettingsByAgent?.[normalizedAgentId] ?? workspace?.aiSettings;\r\n          thinkingLevel = aiSettings?.thinkingLevel;\r\n        }\r\n      }\r\n      const snapshot = await this.extensionMetadata.setStreaming(\r\n        workspaceId,\r\n        streaming,\r\n        model,\r\n        thinkingLevel\r\n      );\r\n      this.emitWorkspaceActivity(workspaceId, snapshot);\r\n    } catch (error) {\r\n      log.error(\"Failed to update workspace streaming status\", { workspaceId, error });\r\n    }\r\n  }\r\n\r\n  private async handleStreamCompletion(workspaceId: string, timestamp: number): Promise<void> {\r\n    await this.updateRecencyTimestamp(workspaceId, timestamp);\r\n    await this.updateStreamingStatus(workspaceId, false);\r\n  }\r\n\r\n  private createInitLogger(workspaceId: string) {\r\n    const hasInitState = () => this.initStateManager.getInitState(workspaceId) !== undefined;\r\n\r\n    return {\r\n      logStep: (message: string) => {\r\n        if (!hasInitState()) {\r\n          return;\r\n        }\r\n        this.initStateManager.appendOutput(workspaceId, message, false);\r\n      },\r\n      logStdout: (line: string) => {\r\n        if (!hasInitState()) {\r\n          return;\r\n        }\r\n        this.initStateManager.appendOutput(workspaceId, line, false);\r\n      },\r\n      logStderr: (line: string) => {\r\n        if (!hasInitState()) {\r\n          return;\r\n        }\r\n        this.initStateManager.appendOutput(workspaceId, line, true);\r\n      },\r\n      logComplete: (exitCode: number) => {\r\n        this.initAbortControllers.delete(workspaceId);\r\n\r\n        // WorkspaceService.remove() clears in-memory init state early so waiters/tools can bail out.\r\n        // If init completes after deletion, avoid noisy logs (endInit() would report missing state).\r\n        if (!hasInitState()) {\r\n          return;\r\n        }\r\n\r\n        void this.initStateManager.endInit(workspaceId, exitCode);\r\n      },\r\n      enterHookPhase: () => {\r\n        if (!hasInitState()) {\r\n          return;\r\n        }\r\n        this.initStateManager.enterHookPhase(workspaceId);\r\n      },\r\n    };\r\n  }\r\n\r\n  private schedulePostCompactionMetadataRefresh(workspaceId: string): void {\r\n    assert(typeof workspaceId === \"string\", \"workspaceId must be a string\");\r\n    const trimmed = workspaceId.trim();\r\n    assert(trimmed.length > 0, \"workspaceId must not be empty\");\r\n\r\n    const existing = this.postCompactionRefreshTimers.get(trimmed);\r\n    if (existing) {\r\n      clearTimeout(existing);\r\n    }\r\n\r\n    const timer = setTimeout(() => {\r\n      this.postCompactionRefreshTimers.delete(trimmed);\r\n      void this.emitPostCompactionMetadata(trimmed);\r\n    }, POST_COMPACTION_METADATA_REFRESH_DEBOUNCE_MS);\r\n\r\n    this.postCompactionRefreshTimers.set(trimmed, timer);\r\n  }\r\n\r\n  private async emitPostCompactionMetadata(workspaceId: string): Promise<void> {\r\n    try {\r\n      const session = this.sessions.get(workspaceId);\r\n      if (!session) {\r\n        return;\r\n      }\r\n\r\n      const metadata = await this.getInfo(workspaceId);\r\n      if (!metadata) {\r\n        return;\r\n      }\r\n\r\n      const postCompaction = await this.getPostCompactionState(workspaceId);\r\n      const enrichedMetadata = { ...metadata, postCompaction };\r\n      session.emitMetadata(enrichedMetadata);\r\n    } catch (error) {\r\n      // Workspace runtime unavailable (e.g., SSH unreachable) - skip emitting post-compaction state.\r\n      log.debug(\"Failed to emit post-compaction metadata\", { workspaceId, error });\r\n    }\r\n  }\r\n\r\n  public getOrCreateSession(workspaceId: string): AgentSession {\r\n    assert(typeof workspaceId === \"string\", \"workspaceId must be a string\");\r\n    const trimmed = workspaceId.trim();\r\n    assert(trimmed.length > 0, \"workspaceId must not be empty\");\r\n\r\n    let session = this.sessions.get(trimmed);\r\n    if (session) {\r\n      return session;\r\n    }\r\n\r\n    session = new AgentSession({\r\n      workspaceId: trimmed,\r\n      config: this.config,\r\n      historyService: this.historyService,\r\n      partialService: this.partialService,\r\n      aiService: this.aiService,\r\n      telemetryService: this.telemetryService,\r\n      initStateManager: this.initStateManager,\r\n      backgroundProcessManager: this.backgroundProcessManager,\r\n      costTrackingService: this.costTrackingService,\r\n      onCompactionComplete: () => {\r\n        this.schedulePostCompactionMetadataRefresh(trimmed);\r\n      },\r\n      onPostCompactionStateChange: () => {\r\n        this.schedulePostCompactionMetadataRefresh(trimmed);\r\n      },\r\n    });\r\n\r\n    const chatUnsubscribe = session.onChatEvent((event) => {\r\n      this.emit(\"chat\", { workspaceId: event.workspaceId, message: event.message });\r\n    });\r\n\r\n    const metadataUnsubscribe = session.onMetadataEvent((event) => {\r\n      this.emit(\"metadata\", {\r\n        workspaceId: event.workspaceId,\r\n        metadata: event.metadata!,\r\n      });\r\n    });\r\n\r\n    this.sessions.set(trimmed, session);\r\n    this.sessionSubscriptions.set(trimmed, {\r\n      chat: chatUnsubscribe,\r\n      metadata: metadataUnsubscribe,\r\n    });\r\n\r\n    return session;\r\n  }\r\n\r\n  /**\r\n   * Register an externally-created AgentSession so that WorkspaceService\r\n   * operations (sendMessage, resumeStream, remove, etc.) reuse it instead of\r\n   * creating a duplicate. Used by `mux run` CLI to keep a single session\r\n   * instance for the parent workspace.\r\n   */\r\n  public registerSession(workspaceId: string, session: AgentSession): void {\r\n    workspaceId = workspaceId.trim();\r\n    assert(workspaceId.length > 0, \"workspaceId must not be empty\");\r\n    assert(!this.sessions.has(workspaceId), `session already registered for ${workspaceId}`);\r\n\r\n    this.sessions.set(workspaceId, session);\r\n\r\n    const chatUnsubscribe = session.onChatEvent((event) => {\r\n      this.emit(\"chat\", { workspaceId: event.workspaceId, message: event.message });\r\n    });\r\n\r\n    const metadataUnsubscribe = session.onMetadataEvent((event) => {\r\n      this.emit(\"metadata\", {\r\n        workspaceId: event.workspaceId,\r\n        metadata: event.metadata!,\r\n      });\r\n    });\r\n\r\n    this.sessionSubscriptions.set(workspaceId, {\r\n      chat: chatUnsubscribe,\r\n      metadata: metadataUnsubscribe,\r\n    });\r\n  }\r\n\r\n  public disposeSession(workspaceId: string): void {\r\n    const trimmed = workspaceId.trim();\r\n    const session = this.sessions.get(trimmed);\r\n    const refreshTimer = this.postCompactionRefreshTimers.get(trimmed);\r\n    if (refreshTimer) {\r\n      clearTimeout(refreshTimer);\r\n      this.postCompactionRefreshTimers.delete(trimmed);\r\n    }\r\n\r\n    if (!session) {\r\n      return;\r\n    }\r\n\r\n    const subscriptions = this.sessionSubscriptions.get(trimmed);\r\n    if (subscriptions) {\r\n      subscriptions.chat();\r\n      subscriptions.metadata();\r\n      this.sessionSubscriptions.delete(trimmed);\r\n    }\r\n\r\n    session.dispose();\r\n    this.sessions.delete(trimmed);\r\n  }\r\n\r\n  private async getPersistedPostCompactionDiffPaths(workspaceId: string): Promise<string[] | null> {\r\n    const postCompactionPath = path.join(\r\n      this.config.getSessionDir(workspaceId),\r\n      \"post-compaction.json\"\r\n    );\r\n\r\n    try {\r\n      const raw = await fsPromises.readFile(postCompactionPath, \"utf-8\");\r\n      const parsed: unknown = JSON.parse(raw);\r\n      const diffsRaw = (parsed as { diffs?: unknown }).diffs;\r\n      if (!Array.isArray(diffsRaw)) {\r\n        return null;\r\n      }\r\n\r\n      const result: string[] = [];\r\n      for (const diff of diffsRaw) {\r\n        if (!diff || typeof diff !== \"object\") continue;\r\n        const p = (diff as { path?: unknown }).path;\r\n        if (typeof p !== \"string\") continue;\r\n        const trimmed = p.trim();\r\n        if (trimmed.length === 0) continue;\r\n        result.push(trimmed);\r\n      }\r\n\r\n      return result;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get post-compaction context state for a workspace.\r\n   * Returns info about what will be injected after compaction.\r\n   * Prefers cached paths from pending compaction, falls back to history extraction.\r\n   */\r\n  public async getPostCompactionState(workspaceId: string): Promise<{\r\n    planPath: string | null;\r\n    trackedFilePaths: string[];\r\n    excludedItems: string[];\r\n  }> {\r\n    // Get workspace metadata to create runtime for plan file check\r\n    const metadata = await this.getInfo(workspaceId);\r\n    if (!metadata) {\r\n      // Can't get metadata, return empty state\r\n      const exclusions = await this.getPostCompactionExclusions(workspaceId);\r\n      return { planPath: null, trackedFilePaths: [], excludedItems: exclusions.excludedItems };\r\n    }\r\n\r\n    const runtime = createRuntimeForWorkspace(metadata);\r\n    const muxHome = runtime.getMuxHome();\r\n    const planPath = getPlanFilePath(metadata.name, metadata.projectName, muxHome);\r\n    // For local/SSH: expand tilde for comparison with message history paths\r\n    // For Docker: paths are already absolute (/var/mux/...), no expansion needed\r\n    const expandedPlanPath = muxHome.startsWith(\"~\") ? expandTilde(planPath) : planPath;\r\n    // Legacy plan path (stored by workspace ID) for filtering\r\n    const legacyPlanPath = getLegacyPlanFilePath(workspaceId);\r\n    const expandedLegacyPlanPath = expandTilde(legacyPlanPath);\r\n\r\n    // Check both new and legacy plan paths, prefer new path\r\n    const newPlanExists = await fileExists(runtime, planPath);\r\n    const legacyPlanExists = !newPlanExists && (await fileExists(runtime, legacyPlanPath));\r\n    // Resolve plan path via runtime to get correct absolute path for deep links.\r\n    // Local: expands ~ to local home. SSH: expands ~ on remote host.\r\n    const activePlanPath = newPlanExists\r\n      ? await runtime.resolvePath(planPath)\r\n      : legacyPlanExists\r\n        ? await runtime.resolvePath(legacyPlanPath)\r\n        : null;\r\n\r\n    // Load exclusions\r\n    const exclusions = await this.getPostCompactionExclusions(workspaceId);\r\n\r\n    // Helper to check if a path is a plan file (new or legacy format)\r\n    const isPlanPath = (p: string) =>\r\n      p === planPath ||\r\n      p === expandedPlanPath ||\r\n      p === legacyPlanPath ||\r\n      p === expandedLegacyPlanPath;\r\n\r\n    // If session has pending compaction attachments, use cached paths\r\n    // (history is cleared after compaction, but cache survives)\r\n    const session = this.sessions.get(workspaceId);\r\n    const pendingPaths = session?.getPendingTrackedFilePaths();\r\n    if (pendingPaths) {\r\n      // Filter out both new and legacy plan file paths\r\n      const trackedFilePaths = pendingPaths.filter((p) => !isPlanPath(p));\r\n      return {\r\n        planPath: activePlanPath,\r\n        trackedFilePaths,\r\n        excludedItems: exclusions.excludedItems,\r\n      };\r\n    }\r\n\r\n    // Fallback (crash-safe): if a post-compaction snapshot exists on disk, use it.\r\n    const persistedPaths = await this.getPersistedPostCompactionDiffPaths(workspaceId);\r\n    if (persistedPaths !== null) {\r\n      const trackedFilePaths = persistedPaths.filter((p) => !isPlanPath(p));\r\n      return {\r\n        planPath: activePlanPath,\r\n        trackedFilePaths,\r\n        excludedItems: exclusions.excludedItems,\r\n      };\r\n    }\r\n\r\n    // Fallback: compute tracked files from message history (survives reloads).\r\n    // Only the current compaction epoch matters  post-compaction files are from\r\n    // the active epoch only.\r\n    const historyResult = await this.historyService.getHistoryFromLatestBoundary(workspaceId);\r\n    const messages = historyResult.success ? historyResult.data : [];\r\n    const allPaths = extractEditedFilePaths(messages);\r\n\r\n    // Exclude plan file from tracked files since it has its own section\r\n    // Filter out both new and legacy plan file paths\r\n    const trackedFilePaths = allPaths.filter((p) => !isPlanPath(p));\r\n    return {\r\n      planPath: activePlanPath,\r\n      trackedFilePaths,\r\n      excludedItems: exclusions.excludedItems,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get post-compaction exclusions for a workspace.\r\n   * Returns empty exclusions if file doesn't exist.\r\n   */\r\n  public async getPostCompactionExclusions(workspaceId: string): Promise<PostCompactionExclusions> {\r\n    const exclusionsPath = path.join(this.config.getSessionDir(workspaceId), \"exclusions.json\");\r\n    try {\r\n      const data = await fsPromises.readFile(exclusionsPath, \"utf-8\");\r\n      return JSON.parse(data) as PostCompactionExclusions;\r\n    } catch {\r\n      return { excludedItems: [] };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set whether an item is excluded from post-compaction context.\r\n   * Item IDs: \"plan\" for plan file, \"file:<path>\" for tracked files.\r\n   */\r\n  public async setPostCompactionExclusion(\r\n    workspaceId: string,\r\n    itemId: string,\r\n    excluded: boolean\r\n  ): Promise<Result<void>> {\r\n    try {\r\n      const exclusions = await this.getPostCompactionExclusions(workspaceId);\r\n      const set = new Set(exclusions.excludedItems);\r\n\r\n      if (excluded) {\r\n        set.add(itemId);\r\n      } else {\r\n        set.delete(itemId);\r\n      }\r\n\r\n      const sessionDir = this.config.getSessionDir(workspaceId);\r\n      await fsPromises.mkdir(sessionDir, { recursive: true });\r\n      const exclusionsPath = path.join(sessionDir, \"exclusions.json\");\r\n      await fsPromises.writeFile(\r\n        exclusionsPath,\r\n        JSON.stringify({ excludedItems: [...set] }, null, 2)\r\n      );\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to set exclusion: ${message}`);\r\n    }\r\n  }\r\n\r\n  async create(\r\n    projectPath: string,\r\n    branchName: string,\r\n    trunkBranch: string | undefined,\r\n    title?: string,\r\n    runtimeConfig?: RuntimeConfig,\r\n    sectionId?: string\r\n  ): Promise<Result<{ metadata: FrontendWorkspaceMetadata }>> {\r\n    // Chat with Mux is a built-in system workspace; it cannot host additional workspaces.\r\n    if (projectPath === getMuxHelpChatProjectPath(this.config.rootDir)) {\r\n      return Err(\"Cannot create workspaces in the Chat with Mux system project\");\r\n    }\r\n\r\n    // Validate workspace name\r\n    const validation = validateWorkspaceName(branchName);\r\n    if (!validation.valid) {\r\n      return Err(validation.error ?? \"Invalid workspace name\");\r\n    }\r\n\r\n    // Generate stable workspace ID\r\n    const workspaceId = this.config.generateStableId();\r\n\r\n    // Create runtime for workspace creation\r\n    // Default to worktree runtime for backward compatibility\r\n    let finalRuntimeConfig: RuntimeConfig = runtimeConfig ?? {\r\n      type: \"worktree\",\r\n      srcBaseDir: this.config.srcDir,\r\n    };\r\n\r\n    if (this.policyService?.isEnforced()) {\r\n      if (!this.policyService.isRuntimeAllowed(finalRuntimeConfig)) {\r\n        return Err(\"Selected runtime is not allowed by policy\");\r\n      }\r\n    }\r\n\r\n    // Local runtime doesn't need a trunk branch; worktree/SSH runtimes require it\r\n    const isLocalRuntime = finalRuntimeConfig.type === \"local\";\r\n    const normalizedTrunkBranch = trunkBranch?.trim() ?? \"\";\r\n    if (!isLocalRuntime && normalizedTrunkBranch.length === 0) {\r\n      return Err(\"Trunk branch is required for worktree and SSH runtimes\");\r\n    }\r\n\r\n    let runtime;\r\n    try {\r\n      runtime = createRuntime(finalRuntimeConfig, { projectPath });\r\n\r\n      // Resolve srcBaseDir path if the config has one.\r\n      // Skip if runtime has deferredRuntimeAccess flag (runtime doesn't exist yet, e.g., Coder).\r\n      const srcBaseDir = getSrcBaseDir(finalRuntimeConfig);\r\n      if (srcBaseDir && !runtime.createFlags?.deferredRuntimeAccess) {\r\n        const resolvedSrcBaseDir = await runtime.resolvePath(srcBaseDir);\r\n        if (resolvedSrcBaseDir !== srcBaseDir && hasSrcBaseDir(finalRuntimeConfig)) {\r\n          finalRuntimeConfig = {\r\n            ...finalRuntimeConfig,\r\n            srcBaseDir: resolvedSrcBaseDir,\r\n          };\r\n          runtime = createRuntime(finalRuntimeConfig, { projectPath });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      const errorMsg = error instanceof Error ? error.message : String(error);\r\n      return Err(errorMsg);\r\n    }\r\n\r\n    const session = this.getOrCreateSession(workspaceId);\r\n    this.initStateManager.startInit(workspaceId, projectPath);\r\n\r\n    // Create abort controller immediately so workspace lifecycle operations (e.g., cancel/remove)\r\n    // can reliably interrupt init even if the UI deletes the workspace during create().\r\n    const initAbortController = new AbortController();\r\n    this.initAbortControllers.set(workspaceId, initAbortController);\r\n\r\n    const initLogger = this.createInitLogger(workspaceId);\r\n\r\n    try {\r\n      // Create workspace with automatic collision retry\r\n      let finalBranchName = branchName;\r\n      let createResult: { success: boolean; workspacePath?: string; error?: string };\r\n\r\n      // If runtime uses config-level collision detection (e.g., Coder - can't reach host),\r\n      // check against existing workspace names before createWorkspace.\r\n      if (runtime.createFlags?.configLevelCollisionDetection) {\r\n        const existingNames = new Set(\r\n          (this.config.loadConfigOrDefault().projects.get(projectPath)?.workspaces ?? []).map(\r\n            (w) => w.name\r\n          )\r\n        );\r\n        for (\r\n          let i = 0;\r\n          i < MAX_WORKSPACE_NAME_COLLISION_RETRIES && existingNames.has(finalBranchName);\r\n          i++\r\n        ) {\r\n          log.debug(`Workspace name collision for \"${finalBranchName}\", adding suffix`);\r\n          finalBranchName = appendCollisionSuffix(branchName);\r\n        }\r\n      }\r\n\r\n      for (let attempt = 0; attempt <= MAX_WORKSPACE_NAME_COLLISION_RETRIES; attempt++) {\r\n        createResult = await runtime.createWorkspace({\r\n          projectPath,\r\n          branchName: finalBranchName,\r\n          trunkBranch: normalizedTrunkBranch,\r\n          directoryName: finalBranchName,\r\n          initLogger,\r\n          abortSignal: initAbortController.signal,\r\n        });\r\n\r\n        if (createResult.success) break;\r\n\r\n        // If collision and not last attempt, retry with suffix\r\n        if (\r\n          isWorkspaceNameCollision(createResult.error) &&\r\n          attempt < MAX_WORKSPACE_NAME_COLLISION_RETRIES\r\n        ) {\r\n          log.debug(`Workspace name collision for \"${finalBranchName}\", retrying with suffix`);\r\n          finalBranchName = appendCollisionSuffix(branchName);\r\n          continue;\r\n        }\r\n        break;\r\n      }\r\n\r\n      if (!createResult!.success || !createResult!.workspacePath) {\r\n        initLogger.logComplete(-1);\r\n        return Err(createResult!.error ?? \"Failed to create workspace\");\r\n      }\r\n\r\n      // Let runtime finalize config (e.g., derive names, compute host) after collision handling\r\n      if (runtime.finalizeConfig) {\r\n        const finalizeResult = await runtime.finalizeConfig(finalBranchName, finalRuntimeConfig);\r\n        if (!finalizeResult.success) {\r\n          initLogger.logComplete(-1);\r\n          return Err(finalizeResult.error);\r\n        }\r\n        finalRuntimeConfig = finalizeResult.data;\r\n        runtime = createRuntime(finalRuntimeConfig, { projectPath });\r\n      }\r\n\r\n      // Let runtime validate before persisting (e.g., external collision checks)\r\n      if (runtime.validateBeforePersist) {\r\n        const validateResult = await runtime.validateBeforePersist(\r\n          finalBranchName,\r\n          finalRuntimeConfig\r\n        );\r\n        if (!validateResult.success) {\r\n          initLogger.logComplete(-1);\r\n          return Err(validateResult.error);\r\n        }\r\n      }\r\n\r\n      const projectName =\r\n        projectPath.split(\"/\").pop() ?? projectPath.split(\"\\\\\").pop() ?? \"unknown\";\r\n\r\n      const metadata = {\r\n        id: workspaceId,\r\n        name: finalBranchName,\r\n        title,\r\n        projectName,\r\n        projectPath,\r\n        createdAt: new Date().toISOString(),\r\n      };\r\n\r\n      await this.config.editConfig((config) => {\r\n        let projectConfig = config.projects.get(projectPath);\r\n        if (!projectConfig) {\r\n          projectConfig = { workspaces: [] };\r\n          config.projects.set(projectPath, projectConfig);\r\n        }\r\n        projectConfig.workspaces.push({\r\n          path: createResult!.workspacePath!,\r\n          id: workspaceId,\r\n          name: finalBranchName,\r\n          title,\r\n          createdAt: metadata.createdAt,\r\n          runtimeConfig: finalRuntimeConfig,\r\n          sectionId,\r\n        });\r\n        return config;\r\n      });\r\n\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const completeMetadata = allMetadata.find((m) => m.id === workspaceId);\r\n      if (!completeMetadata) {\r\n        initLogger.logComplete(-1);\r\n        return Err(\"Failed to retrieve workspace metadata\");\r\n      }\r\n\r\n      session.emitMetadata(this.enrichFrontendMetadata(completeMetadata));\r\n\r\n      // Background init: run postCreateSetup (if present) then initWorkspace\r\n      const secrets = secretsToRecord(this.config.getEffectiveSecrets(projectPath));\r\n      // Background init: postCreateSetup (provisioning) + initWorkspace (sync/checkout/hook)\r\n      //\r\n      // If the user cancelled creation while create() was still in flight, avoid spawning\r\n      // additional background work for a workspace that's already being removed.\r\n      if (!this.removingWorkspaces.has(workspaceId) && !initAbortController.signal.aborted) {\r\n        runBackgroundInit(\r\n          runtime,\r\n          {\r\n            projectPath,\r\n            branchName: finalBranchName,\r\n            trunkBranch: normalizedTrunkBranch,\r\n            workspacePath: createResult!.workspacePath,\r\n            initLogger,\r\n            env: secrets,\r\n            abortSignal: initAbortController.signal,\r\n          },\r\n          workspaceId,\r\n          log\r\n        );\r\n      } else {\r\n        initAbortController.abort();\r\n        this.initAbortControllers.delete(workspaceId);\r\n\r\n        // Background init will never run, so init-end wont fire.\r\n        // Clear init state + re-emit metadata so the sidebar doesnt stay stuck on isInitializing.\r\n        this.initStateManager.clearInMemoryState(workspaceId);\r\n        session.emitMetadata(this.enrichFrontendMetadata(completeMetadata));\r\n      }\r\n\r\n      return Ok({ metadata: this.enrichFrontendMetadata(completeMetadata) });\r\n    } catch (error) {\r\n      initLogger.logComplete(-1);\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to create workspace: ${message}`);\r\n    }\r\n  }\r\n\r\n  async remove(workspaceId: string, force = false): Promise<Result<void>> {\r\n    if (workspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n      return Err(\"Cannot remove the Chat with Mux system workspace\");\r\n    }\r\n\r\n    // Idempotent: if already removing, return success to prevent race conditions\r\n    if (this.removingWorkspaces.has(workspaceId)) {\r\n      return Ok(undefined);\r\n    }\r\n    this.removingWorkspaces.add(workspaceId);\r\n\r\n    // If this workspace is mid-init, cancel the fire-and-forget init work (postCreateSetup,\r\n    // sync/checkout, .mux/init hook, etc.) so removal doesn't leave orphaned background work.\r\n    const initAbortController = this.initAbortControllers.get(workspaceId);\r\n    if (initAbortController) {\r\n      initAbortController.abort();\r\n      this.initAbortControllers.delete(workspaceId);\r\n    }\r\n\r\n    // Try to remove from runtime (filesystem)\r\n    try {\r\n      // Stop any active stream before deleting metadata/config to avoid tool calls racing with removal.\r\n      //\r\n      // IMPORTANT: AIService forwards \"stream-abort\" asynchronously after partial cleanup. If we roll up\r\n      // session timing (or delete session files) immediately after stopStream(), we can race the final\r\n      // abort timing write.\r\n      const wasStreaming = this.aiService.isStreaming(workspaceId);\r\n      const streamStoppedEvent: Promise<\"abort\" | \"end\" | undefined> | undefined = wasStreaming\r\n        ? new Promise((resolve) => {\r\n          const aiService = this.aiService;\r\n          const targetWorkspaceId = workspaceId;\r\n          const timeoutMs = 5000;\r\n\r\n          let settled = false;\r\n          let timer: ReturnType<typeof setTimeout> | undefined;\r\n\r\n          const cleanup = (result: \"abort\" | \"end\" | undefined) => {\r\n            if (settled) return;\r\n            settled = true;\r\n            if (timer) {\r\n              clearTimeout(timer);\r\n              timer = undefined;\r\n            }\r\n            aiService.off(\"stream-abort\", onAbort);\r\n            aiService.off(\"stream-end\", onEnd);\r\n            resolve(result);\r\n          };\r\n\r\n          function onAbort(data: StreamAbortEvent): void {\r\n            if (data.workspaceId !== targetWorkspaceId) return;\r\n            cleanup(\"abort\");\r\n          }\r\n\r\n          function onEnd(data: StreamEndEvent): void {\r\n            if (data.workspaceId !== targetWorkspaceId) return;\r\n            cleanup(\"end\");\r\n          }\r\n\r\n          aiService.on(\"stream-abort\", onAbort);\r\n          aiService.on(\"stream-end\", onEnd);\r\n\r\n          timer = setTimeout(() => cleanup(undefined), timeoutMs);\r\n        })\r\n        : undefined;\r\n\r\n      try {\r\n        const stopResult = await this.aiService.stopStream(workspaceId, { abandonPartial: true });\r\n        if (!stopResult.success) {\r\n          log.debug(\"Failed to stop stream during workspace removal\", {\r\n            workspaceId,\r\n            error: stopResult.error,\r\n          });\r\n        }\r\n      } catch (error: unknown) {\r\n        log.debug(\"Failed to stop stream during workspace removal (threw)\", { workspaceId, error });\r\n      }\r\n\r\n      if (streamStoppedEvent) {\r\n        const stopEvent = await streamStoppedEvent;\r\n        if (!stopEvent) {\r\n          log.debug(\"Timed out waiting for stream to stop during workspace removal\", {\r\n            workspaceId,\r\n          });\r\n        }\r\n\r\n        // If session timing is enabled, make sure no pending writes can recreate session files after\r\n        // we delete the session directory.\r\n        if (this.sessionTimingService) {\r\n          await this.sessionTimingService.waitForIdle(workspaceId);\r\n        }\r\n      }\r\n\r\n      let parentWorkspaceId: string | null = null;\r\n      let childTaskModelString: string | undefined;\r\n      let childTaskThinkingLevel: ThinkingLevel | undefined;\r\n\r\n      const metadataResult = await this.aiService.getWorkspaceMetadata(workspaceId);\r\n      if (metadataResult.success) {\r\n        const metadata = metadataResult.data;\r\n        const projectPath = metadata.projectPath;\r\n\r\n        const runtime = createRuntime(metadata.runtimeConfig, {\r\n          projectPath,\r\n          workspaceName: metadata.name,\r\n        });\r\n\r\n        // Delete workspace from runtime first - if this fails with force=false, we abort\r\n        // and keep workspace in config so user can retry. This prevents orphaned directories.\r\n        const deleteResult = await runtime.deleteWorkspace(\r\n          projectPath,\r\n          metadata.name, // use branch name\r\n          force\r\n        );\r\n\r\n        if (!deleteResult.success) {\r\n          // If force is true, we continue to remove from config even if fs removal failed\r\n          if (!force) {\r\n            return Err(deleteResult.error ?? \"Failed to delete workspace from disk\");\r\n          }\r\n          log.error(\r\n            `Failed to delete workspace from disk, but force=true. Removing from config. Error: ${deleteResult.error}`\r\n          );\r\n        }\r\n\r\n        // Note: Coder workspace deletion is handled by CoderSSHRuntime.deleteWorkspace()\r\n\r\n        parentWorkspaceId = metadata.parentWorkspaceId ?? null;\r\n        childTaskModelString = metadata.taskModelString;\r\n        childTaskThinkingLevel = coerceThinkingLevel(metadata.taskThinkingLevel);\r\n\r\n        // If this workspace is a sub-agent/task, roll its accumulated timing into the parent BEFORE\r\n        // deleting ~/.mux/sessions/<workspaceId>/session-timing.json.\r\n        if (parentWorkspaceId && this.sessionTimingService) {\r\n          try {\r\n            // Flush any last timing write (e.g. from stream-abort) before reading.\r\n            await this.sessionTimingService.waitForIdle(workspaceId);\r\n            await this.sessionTimingService.rollUpTimingIntoParent(parentWorkspaceId, workspaceId);\r\n          } catch (error: unknown) {\r\n            log.error(\"Failed to roll up child session timing into parent\", {\r\n              workspaceId,\r\n              parentWorkspaceId,\r\n              error: error instanceof Error ? error.message : String(error),\r\n            });\r\n          }\r\n        }\r\n\r\n        // If this workspace is a sub-agent/task, roll its accumulated usage into the parent BEFORE\r\n        // deleting ~/.mux/sessions/<workspaceId>/session-usage.json.\r\n        if (parentWorkspaceId && this.sessionUsageService) {\r\n          try {\r\n            const childUsage = await this.sessionUsageService.getSessionUsage(workspaceId);\r\n            if (childUsage && Object.keys(childUsage.byModel).length > 0) {\r\n              const rollup = await this.sessionUsageService.rollUpUsageIntoParent(\r\n                parentWorkspaceId,\r\n                workspaceId,\r\n                childUsage.byModel\r\n              );\r\n\r\n              if (rollup.didRollUp) {\r\n                // Live UI update (best-effort): only emit if the parent session is already active.\r\n                this.sessions.get(parentWorkspaceId)?.emitChatEvent({\r\n                  type: \"session-usage-delta\",\r\n                  workspaceId: parentWorkspaceId,\r\n                  sourceWorkspaceId: workspaceId,\r\n                  byModelDelta: childUsage.byModel,\r\n                  timestamp: Date.now(),\r\n                });\r\n              }\r\n            }\r\n          } catch (error: unknown) {\r\n            log.error(\"Failed to roll up child session usage into parent\", {\r\n              workspaceId,\r\n              parentWorkspaceId,\r\n              error: error instanceof Error ? error.message : String(error),\r\n            });\r\n          }\r\n        }\r\n      } else {\r\n        log.error(`Could not find metadata for workspace ${workspaceId}, creating phantom cleanup`);\r\n      }\r\n\r\n      // Avoid leaking init waiters/logs after workspace deletion.\r\n      // Must happen before deleting the session directory so queued init-status writes don't\r\n      // recreate ~/.mux/sessions/<workspaceId>/ after removal.\r\n      //\r\n      // Intentionally deferred until we're committed to removal: if runtime deletion fails with\r\n      // force=false we return early and keep init state intact so init-end can refresh metadata.\r\n      this.initStateManager.clearInMemoryState(workspaceId);\r\n      // Remove session data\r\n      try {\r\n        const sessionDir = this.config.getSessionDir(workspaceId);\r\n\r\n        if (parentWorkspaceId) {\r\n          try {\r\n            const parentSessionDir = this.config.getSessionDir(parentWorkspaceId);\r\n            await archiveChildSessionArtifactsIntoParentSessionDir({\r\n              parentWorkspaceId,\r\n              parentSessionDir,\r\n              childWorkspaceId: workspaceId,\r\n              childSessionDir: sessionDir,\r\n              childTaskModelString,\r\n              childTaskThinkingLevel,\r\n            });\r\n          } catch (error: unknown) {\r\n            log.error(\"Failed to roll up child session artifacts into parent\", {\r\n              workspaceId,\r\n              parentWorkspaceId,\r\n              error: error instanceof Error ? error.message : String(error),\r\n            });\r\n          }\r\n        }\r\n\r\n        await fsPromises.rm(sessionDir, { recursive: true, force: true });\r\n      } catch (error) {\r\n        log.error(`Failed to remove session directory for ${workspaceId}:`, error);\r\n      }\r\n\r\n      // Stop MCP servers for this workspace\r\n      if (this.mcpServerManager) {\r\n        await this.mcpServerManager.stopServers(workspaceId);\r\n      }\r\n\r\n      // Dispose session\r\n      this.disposeSession(workspaceId);\r\n\r\n      // Close any terminal sessions for this workspace\r\n      this.terminalService?.closeWorkspaceSessions(workspaceId);\r\n\r\n      // Remove from config\r\n      await this.config.removeWorkspace(workspaceId);\r\n\r\n      this.emit(\"metadata\", { workspaceId, metadata: null });\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to remove workspace: ${message}`);\r\n    } finally {\r\n      this.removingWorkspaces.delete(workspaceId);\r\n    }\r\n  }\r\n\r\n  private enrichFrontendMetadata(metadata: FrontendWorkspaceMetadata): FrontendWorkspaceMetadata {\r\n    const isInitializing =\r\n      this.initStateManager.getInitState(metadata.id)?.status === \"running\" || undefined;\r\n    return {\r\n      ...metadata,\r\n      isRemoving: this.removingWorkspaces.has(metadata.id) || undefined,\r\n      isInitializing,\r\n    };\r\n  }\r\n\r\n  private enrichMaybeFrontendMetadata(\r\n    metadata: FrontendWorkspaceMetadata | null\r\n  ): FrontendWorkspaceMetadata | null {\r\n    if (!metadata) {\r\n      return null;\r\n    }\r\n    return this.enrichFrontendMetadata(metadata);\r\n  }\r\n\r\n  async list(): Promise<FrontendWorkspaceMetadata[]> {\r\n    try {\r\n      const workspaces = await this.config.getAllWorkspaceMetadata();\r\n      return workspaces.map((w) => this.enrichFrontendMetadata(w));\r\n    } catch (error) {\r\n      log.error(\"Failed to list workspaces:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get devcontainer info for deep link generation.\r\n   * Returns null if not a devcontainer workspace or container is not running.\r\n   *\r\n   * This queries Docker for the container name (on-demand discovery) and\r\n   * calls ensureReady to get the container workspace path.\r\n   */\r\n  async getDevcontainerInfo(workspaceId: string): Promise<{\r\n    containerName: string;\r\n    containerWorkspacePath: string;\r\n    hostWorkspacePath: string;\r\n  } | null> {\r\n    const metadata = await this.getInfo(workspaceId);\r\n    if (metadata?.runtimeConfig?.type !== \"devcontainer\") {\r\n      return null;\r\n    }\r\n\r\n    const workspace = this.config.findWorkspace(workspaceId);\r\n    if (!workspace) {\r\n      return null;\r\n    }\r\n\r\n    // Get the host workspace path\r\n    const runtimeConfig = metadata.runtimeConfig;\r\n    const runtime = createRuntime(runtimeConfig, {\r\n      projectPath: metadata.projectPath,\r\n      workspaceName: metadata.name,\r\n    });\r\n\r\n    const hostWorkspacePath = runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n\r\n    // Query Docker for container name (on-demand discovery)\r\n    const containerName = await getDevcontainerContainerName(hostWorkspacePath);\r\n    if (!containerName) {\r\n      return null; // Container not running\r\n    }\r\n\r\n    // Get container workspace path via ensureReady (idempotent if already running)\r\n    const readyResult = await runtime.ensureReady();\r\n    if (!readyResult.ready) {\r\n      return null;\r\n    }\r\n\r\n    // Access the cached remoteWorkspaceFolder from DevcontainerRuntime\r\n    const devRuntime = runtime as DevcontainerRuntime;\r\n    const containerWorkspacePath = devRuntime.getRemoteWorkspaceFolder();\r\n    if (!containerWorkspacePath) {\r\n      return null;\r\n    }\r\n\r\n    return { containerName, containerWorkspacePath, hostWorkspacePath };\r\n  }\r\n  async getInfo(workspaceId: string): Promise<FrontendWorkspaceMetadata | null> {\r\n    const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n    const found = allMetadata.find((m) => m.id === workspaceId) ?? null;\r\n    return this.enrichMaybeFrontendMetadata(found);\r\n  }\r\n\r\n  /**\r\n   * Refresh workspace metadata from config and emit to subscribers.\r\n   * Useful when external changes (like section assignment) modify workspace config.\r\n   */\r\n  async refreshAndEmitMetadata(workspaceId: string): Promise<void> {\r\n    const metadata = await this.getInfo(workspaceId);\r\n    if (metadata) {\r\n      this.emit(\"metadata\", { workspaceId, metadata });\r\n    }\r\n  }\r\n\r\n  async rename(workspaceId: string, newName: string): Promise<Result<{ newWorkspaceId: string }>> {\r\n    try {\r\n      if (this.aiService.isStreaming(workspaceId)) {\r\n        return Err(\r\n          \"Cannot rename workspace while AI stream is active. Please wait for the stream to complete.\"\r\n        );\r\n      }\r\n\r\n      const validation = validateWorkspaceName(newName);\r\n      if (!validation.valid) {\r\n        return Err(validation.error ?? \"Invalid workspace name\");\r\n      }\r\n\r\n      // Mark workspace as renaming to block new streams during the rename operation\r\n      this.renamingWorkspaces.add(workspaceId);\r\n\r\n      const metadataResult = await this.aiService.getWorkspaceMetadata(workspaceId);\r\n      if (!metadataResult.success) {\r\n        return Err(`Failed to get workspace metadata: ${metadataResult.error}`);\r\n      }\r\n      const oldMetadata = metadataResult.data;\r\n      const oldName = oldMetadata.name;\r\n\r\n      if (newName === oldName) {\r\n        return Ok({ newWorkspaceId: workspaceId });\r\n      }\r\n\r\n      const allWorkspaces = await this.config.getAllWorkspaceMetadata();\r\n      const collision = allWorkspaces.find(\r\n        (ws) => (ws.name === newName || ws.id === newName) && ws.id !== workspaceId\r\n      );\r\n      if (collision) {\r\n        return Err(`Workspace with name \"${newName}\" already exists`);\r\n      }\r\n\r\n      const workspace = this.config.findWorkspace(workspaceId);\r\n      if (!workspace) {\r\n        return Err(\"Failed to find workspace in config\");\r\n      }\r\n      const { projectPath } = workspace;\r\n\r\n      const runtime = createRuntime(oldMetadata.runtimeConfig, {\r\n        projectPath,\r\n        workspaceName: oldName,\r\n      });\r\n\r\n      const renameResult = await runtime.renameWorkspace(projectPath, oldName, newName);\r\n\r\n      if (!renameResult.success) {\r\n        return Err(renameResult.error);\r\n      }\r\n\r\n      const { oldPath, newPath } = renameResult;\r\n\r\n      await this.config.editConfig((config) => {\r\n        const projectConfig = config.projects.get(projectPath);\r\n        if (projectConfig) {\r\n          const workspaceEntry =\r\n            projectConfig.workspaces.find((w) => w.id === workspaceId) ??\r\n            projectConfig.workspaces.find((w) => w.path === oldPath);\r\n          if (workspaceEntry) {\r\n            workspaceEntry.name = newName;\r\n            workspaceEntry.path = newPath;\r\n          }\r\n        }\r\n        return config;\r\n      });\r\n\r\n      // Rename plan file if it exists (uses workspace name, not ID)\r\n      await movePlanFile(runtime, oldName, newName, oldMetadata.projectName);\r\n\r\n      const allMetadataUpdated = await this.config.getAllWorkspaceMetadata();\r\n      const updatedMetadata = allMetadataUpdated.find((m) => m.id === workspaceId);\r\n      if (!updatedMetadata) {\r\n        return Err(\"Failed to retrieve updated workspace metadata\");\r\n      }\r\n\r\n      const enrichedMetadata = this.enrichFrontendMetadata(updatedMetadata);\r\n\r\n      const session = this.sessions.get(workspaceId);\r\n      if (session) {\r\n        session.emitMetadata(enrichedMetadata);\r\n      } else {\r\n        this.emit(\"metadata\", { workspaceId, metadata: enrichedMetadata });\r\n      }\r\n\r\n      return Ok({ newWorkspaceId: workspaceId });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to rename workspace: ${message}`);\r\n    } finally {\r\n      // Always clear renaming flag, even on error\r\n      this.renamingWorkspaces.delete(workspaceId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update workspace title without affecting the filesystem name.\r\n   * Unlike rename(), this can be called even while streaming is active.\r\n   */\r\n  async updateTitle(workspaceId: string, title: string): Promise<Result<void>> {\r\n    try {\r\n      const workspace = this.config.findWorkspace(workspaceId);\r\n      if (!workspace) {\r\n        return Err(\"Workspace not found\");\r\n      }\r\n      const { projectPath, workspacePath } = workspace;\r\n\r\n      await this.config.editConfig((config) => {\r\n        const projectConfig = config.projects.get(projectPath);\r\n        if (projectConfig) {\r\n          const workspaceEntry =\r\n            projectConfig.workspaces.find((w) => w.id === workspaceId) ??\r\n            projectConfig.workspaces.find((w) => w.path === workspacePath);\r\n          if (workspaceEntry) {\r\n            workspaceEntry.title = title;\r\n          }\r\n        }\r\n        return config;\r\n      });\r\n\r\n      // Emit updated metadata\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const updatedMetadata = allMetadata.find((m) => m.id === workspaceId);\r\n      if (updatedMetadata) {\r\n        const enrichedMetadata = this.enrichFrontendMetadata(updatedMetadata);\r\n        const session = this.sessions.get(workspaceId);\r\n        if (session) {\r\n          session.emitMetadata(enrichedMetadata);\r\n        } else {\r\n          this.emit(\"metadata\", { workspaceId, metadata: enrichedMetadata });\r\n        }\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to update workspace title: ${message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Archive a workspace. Archived workspaces are hidden from the main sidebar\r\n   * but can be viewed on the project page.\r\n   *\r\n   * If init is still running, we abort it before archiving so we don't leave\r\n   * orphaned post-create work running in the background.\r\n   */\r\n  async archive(workspaceId: string): Promise<Result<void>> {\r\n    if (workspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n      return Err(\"Cannot archive the Chat with Mux system workspace\");\r\n    }\r\n\r\n    this.archivingWorkspaces.add(workspaceId);\r\n\r\n    try {\r\n      const workspace = this.config.findWorkspace(workspaceId);\r\n      if (!workspace) {\r\n        return Err(\"Workspace not found\");\r\n      }\r\n      const initState = this.initStateManager.getInitState(workspaceId);\r\n      if (initState?.status === \"running\") {\r\n        // Archiving should not leave post-create setup running in the background.\r\n        const initAbortController = this.initAbortControllers.get(workspaceId);\r\n        if (initAbortController) {\r\n          initAbortController.abort();\r\n          this.initAbortControllers.delete(workspaceId);\r\n        }\r\n\r\n        this.initStateManager.clearInMemoryState(workspaceId);\r\n\r\n        // Clearing init state prevents init-end from firing (createInitLogger.logComplete() bails when\r\n        // state is missing). If archiving fails before we persist archivedAt (e.g., beforeArchive hook\r\n        // error), ensure the sidebar doesn't stay stuck on isInitializing/\"Cancel creation\".\r\n        try {\r\n          const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n          const updatedMetadata = allMetadata.find((m) => m.id === workspaceId);\r\n          if (updatedMetadata) {\r\n            const enrichedMetadata = this.enrichFrontendMetadata(updatedMetadata);\r\n            const session = this.sessions.get(workspaceId);\r\n            if (session) {\r\n              session.emitMetadata(enrichedMetadata);\r\n            } else {\r\n              this.emit(\"metadata\", { workspaceId, metadata: enrichedMetadata });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          log.debug(\"Failed to emit metadata after init cancellation during archive\", {\r\n            workspaceId,\r\n            error: error instanceof Error ? error.message : String(error),\r\n          });\r\n        }\r\n      }\r\n\r\n      const { projectPath, workspacePath } = workspace;\r\n\r\n      // Lifecycle hooks run *before* we persist archivedAt.\r\n      //\r\n      // NOTE: Archiving is typically a quick UI action, but it can fail if a hook needs to perform\r\n      // cleanup (e.g., stopping a dedicated mux-created Coder workspace) and that cleanup fails.\r\n      if (this.workspaceLifecycleHooks) {\r\n        const metadataResult = await this.aiService.getWorkspaceMetadata(workspaceId);\r\n        if (!metadataResult.success) {\r\n          return Err(metadataResult.error);\r\n        }\r\n\r\n        const hookResult = await this.workspaceLifecycleHooks.runBeforeArchive({\r\n          workspaceId,\r\n          workspaceMetadata: metadataResult.data,\r\n        });\r\n        if (!hookResult.success) {\r\n          return Err(hookResult.error);\r\n        }\r\n      }\r\n\r\n      // Archiving removes the workspace from the sidebar; ensure we don't leave a stream running\r\n      // \"headless\" with no obvious UI affordance to interrupt it.\r\n      //\r\n      // NOTE: We only interrupt after beforeArchive hooks succeed, so a hook failure doesn't stop\r\n      // an active stream.\r\n      if (this.aiService.isStreaming(workspaceId)) {\r\n        const stopResult = await this.interruptStream(workspaceId);\r\n        if (!stopResult.success) {\r\n          log.debug(\"Failed to stop stream during workspace archive\", {\r\n            workspaceId,\r\n            error: stopResult.error,\r\n          });\r\n        }\r\n      }\r\n\r\n      await this.config.editConfig((config) => {\r\n        const projectConfig = config.projects.get(projectPath);\r\n        if (projectConfig) {\r\n          const workspaceEntry =\r\n            projectConfig.workspaces.find((w) => w.id === workspaceId) ??\r\n            projectConfig.workspaces.find((w) => w.path === workspacePath);\r\n          if (workspaceEntry) {\r\n            // Just set archivedAt - archived state is derived from archivedAt > unarchivedAt\r\n            workspaceEntry.archivedAt = new Date().toISOString();\r\n          }\r\n        }\r\n        return config;\r\n      });\r\n\r\n      // Emit updated metadata\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const updatedMetadata = allMetadata.find((m) => m.id === workspaceId);\r\n      if (updatedMetadata) {\r\n        const enrichedMetadata = this.enrichFrontendMetadata(updatedMetadata);\r\n        const session = this.sessions.get(workspaceId);\r\n        if (session) {\r\n          session.emitMetadata(enrichedMetadata);\r\n        } else {\r\n          this.emit(\"metadata\", { workspaceId, metadata: enrichedMetadata });\r\n        }\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to archive workspace: ${message}`);\r\n    } finally {\r\n      this.archivingWorkspaces.delete(workspaceId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unarchive a workspace. Restores it to the main sidebar view.\r\n   */\r\n  async unarchive(workspaceId: string): Promise<Result<void>> {\r\n    if (workspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n      return Err(\"Cannot unarchive the Chat with Mux system workspace\");\r\n    }\r\n\r\n    try {\r\n      const workspace = this.config.findWorkspace(workspaceId);\r\n      if (!workspace) {\r\n        return Err(\"Workspace not found\");\r\n      }\r\n      const { projectPath, workspacePath } = workspace;\r\n\r\n      let didUnarchive = false;\r\n\r\n      await this.config.editConfig((config) => {\r\n        const projectConfig = config.projects.get(projectPath);\r\n        if (projectConfig) {\r\n          const workspaceEntry =\r\n            projectConfig.workspaces.find((w) => w.id === workspaceId) ??\r\n            projectConfig.workspaces.find((w) => w.path === workspacePath);\r\n          if (workspaceEntry) {\r\n            const wasArchived = isWorkspaceArchived(\r\n              workspaceEntry.archivedAt,\r\n              workspaceEntry.unarchivedAt\r\n            );\r\n            if (wasArchived) {\r\n              // Just set unarchivedAt - archived state is derived from archivedAt > unarchivedAt.\r\n              // This also bumps workspace to top of recency.\r\n              workspaceEntry.unarchivedAt = new Date().toISOString();\r\n              didUnarchive = true;\r\n            }\r\n          }\r\n        }\r\n        return config;\r\n      });\r\n\r\n      // Only run hooks when the workspace is transitioning from archived  unarchived.\r\n      if (!didUnarchive) {\r\n        return Ok(undefined);\r\n      }\r\n\r\n      // Emit updated metadata\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const updatedMetadata = allMetadata.find((m) => m.id === workspaceId);\r\n      if (updatedMetadata) {\r\n        const enrichedMetadata = this.enrichFrontendMetadata(updatedMetadata);\r\n        const session = this.sessions.get(workspaceId);\r\n        if (session) {\r\n          session.emitMetadata(enrichedMetadata);\r\n        } else {\r\n          this.emit(\"metadata\", { workspaceId, metadata: enrichedMetadata });\r\n        }\r\n      }\r\n\r\n      // Lifecycle hooks run *after* we persist unarchivedAt.\r\n      //\r\n      // Why best-effort: Unarchive is a quick UI action and should not fail permanently due to a\r\n      // start error (e.g., Coder workspace start).\r\n      if (this.workspaceLifecycleHooks) {\r\n        let hookMetadata: WorkspaceMetadata | undefined = updatedMetadata;\r\n        if (!hookMetadata) {\r\n          const metadataResult = await this.aiService.getWorkspaceMetadata(workspaceId);\r\n          if (metadataResult.success) {\r\n            hookMetadata = metadataResult.data;\r\n          } else {\r\n            log.debug(\"Failed to load workspace metadata for afterUnarchive hooks\", {\r\n              workspaceId,\r\n              error: metadataResult.error,\r\n            });\r\n          }\r\n        }\r\n\r\n        if (hookMetadata) {\r\n          await this.workspaceLifecycleHooks.runAfterUnarchive({\r\n            workspaceId,\r\n            workspaceMetadata: hookMetadata,\r\n          });\r\n        }\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to unarchive workspace: ${message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Archive all non-archived workspaces within a project whose GitHub PR is merged.\r\n   *\r\n   * This is intended for a single command-palette action (one backend call), to avoid\r\n   * O(n) frontendbackend loops.\r\n   */\r\n  async archiveMergedInProject(projectPath: string): Promise<Result<ArchiveMergedInProjectResult>> {\r\n    const targetProjectPath = projectPath.trim();\r\n    if (!targetProjectPath) {\r\n      return Err(\"projectPath is required\");\r\n    }\r\n\r\n    const archivedWorkspaceIds: string[] = [];\r\n    const skippedWorkspaceIds: string[] = [];\r\n    const errors: Array<{ workspaceId: string; error: string }> = [];\r\n\r\n    try {\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n\r\n      const candidates = allMetadata.filter((metadata) => {\r\n        if (metadata.id === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n          return false;\r\n        }\r\n        if (metadata.projectPath !== targetProjectPath) {\r\n          return false;\r\n        }\r\n        return !isWorkspaceArchived(metadata.archivedAt, metadata.unarchivedAt);\r\n      });\r\n\r\n      const mergedWorkspaceIds: string[] = [];\r\n\r\n      const GH_CONCURRENCY_LIMIT = 4;\r\n      const GH_TIMEOUT_SECS = 15;\r\n\r\n      await forEachWithConcurrencyLimit(candidates, GH_CONCURRENCY_LIMIT, async (metadata) => {\r\n        const workspaceId = metadata.id;\r\n\r\n        try {\r\n          const result = await this.executeBash(\r\n            workspaceId,\r\n            `gh pr view --json state 2>/dev/null || echo '{\"no_pr\":true}'`,\r\n            { timeout_secs: GH_TIMEOUT_SECS }\r\n          );\r\n\r\n          if (!result.success) {\r\n            errors.push({ workspaceId, error: result.error });\r\n            return;\r\n          }\r\n\r\n          if (!result.data.success) {\r\n            errors.push({ workspaceId, error: result.data.error });\r\n            return;\r\n          }\r\n\r\n          const output = result.data.output;\r\n          if (!output || output.trim().length === 0) {\r\n            errors.push({ workspaceId, error: \"gh pr view returned empty output\" });\r\n            return;\r\n          }\r\n\r\n          let parsed: unknown;\r\n          try {\r\n            parsed = JSON.parse(output);\r\n          } catch (error) {\r\n            const message = error instanceof Error ? error.message : String(error);\r\n            errors.push({ workspaceId, error: `Failed to parse gh output: ${message}` });\r\n            return;\r\n          }\r\n\r\n          if (typeof parsed !== \"object\" || parsed === null) {\r\n            errors.push({ workspaceId, error: \"Unexpected gh output: not a JSON object\" });\r\n            return;\r\n          }\r\n\r\n          const record = parsed as Record<string, unknown>;\r\n\r\n          if (\"no_pr\" in record) {\r\n            skippedWorkspaceIds.push(workspaceId);\r\n            return;\r\n          }\r\n\r\n          if (record.state === \"MERGED\") {\r\n            mergedWorkspaceIds.push(workspaceId);\r\n            return;\r\n          }\r\n\r\n          skippedWorkspaceIds.push(workspaceId);\r\n        } catch (error) {\r\n          const message = error instanceof Error ? error.message : String(error);\r\n          errors.push({ workspaceId, error: message });\r\n        }\r\n      });\r\n\r\n      // Archive sequentially: config.editConfig is not mutex-protected.\r\n      for (const workspaceId of mergedWorkspaceIds) {\r\n        const result = await this.archive(workspaceId);\r\n        if (!result.success) {\r\n          errors.push({ workspaceId, error: result.error });\r\n          continue;\r\n        }\r\n        archivedWorkspaceIds.push(workspaceId);\r\n      }\r\n\r\n      archivedWorkspaceIds.sort();\r\n      skippedWorkspaceIds.sort();\r\n      errors.sort((a, b) => a.workspaceId.localeCompare(b.workspaceId));\r\n\r\n      return Ok({\r\n        archivedWorkspaceIds,\r\n        skippedWorkspaceIds,\r\n        errors,\r\n      });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to archive merged workspaces: ${message}`);\r\n    }\r\n  }\r\n\r\n  private normalizeWorkspaceAISettings(\r\n    aiSettings: WorkspaceAISettings\r\n  ): Result<WorkspaceAISettings, string> {\r\n    const rawModel = aiSettings.model;\r\n    const model = normalizeGatewayModel(rawModel).trim();\r\n    if (!model) {\r\n      return Err(\"Model is required\");\r\n    }\r\n    if (!isValidModelFormat(model)) {\r\n      return Err(`Invalid model format: ${rawModel}`);\r\n    }\r\n\r\n    return Ok({\r\n      model,\r\n      thinkingLevel: aiSettings.thinkingLevel,\r\n    });\r\n  }\r\n\r\n  private normalizeSendMessageAgentId(options: SendMessageOptions): SendMessageOptions {\r\n    // agentId is required by the schema, so this just normalizes the value.\r\n    const rawAgentId = options.agentId;\r\n    const normalizedAgentId =\r\n      typeof rawAgentId === \"string\" && rawAgentId.trim().length > 0\r\n        ? rawAgentId.trim().toLowerCase()\r\n        : WORKSPACE_DEFAULTS.agentId;\r\n\r\n    if (normalizedAgentId === options.agentId) {\r\n      return options;\r\n    }\r\n\r\n    return {\r\n      ...options,\r\n      agentId: normalizedAgentId,\r\n    };\r\n  }\r\n\r\n  private extractWorkspaceAISettingsFromSendOptions(\r\n    options: SendMessageOptions | undefined\r\n  ): WorkspaceAISettings | null {\r\n    const rawModel = options?.model;\r\n    if (typeof rawModel !== \"string\" || rawModel.trim().length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const model = normalizeGatewayModel(rawModel).trim();\r\n    if (!isValidModelFormat(model)) {\r\n      return null;\r\n    }\r\n\r\n    const requestedThinking = options?.thinkingLevel;\r\n    // Be defensive: if a (very) old client doesn't send thinkingLevel, don't overwrite\r\n    // any existing workspace-scoped value.\r\n    if (requestedThinking === undefined) {\r\n      return null;\r\n    }\r\n\r\n    const thinkingLevel = requestedThinking;\r\n\r\n    return { model, thinkingLevel };\r\n  }\r\n\r\n  /**\r\n   * Best-effort persist AI settings from send/resume options.\r\n   * Skips requests explicitly marked to avoid persistence.\r\n   */\r\n  private async maybePersistAISettingsFromOptions(\r\n    workspaceId: string,\r\n    options: SendMessageOptions | undefined,\r\n    context: \"send\" | \"resume\"\r\n  ): Promise<void> {\r\n    if (options?.skipAiSettingsPersistence) {\r\n      // One-shot/compaction sends shouldn't overwrite workspace defaults.\r\n      return;\r\n    }\r\n\r\n    const extractedSettings = this.extractWorkspaceAISettingsFromSendOptions(options);\r\n    if (!extractedSettings) return;\r\n\r\n    const rawAgentId = options?.agentId;\r\n    const agentId =\r\n      typeof rawAgentId === \"string\" && rawAgentId.trim().length > 0\r\n        ? rawAgentId.trim().toLowerCase()\r\n        : WORKSPACE_DEFAULTS.agentId;\r\n\r\n    const persistResult = await this.persistWorkspaceAISettingsForAgent(\r\n      workspaceId,\r\n      agentId,\r\n      extractedSettings,\r\n      {\r\n        emitMetadata: false,\r\n      }\r\n    );\r\n    if (!persistResult.success) {\r\n      log.debug(`Failed to persist workspace AI settings from ${context} options`, {\r\n        workspaceId,\r\n        error: persistResult.error,\r\n      });\r\n    }\r\n  }\r\n\r\n  private async persistWorkspaceAISettingsForAgent(\r\n    workspaceId: string,\r\n    agentId: string,\r\n    aiSettings: WorkspaceAISettings,\r\n    options?: { emitMetadata?: boolean }\r\n  ): Promise<Result<boolean, string>> {\r\n    const found = this.config.findWorkspace(workspaceId);\r\n    if (!found) {\r\n      return Err(\"Workspace not found\");\r\n    }\r\n\r\n    const { projectPath, workspacePath } = found;\r\n\r\n    const config = this.config.loadConfigOrDefault();\r\n    const projectConfig = config.projects.get(projectPath);\r\n    if (!projectConfig) {\r\n      return Err(`Project not found: ${projectPath}`);\r\n    }\r\n\r\n    const workspaceEntry = projectConfig.workspaces.find((w) => w.id === workspaceId);\r\n    const workspaceEntryWithFallback =\r\n      workspaceEntry ?? projectConfig.workspaces.find((w) => w.path === workspacePath);\r\n    if (!workspaceEntryWithFallback) {\r\n      return Err(\"Workspace not found\");\r\n    }\r\n\r\n    const normalizedAgentId = agentId.trim().toLowerCase();\r\n    if (!normalizedAgentId) {\r\n      return Err(\"Agent ID is required\");\r\n    }\r\n\r\n    const prev = workspaceEntryWithFallback.aiSettingsByAgent?.[normalizedAgentId];\r\n    const changed =\r\n      prev?.model !== aiSettings.model || prev?.thinkingLevel !== aiSettings.thinkingLevel;\r\n    if (!changed) {\r\n      return Ok(false);\r\n    }\r\n\r\n    workspaceEntryWithFallback.aiSettingsByAgent = {\r\n      ...(workspaceEntryWithFallback.aiSettingsByAgent ?? {}),\r\n      [normalizedAgentId]: aiSettings,\r\n    };\r\n\r\n    await this.config.saveConfig(config);\r\n\r\n    if (options?.emitMetadata !== false) {\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const updatedMetadata = allMetadata.find((m) => m.id === workspaceId) ?? null;\r\n      const enrichedMetadata = this.enrichMaybeFrontendMetadata(updatedMetadata);\r\n\r\n      const session = this.sessions.get(workspaceId);\r\n      if (session) {\r\n        session.emitMetadata(enrichedMetadata);\r\n      } else {\r\n        this.emit(\"metadata\", { workspaceId, metadata: enrichedMetadata });\r\n      }\r\n    }\r\n\r\n    return Ok(true);\r\n  }\r\n\r\n  async updateModeAISettings(\r\n    workspaceId: string,\r\n    mode: UIMode,\r\n    aiSettings: WorkspaceAISettings\r\n  ): Promise<Result<void, string>> {\r\n    // Mode-based updates use mode as the agentId.\r\n    return this.updateAgentAISettings(workspaceId, mode, aiSettings);\r\n  }\r\n\r\n  async updateAgentAISettings(\r\n    workspaceId: string,\r\n    agentId: string,\r\n    aiSettings: WorkspaceAISettings\r\n  ): Promise<Result<void, string>> {\r\n    try {\r\n      const normalized = this.normalizeWorkspaceAISettings(aiSettings);\r\n      if (!normalized.success) {\r\n        return Err(normalized.error);\r\n      }\r\n\r\n      const persistResult = await this.persistWorkspaceAISettingsForAgent(\r\n        workspaceId,\r\n        agentId,\r\n        normalized.data,\r\n        {\r\n          emitMetadata: true,\r\n        }\r\n      );\r\n      if (!persistResult.success) {\r\n        return Err(persistResult.error);\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to update workspace AI settings: ${message}`);\r\n    }\r\n  }\r\n\r\n  async fork(\r\n    sourceWorkspaceId: string,\r\n    newName: string\r\n  ): Promise<Result<{ metadata: FrontendWorkspaceMetadata; projectPath: string }>> {\r\n    try {\r\n      if (sourceWorkspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n        return Err(\"Cannot fork the Chat with Mux system workspace\");\r\n      }\r\n\r\n      const validation = validateWorkspaceName(newName);\r\n      if (!validation.valid) {\r\n        return Err(validation.error ?? \"Invalid workspace name\");\r\n      }\r\n\r\n      if (this.aiService.isStreaming(sourceWorkspaceId)) {\r\n        await this.partialService.commitToHistory(sourceWorkspaceId);\r\n      }\r\n\r\n      const sourceMetadataResult = await this.aiService.getWorkspaceMetadata(sourceWorkspaceId);\r\n      if (!sourceMetadataResult.success) {\r\n        return Err(`Failed to get source workspace metadata: ${sourceMetadataResult.error}`);\r\n      }\r\n      const sourceMetadata = sourceMetadataResult.data;\r\n      const foundProjectPath = sourceMetadata.projectPath;\r\n      const projectName = sourceMetadata.projectName;\r\n      const sourceRuntimeConfig = sourceMetadata.runtimeConfig;\r\n\r\n      // Policy: do not allow creating new workspaces (including via fork) with a disallowed runtime.\r\n      if (this.policyService?.isEnforced()) {\r\n        if (!this.policyService.isRuntimeAllowed(sourceRuntimeConfig)) {\r\n          return Err(\"Forking this workspace is not allowed by policy (runtime disabled)\");\r\n        }\r\n      }\r\n\r\n      // Block fork for Docker runtimes - creates broken workspaces.\r\n      // Sub-agent task spawning uses a different code path (TaskService.create).\r\n      if (isDockerRuntime(sourceRuntimeConfig)) {\r\n        return Err(\"Forking Docker workspaces is not supported. Create a new workspace instead.\");\r\n      }\r\n\r\n      const runtime = createRuntime(sourceRuntimeConfig, {\r\n        projectPath: foundProjectPath,\r\n        workspaceName: sourceMetadata.name,\r\n      });\r\n\r\n      const newWorkspaceId = this.config.generateStableId();\r\n\r\n      const session = this.getOrCreateSession(newWorkspaceId);\r\n      this.initStateManager.startInit(newWorkspaceId, foundProjectPath);\r\n      const initLogger = this.createInitLogger(newWorkspaceId);\r\n\r\n      const forkResult = await runtime.forkWorkspace({\r\n        projectPath: foundProjectPath,\r\n        sourceWorkspaceName: sourceMetadata.name,\r\n        newWorkspaceName: newName,\r\n        initLogger,\r\n      });\r\n\r\n      if (!forkResult.success) {\r\n        initLogger.logComplete(-1);\r\n        return Err(forkResult.error ?? \"Failed to fork workspace\");\r\n      }\r\n\r\n      // Run init for forked workspace (fire-and-forget like create())\r\n      // Use sourceBranch as trunk since fork is based on source workspace's branch\r\n      const secrets = secretsToRecord(this.config.getEffectiveSecrets(foundProjectPath));\r\n\r\n      const initAbortController = new AbortController();\r\n      this.initAbortControllers.set(newWorkspaceId, initAbortController);\r\n      runBackgroundInit(\r\n        runtime,\r\n        {\r\n          projectPath: foundProjectPath,\r\n          branchName: newName,\r\n          trunkBranch: forkResult.sourceBranch ?? \"main\",\r\n          workspacePath: forkResult.workspacePath!,\r\n          initLogger,\r\n          env: secrets,\r\n          abortSignal: initAbortController.signal,\r\n        },\r\n        newWorkspaceId,\r\n        log\r\n      );\r\n\r\n      const sourceSessionDir = this.config.getSessionDir(sourceWorkspaceId);\r\n      const newSessionDir = this.config.getSessionDir(newWorkspaceId);\r\n\r\n      try {\r\n        await fsPromises.mkdir(newSessionDir, { recursive: true });\r\n\r\n        const sourceChatPath = path.join(sourceSessionDir, \"chat.jsonl\");\r\n        const newChatPath = path.join(newSessionDir, \"chat.jsonl\");\r\n        try {\r\n          await fsPromises.copyFile(sourceChatPath, newChatPath);\r\n        } catch (error) {\r\n          if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\r\n            throw error;\r\n          }\r\n        }\r\n\r\n        const sourcePartialPath = path.join(sourceSessionDir, \"partial.json\");\r\n        const newPartialPath = path.join(newSessionDir, \"partial.json\");\r\n        try {\r\n          await fsPromises.copyFile(sourcePartialPath, newPartialPath);\r\n        } catch (error) {\r\n          if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\r\n            throw error;\r\n          }\r\n        }\r\n\r\n        const sourceTimingPath = path.join(sourceSessionDir, \"session-timing.json\");\r\n        const newTimingPath = path.join(newSessionDir, \"session-timing.json\");\r\n        try {\r\n          await fsPromises.copyFile(sourceTimingPath, newTimingPath);\r\n        } catch (error) {\r\n          if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\r\n            throw error;\r\n          }\r\n        }\r\n        const sourceUsagePath = path.join(sourceSessionDir, \"session-usage.json\");\r\n        const newUsagePath = path.join(newSessionDir, \"session-usage.json\");\r\n        try {\r\n          await fsPromises.copyFile(sourceUsagePath, newUsagePath);\r\n        } catch (error) {\r\n          if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\r\n            throw error;\r\n          }\r\n        }\r\n      } catch (copyError) {\r\n        await runtime.deleteWorkspace(foundProjectPath, newName, true);\r\n        try {\r\n          await fsPromises.rm(newSessionDir, { recursive: true, force: true });\r\n        } catch (cleanupError) {\r\n          log.error(`Failed to clean up session dir ${newSessionDir}:`, cleanupError);\r\n        }\r\n        initLogger.logComplete(-1);\r\n        const message = copyError instanceof Error ? copyError.message : String(copyError);\r\n        return Err(`Failed to copy chat history: ${message}`);\r\n      }\r\n\r\n      // Copy plan file if it exists (checks both new and legacy paths)\r\n      await copyPlanFile(runtime, sourceMetadata.name, sourceWorkspaceId, newName, projectName);\r\n\r\n      // Apply runtime-provided config updates (e.g., Coder marks shared workspaces)\r\n      const { forkedRuntimeConfig } = await applyForkRuntimeUpdates(\r\n        this.config,\r\n        sourceWorkspaceId,\r\n        sourceRuntimeConfig,\r\n        forkResult\r\n      );\r\n\r\n      if (forkResult.sourceRuntimeConfig) {\r\n        const allMetadataUpdated = await this.config.getAllWorkspaceMetadata();\r\n        const updatedMetadata = allMetadataUpdated.find((m) => m.id === sourceWorkspaceId) ?? null;\r\n        const enrichedMetadata = this.enrichMaybeFrontendMetadata(updatedMetadata);\r\n        const sourceSession = this.sessions.get(sourceWorkspaceId);\r\n        if (sourceSession) {\r\n          sourceSession.emitMetadata(enrichedMetadata);\r\n        } else {\r\n          this.emit(\"metadata\", { workspaceId: sourceWorkspaceId, metadata: enrichedMetadata });\r\n        }\r\n      }\r\n\r\n      // Compute namedWorkspacePath for frontend metadata\r\n      const namedWorkspacePath = runtime.getWorkspacePath(foundProjectPath, newName);\r\n\r\n      const metadata: FrontendWorkspaceMetadata = {\r\n        id: newWorkspaceId,\r\n        name: newName,\r\n        projectName,\r\n        projectPath: foundProjectPath,\r\n        createdAt: new Date().toISOString(),\r\n        runtimeConfig: forkedRuntimeConfig,\r\n        namedWorkspacePath,\r\n        // Preserve workspace organization when forking via /fork.\r\n        sectionId: sourceMetadata.sectionId,\r\n      };\r\n\r\n      await this.config.addWorkspace(foundProjectPath, metadata);\r\n\r\n      const enrichedMetadata = this.enrichFrontendMetadata(metadata);\r\n      session.emitMetadata(enrichedMetadata);\r\n\r\n      return Ok({ metadata: enrichedMetadata, projectPath: foundProjectPath });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to fork workspace: ${message}`);\r\n    }\r\n  }\r\n\r\n  async sendMessage(\r\n    workspaceId: string,\r\n    message: string,\r\n    options: SendMessageOptions & {\r\n      fileParts?: FilePart[];\r\n    },\r\n    internal?: {\r\n      allowQueuedAgentTask?: boolean;\r\n      skipAutoResumeReset?: boolean;\r\n      synthetic?: boolean;\r\n    }\r\n  ): Promise<Result<void, SendMessageError>> {\r\n    log.debug(\"sendMessage handler: Received\", {\r\n      workspaceId,\r\n      messagePreview: message.substring(0, 50),\r\n      agentId: options?.agentId,\r\n      options,\r\n    });\r\n\r\n    try {\r\n      // Block streaming while workspace is being renamed to prevent path conflicts\r\n      if (this.renamingWorkspaces.has(workspaceId)) {\r\n        log.debug(\"sendMessage blocked: workspace is being renamed\", { workspaceId });\r\n        return Err({\r\n          type: \"unknown\",\r\n          raw: \"Workspace is being renamed. Please wait and try again.\",\r\n        });\r\n      }\r\n\r\n      // Block streaming while workspace is being removed to prevent races with config/session deletion.\r\n      if (this.removingWorkspaces.has(workspaceId)) {\r\n        log.debug(\"sendMessage blocked: workspace is being removed\", { workspaceId });\r\n        return Err({\r\n          type: \"unknown\",\r\n          raw: \"Workspace is being deleted. Please wait and try again.\",\r\n        });\r\n      }\r\n\r\n      // Guard: avoid creating sessions for workspaces that don't exist anymore.\r\n      if (!this.config.findWorkspace(workspaceId)) {\r\n        return Err({\r\n          type: \"unknown\",\r\n          raw: \"Workspace not found. It may have been deleted.\",\r\n        });\r\n      }\r\n\r\n      // Guard: queued agent tasks must not start streaming via generic sendMessage calls.\r\n      // They should only be started by TaskService once a parallel slot is available.\r\n      if (!internal?.allowQueuedAgentTask) {\r\n        const config = this.config.loadConfigOrDefault();\r\n        for (const [_projectPath, project] of config.projects) {\r\n          const ws = project.workspaces.find((w) => w.id === workspaceId);\r\n          if (!ws) continue;\r\n          if (ws.parentWorkspaceId && ws.taskStatus === \"queued\") {\r\n            taskQueueDebug(\"WorkspaceService.sendMessage blocked (queued task)\", {\r\n              workspaceId,\r\n              stack: new Error(\"sendMessage blocked\").stack,\r\n            });\r\n            return Err({\r\n              type: \"unknown\",\r\n              raw: \"This agent task is queued and cannot start yet. Wait for a slot to free.\",\r\n            });\r\n          }\r\n          break;\r\n        }\r\n      } else {\r\n        taskQueueDebug(\"WorkspaceService.sendMessage allowed (internal dequeue)\", {\r\n          workspaceId,\r\n          stack: new Error(\"sendMessage internal\").stack,\r\n        });\r\n      }\r\n\r\n      const session = this.getOrCreateSession(workspaceId);\r\n\r\n      // Skip recency update for idle compaction - preserve original \"last used\" time\r\n      const muxMeta = options?.muxMetadata as { type?: string; source?: string } | undefined;\r\n      const isIdleCompaction =\r\n        muxMeta?.type === \"compaction-request\" && muxMeta?.source === \"idle-compaction\";\r\n      // Use current time for recency - this matches the timestamp used on the message\r\n      // in agentSession.sendMessage(). Keeps ExtensionMetadata in sync with chat.jsonl.\r\n      const messageTimestamp = Date.now();\r\n      if (!isIdleCompaction) {\r\n        void this.updateRecencyTimestamp(workspaceId, messageTimestamp);\r\n      }\r\n\r\n      // Experiments: resolve flags respecting userOverridable setting.\r\n      // - If userOverridable && frontend provides a value (explicit override)  use frontend value\r\n      // - Else if remote evaluation enabled  use PostHog assignment\r\n      // - Else  use frontend value (dev fallback) or default\r\n      const system1Experiment = EXPERIMENTS[EXPERIMENT_IDS.SYSTEM_1];\r\n      const system1FrontendValue = options?.experiments?.system1;\r\n\r\n      let system1Enabled: boolean | undefined;\r\n      if (system1Experiment.userOverridable && system1FrontendValue !== undefined) {\r\n        // User-overridable: trust frontend value (user's explicit choice)\r\n        system1Enabled = system1FrontendValue;\r\n      } else if (this.experimentsService?.isRemoteEvaluationEnabled() === true) {\r\n        // Remote evaluation: use PostHog assignment\r\n        system1Enabled = this.experimentsService.isExperimentEnabled(EXPERIMENT_IDS.SYSTEM_1);\r\n      } else {\r\n        // Fallback to frontend value (dev mode or telemetry disabled)\r\n        system1Enabled = system1FrontendValue;\r\n      }\r\n\r\n      const resolvedExperiments: Record<string, boolean> = {};\r\n      if (system1Enabled !== undefined) {\r\n        resolvedExperiments.system1 = system1Enabled;\r\n      }\r\n\r\n      const resolvedOptions =\r\n        Object.keys(resolvedExperiments).length === 0\r\n          ? options\r\n          : {\r\n            ...options,\r\n            experiments: {\r\n              ...(options.experiments ?? {}),\r\n              ...resolvedExperiments,\r\n            },\r\n          };\r\n\r\n      const normalizedOptions = this.normalizeSendMessageAgentId(resolvedOptions);\r\n\r\n      // Persist last-used model + thinking level for cross-device consistency.\r\n      await this.maybePersistAISettingsFromOptions(workspaceId, normalizedOptions, \"send\");\r\n\r\n      const shouldQueue =\r\n        !normalizedOptions?.editMessageId &&\r\n        (this.aiService.isStreaming(workspaceId) || session.isStreamStarting());\r\n\r\n      if (shouldQueue) {\r\n        const pendingAskUserQuestion = askUserQuestionManager.getLatestPending(workspaceId);\r\n        if (pendingAskUserQuestion) {\r\n          try {\r\n            askUserQuestionManager.cancel(\r\n              workspaceId,\r\n              pendingAskUserQuestion.toolCallId,\r\n              \"User responded in chat; questions canceled\"\r\n            );\r\n          } catch (error) {\r\n            log.debug(\"Failed to cancel pending ask_user_question\", {\r\n              workspaceId,\r\n              toolCallId: pendingAskUserQuestion.toolCallId,\r\n              error: error instanceof Error ? error.message : String(error),\r\n            });\r\n          }\r\n        }\r\n\r\n        session.queueMessage(message, normalizedOptions);\r\n        return Ok(undefined);\r\n      }\r\n\r\n      if (!internal?.skipAutoResumeReset) {\r\n        this.taskService?.resetAutoResumeCount(workspaceId);\r\n      }\r\n      const result = await session.sendMessage(message, normalizedOptions, {\r\n        synthetic: internal?.synthetic,\r\n      });\r\n      if (!result.success) {\r\n        log.error(\"sendMessage handler: session returned error\", {\r\n          workspaceId,\r\n          error: result.error,\r\n        });\r\n      }\r\n      return result;\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : JSON.stringify(error, null, 2);\r\n      log.error(\"Unexpected error in sendMessage handler:\", error);\r\n\r\n      // Handle incompatible workspace errors from downgraded configs\r\n      if (error instanceof IncompatibleRuntimeError) {\r\n        const sendError: SendMessageError = {\r\n          type: \"incompatible_workspace\",\r\n          message: error.message,\r\n        };\r\n        return Err(sendError);\r\n      }\r\n\r\n      const sendError: SendMessageError = {\r\n        type: \"unknown\",\r\n        raw: `Failed to send message: ${errorMessage}`,\r\n      };\r\n      return Err(sendError);\r\n    }\r\n  }\r\n\r\n  async resumeStream(\r\n    workspaceId: string,\r\n    options: SendMessageOptions,\r\n    internal?: { allowQueuedAgentTask?: boolean }\r\n  ): Promise<Result<void, SendMessageError>> {\r\n    try {\r\n      // Block streaming while workspace is being renamed to prevent path conflicts\r\n      if (this.renamingWorkspaces.has(workspaceId)) {\r\n        log.debug(\"resumeStream blocked: workspace is being renamed\", { workspaceId });\r\n        return Err({\r\n          type: \"unknown\",\r\n          raw: \"Workspace is being renamed. Please wait and try again.\",\r\n        });\r\n      }\r\n\r\n      // Block streaming while workspace is being removed to prevent races with config/session deletion.\r\n      if (this.removingWorkspaces.has(workspaceId)) {\r\n        log.debug(\"resumeStream blocked: workspace is being removed\", { workspaceId });\r\n        return Err({\r\n          type: \"unknown\",\r\n          raw: \"Workspace is being deleted. Please wait and try again.\",\r\n        });\r\n      }\r\n\r\n      // Guard: avoid creating sessions for workspaces that don't exist anymore.\r\n      if (!this.config.findWorkspace(workspaceId)) {\r\n        return Err({\r\n          type: \"unknown\",\r\n          raw: \"Workspace not found. It may have been deleted.\",\r\n        });\r\n      }\r\n\r\n      // Guard: queued agent tasks must not be resumed by generic UI/API calls.\r\n      // TaskService is responsible for dequeuing and starting them.\r\n      if (!internal?.allowQueuedAgentTask) {\r\n        const config = this.config.loadConfigOrDefault();\r\n        for (const [_projectPath, project] of config.projects) {\r\n          const ws = project.workspaces.find((w) => w.id === workspaceId);\r\n          if (!ws) continue;\r\n          if (ws.parentWorkspaceId && ws.taskStatus === \"queued\") {\r\n            taskQueueDebug(\"WorkspaceService.resumeStream blocked (queued task)\", {\r\n              workspaceId,\r\n              stack: new Error(\"resumeStream blocked\").stack,\r\n            });\r\n            return Err({\r\n              type: \"unknown\",\r\n              raw: \"This agent task is queued and cannot start yet. Wait for a slot to free.\",\r\n            });\r\n          }\r\n          break;\r\n        }\r\n      } else {\r\n        taskQueueDebug(\"WorkspaceService.resumeStream allowed (internal dequeue)\", {\r\n          workspaceId,\r\n          stack: new Error(\"resumeStream internal\").stack,\r\n        });\r\n      }\r\n\r\n      const session = this.getOrCreateSession(workspaceId);\r\n\r\n      const normalizedOptions = this.normalizeSendMessageAgentId(options);\r\n\r\n      // Persist last-used model + thinking level for cross-device consistency.\r\n      await this.maybePersistAISettingsFromOptions(workspaceId, normalizedOptions, \"resume\");\r\n\r\n      const result = await session.resumeStream(normalizedOptions);\r\n      if (!result.success) {\r\n        log.error(\"resumeStream handler: session returned error\", {\r\n          workspaceId,\r\n          error: result.error,\r\n        });\r\n      }\r\n      return result;\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      log.error(\"Unexpected error in resumeStream handler:\", error);\r\n\r\n      // Handle incompatible workspace errors from downgraded configs\r\n      if (error instanceof IncompatibleRuntimeError) {\r\n        const sendError: SendMessageError = {\r\n          type: \"incompatible_workspace\",\r\n          message: error.message,\r\n        };\r\n        return Err(sendError);\r\n      }\r\n\r\n      const sendError: SendMessageError = {\r\n        type: \"unknown\",\r\n        raw: `Failed to resume stream: ${errorMessage}`,\r\n      };\r\n      return Err(sendError);\r\n    }\r\n  }\r\n\r\n  async interruptStream(\r\n    workspaceId: string,\r\n    options?: { soft?: boolean; abandonPartial?: boolean; sendQueuedImmediately?: boolean }\r\n  ): Promise<Result<void>> {\r\n    try {\r\n      this.taskService?.resetAutoResumeCount(workspaceId);\r\n      const session = this.getOrCreateSession(workspaceId);\r\n      const stopResult = await session.interruptStream(options);\r\n      if (!stopResult.success) {\r\n        log.error(\"Failed to stop stream:\", stopResult.error);\r\n        return Err(stopResult.error);\r\n      }\r\n\r\n      // For hard interrupts, delete partial immediately. For soft interrupts,\r\n      // defer to stream-abort handler (stream is still running and may recreate partial).\r\n      if (options?.abandonPartial && !options?.soft) {\r\n        log.debug(\"Abandoning partial for workspace:\", workspaceId);\r\n        await this.partialService.deletePartial(workspaceId);\r\n      }\r\n\r\n      // Handle queued messages based on option\r\n      if (options?.sendQueuedImmediately) {\r\n        // Send queued messages immediately instead of restoring to input\r\n        session.sendQueuedMessages();\r\n      } else {\r\n        // Restore queued messages to input box for user-initiated interrupts\r\n        session.restoreQueueToInput();\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      log.error(\"Unexpected error in interruptStream handler:\", error);\r\n      return Err(`Failed to interrupt stream: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  async answerAskUserQuestion(\r\n    workspaceId: string,\r\n    toolCallId: string,\r\n    answers: Record<string, string>\r\n  ): Promise<Result<void>> {\r\n    try {\r\n      // Fast path: normal in-memory execution (stream still running, tool is awaiting input).\r\n      askUserQuestionManager.answer(workspaceId, toolCallId, answers);\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      // Fallback path: app restart (or other process death) means the in-memory\r\n      // AskUserQuestionManager has no pending entry anymore.\r\n      //\r\n      // In that case we persist the tool result into partial.json or chat.jsonl,\r\n      // then emit a synthetic tool-call-end so the renderer updates immediately.\r\n      try {\r\n        // Helper: update a message in-place if it contains this ask_user_question tool call.\r\n        const tryFinalizeMessage = (\r\n          msg: MuxMessage\r\n        ): Result<{ updated: MuxMessage; output: AskUserQuestionToolSuccessResult }> => {\r\n          let foundToolCall = false;\r\n          let output: AskUserQuestionToolSuccessResult | null = null;\r\n          let errorMessage: string | null = null;\r\n\r\n          const updatedParts = msg.parts.map((part) => {\r\n            if (!isDynamicToolPart(part) || part.toolCallId !== toolCallId) {\r\n              return part;\r\n            }\r\n\r\n            foundToolCall = true;\r\n\r\n            if (part.toolName !== \"ask_user_question\") {\r\n              errorMessage = `toolCallId=${toolCallId} is toolName=${part.toolName}, expected ask_user_question`;\r\n              return part;\r\n            }\r\n\r\n            // Already answered - treat as idempotent.\r\n            if (part.state === \"output-available\") {\r\n              const parsedOutput = AskUserQuestionToolResultSchema.safeParse(part.output);\r\n              if (!parsedOutput.success) {\r\n                errorMessage = `ask_user_question output validation failed: ${parsedOutput.error.message}`;\r\n                return part;\r\n              }\r\n              output = parsedOutput.data;\r\n              return part;\r\n            }\r\n\r\n            const parsedArgs = AskUserQuestionToolArgsSchema.safeParse(part.input);\r\n            if (!parsedArgs.success) {\r\n              errorMessage = `ask_user_question input validation failed: ${parsedArgs.error.message}`;\r\n              return part;\r\n            }\r\n\r\n            const nextOutput: AskUserQuestionToolSuccessResult = {\r\n              summary: buildAskUserQuestionSummary(answers),\r\n              ui_only: {\r\n                ask_user_question: {\r\n                  questions: parsedArgs.data.questions,\r\n                  answers,\r\n                },\r\n              },\r\n            };\r\n            output = nextOutput;\r\n\r\n            return {\r\n              ...part,\r\n              state: \"output-available\" as const,\r\n              output: nextOutput,\r\n            };\r\n          });\r\n\r\n          if (errorMessage) {\r\n            return Err(errorMessage);\r\n          }\r\n          if (!foundToolCall) {\r\n            return Err(\"ask_user_question toolCallId not found in message\");\r\n          }\r\n          if (!output) {\r\n            return Err(\"ask_user_question output missing after update\");\r\n          }\r\n\r\n          return Ok({ updated: { ...msg, parts: updatedParts }, output });\r\n        };\r\n\r\n        // 1) Prefer partial.json (most common after restart while waiting)\r\n        const partial = await this.partialService.readPartial(workspaceId);\r\n        if (partial) {\r\n          const finalized = tryFinalizeMessage(partial);\r\n          if (finalized.success) {\r\n            const writeResult = await this.partialService.writePartial(\r\n              workspaceId,\r\n              finalized.data.updated\r\n            );\r\n            if (!writeResult.success) {\r\n              return Err(writeResult.error);\r\n            }\r\n\r\n            const session = this.getOrCreateSession(workspaceId);\r\n            session.emitChatEvent({\r\n              type: \"tool-call-end\",\r\n              workspaceId,\r\n              messageId: finalized.data.updated.id,\r\n              toolCallId,\r\n              toolName: \"ask_user_question\",\r\n              result: finalized.data.output,\r\n              timestamp: Date.now(),\r\n            });\r\n\r\n            return Ok(undefined);\r\n          }\r\n        }\r\n\r\n        // 2) Fall back to chat history (partial may have already been committed).\r\n        // Only the current compaction epoch matters  pending tool calls don't survive compaction.\r\n        const historyResult = await this.historyService.getHistoryFromLatestBoundary(workspaceId);\r\n        if (!historyResult.success) {\r\n          return Err(historyResult.error);\r\n        }\r\n\r\n        // Find the newest message containing this tool call.\r\n        let best: MuxMessage | null = null;\r\n        let bestSeq = -Infinity;\r\n        for (const msg of historyResult.data) {\r\n          const seq = msg.metadata?.historySequence;\r\n          if (seq === undefined) continue;\r\n\r\n          const hasTool = msg.parts.some(\r\n            (p) => isDynamicToolPart(p) && p.toolCallId === toolCallId\r\n          );\r\n          if (hasTool && seq > bestSeq) {\r\n            best = msg;\r\n            bestSeq = seq;\r\n          }\r\n        }\r\n\r\n        if (!best) {\r\n          const errorMessage = error instanceof Error ? error.message : String(error);\r\n          return Err(`Failed to answer ask_user_question: ${errorMessage}`);\r\n        }\r\n\r\n        // Guard against answering stale tool calls.\r\n        const maxSeq = Math.max(\r\n          ...historyResult.data\r\n            .map((m) => m.metadata?.historySequence)\r\n            .filter((n): n is number => typeof n === \"number\")\r\n        );\r\n        if (bestSeq !== maxSeq) {\r\n          return Err(\r\n            `Refusing to answer ask_user_question: tool call is not the latest message (toolSeq=${bestSeq}, latestSeq=${maxSeq})`\r\n          );\r\n        }\r\n\r\n        const finalized = tryFinalizeMessage(best);\r\n        if (!finalized.success) {\r\n          return Err(finalized.error);\r\n        }\r\n\r\n        const updateResult = await this.historyService.updateHistory(\r\n          workspaceId,\r\n          finalized.data.updated\r\n        );\r\n        if (!updateResult.success) {\r\n          return Err(updateResult.error);\r\n        }\r\n\r\n        const session = this.getOrCreateSession(workspaceId);\r\n        session.emitChatEvent({\r\n          type: \"tool-call-end\",\r\n          workspaceId,\r\n          messageId: finalized.data.updated.id,\r\n          toolCallId,\r\n          toolName: \"ask_user_question\",\r\n          result: finalized.data.output,\r\n          timestamp: Date.now(),\r\n        });\r\n\r\n        return Ok(undefined);\r\n      } catch (innerError) {\r\n        const errorMessage = innerError instanceof Error ? innerError.message : String(innerError);\r\n        return Err(errorMessage);\r\n      }\r\n    }\r\n  }\r\n\r\n  clearQueue(workspaceId: string): Result<void> {\r\n    try {\r\n      const session = this.getOrCreateSession(workspaceId);\r\n      session.clearQueue();\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      log.error(\"Unexpected error in clearQueue handler:\", error);\r\n      return Err(`Failed to clear queue: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Best-effort delete of plan files (new + legacy paths) for a workspace.\r\n   *\r\n   * Why best-effort: plan files may not exist yet, or deletion may fail due to permissions.\r\n   */\r\n  private async deletePlanFilesForWorkspace(\r\n    workspaceId: string,\r\n    metadata: FrontendWorkspaceMetadata\r\n  ): Promise<void> {\r\n    // Create runtime to get correct muxHome (Docker uses /var/mux, others use ~/.mux)\r\n    const runtime = createRuntimeForWorkspace(metadata);\r\n    const muxHome = runtime.getMuxHome();\r\n    const planPath = getPlanFilePath(metadata.name, metadata.projectName, muxHome);\r\n    const legacyPlanPath = getLegacyPlanFilePath(workspaceId);\r\n\r\n    const isDocker = isDockerRuntime(metadata.runtimeConfig);\r\n    const isSSH = isSSHRuntime(metadata.runtimeConfig);\r\n\r\n    // For Docker: paths are already absolute (/var/mux/...), just quote\r\n    // For SSH: use $HOME expansion so the runtime shell resolves to the runtime home directory\r\n    // For local: expand tilde locally since shellQuote prevents shell expansion\r\n    const quotedPlanPath = isDocker\r\n      ? shellQuote(planPath)\r\n      : isSSH\r\n        ? expandTildeForSSH(planPath)\r\n        : shellQuote(expandTilde(planPath));\r\n    // For legacy path: SSH/Docker use $HOME expansion, local expands tilde\r\n    const quotedLegacyPlanPath =\r\n      isDocker || isSSH\r\n        ? expandTildeForSSH(legacyPlanPath)\r\n        : shellQuote(expandTilde(legacyPlanPath));\r\n\r\n    if (isDocker || isSSH) {\r\n      try {\r\n        // Use exec to delete files since runtime doesn't have a deleteFile method.\r\n        // Use runtime workspace path (not host projectPath) for Docker containers.\r\n        const workspacePath = runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n        const execStream = await runtime.exec(`rm -f ${quotedPlanPath} ${quotedLegacyPlanPath}`, {\r\n          cwd: workspacePath,\r\n          timeout: 10,\r\n        });\r\n\r\n        try {\r\n          await execStream.stdin.close();\r\n        } catch {\r\n          // Ignore stdin-close errors (e.g. already closed).\r\n        }\r\n\r\n        await execStream.exitCode.catch(() => {\r\n          // Best-effort: ignore failures.\r\n        });\r\n      } catch {\r\n        // Plan files don't exist or can't be deleted - ignore\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    // Local runtimes: delete directly on the local filesystem.\r\n    const planPathAbs = expandTilde(planPath);\r\n    const legacyPlanPathAbs = expandTilde(legacyPlanPath);\r\n\r\n    await Promise.allSettled([\r\n      fsPromises.rm(planPathAbs, { force: true }),\r\n      fsPromises.rm(legacyPlanPathAbs, { force: true }),\r\n    ]);\r\n  }\r\n\r\n  async truncateHistory(workspaceId: string, percentage?: number): Promise<Result<void>> {\r\n    if (this.aiService.isStreaming(workspaceId)) {\r\n      return Err(\r\n        \"Cannot truncate history while stream is active. Press Esc to stop the stream first.\"\r\n      );\r\n    }\r\n\r\n    const truncateResult = await this.historyService.truncateHistory(\r\n      workspaceId,\r\n      percentage ?? 1.0\r\n    );\r\n    if (!truncateResult.success) {\r\n      return Err(truncateResult.error);\r\n    }\r\n\r\n    const deletedSequences = truncateResult.data;\r\n    if (deletedSequences.length > 0) {\r\n      const deleteMessage: DeleteMessage = {\r\n        type: \"delete\",\r\n        historySequences: deletedSequences,\r\n      };\r\n      // Emit through the session so ORPC subscriptions receive the event\r\n      const session = this.sessions.get(workspaceId);\r\n      if (session) {\r\n        session.emitChatEvent(deleteMessage);\r\n      } else {\r\n        // Fallback to direct emit (legacy path)\r\n        this.emit(\"chat\", { workspaceId, message: deleteMessage });\r\n      }\r\n    }\r\n\r\n    // On full clear, also delete plan file and clear file change tracking\r\n    if ((percentage ?? 1.0) === 1.0) {\r\n      const metadata = await this.getInfo(workspaceId);\r\n      if (metadata) {\r\n        await this.deletePlanFilesForWorkspace(workspaceId, metadata);\r\n      }\r\n      this.sessions.get(workspaceId)?.clearFileState();\r\n    }\r\n\r\n    return Ok(undefined);\r\n  }\r\n\r\n  async replaceHistory(\r\n    workspaceId: string,\r\n    summaryMessage: MuxMessage,\r\n    options?: {\r\n      mode?: \"destructive\" | \"append-compaction-boundary\" | null;\r\n      deletePlanFile?: boolean;\r\n    }\r\n  ): Promise<Result<void>> {\r\n    // Support both new enum (\"user\"|\"idle\") and legacy boolean (true)\r\n    const isCompaction = !!summaryMessage.metadata?.compacted;\r\n    if (!isCompaction && this.aiService.isStreaming(workspaceId)) {\r\n      return Err(\r\n        \"Cannot replace history while stream is active. Press Esc to stop the stream first.\"\r\n      );\r\n    }\r\n\r\n    const replaceMode = options?.mode ?? \"destructive\";\r\n\r\n    try {\r\n      let messageToAppend = summaryMessage;\r\n      let deletedSequences: number[] = [];\r\n\r\n      if (replaceMode === \"append-compaction-boundary\") {\r\n        assert(\r\n          summaryMessage.role === \"assistant\",\r\n          \"append-compaction-boundary replace mode requires an assistant summary message\"\r\n        );\r\n\r\n        // Only need the current epoch's messages  the latest boundary marker holds\r\n        // the max compaction epoch, and epochs are monotonically increasing with\r\n        // append-only compaction. Falls back to full history for uncompacted workspaces.\r\n        const historyResult = await this.historyService.getHistoryFromLatestBoundary(workspaceId);\r\n        if (!historyResult.success) {\r\n          return Err(\r\n            `Failed to read history for append-compaction-boundary mode: ${historyResult.error}`\r\n          );\r\n        }\r\n\r\n        const nextCompactionEpoch = getNextCompactionEpochForAppendBoundary(\r\n          workspaceId,\r\n          historyResult.data\r\n        );\r\n        assert(\r\n          isPositiveInteger(nextCompactionEpoch),\r\n          \"append-compaction-boundary replace mode must compute a positive compaction epoch\"\r\n        );\r\n\r\n        const compactedMarker = hasDurableCompactedMarker(summaryMessage.metadata?.compacted)\r\n          ? summaryMessage.metadata.compacted\r\n          : \"user\";\r\n\r\n        messageToAppend = {\r\n          ...summaryMessage,\r\n          metadata: {\r\n            ...(summaryMessage.metadata ?? {}),\r\n            compacted: compactedMarker,\r\n            compactionBoundary: true,\r\n            compactionEpoch: nextCompactionEpoch,\r\n          },\r\n        };\r\n\r\n        assert(\r\n          hasDurableCompactedMarker(messageToAppend.metadata?.compacted),\r\n          \"append-compaction-boundary replace mode requires a durable compacted marker\"\r\n        );\r\n        assert(\r\n          messageToAppend.metadata?.compactionBoundary === true,\r\n          \"append-compaction-boundary replace mode must persist compactionBoundary=true\"\r\n        );\r\n        assert(\r\n          isPositiveInteger(messageToAppend.metadata?.compactionEpoch),\r\n          \"append-compaction-boundary replace mode must persist a positive compactionEpoch\"\r\n        );\r\n      } else {\r\n        assert(\r\n          replaceMode === \"destructive\",\r\n          `replaceHistory received unsupported replace mode: ${String(replaceMode)}`\r\n        );\r\n\r\n        const clearResult = await this.historyService.clearHistory(workspaceId);\r\n        if (!clearResult.success) {\r\n          return Err(`Failed to clear history: ${clearResult.error}`);\r\n        }\r\n        deletedSequences = clearResult.data;\r\n      }\r\n\r\n      const appendResult = await this.historyService.appendToHistory(workspaceId, messageToAppend);\r\n      if (!appendResult.success) {\r\n        return Err(`Failed to append summary message: ${appendResult.error}`);\r\n      }\r\n\r\n      // Emit through the session so ORPC subscriptions receive the events\r\n      const session = this.sessions.get(workspaceId);\r\n      if (deletedSequences.length > 0) {\r\n        const deleteMessage: DeleteMessage = {\r\n          type: \"delete\",\r\n          historySequences: deletedSequences,\r\n        };\r\n        if (session) {\r\n          session.emitChatEvent(deleteMessage);\r\n        } else {\r\n          this.emit(\"chat\", { workspaceId, message: deleteMessage });\r\n        }\r\n      }\r\n\r\n      // Add type: \"message\" for discriminated union (MuxMessage doesn't have it)\r\n      const typedSummaryMessage = { ...messageToAppend, type: \"message\" as const };\r\n      if (session) {\r\n        session.emitChatEvent(typedSummaryMessage);\r\n      } else {\r\n        this.emit(\"chat\", { workspaceId, message: typedSummaryMessage });\r\n      }\r\n\r\n      // Optional cleanup: delete plan file when caller explicitly requests it.\r\n      // Note: the propose_plan UI keeps the plan file on disk; this flag is reserved for\r\n      // explicit reset flows and backwards compatibility.\r\n      if (options?.deletePlanFile === true) {\r\n        const metadata = await this.getInfo(workspaceId);\r\n        if (metadata) {\r\n          await this.deletePlanFilesForWorkspace(workspaceId, metadata);\r\n        }\r\n        this.sessions.get(workspaceId)?.clearFileState();\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to replace history: ${message}`);\r\n    }\r\n  }\r\n\r\n  async getActivityList(): Promise<Record<string, WorkspaceActivitySnapshot>> {\r\n    try {\r\n      const snapshots = await this.extensionMetadata.getAllSnapshots();\r\n      return Object.fromEntries(snapshots.entries());\r\n    } catch (error) {\r\n      log.error(\"Failed to list activity:\", error);\r\n      return {};\r\n    }\r\n  }\r\n  async getChatHistory(workspaceId: string): Promise<MuxMessage[]> {\r\n    try {\r\n      // Only return messages from the latest compaction boundary onward.\r\n      // Pre-boundary messages are summarized in the boundary marker.\r\n      // TODO: allow users to opt in to viewing full pre-boundary history.\r\n      const history = await this.historyService.getHistoryFromLatestBoundary(workspaceId);\r\n      return history.success ? history.data : [];\r\n    } catch (error) {\r\n      log.error(\"Failed to get chat history:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async getFileCompletions(\r\n    workspaceId: string,\r\n    query: string,\r\n    limit = 20\r\n  ): Promise<{ paths: string[] }> {\r\n    assert(workspaceId, \"workspaceId is required\");\r\n    assert(typeof query === \"string\", \"query must be a string\");\r\n\r\n    const resolvedLimit = Math.min(Math.max(1, Math.trunc(limit)), 50);\r\n\r\n    const metadata = await this.getInfo(workspaceId);\r\n    if (!metadata) {\r\n      return { paths: [] };\r\n    }\r\n\r\n    const runtime = createRuntimeForWorkspace(metadata);\r\n    const isInPlace = metadata.projectPath === metadata.name;\r\n    const workspacePath = isInPlace\r\n      ? metadata.projectPath\r\n      : runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n\r\n    const now = Date.now();\r\n    const CACHE_TTL_MS = 10_000;\r\n\r\n    let cached = this.fileCompletionsCache.get(workspaceId);\r\n    if (!cached) {\r\n      cached = { index: EMPTY_FILE_COMPLETIONS_INDEX, fetchedAt: 0 };\r\n      this.fileCompletionsCache.set(workspaceId, cached);\r\n    }\r\n\r\n    const cacheEntry = cached;\r\n\r\n    const isStale = cacheEntry.fetchedAt === 0 || now - cacheEntry.fetchedAt > CACHE_TTL_MS;\r\n    if (isStale && !cacheEntry.refreshing) {\r\n      cacheEntry.refreshing = (async () => {\r\n        const previousIndex = cacheEntry.index;\r\n\r\n        try {\r\n          const result = await execBuffered(runtime, \"git ls-files -co --exclude-standard\", {\r\n            cwd: workspacePath,\r\n            timeout: 5,\r\n          });\r\n\r\n          if (result.exitCode !== 0) {\r\n            cacheEntry.index = previousIndex;\r\n          } else {\r\n            const files = result.stdout\r\n              .split(\"\\n\")\r\n              .map((line) => line.trim())\r\n              // File @mentions are whitespace-delimited, so we exclude spaced paths from autocomplete.\r\n              .filter((filePath) => Boolean(filePath) && !/\\s/.test(filePath));\r\n            cacheEntry.index = buildFileCompletionsIndex(files);\r\n          }\r\n\r\n          cacheEntry.fetchedAt = Date.now();\r\n        } catch (error) {\r\n          log.debug(\"getFileCompletions: failed to list files\", {\r\n            workspaceId,\r\n            error: error instanceof Error ? error.message : String(error),\r\n          });\r\n\r\n          // Keep any previously indexed data, but avoid retrying in a tight loop.\r\n          cacheEntry.index = previousIndex;\r\n          cacheEntry.fetchedAt = Date.now();\r\n        }\r\n      })().finally(() => {\r\n        cacheEntry.refreshing = undefined;\r\n      });\r\n    }\r\n\r\n    if (cacheEntry.fetchedAt === 0 && cacheEntry.refreshing) {\r\n      await cacheEntry.refreshing;\r\n    }\r\n\r\n    return { paths: searchFileCompletions(cacheEntry.index, query, resolvedLimit) };\r\n  }\r\n  async getFullReplay(workspaceId: string): Promise<WorkspaceChatMessage[]> {\r\n    try {\r\n      const session = this.getOrCreateSession(workspaceId);\r\n      const events: WorkspaceChatMessage[] = [];\r\n      await session.replayHistory(({ message }) => {\r\n        events.push(message);\r\n      });\r\n      return events;\r\n    } catch (error) {\r\n      log.error(\"Failed to get full replay:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async executeBash(\r\n    workspaceId: string,\r\n    script: string,\r\n    options?: {\r\n      timeout_secs?: number;\r\n    }\r\n  ): Promise<Result<BashToolResult>> {\r\n    // Block bash execution while workspace is being removed to prevent races with directory deletion.\r\n    // A common case: subagent calls agent_report  frontend's GitStatusStore triggers a git status\r\n    // refresh  executeBash arrives while remove() is deleting the directory  spawn fails with ENOENT.\r\n    // removingWorkspaces is set for the entire duration of remove(), covering the window between\r\n    // disk deletion and metadata invalidation.\r\n    if (this.removingWorkspaces.has(workspaceId)) {\r\n      return Err(`Workspace ${workspaceId} is being removed`);\r\n    }\r\n\r\n    // NOTE: This guard must run before any init/runtime operations that could wake a stopped SSH\r\n    // runtime (e.g., Coder workspaces started via `coder ssh --wait=yes`).\r\n    if (this.archivingWorkspaces.has(workspaceId)) {\r\n      return Err(`Workspace ${workspaceId} is being archived; cannot execute bash`);\r\n    }\r\n\r\n    const metadataResult = await this.aiService.getWorkspaceMetadata(workspaceId);\r\n    if (!metadataResult.success) {\r\n      return Err(`Failed to get workspace metadata: ${metadataResult.error}`);\r\n    }\r\n\r\n    const metadata = metadataResult.data;\r\n    if (isWorkspaceArchived(metadata.archivedAt, metadata.unarchivedAt)) {\r\n      return Err(`Workspace ${workspaceId} is archived; cannot execute bash`);\r\n    }\r\n\r\n    // Wait for workspace initialization (container creation, code sync, etc.)\r\n    // Same behavior as AI tools - 5 min timeout, then proceeds anyway\r\n    await this.initStateManager.waitForInit(workspaceId);\r\n\r\n    try {\r\n      // Get actual workspace path from config\r\n      const workspace = this.config.findWorkspace(workspaceId);\r\n      if (!workspace) {\r\n        return Err(`Workspace ${workspaceId} not found in config`);\r\n      }\r\n\r\n      // Load project secrets\r\n      const projectSecrets = this.config.getEffectiveSecrets(metadata.projectPath);\r\n\r\n      // Create scoped temp directory for this IPC call\r\n      using tempDir = new DisposableTempDir(\"mux-ipc-bash\");\r\n\r\n      // Create runtime and compute workspace path\r\n      const runtime = createRuntime(metadata.runtimeConfig, {\r\n        projectPath: metadata.projectPath,\r\n        workspaceName: metadata.name,\r\n      });\r\n\r\n      // Ensure runtime is ready (e.g., start Docker container if stopped)\r\n      const readyResult = await runtime.ensureReady();\r\n      if (!readyResult.ready) {\r\n        return Err(readyResult.error ?? \"Runtime not ready\");\r\n      }\r\n\r\n      const workspacePath = runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n\r\n      // Create bash tool\r\n      const bashTool = createBashTool({\r\n        cwd: workspacePath,\r\n        runtime,\r\n        secrets: secretsToRecord(projectSecrets),\r\n        runtimeTempDir: tempDir.path,\r\n        overflow_policy: \"truncate\",\r\n      });\r\n\r\n      // Execute the script\r\n      const result = (await bashTool.execute!(\r\n        {\r\n          script,\r\n          timeout_secs: options?.timeout_secs ?? 120,\r\n        },\r\n        {\r\n          toolCallId: `bash-${Date.now()}`,\r\n          messages: [],\r\n        }\r\n      )) as BashToolResult;\r\n\r\n      return Ok(result);\r\n    } catch (error) {\r\n      // bashTool.execute returns error results instead of throwing, so this only catches\r\n      // failures from setup code (getWorkspaceMetadata, findWorkspace, createRuntime, etc.)\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to execute bash command: ${message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List background processes for a workspace.\r\n   * Returns process info suitable for UI display (excludes handle).\r\n   */\r\n  async listBackgroundProcesses(workspaceId: string): Promise<\r\n    Array<{\r\n      id: string;\r\n      pid: number;\r\n      script: string;\r\n      displayName?: string;\r\n      startTime: number;\r\n      status: \"running\" | \"exited\" | \"killed\" | \"failed\";\r\n      exitCode?: number;\r\n    }>\r\n  > {\r\n    const processes = await this.backgroundProcessManager.list(workspaceId);\r\n    return processes.map((p) => ({\r\n      id: p.id,\r\n      pid: p.pid,\r\n      script: p.script,\r\n      displayName: p.displayName,\r\n      startTime: p.startTime,\r\n      status: p.status,\r\n      exitCode: p.exitCode,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Terminate a background process by ID.\r\n   * Verifies the process belongs to the specified workspace.\r\n   */\r\n  async terminateBackgroundProcess(workspaceId: string, processId: string): Promise<Result<void>> {\r\n    // Get process to verify workspace ownership\r\n    const proc = await this.backgroundProcessManager.getProcess(processId);\r\n    if (!proc) {\r\n      return Err(`Process not found: ${processId}`);\r\n    }\r\n    if (proc.workspaceId !== workspaceId) {\r\n      return Err(`Process ${processId} does not belong to workspace ${workspaceId}`);\r\n    }\r\n\r\n    const result = await this.backgroundProcessManager.terminate(processId);\r\n    if (!result.success) {\r\n      return Err(result.error);\r\n    }\r\n    return Ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Peek output for a background bash process.\r\n   *\r\n   * This must not consume the output cursor used by bash_output/task_await.\r\n   */\r\n  async getBackgroundProcessOutput(\r\n    workspaceId: string,\r\n    processId: string,\r\n    options?: { fromOffset?: number; tailBytes?: number }\r\n  ): Promise<\r\n    Result<{\r\n      status: \"running\" | \"exited\" | \"killed\" | \"failed\";\r\n      output: string;\r\n      nextOffset: number;\r\n      truncatedStart: boolean;\r\n    }>\r\n  > {\r\n    const proc = await this.backgroundProcessManager.getProcess(processId);\r\n    if (!proc) {\r\n      return Err(`Process not found: ${processId}`);\r\n    }\r\n    if (proc.workspaceId !== workspaceId) {\r\n      return Err(`Process ${processId} does not belong to workspace ${workspaceId}`);\r\n    }\r\n\r\n    const result = await this.backgroundProcessManager.peekOutput(processId, options);\r\n    if (!result.success) {\r\n      return Err(result.error);\r\n    }\r\n\r\n    return Ok({\r\n      status: result.status,\r\n      output: result.output,\r\n      nextOffset: result.nextOffset,\r\n      truncatedStart: result.truncatedStart,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the tool call IDs of foreground bash processes for a workspace.\r\n   * Returns empty array if no foreground bashes are running.\r\n   */\r\n  getForegroundToolCallIds(workspaceId: string): string[] {\r\n    return this.backgroundProcessManager.getForegroundToolCallIds(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Send a foreground bash process to background by its tool call ID.\r\n   * The process continues running but the agent stops waiting for it.\r\n   */\r\n  sendToBackground(toolCallId: string): Result<void> {\r\n    const result = this.backgroundProcessManager.sendToBackground(toolCallId);\r\n    if (!result.success) {\r\n      return Err(result.error);\r\n    }\r\n    return Ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Subscribe to background bash state changes.\r\n   */\r\n  onBackgroundBashChange(callback: (workspaceId: string) => void): void {\r\n    this.backgroundProcessManager.on(\"change\", callback);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe from background bash state changes.\r\n   */\r\n  offBackgroundBashChange(callback: (workspaceId: string) => void): void {\r\n    this.backgroundProcessManager.off(\"change\", callback);\r\n  }\r\n\r\n  /**\r\n   * Emit an idle-compaction-needed event to a workspace's stream.\r\n   * Called by IdleCompactionService when a workspace becomes eligible while connected.\r\n   */\r\n  emitIdleCompactionNeeded(workspaceId: string): void {\r\n    const session = this.sessions.get(workspaceId);\r\n    if (session) {\r\n      session.emitChatEvent({ type: \"idle-compaction-needed\" });\r\n    }\r\n  }\r\n}\r\n"]}