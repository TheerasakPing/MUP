{"version":3,"file":"mdnsAdvertiserService.test.js","sourceRoot":"","sources":["../../../src/node/services/mdnsAdvertiserService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\nimport { Protocol } from \"@homebridge/ciao\";\nimport type { NetworkInterfaceInfo } from \"node:os\";\nimport { buildMuxMdnsServiceOptions, MUX_MDNS_SERVICE_TYPE } from \"./mdnsAdvertiserService\";\n\ndescribe(\"buildMuxMdnsServiceOptions\", () => {\n  test(\"0.0.0.0 disables IPv6 and avoids advertising loopback addresses\", () => {\n    const networkInterfaces: NodeJS.Dict<NetworkInterfaceInfo[]> = {\n      lo0: [\n        {\n          address: \"127.0.0.1\",\n          netmask: \"255.0.0.0\",\n          family: \"IPv4\",\n          mac: \"00:00:00:00:00:00\",\n          internal: true,\n          cidr: \"127.0.0.1/8\",\n        },\n      ],\n      en0: [\n        {\n          address: \"192.168.1.10\",\n          netmask: \"255.255.255.0\",\n          family: \"IPv4\",\n          mac: \"00:00:00:00:00:00\",\n          internal: false,\n          cidr: \"192.168.1.10/24\",\n        },\n      ],\n    };\n\n    const serviceOptions = buildMuxMdnsServiceOptions({\n      bindHost: \"0.0.0.0\",\n      port: 3000,\n      instanceName: \"mux-test\",\n      version: \"0.0.0-test\",\n      authRequired: true,\n      networkInterfaces,\n    });\n\n    expect(serviceOptions.type).toBe(MUX_MDNS_SERVICE_TYPE);\n    expect(serviceOptions.protocol).toBe(Protocol.TCP);\n    expect(serviceOptions.disabledIpv6).toBe(true);\n    expect(serviceOptions.restrictedAddresses).toEqual([\"en0\"]);\n  });\n\n  test(\"IPv6 wildcard avoids advertising loopback addresses\", () => {\n    const networkInterfaces: NodeJS.Dict<NetworkInterfaceInfo[]> = {\n      lo0: [\n        {\n          address: \"::1\",\n          netmask: \"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff\",\n          family: \"IPv6\",\n          mac: \"00:00:00:00:00:00\",\n          internal: true,\n          cidr: \"::1/128\",\n          scopeid: 0,\n        },\n      ],\n      en0: [\n        {\n          address: \"2001:db8::1\",\n          netmask: \"ffff:ffff:ffff:ffff::\",\n          family: \"IPv6\",\n          mac: \"00:00:00:00:00:00\",\n          internal: false,\n          cidr: \"2001:db8::1/64\",\n          scopeid: 0,\n        },\n      ],\n      awdl0: [\n        {\n          address: \"fe80::1\",\n          netmask: \"ffff:ffff:ffff:ffff::\",\n          family: \"IPv6\",\n          mac: \"00:00:00:00:00:00\",\n          internal: false,\n          cidr: \"fe80::1/64\",\n          scopeid: 0,\n        },\n      ],\n    };\n\n    const serviceOptions = buildMuxMdnsServiceOptions({\n      bindHost: \"::\",\n      port: 3000,\n      instanceName: \"mux-test\",\n      version: \"0.0.0-test\",\n      authRequired: false,\n      networkInterfaces,\n    });\n\n    expect(serviceOptions.restrictedAddresses).toEqual([\"en0\"]);\n    expect(serviceOptions.disabledIpv6).toBeUndefined();\n  });\n\n  test(\"sanitizes dots in instanceName so DNS-SD clients can browse/resolve\", () => {\n    const serviceOptions = buildMuxMdnsServiceOptions({\n      bindHost: \"192.168.1.10\",\n      port: 3000,\n      instanceName: \"mux-host.home\",\n      version: \"0.0.0-test\",\n      authRequired: false,\n    });\n\n    expect(serviceOptions.name).toBe(\"mux-host-home\");\n  });\n\n  test(\"specific IP restricts addresses\", () => {\n    const serviceOptions = buildMuxMdnsServiceOptions({\n      bindHost: \"192.168.1.10\",\n      port: 3000,\n      instanceName: \"mux-test\",\n      version: \"0.0.0-test\",\n      authRequired: false,\n    });\n\n    expect(serviceOptions.restrictedAddresses).toEqual([\"192.168.1.10\"]);\n    expect(serviceOptions.disabledIpv6).toBeUndefined();\n  });\n});\n"]}