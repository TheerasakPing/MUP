{"version":3,"file":"mockAiStreamPlayer.test.js","sourceRoot":"","sources":["../../../../src/node/services/mock/mockAiStreamPlayer.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, beforeEach, afterEach, spyOn } from \"bun:test\";\r\nimport { EventEmitter } from \"events\";\r\nimport { MockAiStreamPlayer } from \"./mockAiStreamPlayer\";\r\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\r\nimport { Ok } from \"@/common/types/result\";\r\nimport type { HistoryService } from \"@/node/services/historyService\";\r\nimport type { AIService } from \"@/node/services/aiService\";\r\nimport { createTestHistoryService } from \"../testHistoryService\";\r\n\r\nfunction readWorkspaceId(payload: unknown): string | undefined {\r\n  if (!payload || typeof payload !== \"object\") return undefined;\r\n  if (!(\"workspaceId\" in payload)) return undefined;\r\n\r\n  const workspaceId = (payload as { workspaceId?: unknown }).workspaceId;\r\n  return typeof workspaceId === \"string\" ? workspaceId : undefined;\r\n}\r\n\r\ndescribe(\"MockAiStreamPlayer\", () => {\r\n  let historyService: HistoryService;\r\n  let cleanup: () => Promise<void>;\r\n\r\n  beforeEach(async () => {\r\n    const testHistory = await createTestHistoryService();\r\n    historyService = testHistory.historyService;\r\n    cleanup = testHistory.cleanup;\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await cleanup();\r\n  });\r\n\r\n  test(\"appends assistant placeholder even when router turn ends with stream error\", async () => {\r\n    const aiServiceStub = new EventEmitter();\r\n\r\n    const player = new MockAiStreamPlayer({\r\n      historyService,\r\n      aiService: aiServiceStub as unknown as AIService,\r\n    });\r\n\r\n    const workspaceId = \"workspace-1\";\r\n\r\n    const firstTurnUser = createMuxMessage(\r\n      \"user-1\",\r\n      \"user\",\r\n      \"[mock:list-languages] List 3 programming languages\",\r\n      {\r\n        timestamp: Date.now(),\r\n      }\r\n    );\r\n\r\n    const firstResult = await player.play([firstTurnUser], workspaceId);\r\n    expect(firstResult.success).toBe(true);\r\n    player.stop(workspaceId);\r\n\r\n    // Read back what was appended during the first turn\r\n    const historyResult = await historyService.getLastMessages(workspaceId, 100);\r\n    const historyBeforeSecondTurn = historyResult.success ? historyResult.data : [];\r\n\r\n    const secondTurnUser = createMuxMessage(\r\n      \"user-2\",\r\n      \"user\",\r\n      \"[mock:error:api] Trigger API error\",\r\n      {\r\n        timestamp: Date.now(),\r\n      }\r\n    );\r\n\r\n    const secondResult = await player.play(\r\n      [firstTurnUser, ...historyBeforeSecondTurn, secondTurnUser],\r\n      workspaceId\r\n    );\r\n    expect(secondResult.success).toBe(true);\r\n\r\n    // Read back all messages and check the assistant placeholders\r\n    const allResult = await historyService.getLastMessages(workspaceId, 100);\r\n    const allMessages = allResult.success ? allResult.data : [];\r\n    const assistantMessages = allMessages.filter((m) => m.role === \"assistant\");\r\n\r\n    expect(assistantMessages).toHaveLength(2);\r\n    const [firstAppend, secondAppend] = assistantMessages;\r\n\r\n    expect(firstAppend.id).not.toBe(secondAppend.id);\r\n\r\n    const firstSeq = firstAppend.metadata?.historySequence ?? -1;\r\n    const secondSeq = secondAppend.metadata?.historySequence ?? -1;\r\n    expect(secondSeq).toBe(firstSeq + 1);\r\n\r\n    player.stop(workspaceId);\r\n  });\r\n\r\n  test(\"removes assistant placeholder when aborted before stream scheduling\", async () => {\r\n    type AppendResult = Awaited<ReturnType<HistoryService[\"appendToHistory\"]>>;\r\n\r\n    // Control when appendToHistory resolves to test the abort race condition.\r\n    // The real service writes to disk immediately; we gate the returned promise\r\n    // so the player sees a pending append while we trigger abort.\r\n    let appendResolve!: (result: AppendResult) => void;\r\n    const appendGate = new Promise<AppendResult>((resolve) => {\r\n      appendResolve = resolve;\r\n    });\r\n\r\n    let appendedMessageResolve!: (msg: MuxMessage) => void;\r\n    const appendedMessage = new Promise<MuxMessage>((resolve) => {\r\n      appendedMessageResolve = resolve;\r\n    });\r\n\r\n    const originalAppend = historyService.appendToHistory.bind(historyService);\r\n    spyOn(historyService, \"appendToHistory\").mockImplementation(\r\n      async (wId: string, message: MuxMessage) => {\r\n        // Write to disk so deleteMessage can find it later\r\n        await originalAppend(wId, message);\r\n        appendedMessageResolve(message);\r\n        // Delay returning to the caller until the gate opens\r\n        return appendGate;\r\n      }\r\n    );\r\n\r\n    const aiServiceStub = new EventEmitter();\r\n\r\n    const player = new MockAiStreamPlayer({\r\n      historyService,\r\n      aiService: aiServiceStub as unknown as AIService,\r\n    });\r\n\r\n    const workspaceId = \"workspace-abort-startup\";\r\n\r\n    const userMessage = createMuxMessage(\r\n      \"user-1\",\r\n      \"user\",\r\n      \"[mock:list-languages] List 3 programming languages\",\r\n      {\r\n        timestamp: Date.now(),\r\n      }\r\n    );\r\n\r\n    const abortController = new AbortController();\r\n    const playPromise = player.play([userMessage], workspaceId, {\r\n      abortSignal: abortController.signal,\r\n    });\r\n\r\n    const assistantMsg = await appendedMessage;\r\n\r\n    appendResolve(Ok(undefined));\r\n    abortController.abort();\r\n\r\n    const result = await playPromise;\r\n    expect(result.success).toBe(true);\r\n\r\n    // Verify the placeholder was deleted from history\r\n    const storedResult = await historyService.getLastMessages(workspaceId, 100);\r\n    const storedMessages = storedResult.success ? storedResult.data : [];\r\n    expect(storedMessages.some((msg) => msg.id === assistantMsg.id)).toBe(false);\r\n  });\r\n\r\n  test(\"stop prevents queued stream events from emitting\", async () => {\r\n    const aiServiceStub = new EventEmitter();\r\n\r\n    const player = new MockAiStreamPlayer({\r\n      historyService,\r\n      aiService: aiServiceStub as unknown as AIService,\r\n    });\r\n\r\n    const workspaceId = \"workspace-2\";\r\n\r\n    let deltaCount = 0;\r\n    let abortCount = 0;\r\n    let stopped = false;\r\n\r\n    aiServiceStub.on(\"stream-abort\", (payload: unknown) => {\r\n      if (readWorkspaceId(payload) === workspaceId) {\r\n        abortCount += 1;\r\n      }\r\n    });\r\n\r\n    const firstDelta = new Promise<void>((resolve, reject) => {\r\n      const timeout = setTimeout(() => {\r\n        reject(new Error(\"Timed out waiting for stream-delta\"));\r\n      }, 1000);\r\n\r\n      aiServiceStub.on(\"stream-delta\", (payload: unknown) => {\r\n        if (readWorkspaceId(payload) !== workspaceId) return;\r\n\r\n        deltaCount += 1;\r\n\r\n        if (!stopped) {\r\n          stopped = true;\r\n          clearTimeout(timeout);\r\n          player.stop(workspaceId);\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n\r\n    const forceTurnUser = createMuxMessage(\"user-force\", \"user\", \"[force] keep streaming\", {\r\n      timestamp: Date.now(),\r\n    });\r\n\r\n    const playResult = await player.play([forceTurnUser], workspaceId);\r\n    expect(playResult.success).toBe(true);\r\n\r\n    await firstDelta;\r\n\r\n    const deltasAtStop = deltaCount;\r\n\r\n    await new Promise((resolve) => setTimeout(resolve, 150));\r\n\r\n    expect(deltaCount).toBe(deltasAtStop);\r\n    expect(abortCount).toBe(1);\r\n  });\r\n});\r\n"]}