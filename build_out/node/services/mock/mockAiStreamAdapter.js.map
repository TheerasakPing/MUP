{"version":3,"file":"mockAiStreamAdapter.js","sourceRoot":"","sources":["../../../../src/node/services/mock/mockAiStreamAdapter.ts"],"names":[],"mappings":"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","sourcesContent":["import type { CompletedMessagePart } from \"@/common/types/stream\";\r\nimport type { MockAssistantEvent } from \"./mockAiEventTypes\";\r\nimport type { MockAiRouterReply } from \"./mockAiRouter\";\r\nimport { KNOWN_MODELS } from \"@/common/constants/knownModels\";\r\n\r\nconst DEFAULT_STREAM_CHUNK_CHARS = 24;\r\nconst DEFAULT_STREAM_CHUNK_DELAY_MS = 25;\r\n\r\nfunction chunkText(text: string, chunkChars: number): string[] {\r\n  if (text.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  // Stream in word-ish chunks so tests can assert on meaningful substrings.\r\n  // (Fixed-width chunking can split tokens like \"README.md\" across boundaries.)\r\n  const chunks: string[] = [];\r\n\r\n  let cursor = 0;\r\n  while (cursor < text.length) {\r\n    const remaining = text.length - cursor;\r\n    if (remaining <= chunkChars) {\r\n      chunks.push(text.slice(cursor));\r\n      break;\r\n    }\r\n\r\n    const window = text.slice(cursor, cursor + chunkChars);\r\n    const lastNewline = window.lastIndexOf(\"\\n\");\r\n    const lastSpace = window.lastIndexOf(\" \");\r\n    const splitAt = Math.max(lastNewline, lastSpace);\r\n\r\n    if (splitAt <= 0) {\r\n      chunks.push(window);\r\n      cursor += chunkChars;\r\n      continue;\r\n    }\r\n\r\n    chunks.push(text.slice(cursor, cursor + splitAt + 1));\r\n    cursor += splitAt + 1;\r\n  }\r\n\r\n  return chunks;\r\n}\r\n\r\nexport interface BuildMockStreamEventsOptions {\r\n  messageId: string;\r\n  model?: string;\r\n  mode?: \"plan\" | \"exec\" | \"compact\";\r\n\r\n  /** Chunk size for stream-delta events. */\r\n  chunkChars?: number;\r\n  /** Delay between chunk emissions. */\r\n  chunkDelayMs?: number;\r\n}\r\n\r\n/**\r\n * Convert a high-level mock reply into low-level stream events.\r\n *\r\n * IMPORTANT: This is the ONLY place the mock router reply is translated into\r\n * stream semantics (stream-start/delta/end, usage-delta, etc).\r\n */\r\nexport function buildMockStreamEventsFromReply(\r\n  reply: MockAiRouterReply,\r\n  options: BuildMockStreamEventsOptions\r\n): MockAssistantEvent[] {\r\n  const model = options.model ?? KNOWN_MODELS.OPUS.id;\r\n  const mode = options.mode ?? reply.mode;\r\n\r\n  const chunkChars = options.chunkChars ?? DEFAULT_STREAM_CHUNK_CHARS;\r\n  const chunkDelayMs = options.chunkDelayMs ?? DEFAULT_STREAM_CHUNK_DELAY_MS;\r\n\r\n  const events: MockAssistantEvent[] = [];\r\n\r\n  events.push({\r\n    kind: \"stream-start\",\r\n    delay: 0,\r\n    messageId: options.messageId,\r\n    model,\r\n    ...(mode && { mode }),\r\n  });\r\n\r\n  let nextDelay = 5;\r\n\r\n  if (reply.usage) {\r\n    events.push({\r\n      kind: \"usage-delta\",\r\n      delay: nextDelay,\r\n      usage: reply.usage,\r\n      cumulativeUsage: reply.usage,\r\n    });\r\n    nextDelay += 5;\r\n  }\r\n\r\n  if (reply.reasoningDeltas && reply.reasoningDeltas.length > 0) {\r\n    for (const delta of reply.reasoningDeltas) {\r\n      events.push({\r\n        kind: \"reasoning-delta\",\r\n        delay: nextDelay,\r\n        text: delta,\r\n      });\r\n      nextDelay += 5;\r\n    }\r\n  }\r\n\r\n  if (reply.toolCalls && reply.toolCalls.length > 0) {\r\n    for (const toolCall of reply.toolCalls) {\r\n      events.push({\r\n        kind: \"tool-start\",\r\n        delay: nextDelay,\r\n        toolCallId: toolCall.toolCallId,\r\n        toolName: toolCall.toolName,\r\n        args: toolCall.args,\r\n      });\r\n      nextDelay += 5;\r\n\r\n      events.push({\r\n        kind: \"tool-end\",\r\n        delay: nextDelay,\r\n        toolCallId: toolCall.toolCallId,\r\n        toolName: toolCall.toolName,\r\n        result: toolCall.result,\r\n      });\r\n      nextDelay += 5;\r\n    }\r\n  }\r\n\r\n  const chunkBaseDelay = nextDelay + 5;\r\n\r\n  const chunks = chunkText(reply.assistantText, chunkChars);\r\n  for (const [index, chunk] of chunks.entries()) {\r\n    events.push({\r\n      kind: \"stream-delta\",\r\n      delay: chunkBaseDelay + index * chunkDelayMs,\r\n      text: chunk,\r\n    });\r\n  }\r\n\r\n  const terminalDelay = chunkBaseDelay + chunks.length * chunkDelayMs;\r\n\r\n  if (reply.error) {\r\n    events.push({\r\n      kind: \"stream-error\",\r\n      delay: terminalDelay,\r\n      error: reply.error.message,\r\n      errorType: reply.error.type,\r\n    });\r\n\r\n    return events;\r\n  }\r\n\r\n  const parts: CompletedMessagePart[] = [{ type: \"text\", text: reply.assistantText }];\r\n\r\n  events.push({\r\n    kind: \"stream-end\",\r\n    delay: terminalDelay,\r\n    metadata: {\r\n      model,\r\n      systemMessageTokens: 0,\r\n    },\r\n    parts,\r\n  });\r\n\r\n  return events;\r\n}\r\n"]}