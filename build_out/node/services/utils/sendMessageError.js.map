{"version":3,"file":"sendMessageError.js","sourceRoot":"","sources":["../../../../src/node/services/utils/sendMessageError.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\nimport type { ErrorEvent } from \"@/common/types/stream\";\nimport type { SendMessageError, StreamErrorType } from \"@/common/types/errors\";\nimport type { StreamErrorMessage } from \"@/common/orpc/types\";\nimport { createAssistantMessageId } from \"./messageIds\";\n\n/**\n * Strip noisy error prefixes from provider error messages.\n * e.g., \"undefined: The document file name can only contain...\"\n *       becomes \"The document file name can only contain...\"\n *\n * These prefixes are artifacts of how upstream errors are coerced to strings\n * (e.g., `${error.type}: ${error.message}` where type is undefined).\n */\nexport const stripNoisyErrorPrefix = (message: string): string => {\n  // Strip \"undefined: \" prefix (common in Anthropic SDK errors)\n  if (message.startsWith(\"undefined: \")) {\n    return message.slice(\"undefined: \".length);\n  }\n  return message;\n};\n\n/**\n * Helper to wrap arbitrary errors into SendMessageError structures.\n * Enforces that the raw string is non-empty for defensive debugging.\n */\nexport const createUnknownSendMessageError = (raw: string): SendMessageError => {\n  assert(typeof raw === \"string\", \"Expected raw error to be a string\");\n  const trimmed = stripNoisyErrorPrefix(raw.trim());\n  assert(trimmed.length > 0, \"createUnknownSendMessageError requires a non-empty message\");\n\n  return {\n    type: \"unknown\",\n    raw: trimmed,\n  };\n};\n\n/**\n * Formats a SendMessageError into a user-visible message and StreamErrorType\n * for display in the chat UI as a stream-error event.\n */\nexport const formatSendMessageError = (\n  error: SendMessageError\n): { message: string; errorType: StreamErrorType } => {\n  switch (error.type) {\n    case \"api_key_not_found\":\n      return {\n        message: `API key not configured for ${error.provider}. Please add your API key in settings.`,\n        errorType: \"authentication\",\n      };\n    case \"oauth_not_connected\":\n      return {\n        message:\n          `OAuth not connected for ${error.provider}. ` +\n          `Please connect your account in Settings â†’ Providers.`,\n        errorType: \"authentication\",\n      };\n    case \"provider_not_supported\":\n      return {\n        message: `Provider \"${error.provider}\" is not supported.`,\n        errorType: \"unknown\",\n      };\n    case \"invalid_model_string\":\n      return {\n        message: error.message,\n        errorType: \"model_not_found\",\n      };\n    case \"incompatible_workspace\":\n      return {\n        message: error.message,\n        errorType: \"unknown\",\n      };\n    case \"runtime_not_ready\":\n      return {\n        message:\n          `Workspace runtime unavailable: ${error.message}. ` +\n          `The container/workspace may have been removed or does not exist.`,\n        errorType: \"runtime_not_ready\",\n      };\n    case \"runtime_start_failed\":\n      return {\n        message: `Workspace is starting: ${error.message}`,\n        errorType: \"runtime_start_failed\",\n      };\n    case \"unknown\":\n      return {\n        message: error.raw,\n        errorType: \"unknown\",\n      };\n    case \"policy_denied\":\n      return {\n        message: error.message,\n        errorType: \"unknown\",\n      };\n  }\n};\n\n/**\n * Stream-error payload helpers.\n */\nexport interface StreamErrorPayload {\n  messageId: string;\n  error: string;\n  errorType?: StreamErrorType;\n}\n\nexport const createErrorEvent = (workspaceId: string, payload: StreamErrorPayload): ErrorEvent => ({\n  type: \"error\",\n  workspaceId,\n  messageId: payload.messageId,\n  error: payload.error,\n  errorType: payload.errorType,\n});\n\nconst API_KEY_ERROR_HINTS = [\"api key\", \"api_key\", \"anthropic_api_key\"];\n\nexport const coerceStreamErrorTypeForMessage = (\n  errorType: StreamErrorType,\n  errorMessage: string\n): StreamErrorType => {\n  const loweredMessage = errorMessage.toLowerCase();\n  if (API_KEY_ERROR_HINTS.some((hint) => loweredMessage.includes(hint))) {\n    return \"authentication\";\n  }\n\n  return errorType;\n};\nexport const createStreamErrorMessage = (payload: StreamErrorPayload): StreamErrorMessage => ({\n  type: \"stream-error\",\n  messageId: payload.messageId,\n  error: payload.error,\n  errorType: payload.errorType ?? \"unknown\",\n});\n\n/**\n * Build a stream-error payload for pre-stream failures so the UI can surface them immediately.\n */\nexport const buildStreamErrorEventData = (error: SendMessageError): StreamErrorPayload => {\n  const { message, errorType } = formatSendMessageError(error);\n  const messageId = createAssistantMessageId();\n  return { messageId, error: message, errorType };\n};\n"]}