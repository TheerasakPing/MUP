{"version":3,"file":"sendMessageError.test.js","sourceRoot":"","sources":["../../../../src/node/services/utils/sendMessageError.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\nimport {\n  buildStreamErrorEventData,\n  coerceStreamErrorTypeForMessage,\n  createErrorEvent,\n  createStreamErrorMessage,\n  createUnknownSendMessageError,\n  formatSendMessageError,\n} from \"./sendMessageError\";\n\ndescribe(\"buildStreamErrorEventData\", () => {\n  test(\"builds a stream-error payload with a synthetic messageId\", () => {\n    const result = buildStreamErrorEventData({\n      type: \"api_key_not_found\",\n      provider: \"openai\",\n    });\n\n    expect(result.errorType).toBe(\"authentication\");\n    expect(result.error).toContain(\"openai\");\n    expect(result.messageId).toMatch(/^assistant-/);\n  });\n});\ndescribe(\"createStreamErrorMessage\", () => {\n  test(\"defaults errorType to unknown\", () => {\n    const result = createStreamErrorMessage({\n      messageId: \"assistant-test\",\n      error: \"something went wrong\",\n    });\n\n    expect(result.type).toBe(\"stream-error\");\n    expect(result.errorType).toBe(\"unknown\");\n    expect(result.messageId).toBe(\"assistant-test\");\n  });\n});\n\ndescribe(\"createErrorEvent\", () => {\n  test(\"builds an error event payload\", () => {\n    const result = createErrorEvent(\"workspace-1\", {\n      messageId: \"assistant-123\",\n      error: \"something broke\",\n      errorType: \"unknown\",\n    });\n\n    expect(result).toEqual({\n      type: \"error\",\n      workspaceId: \"workspace-1\",\n      messageId: \"assistant-123\",\n      error: \"something broke\",\n      errorType: \"unknown\",\n    });\n  });\n});\n\ndescribe(\"coerceStreamErrorTypeForMessage\", () => {\n  test(\"forces authentication when API key hints are present\", () => {\n    const result = coerceStreamErrorTypeForMessage(\"unknown\", \"Missing API key\");\n\n    expect(result).toBe(\"authentication\");\n  });\n\n  test(\"keeps the original errorType otherwise\", () => {\n    const result = coerceStreamErrorTypeForMessage(\"network\", \"Connection reset\");\n\n    expect(result).toBe(\"network\");\n  });\n});\n\ndescribe(\"formatSendMessageError\", () => {\n  test(\"formats api_key_not_found with authentication errorType\", () => {\n    const result = formatSendMessageError({\n      type: \"api_key_not_found\",\n      provider: \"anthropic\",\n    });\n\n    expect(result.errorType).toBe(\"authentication\");\n    expect(result.message).toContain(\"anthropic\");\n    expect(result.message).toContain(\"API key\");\n  });\n\n  test(\"formats provider_not_supported\", () => {\n    const result = formatSendMessageError({\n      type: \"provider_not_supported\",\n      provider: \"unsupported-provider\",\n    });\n\n    expect(result.errorType).toBe(\"unknown\");\n    expect(result.message).toContain(\"unsupported-provider\");\n    expect(result.message).toContain(\"not supported\");\n  });\n\n  test(\"formats invalid_model_string with model_not_found errorType\", () => {\n    const result = formatSendMessageError({\n      type: \"invalid_model_string\",\n      message: \"Invalid model format: foo\",\n    });\n\n    expect(result.errorType).toBe(\"model_not_found\");\n    expect(result.message).toBe(\"Invalid model format: foo\");\n  });\n\n  test(\"formats incompatible_workspace\", () => {\n    const result = formatSendMessageError({\n      type: \"incompatible_workspace\",\n      message: \"Workspace is incompatible\",\n    });\n\n    expect(result.errorType).toBe(\"unknown\");\n    expect(result.message).toBe(\"Workspace is incompatible\");\n  });\n\n  test(\"formats unknown errors\", () => {\n    const result = formatSendMessageError({\n      type: \"unknown\",\n      raw: \"Something went wrong\",\n    });\n\n    expect(result.errorType).toBe(\"unknown\");\n    expect(result.message).toBe(\"Something went wrong\");\n  });\n});\n\ndescribe(\"createUnknownSendMessageError\", () => {\n  test(\"creates unknown error with trimmed message\", () => {\n    const result = createUnknownSendMessageError(\"  test error  \");\n\n    expect(result).toEqual({ type: \"unknown\", raw: \"test error\" });\n  });\n\n  test(\"throws on empty message\", () => {\n    expect(() => createUnknownSendMessageError(\"\")).toThrow();\n    expect(() => createUnknownSendMessageError(\"   \")).toThrow();\n  });\n\n  test(\"strips 'undefined: ' prefix from error messages\", () => {\n    const result = createUnknownSendMessageError(\n      \"undefined: The document file name can only contain alphanumeric characters\"\n    );\n\n    expect(result.type).toBe(\"unknown\");\n    if (result.type === \"unknown\") {\n      expect(result.raw).toBe(\"The document file name can only contain alphanumeric characters\");\n      expect(result.raw).not.toContain(\"undefined:\");\n    }\n  });\n\n  test(\"preserves messages without 'undefined: ' prefix\", () => {\n    const result = createUnknownSendMessageError(\"Normal error message\");\n\n    expect(result.type).toBe(\"unknown\");\n    if (result.type === \"unknown\") {\n      expect(result.raw).toBe(\"Normal error message\");\n    }\n  });\n\n  test(\"only strips prefix when at the start of message\", () => {\n    const result = createUnknownSendMessageError(\"Error code undefined: something happened\");\n\n    expect(result.type).toBe(\"unknown\");\n    if (result.type === \"unknown\") {\n      expect(result.raw).toBe(\"Error code undefined: something happened\");\n    }\n  });\n});\n"]}