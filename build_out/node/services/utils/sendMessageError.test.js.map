{"version":3,"file":"sendMessageError.test.js","sourceRoot":"","sources":["../../../../src/node/services/utils/sendMessageError.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\r\nimport {\r\n  buildStreamErrorEventData,\r\n  coerceStreamErrorTypeForMessage,\r\n  createErrorEvent,\r\n  createStreamErrorMessage,\r\n  createUnknownSendMessageError,\r\n  formatSendMessageError,\r\n} from \"./sendMessageError\";\r\n\r\ndescribe(\"buildStreamErrorEventData\", () => {\r\n  test(\"builds a stream-error payload with a synthetic messageId\", () => {\r\n    const result = buildStreamErrorEventData({\r\n      type: \"api_key_not_found\",\r\n      provider: \"openai\",\r\n    });\r\n\r\n    expect(result.errorType).toBe(\"authentication\");\r\n    expect(result.error).toContain(\"openai\");\r\n    expect(result.messageId).toMatch(/^assistant-/);\r\n  });\r\n});\r\ndescribe(\"createStreamErrorMessage\", () => {\r\n  test(\"defaults errorType to unknown\", () => {\r\n    const result = createStreamErrorMessage({\r\n      messageId: \"assistant-test\",\r\n      error: \"something went wrong\",\r\n    });\r\n\r\n    expect(result.type).toBe(\"stream-error\");\r\n    expect(result.errorType).toBe(\"unknown\");\r\n    expect(result.messageId).toBe(\"assistant-test\");\r\n  });\r\n});\r\n\r\ndescribe(\"createErrorEvent\", () => {\r\n  test(\"builds an error event payload\", () => {\r\n    const result = createErrorEvent(\"workspace-1\", {\r\n      messageId: \"assistant-123\",\r\n      error: \"something broke\",\r\n      errorType: \"unknown\",\r\n    });\r\n\r\n    expect(result).toEqual({\r\n      type: \"error\",\r\n      workspaceId: \"workspace-1\",\r\n      messageId: \"assistant-123\",\r\n      error: \"something broke\",\r\n      errorType: \"unknown\",\r\n    });\r\n  });\r\n});\r\n\r\ndescribe(\"coerceStreamErrorTypeForMessage\", () => {\r\n  test(\"forces authentication when API key hints are present\", () => {\r\n    const result = coerceStreamErrorTypeForMessage(\"unknown\", \"Missing API key\");\r\n\r\n    expect(result).toBe(\"authentication\");\r\n  });\r\n\r\n  test(\"keeps the original errorType otherwise\", () => {\r\n    const result = coerceStreamErrorTypeForMessage(\"network\", \"Connection reset\");\r\n\r\n    expect(result).toBe(\"network\");\r\n  });\r\n});\r\n\r\ndescribe(\"formatSendMessageError\", () => {\r\n  test(\"formats api_key_not_found with authentication errorType\", () => {\r\n    const result = formatSendMessageError({\r\n      type: \"api_key_not_found\",\r\n      provider: \"anthropic\",\r\n    });\r\n\r\n    expect(result.errorType).toBe(\"authentication\");\r\n    expect(result.message).toContain(\"anthropic\");\r\n    expect(result.message).toContain(\"API key\");\r\n  });\r\n\r\n  test(\"formats provider_not_supported\", () => {\r\n    const result = formatSendMessageError({\r\n      type: \"provider_not_supported\",\r\n      provider: \"unsupported-provider\",\r\n    });\r\n\r\n    expect(result.errorType).toBe(\"unknown\");\r\n    expect(result.message).toContain(\"unsupported-provider\");\r\n    expect(result.message).toContain(\"not supported\");\r\n  });\r\n\r\n  test(\"formats invalid_model_string with model_not_found errorType\", () => {\r\n    const result = formatSendMessageError({\r\n      type: \"invalid_model_string\",\r\n      message: \"Invalid model format: foo\",\r\n    });\r\n\r\n    expect(result.errorType).toBe(\"model_not_found\");\r\n    expect(result.message).toBe(\"Invalid model format: foo\");\r\n  });\r\n\r\n  test(\"formats incompatible_workspace\", () => {\r\n    const result = formatSendMessageError({\r\n      type: \"incompatible_workspace\",\r\n      message: \"Workspace is incompatible\",\r\n    });\r\n\r\n    expect(result.errorType).toBe(\"unknown\");\r\n    expect(result.message).toBe(\"Workspace is incompatible\");\r\n  });\r\n\r\n  test(\"formats unknown errors\", () => {\r\n    const result = formatSendMessageError({\r\n      type: \"unknown\",\r\n      raw: \"Something went wrong\",\r\n    });\r\n\r\n    expect(result.errorType).toBe(\"unknown\");\r\n    expect(result.message).toBe(\"Something went wrong\");\r\n  });\r\n});\r\n\r\ndescribe(\"createUnknownSendMessageError\", () => {\r\n  test(\"creates unknown error with trimmed message\", () => {\r\n    const result = createUnknownSendMessageError(\"  test error  \");\r\n\r\n    expect(result).toEqual({ type: \"unknown\", raw: \"test error\" });\r\n  });\r\n\r\n  test(\"throws on empty message\", () => {\r\n    expect(() => createUnknownSendMessageError(\"\")).toThrow();\r\n    expect(() => createUnknownSendMessageError(\"   \")).toThrow();\r\n  });\r\n\r\n  test(\"strips 'undefined: ' prefix from error messages\", () => {\r\n    const result = createUnknownSendMessageError(\r\n      \"undefined: The document file name can only contain alphanumeric characters\"\r\n    );\r\n\r\n    expect(result.type).toBe(\"unknown\");\r\n    if (result.type === \"unknown\") {\r\n      expect(result.raw).toBe(\"The document file name can only contain alphanumeric characters\");\r\n      expect(result.raw).not.toContain(\"undefined:\");\r\n    }\r\n  });\r\n\r\n  test(\"preserves messages without 'undefined: ' prefix\", () => {\r\n    const result = createUnknownSendMessageError(\"Normal error message\");\r\n\r\n    expect(result.type).toBe(\"unknown\");\r\n    if (result.type === \"unknown\") {\r\n      expect(result.raw).toBe(\"Normal error message\");\r\n    }\r\n  });\r\n\r\n  test(\"only strips prefix when at the start of message\", () => {\r\n    const result = createUnknownSendMessageError(\"Error code undefined: something happened\");\r\n\r\n    expect(result.type).toBe(\"unknown\");\r\n    if (result.type === \"unknown\") {\r\n      expect(result.raw).toBe(\"Error code undefined: something happened\");\r\n    }\r\n  });\r\n});\r\n"]}