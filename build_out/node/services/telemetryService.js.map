{"version":3,"file":"telemetryService.js","sourceRoot":"","sources":["../../../src/node/services/telemetryService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Backend Telemetry Service\r\n *\r\n * Sends telemetry events to PostHog from the main process (Node.js).\r\n * This avoids ad-blocker issues that affect browser-side telemetry.\r\n *\r\n * Telemetry is enabled by default, including in development mode.\r\n * It is automatically disabled in CI, test environments, and automation contexts\r\n * (NODE_ENV=test, CI, MUX_E2E=1, JEST_WORKER_ID, etc.).\r\n * Users can manually disable telemetry by setting MUX_DISABLE_TELEMETRY=1.\r\n *\r\n * Uses posthog-node which batches events and flushes asynchronously.\r\n */\r\n\r\nimport assert from \"@/common/utils/assert\";\r\nimport { PostHog } from \"posthog-node\";\r\nimport { randomUUID } from \"crypto\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport { getMuxHome } from \"@/common/constants/paths\";\r\nimport { VERSION } from \"@/version\";\r\nimport type { TelemetryEventPayload, BaseTelemetryProperties } from \"@/common/telemetry/payload\";\r\n\r\n// Default configuration (public keys, safe to commit)\r\nconst DEFAULT_POSTHOG_KEY = \"phc_vF1bLfiD5MXEJkxojjsmV5wgpLffp678yhJd3w9Sl4G\";\r\nconst DEFAULT_POSTHOG_HOST = \"https://us.i.posthog.com\";\r\n\r\n// File to persist anonymous distinct ID across sessions\r\nconst TELEMETRY_ID_FILE = \"telemetry_id\";\r\n\r\n/**\r\n * Check if running in a CI/automation environment.\r\n * Covers major CI providers: GitHub Actions, GitLab CI, Jenkins, CircleCI,\r\n * Travis, Azure Pipelines, Bitbucket, TeamCity, Buildkite, etc.\r\n */\r\nfunction isCIEnvironment(env: NodeJS.ProcessEnv): boolean {\r\n  return (\r\n    // Generic CI indicator (set by most CI systems)\r\n    env.CI === \"true\" ||\r\n    env.CI === \"1\" ||\r\n    // GitHub Actions\r\n    env.GITHUB_ACTIONS === \"true\" ||\r\n    // GitLab CI\r\n    env.GITLAB_CI === \"true\" ||\r\n    // Jenkins\r\n    env.JENKINS_URL !== undefined ||\r\n    // CircleCI\r\n    env.CIRCLECI === \"true\" ||\r\n    // Travis CI\r\n    env.TRAVIS === \"true\" ||\r\n    // Azure Pipelines\r\n    env.TF_BUILD === \"True\" ||\r\n    // Bitbucket Pipelines\r\n    env.BITBUCKET_BUILD_NUMBER !== undefined ||\r\n    // TeamCity\r\n    env.TEAMCITY_VERSION !== undefined ||\r\n    // Buildkite\r\n    env.BUILDKITE === \"true\" ||\r\n    // AWS CodeBuild\r\n    env.CODEBUILD_BUILD_ID !== undefined ||\r\n    // Drone CI\r\n    env.DRONE === \"true\" ||\r\n    // AppVeyor\r\n    env.APPVEYOR === \"True\" ||\r\n    // Vercel / Netlify (build environments)\r\n    env.VERCEL === \"1\" ||\r\n    env.NETLIFY === \"true\"\r\n  );\r\n}\r\n\r\n/**\r\n * Check if telemetry is disabled via environment variable or automation context\r\n */\r\nfunction isTelemetryDisabledByEnv(env: NodeJS.ProcessEnv): boolean {\r\n  return (\r\n    env.MUX_DISABLE_TELEMETRY === \"1\" ||\r\n    env.MUX_E2E === \"1\" ||\r\n    env.NODE_ENV === \"test\" ||\r\n    env.JEST_WORKER_ID !== undefined ||\r\n    env.VITEST !== undefined ||\r\n    env.TEST_INTEGRATION === \"1\" ||\r\n    isCIEnvironment(env)\r\n  );\r\n}\r\n\r\nexport interface TelemetryEnablementContext {\r\n  env: NodeJS.ProcessEnv;\r\n  isElectron: boolean;\r\n  isPackaged: boolean | null;\r\n}\r\n\r\nexport function shouldEnableTelemetry(context: TelemetryEnablementContext): boolean {\r\n  // Telemetry is disabled by explicit env vars, CI, or test environments\r\n  if (isTelemetryDisabledByEnv(context.env)) {\r\n    return false;\r\n  }\r\n\r\n  // Otherwise, telemetry is enabled (including dev mode)\r\n  return true;\r\n}\r\n\r\nasync function getElectronIsPackaged(isElectron: boolean): Promise<boolean | null> {\r\n  if (!isElectron) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // eslint-disable-next-line no-restricted-syntax -- Electron is unavailable in `mux server`; avoid top-level import\r\n    const { app } = await import(\"electron\");\r\n    return app.isPackaged;\r\n  } catch {\r\n    // If we can't determine packaging status, fail closed.\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get the version string for telemetry\r\n */\r\nfunction getVersionString(): string {\r\n  if (\r\n    typeof VERSION === \"object\" &&\r\n    VERSION !== null &&\r\n    typeof (VERSION as Record<string, unknown>).git_describe === \"string\"\r\n  ) {\r\n    return (VERSION as { git_describe: string }).git_describe;\r\n  }\r\n  return \"unknown\";\r\n}\r\n\r\nexport class TelemetryService {\r\n  private client: PostHog | null = null;\r\n  private distinctId: string | null = null;\r\n  private featureFlagVariants: Record<string, string | boolean> = {};\r\n  private readonly muxHome: string;\r\n\r\n  getPostHogClient(): PostHog | null {\r\n    return this.client;\r\n  }\r\n\r\n  getDistinctId(): string | null {\r\n    return this.distinctId;\r\n  }\r\n\r\n  /**\r\n   * Check if telemetry is enabled.\r\n   * Returns true only after initialize() completes and telemetry was not disabled.\r\n   */\r\n  isEnabled(): boolean {\r\n    return this.client !== null;\r\n  }\r\n\r\n  /**\r\n   * Check if telemetry was explicitly disabled by the user via MUX_DISABLE_TELEMETRY=1.\r\n   * This is different from isEnabled() which also returns false in dev mode.\r\n   * Used to gate features like link sharing that should only be hidden when\r\n   * the user explicitly opts out of mux services.\r\n   */\r\n  isExplicitlyDisabled(): boolean {\r\n    return process.env.MUX_DISABLE_TELEMETRY === \"1\";\r\n  }\r\n\r\n  /**\r\n   * Set the current PostHog feature flag/experiment assignment.\r\n   *\r\n   * This is used to attach `$feature/<flagKey>` properties to all telemetry events so\r\n   * PostHog can break down metrics by experiment variant (required for server-side capture).\r\n   */\r\n  setFeatureFlagVariant(flagKey: string, variant: string | boolean | null): void {\r\n    assert(typeof flagKey === \"string\", \"flagKey must be a string\");\r\n    const trimmed = flagKey.trim();\r\n    assert(trimmed.length > 0, \"flagKey must not be empty\");\r\n\r\n    const key = `$feature/${trimmed}`;\r\n\r\n    if (variant === null) {\r\n      // Removing the property avoids emitting null values which can pollute breakdowns.\r\n      // Note: This is safe even if telemetry is disabled.\r\n      delete this.featureFlagVariants[key];\r\n      return;\r\n    }\r\n\r\n    assert(\r\n      typeof variant === \"string\" || typeof variant === \"boolean\",\r\n      \"variant must be a string | boolean | null\"\r\n    );\r\n\r\n    this.featureFlagVariants[key] = variant;\r\n  }\r\n  constructor(muxHome?: string) {\r\n    this.muxHome = muxHome ?? getMuxHome();\r\n  }\r\n\r\n  /**\r\n   * Initialize the PostHog client.\r\n   * Should be called once on app startup.\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (this.client) {\r\n      return;\r\n    }\r\n\r\n    const env = process.env;\r\n\r\n    // Fast path: avoid Electron imports when telemetry is obviously disabled.\r\n    if (isTelemetryDisabledByEnv(env)) {\r\n      return;\r\n    }\r\n\r\n    const isElectron = typeof process.versions.electron === \"string\";\r\n    const isPackaged = await getElectronIsPackaged(isElectron);\r\n\r\n    if (!shouldEnableTelemetry({ env, isElectron, isPackaged })) {\r\n      return;\r\n    }\r\n\r\n    // Load or generate distinct ID\r\n    this.distinctId = await this.loadOrCreateDistinctId();\r\n\r\n    this.client = new PostHog(DEFAULT_POSTHOG_KEY, {\r\n      host: DEFAULT_POSTHOG_HOST,\r\n      // Avoid geo-IP enrichment (we don't need coarse location for mux telemetry)\r\n      disableGeoip: true,\r\n    });\r\n\r\n    console.debug(\"[TelemetryService] Initialized\", { host: DEFAULT_POSTHOG_HOST });\r\n  }\r\n\r\n  /**\r\n   * Load existing distinct ID or create a new one.\r\n   * Persisted in ~/.mux/telemetry_id for cross-session identity.\r\n   */\r\n  private async loadOrCreateDistinctId(): Promise<string> {\r\n    const idPath = path.join(this.muxHome, TELEMETRY_ID_FILE);\r\n\r\n    try {\r\n      // Try to read existing ID\r\n      const id = (await fs.readFile(idPath, \"utf-8\")).trim();\r\n      if (id) {\r\n        return id;\r\n      }\r\n    } catch {\r\n      // File doesn't exist or read error, will create new ID\r\n    }\r\n\r\n    // Generate new ID\r\n    const newId = randomUUID();\r\n\r\n    try {\r\n      // Ensure directory exists\r\n      await fs.mkdir(this.muxHome, { recursive: true });\r\n      await fs.writeFile(idPath, newId, \"utf-8\");\r\n    } catch {\r\n      // Silently ignore persistence failures\r\n    }\r\n\r\n    return newId;\r\n  }\r\n\r\n  /**\r\n   * Get base properties included with all events\r\n   */\r\n  private getBaseProperties(): BaseTelemetryProperties & Record<string, string | boolean> {\r\n    return {\r\n      version: getVersionString(),\r\n      backend_platform: process.platform,\r\n      electronVersion: process.versions.electron ?? \"unknown\",\r\n      nodeVersion: process.versions.node ?? \"unknown\",\r\n      bunVersion: process.versions.bun ?? \"unknown\",\r\n      ...this.featureFlagVariants,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Track a telemetry event.\r\n   * Events are silently ignored when disabled.\r\n   */\r\n\r\n  async getFeatureFlag(key: string): Promise<boolean | string | undefined> {\r\n    if (isTelemetryDisabledByEnv(process.env) || !this.client || !this.distinctId) {\r\n      return undefined;\r\n    }\r\n\r\n    try {\r\n      // `getFeatureFlag` will automatically emit $feature_flag_called.\r\n      return await this.client.getFeatureFlag(key, this.distinctId, { disableGeoip: true });\r\n    } catch {\r\n      return undefined;\r\n    }\r\n  }\r\n  capture(payload: TelemetryEventPayload): void {\r\n    if (isTelemetryDisabledByEnv(process.env) || !this.client || !this.distinctId) {\r\n      return;\r\n    }\r\n\r\n    // Merge base properties with event-specific properties\r\n    const properties = {\r\n      ...this.getBaseProperties(),\r\n      ...payload.properties,\r\n    };\r\n\r\n    this.client.capture({\r\n      distinctId: this.distinctId,\r\n      event: payload.event,\r\n      properties,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Shutdown telemetry and flush any pending events.\r\n   * Should be called on app close.\r\n   */\r\n  async shutdown(): Promise<void> {\r\n    if (!this.client) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await this.client.shutdown();\r\n    } catch {\r\n      // Silently ignore shutdown errors\r\n    }\r\n\r\n    this.client = null;\r\n  }\r\n}\r\n"]}