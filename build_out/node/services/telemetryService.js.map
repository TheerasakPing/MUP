{"version":3,"file":"telemetryService.js","sourceRoot":"","sources":["../../../src/node/services/telemetryService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Backend Telemetry Service\n *\n * Sends telemetry events to PostHog from the main process (Node.js).\n * This avoids ad-blocker issues that affect browser-side telemetry.\n *\n * Telemetry is enabled by default, including in development mode.\n * It is automatically disabled in CI, test environments, and automation contexts\n * (NODE_ENV=test, CI, MUX_E2E=1, JEST_WORKER_ID, etc.).\n * Users can manually disable telemetry by setting MUX_DISABLE_TELEMETRY=1.\n *\n * Uses posthog-node which batches events and flushes asynchronously.\n */\n\nimport assert from \"@/common/utils/assert\";\nimport { PostHog } from \"posthog-node\";\nimport { randomUUID } from \"crypto\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport { getMuxHome } from \"@/common/constants/paths\";\nimport { VERSION } from \"@/version\";\nimport type { TelemetryEventPayload, BaseTelemetryProperties } from \"@/common/telemetry/payload\";\n\n// Default configuration (public keys, safe to commit)\nconst DEFAULT_POSTHOG_KEY = \"phc_vF1bLfiD5MXEJkxojjsmV5wgpLffp678yhJd3w9Sl4G\";\nconst DEFAULT_POSTHOG_HOST = \"https://us.i.posthog.com\";\n\n// File to persist anonymous distinct ID across sessions\nconst TELEMETRY_ID_FILE = \"telemetry_id\";\n\n/**\n * Check if running in a CI/automation environment.\n * Covers major CI providers: GitHub Actions, GitLab CI, Jenkins, CircleCI,\n * Travis, Azure Pipelines, Bitbucket, TeamCity, Buildkite, etc.\n */\nfunction isCIEnvironment(env: NodeJS.ProcessEnv): boolean {\n  return (\n    // Generic CI indicator (set by most CI systems)\n    env.CI === \"true\" ||\n    env.CI === \"1\" ||\n    // GitHub Actions\n    env.GITHUB_ACTIONS === \"true\" ||\n    // GitLab CI\n    env.GITLAB_CI === \"true\" ||\n    // Jenkins\n    env.JENKINS_URL !== undefined ||\n    // CircleCI\n    env.CIRCLECI === \"true\" ||\n    // Travis CI\n    env.TRAVIS === \"true\" ||\n    // Azure Pipelines\n    env.TF_BUILD === \"True\" ||\n    // Bitbucket Pipelines\n    env.BITBUCKET_BUILD_NUMBER !== undefined ||\n    // TeamCity\n    env.TEAMCITY_VERSION !== undefined ||\n    // Buildkite\n    env.BUILDKITE === \"true\" ||\n    // AWS CodeBuild\n    env.CODEBUILD_BUILD_ID !== undefined ||\n    // Drone CI\n    env.DRONE === \"true\" ||\n    // AppVeyor\n    env.APPVEYOR === \"True\" ||\n    // Vercel / Netlify (build environments)\n    env.VERCEL === \"1\" ||\n    env.NETLIFY === \"true\"\n  );\n}\n\n/**\n * Check if telemetry is disabled via environment variable or automation context\n */\nfunction isTelemetryDisabledByEnv(env: NodeJS.ProcessEnv): boolean {\n  return (\n    env.MUX_DISABLE_TELEMETRY === \"1\" ||\n    env.MUX_E2E === \"1\" ||\n    env.NODE_ENV === \"test\" ||\n    env.JEST_WORKER_ID !== undefined ||\n    env.VITEST !== undefined ||\n    env.TEST_INTEGRATION === \"1\" ||\n    isCIEnvironment(env)\n  );\n}\n\nexport interface TelemetryEnablementContext {\n  env: NodeJS.ProcessEnv;\n  isElectron: boolean;\n  isPackaged: boolean | null;\n}\n\nexport function shouldEnableTelemetry(context: TelemetryEnablementContext): boolean {\n  // Telemetry is disabled by explicit env vars, CI, or test environments\n  if (isTelemetryDisabledByEnv(context.env)) {\n    return false;\n  }\n\n  // Otherwise, telemetry is enabled (including dev mode)\n  return true;\n}\n\nasync function getElectronIsPackaged(isElectron: boolean): Promise<boolean | null> {\n  if (!isElectron) {\n    return null;\n  }\n\n  try {\n    // eslint-disable-next-line no-restricted-syntax -- Electron is unavailable in `mux server`; avoid top-level import\n    const { app } = await import(\"electron\");\n    return app.isPackaged;\n  } catch {\n    // If we can't determine packaging status, fail closed.\n    return null;\n  }\n}\n\n/**\n * Get the version string for telemetry\n */\nfunction getVersionString(): string {\n  if (\n    typeof VERSION === \"object\" &&\n    VERSION !== null &&\n    typeof (VERSION as Record<string, unknown>).git_describe === \"string\"\n  ) {\n    return (VERSION as { git_describe: string }).git_describe;\n  }\n  return \"unknown\";\n}\n\nexport class TelemetryService {\n  private client: PostHog | null = null;\n  private distinctId: string | null = null;\n  private featureFlagVariants: Record<string, string | boolean> = {};\n  private readonly muxHome: string;\n\n  getPostHogClient(): PostHog | null {\n    return this.client;\n  }\n\n  getDistinctId(): string | null {\n    return this.distinctId;\n  }\n\n  /**\n   * Check if telemetry is enabled.\n   * Returns true only after initialize() completes and telemetry was not disabled.\n   */\n  isEnabled(): boolean {\n    return this.client !== null;\n  }\n\n  /**\n   * Check if telemetry was explicitly disabled by the user via MUX_DISABLE_TELEMETRY=1.\n   * This is different from isEnabled() which also returns false in dev mode.\n   * Used to gate features like link sharing that should only be hidden when\n   * the user explicitly opts out of mux services.\n   */\n  isExplicitlyDisabled(): boolean {\n    return process.env.MUX_DISABLE_TELEMETRY === \"1\";\n  }\n\n  /**\n   * Set the current PostHog feature flag/experiment assignment.\n   *\n   * This is used to attach `$feature/<flagKey>` properties to all telemetry events so\n   * PostHog can break down metrics by experiment variant (required for server-side capture).\n   */\n  setFeatureFlagVariant(flagKey: string, variant: string | boolean | null): void {\n    assert(typeof flagKey === \"string\", \"flagKey must be a string\");\n    const trimmed = flagKey.trim();\n    assert(trimmed.length > 0, \"flagKey must not be empty\");\n\n    const key = `$feature/${trimmed}`;\n\n    if (variant === null) {\n      // Removing the property avoids emitting null values which can pollute breakdowns.\n      // Note: This is safe even if telemetry is disabled.\n      delete this.featureFlagVariants[key];\n      return;\n    }\n\n    assert(\n      typeof variant === \"string\" || typeof variant === \"boolean\",\n      \"variant must be a string | boolean | null\"\n    );\n\n    this.featureFlagVariants[key] = variant;\n  }\n  constructor(muxHome?: string) {\n    this.muxHome = muxHome ?? getMuxHome();\n  }\n\n  /**\n   * Initialize the PostHog client.\n   * Should be called once on app startup.\n   */\n  async initialize(): Promise<void> {\n    if (this.client) {\n      return;\n    }\n\n    const env = process.env;\n\n    // Fast path: avoid Electron imports when telemetry is obviously disabled.\n    if (isTelemetryDisabledByEnv(env)) {\n      return;\n    }\n\n    const isElectron = typeof process.versions.electron === \"string\";\n    const isPackaged = await getElectronIsPackaged(isElectron);\n\n    if (!shouldEnableTelemetry({ env, isElectron, isPackaged })) {\n      return;\n    }\n\n    // Load or generate distinct ID\n    this.distinctId = await this.loadOrCreateDistinctId();\n\n    this.client = new PostHog(DEFAULT_POSTHOG_KEY, {\n      host: DEFAULT_POSTHOG_HOST,\n      // Avoid geo-IP enrichment (we don't need coarse location for mux telemetry)\n      disableGeoip: true,\n    });\n\n    console.debug(\"[TelemetryService] Initialized\", { host: DEFAULT_POSTHOG_HOST });\n  }\n\n  /**\n   * Load existing distinct ID or create a new one.\n   * Persisted in ~/.mux/telemetry_id for cross-session identity.\n   */\n  private async loadOrCreateDistinctId(): Promise<string> {\n    const idPath = path.join(this.muxHome, TELEMETRY_ID_FILE);\n\n    try {\n      // Try to read existing ID\n      const id = (await fs.readFile(idPath, \"utf-8\")).trim();\n      if (id) {\n        return id;\n      }\n    } catch {\n      // File doesn't exist or read error, will create new ID\n    }\n\n    // Generate new ID\n    const newId = randomUUID();\n\n    try {\n      // Ensure directory exists\n      await fs.mkdir(this.muxHome, { recursive: true });\n      await fs.writeFile(idPath, newId, \"utf-8\");\n    } catch {\n      // Silently ignore persistence failures\n    }\n\n    return newId;\n  }\n\n  /**\n   * Get base properties included with all events\n   */\n  private getBaseProperties(): BaseTelemetryProperties & Record<string, string | boolean> {\n    return {\n      version: getVersionString(),\n      backend_platform: process.platform,\n      electronVersion: process.versions.electron ?? \"unknown\",\n      nodeVersion: process.versions.node ?? \"unknown\",\n      bunVersion: process.versions.bun ?? \"unknown\",\n      ...this.featureFlagVariants,\n    };\n  }\n\n  /**\n   * Track a telemetry event.\n   * Events are silently ignored when disabled.\n   */\n\n  async getFeatureFlag(key: string): Promise<boolean | string | undefined> {\n    if (isTelemetryDisabledByEnv(process.env) || !this.client || !this.distinctId) {\n      return undefined;\n    }\n\n    try {\n      // `getFeatureFlag` will automatically emit $feature_flag_called.\n      return await this.client.getFeatureFlag(key, this.distinctId, { disableGeoip: true });\n    } catch {\n      return undefined;\n    }\n  }\n  capture(payload: TelemetryEventPayload): void {\n    if (isTelemetryDisabledByEnv(process.env) || !this.client || !this.distinctId) {\n      return;\n    }\n\n    // Merge base properties with event-specific properties\n    const properties = {\n      ...this.getBaseProperties(),\n      ...payload.properties,\n    };\n\n    this.client.capture({\n      distinctId: this.distinctId,\n      event: payload.event,\n      properties,\n    });\n  }\n\n  /**\n   * Shutdown telemetry and flush any pending events.\n   * Should be called on app close.\n   */\n  async shutdown(): Promise<void> {\n    if (!this.client) {\n      return;\n    }\n\n    try {\n      await this.client.shutdown();\n    } catch {\n      // Silently ignore shutdown errors\n    }\n\n    this.client = null;\n  }\n}\n"]}