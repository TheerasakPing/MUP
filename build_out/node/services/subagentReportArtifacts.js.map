{"version":3,"file":"subagentReportArtifacts.js","sourceRoot":"","sources":["../../../src/node/services/subagentReportArtifacts.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAY,UAAU,wCAAoB;AAC1C,MAAY,IAAI,sCAAkB;AAElC,0EAAgD;AAEhD,sDAAkF;AAElF,6CAA0C;AAC1C,oFAAiF;AA0BjF,MAAM,sCAAsC,GAAG,CAAU,CAAC;AAE1D,MAAM,mCAAmC,GAAG,uBAAuB,CAAC;AACpE,MAAM,wBAAwB,GAAG,kBAAkB,CAAC;AACpD,MAAM,yBAAyB,GAAG,aAAa,CAAC;AAEhD,SAAS,aAAa,CAAC,KAAc,EAAqB;IACxD,OAAO,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,OAAO,CAAC,KAAK,QAAQ,CAAC,CAAC;AAAA,CAC1E;AAED,4CAAmD,mBAA2B,EAAU;IACtF,OAAO,IAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE,mCAAmC,CAAC,CAAC;AAAA,CAC5E;AAED,uCACE,mBAA2B,EAC3B,WAAmB,EACX;IACR,OAAO,IAAI,CAAC,IAAI,CACd,mBAAmB,EACnB,wBAAwB,EACxB,WAAW,EACX,yBAAyB,CAC1B,CAAC;AAAA,CACH;AAEM,KAAK,0CACV,mBAA2B,EACW;IACtC,IAAI,CAAC;QACH,MAAM,QAAQ,GAAG,kCAAkC,CAAC,mBAAmB,CAAC,CAAC;QACzE,MAAM,GAAG,GAAG,MAAM,UAAU,CAAC,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;QACzD,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAY,CAAC;QAE1C,IAAI,CAAC,MAAM,IAAI,OAAO,MAAM,KAAK,QAAQ,EAAE,CAAC;YAC1C,OAAO,EAAE,OAAO,EAAE,sCAAsC,EAAE,sBAAsB,EAAE,EAAE,EAAE,CAAC;QACzF,CAAC;QAED,MAAM,GAAG,GAAG,MAGX,CAAC;QAEF,IAAI,GAAG,CAAC,OAAO,KAAK,sCAAsC,EAAE,CAAC;YAC3D,mCAAmC;YACnC,OAAO,EAAE,OAAO,EAAE,sCAAsC,EAAE,sBAAsB,EAAE,EAAE,EAAE,CAAC;QACzF,CAAC;QAED,IAAI,CAAC,GAAG,CAAC,sBAAsB,IAAI,OAAO,GAAG,CAAC,sBAAsB,KAAK,QAAQ,EAAE,CAAC;YAClF,OAAO,EAAE,OAAO,EAAE,sCAAsC,EAAE,sBAAsB,EAAE,EAAE,EAAE,CAAC;QACzF,CAAC;QAED,OAAO;YACL,OAAO,EAAE,sCAAsC;YAC/C,sBAAsB,EAAE,GAAG,CAAC,sBAG3B;SACF,CAAC;IACJ,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,MAAM,IAAI,KAAK,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YACrF,OAAO,EAAE,OAAO,EAAE,sCAAsC,EAAE,sBAAsB,EAAE,EAAE,EAAE,CAAC;QACzF,CAAC;QAED,SAAG,CAAC,KAAK,CAAC,+CAA+C,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACtE,OAAO,EAAE,OAAO,EAAE,sCAAsC,EAAE,sBAAsB,EAAE,EAAE,EAAE,CAAC;IACzF,CAAC;AAAA,CACF;AAEM,KAAK,+CACV,mBAA2B,EAC3B,WAAmB,EAC+B;IAClD,MAAM,IAAI,GAAG,MAAM,+BAA+B,CAAC,mBAAmB,CAAC,CAAC;IACxE,OAAO,IAAI,CAAC,sBAAsB,CAAC,WAAW,CAAC,IAAI,IAAI,CAAC;AAAA,CACzD;AAEM,KAAK,qCACV,mBAA2B,EAC3B,WAAmB,EACqB;IACxC,MAAM,IAAI,GAAG,MAAM,oCAAoC,CAAC,mBAAmB,EAAE,WAAW,CAAC,CAAC;IAE1F,MAAM,UAAU,GAAG,6BAA6B,CAAC,mBAAmB,EAAE,WAAW,CAAC,CAAC;IACnF,IAAI,CAAC;QACH,MAAM,GAAG,GAAG,MAAM,UAAU,CAAC,QAAQ,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;QAC3D,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAY,CAAC;QAC1C,IAAI,CAAC,MAAM,IAAI,OAAO,MAAM,KAAK,QAAQ,EAAE,CAAC;YAC1C,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,GAAG,GAAG,MAUX,CAAC;QAEF,MAAM,cAAc,GAAG,OAAO,GAAG,CAAC,cAAc,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,CAAC,IAAI,CAAC;QAC1F,IAAI,CAAC,cAAc,IAAI,cAAc,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACnD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,KAAK,GAAG,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC;QAEpE,MAAM,KAAK,GACT,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ,IAAI,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC;QAC9F,MAAM,aAAa,GAAG,IAAA,8BAAmB,EAAC,GAAG,CAAC,aAAa,CAAC,CAAC;QAE7D,IAAI,IAAI,EAAE,CAAC;YACT,4FAA4F;YAC5F,OAAO;gBACL,GAAG,IAAI;gBACP,KAAK,EACH,OAAO,IAAI,CAAC,KAAK,KAAK,QAAQ,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC;oBAC5D,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;oBACnB,CAAC,CAAC,SAAS;gBACf,aAAa,EAAE,IAAA,8BAAmB,EAAC,IAAI,CAAC,aAAa,CAAC;gBACtD,KAAK,EAAE,KAAK,IAAI,IAAI,CAAC,KAAK;gBAC1B,cAAc;aACf,CAAC;QACJ,CAAC;QAED,6FAA6F;QAC7F,MAAM,iBAAiB,GACrB,OAAO,GAAG,CAAC,iBAAiB,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC,CAAC,IAAI,CAAC;QAC3E,MAAM,WAAW,GAAG,OAAO,GAAG,CAAC,WAAW,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC;QACjF,MAAM,WAAW,GAAG,OAAO,GAAG,CAAC,WAAW,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC;QACjF,MAAM,oBAAoB,GAAG,aAAa,CAAC,GAAG,CAAC,oBAAoB,CAAC;YAClE,CAAC,CAAC,GAAG,CAAC,oBAAoB;YAC1B,CAAC,CAAC,IAAI,CAAC;QAET,IAAI,CAAC,iBAAiB,IAAI,CAAC,WAAW,IAAI,CAAC,WAAW,IAAI,CAAC,oBAAoB,EAAE,CAAC;YAChF,OAAO,IAAI,CAAC;QACd,CAAC;QAED,OAAO;YACL,WAAW;YACX,iBAAiB;YACjB,WAAW;YACX,WAAW;YACX,KAAK;YACL,aAAa;YACb,KAAK;YACL,oBAAoB;YACpB,cAAc;SACf,CAAC;IACJ,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,MAAM,IAAI,KAAK,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YACrF,OAAO,IAAI,CAAC;QACd,CAAC;QAED,SAAG,CAAC,KAAK,CAAC,yCAAyC,EAAE,EAAE,WAAW,EAAE,KAAK,EAAE,CAAC,CAAC;QAC7E,OAAO,IAAI,CAAC;IACd,CAAC;AAAA,CACF;AAEM,KAAK,4CAA4C,MAIvD,EAAwC;IACvC,OAAO,uCAAkB,CAAC,QAAQ,CAAC,MAAM,CAAC,WAAW,EAAE,KAAK,IAAI,EAAE,CAAC;QACjE,MAAM,IAAI,GAAG,MAAM,+BAA+B,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;QAC/E,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAEpB,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC,mBAAmB,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACxE,MAAM,QAAQ,GAAG,kCAAkC,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;YAChF,MAAM,IAAA,2BAAe,EAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;QACjE,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,KAAK,CAAC,gDAAgD,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACzE,CAAC;QAED,OAAO,IAAI,CAAC;IAAA,CACb,CAAC,CAAC;AAAA,CACJ;AAEM,KAAK,uCAAuC,MAclD,EAA6C;IAC5C,IAAI,OAAO,GAA4C,IAAI,CAAC;IAE5D,MAAM,uCAAkB,CAAC,QAAQ,CAAC,MAAM,CAAC,WAAW,EAAE,KAAK,IAAI,EAAE,CAAC;QAChE,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC;QAEzC,MAAM,KAAK,GACT,OAAO,MAAM,CAAC,KAAK,KAAK,QAAQ,IAAI,MAAM,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC;YAChE,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,EAAE;YACrB,CAAC,CAAC,SAAS,CAAC;QAChB,MAAM,aAAa,GAAG,IAAA,8BAAmB,EAAC,MAAM,CAAC,aAAa,CAAC,CAAC;QAEhE,MAAM,IAAI,GAAG,MAAM,+BAA+B,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;QAC/E,MAAM,QAAQ,GAAG,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,WAAW,CAAC,IAAI,IAAI,CAAC;QACzE,MAAM,WAAW,GAAG,QAAQ,EAAE,WAAW,IAAI,KAAK,CAAC;QAEnD,2FAA2F;QAC3F,MAAM,UAAU,GAAG,6BAA6B,CAC9C,MAAM,CAAC,mBAAmB,EAC1B,MAAM,CAAC,WAAW,CACnB,CAAC;QACF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACtE,MAAM,IAAA,2BAAe,EACnB,UAAU,EACV,IAAI,CAAC,SAAS,CACZ;gBACE,WAAW,EAAE,MAAM,CAAC,WAAW;gBAC/B,iBAAiB,EAAE,MAAM,CAAC,iBAAiB;gBAC3C,WAAW;gBACX,WAAW,EAAE,KAAK;gBAClB,KAAK;gBACL,aAAa;gBACb,KAAK,EAAE,MAAM,CAAC,KAAK;gBACnB,oBAAoB,EAAE,MAAM,CAAC,oBAAoB;gBACjD,cAAc,EAAE,MAAM,CAAC,cAAc;aACtC,EACD,IAAI,EACJ,CAAC,CACF,CACF,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,KAAK,CAAC,0CAA0C,EAAE;gBACpD,WAAW,EAAE,MAAM,CAAC,WAAW;gBAC/B,WAAW,EAAE,MAAM,CAAC,WAAW;gBAC/B,KAAK;aACN,CAAC,CAAC;YACH,OAAO;QACT,CAAC;QAED,OAAO,GAAG;YACR,WAAW,EAAE,MAAM,CAAC,WAAW;YAC/B,iBAAiB,EAAE,MAAM,CAAC,iBAAiB;YAC3C,WAAW;YACX,WAAW,EAAE,KAAK;YAClB,KAAK;YACL,aAAa;YACb,KAAK,EAAE,MAAM,CAAC,KAAK;YACnB,oBAAoB,EAAE,MAAM,CAAC,oBAAoB;SAClD,CAAC;QACF,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,OAAO,CAAC;QAE1D,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC,mBAAmB,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACxE,MAAM,QAAQ,GAAG,kCAAkC,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;YAChF,MAAM,IAAA,2BAAe,EAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;QACjE,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,KAAK,CAAC,gDAAgD,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACzE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,KAAK,CAAC,+DAA+D,CAAC,CAAC;IACnF,CAAC;IAED,OAAO,OAAO,CAAC;AAAA,CAChB","sourcesContent":["import * as fsPromises from \"fs/promises\";\nimport * as path from \"node:path\";\n\nimport writeFileAtomic from \"write-file-atomic\";\n\nimport { coerceThinkingLevel, type ThinkingLevel } from \"@/common/types/thinking\";\n\nimport { log } from \"@/node/services/log\";\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\n\nexport interface SubagentReportArtifactsFile {\n  version: 1;\n  artifactsByChildTaskId: Record<string, SubagentReportArtifactIndexEntry>;\n}\n\nexport interface SubagentReportArtifactIndexEntry {\n  childTaskId: string;\n  /** Immediate parent in the agent-task tree (matches WorkspaceConfigEntry.parentWorkspaceId). */\n  parentWorkspaceId: string;\n  createdAtMs: number;\n  updatedAtMs: number;\n  /** Task-level model string used when running the sub-agent (optional for legacy entries). */\n  model?: string;\n  /** Task-level thinking/reasoning level used when running the sub-agent (optional for legacy entries). */\n  thinkingLevel?: ThinkingLevel;\n  title?: string;\n  /** Full ancestor chain (parent first). Used for descendant scope checks after cleanup. */\n  ancestorWorkspaceIds: string[];\n}\n\nexport interface SubagentReportArtifact extends SubagentReportArtifactIndexEntry {\n  reportMarkdown: string;\n}\n\nconst SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION = 1 as const;\n\nconst SUBAGENT_REPORT_ARTIFACTS_FILE_NAME = \"subagent-reports.json\";\nconst SUBAGENT_REPORT_DIR_NAME = \"subagent-reports\";\nconst SUBAGENT_REPORT_FILE_NAME = \"report.json\";\n\nfunction isStringArray(value: unknown): value is string[] {\n  return Array.isArray(value) && value.every((v) => typeof v === \"string\");\n}\n\nexport function getSubagentReportArtifactsFilePath(workspaceSessionDir: string): string {\n  return path.join(workspaceSessionDir, SUBAGENT_REPORT_ARTIFACTS_FILE_NAME);\n}\n\nexport function getSubagentReportArtifactPath(\n  workspaceSessionDir: string,\n  childTaskId: string\n): string {\n  return path.join(\n    workspaceSessionDir,\n    SUBAGENT_REPORT_DIR_NAME,\n    childTaskId,\n    SUBAGENT_REPORT_FILE_NAME\n  );\n}\n\nexport async function readSubagentReportArtifactsFile(\n  workspaceSessionDir: string\n): Promise<SubagentReportArtifactsFile> {\n  try {\n    const filePath = getSubagentReportArtifactsFilePath(workspaceSessionDir);\n    const raw = await fsPromises.readFile(filePath, \"utf-8\");\n    const parsed = JSON.parse(raw) as unknown;\n\n    if (!parsed || typeof parsed !== \"object\") {\n      return { version: SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    const obj = parsed as {\n      version?: unknown;\n      artifactsByChildTaskId?: unknown;\n    };\n\n    if (obj.version !== SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION) {\n      // Unknown version; treat as empty.\n      return { version: SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    if (!obj.artifactsByChildTaskId || typeof obj.artifactsByChildTaskId !== \"object\") {\n      return { version: SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    return {\n      version: SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION,\n      artifactsByChildTaskId: obj.artifactsByChildTaskId as Record<\n        string,\n        SubagentReportArtifactIndexEntry\n      >,\n    };\n  } catch (error) {\n    if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n      return { version: SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    log.error(\"Failed to read subagent report artifacts file\", { error });\n    return { version: SUBAGENT_REPORT_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n  }\n}\n\nexport async function readSubagentReportArtifactIndexEntry(\n  workspaceSessionDir: string,\n  childTaskId: string\n): Promise<SubagentReportArtifactIndexEntry | null> {\n  const file = await readSubagentReportArtifactsFile(workspaceSessionDir);\n  return file.artifactsByChildTaskId[childTaskId] ?? null;\n}\n\nexport async function readSubagentReportArtifact(\n  workspaceSessionDir: string,\n  childTaskId: string\n): Promise<SubagentReportArtifact | null> {\n  const meta = await readSubagentReportArtifactIndexEntry(workspaceSessionDir, childTaskId);\n\n  const reportPath = getSubagentReportArtifactPath(workspaceSessionDir, childTaskId);\n  try {\n    const raw = await fsPromises.readFile(reportPath, \"utf-8\");\n    const parsed = JSON.parse(raw) as unknown;\n    if (!parsed || typeof parsed !== \"object\") {\n      return null;\n    }\n\n    const obj = parsed as {\n      childTaskId?: unknown;\n      parentWorkspaceId?: unknown;\n      createdAtMs?: unknown;\n      updatedAtMs?: unknown;\n      model?: unknown;\n      thinkingLevel?: unknown;\n      title?: unknown;\n      ancestorWorkspaceIds?: unknown;\n      reportMarkdown?: unknown;\n    };\n\n    const reportMarkdown = typeof obj.reportMarkdown === \"string\" ? obj.reportMarkdown : null;\n    if (!reportMarkdown || reportMarkdown.length === 0) {\n      return null;\n    }\n\n    const title = typeof obj.title === \"string\" ? obj.title : undefined;\n\n    const model =\n      typeof obj.model === \"string\" && obj.model.trim().length > 0 ? obj.model.trim() : undefined;\n    const thinkingLevel = coerceThinkingLevel(obj.thinkingLevel);\n\n    if (meta) {\n      // Trust the index file for metadata (versioned), but allow per-task file to override title.\n      return {\n        ...meta,\n        model:\n          typeof meta.model === \"string\" && meta.model.trim().length > 0\n            ? meta.model.trim()\n            : undefined,\n        thinkingLevel: coerceThinkingLevel(meta.thinkingLevel),\n        title: title ?? meta.title,\n        reportMarkdown,\n      };\n    }\n\n    // Self-healing: if the index entry is missing/corrupted, fall back to the per-task artifact.\n    const parentWorkspaceId =\n      typeof obj.parentWorkspaceId === \"string\" ? obj.parentWorkspaceId : null;\n    const createdAtMs = typeof obj.createdAtMs === \"number\" ? obj.createdAtMs : null;\n    const updatedAtMs = typeof obj.updatedAtMs === \"number\" ? obj.updatedAtMs : null;\n    const ancestorWorkspaceIds = isStringArray(obj.ancestorWorkspaceIds)\n      ? obj.ancestorWorkspaceIds\n      : null;\n\n    if (!parentWorkspaceId || !createdAtMs || !updatedAtMs || !ancestorWorkspaceIds) {\n      return null;\n    }\n\n    return {\n      childTaskId,\n      parentWorkspaceId,\n      createdAtMs,\n      updatedAtMs,\n      model,\n      thinkingLevel,\n      title,\n      ancestorWorkspaceIds,\n      reportMarkdown,\n    };\n  } catch (error) {\n    if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n      return null;\n    }\n\n    log.error(\"Failed to read subagent report artifact\", { childTaskId, error });\n    return null;\n  }\n}\n\nexport async function updateSubagentReportArtifactsFile(params: {\n  workspaceId: string;\n  workspaceSessionDir: string;\n  update: (file: SubagentReportArtifactsFile) => void;\n}): Promise<SubagentReportArtifactsFile> {\n  return workspaceFileLocks.withLock(params.workspaceId, async () => {\n    const file = await readSubagentReportArtifactsFile(params.workspaceSessionDir);\n    params.update(file);\n\n    try {\n      await fsPromises.mkdir(params.workspaceSessionDir, { recursive: true });\n      const filePath = getSubagentReportArtifactsFilePath(params.workspaceSessionDir);\n      await writeFileAtomic(filePath, JSON.stringify(file, null, 2));\n    } catch (error) {\n      log.error(\"Failed to write subagent report artifacts file\", { error });\n    }\n\n    return file;\n  });\n}\n\nexport async function upsertSubagentReportArtifact(params: {\n  /** Workspace id that owns the session dir we're writing into (used for file locking). */\n  workspaceId: string;\n  workspaceSessionDir: string;\n  childTaskId: string;\n  parentWorkspaceId: string;\n  ancestorWorkspaceIds: string[];\n  reportMarkdown: string;\n  /** Task-level model string used when running the sub-agent (optional for legacy entries). */\n  model?: string;\n  /** Task-level thinking/reasoning level used when running the sub-agent (optional for legacy entries). */\n  thinkingLevel?: ThinkingLevel;\n  title?: string;\n  nowMs?: number;\n}): Promise<SubagentReportArtifactIndexEntry> {\n  let updated: SubagentReportArtifactIndexEntry | null = null;\n\n  await workspaceFileLocks.withLock(params.workspaceId, async () => {\n    const nowMs = params.nowMs ?? Date.now();\n\n    const model =\n      typeof params.model === \"string\" && params.model.trim().length > 0\n        ? params.model.trim()\n        : undefined;\n    const thinkingLevel = coerceThinkingLevel(params.thinkingLevel);\n\n    const file = await readSubagentReportArtifactsFile(params.workspaceSessionDir);\n    const existing = file.artifactsByChildTaskId[params.childTaskId] ?? null;\n    const createdAtMs = existing?.createdAtMs ?? nowMs;\n\n    // Write the report payload first so we never publish an index entry without a report body.\n    const reportPath = getSubagentReportArtifactPath(\n      params.workspaceSessionDir,\n      params.childTaskId\n    );\n    try {\n      await fsPromises.mkdir(path.dirname(reportPath), { recursive: true });\n      await writeFileAtomic(\n        reportPath,\n        JSON.stringify(\n          {\n            childTaskId: params.childTaskId,\n            parentWorkspaceId: params.parentWorkspaceId,\n            createdAtMs,\n            updatedAtMs: nowMs,\n            model,\n            thinkingLevel,\n            title: params.title,\n            ancestorWorkspaceIds: params.ancestorWorkspaceIds,\n            reportMarkdown: params.reportMarkdown,\n          },\n          null,\n          2\n        )\n      );\n    } catch (error) {\n      log.error(\"Failed to write subagent report artifact\", {\n        workspaceId: params.workspaceId,\n        childTaskId: params.childTaskId,\n        error,\n      });\n      return;\n    }\n\n    updated = {\n      childTaskId: params.childTaskId,\n      parentWorkspaceId: params.parentWorkspaceId,\n      createdAtMs,\n      updatedAtMs: nowMs,\n      model,\n      thinkingLevel,\n      title: params.title,\n      ancestorWorkspaceIds: params.ancestorWorkspaceIds,\n    };\n    file.artifactsByChildTaskId[params.childTaskId] = updated;\n\n    try {\n      await fsPromises.mkdir(params.workspaceSessionDir, { recursive: true });\n      const filePath = getSubagentReportArtifactsFilePath(params.workspaceSessionDir);\n      await writeFileAtomic(filePath, JSON.stringify(file, null, 2));\n    } catch (error) {\n      log.error(\"Failed to write subagent report artifacts file\", { error });\n    }\n  });\n\n  if (!updated) {\n    throw new Error(\"upsertSubagentReportArtifact: failed to write report artifact\");\n  }\n\n  return updated;\n}\n"]}