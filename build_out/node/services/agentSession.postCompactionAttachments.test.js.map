{"version":3,"file":"agentSession.postCompactionAttachments.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.postCompactionAttachments.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, mock, afterEach } from \"bun:test\";\nimport { EventEmitter } from \"events\";\n\nimport type { PostCompactionAttachment } from \"@/common/types/attachment\";\nimport { TURNS_BETWEEN_ATTACHMENTS } from \"@/common/constants/attachments\";\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\nimport type { Config } from \"@/node/config\";\n\nimport type { AIService } from \"./aiService\";\nimport { AgentSession } from \"./agentSession\";\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\nimport type { HistoryService } from \"./historyService\";\nimport type { InitStateManager } from \"./initStateManager\";\nimport type { PartialService } from \"./partialService\";\nimport { DisposableTempDir } from \"./tempDir\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport type { CostTrackingService } from \"./costTrackingService\";\n\nfunction createSuccessfulFileEditMessage(id: string, filePath: string, diff: string): MuxMessage {\n  return {\n    id,\n    role: \"assistant\",\n    parts: [\n      {\n        type: \"dynamic-tool\",\n        toolCallId: `tool-${id}`,\n        toolName: \"file_edit_replace_string\",\n        state: \"output-available\",\n        input: { file_path: filePath },\n        output: { success: true, diff },\n      },\n    ],\n    metadata: {\n      timestamp: Date.now(),\n    },\n  };\n}\n\nfunction getEditedFilePaths(attachments: PostCompactionAttachment[]): string[] {\n  const editedFilesAttachment = attachments.find(\n    (\n      attachment\n    ): attachment is Extract<PostCompactionAttachment, { type: \"edited_files_reference\" }> =>\n      attachment.type === \"edited_files_reference\"\n  );\n\n  return editedFilesAttachment?.files.map((file) => file.path) ?? [];\n}\n\nfunction createSessionForHistory(historyService: HistoryService, sessionDir: string): AgentSession {\n  const partialService: PartialService = {} as unknown as PartialService;\n\n  const aiEmitter = new EventEmitter();\n  const aiService: AIService = {\n    on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n      aiEmitter.on(String(eventName), listener);\n      return this;\n    },\n    off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n      aiEmitter.off(String(eventName), listener);\n      return this;\n    },\n    getWorkspaceMetadata: mock(() =>\n      Promise.resolve({ success: false as const, error: \"metadata unavailable\" })\n    ),\n    stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n  } as unknown as AIService;\n\n  const initStateManager: InitStateManager = {\n    on() {\n      return this;\n    },\n    off() {\n      return this;\n    },\n  } as unknown as InitStateManager;\n\n  const backgroundProcessManager: BackgroundProcessManager = {\n    setMessageQueued: mock(() => undefined),\n    cleanup: mock(() => Promise.resolve()),\n  } as unknown as BackgroundProcessManager;\n\n  const config: Config = {\n    srcDir: \"/tmp\",\n    getSessionDir: mock(() => sessionDir),\n  } as unknown as Config;\n\n  return new AgentSession({\n    workspaceId: \"workspace-post-compaction-test\",\n    config,\n    historyService,\n    partialService,\n    aiService,\n    initStateManager,\n    costTrackingService: {} as unknown as CostTrackingService,\n    backgroundProcessManager,\n  });\n}\n\nasync function generatePeriodicPostCompactionAttachments(\n  session: AgentSession\n): Promise<PostCompactionAttachment[]> {\n  const privateSession = session as unknown as {\n    compactionOccurred: boolean;\n    turnsSinceLastAttachment: number;\n    getPostCompactionAttachmentsIfNeeded: () => Promise<PostCompactionAttachment[] | null>;\n  };\n\n  privateSession.compactionOccurred = true;\n  privateSession.turnsSinceLastAttachment = TURNS_BETWEEN_ATTACHMENTS - 1;\n\n  const attachments = await privateSession.getPostCompactionAttachmentsIfNeeded();\n  expect(attachments).not.toBeNull();\n\n  return attachments ?? [];\n}\n\ndescribe(\"AgentSession periodic post-compaction attachments\", () => {\n  let historyCleanup: (() => Promise<void>) | undefined;\n  afterEach(async () => {\n    await historyCleanup?.();\n  });\n\n  test(\"extracts edited file diffs from the latest durable compaction boundary slice\", async () => {\n    using sessionDir = new DisposableTempDir(\"agent-session-latest-boundary\");\n\n    const history: MuxMessage[] = [\n      createSuccessfulFileEditMessage(\n        \"stale-before-boundary\",\n        \"/tmp/stale-before-boundary.ts\",\n        \"@@ -1 +1 @@\\n-old\\n+older\\n\"\n      ),\n      createMuxMessage(\"boundary-1\", \"assistant\", \"epoch 1 summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      }),\n      createSuccessfulFileEditMessage(\n        \"stale-epoch-1\",\n        \"/tmp/stale-epoch-1.ts\",\n        \"@@ -1 +1 @@\\n-old\\n+stale\\n\"\n      ),\n      createMuxMessage(\"boundary-2\", \"assistant\", \"epoch 2 summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 2,\n      }),\n      createSuccessfulFileEditMessage(\n        \"recent-epoch-2\",\n        \"/tmp/recent-epoch-2.ts\",\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\"\n      ),\n    ];\n\n    const workspaceId = \"workspace-post-compaction-test\";\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n    for (const msg of history) {\n      await historyService.appendToHistory(workspaceId, msg);\n    }\n\n    const session = createSessionForHistory(historyService, sessionDir.path);\n\n    try {\n      const attachments = await generatePeriodicPostCompactionAttachments(session);\n      expect(getEditedFilePaths(attachments)).toEqual([\"/tmp/recent-epoch-2.ts\"]);\n    } finally {\n      session.dispose();\n    }\n  });\n\n  test(\"falls back safely when boundary markers are malformed\", async () => {\n    using sessionDir = new DisposableTempDir(\"agent-session-malformed-boundary\");\n\n    const history: MuxMessage[] = [\n      createSuccessfulFileEditMessage(\"stale-edit\", \"/tmp/stale.ts\", \"@@ -1 +1 @@\\n-old\\n+stale\\n\"),\n      createMuxMessage(\"malformed-boundary\", \"assistant\", \"malformed summary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        // Missing compactionEpoch: marker should be ignored without crashing.\n      }),\n      createSuccessfulFileEditMessage(\n        \"recent-edit\",\n        \"/tmp/recent.ts\",\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\"\n      ),\n    ];\n\n    const workspaceId = \"workspace-post-compaction-test\";\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n    for (const msg of history) {\n      await historyService.appendToHistory(workspaceId, msg);\n    }\n\n    const session = createSessionForHistory(historyService, sessionDir.path);\n\n    try {\n      const attachments = await generatePeriodicPostCompactionAttachments(session);\n      expect(getEditedFilePaths(attachments)).toEqual([\"/tmp/recent.ts\", \"/tmp/stale.ts\"]);\n    } finally {\n      session.dispose();\n    }\n  });\n});\n"]}