{"version":3,"file":"agentSession.postCompactionAttachments.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.postCompactionAttachments.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAmE;AACnE,mCAAsC;AAGtC,gEAA2E;AAC3E,oDAA2E;AAI3E,iDAA8C;AAK9C,uCAA8C;AAC9C,6DAAgE;AAGhE,SAAS,+BAA+B,CAAC,EAAU,EAAE,QAAgB,EAAE,IAAY,EAAc;IAC/F,OAAO;QACL,EAAE;QACF,IAAI,EAAE,WAAW;QACjB,KAAK,EAAE;YACL;gBACE,IAAI,EAAE,cAAc;gBACpB,UAAU,EAAE,QAAQ,EAAE,EAAE;gBACxB,QAAQ,EAAE,0BAA0B;gBACpC,KAAK,EAAE,kBAAkB;gBACzB,KAAK,EAAE,EAAE,SAAS,EAAE,QAAQ,EAAE;gBAC9B,MAAM,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE;aAChC;SACF;QACD,QAAQ,EAAE;YACR,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB;KACF,CAAC;AAAA,CACH;AAED,SAAS,kBAAkB,CAAC,WAAuC,EAAY;IAC7E,MAAM,qBAAqB,GAAG,WAAW,CAAC,IAAI,CAC5C,CACE,UAAU,EAC2E,EAAE,CACvF,UAAU,CAAC,IAAI,KAAK,wBAAwB,CAC/C,CAAC;IAEF,OAAO,qBAAqB,EAAE,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;AAAA,CACpE;AAED,SAAS,uBAAuB,CAAC,cAA8B,EAAE,UAAkB,EAAgB;IACjG,MAAM,cAAc,GAAmB,EAA+B,CAAC;IAEvE,MAAM,SAAS,GAAG,IAAI,qBAAY,EAAE,CAAC;IACrC,MAAM,SAAS,GAAc;QAC3B,EAAE,CAAC,SAA0B,EAAE,QAAsC,EAAE;YACrE,SAAS,CAAC,EAAE,CAAC,MAAM,CAAC,SAAS,CAAC,EAAE,QAAQ,CAAC,CAAC;YAC1C,OAAO,IAAI,CAAC;QAAA,CACb;QACD,GAAG,CAAC,SAA0B,EAAE,QAAsC,EAAE;YACtE,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,EAAE,QAAQ,CAAC,CAAC;YAC3C,OAAO,IAAI,CAAC;QAAA,CACb;QACD,oBAAoB,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAC9B,OAAO,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,KAAc,EAAE,KAAK,EAAE,sBAAsB,EAAE,CAAC,CAC5E;QACD,UAAU,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,IAAa,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAC;KAC7D,CAAC;IAE1B,MAAM,gBAAgB,GAAqB;QACzC,EAAE,GAAG;YACH,OAAO,IAAI,CAAC;QAAA,CACb;QACD,GAAG,GAAG;YACJ,OAAO,IAAI,CAAC;QAAA,CACb;KAC6B,CAAC;IAEjC,MAAM,wBAAwB,GAA6B;QACzD,gBAAgB,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,SAAS,CAAC;QACvC,OAAO,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;KACA,CAAC;IAEzC,MAAM,MAAM,GAAW;QACrB,MAAM,EAAE,MAAM;QACd,aAAa,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,UAAU,CAAC;KACjB,CAAC;IAEvB,OAAO,IAAI,2BAAY,CAAC;QACtB,WAAW,EAAE,gCAAgC;QAC7C,MAAM;QACN,cAAc;QACd,cAAc;QACd,SAAS;QACT,gBAAgB;QAChB,mBAAmB,EAAE,EAAoC;QACzD,wBAAwB;KACzB,CAAC,CAAC;AAAA,CACJ;AAED,KAAK,UAAU,yCAAyC,CACtD,OAAqB,EACgB;IACrC,MAAM,cAAc,GAAG,OAItB,CAAC;IAEF,cAAc,CAAC,kBAAkB,GAAG,IAAI,CAAC;IACzC,cAAc,CAAC,wBAAwB,GAAG,uCAAyB,GAAG,CAAC,CAAC;IAExE,MAAM,WAAW,GAAG,MAAM,cAAc,CAAC,oCAAoC,EAAE,CAAC;IAChF,IAAA,iBAAM,EAAC,WAAW,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;IAEnC,OAAO,WAAW,IAAI,EAAE,CAAC;AAAA,CAC1B;AAED,IAAA,mBAAQ,EAAC,mDAAmD,EAAE,GAAG,EAAE,CAAC;IAClE,IAAI,cAAiD,CAAC;IACtD,IAAA,oBAAS,EAAC,KAAK,IAAI,EAAE,CAAC;QACpB,MAAM,cAAc,EAAE,EAAE,CAAC;IAAA,CAC1B,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,8EAA8E,EAAE,KAAK,IAAI,EAAE,CAAC;;;YAC/F,MAAM,UAAU,kCAAG,IAAI,2BAAiB,CAAC,+BAA+B,CAAC,QAAA,CAAC;YAE1E,MAAM,OAAO,GAAiB;gBAC5B,+BAA+B,CAC7B,uBAAuB,EACvB,+BAA+B,EAC/B,6BAA6B,CAC9B;gBACD,IAAA,0BAAgB,EAAC,YAAY,EAAE,WAAW,EAAE,iBAAiB,EAAE;oBAC7D,SAAS,EAAE,MAAM;oBACjB,kBAAkB,EAAE,IAAI;oBACxB,eAAe,EAAE,CAAC;iBACnB,CAAC;gBACF,+BAA+B,CAC7B,eAAe,EACf,uBAAuB,EACvB,6BAA6B,CAC9B;gBACD,IAAA,0BAAgB,EAAC,YAAY,EAAE,WAAW,EAAE,iBAAiB,EAAE;oBAC7D,SAAS,EAAE,MAAM;oBACjB,kBAAkB,EAAE,IAAI;oBACxB,eAAe,EAAE,CAAC;iBACnB,CAAC;gBACF,+BAA+B,CAC7B,gBAAgB,EAChB,wBAAwB,EACxB,gCAAgC,CACjC;aACF,CAAC;YAEF,MAAM,WAAW,GAAG,gCAAgC,CAAC;YACrD,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;YACrE,cAAc,GAAG,OAAO,CAAC;YACzB,KAAK,MAAM,GAAG,IAAI,OAAO,EAAE,CAAC;gBAC1B,MAAM,cAAc,CAAC,eAAe,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;YACzD,CAAC;YAED,MAAM,OAAO,GAAG,uBAAuB,CAAC,cAAc,EAAE,UAAU,CAAC,IAAI,CAAC,CAAC;YAEzE,IAAI,CAAC;gBACH,MAAM,WAAW,GAAG,MAAM,yCAAyC,CAAC,OAAO,CAAC,CAAC;gBAC7E,IAAA,iBAAM,EAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,wBAAwB,CAAC,CAAC,CAAC;YAC9E,CAAC;oBAAS,CAAC;gBACT,OAAO,CAAC,OAAO,EAAE,CAAC;YACpB,CAAC;;;;;;;;;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE,CAAC;;;YACxE,MAAM,UAAU,kCAAG,IAAI,2BAAiB,CAAC,kCAAkC,CAAC,QAAA,CAAC;YAE7E,MAAM,OAAO,GAAiB;gBAC5B,+BAA+B,CAAC,YAAY,EAAE,eAAe,EAAE,6BAA6B,CAAC;gBAC7F,IAAA,0BAAgB,EAAC,oBAAoB,EAAE,WAAW,EAAE,mBAAmB,EAAE;oBACvE,SAAS,EAAE,MAAM;oBACjB,kBAAkB,EAAE,IAAI;oBACxB,sEAAsE;iBACvE,CAAC;gBACF,+BAA+B,CAC7B,aAAa,EACb,gBAAgB,EAChB,gCAAgC,CACjC;aACF,CAAC;YAEF,MAAM,WAAW,GAAG,gCAAgC,CAAC;YACrD,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;YACrE,cAAc,GAAG,OAAO,CAAC;YACzB,KAAK,MAAM,GAAG,IAAI,OAAO,EAAE,CAAC;gBAC1B,MAAM,cAAc,CAAC,eAAe,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;YACzD,CAAC;YAED,MAAM,OAAO,GAAG,uBAAuB,CAAC,cAAc,EAAE,UAAU,CAAC,IAAI,CAAC,CAAC;YAEzE,IAAI,CAAC;gBACH,MAAM,WAAW,GAAG,MAAM,yCAAyC,CAAC,OAAO,CAAC,CAAC;gBAC7E,IAAA,iBAAM,EAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,gBAAgB,EAAE,eAAe,CAAC,CAAC,CAAC;YACvF,CAAC;oBAAS,CAAC;gBACT,OAAO,CAAC,OAAO,EAAE,CAAC;YACpB,CAAC;;;;;;;;;IAAA,CACF,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, expect, test, mock, afterEach } from \"bun:test\";\r\nimport { EventEmitter } from \"events\";\r\n\r\nimport type { PostCompactionAttachment } from \"@/common/types/attachment\";\r\nimport { TURNS_BETWEEN_ATTACHMENTS } from \"@/common/constants/attachments\";\r\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\r\nimport type { Config } from \"@/node/config\";\r\n\r\nimport type { AIService } from \"./aiService\";\r\nimport { AgentSession } from \"./agentSession\";\r\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\r\nimport type { HistoryService } from \"./historyService\";\r\nimport type { InitStateManager } from \"./initStateManager\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport { DisposableTempDir } from \"./tempDir\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { CostTrackingService } from \"./costTrackingService\";\r\n\r\nfunction createSuccessfulFileEditMessage(id: string, filePath: string, diff: string): MuxMessage {\r\n  return {\r\n    id,\r\n    role: \"assistant\",\r\n    parts: [\r\n      {\r\n        type: \"dynamic-tool\",\r\n        toolCallId: `tool-${id}`,\r\n        toolName: \"file_edit_replace_string\",\r\n        state: \"output-available\",\r\n        input: { file_path: filePath },\r\n        output: { success: true, diff },\r\n      },\r\n    ],\r\n    metadata: {\r\n      timestamp: Date.now(),\r\n    },\r\n  };\r\n}\r\n\r\nfunction getEditedFilePaths(attachments: PostCompactionAttachment[]): string[] {\r\n  const editedFilesAttachment = attachments.find(\r\n    (\r\n      attachment\r\n    ): attachment is Extract<PostCompactionAttachment, { type: \"edited_files_reference\" }> =>\r\n      attachment.type === \"edited_files_reference\"\r\n  );\r\n\r\n  return editedFilesAttachment?.files.map((file) => file.path) ?? [];\r\n}\r\n\r\nfunction createSessionForHistory(historyService: HistoryService, sessionDir: string): AgentSession {\r\n  const partialService: PartialService = {} as unknown as PartialService;\r\n\r\n  const aiEmitter = new EventEmitter();\r\n  const aiService: AIService = {\r\n    on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n      aiEmitter.on(String(eventName), listener);\r\n      return this;\r\n    },\r\n    off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n      aiEmitter.off(String(eventName), listener);\r\n      return this;\r\n    },\r\n    getWorkspaceMetadata: mock(() =>\r\n      Promise.resolve({ success: false as const, error: \"metadata unavailable\" })\r\n    ),\r\n    stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n  } as unknown as AIService;\r\n\r\n  const initStateManager: InitStateManager = {\r\n    on() {\r\n      return this;\r\n    },\r\n    off() {\r\n      return this;\r\n    },\r\n  } as unknown as InitStateManager;\r\n\r\n  const backgroundProcessManager: BackgroundProcessManager = {\r\n    setMessageQueued: mock(() => undefined),\r\n    cleanup: mock(() => Promise.resolve()),\r\n  } as unknown as BackgroundProcessManager;\r\n\r\n  const config: Config = {\r\n    srcDir: \"/tmp\",\r\n    getSessionDir: mock(() => sessionDir),\r\n  } as unknown as Config;\r\n\r\n  return new AgentSession({\r\n    workspaceId: \"workspace-post-compaction-test\",\r\n    config,\r\n    historyService,\r\n    partialService,\r\n    aiService,\r\n    initStateManager,\r\n    costTrackingService: {} as unknown as CostTrackingService,\r\n    backgroundProcessManager,\r\n  });\r\n}\r\n\r\nasync function generatePeriodicPostCompactionAttachments(\r\n  session: AgentSession\r\n): Promise<PostCompactionAttachment[]> {\r\n  const privateSession = session as unknown as {\r\n    compactionOccurred: boolean;\r\n    turnsSinceLastAttachment: number;\r\n    getPostCompactionAttachmentsIfNeeded: () => Promise<PostCompactionAttachment[] | null>;\r\n  };\r\n\r\n  privateSession.compactionOccurred = true;\r\n  privateSession.turnsSinceLastAttachment = TURNS_BETWEEN_ATTACHMENTS - 1;\r\n\r\n  const attachments = await privateSession.getPostCompactionAttachmentsIfNeeded();\r\n  expect(attachments).not.toBeNull();\r\n\r\n  return attachments ?? [];\r\n}\r\n\r\ndescribe(\"AgentSession periodic post-compaction attachments\", () => {\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  test(\"extracts edited file diffs from the latest durable compaction boundary slice\", async () => {\r\n    using sessionDir = new DisposableTempDir(\"agent-session-latest-boundary\");\r\n\r\n    const history: MuxMessage[] = [\r\n      createSuccessfulFileEditMessage(\r\n        \"stale-before-boundary\",\r\n        \"/tmp/stale-before-boundary.ts\",\r\n        \"@@ -1 +1 @@\\n-old\\n+older\\n\"\r\n      ),\r\n      createMuxMessage(\"boundary-1\", \"assistant\", \"epoch 1 summary\", {\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        compactionEpoch: 1,\r\n      }),\r\n      createSuccessfulFileEditMessage(\r\n        \"stale-epoch-1\",\r\n        \"/tmp/stale-epoch-1.ts\",\r\n        \"@@ -1 +1 @@\\n-old\\n+stale\\n\"\r\n      ),\r\n      createMuxMessage(\"boundary-2\", \"assistant\", \"epoch 2 summary\", {\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        compactionEpoch: 2,\r\n      }),\r\n      createSuccessfulFileEditMessage(\r\n        \"recent-epoch-2\",\r\n        \"/tmp/recent-epoch-2.ts\",\r\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\"\r\n      ),\r\n    ];\r\n\r\n    const workspaceId = \"workspace-post-compaction-test\";\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n    for (const msg of history) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n\r\n    const session = createSessionForHistory(historyService, sessionDir.path);\r\n\r\n    try {\r\n      const attachments = await generatePeriodicPostCompactionAttachments(session);\r\n      expect(getEditedFilePaths(attachments)).toEqual([\"/tmp/recent-epoch-2.ts\"]);\r\n    } finally {\r\n      session.dispose();\r\n    }\r\n  });\r\n\r\n  test(\"falls back safely when boundary markers are malformed\", async () => {\r\n    using sessionDir = new DisposableTempDir(\"agent-session-malformed-boundary\");\r\n\r\n    const history: MuxMessage[] = [\r\n      createSuccessfulFileEditMessage(\"stale-edit\", \"/tmp/stale.ts\", \"@@ -1 +1 @@\\n-old\\n+stale\\n\"),\r\n      createMuxMessage(\"malformed-boundary\", \"assistant\", \"malformed summary\", {\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        // Missing compactionEpoch: marker should be ignored without crashing.\r\n      }),\r\n      createSuccessfulFileEditMessage(\r\n        \"recent-edit\",\r\n        \"/tmp/recent.ts\",\r\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\"\r\n      ),\r\n    ];\r\n\r\n    const workspaceId = \"workspace-post-compaction-test\";\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n    for (const msg of history) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n\r\n    const session = createSessionForHistory(historyService, sessionDir.path);\r\n\r\n    try {\r\n      const attachments = await generatePeriodicPostCompactionAttachments(session);\r\n      expect(getEditedFilePaths(attachments)).toEqual([\"/tmp/recent.ts\", \"/tmp/stale.ts\"]);\r\n    } finally {\r\n      session.dispose();\r\n    }\r\n  });\r\n});\r\n"]}