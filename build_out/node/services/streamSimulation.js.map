{"version":3,"file":"streamSimulation.js","sourceRoot":"","sources":["../../../src/node/services/streamSimulation.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Stream simulation: synthetic stream event sequences for special early-return conditions.\r\n *\r\n * Extracted from `streamMessage()` — these functions simulate the full stream\r\n * lifecycle (start → delta → end/error) without calling an AI provider.\r\n *\r\n * Used for:\r\n * - `forceContextLimitError`: OpenAI SDK testing of context-exceeded handling\r\n * - `simulateToolPolicyNoop`: OpenAI SDK testing of tool-policy-disabled handling\r\n */\r\n\r\nimport type { MuxMessage, MuxTextPart } from \"@/common/types/message\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\nimport type { ThinkingLevel } from \"@/common/types/thinking\";\r\nimport type { StreamDeltaEvent, StreamEndEvent, StreamStartEvent } from \"@/common/types/stream\";\r\nimport type { ToolPolicy } from \"@/common/utils/tools/toolPolicy\";\r\nimport type { HistoryService } from \"./historyService\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport { createErrorEvent } from \"./utils/sendMessageError\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Shared context for both simulation paths\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Common parameters shared by all simulated stream scenarios. */\r\nexport interface SimulationContext {\r\n  workspaceId: string;\r\n  assistantMessageId: string;\r\n  canonicalModelString: string;\r\n  routedThroughGateway: boolean;\r\n  historySequence: number;\r\n  systemMessageTokens: number;\r\n  effectiveAgentId: string;\r\n  effectiveMode: \"plan\" | \"exec\" | \"compact\";\r\n  effectiveThinkingLevel: ThinkingLevel;\r\n  /** Emit a typed stream event (stream-start, stream-delta, stream-end, error). */\r\n  emit: (event: string, data: unknown) => void;\r\n}\r\n\r\n/** Build the common StreamStartEvent used by both simulation paths. */\r\nfunction createSimulatedStreamStart(ctx: SimulationContext): StreamStartEvent {\r\n  return {\r\n    type: \"stream-start\",\r\n    workspaceId: ctx.workspaceId,\r\n    messageId: ctx.assistantMessageId,\r\n    model: ctx.canonicalModelString,\r\n    routedThroughGateway: ctx.routedThroughGateway,\r\n    historySequence: ctx.historySequence,\r\n    startTime: Date.now(),\r\n    agentId: ctx.effectiveAgentId,\r\n    mode: ctx.effectiveMode,\r\n    thinkingLevel: ctx.effectiveThinkingLevel,\r\n  };\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// forceContextLimitError simulation\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Simulate a context-length-exceeded error without hitting the provider.\r\n *\r\n * Writes an error partial, emits stream-start + error events, then returns.\r\n * Used by the OpenAI SDK `forceContextLimitError` provider option.\r\n */\r\nexport async function simulateContextLimitError(\r\n  ctx: SimulationContext,\r\n  partialService: PartialService\r\n): Promise<void> {\r\n  const errorMessage =\r\n    \"Context length exceeded: the conversation is too long to send to this OpenAI model. Please shorten the history and try again.\";\r\n\r\n  const errorPartialMessage: MuxMessage = {\r\n    id: ctx.assistantMessageId,\r\n    role: \"assistant\",\r\n    metadata: {\r\n      historySequence: ctx.historySequence,\r\n      timestamp: Date.now(),\r\n      model: ctx.canonicalModelString,\r\n      routedThroughGateway: ctx.routedThroughGateway,\r\n      systemMessageTokens: ctx.systemMessageTokens,\r\n      agentId: ctx.effectiveAgentId,\r\n      thinkingLevel: ctx.effectiveThinkingLevel,\r\n      partial: true,\r\n      error: errorMessage,\r\n      errorType: \"context_exceeded\",\r\n    },\r\n    parts: [],\r\n  };\r\n\r\n  await partialService.writePartial(ctx.workspaceId, errorPartialMessage);\r\n\r\n  ctx.emit(\"stream-start\", createSimulatedStreamStart(ctx));\r\n  ctx.emit(\r\n    \"error\",\r\n    createErrorEvent(ctx.workspaceId, {\r\n      messageId: ctx.assistantMessageId,\r\n      error: errorMessage,\r\n      errorType: \"context_exceeded\",\r\n    })\r\n  );\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// simulateToolPolicyNoop simulation\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Simulate a full stream lifecycle for a tool-policy-disabled noop response.\r\n *\r\n * Emits stream-start → stream-delta → stream-end, then updates history.\r\n * Used by the OpenAI SDK `simulateToolPolicyNoop` provider option.\r\n */\r\nexport async function simulateToolPolicyNoop(\r\n  ctx: SimulationContext,\r\n  effectiveToolPolicy: ToolPolicy | undefined,\r\n  historyService: HistoryService,\r\n  partialService: PartialService\r\n): Promise<void> {\r\n  const noopMessage = createMuxMessage(ctx.assistantMessageId, \"assistant\", \"\", {\r\n    timestamp: Date.now(),\r\n    model: ctx.canonicalModelString,\r\n    routedThroughGateway: ctx.routedThroughGateway,\r\n    systemMessageTokens: ctx.systemMessageTokens,\r\n    agentId: ctx.effectiveAgentId,\r\n    thinkingLevel: ctx.effectiveThinkingLevel,\r\n    toolPolicy: effectiveToolPolicy,\r\n  });\r\n\r\n  const parts: StreamEndEvent[\"parts\"] = [\r\n    {\r\n      type: \"text\",\r\n      text: \"Tool execution skipped because the requested tool is disabled by policy.\",\r\n    },\r\n  ];\r\n\r\n  ctx.emit(\"stream-start\", createSimulatedStreamStart(ctx));\r\n\r\n  const textParts = parts.filter((part): part is MuxTextPart => part.type === \"text\");\r\n  if (textParts.length === 0) {\r\n    throw new Error(\"simulateToolPolicyNoop requires at least one text part\");\r\n  }\r\n\r\n  for (const textPart of textParts) {\r\n    if (textPart.text.length === 0) {\r\n      continue;\r\n    }\r\n\r\n    const streamDeltaEvent: StreamDeltaEvent = {\r\n      type: \"stream-delta\",\r\n      workspaceId: ctx.workspaceId,\r\n      messageId: ctx.assistantMessageId,\r\n      delta: textPart.text,\r\n      tokens: 0, // Mock scenario — actual tokenization happens in streamManager\r\n      timestamp: Date.now(),\r\n    };\r\n    ctx.emit(\"stream-delta\", streamDeltaEvent);\r\n  }\r\n\r\n  const streamEndEvent: StreamEndEvent = {\r\n    type: \"stream-end\",\r\n    workspaceId: ctx.workspaceId,\r\n    messageId: ctx.assistantMessageId,\r\n    metadata: {\r\n      model: ctx.canonicalModelString,\r\n      thinkingLevel: ctx.effectiveThinkingLevel,\r\n      routedThroughGateway: ctx.routedThroughGateway,\r\n      systemMessageTokens: ctx.systemMessageTokens,\r\n    },\r\n    parts,\r\n  };\r\n  ctx.emit(\"stream-end\", streamEndEvent);\r\n\r\n  const finalAssistantMessage: MuxMessage = {\r\n    ...noopMessage,\r\n    metadata: {\r\n      ...noopMessage.metadata,\r\n      historySequence: ctx.historySequence,\r\n    },\r\n    parts,\r\n  };\r\n\r\n  await partialService.deletePartial(ctx.workspaceId);\r\n  await historyService.updateHistory(ctx.workspaceId, finalAssistantMessage);\r\n}\r\n"]}