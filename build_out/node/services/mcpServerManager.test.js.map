{"version":3,"file":"mcpServerManager.test.js","sourceRoot":"","sources":["../../../src/node/services/mcpServerManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { afterEach, beforeEach, describe, expect, mock, test } from \"bun:test\";\nimport { createServer } from \"http\";\n\nimport { MCPServerManager } from \"./mcpServerManager\";\nimport type { MCPConfigService } from \"./mcpConfigService\";\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport type { Tool } from \"ai\";\n\ninterface MCPServerManagerTestAccess {\n  workspaceServers: Map<string, unknown>;\n  cleanupIdleServers: () => void;\n  startServers: (...args: unknown[]) => Promise<Map<string, unknown>>;\n}\n\ndescribe(\"MCPServerManager\", () => {\n  let configService: {\n    listServers: ReturnType<typeof mock>;\n  };\n\n  let manager: MCPServerManager;\n  let access: MCPServerManagerTestAccess;\n\n  beforeEach(() => {\n    configService = {\n      listServers: mock(() => Promise.resolve({})),\n    };\n\n    manager = new MCPServerManager(configService as unknown as MCPConfigService);\n    access = manager as unknown as MCPServerManagerTestAccess;\n  });\n\n  afterEach(() => {\n    manager.dispose();\n  });\n\n  test(\"cleanupIdleServers stops idle servers when workspace is not leased\", () => {\n    const workspaceId = \"ws-idle\";\n\n    const close = mock(() => Promise.resolve(undefined));\n\n    const instance = {\n      name: \"server\",\n      resolvedTransport: \"stdio\",\n      autoFallbackUsed: false,\n      tools: {},\n      isClosed: false,\n      close,\n    };\n\n    const entry = {\n      configSignature: \"sig\",\n      instances: new Map([[\"server\", instance]]),\n      stats: {\n        enabledServerCount: 1,\n        startedServerCount: 1,\n        failedServerCount: 0,\n        autoFallbackCount: 0,\n        hasStdio: true,\n        hasHttp: false,\n        hasSse: false,\n        transportMode: \"stdio_only\",\n      },\n      lastActivity: Date.now() - 11 * 60_000,\n    };\n\n    access.workspaceServers.set(workspaceId, entry);\n\n    access.cleanupIdleServers();\n\n    expect(access.workspaceServers.has(workspaceId)).toBe(false);\n    expect(close).toHaveBeenCalledTimes(1);\n  });\n\n  test(\"cleanupIdleServers does not stop idle servers when workspace is leased\", () => {\n    const workspaceId = \"ws-leased\";\n\n    const close = mock(() => Promise.resolve(undefined));\n\n    const instance = {\n      name: \"server\",\n      resolvedTransport: \"stdio\",\n      autoFallbackUsed: false,\n      tools: {},\n      isClosed: false,\n      close,\n    };\n\n    const entry = {\n      configSignature: \"sig\",\n      instances: new Map([[\"server\", instance]]),\n      stats: {\n        enabledServerCount: 1,\n        startedServerCount: 1,\n        failedServerCount: 0,\n        autoFallbackCount: 0,\n        hasStdio: true,\n        hasHttp: false,\n        hasSse: false,\n        transportMode: \"stdio_only\",\n      },\n      lastActivity: Date.now() - 11 * 60_000,\n    };\n\n    access.workspaceServers.set(workspaceId, entry);\n    manager.acquireLease(workspaceId);\n\n    // Ensure the workspace still looks idle even after acquireLease() updates activity.\n    (entry as { lastActivity: number }).lastActivity = Date.now() - 11 * 60_000;\n\n    access.cleanupIdleServers();\n\n    expect(access.workspaceServers.has(workspaceId)).toBe(true);\n    expect(close).toHaveBeenCalledTimes(0);\n  });\n\n  test(\"getToolsForWorkspace defers restarts while leased and applies them on next request\", async () => {\n    const workspaceId = \"ws-defer\";\n    const projectPath = \"/tmp/project\";\n    const workspacePath = \"/tmp/workspace\";\n\n    let command = \"cmd-1\";\n    configService.listServers = mock(() =>\n      Promise.resolve({\n        server: { transport: \"stdio\", command, disabled: false },\n      })\n    );\n\n    const close = mock(() => Promise.resolve(undefined));\n\n    const dummyTool = {\n      execute: mock(() => Promise.resolve({ ok: true })),\n    } as unknown as Tool;\n\n    const startServersMock = mock(() =>\n      Promise.resolve(\n        new Map([\n          [\n            \"server\",\n            {\n              name: \"server\",\n              resolvedTransport: \"stdio\",\n              autoFallbackUsed: false,\n              tools: { tool: dummyTool },\n              isClosed: false,\n              close,\n            },\n          ],\n        ])\n      )\n    );\n\n    access.startServers = startServersMock;\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    manager.acquireLease(workspaceId);\n\n    // Change signature while leased.\n    command = \"cmd-2\";\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    expect(startServersMock).toHaveBeenCalledTimes(1);\n\n    manager.releaseLease(workspaceId);\n\n    // No automatic restart on lease release (avoids closing clients out from under a\n    // subsequent stream that already captured the tool objects).\n    expect(access.workspaceServers.has(workspaceId)).toBe(true);\n    expect(close).toHaveBeenCalledTimes(0);\n\n    // Next request (no lease) applies the pending restart.\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    expect(startServersMock).toHaveBeenCalledTimes(2);\n    expect(close).toHaveBeenCalledTimes(1);\n  });\n\n  test(\"getToolsForWorkspace restarts when cached instances are marked closed\", async () => {\n    const workspaceId = \"ws-closed\";\n    const projectPath = \"/tmp/project\";\n    const workspacePath = \"/tmp/workspace\";\n\n    configService.listServers = mock(() =>\n      Promise.resolve({\n        server: { transport: \"stdio\", command: \"cmd\", disabled: false },\n      })\n    );\n\n    const close1 = mock(() => Promise.resolve(undefined));\n    const close2 = mock(() => Promise.resolve(undefined));\n\n    let startCount = 0;\n    const startServersMock = mock(() => {\n      startCount += 1;\n      return Promise.resolve(\n        new Map([\n          [\n            \"server\",\n            {\n              name: \"server\",\n              resolvedTransport: \"stdio\",\n              autoFallbackUsed: false,\n              tools: {},\n              isClosed: false,\n              close: startCount === 1 ? close1 : close2,\n            },\n          ],\n        ])\n      );\n    });\n\n    access.startServers = startServersMock;\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    // Simulate an active stream lease.\n    manager.acquireLease(workspaceId);\n\n    const cached = access.workspaceServers.get(workspaceId) as {\n      instances: Map<string, { isClosed: boolean }>;\n    };\n\n    const instance = cached.instances.get(\"server\");\n    expect(instance).toBeTruthy();\n    if (instance) {\n      instance.isClosed = true;\n    }\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    expect(startServersMock).toHaveBeenCalledTimes(2);\n    expect(close1).toHaveBeenCalledTimes(1);\n  });\n\n  test(\"getToolsForWorkspace does not close healthy instances when restarting closed ones while leased\", async () => {\n    const workspaceId = \"ws-closed-partial\";\n    const projectPath = \"/tmp/project\";\n    const workspacePath = \"/tmp/workspace\";\n\n    configService.listServers = mock(() =>\n      Promise.resolve({\n        serverA: { transport: \"stdio\", command: \"cmd-a\", disabled: false },\n        serverB: { transport: \"stdio\", command: \"cmd-b\", disabled: false },\n      })\n    );\n\n    const closeA1 = mock(() => Promise.resolve(undefined));\n    const closeA2 = mock(() => Promise.resolve(undefined));\n    const closeB1 = mock(() => Promise.resolve(undefined));\n\n    let startCount = 0;\n    const startServersMock = mock(() => {\n      startCount += 1;\n\n      if (startCount === 1) {\n        return Promise.resolve(\n          new Map([\n            [\n              \"serverA\",\n              {\n                name: \"serverA\",\n                resolvedTransport: \"stdio\",\n                autoFallbackUsed: false,\n                tools: {},\n                isClosed: false,\n                close: closeA1,\n              },\n            ],\n            [\n              \"serverB\",\n              {\n                name: \"serverB\",\n                resolvedTransport: \"stdio\",\n                autoFallbackUsed: false,\n                tools: {},\n                isClosed: false,\n                close: closeB1,\n              },\n            ],\n          ])\n        );\n      }\n\n      return Promise.resolve(\n        new Map([\n          [\n            \"serverA\",\n            {\n              name: \"serverA\",\n              resolvedTransport: \"stdio\",\n              autoFallbackUsed: false,\n              tools: {},\n              isClosed: false,\n              close: closeA2,\n            },\n          ],\n        ])\n      );\n    });\n\n    access.startServers = startServersMock;\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    // Simulate an active stream lease.\n    manager.acquireLease(workspaceId);\n\n    const cached = access.workspaceServers.get(workspaceId) as {\n      instances: Map<string, { isClosed: boolean }>;\n    };\n\n    const instanceA = cached.instances.get(\"serverA\");\n    expect(instanceA).toBeTruthy();\n    if (instanceA) {\n      instanceA.isClosed = true;\n    }\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    // Restart should only close the dead instance.\n    expect(closeA1).toHaveBeenCalledTimes(1);\n    expect(closeB1).toHaveBeenCalledTimes(0);\n  });\n\n  test(\"getToolsForWorkspace does not return tools from newly-disabled servers while leased\", async () => {\n    const workspaceId = \"ws-disable-while-leased\";\n    const projectPath = \"/tmp/project\";\n    const workspacePath = \"/tmp/workspace\";\n\n    configService.listServers = mock(() =>\n      Promise.resolve({\n        serverA: { transport: \"stdio\", command: \"cmd-a\", disabled: false },\n        serverB: { transport: \"stdio\", command: \"cmd-b\", disabled: false },\n      })\n    );\n\n    const dummyToolA = { execute: mock(() => Promise.resolve({ ok: true })) } as unknown as Tool;\n    const dummyToolB = { execute: mock(() => Promise.resolve({ ok: true })) } as unknown as Tool;\n\n    const startServersMock = mock(() =>\n      Promise.resolve(\n        new Map([\n          [\n            \"serverA\",\n            {\n              name: \"serverA\",\n              resolvedTransport: \"stdio\",\n              autoFallbackUsed: false,\n              tools: { tool: dummyToolA },\n              isClosed: false,\n              close: mock(() => Promise.resolve(undefined)),\n            },\n          ],\n          [\n            \"serverB\",\n            {\n              name: \"serverB\",\n              resolvedTransport: \"stdio\",\n              autoFallbackUsed: false,\n              tools: { tool: dummyToolB },\n              isClosed: false,\n              close: mock(() => Promise.resolve(undefined)),\n            },\n          ],\n        ])\n      )\n    );\n\n    access.startServers = startServersMock;\n\n    await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n    });\n\n    manager.acquireLease(workspaceId);\n\n    const toolsResult = await manager.getToolsForWorkspace({\n      workspaceId,\n      projectPath,\n      runtime: {} as unknown as Runtime,\n      workspacePath,\n      overrides: {\n        disabledServers: [\"serverB\"],\n      },\n    });\n\n    // Tool names are normalized to provider-safe keys (lowercase + underscore-delimited).\n    expect(Object.keys(toolsResult.tools)).toContain(\"servera_tool\");\n    expect(Object.keys(toolsResult.tools)).not.toContain(\"serverb_tool\");\n  });\n\n  test(\"test() includes oauthChallenge when server responds 401 + WWW-Authenticate Bearer\", async () => {\n    let baseUrl = \"\";\n    let resourceMetadataUrl = \"\";\n\n    const server = createServer((_req, res) => {\n      res.statusCode = 401;\n      res.setHeader(\n        \"WWW-Authenticate\",\n        `Bearer scope=\"mcp.read\" resource_metadata=\"${resourceMetadataUrl}\"`\n      );\n      res.end(\"Unauthorized\");\n    });\n\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\n\n    try {\n      const address = server.address();\n      if (!address || typeof address === \"string\") {\n        throw new Error(\"Failed to bind OAuth challenge test server\");\n      }\n\n      baseUrl = `http://127.0.0.1:${address.port}/`;\n      resourceMetadataUrl = `${baseUrl}.well-known/oauth-protected-resource`;\n\n      const result = await manager.test({\n        projectPath: \"/tmp/project\",\n        transport: \"http\",\n        url: baseUrl,\n      });\n\n      expect(result.success).toBe(false);\n      if (result.success) {\n        throw new Error(\"Expected test() to fail\");\n      }\n\n      expect(result.oauthChallenge).toEqual({\n        scope: \"mcp.read\",\n        resourceMetadataUrl,\n      });\n    } finally {\n      await new Promise<void>((resolve) => server.close(() => resolve()));\n    }\n  });\n});\n"]}