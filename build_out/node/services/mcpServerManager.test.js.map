{"version":3,"file":"mcpServerManager.test.js","sourceRoot":"","sources":["../../../src/node/services/mcpServerManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { afterEach, beforeEach, describe, expect, mock, test } from \"bun:test\";\r\nimport { createServer } from \"http\";\r\n\r\nimport { MCPServerManager } from \"./mcpServerManager\";\r\nimport type { MCPConfigService } from \"./mcpConfigService\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport type { Tool } from \"ai\";\r\n\r\ninterface MCPServerManagerTestAccess {\r\n  workspaceServers: Map<string, unknown>;\r\n  cleanupIdleServers: () => void;\r\n  startServers: (...args: unknown[]) => Promise<Map<string, unknown>>;\r\n}\r\n\r\ndescribe(\"MCPServerManager\", () => {\r\n  let configService: {\r\n    listServers: ReturnType<typeof mock>;\r\n  };\r\n\r\n  let manager: MCPServerManager;\r\n  let access: MCPServerManagerTestAccess;\r\n\r\n  beforeEach(() => {\r\n    configService = {\r\n      listServers: mock(() => Promise.resolve({})),\r\n    };\r\n\r\n    manager = new MCPServerManager(configService as unknown as MCPConfigService);\r\n    access = manager as unknown as MCPServerManagerTestAccess;\r\n  });\r\n\r\n  afterEach(() => {\r\n    manager.dispose();\r\n  });\r\n\r\n  test(\"cleanupIdleServers stops idle servers when workspace is not leased\", () => {\r\n    const workspaceId = \"ws-idle\";\r\n\r\n    const close = mock(() => Promise.resolve(undefined));\r\n\r\n    const instance = {\r\n      name: \"server\",\r\n      resolvedTransport: \"stdio\",\r\n      autoFallbackUsed: false,\r\n      tools: {},\r\n      isClosed: false,\r\n      close,\r\n    };\r\n\r\n    const entry = {\r\n      configSignature: \"sig\",\r\n      instances: new Map([[\"server\", instance]]),\r\n      stats: {\r\n        enabledServerCount: 1,\r\n        startedServerCount: 1,\r\n        failedServerCount: 0,\r\n        autoFallbackCount: 0,\r\n        hasStdio: true,\r\n        hasHttp: false,\r\n        hasSse: false,\r\n        transportMode: \"stdio_only\",\r\n      },\r\n      lastActivity: Date.now() - 11 * 60_000,\r\n    };\r\n\r\n    access.workspaceServers.set(workspaceId, entry);\r\n\r\n    access.cleanupIdleServers();\r\n\r\n    expect(access.workspaceServers.has(workspaceId)).toBe(false);\r\n    expect(close).toHaveBeenCalledTimes(1);\r\n  });\r\n\r\n  test(\"cleanupIdleServers does not stop idle servers when workspace is leased\", () => {\r\n    const workspaceId = \"ws-leased\";\r\n\r\n    const close = mock(() => Promise.resolve(undefined));\r\n\r\n    const instance = {\r\n      name: \"server\",\r\n      resolvedTransport: \"stdio\",\r\n      autoFallbackUsed: false,\r\n      tools: {},\r\n      isClosed: false,\r\n      close,\r\n    };\r\n\r\n    const entry = {\r\n      configSignature: \"sig\",\r\n      instances: new Map([[\"server\", instance]]),\r\n      stats: {\r\n        enabledServerCount: 1,\r\n        startedServerCount: 1,\r\n        failedServerCount: 0,\r\n        autoFallbackCount: 0,\r\n        hasStdio: true,\r\n        hasHttp: false,\r\n        hasSse: false,\r\n        transportMode: \"stdio_only\",\r\n      },\r\n      lastActivity: Date.now() - 11 * 60_000,\r\n    };\r\n\r\n    access.workspaceServers.set(workspaceId, entry);\r\n    manager.acquireLease(workspaceId);\r\n\r\n    // Ensure the workspace still looks idle even after acquireLease() updates activity.\r\n    (entry as { lastActivity: number }).lastActivity = Date.now() - 11 * 60_000;\r\n\r\n    access.cleanupIdleServers();\r\n\r\n    expect(access.workspaceServers.has(workspaceId)).toBe(true);\r\n    expect(close).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  test(\"getToolsForWorkspace defers restarts while leased and applies them on next request\", async () => {\r\n    const workspaceId = \"ws-defer\";\r\n    const projectPath = \"/tmp/project\";\r\n    const workspacePath = \"/tmp/workspace\";\r\n\r\n    let command = \"cmd-1\";\r\n    configService.listServers = mock(() =>\r\n      Promise.resolve({\r\n        server: { transport: \"stdio\", command, disabled: false },\r\n      })\r\n    );\r\n\r\n    const close = mock(() => Promise.resolve(undefined));\r\n\r\n    const dummyTool = {\r\n      execute: mock(() => Promise.resolve({ ok: true })),\r\n    } as unknown as Tool;\r\n\r\n    const startServersMock = mock(() =>\r\n      Promise.resolve(\r\n        new Map([\r\n          [\r\n            \"server\",\r\n            {\r\n              name: \"server\",\r\n              resolvedTransport: \"stdio\",\r\n              autoFallbackUsed: false,\r\n              tools: { tool: dummyTool },\r\n              isClosed: false,\r\n              close,\r\n            },\r\n          ],\r\n        ])\r\n      )\r\n    );\r\n\r\n    access.startServers = startServersMock;\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    manager.acquireLease(workspaceId);\r\n\r\n    // Change signature while leased.\r\n    command = \"cmd-2\";\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    expect(startServersMock).toHaveBeenCalledTimes(1);\r\n\r\n    manager.releaseLease(workspaceId);\r\n\r\n    // No automatic restart on lease release (avoids closing clients out from under a\r\n    // subsequent stream that already captured the tool objects).\r\n    expect(access.workspaceServers.has(workspaceId)).toBe(true);\r\n    expect(close).toHaveBeenCalledTimes(0);\r\n\r\n    // Next request (no lease) applies the pending restart.\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    expect(startServersMock).toHaveBeenCalledTimes(2);\r\n    expect(close).toHaveBeenCalledTimes(1);\r\n  });\r\n\r\n  test(\"getToolsForWorkspace restarts when cached instances are marked closed\", async () => {\r\n    const workspaceId = \"ws-closed\";\r\n    const projectPath = \"/tmp/project\";\r\n    const workspacePath = \"/tmp/workspace\";\r\n\r\n    configService.listServers = mock(() =>\r\n      Promise.resolve({\r\n        server: { transport: \"stdio\", command: \"cmd\", disabled: false },\r\n      })\r\n    );\r\n\r\n    const close1 = mock(() => Promise.resolve(undefined));\r\n    const close2 = mock(() => Promise.resolve(undefined));\r\n\r\n    let startCount = 0;\r\n    const startServersMock = mock(() => {\r\n      startCount += 1;\r\n      return Promise.resolve(\r\n        new Map([\r\n          [\r\n            \"server\",\r\n            {\r\n              name: \"server\",\r\n              resolvedTransport: \"stdio\",\r\n              autoFallbackUsed: false,\r\n              tools: {},\r\n              isClosed: false,\r\n              close: startCount === 1 ? close1 : close2,\r\n            },\r\n          ],\r\n        ])\r\n      );\r\n    });\r\n\r\n    access.startServers = startServersMock;\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    // Simulate an active stream lease.\r\n    manager.acquireLease(workspaceId);\r\n\r\n    const cached = access.workspaceServers.get(workspaceId) as {\r\n      instances: Map<string, { isClosed: boolean }>;\r\n    };\r\n\r\n    const instance = cached.instances.get(\"server\");\r\n    expect(instance).toBeTruthy();\r\n    if (instance) {\r\n      instance.isClosed = true;\r\n    }\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    expect(startServersMock).toHaveBeenCalledTimes(2);\r\n    expect(close1).toHaveBeenCalledTimes(1);\r\n  });\r\n\r\n  test(\"getToolsForWorkspace does not close healthy instances when restarting closed ones while leased\", async () => {\r\n    const workspaceId = \"ws-closed-partial\";\r\n    const projectPath = \"/tmp/project\";\r\n    const workspacePath = \"/tmp/workspace\";\r\n\r\n    configService.listServers = mock(() =>\r\n      Promise.resolve({\r\n        serverA: { transport: \"stdio\", command: \"cmd-a\", disabled: false },\r\n        serverB: { transport: \"stdio\", command: \"cmd-b\", disabled: false },\r\n      })\r\n    );\r\n\r\n    const closeA1 = mock(() => Promise.resolve(undefined));\r\n    const closeA2 = mock(() => Promise.resolve(undefined));\r\n    const closeB1 = mock(() => Promise.resolve(undefined));\r\n\r\n    let startCount = 0;\r\n    const startServersMock = mock(() => {\r\n      startCount += 1;\r\n\r\n      if (startCount === 1) {\r\n        return Promise.resolve(\r\n          new Map([\r\n            [\r\n              \"serverA\",\r\n              {\r\n                name: \"serverA\",\r\n                resolvedTransport: \"stdio\",\r\n                autoFallbackUsed: false,\r\n                tools: {},\r\n                isClosed: false,\r\n                close: closeA1,\r\n              },\r\n            ],\r\n            [\r\n              \"serverB\",\r\n              {\r\n                name: \"serverB\",\r\n                resolvedTransport: \"stdio\",\r\n                autoFallbackUsed: false,\r\n                tools: {},\r\n                isClosed: false,\r\n                close: closeB1,\r\n              },\r\n            ],\r\n          ])\r\n        );\r\n      }\r\n\r\n      return Promise.resolve(\r\n        new Map([\r\n          [\r\n            \"serverA\",\r\n            {\r\n              name: \"serverA\",\r\n              resolvedTransport: \"stdio\",\r\n              autoFallbackUsed: false,\r\n              tools: {},\r\n              isClosed: false,\r\n              close: closeA2,\r\n            },\r\n          ],\r\n        ])\r\n      );\r\n    });\r\n\r\n    access.startServers = startServersMock;\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    // Simulate an active stream lease.\r\n    manager.acquireLease(workspaceId);\r\n\r\n    const cached = access.workspaceServers.get(workspaceId) as {\r\n      instances: Map<string, { isClosed: boolean }>;\r\n    };\r\n\r\n    const instanceA = cached.instances.get(\"serverA\");\r\n    expect(instanceA).toBeTruthy();\r\n    if (instanceA) {\r\n      instanceA.isClosed = true;\r\n    }\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    // Restart should only close the dead instance.\r\n    expect(closeA1).toHaveBeenCalledTimes(1);\r\n    expect(closeB1).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  test(\"getToolsForWorkspace does not return tools from newly-disabled servers while leased\", async () => {\r\n    const workspaceId = \"ws-disable-while-leased\";\r\n    const projectPath = \"/tmp/project\";\r\n    const workspacePath = \"/tmp/workspace\";\r\n\r\n    configService.listServers = mock(() =>\r\n      Promise.resolve({\r\n        serverA: { transport: \"stdio\", command: \"cmd-a\", disabled: false },\r\n        serverB: { transport: \"stdio\", command: \"cmd-b\", disabled: false },\r\n      })\r\n    );\r\n\r\n    const dummyToolA = { execute: mock(() => Promise.resolve({ ok: true })) } as unknown as Tool;\r\n    const dummyToolB = { execute: mock(() => Promise.resolve({ ok: true })) } as unknown as Tool;\r\n\r\n    const startServersMock = mock(() =>\r\n      Promise.resolve(\r\n        new Map([\r\n          [\r\n            \"serverA\",\r\n            {\r\n              name: \"serverA\",\r\n              resolvedTransport: \"stdio\",\r\n              autoFallbackUsed: false,\r\n              tools: { tool: dummyToolA },\r\n              isClosed: false,\r\n              close: mock(() => Promise.resolve(undefined)),\r\n            },\r\n          ],\r\n          [\r\n            \"serverB\",\r\n            {\r\n              name: \"serverB\",\r\n              resolvedTransport: \"stdio\",\r\n              autoFallbackUsed: false,\r\n              tools: { tool: dummyToolB },\r\n              isClosed: false,\r\n              close: mock(() => Promise.resolve(undefined)),\r\n            },\r\n          ],\r\n        ])\r\n      )\r\n    );\r\n\r\n    access.startServers = startServersMock;\r\n\r\n    await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    manager.acquireLease(workspaceId);\r\n\r\n    const toolsResult = await manager.getToolsForWorkspace({\r\n      workspaceId,\r\n      projectPath,\r\n      runtime: {} as unknown as Runtime,\r\n      workspacePath,\r\n      overrides: {\r\n        disabledServers: [\"serverB\"],\r\n      },\r\n    });\r\n\r\n    // Tool names are normalized to provider-safe keys (lowercase + underscore-delimited).\r\n    expect(Object.keys(toolsResult.tools)).toContain(\"servera_tool\");\r\n    expect(Object.keys(toolsResult.tools)).not.toContain(\"serverb_tool\");\r\n  });\r\n\r\n  test(\"test() includes oauthChallenge when server responds 401 + WWW-Authenticate Bearer\", async () => {\r\n    let baseUrl = \"\";\r\n    let resourceMetadataUrl = \"\";\r\n\r\n    const server = createServer((_req, res) => {\r\n      res.statusCode = 401;\r\n      res.setHeader(\r\n        \"WWW-Authenticate\",\r\n        `Bearer scope=\"mcp.read\" resource_metadata=\"${resourceMetadataUrl}\"`\r\n      );\r\n      res.end(\"Unauthorized\");\r\n    });\r\n\r\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\r\n\r\n    try {\r\n      const address = server.address();\r\n      if (!address || typeof address === \"string\") {\r\n        throw new Error(\"Failed to bind OAuth challenge test server\");\r\n      }\r\n\r\n      baseUrl = `http://127.0.0.1:${address.port}/`;\r\n      resourceMetadataUrl = `${baseUrl}.well-known/oauth-protected-resource`;\r\n\r\n      const result = await manager.test({\r\n        projectPath: \"/tmp/project\",\r\n        transport: \"http\",\r\n        url: baseUrl,\r\n      });\r\n\r\n      expect(result.success).toBe(false);\r\n      if (result.success) {\r\n        throw new Error(\"Expected test() to fail\");\r\n      }\r\n\r\n      expect(result.oauthChallenge).toEqual({\r\n        scope: \"mcp.read\",\r\n        resourceMetadataUrl,\r\n      });\r\n    } finally {\r\n      await new Promise<void>((resolve) => server.close(() => resolve()));\r\n    }\r\n  });\r\n});\r\n"]}