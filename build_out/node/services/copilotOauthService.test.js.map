{"version":3,"file":"copilotOauthService.test.js","sourceRoot":"","sources":["../../../src/node/services/copilotOauthService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\n\nimport type { Result } from \"@/common/types/result\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport type { ProviderService } from \"@/node/services/providerService\";\nimport type { WindowService } from \"@/node/services/windowService\";\nimport { CopilotOauthService } from \"./copilotOauthService\";\n\n// ---------------------------------------------------------------------------\n// Helpers\n// ---------------------------------------------------------------------------\n\n/** Build a mock fetch Response with JSON body. */\nfunction jsonResponse(body: Record<string, unknown>, status = 200): Response {\n  return new Response(JSON.stringify(body), {\n    status,\n    headers: { \"Content-Type\": \"application/json\" },\n  });\n}\n\n/** Standard device code response from GitHub. */\nfunction deviceCodeResponse(overrides?: Record<string, unknown>): Response {\n  return jsonResponse({\n    verification_uri: \"https://github.com/login/device\",\n    user_code: \"ABCD-1234\",\n    device_code: \"dc_test_123\",\n    interval: 0,\n    ...overrides,\n  });\n}\n\n/** Token success response. */\nfunction tokenSuccessResponse(token = \"ghp_test_token\"): Response {\n  return jsonResponse({ access_token: token });\n}\n\n/** Polling \"not yet\" response. */\nfunction authorizationPendingResponse(): Response {\n  return jsonResponse({ error: \"authorization_pending\" });\n}\n\n/** Models list response from Copilot API. */\nfunction modelsResponse(models: string[] = [\"gpt-5\", \"claude-sonnet-4\"]): Response {\n  return jsonResponse({ data: models.map((id) => ({ id })) });\n}\n\n// Helper to mock globalThis.fetch without needing the `preconnect` property.\nfunction mockFetch(\n  fn: (input: string | URL, init?: RequestInit) => Response | Promise<Response>\n): void {\n  globalThis.fetch = Object.assign(fn, {\n    preconnect: (_url: string | URL) => {\n      // no-op in tests\n    },\n  }) as typeof fetch;\n}\n\n// ---------------------------------------------------------------------------\n// Mock dependencies\n// ---------------------------------------------------------------------------\n\ninterface MockDeps {\n  setConfigCalls: Array<{ provider: string; keyPath: string[]; value: string }>;\n  setConfigResult: Result<void, string>;\n  setModelsCalls: Array<{ provider: string; models: string[] }>;\n  setModelsResult: Result<void, string>;\n  focusCalls: number;\n}\n\nfunction createMockDeps(): MockDeps {\n  return {\n    setConfigCalls: [],\n    setConfigResult: Ok(undefined),\n    setModelsCalls: [],\n    setModelsResult: Ok(undefined),\n    focusCalls: 0,\n  };\n}\n\nfunction createMockProviderService(\n  deps: MockDeps\n): Pick<ProviderService, \"setConfig\" | \"setModels\"> {\n  return {\n    setConfig: (provider: string, keyPath: string[], value: string): Result<void, string> => {\n      deps.setConfigCalls.push({ provider, keyPath, value });\n      return deps.setConfigResult;\n    },\n    setModels: (provider: string, models: string[]): Result<void, string> => {\n      deps.setModelsCalls.push({ provider, models });\n      return deps.setModelsResult;\n    },\n  };\n}\n\nfunction createMockWindowService(deps: MockDeps): Pick<WindowService, \"focusMainWindow\"> {\n  return {\n    focusMainWindow: () => {\n      deps.focusCalls++;\n    },\n  };\n}\n\nfunction createService(deps: MockDeps): CopilotOauthService {\n  return new CopilotOauthService(\n    createMockProviderService(deps) as ProviderService,\n    createMockWindowService(deps) as WindowService\n  );\n}\n\n// ---------------------------------------------------------------------------\n// Tests\n// ---------------------------------------------------------------------------\n\ndescribe(\"CopilotOauthService\", () => {\n  let deps: MockDeps;\n  let service: CopilotOauthService;\n  const originalFetch = globalThis.fetch;\n\n  beforeEach(() => {\n    deps = createMockDeps();\n    service = createService(deps);\n  });\n\n  afterEach(() => {\n    globalThis.fetch = originalFetch;\n    service.dispose();\n  });\n\n  // -------------------------------------------------------------------------\n  // startDeviceFlow\n  // -------------------------------------------------------------------------\n\n  describe(\"startDeviceFlow\", () => {\n    it(\"returns flowId, verificationUri, and userCode on success\", async () => {\n      mockFetch(() => deviceCodeResponse());\n\n      const result = await service.startDeviceFlow();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.flowId).toBeTruthy();\n        expect(result.data.verificationUri).toBe(\"https://github.com/login/device\");\n        expect(result.data.userCode).toBe(\"ABCD-1234\");\n      }\n    });\n\n    it(\"sends request to github.com device code endpoint\", async () => {\n      let capturedUrl = \"\";\n      mockFetch((input) => {\n        capturedUrl = String(input);\n        return deviceCodeResponse();\n      });\n\n      await service.startDeviceFlow();\n      expect(capturedUrl).toBe(\"https://github.com/login/device/code\");\n    });\n\n    it(\"returns Err when fetch response is not ok\", async () => {\n      mockFetch(() => new Response(\"Server Error\", { status: 500 }));\n\n      const result = await service.startDeviceFlow();\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"500\");\n      }\n    });\n\n    it(\"returns Err when fetch throws a network error\", async () => {\n      mockFetch(() => {\n        throw new Error(\"DNS resolution failed\");\n      });\n\n      const result = await service.startDeviceFlow();\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"DNS resolution failed\");\n      }\n    });\n\n    it(\"returns Err when response is missing required fields\", async () => {\n      mockFetch(() => jsonResponse({ verification_uri: \"https://example.com\" }));\n\n      const result = await service.startDeviceFlow();\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"Invalid response\");\n      }\n    });\n\n    it(\"each flow gets a unique flowId\", async () => {\n      mockFetch(() => deviceCodeResponse());\n\n      const first = await service.startDeviceFlow();\n      const second = await service.startDeviceFlow();\n      expect(first.success).toBe(true);\n      expect(second.success).toBe(true);\n      if (first.success && second.success) {\n        expect(first.data.flowId).not.toBe(second.data.flowId);\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Happy path: poll → success\n  // -------------------------------------------------------------------------\n\n  describe(\"happy path: poll → success\", () => {\n    it(\"polls until access_token is returned, then persists it\", async () => {\n      // startDeviceFlow fetch\n      let pollCount = 0;\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return modelsResponse();\n        }\n        // Polling endpoint\n        pollCount++;\n        if (pollCount === 1) {\n          return authorizationPendingResponse();\n        }\n        return tokenSuccessResponse(\"ghp_final_token\");\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 30_000,\n      });\n\n      expect(waitResult.success).toBe(true);\n\n      // Verify token was persisted\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeDefined();\n      expect(apiKeyCall!.value).toBe(\"ghp_final_token\");\n    });\n\n    it(\"calls focusMainWindow after successful auth\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return modelsResponse();\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      await service.waitForDeviceFlow(startResult.data.flowId, { timeoutMs: 10_000 });\n\n      expect(deps.focusCalls).toBe(1);\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // slow_down response\n  // -------------------------------------------------------------------------\n\n  describe(\"slow_down response\", () => {\n    it(\"respects slow_down and eventually succeeds\", async () => {\n      let pollCount = 0;\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return modelsResponse();\n        }\n        pollCount++;\n        if (pollCount === 1) {\n          // slow_down: service should increase interval but continue\n          return jsonResponse({ error: \"slow_down\", interval: 0 });\n        }\n        return tokenSuccessResponse(\"ghp_slow_token\");\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 30_000,\n      });\n\n      expect(waitResult.success).toBe(true);\n\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeDefined();\n      expect(apiKeyCall!.value).toBe(\"ghp_slow_token\");\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Terminal error\n  // -------------------------------------------------------------------------\n\n  describe(\"terminal error\", () => {\n    it(\"resolves with Err on access_denied\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        return jsonResponse({ error: \"access_denied\" });\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n\n      expect(waitResult.success).toBe(false);\n      if (!waitResult.success) {\n        expect(waitResult.error).toContain(\"access_denied\");\n      }\n\n      // Token should NOT have been persisted\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeUndefined();\n    });\n\n    it(\"resolves with Err on expired_token\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        return jsonResponse({ error: \"expired_token\" });\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n\n      expect(waitResult.success).toBe(false);\n      if (!waitResult.success) {\n        expect(waitResult.error).toContain(\"expired_token\");\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Cancellation\n  // -------------------------------------------------------------------------\n\n  describe(\"cancellation\", () => {\n    it(\"resolves waitForDeviceFlow with error when cancelled\", async () => {\n      // Make polling hang indefinitely with authorization_pending\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        return authorizationPendingResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const flowId = startResult.data.flowId;\n\n      // Start waiting (don't await yet)\n      const waitPromise = service.waitForDeviceFlow(flowId, { timeoutMs: 30_000 });\n\n      // Give polling loop a tick to start\n      await new Promise((resolve) => setTimeout(resolve, 10));\n\n      // Cancel the flow\n      service.cancelDeviceFlow(flowId);\n\n      const result = await waitPromise;\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"cancelled\");\n      }\n\n      // Token should NOT have been persisted\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeUndefined();\n    });\n\n    it(\"does not persist token if cancelled mid-request\", async () => {\n      // Control when the polling fetch resolves\n      let resolvePollFetch!: (res: Response) => void;\n\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        // Hang the polling request until we resolve it manually\n        return new Promise<Response>((resolve) => {\n          resolvePollFetch = resolve;\n        });\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const flowId = startResult.data.flowId;\n      const waitPromise = service.waitForDeviceFlow(flowId, { timeoutMs: 30_000 });\n\n      // Give polling loop a tick to start the fetch\n      await new Promise((resolve) => setTimeout(resolve, 10));\n\n      // Cancel while fetch is in-flight\n      service.cancelDeviceFlow(flowId);\n\n      // Now resolve the fetch with a valid token — it should be ignored\n      // because flow.cancelled is checked after fetch returns\n      resolvePollFetch(tokenSuccessResponse(\"ghp_should_not_persist\"));\n\n      const result = await waitPromise;\n      expect(result.success).toBe(false);\n\n      // Token should NOT have been persisted\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeUndefined();\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Transient network error recovery\n  // -------------------------------------------------------------------------\n\n  describe(\"transient network error recovery\", () => {\n    it(\"retries after a transient fetch error and eventually succeeds\", async () => {\n      let pollCount = 0;\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return modelsResponse();\n        }\n        pollCount++;\n        if (pollCount === 1) {\n          throw new Error(\"ECONNRESET\");\n        }\n        return tokenSuccessResponse(\"ghp_recovered\");\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 30_000,\n      });\n\n      expect(waitResult.success).toBe(true);\n\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeDefined();\n      expect(apiKeyCall!.value).toBe(\"ghp_recovered\");\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Re-entrancy guard\n  // -------------------------------------------------------------------------\n\n  describe(\"re-entrancy guard\", () => {\n    it(\"only starts one polling loop even when waitForDeviceFlow is called twice\", async () => {\n      let pollCallCount = 0;\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return modelsResponse();\n        }\n        pollCallCount++;\n        return tokenSuccessResponse(\"ghp_single_poll\");\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const flowId = startResult.data.flowId;\n\n      // Call waitForDeviceFlow twice concurrently\n      const [result1, result2] = await Promise.all([\n        service.waitForDeviceFlow(flowId, { timeoutMs: 10_000 }),\n        service.waitForDeviceFlow(flowId, { timeoutMs: 10_000 }),\n      ]);\n\n      // Both should succeed\n      expect(result1.success).toBe(true);\n      expect(result2.success).toBe(true);\n\n      // Only one polling request should have been made (one poll loop)\n      expect(pollCallCount).toBe(1);\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Model fetching after successful auth\n  // -------------------------------------------------------------------------\n\n  describe(\"model fetching after successful auth\", () => {\n    it(\"fetches models from Copilot API and stores only allowed prefixes via setModels\", async () => {\n      let modelsUrl = \"\";\n      let modelsAuthHeader = \"\";\n      mockFetch((input, init) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          modelsUrl = url;\n          modelsAuthHeader = (init?.headers as Record<string, string>)?.Authorization ?? \"\";\n          // Return a mix of matching and non-matching models\n          return modelsResponse([\n            \"gpt-5\",\n            \"claude-sonnet-4.5\",\n            \"gpt-4o\",\n            \"o3-mini\",\n            \"gemini-3-pro-preview\",\n            \"grok-code-mini\",\n          ]);\n        }\n        return tokenSuccessResponse(\"ghp_model_token\");\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n      expect(waitResult.success).toBe(true);\n\n      // Verify models endpoint was called with correct URL and auth\n      expect(modelsUrl).toBe(\"https://api.githubcopilot.com/models\");\n      expect(modelsAuthHeader).toBe(\"Bearer ghp_model_token\");\n\n      // Verify only models matching allowed prefixes were stored\n      expect(deps.setModelsCalls).toHaveLength(1);\n      const call = deps.setModelsCalls[0];\n      expect(call?.provider).toBe(\"github-copilot\");\n      expect(call?.models).toEqual([\n        \"gpt-5\",\n        \"claude-sonnet-4.5\",\n        \"gemini-3-pro-preview\",\n        \"grok-code-mini\",\n      ]);\n    });\n\n    it(\"excludes models not matching any allowed prefix\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          // All models are non-matching\n          return modelsResponse([\"gpt-4o\", \"o3-mini\", \"o1-preview\"]);\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n      expect(waitResult.success).toBe(true);\n\n      // setModels should not be called when all models are filtered out\n      expect(deps.setModelsCalls).toHaveLength(0);\n    });\n\n    it(\"login succeeds even if model fetch returns non-200\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return new Response(\"Internal Server Error\", { status: 500 });\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n\n      // Login should still succeed\n      expect(waitResult.success).toBe(true);\n\n      // No models should have been stored\n      expect(deps.setModelsCalls).toHaveLength(0);\n    });\n\n    it(\"login succeeds even if model fetch throws a network error\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          throw new Error(\"ECONNREFUSED\");\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n\n      // Login should still succeed despite model fetch failure\n      expect(waitResult.success).toBe(true);\n\n      // Token should still have been persisted\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeDefined();\n\n      // No models should have been stored\n      expect(deps.setModelsCalls).toHaveLength(0);\n    });\n\n    it(\"does not call setModels when API returns empty model list\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return jsonResponse({ data: [] });\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n      expect(waitResult.success).toBe(true);\n\n      // Empty list — should not call setModels\n      expect(deps.setModelsCalls).toHaveLength(0);\n    });\n\n    it(\"does not call setModels when API response has no data field\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        if (url.includes(\"/models\")) {\n          return jsonResponse({ something_else: true });\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n      expect(waitResult.success).toBe(true);\n\n      expect(deps.setModelsCalls).toHaveLength(0);\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Dispose cleanup\n  // -------------------------------------------------------------------------\n\n  describe(\"dispose\", () => {\n    it(\"resolves pending waitForDeviceFlow with error\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        // Never return a token — keep it pending\n        return authorizationPendingResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitPromise = service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 30_000,\n      });\n\n      // Give polling loop a tick to start\n      await new Promise((resolve) => setTimeout(resolve, 10));\n\n      // Dispose the service\n      service.dispose();\n\n      const result = await waitPromise;\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"shutting down\");\n      }\n\n      // Token should NOT have been persisted\n      const apiKeyCall = deps.setConfigCalls.find(\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\n      );\n      expect(apiKeyCall).toBeUndefined();\n    });\n\n    it(\"clears all flows from the map\", async () => {\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        return authorizationPendingResponse();\n      });\n\n      // Start two flows\n      const flow1 = await service.startDeviceFlow();\n      const flow2 = await service.startDeviceFlow();\n      expect(flow1.success).toBe(true);\n      expect(flow2.success).toBe(true);\n\n      service.dispose();\n\n      // After dispose, waitForDeviceFlow should return \"not found\"\n      if (flow1.success) {\n        const result = await service.waitForDeviceFlow(flow1.data.flowId);\n        expect(result.success).toBe(false);\n        if (!result.success) {\n          expect(result.error).toContain(\"not found\");\n        }\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // setConfig failure\n  // -------------------------------------------------------------------------\n\n  describe(\"setConfig failure\", () => {\n    it(\"propagates setConfig error to waitForDeviceFlow result\", async () => {\n      deps.setConfigResult = Err(\"disk full\");\n\n      mockFetch((input) => {\n        const url = String(input);\n        if (url.includes(\"/login/device/code\")) {\n          return deviceCodeResponse();\n        }\n        return tokenSuccessResponse();\n      });\n\n      const startResult = await service.startDeviceFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\n        timeoutMs: 10_000,\n      });\n\n      expect(waitResult.success).toBe(false);\n      if (!waitResult.success) {\n        expect(waitResult.error).toContain(\"disk full\");\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // waitForDeviceFlow edge cases\n  // -------------------------------------------------------------------------\n\n  describe(\"waitForDeviceFlow edge cases\", () => {\n    it(\"returns Err for unknown flowId\", async () => {\n      const result = await service.waitForDeviceFlow(\"nonexistent-flow-id\");\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"not found\");\n      }\n    });\n\n    it(\"cancelDeviceFlow is a no-op for unknown flowId\", () => {\n      // Should not throw\n      service.cancelDeviceFlow(\"nonexistent-flow-id\");\n    });\n  });\n});\n"]}