{"version":3,"file":"copilotOauthService.test.js","sourceRoot":"","sources":["../../../src/node/services/copilotOauthService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\n\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Err, Ok } from \"@/common/types/result\";\r\nimport type { ProviderService } from \"@/node/services/providerService\";\r\nimport type { WindowService } from \"@/node/services/windowService\";\r\nimport { CopilotOauthService } from \"./copilotOauthService\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Helpers\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Build a mock fetch Response with JSON body. */\r\nfunction jsonResponse(body: Record<string, unknown>, status = 200): Response {\r\n  return new Response(JSON.stringify(body), {\r\n    status,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n  });\r\n}\r\n\r\n/** Standard device code response from GitHub. */\r\nfunction deviceCodeResponse(overrides?: Record<string, unknown>): Response {\r\n  return jsonResponse({\r\n    verification_uri: \"https://github.com/login/device\",\r\n    user_code: \"ABCD-1234\",\r\n    device_code: \"dc_test_123\",\r\n    interval: 0,\r\n    ...overrides,\r\n  });\r\n}\r\n\r\n/** Token success response. */\r\nfunction tokenSuccessResponse(token = \"ghp_test_token\"): Response {\r\n  return jsonResponse({ access_token: token });\r\n}\r\n\r\n/** Polling \"not yet\" response. */\r\nfunction authorizationPendingResponse(): Response {\r\n  return jsonResponse({ error: \"authorization_pending\" });\r\n}\r\n\r\n/** Models list response from Copilot API. */\r\nfunction modelsResponse(models: string[] = [\"gpt-5\", \"claude-sonnet-4\"]): Response {\r\n  return jsonResponse({ data: models.map((id) => ({ id })) });\r\n}\r\n\r\n// Helper to mock globalThis.fetch without needing the `preconnect` property.\r\nfunction mockFetch(\r\n  fn: (input: string | URL, init?: RequestInit) => Response | Promise<Response>\r\n): void {\r\n  globalThis.fetch = Object.assign(fn, {\r\n    preconnect: (_url: string | URL) => {\r\n      // no-op in tests\r\n    },\r\n  }) as typeof fetch;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Mock dependencies\r\n// ---------------------------------------------------------------------------\r\n\r\ninterface MockDeps {\r\n  setConfigCalls: Array<{ provider: string; keyPath: string[]; value: string }>;\r\n  setConfigResult: Result<void, string>;\r\n  setModelsCalls: Array<{ provider: string; models: string[] }>;\r\n  setModelsResult: Result<void, string>;\r\n  focusCalls: number;\r\n}\r\n\r\nfunction createMockDeps(): MockDeps {\r\n  return {\r\n    setConfigCalls: [],\r\n    setConfigResult: Ok(undefined),\r\n    setModelsCalls: [],\r\n    setModelsResult: Ok(undefined),\r\n    focusCalls: 0,\r\n  };\r\n}\r\n\r\nfunction createMockProviderService(\r\n  deps: MockDeps\r\n): Pick<ProviderService, \"setConfig\" | \"setModels\"> {\r\n  return {\r\n    setConfig: (provider: string, keyPath: string[], value: string): Result<void, string> => {\r\n      deps.setConfigCalls.push({ provider, keyPath, value });\r\n      return deps.setConfigResult;\r\n    },\r\n    setModels: (provider: string, models: string[]): Result<void, string> => {\r\n      deps.setModelsCalls.push({ provider, models });\r\n      return deps.setModelsResult;\r\n    },\r\n  };\r\n}\r\n\r\nfunction createMockWindowService(deps: MockDeps): Pick<WindowService, \"focusMainWindow\"> {\r\n  return {\r\n    focusMainWindow: () => {\r\n      deps.focusCalls++;\r\n    },\r\n  };\r\n}\r\n\r\nfunction createService(deps: MockDeps): CopilotOauthService {\r\n  return new CopilotOauthService(\r\n    createMockProviderService(deps) as ProviderService,\r\n    createMockWindowService(deps) as WindowService\r\n  );\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Tests\r\n// ---------------------------------------------------------------------------\r\n\r\ndescribe(\"CopilotOauthService\", () => {\r\n  let deps: MockDeps;\r\n  let service: CopilotOauthService;\r\n  const originalFetch = globalThis.fetch;\r\n\r\n  beforeEach(() => {\r\n    deps = createMockDeps();\r\n    service = createService(deps);\r\n  });\r\n\r\n  afterEach(() => {\r\n    globalThis.fetch = originalFetch;\r\n    service.dispose();\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // startDeviceFlow\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"startDeviceFlow\", () => {\r\n    it(\"returns flowId, verificationUri, and userCode on success\", async () => {\r\n      mockFetch(() => deviceCodeResponse());\r\n\r\n      const result = await service.startDeviceFlow();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data.flowId).toBeTruthy();\r\n        expect(result.data.verificationUri).toBe(\"https://github.com/login/device\");\r\n        expect(result.data.userCode).toBe(\"ABCD-1234\");\r\n      }\r\n    });\r\n\r\n    it(\"sends request to github.com device code endpoint\", async () => {\r\n      let capturedUrl = \"\";\r\n      mockFetch((input) => {\r\n        capturedUrl = String(input);\r\n        return deviceCodeResponse();\r\n      });\r\n\r\n      await service.startDeviceFlow();\r\n      expect(capturedUrl).toBe(\"https://github.com/login/device/code\");\r\n    });\r\n\r\n    it(\"returns Err when fetch response is not ok\", async () => {\r\n      mockFetch(() => new Response(\"Server Error\", { status: 500 }));\r\n\r\n      const result = await service.startDeviceFlow();\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"500\");\r\n      }\r\n    });\r\n\r\n    it(\"returns Err when fetch throws a network error\", async () => {\r\n      mockFetch(() => {\r\n        throw new Error(\"DNS resolution failed\");\r\n      });\r\n\r\n      const result = await service.startDeviceFlow();\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"DNS resolution failed\");\r\n      }\r\n    });\r\n\r\n    it(\"returns Err when response is missing required fields\", async () => {\r\n      mockFetch(() => jsonResponse({ verification_uri: \"https://example.com\" }));\r\n\r\n      const result = await service.startDeviceFlow();\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"Invalid response\");\r\n      }\r\n    });\r\n\r\n    it(\"each flow gets a unique flowId\", async () => {\r\n      mockFetch(() => deviceCodeResponse());\r\n\r\n      const first = await service.startDeviceFlow();\r\n      const second = await service.startDeviceFlow();\r\n      expect(first.success).toBe(true);\r\n      expect(second.success).toBe(true);\r\n      if (first.success && second.success) {\r\n        expect(first.data.flowId).not.toBe(second.data.flowId);\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Happy path: poll → success\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"happy path: poll → success\", () => {\r\n    it(\"polls until access_token is returned, then persists it\", async () => {\r\n      // startDeviceFlow fetch\r\n      let pollCount = 0;\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return modelsResponse();\r\n        }\r\n        // Polling endpoint\r\n        pollCount++;\r\n        if (pollCount === 1) {\r\n          return authorizationPendingResponse();\r\n        }\r\n        return tokenSuccessResponse(\"ghp_final_token\");\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 30_000,\r\n      });\r\n\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      // Verify token was persisted\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeDefined();\r\n      expect(apiKeyCall!.value).toBe(\"ghp_final_token\");\r\n    });\r\n\r\n    it(\"calls focusMainWindow after successful auth\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return modelsResponse();\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      await service.waitForDeviceFlow(startResult.data.flowId, { timeoutMs: 10_000 });\r\n\r\n      expect(deps.focusCalls).toBe(1);\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // slow_down response\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"slow_down response\", () => {\r\n    it(\"respects slow_down and eventually succeeds\", async () => {\r\n      let pollCount = 0;\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return modelsResponse();\r\n        }\r\n        pollCount++;\r\n        if (pollCount === 1) {\r\n          // slow_down: service should increase interval but continue\r\n          return jsonResponse({ error: \"slow_down\", interval: 0 });\r\n        }\r\n        return tokenSuccessResponse(\"ghp_slow_token\");\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 30_000,\r\n      });\r\n\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeDefined();\r\n      expect(apiKeyCall!.value).toBe(\"ghp_slow_token\");\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Terminal error\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"terminal error\", () => {\r\n    it(\"resolves with Err on access_denied\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        return jsonResponse({ error: \"access_denied\" });\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n\r\n      expect(waitResult.success).toBe(false);\r\n      if (!waitResult.success) {\r\n        expect(waitResult.error).toContain(\"access_denied\");\r\n      }\r\n\r\n      // Token should NOT have been persisted\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeUndefined();\r\n    });\r\n\r\n    it(\"resolves with Err on expired_token\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        return jsonResponse({ error: \"expired_token\" });\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n\r\n      expect(waitResult.success).toBe(false);\r\n      if (!waitResult.success) {\r\n        expect(waitResult.error).toContain(\"expired_token\");\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Cancellation\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"cancellation\", () => {\r\n    it(\"resolves waitForDeviceFlow with error when cancelled\", async () => {\r\n      // Make polling hang indefinitely with authorization_pending\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        return authorizationPendingResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const flowId = startResult.data.flowId;\r\n\r\n      // Start waiting (don't await yet)\r\n      const waitPromise = service.waitForDeviceFlow(flowId, { timeoutMs: 30_000 });\r\n\r\n      // Give polling loop a tick to start\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n\r\n      // Cancel the flow\r\n      service.cancelDeviceFlow(flowId);\r\n\r\n      const result = await waitPromise;\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"cancelled\");\r\n      }\r\n\r\n      // Token should NOT have been persisted\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeUndefined();\r\n    });\r\n\r\n    it(\"does not persist token if cancelled mid-request\", async () => {\r\n      // Control when the polling fetch resolves\r\n      let resolvePollFetch!: (res: Response) => void;\r\n\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        // Hang the polling request until we resolve it manually\r\n        return new Promise<Response>((resolve) => {\r\n          resolvePollFetch = resolve;\r\n        });\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const flowId = startResult.data.flowId;\r\n      const waitPromise = service.waitForDeviceFlow(flowId, { timeoutMs: 30_000 });\r\n\r\n      // Give polling loop a tick to start the fetch\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n\r\n      // Cancel while fetch is in-flight\r\n      service.cancelDeviceFlow(flowId);\r\n\r\n      // Now resolve the fetch with a valid token — it should be ignored\r\n      // because flow.cancelled is checked after fetch returns\r\n      resolvePollFetch(tokenSuccessResponse(\"ghp_should_not_persist\"));\r\n\r\n      const result = await waitPromise;\r\n      expect(result.success).toBe(false);\r\n\r\n      // Token should NOT have been persisted\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeUndefined();\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Transient network error recovery\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"transient network error recovery\", () => {\r\n    it(\"retries after a transient fetch error and eventually succeeds\", async () => {\r\n      let pollCount = 0;\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return modelsResponse();\r\n        }\r\n        pollCount++;\r\n        if (pollCount === 1) {\r\n          throw new Error(\"ECONNRESET\");\r\n        }\r\n        return tokenSuccessResponse(\"ghp_recovered\");\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 30_000,\r\n      });\r\n\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeDefined();\r\n      expect(apiKeyCall!.value).toBe(\"ghp_recovered\");\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Re-entrancy guard\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"re-entrancy guard\", () => {\r\n    it(\"only starts one polling loop even when waitForDeviceFlow is called twice\", async () => {\r\n      let pollCallCount = 0;\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return modelsResponse();\r\n        }\r\n        pollCallCount++;\r\n        return tokenSuccessResponse(\"ghp_single_poll\");\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const flowId = startResult.data.flowId;\r\n\r\n      // Call waitForDeviceFlow twice concurrently\r\n      const [result1, result2] = await Promise.all([\r\n        service.waitForDeviceFlow(flowId, { timeoutMs: 10_000 }),\r\n        service.waitForDeviceFlow(flowId, { timeoutMs: 10_000 }),\r\n      ]);\r\n\r\n      // Both should succeed\r\n      expect(result1.success).toBe(true);\r\n      expect(result2.success).toBe(true);\r\n\r\n      // Only one polling request should have been made (one poll loop)\r\n      expect(pollCallCount).toBe(1);\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Model fetching after successful auth\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"model fetching after successful auth\", () => {\r\n    it(\"fetches models from Copilot API and stores only allowed prefixes via setModels\", async () => {\r\n      let modelsUrl = \"\";\r\n      let modelsAuthHeader = \"\";\r\n      mockFetch((input, init) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          modelsUrl = url;\r\n          modelsAuthHeader = (init?.headers as Record<string, string>)?.Authorization ?? \"\";\r\n          // Return a mix of matching and non-matching models\r\n          return modelsResponse([\r\n            \"gpt-5\",\r\n            \"claude-sonnet-4.5\",\r\n            \"gpt-4o\",\r\n            \"o3-mini\",\r\n            \"gemini-3-pro-preview\",\r\n            \"grok-code-mini\",\r\n          ]);\r\n        }\r\n        return tokenSuccessResponse(\"ghp_model_token\");\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      // Verify models endpoint was called with correct URL and auth\r\n      expect(modelsUrl).toBe(\"https://api.githubcopilot.com/models\");\r\n      expect(modelsAuthHeader).toBe(\"Bearer ghp_model_token\");\r\n\r\n      // Verify only models matching allowed prefixes were stored\r\n      expect(deps.setModelsCalls).toHaveLength(1);\r\n      const call = deps.setModelsCalls[0];\r\n      expect(call?.provider).toBe(\"github-copilot\");\r\n      expect(call?.models).toEqual([\r\n        \"gpt-5\",\r\n        \"claude-sonnet-4.5\",\r\n        \"gemini-3-pro-preview\",\r\n        \"grok-code-mini\",\r\n      ]);\r\n    });\r\n\r\n    it(\"excludes models not matching any allowed prefix\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          // All models are non-matching\r\n          return modelsResponse([\"gpt-4o\", \"o3-mini\", \"o1-preview\"]);\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      // setModels should not be called when all models are filtered out\r\n      expect(deps.setModelsCalls).toHaveLength(0);\r\n    });\r\n\r\n    it(\"login succeeds even if model fetch returns non-200\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return new Response(\"Internal Server Error\", { status: 500 });\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n\r\n      // Login should still succeed\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      // No models should have been stored\r\n      expect(deps.setModelsCalls).toHaveLength(0);\r\n    });\r\n\r\n    it(\"login succeeds even if model fetch throws a network error\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          throw new Error(\"ECONNREFUSED\");\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n\r\n      // Login should still succeed despite model fetch failure\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      // Token should still have been persisted\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeDefined();\r\n\r\n      // No models should have been stored\r\n      expect(deps.setModelsCalls).toHaveLength(0);\r\n    });\r\n\r\n    it(\"does not call setModels when API returns empty model list\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return jsonResponse({ data: [] });\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      // Empty list — should not call setModels\r\n      expect(deps.setModelsCalls).toHaveLength(0);\r\n    });\r\n\r\n    it(\"does not call setModels when API response has no data field\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        if (url.includes(\"/models\")) {\r\n          return jsonResponse({ something_else: true });\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n      expect(waitResult.success).toBe(true);\r\n\r\n      expect(deps.setModelsCalls).toHaveLength(0);\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Dispose cleanup\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"dispose\", () => {\r\n    it(\"resolves pending waitForDeviceFlow with error\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        // Never return a token — keep it pending\r\n        return authorizationPendingResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitPromise = service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 30_000,\r\n      });\r\n\r\n      // Give polling loop a tick to start\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n\r\n      // Dispose the service\r\n      service.dispose();\r\n\r\n      const result = await waitPromise;\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"shutting down\");\r\n      }\r\n\r\n      // Token should NOT have been persisted\r\n      const apiKeyCall = deps.setConfigCalls.find(\r\n        (c) => c.provider === \"github-copilot\" && c.keyPath[0] === \"apiKey\"\r\n      );\r\n      expect(apiKeyCall).toBeUndefined();\r\n    });\r\n\r\n    it(\"clears all flows from the map\", async () => {\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        return authorizationPendingResponse();\r\n      });\r\n\r\n      // Start two flows\r\n      const flow1 = await service.startDeviceFlow();\r\n      const flow2 = await service.startDeviceFlow();\r\n      expect(flow1.success).toBe(true);\r\n      expect(flow2.success).toBe(true);\r\n\r\n      service.dispose();\r\n\r\n      // After dispose, waitForDeviceFlow should return \"not found\"\r\n      if (flow1.success) {\r\n        const result = await service.waitForDeviceFlow(flow1.data.flowId);\r\n        expect(result.success).toBe(false);\r\n        if (!result.success) {\r\n          expect(result.error).toContain(\"not found\");\r\n        }\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // setConfig failure\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"setConfig failure\", () => {\r\n    it(\"propagates setConfig error to waitForDeviceFlow result\", async () => {\r\n      deps.setConfigResult = Err(\"disk full\");\r\n\r\n      mockFetch((input) => {\r\n        const url = String(input);\r\n        if (url.includes(\"/login/device/code\")) {\r\n          return deviceCodeResponse();\r\n        }\r\n        return tokenSuccessResponse();\r\n      });\r\n\r\n      const startResult = await service.startDeviceFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const waitResult = await service.waitForDeviceFlow(startResult.data.flowId, {\r\n        timeoutMs: 10_000,\r\n      });\r\n\r\n      expect(waitResult.success).toBe(false);\r\n      if (!waitResult.success) {\r\n        expect(waitResult.error).toContain(\"disk full\");\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // waitForDeviceFlow edge cases\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"waitForDeviceFlow edge cases\", () => {\r\n    it(\"returns Err for unknown flowId\", async () => {\r\n      const result = await service.waitForDeviceFlow(\"nonexistent-flow-id\");\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"not found\");\r\n      }\r\n    });\r\n\r\n    it(\"cancelDeviceFlow is a no-op for unknown flowId\", () => {\r\n      // Should not throw\r\n      service.cancelDeviceFlow(\"nonexistent-flow-id\");\r\n    });\r\n  });\r\n});\r\n"]}