{"version":3,"file":"initStateManager.test.js","sourceRoot":"","sources":["../../../src/node/services/initStateManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport * as os from \"os\";\nimport { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\nimport { Config } from \"@/node/config\";\nimport { InitStateManager } from \"./initStateManager\";\nimport type { WorkspaceInitEvent } from \"@/common/orpc/types\";\nimport { INIT_HOOK_MAX_LINES } from \"@/common/constants/toolLimits\";\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\n\ndescribe(\"InitStateManager\", () => {\n  let tempDir: string;\n  let config: Config;\n  let manager: InitStateManager;\n\n  beforeEach(async () => {\n    // Create temp directory as mux root\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"init-state-test-\"));\n\n    // Create sessions directory\n    const sessionsDir = path.join(tempDir, \"sessions\");\n    await fs.mkdir(sessionsDir, { recursive: true });\n\n    // Config constructor takes rootDir directly\n    config = new Config(tempDir);\n    manager = new InitStateManager(config);\n  });\n\n  afterEach(async () => {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  });\n\n  describe(\"lifecycle\", () => {\n    it(\"should track init hook lifecycle (start → output → end)\", async () => {\n      const workspaceId = \"test-workspace\";\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\n\n      // Subscribe to events\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n\n      // Start init\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      expect(manager.getInitState(workspaceId)).toBeTruthy();\n      expect(manager.getInitState(workspaceId)?.status).toBe(\"running\");\n\n      // Append output\n      manager.appendOutput(workspaceId, \"Installing deps...\", false);\n      manager.appendOutput(workspaceId, \"Done!\", false);\n      expect(manager.getInitState(workspaceId)?.lines).toEqual([\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        { line: \"Installing deps...\", isError: false, timestamp: expect.any(Number) },\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        { line: \"Done!\", isError: false, timestamp: expect.any(Number) },\n      ]);\n\n      // End init (await to ensure event fires)\n      await manager.endInit(workspaceId, 0);\n      expect(manager.getInitState(workspaceId)?.status).toBe(\"success\");\n      expect(manager.getInitState(workspaceId)?.exitCode).toBe(0);\n\n      // Verify events\n      expect(events).toHaveLength(4); // start + 2 outputs + end\n      expect(events[0].type).toBe(\"init-start\");\n      expect(events[1].type).toBe(\"init-output\");\n      expect(events[2].type).toBe(\"init-output\");\n      expect(events[3].type).toBe(\"init-end\");\n    });\n\n    it(\"should track stderr lines with isError flag\", () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      manager.appendOutput(workspaceId, \"stdout line\", false);\n      manager.appendOutput(workspaceId, \"stderr line\", true);\n\n      const state = manager.getInitState(workspaceId);\n      expect(state?.lines).toEqual([\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        { line: \"stdout line\", isError: false, timestamp: expect.any(Number) },\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        { line: \"stderr line\", isError: true, timestamp: expect.any(Number) },\n      ]);\n    });\n\n    it(\"should set status to error on non-zero exit code\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      await manager.endInit(workspaceId, 1);\n\n      const state = manager.getInitState(workspaceId);\n      expect(state?.status).toBe(\"error\");\n      expect(state?.exitCode).toBe(1);\n    });\n  });\n\n  describe(\"persistence\", () => {\n    it(\"should persist state to disk on endInit\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      manager.appendOutput(workspaceId, \"Line 1\", false);\n      manager.appendOutput(workspaceId, \"Line 2\", true);\n      await manager.endInit(workspaceId, 0);\n\n      // Read from disk\n      const diskState = await manager.readInitStatus(workspaceId);\n      expect(diskState).toBeTruthy();\n      expect(diskState?.status).toBe(\"success\");\n      expect(diskState?.exitCode).toBe(0);\n      expect(diskState?.lines).toEqual([\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        { line: \"Line 1\", isError: false, timestamp: expect.any(Number) },\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        { line: \"Line 2\", isError: true, timestamp: expect.any(Number) },\n      ]);\n    });\n\n    it(\"should replay from in-memory state when available\", async () => {\n      const workspaceId = \"test-workspace\";\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\n\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n\n      // Create state\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      manager.appendOutput(workspaceId, \"Line 1\", false);\n      await manager.endInit(workspaceId, 0);\n\n      events.length = 0; // Clear events\n\n      // Replay from in-memory\n      await manager.replayInit(workspaceId);\n\n      expect(events).toHaveLength(3); // start + output + end\n      expect(events[0].type).toBe(\"init-start\");\n      expect(events[1].type).toBe(\"init-output\");\n      expect(events[2].type).toBe(\"init-end\");\n    });\n\n    it(\"should replay from disk when not in memory\", async () => {\n      const workspaceId = \"test-workspace\";\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\n\n      // Create and persist state\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      manager.appendOutput(workspaceId, \"Line 1\", false);\n      manager.appendOutput(workspaceId, \"Error line\", true);\n      await manager.endInit(workspaceId, 1);\n\n      // Clear in-memory state (simulate process restart)\n      manager.clearInMemoryState(workspaceId);\n      expect(manager.getInitState(workspaceId)).toBeUndefined();\n\n      // Subscribe to events\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n\n      // Replay from disk\n      await manager.replayInit(workspaceId);\n\n      expect(events).toHaveLength(4); // start + 2 outputs + end\n      expect(events[0].type).toBe(\"init-start\");\n      expect(events[1].type).toBe(\"init-output\");\n      expect((events[1] as { line: string }).line).toBe(\"Line 1\");\n      expect(events[2].type).toBe(\"init-output\");\n      expect((events[2] as { line: string }).line).toBe(\"Error line\");\n      expect((events[2] as { isError?: boolean }).isError).toBe(true);\n      expect(events[3].type).toBe(\"init-end\");\n      expect((events[3] as { exitCode: number }).exitCode).toBe(1);\n    });\n\n    it(\"should not replay if no state exists\", async () => {\n      const workspaceId = \"nonexistent-workspace\";\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\n\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n\n      await manager.replayInit(workspaceId);\n\n      expect(events).toHaveLength(0);\n    });\n  });\n\n  describe(\"cleanup\", () => {\n    it(\"should delete persisted state from disk\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      await manager.endInit(workspaceId, 0);\n\n      // Verify state exists\n      const stateBeforeDelete = await manager.readInitStatus(workspaceId);\n      expect(stateBeforeDelete).toBeTruthy();\n\n      // Delete\n      await manager.deleteInitStatus(workspaceId);\n\n      // Verify deleted\n      const stateAfterDelete = await manager.readInitStatus(workspaceId);\n      expect(stateAfterDelete).toBeNull();\n    });\n\n    it(\"should clear in-memory state\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      expect(manager.getInitState(workspaceId)).toBeTruthy();\n\n      // Get the init promise before clearing\n      const initPromise = manager.waitForInit(workspaceId);\n\n      // Clear in-memory state (rejects internal promise, but waitForInit catches it)\n      manager.clearInMemoryState(workspaceId);\n\n      // Verify state is cleared\n      expect(manager.getInitState(workspaceId)).toBeUndefined();\n\n      // waitForInit never throws - it resolves even when init is canceled\n      // This allows tools to proceed and fail naturally with their own errors\n      // eslint-disable-next-line @typescript-eslint/await-thenable\n      await expect(initPromise).resolves.toBeUndefined();\n    });\n\n    it(\"should not recreate session directory if queued persistence runs after state is cleared\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      const sessionDir = config.getSessionDir(workspaceId);\n      await fs.mkdir(sessionDir, { recursive: true });\n\n      let releaseLock: (() => void) | undefined;\n      const lockHeld = workspaceFileLocks.withLock(workspaceId, async () => {\n        await new Promise<void>((resolve) => {\n          releaseLock = resolve;\n        });\n      });\n\n      // Let the lock callback run so releaseLock is set.\n      await Promise.resolve();\n      if (!releaseLock) {\n        throw new Error(\"Expected workspace file lock to be held\");\n      }\n\n      // Queue endInit persistence behind the workspace file lock.\n      const endInitPromise = manager.endInit(workspaceId, 0);\n\n      // Simulate workspace removal: clear in-memory init state and delete the session directory.\n      manager.clearInMemoryState(workspaceId);\n      await fs.rm(sessionDir, { recursive: true, force: true });\n\n      // Allow queued persistence to proceed.\n      releaseLock();\n      await lockHeld;\n      await endInitPromise;\n\n      expect(await manager.readInitStatus(workspaceId)).toBeNull();\n\n      const sessionDirExists = await fs\n        .access(sessionDir)\n        .then(() => true)\n        .catch(() => false);\n      expect(sessionDirExists).toBe(false);\n    });\n  });\n\n  describe(\"error handling\", () => {\n    it(\"should handle appendOutput with no active state\", () => {\n      const workspaceId = \"nonexistent-workspace\";\n      // Should not throw\n      manager.appendOutput(workspaceId, \"Line\", false);\n    });\n\n    it(\"should handle endInit with no active state\", async () => {\n      const workspaceId = \"nonexistent-workspace\";\n      // Should not throw\n      await manager.endInit(workspaceId, 0);\n    });\n\n    it(\"should handle deleteInitStatus for nonexistent file\", async () => {\n      const workspaceId = \"nonexistent-workspace\";\n      // Should not throw\n      await manager.deleteInitStatus(workspaceId);\n    });\n  });\n\n  describe(\"truncation\", () => {\n    it(\"should truncate lines when exceeding INIT_HOOK_MAX_LINES\", () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      // Add more lines than the limit\n      const totalLines = INIT_HOOK_MAX_LINES + 100;\n      for (let i = 0; i < totalLines; i++) {\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\n      }\n\n      const state = manager.getInitState(workspaceId);\n      expect(state?.lines.length).toBe(INIT_HOOK_MAX_LINES);\n      expect(state?.truncatedLines).toBe(100);\n\n      // Should have the most recent lines (tail)\n      const lastLine = state?.lines[INIT_HOOK_MAX_LINES - 1];\n      expect(lastLine?.line).toBe(`Line ${totalLines - 1}`);\n\n      // First line should be from when truncation started\n      const firstLine = state?.lines[0];\n      expect(firstLine?.line).toBe(`Line 100`);\n    });\n\n    it(\"should include truncatedLines in init-end event\", async () => {\n      const workspaceId = \"test-workspace\";\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\n\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      // Add more lines than the limit\n      for (let i = 0; i < INIT_HOOK_MAX_LINES + 50; i++) {\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\n      }\n\n      await manager.endInit(workspaceId, 0);\n\n      expect(events).toHaveLength(1);\n      expect((events[0] as { truncatedLines?: number }).truncatedLines).toBe(50);\n    });\n\n    it(\"should persist truncatedLines to disk\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      // Add more lines than the limit\n      for (let i = 0; i < INIT_HOOK_MAX_LINES + 25; i++) {\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\n      }\n\n      await manager.endInit(workspaceId, 0);\n\n      const diskState = await manager.readInitStatus(workspaceId);\n      expect(diskState?.truncatedLines).toBe(25);\n      expect(diskState?.lines.length).toBe(INIT_HOOK_MAX_LINES);\n    });\n\n    it(\"should not set truncatedLines when under limit\", () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      // Add fewer lines than the limit\n      for (let i = 0; i < 10; i++) {\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\n      }\n\n      const state = manager.getInitState(workspaceId);\n      expect(state?.lines.length).toBe(10);\n      expect(state?.truncatedLines).toBeUndefined();\n    });\n\n    it(\"should truncate old persisted data on replay (backwards compat)\", async () => {\n      const workspaceId = \"test-workspace\";\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\n\n      // Manually write a large init-status.json to simulate old data\n      const sessionsDir = path.join(tempDir, \"sessions\", workspaceId);\n      await fs.mkdir(sessionsDir, { recursive: true });\n\n      const oldLineCount = INIT_HOOK_MAX_LINES + 200;\n      const oldStatus = {\n        status: \"success\",\n        hookPath: \"/path/to/hook\",\n        startTime: Date.now() - 1000,\n        lines: Array.from({ length: oldLineCount }, (_, i) => ({\n          line: `Old line ${i}`,\n          isError: false,\n          timestamp: Date.now() - 1000 + i,\n        })),\n        exitCode: 0,\n        endTime: Date.now(),\n        // No truncatedLines field - old format\n      };\n      await fs.writeFile(path.join(sessionsDir, \"init-status.json\"), JSON.stringify(oldStatus));\n\n      // Subscribe to events\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\n        events.push(event)\n      );\n\n      // Replay from disk\n      await manager.replayInit(workspaceId);\n\n      // Should only emit MAX_LINES output events (truncated)\n      const outputEvents = events.filter((e) => e.type === \"init-output\");\n      expect(outputEvents.length).toBe(INIT_HOOK_MAX_LINES);\n\n      // init-end should include truncatedLines count\n      const endEvent = events.find((e) => e.type === \"init-end\");\n      expect((endEvent as { truncatedLines?: number }).truncatedLines).toBe(200);\n\n      // First replayed line should be from the tail (old line 200)\n      expect((outputEvents[0] as { line: string }).line).toBe(\"Old line 200\");\n    });\n  });\n\n  describe(\"waitForInit hook phase\", () => {\n    it(\"should not time out during runtime setup (intentional)\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      const waitPromise = manager.waitForInit(workspaceId);\n      const result = await Promise.race([\n        waitPromise.then(() => \"done\"),\n        new Promise((resolve) => setTimeout(() => resolve(\"pending\"), 150)),\n      ]);\n\n      expect(result).toBe(\"pending\");\n\n      await manager.endInit(workspaceId, 0);\n      await waitPromise;\n    });\n\n    it(\"should start timeout once hook phase begins\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      manager.enterHookPhase(workspaceId);\n\n      const state = manager.getInitState(workspaceId);\n      if (!state) {\n        throw new Error(\"Expected init state to exist\");\n      }\n      state.hookStartTime = Date.now() - 5 * 60 * 1000 - 1000;\n\n      const waitPromise = manager.waitForInit(workspaceId);\n      const result = await Promise.race([\n        waitPromise.then(() => \"done\"),\n        new Promise((resolve) => setTimeout(() => resolve(\"pending\"), 150)),\n      ]);\n\n      expect(result).toBe(\"done\");\n\n      await manager.endInit(workspaceId, 0);\n      await waitPromise;\n    });\n\n    it(\"should set hookStartTime when entering hook phase\", () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n\n      manager.enterHookPhase(workspaceId);\n\n      const state = manager.getInitState(workspaceId);\n      if (!state) {\n        throw new Error(\"Expected init state to exist\");\n      }\n\n      expect(state.phase).toBe(\"init_hook\");\n      expect(state.hookStartTime).toBeDefined();\n      expect(typeof state.hookStartTime).toBe(\"number\");\n    });\n  });\n\n  describe(\"waitForInit with abortSignal\", () => {\n    it(\"should return immediately if abortSignal is already aborted\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      const controller = new AbortController();\n      controller.abort();\n\n      const start = Date.now();\n      await manager.waitForInit(workspaceId, controller.signal);\n      expect(Date.now() - start).toBeLessThan(200); // Should be instant\n    });\n\n    it(\"should return when abortSignal fires during wait\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      const controller = new AbortController();\n\n      const waitPromise = manager.waitForInit(workspaceId, controller.signal);\n      setTimeout(() => controller.abort(), 20);\n\n      const start = Date.now();\n      await waitPromise;\n      expect(Date.now() - start).toBeLessThan(300); // Should return quickly after abort\n    });\n\n    it(\"should clean up timeout when init completes first\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      const waitPromise = manager.waitForInit(workspaceId);\n\n      await manager.endInit(workspaceId, 0);\n      await waitPromise;\n      // No spurious timeout error should be logged (verify via log spy if needed)\n    });\n\n    it(\"should work without abortSignal (backwards compat)\", async () => {\n      const workspaceId = \"test-workspace\";\n      manager.startInit(workspaceId, \"/path/to/hook\");\n      const waitPromise = manager.waitForInit(workspaceId);\n\n      // Complete init\n      await manager.endInit(workspaceId, 0);\n      await waitPromise;\n      // Should complete without error\n    });\n  });\n});\n"]}