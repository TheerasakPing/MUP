{"version":3,"file":"initStateManager.test.js","sourceRoot":"","sources":["../../../src/node/services/initStateManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport { Config } from \"@/node/config\";\r\nimport { InitStateManager } from \"./initStateManager\";\r\nimport type { WorkspaceInitEvent } from \"@/common/orpc/types\";\r\nimport { INIT_HOOK_MAX_LINES } from \"@/common/constants/toolLimits\";\r\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\r\n\r\ndescribe(\"InitStateManager\", () => {\r\n  let tempDir: string;\r\n  let config: Config;\r\n  let manager: InitStateManager;\r\n\r\n  beforeEach(async () => {\r\n    // Create temp directory as mux root\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"init-state-test-\"));\r\n\r\n    // Create sessions directory\r\n    const sessionsDir = path.join(tempDir, \"sessions\");\r\n    await fs.mkdir(sessionsDir, { recursive: true });\r\n\r\n    // Config constructor takes rootDir directly\r\n    config = new Config(tempDir);\r\n    manager = new InitStateManager(config);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  describe(\"lifecycle\", () => {\r\n    it(\"should track init hook lifecycle (start → output → end)\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\r\n\r\n      // Subscribe to events\r\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n\r\n      // Start init\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      expect(manager.getInitState(workspaceId)).toBeTruthy();\r\n      expect(manager.getInitState(workspaceId)?.status).toBe(\"running\");\r\n\r\n      // Append output\r\n      manager.appendOutput(workspaceId, \"Installing deps...\", false);\r\n      manager.appendOutput(workspaceId, \"Done!\", false);\r\n      expect(manager.getInitState(workspaceId)?.lines).toEqual([\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n        { line: \"Installing deps...\", isError: false, timestamp: expect.any(Number) },\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n        { line: \"Done!\", isError: false, timestamp: expect.any(Number) },\r\n      ]);\r\n\r\n      // End init (await to ensure event fires)\r\n      await manager.endInit(workspaceId, 0);\r\n      expect(manager.getInitState(workspaceId)?.status).toBe(\"success\");\r\n      expect(manager.getInitState(workspaceId)?.exitCode).toBe(0);\r\n\r\n      // Verify events\r\n      expect(events).toHaveLength(4); // start + 2 outputs + end\r\n      expect(events[0].type).toBe(\"init-start\");\r\n      expect(events[1].type).toBe(\"init-output\");\r\n      expect(events[2].type).toBe(\"init-output\");\r\n      expect(events[3].type).toBe(\"init-end\");\r\n    });\r\n\r\n    it(\"should track stderr lines with isError flag\", () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      manager.appendOutput(workspaceId, \"stdout line\", false);\r\n      manager.appendOutput(workspaceId, \"stderr line\", true);\r\n\r\n      const state = manager.getInitState(workspaceId);\r\n      expect(state?.lines).toEqual([\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n        { line: \"stdout line\", isError: false, timestamp: expect.any(Number) },\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n        { line: \"stderr line\", isError: true, timestamp: expect.any(Number) },\r\n      ]);\r\n    });\r\n\r\n    it(\"should set status to error on non-zero exit code\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      await manager.endInit(workspaceId, 1);\r\n\r\n      const state = manager.getInitState(workspaceId);\r\n      expect(state?.status).toBe(\"error\");\r\n      expect(state?.exitCode).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe(\"persistence\", () => {\r\n    it(\"should persist state to disk on endInit\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      manager.appendOutput(workspaceId, \"Line 1\", false);\r\n      manager.appendOutput(workspaceId, \"Line 2\", true);\r\n      await manager.endInit(workspaceId, 0);\r\n\r\n      // Read from disk\r\n      const diskState = await manager.readInitStatus(workspaceId);\r\n      expect(diskState).toBeTruthy();\r\n      expect(diskState?.status).toBe(\"success\");\r\n      expect(diskState?.exitCode).toBe(0);\r\n      expect(diskState?.lines).toEqual([\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n        { line: \"Line 1\", isError: false, timestamp: expect.any(Number) },\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n        { line: \"Line 2\", isError: true, timestamp: expect.any(Number) },\r\n      ]);\r\n    });\r\n\r\n    it(\"should replay from in-memory state when available\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\r\n\r\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n\r\n      // Create state\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      manager.appendOutput(workspaceId, \"Line 1\", false);\r\n      await manager.endInit(workspaceId, 0);\r\n\r\n      events.length = 0; // Clear events\r\n\r\n      // Replay from in-memory\r\n      await manager.replayInit(workspaceId);\r\n\r\n      expect(events).toHaveLength(3); // start + output + end\r\n      expect(events[0].type).toBe(\"init-start\");\r\n      expect(events[1].type).toBe(\"init-output\");\r\n      expect(events[2].type).toBe(\"init-end\");\r\n    });\r\n\r\n    it(\"should replay from disk when not in memory\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\r\n\r\n      // Create and persist state\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      manager.appendOutput(workspaceId, \"Line 1\", false);\r\n      manager.appendOutput(workspaceId, \"Error line\", true);\r\n      await manager.endInit(workspaceId, 1);\r\n\r\n      // Clear in-memory state (simulate process restart)\r\n      manager.clearInMemoryState(workspaceId);\r\n      expect(manager.getInitState(workspaceId)).toBeUndefined();\r\n\r\n      // Subscribe to events\r\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n\r\n      // Replay from disk\r\n      await manager.replayInit(workspaceId);\r\n\r\n      expect(events).toHaveLength(4); // start + 2 outputs + end\r\n      expect(events[0].type).toBe(\"init-start\");\r\n      expect(events[1].type).toBe(\"init-output\");\r\n      expect((events[1] as { line: string }).line).toBe(\"Line 1\");\r\n      expect(events[2].type).toBe(\"init-output\");\r\n      expect((events[2] as { line: string }).line).toBe(\"Error line\");\r\n      expect((events[2] as { isError?: boolean }).isError).toBe(true);\r\n      expect(events[3].type).toBe(\"init-end\");\r\n      expect((events[3] as { exitCode: number }).exitCode).toBe(1);\r\n    });\r\n\r\n    it(\"should not replay if no state exists\", async () => {\r\n      const workspaceId = \"nonexistent-workspace\";\r\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\r\n\r\n      manager.on(\"init-start\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n\r\n      await manager.replayInit(workspaceId);\r\n\r\n      expect(events).toHaveLength(0);\r\n    });\r\n  });\r\n\r\n  describe(\"cleanup\", () => {\r\n    it(\"should delete persisted state from disk\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      await manager.endInit(workspaceId, 0);\r\n\r\n      // Verify state exists\r\n      const stateBeforeDelete = await manager.readInitStatus(workspaceId);\r\n      expect(stateBeforeDelete).toBeTruthy();\r\n\r\n      // Delete\r\n      await manager.deleteInitStatus(workspaceId);\r\n\r\n      // Verify deleted\r\n      const stateAfterDelete = await manager.readInitStatus(workspaceId);\r\n      expect(stateAfterDelete).toBeNull();\r\n    });\r\n\r\n    it(\"should clear in-memory state\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      expect(manager.getInitState(workspaceId)).toBeTruthy();\r\n\r\n      // Get the init promise before clearing\r\n      const initPromise = manager.waitForInit(workspaceId);\r\n\r\n      // Clear in-memory state (rejects internal promise, but waitForInit catches it)\r\n      manager.clearInMemoryState(workspaceId);\r\n\r\n      // Verify state is cleared\r\n      expect(manager.getInitState(workspaceId)).toBeUndefined();\r\n\r\n      // waitForInit never throws - it resolves even when init is canceled\r\n      // This allows tools to proceed and fail naturally with their own errors\r\n      // eslint-disable-next-line @typescript-eslint/await-thenable\r\n      await expect(initPromise).resolves.toBeUndefined();\r\n    });\r\n\r\n    it(\"should not recreate session directory if queued persistence runs after state is cleared\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      const sessionDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(sessionDir, { recursive: true });\r\n\r\n      let releaseLock: (() => void) | undefined;\r\n      const lockHeld = workspaceFileLocks.withLock(workspaceId, async () => {\r\n        await new Promise<void>((resolve) => {\r\n          releaseLock = resolve;\r\n        });\r\n      });\r\n\r\n      // Let the lock callback run so releaseLock is set.\r\n      await Promise.resolve();\r\n      if (!releaseLock) {\r\n        throw new Error(\"Expected workspace file lock to be held\");\r\n      }\r\n\r\n      // Queue endInit persistence behind the workspace file lock.\r\n      const endInitPromise = manager.endInit(workspaceId, 0);\r\n\r\n      // Simulate workspace removal: clear in-memory init state and delete the session directory.\r\n      manager.clearInMemoryState(workspaceId);\r\n      await fs.rm(sessionDir, { recursive: true, force: true });\r\n\r\n      // Allow queued persistence to proceed.\r\n      releaseLock();\r\n      await lockHeld;\r\n      await endInitPromise;\r\n\r\n      expect(await manager.readInitStatus(workspaceId)).toBeNull();\r\n\r\n      const sessionDirExists = await fs\r\n        .access(sessionDir)\r\n        .then(() => true)\r\n        .catch(() => false);\r\n      expect(sessionDirExists).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"error handling\", () => {\r\n    it(\"should handle appendOutput with no active state\", () => {\r\n      const workspaceId = \"nonexistent-workspace\";\r\n      // Should not throw\r\n      manager.appendOutput(workspaceId, \"Line\", false);\r\n    });\r\n\r\n    it(\"should handle endInit with no active state\", async () => {\r\n      const workspaceId = \"nonexistent-workspace\";\r\n      // Should not throw\r\n      await manager.endInit(workspaceId, 0);\r\n    });\r\n\r\n    it(\"should handle deleteInitStatus for nonexistent file\", async () => {\r\n      const workspaceId = \"nonexistent-workspace\";\r\n      // Should not throw\r\n      await manager.deleteInitStatus(workspaceId);\r\n    });\r\n  });\r\n\r\n  describe(\"truncation\", () => {\r\n    it(\"should truncate lines when exceeding INIT_HOOK_MAX_LINES\", () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      // Add more lines than the limit\r\n      const totalLines = INIT_HOOK_MAX_LINES + 100;\r\n      for (let i = 0; i < totalLines; i++) {\r\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\r\n      }\r\n\r\n      const state = manager.getInitState(workspaceId);\r\n      expect(state?.lines.length).toBe(INIT_HOOK_MAX_LINES);\r\n      expect(state?.truncatedLines).toBe(100);\r\n\r\n      // Should have the most recent lines (tail)\r\n      const lastLine = state?.lines[INIT_HOOK_MAX_LINES - 1];\r\n      expect(lastLine?.line).toBe(`Line ${totalLines - 1}`);\r\n\r\n      // First line should be from when truncation started\r\n      const firstLine = state?.lines[0];\r\n      expect(firstLine?.line).toBe(`Line 100`);\r\n    });\r\n\r\n    it(\"should include truncatedLines in init-end event\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\r\n\r\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      // Add more lines than the limit\r\n      for (let i = 0; i < INIT_HOOK_MAX_LINES + 50; i++) {\r\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\r\n      }\r\n\r\n      await manager.endInit(workspaceId, 0);\r\n\r\n      expect(events).toHaveLength(1);\r\n      expect((events[0] as { truncatedLines?: number }).truncatedLines).toBe(50);\r\n    });\r\n\r\n    it(\"should persist truncatedLines to disk\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      // Add more lines than the limit\r\n      for (let i = 0; i < INIT_HOOK_MAX_LINES + 25; i++) {\r\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\r\n      }\r\n\r\n      await manager.endInit(workspaceId, 0);\r\n\r\n      const diskState = await manager.readInitStatus(workspaceId);\r\n      expect(diskState?.truncatedLines).toBe(25);\r\n      expect(diskState?.lines.length).toBe(INIT_HOOK_MAX_LINES);\r\n    });\r\n\r\n    it(\"should not set truncatedLines when under limit\", () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      // Add fewer lines than the limit\r\n      for (let i = 0; i < 10; i++) {\r\n        manager.appendOutput(workspaceId, `Line ${i}`, false);\r\n      }\r\n\r\n      const state = manager.getInitState(workspaceId);\r\n      expect(state?.lines.length).toBe(10);\r\n      expect(state?.truncatedLines).toBeUndefined();\r\n    });\r\n\r\n    it(\"should truncate old persisted data on replay (backwards compat)\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const events: Array<WorkspaceInitEvent & { workspaceId: string }> = [];\r\n\r\n      // Manually write a large init-status.json to simulate old data\r\n      const sessionsDir = path.join(tempDir, \"sessions\", workspaceId);\r\n      await fs.mkdir(sessionsDir, { recursive: true });\r\n\r\n      const oldLineCount = INIT_HOOK_MAX_LINES + 200;\r\n      const oldStatus = {\r\n        status: \"success\",\r\n        hookPath: \"/path/to/hook\",\r\n        startTime: Date.now() - 1000,\r\n        lines: Array.from({ length: oldLineCount }, (_, i) => ({\r\n          line: `Old line ${i}`,\r\n          isError: false,\r\n          timestamp: Date.now() - 1000 + i,\r\n        })),\r\n        exitCode: 0,\r\n        endTime: Date.now(),\r\n        // No truncatedLines field - old format\r\n      };\r\n      await fs.writeFile(path.join(sessionsDir, \"init-status.json\"), JSON.stringify(oldStatus));\r\n\r\n      // Subscribe to events\r\n      manager.on(\"init-output\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n      manager.on(\"init-end\", (event: WorkspaceInitEvent & { workspaceId: string }) =>\r\n        events.push(event)\r\n      );\r\n\r\n      // Replay from disk\r\n      await manager.replayInit(workspaceId);\r\n\r\n      // Should only emit MAX_LINES output events (truncated)\r\n      const outputEvents = events.filter((e) => e.type === \"init-output\");\r\n      expect(outputEvents.length).toBe(INIT_HOOK_MAX_LINES);\r\n\r\n      // init-end should include truncatedLines count\r\n      const endEvent = events.find((e) => e.type === \"init-end\");\r\n      expect((endEvent as { truncatedLines?: number }).truncatedLines).toBe(200);\r\n\r\n      // First replayed line should be from the tail (old line 200)\r\n      expect((outputEvents[0] as { line: string }).line).toBe(\"Old line 200\");\r\n    });\r\n  });\r\n\r\n  describe(\"waitForInit hook phase\", () => {\r\n    it(\"should not time out during runtime setup (intentional)\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      const waitPromise = manager.waitForInit(workspaceId);\r\n      const result = await Promise.race([\r\n        waitPromise.then(() => \"done\"),\r\n        new Promise((resolve) => setTimeout(() => resolve(\"pending\"), 150)),\r\n      ]);\r\n\r\n      expect(result).toBe(\"pending\");\r\n\r\n      await manager.endInit(workspaceId, 0);\r\n      await waitPromise;\r\n    });\r\n\r\n    it(\"should start timeout once hook phase begins\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      manager.enterHookPhase(workspaceId);\r\n\r\n      const state = manager.getInitState(workspaceId);\r\n      if (!state) {\r\n        throw new Error(\"Expected init state to exist\");\r\n      }\r\n      state.hookStartTime = Date.now() - 5 * 60 * 1000 - 1000;\r\n\r\n      const waitPromise = manager.waitForInit(workspaceId);\r\n      const result = await Promise.race([\r\n        waitPromise.then(() => \"done\"),\r\n        new Promise((resolve) => setTimeout(() => resolve(\"pending\"), 150)),\r\n      ]);\r\n\r\n      expect(result).toBe(\"done\");\r\n\r\n      await manager.endInit(workspaceId, 0);\r\n      await waitPromise;\r\n    });\r\n\r\n    it(\"should set hookStartTime when entering hook phase\", () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n\r\n      manager.enterHookPhase(workspaceId);\r\n\r\n      const state = manager.getInitState(workspaceId);\r\n      if (!state) {\r\n        throw new Error(\"Expected init state to exist\");\r\n      }\r\n\r\n      expect(state.phase).toBe(\"init_hook\");\r\n      expect(state.hookStartTime).toBeDefined();\r\n      expect(typeof state.hookStartTime).toBe(\"number\");\r\n    });\r\n  });\r\n\r\n  describe(\"waitForInit with abortSignal\", () => {\r\n    it(\"should return immediately if abortSignal is already aborted\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      const controller = new AbortController();\r\n      controller.abort();\r\n\r\n      const start = Date.now();\r\n      await manager.waitForInit(workspaceId, controller.signal);\r\n      expect(Date.now() - start).toBeLessThan(200); // Should be instant\r\n    });\r\n\r\n    it(\"should return when abortSignal fires during wait\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      const controller = new AbortController();\r\n\r\n      const waitPromise = manager.waitForInit(workspaceId, controller.signal);\r\n      setTimeout(() => controller.abort(), 20);\r\n\r\n      const start = Date.now();\r\n      await waitPromise;\r\n      expect(Date.now() - start).toBeLessThan(300); // Should return quickly after abort\r\n    });\r\n\r\n    it(\"should clean up timeout when init completes first\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      const waitPromise = manager.waitForInit(workspaceId);\r\n\r\n      await manager.endInit(workspaceId, 0);\r\n      await waitPromise;\r\n      // No spurious timeout error should be logged (verify via log spy if needed)\r\n    });\r\n\r\n    it(\"should work without abortSignal (backwards compat)\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      manager.startInit(workspaceId, \"/path/to/hook\");\r\n      const waitPromise = manager.waitForInit(workspaceId);\r\n\r\n      // Complete init\r\n      await manager.endInit(workspaceId, 0);\r\n      await waitPromise;\r\n      // Should complete without error\r\n    });\r\n  });\r\n});\r\n"]}