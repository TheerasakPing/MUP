{"version":3,"file":"aiService.test.js","sourceRoot":"","sources":["../../../src/node/services/aiService.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Bun test file - doesn't support Jest mocking, so we skip this test for now\n// These tests would need to be rewritten to work with Bun's test runner\n// For now, the commandProcessor tests demonstrate our testing approach\n\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\n\nimport { describe, it, expect, beforeEach, afterEach, mock, spyOn } from \"bun:test\";\n\nimport { AIService } from \"./aiService\";\nimport { discoverAvailableSubagentsForToolContext } from \"./streamContextBuilder\";\nimport {\n  normalizeAnthropicBaseURL,\n  buildAnthropicHeaders,\n  buildAppAttributionHeaders,\n  ANTHROPIC_1M_CONTEXT_HEADER,\n  type ProviderModelFactory,\n} from \"./providerModelFactory\";\nimport { HistoryService } from \"./historyService\";\nimport { PartialService } from \"./partialService\";\nimport { InitStateManager } from \"./initStateManager\";\nimport { ProviderService } from \"./providerService\";\nimport { Config } from \"@/node/config\";\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\n\nimport { createTaskTool } from \"./tools/task\";\nimport { createTestToolConfig } from \"./tools/testHelpers\";\nimport { MUX_APP_ATTRIBUTION_TITLE, MUX_APP_ATTRIBUTION_URL } from \"@/constants/appAttribution\";\nimport { KNOWN_MODELS } from \"@/common/constants/knownModels\";\nimport type { CodexOauthService } from \"@/node/services/codexOauthService\";\nimport { CODEX_ENDPOINT } from \"@/common/constants/codexOAuth\";\n\nimport type { LanguageModel } from \"ai\";\nimport { createMuxMessage } from \"@/common/types/message\";\nimport type { MuxMessage } from \"@/common/types/message\";\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\nimport { DEFAULT_TASK_SETTINGS } from \"@/common/types/tasks\";\nimport type { StreamManager } from \"./streamManager\";\nimport * as agentResolution from \"./agentResolution\";\nimport * as streamContextBuilder from \"./streamContextBuilder\";\nimport * as messagePipeline from \"./messagePipeline\";\nimport * as toolsModule from \"@/common/utils/tools/tools\";\nimport * as systemMessageModule from \"./systemMessage\";\n\ndescribe(\"AIService\", () => {\n  let service: AIService;\n\n  beforeEach(() => {\n    const config = new Config();\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n    service = new AIService(\n      config,\n      historyService,\n      partialService,\n      initStateManager,\n      providerService\n    );\n  });\n\n  // Note: These tests are placeholders as Bun doesn't support Jest mocking\n  // In a production environment, we'd use dependency injection or other patterns\n  // to make the code more testable without mocking\n\n  it(\"should create an AIService instance\", () => {\n    expect(service).toBeDefined();\n    expect(service).toBeInstanceOf(AIService);\n  });\n});\n\ndescribe(\"AIService.resolveGatewayModelString\", () => {\n  async function writeMuxConfig(\n    root: string,\n    config: { muxGatewayEnabled?: boolean; muxGatewayModels?: string[] }\n  ): Promise<void> {\n    await fs.writeFile(\n      path.join(root, \"config.json\"),\n      JSON.stringify(\n        {\n          projects: [],\n          ...config,\n        },\n        null,\n        2\n      ),\n      \"utf-8\"\n    );\n  }\n\n  async function writeProvidersConfig(root: string, config: object): Promise<void> {\n    await fs.writeFile(\n      path.join(root, \"providers.jsonc\"),\n      JSON.stringify(config, null, 2),\n      \"utf-8\"\n    );\n  }\n\n  function toGatewayModelString(modelString: string): string {\n    const colonIndex = modelString.indexOf(\":\");\n    const provider = colonIndex === -1 ? modelString : modelString.slice(0, colonIndex);\n    const modelId = colonIndex === -1 ? \"\" : modelString.slice(colonIndex + 1);\n    return `mux-gateway:${provider}/${modelId}`;\n  }\n\n  function createService(root: string): AIService {\n    const config = new Config(root);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n    return new AIService(config, historyService, partialService, initStateManager, providerService);\n  }\n\n  it(\"routes allowlisted models when gateway is enabled + configured\", async () => {\n    using muxHome = new DisposableTempDir(\"gateway-routing\");\n\n    await writeMuxConfig(muxHome.path, {\n      muxGatewayEnabled: true,\n      muxGatewayModels: [KNOWN_MODELS.SONNET.id],\n    });\n    await writeProvidersConfig(muxHome.path, {\n      \"mux-gateway\": { couponCode: \"test-coupon\" },\n    });\n\n    const service = createService(muxHome.path);\n\n    // @ts-expect-error - accessing private field for testing\n    const resolved = service.providerModelFactory.resolveGatewayModelString(KNOWN_MODELS.SONNET.id);\n\n    expect(resolved).toBe(toGatewayModelString(KNOWN_MODELS.SONNET.id));\n  });\n\n  it(\"does not route when gateway is disabled\", async () => {\n    using muxHome = new DisposableTempDir(\"gateway-routing-disabled\");\n\n    await writeMuxConfig(muxHome.path, {\n      muxGatewayEnabled: false,\n      muxGatewayModels: [KNOWN_MODELS.SONNET.id],\n    });\n    await writeProvidersConfig(muxHome.path, {\n      \"mux-gateway\": { couponCode: \"test-coupon\" },\n    });\n\n    const service = createService(muxHome.path);\n\n    // @ts-expect-error - accessing private field for testing\n    const resolved = service.providerModelFactory.resolveGatewayModelString(KNOWN_MODELS.SONNET.id);\n\n    expect(resolved).toBe(KNOWN_MODELS.SONNET.id);\n  });\n\n  it(\"does not route when gateway is not configured\", async () => {\n    using muxHome = new DisposableTempDir(\"gateway-routing-unconfigured\");\n\n    await writeMuxConfig(muxHome.path, {\n      muxGatewayEnabled: true,\n      muxGatewayModels: [KNOWN_MODELS.SONNET.id],\n    });\n\n    const service = createService(muxHome.path);\n\n    // @ts-expect-error - accessing private field for testing\n    const resolved = service.providerModelFactory.resolveGatewayModelString(KNOWN_MODELS.SONNET.id);\n\n    expect(resolved).toBe(KNOWN_MODELS.SONNET.id);\n  });\n\n  it(\"does not route unsupported providers even when allowlisted\", async () => {\n    using muxHome = new DisposableTempDir(\"gateway-routing-unsupported-provider\");\n\n    const modelString = \"openrouter:some-model\";\n    await writeMuxConfig(muxHome.path, {\n      muxGatewayEnabled: true,\n      muxGatewayModels: [modelString],\n    });\n    await writeProvidersConfig(muxHome.path, {\n      \"mux-gateway\": { couponCode: \"test-coupon\" },\n    });\n\n    const service = createService(muxHome.path);\n\n    // @ts-expect-error - accessing private field for testing\n    const resolved = service.providerModelFactory.resolveGatewayModelString(modelString);\n\n    expect(resolved).toBe(modelString);\n  });\n\n  it(\"routes model variants when the base model is allowlisted via modelKey\", async () => {\n    using muxHome = new DisposableTempDir(\"gateway-routing-model-key\");\n\n    const variant = \"xai:grok-4-1-fast-reasoning\";\n    await writeMuxConfig(muxHome.path, {\n      muxGatewayEnabled: true,\n      muxGatewayModels: [KNOWN_MODELS.GROK_4_1.id],\n    });\n    await writeProvidersConfig(muxHome.path, {\n      \"mux-gateway\": { couponCode: \"test-coupon\" },\n    });\n\n    const service = createService(muxHome.path);\n\n    // @ts-expect-error - accessing private field for testing\n    const resolved = service.providerModelFactory.resolveGatewayModelString(\n      variant,\n      KNOWN_MODELS.GROK_4_1.id\n    );\n\n    expect(resolved).toBe(toGatewayModelString(variant));\n  });\n\n  it(\"honors explicit mux-gateway prefixes from legacy clients\", async () => {\n    using muxHome = new DisposableTempDir(\"gateway-routing-explicit\");\n\n    await writeMuxConfig(muxHome.path, {\n      muxGatewayEnabled: true,\n      muxGatewayModels: [],\n    });\n    await writeProvidersConfig(muxHome.path, {\n      \"mux-gateway\": { couponCode: \"test-coupon\" },\n    });\n\n    const service = createService(muxHome.path);\n\n    // @ts-expect-error - accessing private field for testing\n    const resolved = service.providerModelFactory.resolveGatewayModelString(\n      KNOWN_MODELS.GPT.id,\n      undefined,\n      true\n    );\n\n    expect(resolved).toBe(toGatewayModelString(KNOWN_MODELS.GPT.id));\n  });\n});\n\ndescribe(\"AIService.createModel (Codex OAuth routing)\", () => {\n  async function writeProvidersConfig(root: string, config: object): Promise<void> {\n    await fs.writeFile(\n      path.join(root, \"providers.jsonc\"),\n      JSON.stringify(config, null, 2),\n      \"utf-8\"\n    );\n  }\n\n  function createService(root: string): AIService {\n    const config = new Config(root);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n    return new AIService(config, historyService, partialService, initStateManager, providerService);\n  }\n\n  function getFetchUrl(input: Parameters<typeof fetch>[0]): string {\n    if (typeof input === \"string\") {\n      return input;\n    }\n    if (input instanceof URL) {\n      return input.toString();\n    }\n    if (typeof input === \"object\" && input !== null && \"url\" in input) {\n      const possibleUrl = (input as { url?: unknown }).url;\n      if (typeof possibleUrl === \"string\") {\n        return possibleUrl;\n      }\n    }\n    return \"\";\n  }\n\n  it(\"returns oauth_not_connected for required Codex models when both OAuth and API key are missing\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-missing\");\n\n    await writeProvidersConfig(muxHome.path, {\n      openai: {},\n    });\n\n    // Temporarily clear OPENAI_API_KEY so resolveProviderCredentials doesn't find it\n    const savedKey = process.env.OPENAI_API_KEY;\n    delete process.env.OPENAI_API_KEY;\n    try {\n      const service = createService(muxHome.path);\n      const result = await service.createModel(KNOWN_MODELS.GPT_52_CODEX.id);\n\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toEqual({ type: \"oauth_not_connected\", provider: \"openai\" });\n      }\n    } finally {\n      if (savedKey !== undefined) {\n        process.env.OPENAI_API_KEY = savedKey;\n      }\n    }\n  });\n\n  it(\"falls back to API key for required Codex models when OAuth is missing but API key is present\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-missing-apikey-present\");\n\n    await writeProvidersConfig(muxHome.path, {\n      openai: { apiKey: \"sk-test-key\" },\n    });\n\n    const service = createService(muxHome.path);\n    const result = await service.createModel(KNOWN_MODELS.GPT_52_CODEX.id);\n\n    // Should succeed â€” falls back to API key instead of erroring with oauth_not_connected\n    expect(result.success).toBe(true);\n  });\n\n  it(\"does not require an OpenAI API key when Codex OAuth is configured\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-present\");\n\n    await writeProvidersConfig(muxHome.path, {\n      openai: {\n        codexOauth: {\n          type: \"oauth\",\n          access: \"test-access-token\",\n          refresh: \"test-refresh-token\",\n          expires: Date.now() + 60_000,\n          accountId: \"test-account-id\",\n        },\n      },\n    });\n\n    const service = createService(muxHome.path);\n    const result = await service.createModel(KNOWN_MODELS.GPT_52_CODEX.id);\n\n    expect(result.success).toBe(true);\n  });\n\n  it(\"defaults OAuth-allowed models to ChatGPT OAuth when both auth methods are configured\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-default-auth-oauth\");\n\n    const config = new Config(muxHome.path);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n\n    const service = new AIService(\n      config,\n      historyService,\n      partialService,\n      initStateManager,\n      providerService\n    );\n\n    const requests: Array<{\n      input: Parameters<typeof fetch>[0];\n      init?: Parameters<typeof fetch>[1];\n    }> = [];\n\n    const baseFetch = (input: Parameters<typeof fetch>[0], init?: Parameters<typeof fetch>[1]) => {\n      requests.push({ input, init });\n\n      // Minimal valid OpenAI Responses payload for the provider's response schema.\n      const responseBody = {\n        id: \"resp_test\",\n        created_at: 0,\n        model: \"gpt-5.2\",\n        output: [\n          {\n            type: \"message\",\n            role: \"assistant\",\n            id: \"msg_test\",\n            content: [{ type: \"output_text\", text: \"ok\", annotations: [] }],\n          },\n        ],\n        usage: {\n          input_tokens: 1,\n          output_tokens: 1,\n        },\n      };\n\n      return Promise.resolve(\n        new Response(JSON.stringify(responseBody), {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json\",\n          },\n        })\n      );\n    };\n\n    // Ensure createModel sees a function fetch (providers.jsonc can't store functions).\n    config.loadProvidersConfig = () => ({\n      openai: {\n        apiKey: \"test-openai-api-key\",\n        codexOauth: {\n          type: \"oauth\",\n          access: \"test-access-token\",\n          refresh: \"test-refresh-token\",\n          expires: Date.now() + 60_000,\n          accountId: \"test-account-id\",\n        },\n        fetch: baseFetch,\n      },\n    });\n\n    // fetchWithOpenAITruncation closes over codexOauthService during createModel.\n    service.setCodexOauthService({\n      getValidAuth: () =>\n        Promise.resolve({\n          success: true,\n          data: {\n            type: \"oauth\",\n            access: \"test-access-token\",\n            refresh: \"test-refresh-token\",\n            expires: Date.now() + 60_000,\n            accountId: \"test-account-id\",\n          },\n        }),\n    } as CodexOauthService);\n\n    const modelResult = await service.createModel(KNOWN_MODELS.GPT.id);\n    expect(modelResult.success).toBe(true);\n    if (!modelResult.success) return;\n\n    const model = modelResult.data;\n    if (typeof model === \"string\") {\n      throw new Error(\"Expected a LanguageModelV2 instance, got a model id string\");\n    }\n\n    await model.doGenerate({\n      prompt: [\n        {\n          role: \"user\",\n          content: [{ type: \"text\", text: \"Hello\" }],\n        },\n      ],\n    });\n\n    expect(requests.length).toBeGreaterThan(0);\n    const lastRequest = requests[requests.length - 1];\n    expect(getFetchUrl(lastRequest.input)).toBe(CODEX_ENDPOINT);\n  });\n\n  it(\"does not rewrite OAuth-allowed models when default auth is set to apiKey\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-default-auth-api-key\");\n\n    const config = new Config(muxHome.path);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n\n    const service = new AIService(\n      config,\n      historyService,\n      partialService,\n      initStateManager,\n      providerService\n    );\n\n    const requests: Array<{\n      input: Parameters<typeof fetch>[0];\n      init?: Parameters<typeof fetch>[1];\n    }> = [];\n\n    const baseFetch = (input: Parameters<typeof fetch>[0], init?: Parameters<typeof fetch>[1]) => {\n      requests.push({ input, init });\n\n      // Minimal valid OpenAI Responses payload for the provider's response schema.\n      const responseBody = {\n        id: \"resp_test\",\n        created_at: 0,\n        model: \"gpt-5.2\",\n        output: [\n          {\n            type: \"message\",\n            role: \"assistant\",\n            id: \"msg_test\",\n            content: [{ type: \"output_text\", text: \"ok\", annotations: [] }],\n          },\n        ],\n        usage: {\n          input_tokens: 1,\n          output_tokens: 1,\n        },\n      };\n\n      return Promise.resolve(\n        new Response(JSON.stringify(responseBody), {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json\",\n          },\n        })\n      );\n    };\n\n    // Ensure createModel sees a function fetch (providers.jsonc can't store functions).\n    config.loadProvidersConfig = () => ({\n      openai: {\n        apiKey: \"test-openai-api-key\",\n        codexOauth: {\n          type: \"oauth\",\n          access: \"test-access-token\",\n          refresh: \"test-refresh-token\",\n          expires: Date.now() + 60_000,\n          accountId: \"test-account-id\",\n        },\n        codexOauthDefaultAuth: \"apiKey\",\n        fetch: baseFetch,\n      },\n    });\n\n    const modelResult = await service.createModel(KNOWN_MODELS.GPT.id);\n    expect(modelResult.success).toBe(true);\n    if (!modelResult.success) return;\n\n    const model = modelResult.data;\n    if (typeof model === \"string\") {\n      throw new Error(\"Expected a LanguageModelV2 instance, got a model id string\");\n    }\n\n    await model.doGenerate({\n      prompt: [\n        {\n          role: \"user\",\n          content: [{ type: \"text\", text: \"Hello\" }],\n        },\n      ],\n    });\n\n    expect(requests.length).toBeGreaterThan(0);\n    const lastRequest = requests[requests.length - 1];\n    expect(getFetchUrl(lastRequest.input)).not.toBe(CODEX_ENDPOINT);\n  });\n\n  it(\"ensures Codex OAuth routed Responses requests include non-empty instructions\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-instructions\");\n\n    const config = new Config(muxHome.path);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n\n    const service = new AIService(\n      config,\n      historyService,\n      partialService,\n      initStateManager,\n      providerService\n    );\n\n    const requests: Array<{\n      input: Parameters<typeof fetch>[0];\n      init?: Parameters<typeof fetch>[1];\n    }> = [];\n\n    const baseFetch = (input: Parameters<typeof fetch>[0], init?: Parameters<typeof fetch>[1]) => {\n      requests.push({ input, init });\n\n      // Minimal valid OpenAI Responses payload for the provider's response schema.\n      const responseBody = {\n        id: \"resp_test\",\n        created_at: 0,\n        model: \"gpt-5.2-codex\",\n        output: [\n          {\n            type: \"message\",\n            role: \"assistant\",\n            id: \"msg_test\",\n            content: [{ type: \"output_text\", text: \"ok\", annotations: [] }],\n          },\n        ],\n        usage: {\n          input_tokens: 1,\n          output_tokens: 1,\n        },\n      };\n\n      return Promise.resolve(\n        new Response(JSON.stringify(responseBody), {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json\",\n          },\n        })\n      );\n    };\n\n    // Ensure createModel sees a function fetch (providers.jsonc can't store functions).\n    config.loadProvidersConfig = () => ({\n      openai: {\n        apiKey: \"test-openai-api-key\",\n        codexOauth: {\n          type: \"oauth\",\n          access: \"test-access-token\",\n          refresh: \"test-refresh-token\",\n          expires: Date.now() + 60_000,\n          accountId: \"test-account-id\",\n        },\n        fetch: baseFetch,\n      },\n    });\n\n    // fetchWithOpenAITruncation closes over codexOauthService during createModel.\n    service.setCodexOauthService({\n      getValidAuth: () =>\n        Promise.resolve({\n          success: true,\n          data: {\n            type: \"oauth\",\n            access: \"test-access-token\",\n            refresh: \"test-refresh-token\",\n            expires: Date.now() + 60_000,\n            accountId: \"test-account-id\",\n          },\n        }),\n    } as CodexOauthService);\n\n    const modelResult = await service.createModel(KNOWN_MODELS.GPT_52_CODEX.id);\n    expect(modelResult.success).toBe(true);\n    if (!modelResult.success) return;\n\n    const model = modelResult.data;\n    if (typeof model === \"string\") {\n      throw new Error(\"Expected a LanguageModelV2 instance, got a model id string\");\n    }\n\n    const systemPrompt = \"Test system prompt\";\n\n    await model.doGenerate({\n      prompt: [\n        {\n          role: \"system\",\n          content: systemPrompt,\n        },\n        {\n          role: \"user\",\n          content: [{ type: \"text\", text: \"Hello\" }],\n        },\n      ],\n    });\n\n    expect(requests.length).toBeGreaterThan(0);\n\n    const lastRequest = requests[requests.length - 1];\n\n    // URL rewrite to chatgpt.com\n    expect(lastRequest.input).toBe(CODEX_ENDPOINT);\n\n    // Auth header injection\n    const headers = new Headers(lastRequest.init?.headers);\n    expect(headers.get(\"authorization\")).toBe(\"Bearer test-access-token\");\n    expect(headers.get(\"chatgpt-account-id\")).toBe(\"test-account-id\");\n\n    // Body mutation: non-empty instructions\n    const bodyString = lastRequest.init?.body;\n    expect(typeof bodyString).toBe(\"string\");\n    if (typeof bodyString !== \"string\") {\n      throw new Error(\"Expected request body to be a string\");\n    }\n\n    const parsedBody = JSON.parse(bodyString) as unknown;\n    if (!parsedBody || typeof parsedBody !== \"object\") {\n      throw new Error(\"Expected request body to parse as an object\");\n    }\n\n    const instructions = (parsedBody as { instructions?: unknown }).instructions;\n    expect(typeof instructions).toBe(\"string\");\n    if (typeof instructions !== \"string\") {\n      throw new Error(\"Expected instructions to be a string\");\n    }\n\n    expect(instructions.trim().length).toBeGreaterThan(0);\n    expect(instructions).toBe(systemPrompt);\n\n    // Codex endpoint requires store=false\n    const store = (parsedBody as { store?: unknown }).store;\n    expect(store).toBe(false);\n\n    // System message should be removed from input to avoid double-system\n    const input = (parsedBody as { input?: unknown[] }).input;\n    if (Array.isArray(input)) {\n      for (const item of input) {\n        if (item && typeof item === \"object\" && \"role\" in item) {\n          expect((item as { role: string }).role).not.toBe(\"system\");\n          expect((item as { role: string }).role).not.toBe(\"developer\");\n        }\n      }\n    }\n  });\n\n  it(\"filters out item_reference entries and preserves inline items when routing through Codex OAuth\", async () => {\n    using muxHome = new DisposableTempDir(\"codex-oauth-filter-refs\");\n\n    const config = new Config(muxHome.path);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n\n    const service = new AIService(\n      config,\n      historyService,\n      partialService,\n      initStateManager,\n      providerService\n    );\n\n    const requests: Array<{\n      input: Parameters<typeof fetch>[0];\n      init?: Parameters<typeof fetch>[1];\n    }> = [];\n\n    const baseFetch = (input: Parameters<typeof fetch>[0], init?: Parameters<typeof fetch>[1]) => {\n      requests.push({ input, init });\n\n      const responseBody = {\n        id: \"resp_test\",\n        created_at: 0,\n        model: \"gpt-5.2-codex\",\n        output: [\n          {\n            type: \"message\",\n            role: \"assistant\",\n            id: \"msg_test\",\n            content: [{ type: \"output_text\", text: \"ok\", annotations: [] }],\n          },\n        ],\n        usage: { input_tokens: 1, output_tokens: 1 },\n      };\n\n      return Promise.resolve(\n        new Response(JSON.stringify(responseBody), {\n          status: 200,\n          headers: { \"content-type\": \"application/json\" },\n        })\n      );\n    };\n\n    config.loadProvidersConfig = () => ({\n      openai: {\n        apiKey: \"test-openai-api-key\",\n        codexOauth: {\n          type: \"oauth\",\n          access: \"test-access-token\",\n          refresh: \"test-refresh-token\",\n          expires: Date.now() + 60_000,\n          accountId: \"test-account-id\",\n        },\n        fetch: baseFetch,\n      },\n    });\n\n    service.setCodexOauthService({\n      getValidAuth: () =>\n        Promise.resolve({\n          success: true,\n          data: {\n            type: \"oauth\",\n            access: \"test-access-token\",\n            refresh: \"test-refresh-token\",\n            expires: Date.now() + 60_000,\n            accountId: \"test-account-id\",\n          },\n        }),\n    } as CodexOauthService);\n\n    const modelResult = await service.createModel(KNOWN_MODELS.GPT_52_CODEX.id);\n    expect(modelResult.success).toBe(true);\n    if (!modelResult.success) return;\n\n    const model = modelResult.data;\n    if (typeof model === \"string\") {\n      throw new Error(\"Expected a LanguageModelV2 instance, got a model id string\");\n    }\n\n    await model.doGenerate({\n      prompt: [\n        { role: \"system\", content: \"You are a helpful assistant\" },\n        { role: \"user\", content: [{ type: \"text\", text: \"Hello\" }] },\n      ],\n    });\n\n    expect(requests.length).toBeGreaterThan(0);\n\n    const lastRequest = requests[requests.length - 1];\n    const bodyString = lastRequest.init?.body;\n    expect(typeof bodyString).toBe(\"string\");\n    if (typeof bodyString !== \"string\") {\n      throw new Error(\"Expected request body to be a string\");\n    }\n\n    const parsedBody = JSON.parse(bodyString) as { store?: boolean; input?: unknown[] };\n\n    // Verify Codex transform ran (store=false is set)\n    expect(parsedBody.store).toBe(false);\n\n    // Verify no item_reference entries exist in output\n    const input = parsedBody.input;\n    expect(Array.isArray(input)).toBe(true);\n    if (Array.isArray(input)) {\n      for (const item of input) {\n        if (item && typeof item === \"object\" && item !== null) {\n          expect((item as Record<string, unknown>).type).not.toBe(\"item_reference\");\n        }\n      }\n    }\n  });\n\n  it(\"item_reference filter removes references and preserves inline items\", () => {\n    // Direct unit test of the item_reference filtering logic used in the\n    // Codex body transformation, independent of the full AIService pipeline.\n    const input: Array<Record<string, unknown>> = [\n      { role: \"user\", content: [{ type: \"input_text\", text: \"hello\" }] },\n      { type: \"item_reference\", id: \"rs_abc123\" },\n      {\n        type: \"message\",\n        role: \"assistant\",\n        id: \"msg_001\",\n        content: [{ type: \"output_text\", text: \"hi\" }],\n      },\n      {\n        type: \"function_call\",\n        id: \"fc_xyz\",\n        call_id: \"call_1\",\n        name: \"test_fn\",\n        arguments: \"{}\",\n      },\n      { type: \"item_reference\", id: \"rs_def456\" },\n      { type: \"function_call_output\", call_id: \"call_1\", output: \"result\" },\n    ];\n\n    // Same filter logic as in aiService.ts Codex body transformation\n    const filtered = input.filter(\n      (item) => !(item && typeof item === \"object\" && item.type === \"item_reference\")\n    );\n\n    // Both item_reference entries removed\n    expect(filtered).toHaveLength(4);\n    expect(filtered.some((i) => i.type === \"item_reference\")).toBe(false);\n\n    // Inline items preserved with their IDs intact\n    expect(filtered.find((i) => i.role === \"assistant\")?.id).toBe(\"msg_001\");\n    expect(filtered.find((i) => i.type === \"function_call\")?.id).toBe(\"fc_xyz\");\n    expect(filtered.find((i) => i.type === \"function_call_output\")?.call_id).toBe(\"call_1\");\n    expect(filtered.find((i) => i.role === \"user\")).toBeDefined();\n  });\n});\n\ndescribe(\"AIService.streamMessage compaction boundary slicing\", () => {\n  interface StreamMessageHarness {\n    service: AIService;\n    planPayloadMessageIds: string[][];\n    preparedPayloadMessageIds: string[][];\n    startStreamCalls: unknown[][];\n  }\n\n  function createWorkspaceMetadata(workspaceId: string, projectPath: string): WorkspaceMetadata {\n    return {\n      id: workspaceId,\n      name: \"workspace-under-test\",\n      projectName: \"project-under-test\",\n      projectPath,\n      runtimeConfig: { type: \"local\" },\n    };\n  }\n\n  function messageIdsFromUnknownArray(messages: unknown): string[] {\n    if (!Array.isArray(messages)) {\n      throw new Error(\"Expected message array\");\n    }\n\n    return messages.map((message) => {\n      if (!message || typeof message !== \"object\") {\n        throw new Error(\"Expected message object in array\");\n      }\n\n      const id = (message as { id?: unknown }).id;\n      if (typeof id !== \"string\") {\n        throw new Error(\"Expected message.id to be a string\");\n      }\n\n      return id;\n    });\n  }\n\n  function openAIOptionsFromStartStreamCall(startStreamArgs: unknown[]): Record<string, unknown> {\n    const providerOptions = startStreamArgs[11];\n    if (!providerOptions || typeof providerOptions !== \"object\") {\n      throw new Error(\"Expected provider options object at startStream arg index 11\");\n    }\n\n    const openai = (providerOptions as { openai?: unknown }).openai;\n    if (!openai || typeof openai !== \"object\") {\n      throw new Error(\"Expected OpenAI provider options in startStream providerOptions\");\n    }\n\n    return openai as Record<string, unknown>;\n  }\n\n  function createHarness(muxHomePath: string, metadata: WorkspaceMetadata): StreamMessageHarness {\n    const config = new Config(muxHomePath);\n    const historyService = new HistoryService(config);\n    const partialService = new PartialService(config, historyService);\n    const initStateManager = new InitStateManager(config);\n    const providerService = new ProviderService(config);\n    const service = new AIService(\n      config,\n      historyService,\n      partialService,\n      initStateManager,\n      providerService\n    );\n\n    const planPayloadMessageIds: string[][] = [];\n    const preparedPayloadMessageIds: string[][] = [];\n    const startStreamCalls: unknown[][] = [];\n\n    const resolvedAgentResult: Awaited<ReturnType<typeof agentResolution.resolveAgentForStream>> = {\n      success: true,\n      data: {\n        effectiveAgentId: \"exec\",\n        agentDefinition: {\n          id: \"exec\",\n          scope: \"built-in\",\n          frontmatter: { name: \"Exec\" },\n          body: \"Exec agent body\",\n        },\n        agentDiscoveryPath: metadata.projectPath,\n        isSubagentWorkspace: false,\n        agentIsPlanLike: false,\n        effectiveMode: \"exec\",\n        taskSettings: DEFAULT_TASK_SETTINGS,\n        taskDepth: 0,\n        shouldDisableTaskToolsForDepth: false,\n        effectiveToolPolicy: undefined,\n        toolNamesForSentinel: [],\n      },\n    };\n    spyOn(agentResolution, \"resolveAgentForStream\").mockImplementation(() =>\n      Promise.resolve(resolvedAgentResult)\n    );\n\n    spyOn(streamContextBuilder, \"buildPlanInstructions\").mockImplementation((args) => {\n      planPayloadMessageIds.push(args.requestPayloadMessages.map((message) => message.id));\n\n      const planInstructionsResult: Awaited<\n        ReturnType<typeof streamContextBuilder.buildPlanInstructions>\n      > = {\n        effectiveAdditionalInstructions: undefined,\n        planFilePath: path.join(metadata.projectPath, \"plan.md\"),\n        planContentForTransition: undefined,\n      };\n\n      return Promise.resolve(planInstructionsResult);\n    });\n\n    spyOn(streamContextBuilder, \"buildStreamSystemContext\").mockResolvedValue({\n      agentSystemPrompt: \"test-agent-prompt\",\n      systemMessage: \"test-system-message\",\n      systemMessageTokens: 1,\n      agentDefinitions: undefined,\n      availableSkills: undefined,\n    });\n\n    spyOn(messagePipeline, \"prepareMessagesForProvider\").mockImplementation((args) => {\n      preparedPayloadMessageIds.push(args.messagesWithSentinel.map((message) => message.id));\n      const preparedMessages = args.messagesWithSentinel as unknown as Awaited<\n        ReturnType<typeof messagePipeline.prepareMessagesForProvider>\n      >;\n      return Promise.resolve(preparedMessages);\n    });\n\n    spyOn(toolsModule, \"getToolsForModel\").mockResolvedValue({});\n    spyOn(systemMessageModule, \"readToolInstructions\").mockResolvedValue({});\n\n    const fakeModel = Object.create(null) as LanguageModel;\n    const providerModelFactory = Reflect.get(service, \"providerModelFactory\") as\n      | ProviderModelFactory\n      | undefined;\n    if (!providerModelFactory) {\n      throw new Error(\"Expected AIService.providerModelFactory in streamMessage test harness\");\n    }\n\n    const resolveAndCreateModelResult: Awaited<\n      ReturnType<ProviderModelFactory[\"resolveAndCreateModel\"]>\n    > = {\n      success: true,\n      data: {\n        model: fakeModel,\n        effectiveModelString: \"openai:gpt-5.2\",\n        canonicalModelString: \"openai:gpt-5.2\",\n        canonicalProviderName: \"openai\",\n        canonicalModelId: \"gpt-5.2\",\n        routedThroughGateway: false,\n      },\n    };\n    spyOn(providerModelFactory, \"resolveAndCreateModel\").mockResolvedValue(\n      resolveAndCreateModelResult\n    );\n\n    spyOn(service, \"getWorkspaceMetadata\").mockResolvedValue({\n      success: true,\n      data: metadata,\n    });\n\n    spyOn(initStateManager, \"waitForInit\").mockResolvedValue(undefined);\n\n    spyOn(config, \"findWorkspace\").mockReturnValue({\n      workspacePath: metadata.projectPath,\n      projectPath: metadata.projectPath,\n    });\n\n    spyOn(partialService, \"commitToHistory\").mockResolvedValue({\n      success: true,\n      data: undefined,\n    });\n\n    spyOn(historyService, \"appendToHistory\").mockImplementation((_workspaceId, message) => {\n      message.metadata = {\n        ...(message.metadata ?? {}),\n        historySequence: 7,\n      };\n\n      return Promise.resolve({ success: true, data: undefined });\n    });\n\n    const streamManager = (service as unknown as { streamManager: StreamManager }).streamManager;\n    const streamToken = \"stream-token\" as ReturnType<StreamManager[\"generateStreamToken\"]>;\n\n    spyOn(streamManager, \"generateStreamToken\").mockReturnValue(streamToken);\n    spyOn(streamManager, \"createTempDirForStream\").mockResolvedValue(\n      path.join(metadata.projectPath, \".tmp-stream\")\n    );\n    spyOn(streamManager, \"isResponseIdLost\").mockReturnValue(false);\n    spyOn(streamManager, \"startStream\").mockImplementation((...args: unknown[]) => {\n      startStreamCalls.push(args);\n\n      const startStreamResult: Awaited<ReturnType<StreamManager[\"startStream\"]>> = {\n        success: true,\n        data: streamToken,\n      };\n\n      return Promise.resolve(startStreamResult);\n    });\n\n    return {\n      service,\n      planPayloadMessageIds,\n      preparedPayloadMessageIds,\n      startStreamCalls,\n    };\n  }\n\n  afterEach(() => {\n    mock.restore();\n  });\n\n  it(\"uses the latest durable boundary slice for provider payload and OpenAI derivations\", async () => {\n    using muxHome = new DisposableTempDir(\"ai-service-slice-latest-boundary\");\n    const projectPath = path.join(muxHome.path, \"project\");\n    await fs.mkdir(projectPath, { recursive: true });\n\n    const workspaceId = \"workspace-slice-latest\";\n    const metadata = createWorkspaceMetadata(workspaceId, projectPath);\n    const harness = createHarness(muxHome.path, metadata);\n\n    const messages: MuxMessage[] = [\n      createMuxMessage(\"boundary-1\", \"assistant\", \"compaction epoch 1\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n        model: \"openai:gpt-5.2\",\n      }),\n      createMuxMessage(\"assistant-old-response\", \"assistant\", \"older response\", {\n        model: \"openai:gpt-5.2\",\n        providerMetadata: { openai: { responseId: \"resp_epoch_1\" } },\n      }),\n      createMuxMessage(\n        \"start-here-summary\",\n        \"assistant\",\n        \"# Start Here\\n\\n- Existing plan context\\n\\n*Plan file preserved at:* /tmp/plan.md\",\n        {\n          compacted: \"user\",\n          agentId: \"plan\",\n        }\n      ),\n      createMuxMessage(\"mid-user\", \"user\", \"mid conversation\"),\n      createMuxMessage(\"boundary-2\", \"assistant\", \"compaction epoch 2\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 2,\n        model: \"openai:gpt-5.2\",\n      }),\n      createMuxMessage(\"latest-user\", \"user\", \"continue\"),\n    ];\n\n    const result = await harness.service.streamMessage({\n      messages,\n      workspaceId,\n      modelString: \"openai:gpt-5.2\",\n      thinkingLevel: \"medium\",\n    });\n\n    expect(result.success).toBe(true);\n    expect(harness.planPayloadMessageIds).toEqual([[\"boundary-2\", \"latest-user\"]]);\n    expect(harness.preparedPayloadMessageIds).toEqual([[\"boundary-2\", \"latest-user\"]]);\n    expect(harness.startStreamCalls).toHaveLength(1);\n\n    const startStreamCall = harness.startStreamCalls[0];\n    expect(startStreamCall).toBeDefined();\n    if (!startStreamCall) {\n      throw new Error(\"Expected streamManager.startStream call arguments\");\n    }\n\n    const startStreamMessageIds = messageIdsFromUnknownArray(startStreamCall[1]);\n    expect(startStreamMessageIds).toEqual([\"boundary-2\", \"latest-user\"]);\n\n    const openaiOptions = openAIOptionsFromStartStreamCall(startStreamCall);\n    expect(openaiOptions.previousResponseId).toBeUndefined();\n    expect(openaiOptions.promptCacheKey).toBe(`mux-v1-${workspaceId}`);\n  });\n\n  it(\"falls back safely when boundary metadata is malformed\", async () => {\n    using muxHome = new DisposableTempDir(\"ai-service-slice-malformed-boundary\");\n    const projectPath = path.join(muxHome.path, \"project\");\n    await fs.mkdir(projectPath, { recursive: true });\n\n    const workspaceId = \"workspace-slice-malformed\";\n    const metadata = createWorkspaceMetadata(workspaceId, projectPath);\n    const harness = createHarness(muxHome.path, metadata);\n\n    const messages: MuxMessage[] = [\n      createMuxMessage(\"assistant-before-malformed\", \"assistant\", \"response before malformed\", {\n        model: \"openai:gpt-5.2\",\n        providerMetadata: { openai: { responseId: \"resp_before_malformed\" } },\n      }),\n      createMuxMessage(\"malformed-boundary\", \"assistant\", \"not a durable boundary\", {\n        compacted: \"user\",\n        compactionBoundary: true,\n        // Invalid durable marker: must not truncate request payload.\n        compactionEpoch: 0,\n        model: \"openai:gpt-5.2\",\n      }),\n      createMuxMessage(\"latest-user\", \"user\", \"continue\"),\n    ];\n\n    const result = await harness.service.streamMessage({\n      messages,\n      workspaceId,\n      modelString: \"openai:gpt-5.2\",\n      thinkingLevel: \"medium\",\n    });\n\n    expect(result.success).toBe(true);\n    expect(harness.planPayloadMessageIds).toEqual([\n      [\"assistant-before-malformed\", \"malformed-boundary\", \"latest-user\"],\n    ]);\n    expect(harness.preparedPayloadMessageIds).toEqual([\n      [\"assistant-before-malformed\", \"malformed-boundary\", \"latest-user\"],\n    ]);\n    expect(harness.startStreamCalls).toHaveLength(1);\n\n    const startStreamCall = harness.startStreamCalls[0];\n    expect(startStreamCall).toBeDefined();\n    if (!startStreamCall) {\n      throw new Error(\"Expected streamManager.startStream call arguments\");\n    }\n\n    const startStreamMessageIds = messageIdsFromUnknownArray(startStreamCall[1]);\n    expect(startStreamMessageIds).toEqual([\n      \"assistant-before-malformed\",\n      \"malformed-boundary\",\n      \"latest-user\",\n    ]);\n\n    const openaiOptions = openAIOptionsFromStartStreamCall(startStreamCall);\n    expect(openaiOptions.previousResponseId).toBe(\"resp_before_malformed\");\n    expect(openaiOptions.promptCacheKey).toBe(`mux-v1-${workspaceId}`);\n  });\n});\n\ndescribe(\"normalizeAnthropicBaseURL\", () => {\n  it(\"appends /v1 to URLs without it\", () => {\n    expect(normalizeAnthropicBaseURL(\"https://api.anthropic.com\")).toBe(\n      \"https://api.anthropic.com/v1\"\n    );\n    expect(normalizeAnthropicBaseURL(\"https://custom-proxy.com\")).toBe(\n      \"https://custom-proxy.com/v1\"\n    );\n  });\n\n  it(\"preserves URLs already ending with /v1\", () => {\n    expect(normalizeAnthropicBaseURL(\"https://api.anthropic.com/v1\")).toBe(\n      \"https://api.anthropic.com/v1\"\n    );\n    expect(normalizeAnthropicBaseURL(\"https://custom-proxy.com/v1\")).toBe(\n      \"https://custom-proxy.com/v1\"\n    );\n  });\n\n  it(\"removes trailing slashes before appending /v1\", () => {\n    expect(normalizeAnthropicBaseURL(\"https://api.anthropic.com/\")).toBe(\n      \"https://api.anthropic.com/v1\"\n    );\n    expect(normalizeAnthropicBaseURL(\"https://api.anthropic.com///\")).toBe(\n      \"https://api.anthropic.com/v1\"\n    );\n  });\n\n  it(\"removes trailing slash after /v1\", () => {\n    expect(normalizeAnthropicBaseURL(\"https://api.anthropic.com/v1/\")).toBe(\n      \"https://api.anthropic.com/v1\"\n    );\n  });\n\n  it(\"handles URLs with ports\", () => {\n    expect(normalizeAnthropicBaseURL(\"http://localhost:8080\")).toBe(\"http://localhost:8080/v1\");\n    expect(normalizeAnthropicBaseURL(\"http://localhost:8080/v1\")).toBe(\"http://localhost:8080/v1\");\n  });\n\n  it(\"handles URLs with paths that include v1 in the middle\", () => {\n    // This should still append /v1 because the path doesn't END with /v1\n    expect(normalizeAnthropicBaseURL(\"https://proxy.com/api/v1-beta\")).toBe(\n      \"https://proxy.com/api/v1-beta/v1\"\n    );\n  });\n});\n\ndescribe(\"buildAnthropicHeaders\", () => {\n  it(\"returns undefined when use1MContext is false and no existing headers\", () => {\n    expect(buildAnthropicHeaders(undefined, false)).toBeUndefined();\n  });\n\n  it(\"returns existing headers unchanged when use1MContext is false\", () => {\n    const existing = { \"x-custom\": \"value\" };\n    expect(buildAnthropicHeaders(existing, false)).toBe(existing);\n  });\n\n  it(\"returns existing headers unchanged when use1MContext is undefined\", () => {\n    const existing = { \"x-custom\": \"value\" };\n    expect(buildAnthropicHeaders(existing, undefined)).toBe(existing);\n  });\n\n  it(\"adds 1M context header when use1MContext is true and no existing headers\", () => {\n    const result = buildAnthropicHeaders(undefined, true);\n    expect(result).toEqual({ \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER });\n  });\n\n  it(\"merges 1M context header with existing headers when use1MContext is true\", () => {\n    const existing = { \"x-custom\": \"value\" };\n    const result = buildAnthropicHeaders(existing, true);\n    expect(result).toEqual({\n      \"x-custom\": \"value\",\n      \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER,\n    });\n  });\n\n  it(\"overwrites existing anthropic-beta header when use1MContext is true\", () => {\n    const existing = { \"anthropic-beta\": \"other-beta\" };\n    const result = buildAnthropicHeaders(existing, true);\n    expect(result).toEqual({ \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER });\n  });\n});\n\ndescribe(\"buildAppAttributionHeaders\", () => {\n  it(\"adds both headers when no headers exist\", () => {\n    expect(buildAppAttributionHeaders(undefined)).toEqual({\n      \"HTTP-Referer\": MUX_APP_ATTRIBUTION_URL,\n      \"X-Title\": MUX_APP_ATTRIBUTION_TITLE,\n    });\n  });\n\n  it(\"adds only the missing header when one is present\", () => {\n    const existing = { \"HTTP-Referer\": \"https://example.com\" };\n    const result = buildAppAttributionHeaders(existing);\n    expect(result).toEqual({\n      \"HTTP-Referer\": \"https://example.com\",\n      \"X-Title\": MUX_APP_ATTRIBUTION_TITLE,\n    });\n  });\n\n  it(\"does not overwrite existing values (case-insensitive)\", () => {\n    const existing = { \"http-referer\": \"https://example.com\", \"X-TITLE\": \"My App\" };\n    const result = buildAppAttributionHeaders(existing);\n    expect(result).toEqual(existing);\n  });\n\n  it(\"preserves unrelated headers\", () => {\n    const existing = { \"x-custom\": \"value\" };\n    const result = buildAppAttributionHeaders(existing);\n    expect(result).toEqual({\n      \"x-custom\": \"value\",\n      \"HTTP-Referer\": MUX_APP_ATTRIBUTION_URL,\n      \"X-Title\": MUX_APP_ATTRIBUTION_TITLE,\n    });\n  });\n\n  it(\"does not mutate the input object\", () => {\n    const existing = { \"x-custom\": \"value\" };\n    const existingSnapshot = { ...existing };\n\n    buildAppAttributionHeaders(existing);\n\n    expect(existing).toEqual(existingSnapshot);\n  });\n});\n\ndescribe(\"discoverAvailableSubagentsForToolContext\", () => {\n  it(\"includes derived agents that inherit subagent.runnable from base\", async () => {\n    using project = new DisposableTempDir(\"available-subagents\");\n    using muxHome = new DisposableTempDir(\"available-subagents-home\");\n\n    const agentsRoot = path.join(project.path, \".mux\", \"agents\");\n    await fs.mkdir(agentsRoot, { recursive: true });\n\n    // Derived agent: base exec but no explicit subagent.runnable.\n    await fs.writeFile(\n      path.join(agentsRoot, \"custom.md\"),\n      `---\\nname: Custom Exec Derivative\\nbase: exec\\n---\\nBody\\n`,\n      \"utf-8\"\n    );\n\n    const runtime = new LocalRuntime(project.path);\n    const cfg = new Config(muxHome.path).loadConfigOrDefault();\n\n    const availableSubagents = await discoverAvailableSubagentsForToolContext({\n      runtime,\n      workspacePath: project.path,\n      cfg,\n      roots: {\n        projectRoot: agentsRoot,\n        globalRoot: path.join(project.path, \"empty-global-agents\"),\n      },\n    });\n\n    const custom = availableSubagents.find((agent) => agent.id === \"custom\");\n    expect(custom).toBeDefined();\n    expect(custom?.subagentRunnable).toBe(true);\n\n    // Ensure the task tool description includes the derived agent in the runnable sub-agent list.\n    const taskTool = createTaskTool({\n      ...createTestToolConfig(project.path, { workspaceId: \"test-workspace\" }),\n      availableSubagents,\n    });\n\n    const description = (taskTool as unknown as { description?: unknown }).description;\n    expect(typeof description).toBe(\"string\");\n    if (typeof description === \"string\") {\n      expect(description).toContain(\"Available sub-agents\");\n      expect(description).toContain(\"- custom\");\n    }\n  });\n});\n"]}