{"version":3,"file":"copilotOauthService.js","sourceRoot":"","sources":["../../../src/node/services/copilotOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as crypto from \"crypto\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Err, Ok } from \"@/common/types/result\";\r\nimport type { ProviderService } from \"@/node/services/providerService\";\r\nimport type { WindowService } from \"@/node/services/windowService\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\nconst GITHUB_COPILOT_CLIENT_ID = \"Ov23liCVKFN3jOo9R7HS\";\r\nconst SCOPE = \"read:user\";\r\nconst POLLING_SAFETY_MARGIN_MS = 3000;\r\nconst DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;\r\nconst COMPLETED_FLOW_TTL_MS = 60 * 1000;\r\n// Only surface top-tier model families from the Copilot API\r\nexport const COPILOT_MODEL_PREFIXES = [\"gpt-5\", \"claude-\", \"gemini-3\", \"grok-code\"];\r\n\r\nconst GITHUB_DEVICE_CODE_URL = \"https://github.com/login/device/code\";\r\nconst GITHUB_ACCESS_TOKEN_URL = \"https://github.com/login/oauth/access_token\";\r\nconst COPILOT_API_BASE_URL = \"https://api.githubcopilot.com\";\r\n\r\ninterface DeviceFlow {\r\n  flowId: string;\r\n  deviceCode: string;\r\n  interval: number;\r\n  cancelled: boolean;\r\n  timeout: ReturnType<typeof setTimeout>;\r\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\r\n  pollingStarted: boolean;\r\n  resultPromise: Promise<Result<void, string>>;\r\n  resolveResult: (result: Result<void, string>) => void;\r\n}\r\n\r\nexport class CopilotOauthService {\r\n  private readonly flows = new Map<string, DeviceFlow>();\r\n\r\n  constructor(\r\n    private readonly providerService: ProviderService,\r\n    private readonly windowService?: WindowService\r\n  ) {}\r\n\r\n  async startDeviceFlow(): Promise<\r\n    Result<{ flowId: string; verificationUri: string; userCode: string }, string>\r\n  > {\r\n    const flowId = crypto.randomUUID();\r\n\r\n    try {\r\n      const res = await fetch(GITHUB_DEVICE_CODE_URL, {\r\n        method: \"POST\",\r\n        headers: {\r\n          Accept: \"application/json\",\r\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        },\r\n        body: new URLSearchParams({\r\n          client_id: GITHUB_COPILOT_CLIENT_ID,\r\n          scope: SCOPE,\r\n        }),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const text = await res.text().catch(() => \"\");\r\n        return Err(`GitHub device code request failed (${res.status}): ${text}`);\r\n      }\r\n\r\n      const data = (await res.json()) as {\r\n        verification_uri?: string;\r\n        user_code?: string;\r\n        device_code?: string;\r\n        interval?: number;\r\n      };\r\n\r\n      if (!data.verification_uri || !data.user_code || !data.device_code) {\r\n        return Err(\"Invalid response from GitHub device code endpoint\");\r\n      }\r\n\r\n      // Create deferred promise\r\n      let resolveResult!: (result: Result<void, string>) => void;\r\n      const resultPromise = new Promise<Result<void, string>>((resolve) => {\r\n        resolveResult = resolve;\r\n      });\r\n\r\n      const timeout = setTimeout(() => {\r\n        void this.finishFlow(flowId, Err(\"Timed out waiting for GitHub authorization\"));\r\n      }, DEFAULT_TIMEOUT_MS);\r\n\r\n      this.flows.set(flowId, {\r\n        flowId,\r\n        deviceCode: data.device_code,\r\n        interval: data.interval ?? 5,\r\n        cancelled: false,\r\n        pollingStarted: false,\r\n        timeout,\r\n        cleanupTimeout: null,\r\n        resultPromise,\r\n        resolveResult,\r\n      });\r\n\r\n      log.debug(`Copilot OAuth device flow started (flowId=${flowId})`);\r\n\r\n      return Ok({\r\n        flowId,\r\n        verificationUri: data.verification_uri,\r\n        userCode: data.user_code,\r\n      });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to start device flow: ${message}`);\r\n    }\r\n  }\r\n\r\n  async waitForDeviceFlow(\r\n    flowId: string,\r\n    opts?: { timeoutMs?: number }\r\n  ): Promise<Result<void, string>> {\r\n    const flow = this.flows.get(flowId);\r\n    if (!flow) {\r\n      return Err(\"Device flow not found\");\r\n    }\r\n\r\n    // Start polling in background (guard against re-entrant calls, e.g. React StrictMode re-mount)\r\n    if (!flow.pollingStarted) {\r\n      flow.pollingStarted = true;\r\n      void this.pollForToken(flow);\r\n    }\r\n\r\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_TIMEOUT_MS;\r\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\r\n      timeoutHandle = setTimeout(() => {\r\n        resolve(Err(\"Timed out waiting for GitHub authorization\"));\r\n      }, timeoutMs);\r\n    });\r\n\r\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\r\n\r\n    if (timeoutHandle !== null) {\r\n      clearTimeout(timeoutHandle);\r\n    }\r\n\r\n    if (!result.success) {\r\n      void this.finishFlow(flowId, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  cancelDeviceFlow(flowId: string): void {\r\n    const flow = this.flows.get(flowId);\r\n    if (!flow) return;\r\n\r\n    log.debug(`Copilot OAuth device flow cancelled (flowId=${flowId})`);\r\n    this.finishFlow(flowId, Err(\"Device flow cancelled\"));\r\n  }\r\n\r\n  dispose(): void {\r\n    for (const flow of this.flows.values()) {\r\n      clearTimeout(flow.timeout);\r\n      if (flow.cleanupTimeout !== null) clearTimeout(flow.cleanupTimeout);\r\n      flow.cancelled = true;\r\n      try {\r\n        flow.resolveResult(Err(\"App shutting down\"));\r\n      } catch {\r\n        /* already resolved */\r\n      }\r\n    }\r\n    this.flows.clear();\r\n  }\r\n\r\n  private async pollForToken(flow: DeviceFlow): Promise<void> {\r\n    while (!flow.cancelled) {\r\n      try {\r\n        const res = await fetch(GITHUB_ACCESS_TOKEN_URL, {\r\n          method: \"POST\",\r\n          headers: {\r\n            Accept: \"application/json\",\r\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n          },\r\n          body: new URLSearchParams({\r\n            client_id: GITHUB_COPILOT_CLIENT_ID,\r\n            device_code: flow.deviceCode,\r\n            grant_type: \"urn:ietf:params:oauth:grant-type:device_code\",\r\n          }),\r\n        });\r\n\r\n        const data = (await res.json()) as {\r\n          access_token?: string;\r\n          error?: string;\r\n          interval?: number;\r\n        };\r\n\r\n        // Re-check cancellation after the fetch round-trip to avoid\r\n        // persisting credentials for a flow that was cancelled mid-request.\r\n        if (flow.cancelled) return;\r\n\r\n        if (data.access_token) {\r\n          // Store token as apiKey for the github-copilot provider\r\n          const persistResult = this.providerService.setConfig(\r\n            \"github-copilot\",\r\n            [\"apiKey\"],\r\n            data.access_token\r\n          );\r\n\r\n          if (!persistResult.success) {\r\n            void this.finishFlow(flow.flowId, Err(persistResult.error));\r\n            return;\r\n          }\r\n\r\n          // Fetch available models from Copilot API (best-effort, non-blocking on failure)\r\n          try {\r\n            const modelsRes = await fetch(`${COPILOT_API_BASE_URL}/models`, {\r\n              headers: {\r\n                Authorization: `Bearer ${data.access_token}`,\r\n                \"Openai-Intent\": \"conversation-edits\",\r\n                Accept: \"application/json\",\r\n              },\r\n            });\r\n\r\n            if (modelsRes.ok) {\r\n              const modelsData = (await modelsRes.json()) as {\r\n                data?: Array<{ id: string }>;\r\n              };\r\n              if (modelsData.data && modelsData.data.length > 0) {\r\n                const modelIds = modelsData.data\r\n                  .map((m) => m.id)\r\n                  .filter((id) => COPILOT_MODEL_PREFIXES.some((prefix) => id.startsWith(prefix)));\r\n                if (modelIds.length > 0) {\r\n                  this.providerService.setModels(\"github-copilot\", modelIds);\r\n                }\r\n              }\r\n            }\r\n          } catch (e) {\r\n            log.debug(\"Failed to fetch Copilot models after login\", e);\r\n          }\r\n\r\n          log.debug(`Copilot OAuth completed successfully (flowId=${flow.flowId})`);\r\n          this.windowService?.focusMainWindow();\r\n          void this.finishFlow(flow.flowId, Ok(undefined));\r\n          return;\r\n        }\r\n\r\n        if (data.error === \"authorization_pending\") {\r\n          // Expected during normal flow — will retry after sleep below\r\n        } else if (data.error === \"slow_down\") {\r\n          flow.interval = data.interval ?? flow.interval + 5;\r\n        } else if (data.error) {\r\n          // Any other error\r\n          void this.finishFlow(flow.flowId, Err(`GitHub OAuth error: ${data.error}`));\r\n          return;\r\n        }\r\n      } catch (error) {\r\n        if (flow.cancelled) return;\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        log.warn(`Copilot OAuth polling error (will retry): ${message}`);\r\n        // Transient errors — fall through to sleep, then retry\r\n      }\r\n\r\n      // Sleep before next iteration (placed at end so the first poll happens immediately)\r\n      await new Promise((resolve) =>\r\n        setTimeout(resolve, flow.interval * 1000 + POLLING_SAFETY_MARGIN_MS)\r\n      );\r\n    }\r\n  }\r\n\r\n  private finishFlow(flowId: string, result: Result<void, string>): void {\r\n    const flow = this.flows.get(flowId);\r\n    if (!flow || flow.cancelled) return;\r\n\r\n    flow.cancelled = true;\r\n    clearTimeout(flow.timeout);\r\n\r\n    try {\r\n      flow.resolveResult(result);\r\n    } catch {\r\n      // Already resolved\r\n    }\r\n\r\n    // Keep completed flow briefly so callers can still await\r\n    if (flow.cleanupTimeout !== null) {\r\n      clearTimeout(flow.cleanupTimeout);\r\n    }\r\n    flow.cleanupTimeout = setTimeout(() => {\r\n      this.flows.delete(flowId);\r\n    }, COMPLETED_FLOW_TTL_MS);\r\n  }\r\n}\r\n"]}