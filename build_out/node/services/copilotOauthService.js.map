{"version":3,"file":"copilotOauthService.js","sourceRoot":"","sources":["../../../src/node/services/copilotOauthService.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAY,MAAM,mCAAe;AAEjC,kDAAgD;AAGhD,6CAA0C;AAE1C,MAAM,wBAAwB,GAAG,sBAAsB,CAAC;AACxD,MAAM,KAAK,GAAG,WAAW,CAAC;AAC1B,MAAM,wBAAwB,GAAG,IAAI,CAAC;AACtC,MAAM,kBAAkB,GAAG,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC;AACzC,MAAM,qBAAqB,GAAG,EAAE,GAAG,IAAI,CAAC;AACxC,4DAA4D;AAC/C,QAAA,sBAAsB,GAAG,CAAC,OAAO,EAAE,SAAS,EAAE,UAAU,EAAE,WAAW,CAAC,CAAC;AAEpF,MAAM,sBAAsB,GAAG,sCAAsC,CAAC;AACtE,MAAM,uBAAuB,GAAG,6CAA6C,CAAC;AAC9E,MAAM,oBAAoB,GAAG,+BAA+B,CAAC;AAc7D;IAIqB,eAAe;IACf,aAAa;IAJf,KAAK,GAAG,IAAI,GAAG,EAAsB,CAAC;IAEvD,YACmB,eAAgC,EAChC,aAA6B,EAC9C;+BAFiB,eAAe;6BACf,aAAa;IAC7B,CAAC;IAEJ,KAAK,CAAC,eAAe,GAEnB;QACA,MAAM,MAAM,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;QAEnC,IAAI,CAAC;YACH,MAAM,GAAG,GAAG,MAAM,KAAK,CAAC,sBAAsB,EAAE;gBAC9C,MAAM,EAAE,MAAM;gBACd,OAAO,EAAE;oBACP,MAAM,EAAE,kBAAkB;oBAC1B,cAAc,EAAE,mCAAmC;iBACpD;gBACD,IAAI,EAAE,IAAI,eAAe,CAAC;oBACxB,SAAS,EAAE,wBAAwB;oBACnC,KAAK,EAAE,KAAK;iBACb,CAAC;aACH,CAAC,CAAC;YAEH,IAAI,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC;gBACZ,MAAM,IAAI,GAAG,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,CAAC;gBAC9C,OAAO,IAAA,YAAG,EAAC,sCAAsC,GAAG,CAAC,MAAM,MAAM,IAAI,EAAE,CAAC,CAAC;YAC3E,CAAC;YAED,MAAM,IAAI,GAAG,CAAC,MAAM,GAAG,CAAC,IAAI,EAAE,CAK7B,CAAC;YAEF,IAAI,CAAC,IAAI,CAAC,gBAAgB,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;gBACnE,OAAO,IAAA,YAAG,EAAC,mDAAmD,CAAC,CAAC;YAClE,CAAC;YAED,0BAA0B;YAC1B,IAAI,aAAsD,CAAC;YAC3D,MAAM,aAAa,GAAG,IAAI,OAAO,CAAuB,CAAC,OAAO,EAAE,EAAE,CAAC;gBACnE,aAAa,GAAG,OAAO,CAAC;YAAA,CACzB,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;gBAC/B,KAAK,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,IAAA,YAAG,EAAC,4CAA4C,CAAC,CAAC,CAAC;YAAA,CACjF,EAAE,kBAAkB,CAAC,CAAC;YAEvB,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE;gBACrB,MAAM;gBACN,UAAU,EAAE,IAAI,CAAC,WAAW;gBAC5B,QAAQ,EAAE,IAAI,CAAC,QAAQ,IAAI,CAAC;gBAC5B,SAAS,EAAE,KAAK;gBAChB,cAAc,EAAE,KAAK;gBACrB,OAAO;gBACP,cAAc,EAAE,IAAI;gBACpB,aAAa;gBACb,aAAa;aACd,CAAC,CAAC;YAEH,SAAG,CAAC,KAAK,CAAC,6CAA6C,MAAM,GAAG,CAAC,CAAC;YAElE,OAAO,IAAA,WAAE,EAAC;gBACR,MAAM;gBACN,eAAe,EAAE,IAAI,CAAC,gBAAgB;gBACtC,QAAQ,EAAE,IAAI,CAAC,SAAS;aACzB,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YACvE,OAAO,IAAA,YAAG,EAAC,gCAAgC,OAAO,EAAE,CAAC,CAAC;QACxD,CAAC;IAAA,CACF;IAED,KAAK,CAAC,iBAAiB,CACrB,MAAc,EACd,IAA6B,EACE;QAC/B,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACpC,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,OAAO,IAAA,YAAG,EAAC,uBAAuB,CAAC,CAAC;QACtC,CAAC;QAED,+FAA+F;QAC/F,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;YACzB,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC;YAC3B,KAAK,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QAC/B,CAAC;QAED,MAAM,SAAS,GAAG,IAAI,EAAE,SAAS,IAAI,kBAAkB,CAAC;QACxD,IAAI,aAAa,GAAyC,IAAI,CAAC;QAC/D,MAAM,cAAc,GAAG,IAAI,OAAO,CAAuB,CAAC,OAAO,EAAE,EAAE,CAAC;YACpE,aAAa,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;gBAC/B,OAAO,CAAC,IAAA,YAAG,EAAC,4CAA4C,CAAC,CAAC,CAAC;YAAA,CAC5D,EAAE,SAAS,CAAC,CAAC;QAAA,CACf,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,aAAa,EAAE,cAAc,CAAC,CAAC,CAAC;QAExE,IAAI,aAAa,KAAK,IAAI,EAAE,CAAC;YAC3B,YAAY,CAAC,aAAa,CAAC,CAAC;QAC9B,CAAC;QAED,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;YACpB,KAAK,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;QACvC,CAAC;QAED,OAAO,MAAM,CAAC;IAAA,CACf;IAED,gBAAgB,CAAC,MAAc,EAAQ;QACrC,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACpC,IAAI,CAAC,IAAI;YAAE,OAAO;QAElB,SAAG,CAAC,KAAK,CAAC,+CAA+C,MAAM,GAAG,CAAC,CAAC;QACpE,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,IAAA,YAAG,EAAC,uBAAuB,CAAC,CAAC,CAAC;IAAA,CACvD;IAED,OAAO,GAAS;QACd,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,EAAE,CAAC;YACvC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC3B,IAAI,IAAI,CAAC,cAAc,KAAK,IAAI;gBAAE,YAAY,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;YACpE,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;YACtB,IAAI,CAAC;gBACH,IAAI,CAAC,aAAa,CAAC,IAAA,YAAG,EAAC,mBAAmB,CAAC,CAAC,CAAC;YAC/C,CAAC;YAAC,MAAM,CAAC;gBACP,sBAAsB;YACxB,CAAC;QACH,CAAC;QACD,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC;IAAA,CACpB;IAEO,KAAK,CAAC,YAAY,CAAC,IAAgB,EAAiB;QAC1D,OAAO,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;YACvB,IAAI,CAAC;gBACH,MAAM,GAAG,GAAG,MAAM,KAAK,CAAC,uBAAuB,EAAE;oBAC/C,MAAM,EAAE,MAAM;oBACd,OAAO,EAAE;wBACP,MAAM,EAAE,kBAAkB;wBAC1B,cAAc,EAAE,mCAAmC;qBACpD;oBACD,IAAI,EAAE,IAAI,eAAe,CAAC;wBACxB,SAAS,EAAE,wBAAwB;wBACnC,WAAW,EAAE,IAAI,CAAC,UAAU;wBAC5B,UAAU,EAAE,8CAA8C;qBAC3D,CAAC;iBACH,CAAC,CAAC;gBAEH,MAAM,IAAI,GAAG,CAAC,MAAM,GAAG,CAAC,IAAI,EAAE,CAI7B,CAAC;gBAEF,4DAA4D;gBAC5D,oEAAoE;gBACpE,IAAI,IAAI,CAAC,SAAS;oBAAE,OAAO;gBAE3B,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;oBACtB,wDAAwD;oBACxD,MAAM,aAAa,GAAG,IAAI,CAAC,eAAe,CAAC,SAAS,CAClD,gBAAgB,EAChB,CAAC,QAAQ,CAAC,EACV,IAAI,CAAC,YAAY,CAClB,CAAC;oBAEF,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC;wBAC3B,KAAK,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,EAAE,IAAA,YAAG,EAAC,aAAa,CAAC,KAAK,CAAC,CAAC,CAAC;wBAC5D,OAAO;oBACT,CAAC;oBAED,iFAAiF;oBACjF,IAAI,CAAC;wBACH,MAAM,SAAS,GAAG,MAAM,KAAK,CAAC,GAAG,oBAAoB,SAAS,EAAE;4BAC9D,OAAO,EAAE;gCACP,aAAa,EAAE,UAAU,IAAI,CAAC,YAAY,EAAE;gCAC5C,eAAe,EAAE,oBAAoB;gCACrC,MAAM,EAAE,kBAAkB;6BAC3B;yBACF,CAAC,CAAC;wBAEH,IAAI,SAAS,CAAC,EAAE,EAAE,CAAC;4BACjB,MAAM,UAAU,GAAG,CAAC,MAAM,SAAS,CAAC,IAAI,EAAE,CAEzC,CAAC;4BACF,IAAI,UAAU,CAAC,IAAI,IAAI,UAAU,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gCAClD,MAAM,QAAQ,GAAG,UAAU,CAAC,IAAI;qCAC7B,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;qCAChB,MAAM,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,QAAA,sBAAsB,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;gCAClF,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oCACxB,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,gBAAgB,EAAE,QAAQ,CAAC,CAAC;gCAC7D,CAAC;4BACH,CAAC;wBACH,CAAC;oBACH,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACX,SAAG,CAAC,KAAK,CAAC,4CAA4C,EAAE,CAAC,CAAC,CAAC;oBAC7D,CAAC;oBAED,SAAG,CAAC,KAAK,CAAC,gDAAgD,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC;oBAC1E,IAAI,CAAC,aAAa,EAAE,eAAe,EAAE,CAAC;oBACtC,KAAK,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,EAAE,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;oBACjD,OAAO;gBACT,CAAC;gBAED,IAAI,IAAI,CAAC,KAAK,KAAK,uBAAuB,EAAE,CAAC;oBAC3C,+DAA6D;gBAC/D,CAAC;qBAAM,IAAI,IAAI,CAAC,KAAK,KAAK,WAAW,EAAE,CAAC;oBACtC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAC;gBACrD,CAAC;qBAAM,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;oBACtB,kBAAkB;oBAClB,KAAK,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,EAAE,IAAA,YAAG,EAAC,uBAAuB,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;oBAC5E,OAAO;gBACT,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,IAAI,CAAC,SAAS;oBAAE,OAAO;gBAC3B,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBACvE,SAAG,CAAC,IAAI,CAAC,6CAA6C,OAAO,EAAE,CAAC,CAAC;gBACjE,yDAAuD;YACzD,CAAC;YAED,oFAAoF;YACpF,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAC5B,UAAU,CAAC,OAAO,EAAE,IAAI,CAAC,QAAQ,GAAG,IAAI,GAAG,wBAAwB,CAAC,CACrE,CAAC;QACJ,CAAC;IAAA,CACF;IAEO,UAAU,CAAC,MAAc,EAAE,MAA4B,EAAQ;QACrE,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACpC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,SAAS;YAAE,OAAO;QAEpC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAE3B,IAAI,CAAC;YACH,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;QAC7B,CAAC;QAAC,MAAM,CAAC;YACP,mBAAmB;QACrB,CAAC;QAED,yDAAyD;QACzD,IAAI,IAAI,CAAC,cAAc,KAAK,IAAI,EAAE,CAAC;YACjC,YAAY,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACpC,CAAC;QACD,IAAI,CAAC,cAAc,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;YACrC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAAA,CAC3B,EAAE,qBAAqB,CAAC,CAAC;IAAA,CAC3B;CACF","sourcesContent":["import * as crypto from \"crypto\";\nimport type { Result } from \"@/common/types/result\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport type { ProviderService } from \"@/node/services/providerService\";\nimport type { WindowService } from \"@/node/services/windowService\";\nimport { log } from \"@/node/services/log\";\n\nconst GITHUB_COPILOT_CLIENT_ID = \"Ov23liCVKFN3jOo9R7HS\";\nconst SCOPE = \"read:user\";\nconst POLLING_SAFETY_MARGIN_MS = 3000;\nconst DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;\nconst COMPLETED_FLOW_TTL_MS = 60 * 1000;\n// Only surface top-tier model families from the Copilot API\nexport const COPILOT_MODEL_PREFIXES = [\"gpt-5\", \"claude-\", \"gemini-3\", \"grok-code\"];\n\nconst GITHUB_DEVICE_CODE_URL = \"https://github.com/login/device/code\";\nconst GITHUB_ACCESS_TOKEN_URL = \"https://github.com/login/oauth/access_token\";\nconst COPILOT_API_BASE_URL = \"https://api.githubcopilot.com\";\n\ninterface DeviceFlow {\n  flowId: string;\n  deviceCode: string;\n  interval: number;\n  cancelled: boolean;\n  timeout: ReturnType<typeof setTimeout>;\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\n  pollingStarted: boolean;\n  resultPromise: Promise<Result<void, string>>;\n  resolveResult: (result: Result<void, string>) => void;\n}\n\nexport class CopilotOauthService {\n  private readonly flows = new Map<string, DeviceFlow>();\n\n  constructor(\n    private readonly providerService: ProviderService,\n    private readonly windowService?: WindowService\n  ) {}\n\n  async startDeviceFlow(): Promise<\n    Result<{ flowId: string; verificationUri: string; userCode: string }, string>\n  > {\n    const flowId = crypto.randomUUID();\n\n    try {\n      const res = await fetch(GITHUB_DEVICE_CODE_URL, {\n        method: \"POST\",\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: new URLSearchParams({\n          client_id: GITHUB_COPILOT_CLIENT_ID,\n          scope: SCOPE,\n        }),\n      });\n\n      if (!res.ok) {\n        const text = await res.text().catch(() => \"\");\n        return Err(`GitHub device code request failed (${res.status}): ${text}`);\n      }\n\n      const data = (await res.json()) as {\n        verification_uri?: string;\n        user_code?: string;\n        device_code?: string;\n        interval?: number;\n      };\n\n      if (!data.verification_uri || !data.user_code || !data.device_code) {\n        return Err(\"Invalid response from GitHub device code endpoint\");\n      }\n\n      // Create deferred promise\n      let resolveResult!: (result: Result<void, string>) => void;\n      const resultPromise = new Promise<Result<void, string>>((resolve) => {\n        resolveResult = resolve;\n      });\n\n      const timeout = setTimeout(() => {\n        void this.finishFlow(flowId, Err(\"Timed out waiting for GitHub authorization\"));\n      }, DEFAULT_TIMEOUT_MS);\n\n      this.flows.set(flowId, {\n        flowId,\n        deviceCode: data.device_code,\n        interval: data.interval ?? 5,\n        cancelled: false,\n        pollingStarted: false,\n        timeout,\n        cleanupTimeout: null,\n        resultPromise,\n        resolveResult,\n      });\n\n      log.debug(`Copilot OAuth device flow started (flowId=${flowId})`);\n\n      return Ok({\n        flowId,\n        verificationUri: data.verification_uri,\n        userCode: data.user_code,\n      });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Failed to start device flow: ${message}`);\n    }\n  }\n\n  async waitForDeviceFlow(\n    flowId: string,\n    opts?: { timeoutMs?: number }\n  ): Promise<Result<void, string>> {\n    const flow = this.flows.get(flowId);\n    if (!flow) {\n      return Err(\"Device flow not found\");\n    }\n\n    // Start polling in background (guard against re-entrant calls, e.g. React StrictMode re-mount)\n    if (!flow.pollingStarted) {\n      flow.pollingStarted = true;\n      void this.pollForToken(flow);\n    }\n\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_TIMEOUT_MS;\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\n      timeoutHandle = setTimeout(() => {\n        resolve(Err(\"Timed out waiting for GitHub authorization\"));\n      }, timeoutMs);\n    });\n\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\n\n    if (timeoutHandle !== null) {\n      clearTimeout(timeoutHandle);\n    }\n\n    if (!result.success) {\n      void this.finishFlow(flowId, result);\n    }\n\n    return result;\n  }\n\n  cancelDeviceFlow(flowId: string): void {\n    const flow = this.flows.get(flowId);\n    if (!flow) return;\n\n    log.debug(`Copilot OAuth device flow cancelled (flowId=${flowId})`);\n    this.finishFlow(flowId, Err(\"Device flow cancelled\"));\n  }\n\n  dispose(): void {\n    for (const flow of this.flows.values()) {\n      clearTimeout(flow.timeout);\n      if (flow.cleanupTimeout !== null) clearTimeout(flow.cleanupTimeout);\n      flow.cancelled = true;\n      try {\n        flow.resolveResult(Err(\"App shutting down\"));\n      } catch {\n        /* already resolved */\n      }\n    }\n    this.flows.clear();\n  }\n\n  private async pollForToken(flow: DeviceFlow): Promise<void> {\n    while (!flow.cancelled) {\n      try {\n        const res = await fetch(GITHUB_ACCESS_TOKEN_URL, {\n          method: \"POST\",\n          headers: {\n            Accept: \"application/json\",\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n          },\n          body: new URLSearchParams({\n            client_id: GITHUB_COPILOT_CLIENT_ID,\n            device_code: flow.deviceCode,\n            grant_type: \"urn:ietf:params:oauth:grant-type:device_code\",\n          }),\n        });\n\n        const data = (await res.json()) as {\n          access_token?: string;\n          error?: string;\n          interval?: number;\n        };\n\n        // Re-check cancellation after the fetch round-trip to avoid\n        // persisting credentials for a flow that was cancelled mid-request.\n        if (flow.cancelled) return;\n\n        if (data.access_token) {\n          // Store token as apiKey for the github-copilot provider\n          const persistResult = this.providerService.setConfig(\n            \"github-copilot\",\n            [\"apiKey\"],\n            data.access_token\n          );\n\n          if (!persistResult.success) {\n            void this.finishFlow(flow.flowId, Err(persistResult.error));\n            return;\n          }\n\n          // Fetch available models from Copilot API (best-effort, non-blocking on failure)\n          try {\n            const modelsRes = await fetch(`${COPILOT_API_BASE_URL}/models`, {\n              headers: {\n                Authorization: `Bearer ${data.access_token}`,\n                \"Openai-Intent\": \"conversation-edits\",\n                Accept: \"application/json\",\n              },\n            });\n\n            if (modelsRes.ok) {\n              const modelsData = (await modelsRes.json()) as {\n                data?: Array<{ id: string }>;\n              };\n              if (modelsData.data && modelsData.data.length > 0) {\n                const modelIds = modelsData.data\n                  .map((m) => m.id)\n                  .filter((id) => COPILOT_MODEL_PREFIXES.some((prefix) => id.startsWith(prefix)));\n                if (modelIds.length > 0) {\n                  this.providerService.setModels(\"github-copilot\", modelIds);\n                }\n              }\n            }\n          } catch (e) {\n            log.debug(\"Failed to fetch Copilot models after login\", e);\n          }\n\n          log.debug(`Copilot OAuth completed successfully (flowId=${flow.flowId})`);\n          this.windowService?.focusMainWindow();\n          void this.finishFlow(flow.flowId, Ok(undefined));\n          return;\n        }\n\n        if (data.error === \"authorization_pending\") {\n          // Expected during normal flow — will retry after sleep below\n        } else if (data.error === \"slow_down\") {\n          flow.interval = data.interval ?? flow.interval + 5;\n        } else if (data.error) {\n          // Any other error\n          void this.finishFlow(flow.flowId, Err(`GitHub OAuth error: ${data.error}`));\n          return;\n        }\n      } catch (error) {\n        if (flow.cancelled) return;\n        const message = error instanceof Error ? error.message : String(error);\n        log.warn(`Copilot OAuth polling error (will retry): ${message}`);\n        // Transient errors — fall through to sleep, then retry\n      }\n\n      // Sleep before next iteration (placed at end so the first poll happens immediately)\n      await new Promise((resolve) =>\n        setTimeout(resolve, flow.interval * 1000 + POLLING_SAFETY_MARGIN_MS)\n      );\n    }\n  }\n\n  private finishFlow(flowId: string, result: Result<void, string>): void {\n    const flow = this.flows.get(flowId);\n    if (!flow || flow.cancelled) return;\n\n    flow.cancelled = true;\n    clearTimeout(flow.timeout);\n\n    try {\n      flow.resolveResult(result);\n    } catch {\n      // Already resolved\n    }\n\n    // Keep completed flow briefly so callers can still await\n    if (flow.cleanupTimeout !== null) {\n      clearTimeout(flow.cleanupTimeout);\n    }\n    flow.cleanupTimeout = setTimeout(() => {\n      this.flows.delete(flowId);\n    }, COMPLETED_FLOW_TTL_MS);\n  }\n}\n"]}