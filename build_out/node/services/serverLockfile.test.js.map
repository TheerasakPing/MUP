{"version":3,"file":"serverLockfile.test.js","sourceRoot":"","sources":["../../../src/node/services/serverLockfile.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { ServerLockfile } from \"./serverLockfile\";\r\n\r\ndescribe(\"ServerLockfile\", () => {\r\n  let tempDir: string;\r\n  let lockfile: ServerLockfile;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-lock-test-\"));\r\n    lockfile = new ServerLockfile(tempDir);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  test(\"acquire creates lockfile with correct data\", async () => {\r\n    await lockfile.acquire(\"http://localhost:12345\", \"test-token\");\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.baseUrl).toBe(\"http://localhost:12345\");\r\n    expect(data!.token).toBe(\"test-token\");\r\n    expect(data!.pid).toBe(process.pid);\r\n    expect(data!.startedAt).toBeDefined();\r\n  });\r\n\r\n  test(\"acquire persists optional network metadata\", async () => {\r\n    await lockfile.acquire(\"http://localhost:12345\", \"test-token\", {\r\n      bindHost: \"0.0.0.0\",\r\n      port: 12345,\r\n      networkBaseUrls: [\"http://192.168.1.10:12345\"],\r\n    });\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.bindHost).toBe(\"0.0.0.0\");\r\n    expect(data!.port).toBe(12345);\r\n    expect(data!.networkBaseUrls).toEqual([\"http://192.168.1.10:12345\"]);\r\n  });\r\n\r\n  test(\"read returns null for non-existent lockfile\", async () => {\r\n    const data = await lockfile.read();\r\n    expect(data).toBeNull();\r\n  });\r\n\r\n  test(\"read returns null for stale lockfile (dead PID)\", async () => {\r\n    const lockPath = lockfile.getLockPath();\r\n\r\n    // Write lockfile with fake dead PID\r\n    await fs.writeFile(\r\n      lockPath,\r\n      JSON.stringify({\r\n        pid: 999999999, // Very unlikely to be a real PID\r\n        baseUrl: \"http://localhost:12345\",\r\n        token: \"test-token\",\r\n        startedAt: new Date().toISOString(),\r\n      })\r\n    );\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).toBeNull();\r\n\r\n    // Stale lockfile should be cleaned up\r\n    let exists = true;\r\n    try {\r\n      await fs.access(lockPath);\r\n    } catch {\r\n      exists = false;\r\n    }\r\n    expect(exists).toBe(false);\r\n  });\r\n\r\n  test(\"read returns data for lockfile with current PID\", async () => {\r\n    await lockfile.acquire(\"http://127.0.0.1:54321\", \"valid-token\");\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.baseUrl).toBe(\"http://127.0.0.1:54321\");\r\n    expect(data!.token).toBe(\"valid-token\");\r\n  });\r\n\r\n  test(\"release removes lockfile\", async () => {\r\n    await lockfile.acquire(\"http://localhost:12345\", \"test-token\");\r\n    const lockPath = lockfile.getLockPath();\r\n\r\n    let exists = true;\r\n    try {\r\n      await fs.access(lockPath);\r\n    } catch {\r\n      exists = false;\r\n    }\r\n    expect(exists).toBe(true);\r\n\r\n    await lockfile.release();\r\n\r\n    try {\r\n      await fs.access(lockPath);\r\n      exists = true;\r\n    } catch {\r\n      exists = false;\r\n    }\r\n    expect(exists).toBe(false);\r\n  });\r\n\r\n  test(\"release is idempotent (no error if file doesn't exist)\", async () => {\r\n    // Should not throw\r\n    await lockfile.release();\r\n    await lockfile.release();\r\n  });\r\n\r\n  test(\"lockfile has restrictive permissions on unix\", async () => {\r\n    // Skip on Windows where file permissions work differently\r\n    if (process.platform === \"win32\") {\r\n      return;\r\n    }\r\n\r\n    await lockfile.acquire(\"http://localhost:12345\", \"test-token\");\r\n    const lockPath = lockfile.getLockPath();\r\n    const stats = await fs.stat(lockPath);\r\n\r\n    // 0o600 = owner read/write only\r\n    expect(stats.mode & 0o777).toBe(0o600);\r\n  });\r\n\r\n  test(\"acquire overwrites existing lockfile\", async () => {\r\n    await lockfile.acquire(\"http://localhost:11111\", \"first-token\");\r\n    await lockfile.acquire(\"https://my.machine.local/mux\", \"second-token\");\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.baseUrl).toBe(\"https://my.machine.local/mux\");\r\n    expect(data!.token).toBe(\"second-token\");\r\n  });\r\n\r\n  test(\"read handles corrupted lockfile gracefully\", async () => {\r\n    const lockPath = lockfile.getLockPath();\r\n    await fs.writeFile(lockPath, \"not valid json\");\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).toBeNull();\r\n  });\r\n\r\n  test(\"acquire creates parent directory if it doesn't exist\", async () => {\r\n    const nestedDir = path.join(tempDir, \"nested\", \"dir\");\r\n    const nestedLockfile = new ServerLockfile(nestedDir);\r\n\r\n    await nestedLockfile.acquire(\"http://localhost:12345\", \"test-token\");\r\n\r\n    const data = await nestedLockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.baseUrl).toBe(\"http://localhost:12345\");\r\n  });\r\n\r\n  test(\"getLockPath returns correct path\", () => {\r\n    const expectedPath = path.join(tempDir, \"server.lock\");\r\n    expect(lockfile.getLockPath()).toBe(expectedPath);\r\n  });\r\n\r\n  test(\"supports HTTPS URLs\", async () => {\r\n    await lockfile.acquire(\"https://secure.example.com:8443/api\", \"secure-token\");\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.baseUrl).toBe(\"https://secure.example.com:8443/api\");\r\n  });\r\n\r\n  test(\"supports URLs with path prefixes\", async () => {\r\n    await lockfile.acquire(\"https://my.machine.local/mux/\", \"path-token\");\r\n\r\n    const data = await lockfile.read();\r\n    expect(data).not.toBeNull();\r\n    expect(data!.baseUrl).toBe(\"https://my.machine.local/mux/\");\r\n  });\r\n});\r\n"]}