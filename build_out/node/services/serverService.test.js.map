{"version":3,"file":"serverService.test.js","sourceRoot":"","sources":["../../../src/node/services/serverService.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAyE;AACzE,MAAY,EAAE,wCAAoB;AAClC,MAAY,IAAI,iCAAa;AAC7B,MAAY,EAAE,+BAAW;AACzB,MAAY,GAAG,gCAAY;AAC3B,mDAAwE;AAExE,0CAAuC;AACvC,qDAAwD;AAExD,IAAA,mBAAQ,EAAC,eAAe,EAAE,GAAG,EAAE,CAAC;IAC9B,IAAA,eAAI,EAAC,4BAA4B,EAAE,KAAK,IAAI,EAAE,CAAC;QAC7C,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QACpC,IAAA,iBAAM,EAAC,MAAM,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC;IAAA,CACrD,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,4BAA4B,EAAE,KAAK,IAAI,EAAE,CAAC;QAC7C,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QACpC,OAAO,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;QACvC,IAAA,iBAAM,EAAC,MAAM,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;IAAA,CAC7D,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,sBAAsB,EAAE,KAAK,IAAI,EAAE,CAAC;QACvC,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QACpC,OAAO,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC;QACpC,IAAA,iBAAM,EAAC,MAAM,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QACzD,OAAO,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC;QACpC,IAAA,iBAAM,EAAC,MAAM,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;IAAA,CAC1D,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,qBAAqB,EAAE,KAAK,IAAI,EAAE,CAAC;QACtC,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QACpC,OAAO,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;QACvC,IAAA,iBAAM,EAAC,MAAM,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QAC5D,OAAO,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;QAC/B,IAAA,iBAAM,EAAC,MAAM,OAAO,CAAC,gBAAgB,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC;IAAA,CACrD,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC;AAEH,IAAA,mBAAQ,EAAC,2BAA2B,EAAE,GAAG,EAAE,CAAC;IAC1C,IAAI,OAAe,CAAC;IAEpB,IAAI,WAAwB,CAAC;IAE7B,IAAA,qBAAU,EAAC,KAAK,IAAI,EAAE,CAAC;QACrB,OAAO,GAAG,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC;QACvE,MAAM,MAAM,GAAG,IAAI,eAAM,CAAC,OAAO,CAAC,CAAC;QACnC,WAAW,GAAG,EAAE,MAAM,EAA4B,CAAC;IAAA,CACpD,CAAC,CAAC;IAEH,IAAA,oBAAS,EAAC,KAAK,IAAI,EAAE,CAAC;QACpB,qCAAqC;QACrC,IAAI,CAAC;YACH,MAAM,EAAE,CAAC,KAAK,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;QACjC,CAAC;QAAC,MAAM,CAAC;YACP,SAAS;QACX,CAAC;QACD,MAAM,EAAE,CAAC,EAAE,CAAC,OAAO,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;IAAA,CACxD,CAAC,CAAC;IAEH,+DAA+D;IAC/D,KAAK,UAAU,eAAe,CAAC,IAAY,EAAoB;QAC7D,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC;YAC9B,MAAM,MAAM,GAAG,IAAI,GAAG,CAAC,MAAM,EAAE,CAAC;YAChC,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;YACvB,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE,CAAC;gBACzB,MAAM,CAAC,OAAO,EAAE,CAAC;gBACjB,OAAO,CAAC,IAAI,CAAC,CAAC;YAAA,CACf,CAAC,CAAC;YACH,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE,CAAC;gBACzB,MAAM,CAAC,OAAO,EAAE,CAAC;gBACjB,OAAO,CAAC,KAAK,CAAC,CAAC;YAAA,CAChB,CAAC,CAAC;YACH,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC;gBACvB,OAAO,CAAC,KAAK,CAAC,CAAC;YAAA,CAChB,CAAC,CAAC;YACH,MAAM,CAAC,OAAO,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;QAAA,CACnC,CAAC,CAAC;IAAA,CACJ;IAED,IAAA,eAAI,EAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE,CAAC;QACnE,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QAEpC,gFAAgF;QAChF,uEAAuE;QACvE,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,mBAAmB,CAAC,CAAC;QAC5D,MAAM,EAAE,CAAC,SAAS,CAAC,WAAW,EAAE,iBAAiB,CAAC,CAAC;QAEnD,IAAI,WAAW,GAAY,IAAI,CAAC;QAEhC,IAAI,CAAC;YACH,gEAAgE;YAChE,MAAM,OAAO,CAAC,WAAW,CAAC;gBACxB,OAAO,EAAE,WAAW;gBACpB,OAAO,EAAE,WAAW;gBACpB,SAAS,EAAE,YAAY;gBACvB,IAAI,EAAE,CAAC,EAAE,cAAc;aACxB,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,WAAW,GAAG,GAAG,CAAC;QACpB,CAAC;QAED,kCAAkC;QAClC,IAAA,iBAAM,EAAC,WAAW,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;QACnC,IAAA,iBAAM,EAAC,WAAW,CAAC,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;QAC1C,IAAA,iBAAM,EAAE,WAAqB,CAAC,OAAO,CAAC,CAAC,OAAO,CAC5C,mDAAmD,CACpD,CAAC;QAEF,wCAAwC;QACxC,IAAA,iBAAM,EAAC,OAAO,CAAC,eAAe,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC9C,IAAA,iBAAM,EAAC,OAAO,CAAC,aAAa,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC;IAAA,CAC5C,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,6DAA6D,EAAE,KAAK,IAAI,EAAE,CAAC;QAC9E,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QAEpC,8FAA8F;QAC9F,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;QACnD,MAAM,gBAAgB,GAAG;YACvB,GAAG,EAAE,OAAO,CAAC,GAAG;YAChB,OAAO,EAAE,uBAAuB;YAChC,KAAK,EAAE,oBAAoB;YAC3B,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;SACpC,CAAC;QACF,MAAM,EAAE,CAAC,SAAS,CAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,gBAAgB,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;QAExE,oDAAoD;QACpD,IAAI,WAAW,GAAiB,IAAI,CAAC;QACrC,IAAI,CAAC;YACH,MAAM,OAAO,CAAC,WAAW,CAAC;gBACxB,OAAO,EAAE,OAAO;gBAChB,OAAO,EAAE,WAAW;gBACpB,SAAS,EAAE,YAAY;gBACvB,IAAI,EAAE,CAAC;aACR,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,WAAW,GAAG,GAAY,CAAC;QAC7B,CAAC;QAED,IAAA,iBAAM,EAAC,WAAW,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;QACnC,IAAA,iBAAM,EAAC,WAAY,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;QAEzD,kEAAkE;QAClE,MAAM,OAAO,CAAC,UAAU,EAAE,CAAC;QAE3B,sDAAsD;QACtD,MAAM,WAAW,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;QACzD,MAAM,QAAQ,GAAG,qCAAoB,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC;QACrE,IAAA,iBAAM,EAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;QACvD,IAAA,iBAAM,EAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;IAAA,CACnD,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE,CAAC;QAC/D,MAAM,OAAO,GAAG,IAAI,6BAAa,EAAE,CAAC;QAEpC,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC;YACrC,OAAO,EAAE,OAAO;YAChB,OAAO,EAAE,WAAW;YACpB,SAAS,EAAE,YAAY;YACvB,IAAI,EAAE,CAAC;SACR,CAAC,CAAC;QAEH,IAAI,CAAC;YACH,IAAA,iBAAM,EAAC,IAAI,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,6BAA6B,CAAC,CAAC;YAC5D,IAAA,iBAAM,EAAC,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YACtC,IAAA,iBAAM,EAAC,OAAO,CAAC,eAAe,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAE7C,8BAA8B;YAC9B,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;YACnD,MAAM,WAAW,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YACzD,MAAM,QAAQ,GAAG,qCAAoB,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC;YACrE,IAAA,iBAAM,EAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YAE1C,sCAAsC;YACtC,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;YACtD,IAAA,iBAAM,EAAC,MAAM,eAAe,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACjD,CAAC;gBAAS,CAAC;YACT,MAAM,OAAO,CAAC,UAAU,EAAE,CAAC;QAC7B,CAAC;IAAA,CACF,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC;AAEH,IAAA,mBAAQ,EAAC,wBAAwB,EAAE,GAAG,EAAE,CAAC;IACvC,IAAA,eAAI,EAAC,kCAAkC,EAAE,GAAG,EAAE,CAAC;QAC7C,IAAA,iBAAM,EAAC,IAAA,sCAAsB,EAAC,EAAE,QAAQ,EAAE,WAAW,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAClF,IAAA,iBAAM,EAAC,IAAA,sCAAsB,EAAC,EAAE,QAAQ,EAAE,WAAW,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAClF,IAAA,iBAAM,EAAC,IAAA,sCAAsB,EAAC,EAAE,QAAQ,EAAE,WAAW,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAClF,IAAA,iBAAM,EAAC,IAAA,sCAAsB,EAAC,EAAE,QAAQ,EAAE,KAAK,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;IAAA,CAC7E,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,qDAAqD,EAAE,GAAG,EAAE,CAAC;QAChE,MAAM,iBAAiB,GAA4C;YACjE,GAAG,EAAE;gBACH;oBACE,OAAO,EAAE,WAAW;oBACpB,OAAO,EAAE,WAAW;oBACpB,MAAM,EAAE,MAAM;oBACd,GAAG,EAAE,mBAAmB;oBACxB,QAAQ,EAAE,IAAI;oBACd,IAAI,EAAE,aAAa;iBACpB;aACF;YACD,GAAG,EAAE;gBACH;oBACE,OAAO,EAAE,cAAc;oBACvB,OAAO,EAAE,eAAe;oBACxB,MAAM,EAAE,MAAM;oBACd,GAAG,EAAE,mBAAmB;oBACxB,QAAQ,EAAE,KAAK;oBACf,IAAI,EAAE,iBAAiB;iBACxB;aACF;YACD,UAAU,EAAE;gBACV;oBACE,OAAO,EAAE,YAAY;oBACrB,OAAO,EAAE,aAAa;oBACtB,MAAM,EAAE,MAAM;oBACd,GAAG,EAAE,mBAAmB;oBACxB,QAAQ,EAAE,KAAK;oBACf,IAAI,EAAE,eAAe;iBACtB;aACF;YACD,OAAO,EAAE;gBACP;oBACE,OAAO,EAAE,aAAa;oBACtB,OAAO,EAAE,aAAa;oBACtB,MAAM,EAAE,MAAM;oBACd,GAAG,EAAE,mBAAmB;oBACxB,QAAQ,EAAE,KAAK;oBACf,IAAI,EAAE,gBAAgB;iBACvB;aACF;SACF,CAAC;QAEF,IAAA,iBAAM,EACJ,IAAA,sCAAsB,EAAC;YACrB,QAAQ,EAAE,SAAS;YACnB,IAAI,EAAE,IAAI;YACV,iBAAiB;SAClB,CAAC,CACH,CAAC,OAAO,CAAC,CAAC,wBAAwB,EAAE,0BAA0B,CAAC,CAAC,CAAC;IAAA,CACnE,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,iCAAiC,EAAE,GAAG,EAAE,CAAC;QAC5C,MAAM,iBAAiB,GAA4C;YACjE,GAAG,EAAE;gBACH;oBACE,OAAO,EAAE,mBAAmB;oBAC5B,OAAO,EAAE,uBAAuB;oBAChC,MAAM,EAAE,MAAM;oBACd,GAAG,EAAE,mBAAmB;oBACxB,QAAQ,EAAE,KAAK;oBACf,IAAI,EAAE,sBAAsB;oBAC5B,OAAO,EAAE,CAAC;iBACX;gBACD;oBACE,OAAO,EAAE,SAAS;oBAClB,OAAO,EAAE,uBAAuB;oBAChC,MAAM,EAAE,MAAM;oBACd,GAAG,EAAE,mBAAmB;oBACxB,QAAQ,EAAE,KAAK;oBACf,IAAI,EAAE,YAAY;oBAClB,OAAO,EAAE,CAAC;iBACX;aACF;SACF,CAAC;QAEF,IAAA,iBAAM,EACJ,IAAA,sCAAsB,EAAC;YACrB,QAAQ,EAAE,IAAI;YACd,IAAI,EAAE,IAAI;YACV,iBAAiB;SAClB,CAAC,CACH,CAAC,OAAO,CAAC,CAAC,iCAAiC,CAAC,CAAC,CAAC;QAE/C,IAAA,iBAAM,EAAC,IAAA,sCAAsB,EAAC,EAAE,QAAQ,EAAE,aAAa,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC;YAC9E,2BAA2B;SAC5B,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, expect, test, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport * as net from \"net\";\r\nimport { ServerService, computeNetworkBaseUrls } from \"./serverService\";\r\nimport type { ORPCContext } from \"@/node/orpc/context\";\r\nimport { Config } from \"@/node/config\";\r\nimport { ServerLockDataSchema } from \"./serverLockfile\";\r\n\r\ndescribe(\"ServerService\", () => {\r\n  test(\"initializes with null path\", async () => {\r\n    const service = new ServerService();\r\n    expect(await service.getLaunchProject()).toBeNull();\r\n  });\r\n\r\n  test(\"sets and gets project path\", async () => {\r\n    const service = new ServerService();\r\n    service.setLaunchProject(\"/test/path\");\r\n    expect(await service.getLaunchProject()).toBe(\"/test/path\");\r\n  });\r\n\r\n  test(\"updates project path\", async () => {\r\n    const service = new ServerService();\r\n    service.setLaunchProject(\"/path/1\");\r\n    expect(await service.getLaunchProject()).toBe(\"/path/1\");\r\n    service.setLaunchProject(\"/path/2\");\r\n    expect(await service.getLaunchProject()).toBe(\"/path/2\");\r\n  });\r\n\r\n  test(\"clears project path\", async () => {\r\n    const service = new ServerService();\r\n    service.setLaunchProject(\"/test/path\");\r\n    expect(await service.getLaunchProject()).toBe(\"/test/path\");\r\n    service.setLaunchProject(null);\r\n    expect(await service.getLaunchProject()).toBeNull();\r\n  });\r\n});\r\n\r\ndescribe(\"ServerService.startServer\", () => {\r\n  let tempDir: string;\r\n\r\n  let stubContext: ORPCContext;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-server-test-\"));\r\n    const config = new Config(tempDir);\r\n    stubContext = { config } as unknown as ORPCContext;\r\n  });\r\n\r\n  afterEach(async () => {\r\n    // Restore permissions before cleanup\r\n    try {\r\n      await fs.chmod(tempDir, 0o755);\r\n    } catch {\r\n      // ignore\r\n    }\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  /** Check if a port is in use by attempting to connect to it */\r\n  async function isPortListening(port: number): Promise<boolean> {\r\n    return new Promise((resolve) => {\r\n      const socket = new net.Socket();\r\n      socket.setTimeout(100);\r\n      socket.on(\"connect\", () => {\r\n        socket.destroy();\r\n        resolve(true);\r\n      });\r\n      socket.on(\"timeout\", () => {\r\n        socket.destroy();\r\n        resolve(false);\r\n      });\r\n      socket.on(\"error\", () => {\r\n        resolve(false);\r\n      });\r\n      socket.connect(port, \"127.0.0.1\");\r\n    });\r\n  }\r\n\r\n  test(\"cleans up server when lockfile acquisition fails\", async () => {\r\n    const service = new ServerService();\r\n\r\n    // Make muxHome a *file* (not a directory) so lockfile.acquire() fails reliably,\r\n    // even when tests run as root (chmod-based tests don't fail for root).\r\n    const muxHomeFile = path.join(tempDir, \"muxHome-not-a-dir\");\r\n    await fs.writeFile(muxHomeFile, \"not a directory\");\r\n\r\n    let thrownError: unknown = null;\r\n\r\n    try {\r\n      // Start server - this should fail when trying to write lockfile\r\n      await service.startServer({\r\n        muxHome: muxHomeFile,\r\n        context: stubContext,\r\n        authToken: \"test-token\",\r\n        port: 0, // random port\r\n      });\r\n    } catch (err) {\r\n      thrownError = err;\r\n    }\r\n\r\n    // Verify that an error was thrown\r\n    expect(thrownError).not.toBeNull();\r\n    expect(thrownError).toBeInstanceOf(Error);\r\n    expect((thrownError as Error).message).toMatch(\r\n      /EACCES|permission denied|ENOTDIR|not a directory/i\r\n    );\r\n\r\n    // Verify the server is NOT left running\r\n    expect(service.isServerRunning()).toBe(false);\r\n    expect(service.getServerInfo()).toBeNull();\r\n  });\r\n\r\n  test(\"does not delete another process's lockfile when start fails\", async () => {\r\n    const service = new ServerService();\r\n\r\n    // Create a lockfile simulating another running server (use our own PID so it appears \"alive\")\r\n    const lockPath = path.join(tempDir, \"server.lock\");\r\n    const existingLockData = {\r\n      pid: process.pid,\r\n      baseUrl: \"http://127.0.0.1:9999\",\r\n      token: \"other-server-token\",\r\n      startedAt: new Date().toISOString(),\r\n    };\r\n    await fs.writeFile(lockPath, JSON.stringify(existingLockData, null, 2));\r\n\r\n    // Try to start - should fail due to existing server\r\n    let thrownError: Error | null = null;\r\n    try {\r\n      await service.startServer({\r\n        muxHome: tempDir,\r\n        context: stubContext,\r\n        authToken: \"test-token\",\r\n        port: 0,\r\n      });\r\n    } catch (err) {\r\n      thrownError = err as Error;\r\n    }\r\n\r\n    expect(thrownError).not.toBeNull();\r\n    expect(thrownError!.message).toMatch(/already running/i);\r\n\r\n    // Critical: call stopServer (simulating cleanup in finally block)\r\n    await service.stopServer();\r\n\r\n    // Verify the OTHER process's lockfile was NOT deleted\r\n    const lockContent = await fs.readFile(lockPath, \"utf-8\");\r\n    const lockData = ServerLockDataSchema.parse(JSON.parse(lockContent));\r\n    expect(lockData.baseUrl).toBe(\"http://127.0.0.1:9999\");\r\n    expect(lockData.token).toBe(\"other-server-token\");\r\n  });\r\n\r\n  test(\"successful start creates lockfile and server\", async () => {\r\n    const service = new ServerService();\r\n\r\n    const info = await service.startServer({\r\n      muxHome: tempDir,\r\n      context: stubContext,\r\n      authToken: \"test-token\",\r\n      port: 0,\r\n    });\r\n\r\n    try {\r\n      expect(info.baseUrl).toMatch(/^http:\\/\\/127\\.0\\.0\\.1:\\d+$/);\r\n      expect(info.token).toBe(\"test-token\");\r\n      expect(service.isServerRunning()).toBe(true);\r\n\r\n      // Verify lockfile was created\r\n      const lockPath = path.join(tempDir, \"server.lock\");\r\n      const lockContent = await fs.readFile(lockPath, \"utf-8\");\r\n      const lockData = ServerLockDataSchema.parse(JSON.parse(lockContent));\r\n      expect(lockData.baseUrl).toBe(info.baseUrl);\r\n      expect(lockData.token).toBe(\"test-token\");\r\n\r\n      // Verify server is actually listening\r\n      const port = parseInt(info.baseUrl.split(\":\")[2], 10);\r\n      expect(await isPortListening(port)).toBe(true);\r\n    } finally {\r\n      await service.stopServer();\r\n    }\r\n  });\r\n});\r\n\r\ndescribe(\"computeNetworkBaseUrls\", () => {\r\n  test(\"returns empty for loopback binds\", () => {\r\n    expect(computeNetworkBaseUrls({ bindHost: \"127.0.0.1\", port: 3000 })).toEqual([]);\r\n    expect(computeNetworkBaseUrls({ bindHost: \"127.0.0.2\", port: 3000 })).toEqual([]);\r\n    expect(computeNetworkBaseUrls({ bindHost: \"localhost\", port: 3000 })).toEqual([]);\r\n    expect(computeNetworkBaseUrls({ bindHost: \"::1\", port: 3000 })).toEqual([]);\r\n  });\r\n\r\n  test(\"expands 0.0.0.0 to all non-internal IPv4 interfaces\", () => {\r\n    const networkInterfaces: ReturnType<typeof os.networkInterfaces> = {\r\n      lo0: [\r\n        {\r\n          address: \"127.0.0.1\",\r\n          netmask: \"255.0.0.0\",\r\n          family: \"IPv4\",\r\n          mac: \"00:00:00:00:00:00\",\r\n          internal: true,\r\n          cidr: \"127.0.0.1/8\",\r\n        },\r\n      ],\r\n      en0: [\r\n        {\r\n          address: \"192.168.1.10\",\r\n          netmask: \"255.255.255.0\",\r\n          family: \"IPv4\",\r\n          mac: \"aa:bb:cc:dd:ee:ff\",\r\n          internal: false,\r\n          cidr: \"192.168.1.10/24\",\r\n        },\r\n      ],\r\n      tailscale0: [\r\n        {\r\n          address: \"100.64.0.2\",\r\n          netmask: \"255.192.0.0\",\r\n          family: \"IPv4\",\r\n          mac: \"aa:bb:cc:dd:ee:01\",\r\n          internal: false,\r\n          cidr: \"100.64.0.2/10\",\r\n        },\r\n      ],\r\n      docker0: [\r\n        {\r\n          address: \"169.254.1.2\",\r\n          netmask: \"255.255.0.0\",\r\n          family: \"IPv4\",\r\n          mac: \"aa:bb:cc:dd:ee:02\",\r\n          internal: false,\r\n          cidr: \"169.254.1.2/16\",\r\n        },\r\n      ],\r\n    };\r\n\r\n    expect(\r\n      computeNetworkBaseUrls({\r\n        bindHost: \"0.0.0.0\",\r\n        port: 3000,\r\n        networkInterfaces,\r\n      })\r\n    ).toEqual([\"http://100.64.0.2:3000\", \"http://192.168.1.10:3000\"]);\r\n  });\r\n\r\n  test(\"formats IPv6 URLs with brackets\", () => {\r\n    const networkInterfaces: ReturnType<typeof os.networkInterfaces> = {\r\n      en0: [\r\n        {\r\n          address: \"fd7a:115c:a1e0::1\",\r\n          netmask: \"ffff:ffff:ffff:ffff::\",\r\n          family: \"IPv6\",\r\n          mac: \"aa:bb:cc:dd:ee:ff\",\r\n          internal: false,\r\n          cidr: \"fd7a:115c:a1e0::1/64\",\r\n          scopeid: 0,\r\n        },\r\n        {\r\n          address: \"fe80::1\",\r\n          netmask: \"ffff:ffff:ffff:ffff::\",\r\n          family: \"IPv6\",\r\n          mac: \"aa:bb:cc:dd:ee:ff\",\r\n          internal: false,\r\n          cidr: \"fe80::1/64\",\r\n          scopeid: 0,\r\n        },\r\n      ],\r\n    };\r\n\r\n    expect(\r\n      computeNetworkBaseUrls({\r\n        bindHost: \"::\",\r\n        port: 3000,\r\n        networkInterfaces,\r\n      })\r\n    ).toEqual([\"http://[fd7a:115c:a1e0::1]:3000\"]);\r\n\r\n    expect(computeNetworkBaseUrls({ bindHost: \"2001:db8::1\", port: 3000 })).toEqual([\r\n      \"http://[2001:db8::1]:3000\",\r\n    ]);\r\n  });\r\n});\r\n"]}