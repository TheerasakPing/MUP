{"version":3,"file":"muxGovernorOauthService.js","sourceRoot":"","sources":["../../../src/node/services/muxGovernorOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * OAuth service for Mux Governor enrollment.\r\n *\r\n * Similar pattern to MuxGatewayOauthService but:\r\n * - Takes a user-provided governor origin (not hardcoded)\r\n * - Persists credentials to config.json (muxGovernorUrl + muxGovernorToken)\r\n */\r\n\r\nimport * as crypto from \"crypto\";\r\nimport * as http from \"http\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Err, Ok } from \"@/common/types/result\";\r\nimport {\r\n  buildGovernorAuthorizeUrl,\r\n  buildGovernorExchangeBody,\r\n  buildGovernorExchangeUrl,\r\n  normalizeGovernorUrl,\r\n} from \"@/common/constants/muxGovernorOAuth\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { PolicyService } from \"@/node/services/policyService\";\r\nimport type { WindowService } from \"@/node/services/windowService\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\nconst DEFAULT_DESKTOP_TIMEOUT_MS = 5 * 60 * 1000;\r\nconst DEFAULT_SERVER_TIMEOUT_MS = 10 * 60 * 1000;\r\nconst COMPLETED_DESKTOP_FLOW_TTL_MS = 60 * 1000;\r\n\r\ninterface DesktopFlow {\r\n  flowId: string;\r\n  governorOrigin: string;\r\n  authorizeUrl: string;\r\n  redirectUri: string;\r\n  server: http.Server;\r\n  timeout: ReturnType<typeof setTimeout>;\r\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\r\n  resultPromise: Promise<Result<void, string>>;\r\n  resolveResult: (result: Result<void, string>) => void;\r\n  settled: boolean;\r\n}\r\n\r\ninterface ServerFlow {\r\n  state: string;\r\n  governorOrigin: string;\r\n  expiresAtMs: number;\r\n}\r\n\r\nfunction closeServer(server: http.Server): Promise<void> {\r\n  return new Promise((resolve) => {\r\n    server.close(() => resolve());\r\n  });\r\n}\r\n\r\nfunction createDeferred<T>(): { promise: Promise<T>; resolve: (value: T) => void } {\r\n  let resolve!: (value: T) => void;\r\n  const promise = new Promise<T>((res) => {\r\n    resolve = res;\r\n  });\r\n  return { promise, resolve };\r\n}\r\n\r\nexport class MuxGovernorOauthService {\r\n  private readonly desktopFlows = new Map<string, DesktopFlow>();\r\n  private readonly serverFlows = new Map<string, ServerFlow>();\r\n\r\n  constructor(\r\n    private readonly config: Config,\r\n    private readonly windowService?: WindowService,\r\n    private readonly policyService?: PolicyService\r\n  ) {}\r\n\r\n  async startDesktopFlow(input: {\r\n    governorOrigin: string;\r\n  }): Promise<Result<{ flowId: string; authorizeUrl: string; redirectUri: string }, string>> {\r\n    // Normalize and validate the governor origin\r\n    let governorOrigin: string;\r\n    try {\r\n      governorOrigin = normalizeGovernorUrl(input.governorOrigin);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Invalid Governor URL: ${message}`);\r\n    }\r\n\r\n    const flowId = crypto.randomUUID();\r\n\r\n    const { promise: resultPromise, resolve: resolveResult } =\r\n      createDeferred<Result<void, string>>();\r\n\r\n    const server = http.createServer((req, res) => {\r\n      const reqUrl = req.url ?? \"/\";\r\n      const url = new URL(reqUrl, \"http://localhost\");\r\n\r\n      if (req.method !== \"GET\" || url.pathname !== \"/callback\") {\r\n        res.statusCode = 404;\r\n        res.end(\"Not found\");\r\n        return;\r\n      }\r\n\r\n      const state = url.searchParams.get(\"state\");\r\n      if (!state || state !== flowId) {\r\n        res.statusCode = 400;\r\n        res.setHeader(\"Content-Type\", \"text/html\");\r\n        res.end(\"<h1>Invalid OAuth state</h1>\");\r\n        return;\r\n      }\r\n\r\n      const code = url.searchParams.get(\"code\");\r\n      const error = url.searchParams.get(\"error\");\r\n      const errorDescription = url.searchParams.get(\"error_description\") ?? undefined;\r\n\r\n      void this.handleDesktopCallback({\r\n        flowId,\r\n        governorOrigin,\r\n        code,\r\n        error,\r\n        errorDescription,\r\n        res,\r\n      });\r\n    });\r\n\r\n    try {\r\n      await new Promise<void>((resolve, reject) => {\r\n        server.once(\"error\", reject);\r\n        server.listen(0, \"127.0.0.1\", () => resolve());\r\n      });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to start OAuth callback listener: ${message}`);\r\n    }\r\n\r\n    const address = server.address();\r\n    if (!address || typeof address === \"string\") {\r\n      return Err(\"Failed to determine OAuth callback listener port\");\r\n    }\r\n\r\n    const redirectUri = `http://127.0.0.1:${address.port}/callback`;\r\n    const authorizeUrl = buildGovernorAuthorizeUrl({\r\n      governorOrigin,\r\n      redirectUri,\r\n      state: flowId,\r\n    });\r\n\r\n    const timeout = setTimeout(() => {\r\n      void this.finishDesktopFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\r\n    }, DEFAULT_DESKTOP_TIMEOUT_MS);\r\n\r\n    this.desktopFlows.set(flowId, {\r\n      flowId,\r\n      governorOrigin,\r\n      authorizeUrl,\r\n      redirectUri,\r\n      server,\r\n      timeout,\r\n      cleanupTimeout: null,\r\n      resultPromise,\r\n      resolveResult,\r\n      settled: false,\r\n    });\r\n\r\n    log.debug(\r\n      `Mux Governor OAuth desktop flow started (flowId=${flowId}, origin=${governorOrigin})`\r\n    );\r\n\r\n    return Ok({ flowId, authorizeUrl, redirectUri });\r\n  }\r\n\r\n  async waitForDesktopFlow(\r\n    flowId: string,\r\n    opts?: { timeoutMs?: number }\r\n  ): Promise<Result<void, string>> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow) {\r\n      return Err(\"OAuth flow not found\");\r\n    }\r\n\r\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DESKTOP_TIMEOUT_MS;\r\n\r\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\r\n      timeoutHandle = setTimeout(() => {\r\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\r\n      }, timeoutMs);\r\n    });\r\n\r\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\r\n\r\n    if (timeoutHandle !== null) {\r\n      clearTimeout(timeoutHandle);\r\n    }\r\n\r\n    if (!result.success) {\r\n      // Ensure listener is closed on timeout/errors.\r\n      void this.finishDesktopFlow(flowId, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  async cancelDesktopFlow(flowId: string): Promise<void> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow) return;\r\n\r\n    log.debug(`Mux Governor OAuth desktop flow cancelled (flowId=${flowId})`);\r\n    await this.finishDesktopFlow(flowId, Err(\"OAuth flow cancelled\"));\r\n  }\r\n\r\n  startServerFlow(input: {\r\n    governorOrigin: string;\r\n    redirectUri: string;\r\n  }): Result<{ authorizeUrl: string; state: string }, string> {\r\n    // Normalize and validate the governor origin\r\n    let governorOrigin: string;\r\n    try {\r\n      governorOrigin = normalizeGovernorUrl(input.governorOrigin);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Invalid Governor URL: ${message}`);\r\n    }\r\n\r\n    const state = crypto.randomUUID();\r\n\r\n    // Prune expired flows (best-effort; avoids unbounded growth if callbacks never arrive).\r\n    const now = Date.now();\r\n    for (const [key, flow] of this.serverFlows) {\r\n      if (flow.expiresAtMs <= now) {\r\n        this.serverFlows.delete(key);\r\n      }\r\n    }\r\n\r\n    const authorizeUrl = buildGovernorAuthorizeUrl({\r\n      governorOrigin,\r\n      redirectUri: input.redirectUri,\r\n      state,\r\n    });\r\n\r\n    this.serverFlows.set(state, {\r\n      state,\r\n      governorOrigin,\r\n      expiresAtMs: Date.now() + DEFAULT_SERVER_TIMEOUT_MS,\r\n    });\r\n\r\n    log.debug(`Mux Governor OAuth server flow started (state=${state}, origin=${governorOrigin})`);\r\n\r\n    return Ok({ authorizeUrl, state });\r\n  }\r\n\r\n  async handleServerCallbackAndExchange(input: {\r\n    state: string | null;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n  }): Promise<Result<void, string>> {\r\n    const state = input.state;\r\n    if (!state) {\r\n      return Err(\"Missing OAuth state\");\r\n    }\r\n\r\n    const flow = this.serverFlows.get(state);\r\n    if (!flow) {\r\n      return Err(\"Unknown OAuth state\");\r\n    }\r\n\r\n    if (Date.now() > flow.expiresAtMs) {\r\n      this.serverFlows.delete(state);\r\n      return Err(\"OAuth flow expired\");\r\n    }\r\n\r\n    // Regardless of outcome, this flow should not be reused.\r\n    const governorOrigin = flow.governorOrigin;\r\n    this.serverFlows.delete(state);\r\n\r\n    return this.handleCallbackAndExchange({\r\n      state,\r\n      governorOrigin,\r\n      code: input.code,\r\n      error: input.error,\r\n      errorDescription: input.errorDescription,\r\n    });\r\n  }\r\n\r\n  async dispose(): Promise<void> {\r\n    // Best-effort: cancel all in-flight flows.\r\n    const flowIds = [...this.desktopFlows.keys()];\r\n    await Promise.all(flowIds.map((id) => this.finishDesktopFlow(id, Err(\"App shutting down\"))));\r\n\r\n    for (const flow of this.desktopFlows.values()) {\r\n      clearTimeout(flow.timeout);\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n    }\r\n\r\n    this.desktopFlows.clear();\r\n    this.serverFlows.clear();\r\n  }\r\n\r\n  private async handleDesktopCallback(input: {\r\n    flowId: string;\r\n    governorOrigin: string;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n    res: http.ServerResponse;\r\n  }): Promise<void> {\r\n    const flow = this.desktopFlows.get(input.flowId);\r\n    if (!flow || flow.settled) {\r\n      input.res.statusCode = 409;\r\n      input.res.setHeader(\"Content-Type\", \"text/html\");\r\n      input.res.end(\"<h1>OAuth flow already completed</h1>\");\r\n      return;\r\n    }\r\n\r\n    log.debug(`Mux Governor OAuth callback received (flowId=${input.flowId})`);\r\n\r\n    const result = await this.handleCallbackAndExchange({\r\n      state: input.flowId,\r\n      governorOrigin: input.governorOrigin,\r\n      code: input.code,\r\n      error: input.error,\r\n      errorDescription: input.errorDescription,\r\n    });\r\n\r\n    const title = result.success ? \"Enrollment complete\" : \"Enrollment failed\";\r\n    const description = result.success\r\n      ? \"You can return to Mux. You may now close this tab.\"\r\n      : escapeHtml(result.error);\r\n\r\n    const html = `<!doctype html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <meta name=\"color-scheme\" content=\"dark light\" />\r\n    <title>${title}</title>\r\n    <style>\r\n      body { font-family: system-ui, sans-serif; max-width: 600px; margin: 4rem auto; padding: 1rem; }\r\n      h1 { margin-bottom: 1rem; }\r\n      .muted { color: #666; }\r\n    </style>\r\n  </head>\r\n  <body>\r\n    <h1>${title}</h1>\r\n    <p>${description}</p>\r\n    ${\r\n      result.success\r\n        ? '<p class=\"muted\">Mux should now be in the foreground. You can close this tab.</p>'\r\n        : '<p class=\"muted\">You can close this tab.</p>'\r\n    }\r\n    <script>\r\n      (() => {\r\n        const ok = ${result.success ? \"true\" : \"false\"};\r\n        if (!ok) return;\r\n        try { window.close(); } catch {}\r\n        setTimeout(() => { try { window.close(); } catch {} }, 50);\r\n      })();\r\n    </script>\r\n  </body>\r\n</html>`;\r\n\r\n    input.res.setHeader(\"Content-Type\", \"text/html\");\r\n    if (!result.success) {\r\n      input.res.statusCode = 400;\r\n    }\r\n\r\n    input.res.end(html);\r\n\r\n    await this.finishDesktopFlow(input.flowId, result);\r\n  }\r\n\r\n  private async handleCallbackAndExchange(input: {\r\n    state: string;\r\n    governorOrigin: string;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n  }): Promise<Result<void, string>> {\r\n    if (input.error) {\r\n      const message = input.errorDescription\r\n        ? `${input.error}: ${input.errorDescription}`\r\n        : input.error;\r\n      return Err(`Mux Governor OAuth error: ${message}`);\r\n    }\r\n\r\n    if (!input.code) {\r\n      return Err(\"Missing OAuth code\");\r\n    }\r\n\r\n    const tokenResult = await this.exchangeCodeForToken(input.code, input.governorOrigin);\r\n    if (!tokenResult.success) {\r\n      return Err(tokenResult.error);\r\n    }\r\n\r\n    // Persist to config.json\r\n    try {\r\n      await this.config.editConfig((config) => ({\r\n        ...config,\r\n        muxGovernorUrl: input.governorOrigin,\r\n        muxGovernorToken: tokenResult.data,\r\n      }));\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to save Governor credentials: ${message}`);\r\n    }\r\n\r\n    log.debug(`Mux Governor OAuth exchange completed (state=${input.state})`);\r\n\r\n    this.windowService?.focusMainWindow();\r\n\r\n    const refreshResult = await this.policyService?.refreshNow();\r\n    if (refreshResult && !refreshResult.success) {\r\n      log.warn(\"Policy refresh after Governor enrollment failed\", {\r\n        error: refreshResult.error,\r\n      });\r\n    }\r\n    return Ok(undefined);\r\n  }\r\n\r\n  private async exchangeCodeForToken(\r\n    code: string,\r\n    governorOrigin: string\r\n  ): Promise<Result<string, string>> {\r\n    const exchangeUrl = buildGovernorExchangeUrl(governorOrigin);\r\n\r\n    try {\r\n      const response = await fetch(exchangeUrl, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        },\r\n        body: buildGovernorExchangeBody({ code }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text().catch(() => \"\");\r\n        const prefix = `Mux Governor exchange failed (${response.status})`;\r\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\r\n      }\r\n\r\n      const json = (await response.json()) as { access_token?: unknown };\r\n      const token = typeof json.access_token === \"string\" ? json.access_token : null;\r\n      if (!token) {\r\n        return Err(\"Mux Governor exchange response missing access_token\");\r\n      }\r\n\r\n      return Ok(token);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Mux Governor exchange failed: ${message}`);\r\n    }\r\n  }\r\n\r\n  private async finishDesktopFlow(flowId: string, result: Result<void, string>): Promise<void> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow || flow.settled) return;\r\n\r\n    flow.settled = true;\r\n    clearTimeout(flow.timeout);\r\n\r\n    try {\r\n      flow.resolveResult(result);\r\n\r\n      // Stop accepting new connections.\r\n      await closeServer(flow.server);\r\n    } catch (error) {\r\n      log.debug(\"Failed to close OAuth callback listener:\", error);\r\n    } finally {\r\n      // Keep the completed flow around briefly so callers can still await the result.\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n      flow.cleanupTimeout = setTimeout(() => {\r\n        this.desktopFlows.delete(flowId);\r\n      }, COMPLETED_DESKTOP_FLOW_TTL_MS);\r\n    }\r\n  }\r\n}\r\n\r\nfunction escapeHtml(input: string): string {\r\n  return input\r\n    .replaceAll(\"&\", \"&amp;\")\r\n    .replaceAll(\"<\", \"&lt;\")\r\n    .replaceAll(\">\", \"&gt;\")\r\n    .replaceAll('\"', \"&quot;\")\r\n    .replaceAll(\"'\", \"&#39;\");\r\n}\r\n"]}