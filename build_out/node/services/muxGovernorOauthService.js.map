{"version":3,"file":"muxGovernorOauthService.js","sourceRoot":"","sources":["../../../src/node/services/muxGovernorOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * OAuth service for Mux Governor enrollment.\n *\n * Similar pattern to MuxGatewayOauthService but:\n * - Takes a user-provided governor origin (not hardcoded)\n * - Persists credentials to config.json (muxGovernorUrl + muxGovernorToken)\n */\n\nimport * as crypto from \"crypto\";\nimport * as http from \"http\";\nimport type { Result } from \"@/common/types/result\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport {\n  buildGovernorAuthorizeUrl,\n  buildGovernorExchangeBody,\n  buildGovernorExchangeUrl,\n  normalizeGovernorUrl,\n} from \"@/common/constants/muxGovernorOAuth\";\nimport type { Config } from \"@/node/config\";\nimport type { PolicyService } from \"@/node/services/policyService\";\nimport type { WindowService } from \"@/node/services/windowService\";\nimport { log } from \"@/node/services/log\";\n\nconst DEFAULT_DESKTOP_TIMEOUT_MS = 5 * 60 * 1000;\nconst DEFAULT_SERVER_TIMEOUT_MS = 10 * 60 * 1000;\nconst COMPLETED_DESKTOP_FLOW_TTL_MS = 60 * 1000;\n\ninterface DesktopFlow {\n  flowId: string;\n  governorOrigin: string;\n  authorizeUrl: string;\n  redirectUri: string;\n  server: http.Server;\n  timeout: ReturnType<typeof setTimeout>;\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\n  resultPromise: Promise<Result<void, string>>;\n  resolveResult: (result: Result<void, string>) => void;\n  settled: boolean;\n}\n\ninterface ServerFlow {\n  state: string;\n  governorOrigin: string;\n  expiresAtMs: number;\n}\n\nfunction closeServer(server: http.Server): Promise<void> {\n  return new Promise((resolve) => {\n    server.close(() => resolve());\n  });\n}\n\nfunction createDeferred<T>(): { promise: Promise<T>; resolve: (value: T) => void } {\n  let resolve!: (value: T) => void;\n  const promise = new Promise<T>((res) => {\n    resolve = res;\n  });\n  return { promise, resolve };\n}\n\nexport class MuxGovernorOauthService {\n  private readonly desktopFlows = new Map<string, DesktopFlow>();\n  private readonly serverFlows = new Map<string, ServerFlow>();\n\n  constructor(\n    private readonly config: Config,\n    private readonly windowService?: WindowService,\n    private readonly policyService?: PolicyService\n  ) {}\n\n  async startDesktopFlow(input: {\n    governorOrigin: string;\n  }): Promise<Result<{ flowId: string; authorizeUrl: string; redirectUri: string }, string>> {\n    // Normalize and validate the governor origin\n    let governorOrigin: string;\n    try {\n      governorOrigin = normalizeGovernorUrl(input.governorOrigin);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Invalid Governor URL: ${message}`);\n    }\n\n    const flowId = crypto.randomUUID();\n\n    const { promise: resultPromise, resolve: resolveResult } =\n      createDeferred<Result<void, string>>();\n\n    const server = http.createServer((req, res) => {\n      const reqUrl = req.url ?? \"/\";\n      const url = new URL(reqUrl, \"http://localhost\");\n\n      if (req.method !== \"GET\" || url.pathname !== \"/callback\") {\n        res.statusCode = 404;\n        res.end(\"Not found\");\n        return;\n      }\n\n      const state = url.searchParams.get(\"state\");\n      if (!state || state !== flowId) {\n        res.statusCode = 400;\n        res.setHeader(\"Content-Type\", \"text/html\");\n        res.end(\"<h1>Invalid OAuth state</h1>\");\n        return;\n      }\n\n      const code = url.searchParams.get(\"code\");\n      const error = url.searchParams.get(\"error\");\n      const errorDescription = url.searchParams.get(\"error_description\") ?? undefined;\n\n      void this.handleDesktopCallback({\n        flowId,\n        governorOrigin,\n        code,\n        error,\n        errorDescription,\n        res,\n      });\n    });\n\n    try {\n      await new Promise<void>((resolve, reject) => {\n        server.once(\"error\", reject);\n        server.listen(0, \"127.0.0.1\", () => resolve());\n      });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Failed to start OAuth callback listener: ${message}`);\n    }\n\n    const address = server.address();\n    if (!address || typeof address === \"string\") {\n      return Err(\"Failed to determine OAuth callback listener port\");\n    }\n\n    const redirectUri = `http://127.0.0.1:${address.port}/callback`;\n    const authorizeUrl = buildGovernorAuthorizeUrl({\n      governorOrigin,\n      redirectUri,\n      state: flowId,\n    });\n\n    const timeout = setTimeout(() => {\n      void this.finishDesktopFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\n    }, DEFAULT_DESKTOP_TIMEOUT_MS);\n\n    this.desktopFlows.set(flowId, {\n      flowId,\n      governorOrigin,\n      authorizeUrl,\n      redirectUri,\n      server,\n      timeout,\n      cleanupTimeout: null,\n      resultPromise,\n      resolveResult,\n      settled: false,\n    });\n\n    log.debug(\n      `Mux Governor OAuth desktop flow started (flowId=${flowId}, origin=${governorOrigin})`\n    );\n\n    return Ok({ flowId, authorizeUrl, redirectUri });\n  }\n\n  async waitForDesktopFlow(\n    flowId: string,\n    opts?: { timeoutMs?: number }\n  ): Promise<Result<void, string>> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow) {\n      return Err(\"OAuth flow not found\");\n    }\n\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DESKTOP_TIMEOUT_MS;\n\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\n      timeoutHandle = setTimeout(() => {\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\n      }, timeoutMs);\n    });\n\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\n\n    if (timeoutHandle !== null) {\n      clearTimeout(timeoutHandle);\n    }\n\n    if (!result.success) {\n      // Ensure listener is closed on timeout/errors.\n      void this.finishDesktopFlow(flowId, result);\n    }\n\n    return result;\n  }\n\n  async cancelDesktopFlow(flowId: string): Promise<void> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow) return;\n\n    log.debug(`Mux Governor OAuth desktop flow cancelled (flowId=${flowId})`);\n    await this.finishDesktopFlow(flowId, Err(\"OAuth flow cancelled\"));\n  }\n\n  startServerFlow(input: {\n    governorOrigin: string;\n    redirectUri: string;\n  }): Result<{ authorizeUrl: string; state: string }, string> {\n    // Normalize and validate the governor origin\n    let governorOrigin: string;\n    try {\n      governorOrigin = normalizeGovernorUrl(input.governorOrigin);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Invalid Governor URL: ${message}`);\n    }\n\n    const state = crypto.randomUUID();\n\n    // Prune expired flows (best-effort; avoids unbounded growth if callbacks never arrive).\n    const now = Date.now();\n    for (const [key, flow] of this.serverFlows) {\n      if (flow.expiresAtMs <= now) {\n        this.serverFlows.delete(key);\n      }\n    }\n\n    const authorizeUrl = buildGovernorAuthorizeUrl({\n      governorOrigin,\n      redirectUri: input.redirectUri,\n      state,\n    });\n\n    this.serverFlows.set(state, {\n      state,\n      governorOrigin,\n      expiresAtMs: Date.now() + DEFAULT_SERVER_TIMEOUT_MS,\n    });\n\n    log.debug(`Mux Governor OAuth server flow started (state=${state}, origin=${governorOrigin})`);\n\n    return Ok({ authorizeUrl, state });\n  }\n\n  async handleServerCallbackAndExchange(input: {\n    state: string | null;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n  }): Promise<Result<void, string>> {\n    const state = input.state;\n    if (!state) {\n      return Err(\"Missing OAuth state\");\n    }\n\n    const flow = this.serverFlows.get(state);\n    if (!flow) {\n      return Err(\"Unknown OAuth state\");\n    }\n\n    if (Date.now() > flow.expiresAtMs) {\n      this.serverFlows.delete(state);\n      return Err(\"OAuth flow expired\");\n    }\n\n    // Regardless of outcome, this flow should not be reused.\n    const governorOrigin = flow.governorOrigin;\n    this.serverFlows.delete(state);\n\n    return this.handleCallbackAndExchange({\n      state,\n      governorOrigin,\n      code: input.code,\n      error: input.error,\n      errorDescription: input.errorDescription,\n    });\n  }\n\n  async dispose(): Promise<void> {\n    // Best-effort: cancel all in-flight flows.\n    const flowIds = [...this.desktopFlows.keys()];\n    await Promise.all(flowIds.map((id) => this.finishDesktopFlow(id, Err(\"App shutting down\"))));\n\n    for (const flow of this.desktopFlows.values()) {\n      clearTimeout(flow.timeout);\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n    }\n\n    this.desktopFlows.clear();\n    this.serverFlows.clear();\n  }\n\n  private async handleDesktopCallback(input: {\n    flowId: string;\n    governorOrigin: string;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n    res: http.ServerResponse;\n  }): Promise<void> {\n    const flow = this.desktopFlows.get(input.flowId);\n    if (!flow || flow.settled) {\n      input.res.statusCode = 409;\n      input.res.setHeader(\"Content-Type\", \"text/html\");\n      input.res.end(\"<h1>OAuth flow already completed</h1>\");\n      return;\n    }\n\n    log.debug(`Mux Governor OAuth callback received (flowId=${input.flowId})`);\n\n    const result = await this.handleCallbackAndExchange({\n      state: input.flowId,\n      governorOrigin: input.governorOrigin,\n      code: input.code,\n      error: input.error,\n      errorDescription: input.errorDescription,\n    });\n\n    const title = result.success ? \"Enrollment complete\" : \"Enrollment failed\";\n    const description = result.success\n      ? \"You can return to Mux. You may now close this tab.\"\n      : escapeHtml(result.error);\n\n    const html = `<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"dark light\" />\n    <title>${title}</title>\n    <style>\n      body { font-family: system-ui, sans-serif; max-width: 600px; margin: 4rem auto; padding: 1rem; }\n      h1 { margin-bottom: 1rem; }\n      .muted { color: #666; }\n    </style>\n  </head>\n  <body>\n    <h1>${title}</h1>\n    <p>${description}</p>\n    ${\n      result.success\n        ? '<p class=\"muted\">Mux should now be in the foreground. You can close this tab.</p>'\n        : '<p class=\"muted\">You can close this tab.</p>'\n    }\n    <script>\n      (() => {\n        const ok = ${result.success ? \"true\" : \"false\"};\n        if (!ok) return;\n        try { window.close(); } catch {}\n        setTimeout(() => { try { window.close(); } catch {} }, 50);\n      })();\n    </script>\n  </body>\n</html>`;\n\n    input.res.setHeader(\"Content-Type\", \"text/html\");\n    if (!result.success) {\n      input.res.statusCode = 400;\n    }\n\n    input.res.end(html);\n\n    await this.finishDesktopFlow(input.flowId, result);\n  }\n\n  private async handleCallbackAndExchange(input: {\n    state: string;\n    governorOrigin: string;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n  }): Promise<Result<void, string>> {\n    if (input.error) {\n      const message = input.errorDescription\n        ? `${input.error}: ${input.errorDescription}`\n        : input.error;\n      return Err(`Mux Governor OAuth error: ${message}`);\n    }\n\n    if (!input.code) {\n      return Err(\"Missing OAuth code\");\n    }\n\n    const tokenResult = await this.exchangeCodeForToken(input.code, input.governorOrigin);\n    if (!tokenResult.success) {\n      return Err(tokenResult.error);\n    }\n\n    // Persist to config.json\n    try {\n      await this.config.editConfig((config) => ({\n        ...config,\n        muxGovernorUrl: input.governorOrigin,\n        muxGovernorToken: tokenResult.data,\n      }));\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Failed to save Governor credentials: ${message}`);\n    }\n\n    log.debug(`Mux Governor OAuth exchange completed (state=${input.state})`);\n\n    this.windowService?.focusMainWindow();\n\n    const refreshResult = await this.policyService?.refreshNow();\n    if (refreshResult && !refreshResult.success) {\n      log.warn(\"Policy refresh after Governor enrollment failed\", {\n        error: refreshResult.error,\n      });\n    }\n    return Ok(undefined);\n  }\n\n  private async exchangeCodeForToken(\n    code: string,\n    governorOrigin: string\n  ): Promise<Result<string, string>> {\n    const exchangeUrl = buildGovernorExchangeUrl(governorOrigin);\n\n    try {\n      const response = await fetch(exchangeUrl, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: buildGovernorExchangeBody({ code }),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => \"\");\n        const prefix = `Mux Governor exchange failed (${response.status})`;\n        return Err(errorText ? `${prefix}: ${errorText}` : prefix);\n      }\n\n      const json = (await response.json()) as { access_token?: unknown };\n      const token = typeof json.access_token === \"string\" ? json.access_token : null;\n      if (!token) {\n        return Err(\"Mux Governor exchange response missing access_token\");\n      }\n\n      return Ok(token);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Mux Governor exchange failed: ${message}`);\n    }\n  }\n\n  private async finishDesktopFlow(flowId: string, result: Result<void, string>): Promise<void> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow || flow.settled) return;\n\n    flow.settled = true;\n    clearTimeout(flow.timeout);\n\n    try {\n      flow.resolveResult(result);\n\n      // Stop accepting new connections.\n      await closeServer(flow.server);\n    } catch (error) {\n      log.debug(\"Failed to close OAuth callback listener:\", error);\n    } finally {\n      // Keep the completed flow around briefly so callers can still await the result.\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n      flow.cleanupTimeout = setTimeout(() => {\n        this.desktopFlows.delete(flowId);\n      }, COMPLETED_DESKTOP_FLOW_TTL_MS);\n    }\n  }\n}\n\nfunction escapeHtml(input: string): string {\n  return input\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#39;\");\n}\n"]}