{"version":3,"file":"editorService.js","sourceRoot":"","sources":["../../../src/node/services/editorService.ts"],"names":[],"mappings":"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","sourcesContent":["import { spawn, spawnSync } from \"child_process\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { isDockerRuntime, isSSHRuntime, isDevcontainerRuntime } from \"@/common/types/runtime\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\n/**\r\n * Quote a string for safe use in shell commands.\r\n *\r\n * IMPORTANT: Prefer spawning commands with an args array instead of building a\r\n * single shell string. This helper exists only for custom editor commands.\r\n */\r\nfunction shellQuote(value: string): string {\r\n  if (value.length === 0) return process.platform === \"win32\" ? '\"\"' : \"''\";\r\n\r\n  // cmd.exe: use double quotes (single quotes are treated as literal characters)\r\n  if (process.platform === \"win32\") {\r\n    return `\"${value.replace(/\"/g, '\"\"')}\"`;\r\n  }\r\n\r\n  // POSIX shells: single quotes with proper escaping for embedded single quotes.\r\n  return \"'\" + value.replace(/'/g, \"'\\\"'\\\"'\") + \"'\";\r\n}\r\n\r\nfunction getExecutableFromShellCommand(command: string): string | null {\r\n  const trimmed = command.trim();\r\n  if (!trimmed) return null;\r\n\r\n  const quote = trimmed[0];\r\n  if (quote === '\"' || quote === \"'\") {\r\n    const endQuoteIndex = trimmed.indexOf(quote, 1);\r\n    if (endQuoteIndex === -1) {\r\n      return null;\r\n    }\r\n    return trimmed.slice(1, endQuoteIndex);\r\n  }\r\n\r\n  return trimmed.split(/\\s+/)[0] ?? null;\r\n}\r\n\r\nfunction looksLikePath(command: string): boolean {\r\n  return (\r\n    command.startsWith(\"./\") ||\r\n    command.startsWith(\"../\") ||\r\n    command.includes(\"/\") ||\r\n    command.includes(\"\\\\\") ||\r\n    /^[A-Za-z]:/.test(command)\r\n  );\r\n}\r\n\r\nexport interface EditorConfig {\r\n  editor: string;\r\n  customCommand?: string;\r\n}\r\n\r\n/**\r\n * Service for opening workspaces in code editors.\r\n *\r\n * NOTE: VS Code/Cursor/Zed are opened via deep links in the renderer.\r\n * This service is only responsible for spawning the user's custom editor command.\r\n */\r\nexport class EditorService {\r\n  private readonly config: Config;\r\n\r\n  constructor(config: Config) {\r\n    this.config = config;\r\n  }\r\n\r\n  /**\r\n   * Open a path in the user's configured code editor.\r\n   *\r\n   * @param workspaceId - The workspace (used to determine runtime + validate constraints)\r\n   * @param targetPath - The path to open (workspace directory or specific file)\r\n   * @param editorConfig - Editor configuration from user settings\r\n   */\r\n  async openInEditor(\r\n    workspaceId: string,\r\n    targetPath: string,\r\n    editorConfig: EditorConfig\r\n  ): Promise<{ success: true; data: void } | { success: false; error: string }> {\r\n    try {\r\n      if (editorConfig.editor !== \"custom\") {\r\n        return {\r\n          success: false,\r\n          error:\r\n            \"Built-in editors are opened via deep links. Select Custom editor to use a command.\",\r\n        };\r\n      }\r\n\r\n      const customCommand = editorConfig.customCommand?.trim();\r\n      if (!customCommand) {\r\n        return { success: false, error: \"No editor command configured\" };\r\n      }\r\n\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const workspace = allMetadata.find((w) => w.id === workspaceId);\r\n\r\n      if (!workspace) {\r\n        return { success: false, error: `Workspace not found: ${workspaceId}` };\r\n      }\r\n\r\n      // Remote runtimes: custom commands run on the local machine and can't access remote paths.\r\n      if (isSSHRuntime(workspace.runtimeConfig)) {\r\n        return {\r\n          success: false,\r\n          error: \"Custom editors do not support SSH connections for SSH workspaces\",\r\n        };\r\n      }\r\n\r\n      if (isDevcontainerRuntime(workspace.runtimeConfig)) {\r\n        return { success: false, error: \"Custom editors do not support Dev Containers\" };\r\n      }\r\n      if (isDockerRuntime(workspace.runtimeConfig)) {\r\n        return { success: false, error: \"Custom editors do not support Docker containers\" };\r\n      }\r\n\r\n      const executable = getExecutableFromShellCommand(customCommand);\r\n      if (!executable) {\r\n        return { success: false, error: `Invalid custom editor command: ${customCommand}` };\r\n      }\r\n\r\n      if (!(await this.isCommandAvailable(executable))) {\r\n        return { success: false, error: `Editor command not found: ${executable}` };\r\n      }\r\n\r\n      // Local - expand tilde (shellQuote prevents shell expansion)\r\n      const resolvedPath = targetPath.startsWith(\"~/\")\r\n        ? targetPath.replace(\"~\", process.env.HOME ?? \"~\")\r\n        : targetPath;\r\n\r\n      const shellCmd = `${customCommand} ${shellQuote(resolvedPath)}`;\r\n      log.info(`Opening local path in custom editor: ${shellCmd}`);\r\n      const child = spawn(shellCmd, [], {\r\n        detached: true,\r\n        stdio: \"ignore\",\r\n        shell: true,\r\n        windowsHide: true,\r\n      });\r\n      child.unref();\r\n\r\n      return { success: true, data: undefined };\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : String(err);\r\n      log.error(`Failed to open in editor: ${message}`);\r\n      return { success: false, error: message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if a command is available in the system PATH.\r\n   * Inherits enriched PATH from process.env (set by initShellEnv at startup).\r\n   */\r\n  private async isCommandAvailable(command: string): Promise<boolean> {\r\n    try {\r\n      if (looksLikePath(command)) {\r\n        await fsPromises.access(command);\r\n        return true;\r\n      }\r\n\r\n      const lookupCommand = process.platform === \"win32\" ? \"where\" : \"which\";\r\n      const result = spawnSync(lookupCommand, [command], { encoding: \"utf8\" });\r\n      return result.status === 0;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n}\r\n"]}