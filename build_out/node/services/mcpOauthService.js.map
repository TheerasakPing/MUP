{"version":3,"file":"mcpOauthService.js","sourceRoot":"","sources":["../../../src/node/services/mcpOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as crypto from \"crypto\";\r\nimport * as http from \"http\";\r\nimport * as path from \"path\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport writeFileAtomic from \"write-file-atomic\";\r\nimport { auth, type OAuthClientProvider } from \"@ai-sdk/mcp\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { MCPConfigService } from \"@/node/services/mcpConfigService\";\r\nimport type { WindowService } from \"@/node/services/windowService\";\r\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\r\nimport { log } from \"@/node/services/log\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Err, Ok } from \"@/common/types/result\";\r\nimport { roundToBase2 } from \"@/common/telemetry/utils\";\r\nimport type {\r\n  MCPOAuthAuthStatus,\r\n  MCPOAuthClientInformation,\r\n  MCPOAuthPendingServerConfig,\r\n  MCPOAuthStoredCredentials,\r\n  MCPOAuthTokens,\r\n} from \"@/common/types/mcpOauth\";\r\nimport { stripTrailingSlashes } from \"@/node/utils/pathUtils\";\r\nimport { MutexMap } from \"@/node/utils/concurrency/mutexMap\";\r\n\r\nconst DEFAULT_DESKTOP_TIMEOUT_MS = 5 * 60 * 1000;\r\nconst DEFAULT_SERVER_TIMEOUT_MS = 10 * 60 * 1000;\r\nconst COMPLETED_FLOW_TTL_MS = 60 * 1000;\r\nconst STORE_FILE_NAME = \"mcp-oauth.json\";\r\n\r\ninterface McpOauthStoreFileV1 {\r\n  version: 1;\r\n  /** projectPath -> serverName -> stored credentials */\r\n  entries: Record<string, Record<string, MCPOAuthStoredCredentials>>;\r\n}\r\n\r\ninterface McpOauthStoreFileV2 {\r\n  version: 2;\r\n  /**\r\n   * Global credentials store.\r\n   *\r\n   * Keyed by normalizeServerUrlForComparison(creds.serverUrl).\r\n   */\r\n  entries: Record<string, MCPOAuthStoredCredentials>;\r\n}\r\n\r\ntype McpOauthStoreFile = McpOauthStoreFileV2;\r\n\r\nfunction createEmptyStore(): McpOauthStoreFileV2 {\r\n  return { version: 2, entries: {} };\r\n}\r\n\r\n// Exported for focused unit tests (WWW-Authenticate parsing) without requiring\r\n// a real OAuth server.\r\nexport interface BearerChallenge {\r\n  /** The full raw WWW-Authenticate header value (best-effort). */\r\n  raw: string;\r\n  scope?: string;\r\n  resourceMetadataUrl?: URL;\r\n}\r\n\r\ninterface OAuthFlowBase {\r\n  flowId: string;\r\n  projectPath: string;\r\n  serverName: string;\r\n\r\n  /**\r\n   * The configured MCP server URL (hash stripped), used for OAuth discovery/authorization.\r\n   *\r\n   * Important: Do NOT normalize trailing slashes here. Some servers rely on a trailing\r\n   * slash (e.g. /mcp/) so relative OAuth discovery URLs resolve under that base path.\r\n   */\r\n  serverUrlForDiscovery: string;\r\n\r\n  /**\r\n   * Normalized MCP server URL used only for credential keying and comparison.\r\n   *\r\n   * We treat /foo and /foo/ as equivalent for stored credentials, so we strip a\r\n   * non-root trailing slash.\r\n   */\r\n  serverUrlForStoreKey: string;\r\n\r\n  transport: \"http\" | \"sse\" | \"auto\";\r\n  startedAtMs: number;\r\n\r\n  /**\r\n   * OAuth client information registered for this specific flow.\r\n   *\r\n   * We keep the per-flow client_id in memory for the subsequent authorization\r\n   * code exchange.\r\n   */\r\n  clientInformation: MCPOAuthClientInformation | null;\r\n\r\n  authorizeUrl: string;\r\n  redirectUri: string;\r\n\r\n  /** Optional values discovered from WWW-Authenticate. */\r\n  scope?: string;\r\n  resourceMetadataUrl?: URL;\r\n\r\n  /** PKCE verifier for this flow (set by @ai-sdk/mcp auth()). */\r\n  codeVerifier: string | null;\r\n\r\n  timeout: ReturnType<typeof setTimeout>;\r\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\r\n\r\n  resultPromise: Promise<Result<void, string>>;\r\n  resolveResult: (result: Result<void, string>) => void;\r\n  settled: boolean;\r\n}\r\n\r\ninterface DesktopFlow extends OAuthFlowBase {\r\n  server: http.Server;\r\n}\r\n\r\ntype ServerFlow = OAuthFlowBase;\r\n\r\nfunction closeServer(server: http.Server): Promise<void> {\r\n  return new Promise((resolve) => {\r\n    server.close(() => resolve());\r\n  });\r\n}\r\n\r\nfunction createDeferred<T>(): { promise: Promise<T>; resolve: (value: T) => void } {\r\n  let resolve!: (value: T) => void;\r\n  const promise = new Promise<T>((res) => {\r\n    resolve = res;\r\n  });\r\n  return { promise, resolve };\r\n}\r\n\r\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\r\n  return Boolean(value) && typeof value === \"object\" && !Array.isArray(value);\r\n}\r\n\r\nfunction normalizeProjectPathKey(projectPath: string): string {\r\n  // Keep keys stable across callers; config already strips trailing slashes.\r\n  return stripTrailingSlashes(projectPath);\r\n}\r\n\r\n/**\r\n * Normalizes an MCP server URL only for keying/comparing stored credentials.\r\n *\r\n * Important: This MUST NOT be used for OAuth discovery/authorization requests.\r\n * Removing a trailing slash changes how relative URLs resolve (e.g. /mcp vs /mcp/).\r\n */\r\nfunction normalizeServerUrlForComparison(serverUrl: string): string | null {\r\n  try {\r\n    const url = new URL(serverUrl);\r\n\r\n    // Avoid accidental mismatch from an irrelevant hash.\r\n    url.hash = \"\";\r\n\r\n    // Normalize trailing slashes for comparison (treat /foo and /foo/ as equivalent).\r\n    if (url.pathname.endsWith(\"/\") && url.pathname !== \"/\") {\r\n      url.pathname = url.pathname.slice(0, -1);\r\n    }\r\n\r\n    return url.toString();\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Sanitizes an MCP server URL for network requests.\r\n *\r\n * This intentionally does not normalize the pathname; we only strip the hash.\r\n */\r\nfunction sanitizeServerUrlForRequest(serverUrl: string): string | null {\r\n  try {\r\n    const url = new URL(serverUrl);\r\n\r\n    if (url.protocol !== \"http:\" && url.protocol !== \"https:\") {\r\n      return null;\r\n    }\r\n\r\n    // Avoid accidental mismatch from an irrelevant hash.\r\n    url.hash = \"\";\r\n\r\n    return url.toString();\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function parseBearerWwwAuthenticate(header: string): BearerChallenge | null {\r\n  const raw = header;\r\n\r\n  // Minimal, spec-friendly extraction. We intentionally avoid implementing a full\r\n  // RFC 7235 challenge parser; we only care about a subset of Bearer params.\r\n  if (!/\\bbearer\\b/i.test(raw)) {\r\n    return null;\r\n  }\r\n\r\n  const scopeMatch = /\\bscope=\"([^\"]*)\"/i.exec(raw) ?? /\\bscope=([^,\\s]+)/i.exec(raw);\r\n  const scope = scopeMatch ? scopeMatch[1] : undefined;\r\n\r\n  const resourceMetadataMatch =\r\n    /\\bresource_metadata=\"([^\"]*)\"/i.exec(raw) ?? /\\bresource_metadata=([^,\\s]+)/i.exec(raw);\r\n\r\n  let resourceMetadataUrl: URL | undefined;\r\n  if (resourceMetadataMatch) {\r\n    try {\r\n      resourceMetadataUrl = new URL(resourceMetadataMatch[1]);\r\n    } catch {\r\n      // Ignore invalid URLs.\r\n    }\r\n  }\r\n\r\n  return {\r\n    raw,\r\n    scope,\r\n    resourceMetadataUrl,\r\n  };\r\n}\r\n\r\nasync function probeServerForBearerChallenge(serverUrl: string): Promise<BearerChallenge | null> {\r\n  const requestUrl = sanitizeServerUrlForRequest(serverUrl);\r\n  if (!requestUrl) {\r\n    return null;\r\n  }\r\n\r\n  // Best-effort probe: do a simple unauthenticated request and parse WWW-Authenticate.\r\n  //\r\n  // We intentionally avoid sending MCP-specific headers here because the probe is\r\n  // only used to extract OAuth hints (scope/resource_metadata) and must not be\r\n  // protocol-version coupled.\r\n  const abortController = new AbortController();\r\n  const timeout = setTimeout(() => abortController.abort(), 5_000);\r\n\r\n  try {\r\n    const response = await fetch(requestUrl, {\r\n      method: \"GET\",\r\n      headers: {\r\n        Accept: \"text/event-stream\",\r\n      },\r\n      redirect: \"manual\",\r\n      signal: abortController.signal,\r\n    });\r\n\r\n    const header =\r\n      response.headers.get(\"www-authenticate\") ?? response.headers.get(\"WWW-Authenticate\");\r\n    if (!header) {\r\n      return null;\r\n    }\r\n\r\n    return parseBearerWwwAuthenticate(header);\r\n  } catch {\r\n    return null;\r\n  } finally {\r\n    clearTimeout(timeout);\r\n  }\r\n}\r\n\r\nfunction parseStoredCredentials(value: unknown): MCPOAuthStoredCredentials | null {\r\n  if (!isPlainObject(value)) {\r\n    return null;\r\n  }\r\n\r\n  const serverUrlRaw = typeof value.serverUrl === \"string\" ? value.serverUrl : null;\r\n  const updatedAtMs = typeof value.updatedAtMs === \"number\" ? value.updatedAtMs : null;\r\n\r\n  if (!serverUrlRaw || updatedAtMs === null || !Number.isFinite(updatedAtMs)) {\r\n    return null;\r\n  }\r\n\r\n  const serverUrl = normalizeServerUrlForComparison(serverUrlRaw);\r\n  if (!serverUrl) {\r\n    return null;\r\n  }\r\n\r\n  const clientInformationRaw = value.clientInformation;\r\n  const clientInformation: MCPOAuthClientInformation | undefined = isPlainObject(\r\n    clientInformationRaw\r\n  )\r\n    ? {\r\n        client_id:\r\n          typeof clientInformationRaw.client_id === \"string\" ? clientInformationRaw.client_id : \"\",\r\n        client_secret:\r\n          typeof clientInformationRaw.client_secret === \"string\"\r\n            ? clientInformationRaw.client_secret\r\n            : undefined,\r\n        client_id_issued_at:\r\n          typeof clientInformationRaw.client_id_issued_at === \"number\"\r\n            ? clientInformationRaw.client_id_issued_at\r\n            : undefined,\r\n        client_secret_expires_at:\r\n          typeof clientInformationRaw.client_secret_expires_at === \"number\"\r\n            ? clientInformationRaw.client_secret_expires_at\r\n            : undefined,\r\n      }\r\n    : undefined;\r\n\r\n  if (clientInformation && !clientInformation.client_id) {\r\n    // client_id is required if the object is present.\r\n    return null;\r\n  }\r\n\r\n  const tokensRaw = value.tokens;\r\n  const tokens: MCPOAuthTokens | undefined = isPlainObject(tokensRaw)\r\n    ? {\r\n        access_token: typeof tokensRaw.access_token === \"string\" ? tokensRaw.access_token : \"\",\r\n        id_token: typeof tokensRaw.id_token === \"string\" ? tokensRaw.id_token : undefined,\r\n        token_type: typeof tokensRaw.token_type === \"string\" ? tokensRaw.token_type : \"\",\r\n        expires_in: typeof tokensRaw.expires_in === \"number\" ? tokensRaw.expires_in : undefined,\r\n        scope: typeof tokensRaw.scope === \"string\" ? tokensRaw.scope : undefined,\r\n        refresh_token:\r\n          typeof tokensRaw.refresh_token === \"string\" ? tokensRaw.refresh_token : undefined,\r\n      }\r\n    : undefined;\r\n\r\n  if (tokens && (!tokens.access_token || !tokens.token_type)) {\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    serverUrl,\r\n    clientInformation,\r\n    tokens,\r\n    updatedAtMs,\r\n  };\r\n}\r\n\r\nfunction parseStoreFile(raw: string): McpOauthStoreFileV1 | McpOauthStoreFileV2 | null {\r\n  try {\r\n    const parsed = JSON.parse(raw) as unknown;\r\n    if (!isPlainObject(parsed)) {\r\n      return null;\r\n    }\r\n\r\n    const version = parsed.version;\r\n    if (version !== 1 && version !== 2) {\r\n      return null;\r\n    }\r\n\r\n    const entriesRaw = parsed.entries;\r\n    if (!isPlainObject(entriesRaw)) {\r\n      return null;\r\n    }\r\n\r\n    if (version === 1) {\r\n      const entries: Record<string, Record<string, MCPOAuthStoredCredentials>> = {};\r\n\r\n      for (const [projectPath, byServerRaw] of Object.entries(entriesRaw)) {\r\n        if (!isPlainObject(byServerRaw)) {\r\n          continue;\r\n        }\r\n\r\n        const byServer: Record<string, MCPOAuthStoredCredentials> = {};\r\n\r\n        for (const [serverName, credRaw] of Object.entries(byServerRaw)) {\r\n          const creds = parseStoredCredentials(credRaw);\r\n          if (!creds) {\r\n            continue;\r\n          }\r\n\r\n          byServer[serverName] = creds;\r\n        }\r\n\r\n        if (Object.keys(byServer).length > 0) {\r\n          entries[projectPath] = byServer;\r\n        }\r\n      }\r\n\r\n      return { version: 1, entries };\r\n    }\r\n\r\n    // v2\r\n    const entries: Record<string, MCPOAuthStoredCredentials> = {};\r\n\r\n    for (const credRaw of Object.values(entriesRaw)) {\r\n      const creds = parseStoredCredentials(credRaw);\r\n      if (!creds) {\r\n        continue;\r\n      }\r\n\r\n      const serverUrlKey = creds.serverUrl;\r\n      const existing = entries[serverUrlKey];\r\n\r\n      if (!existing || creds.updatedAtMs > existing.updatedAtMs) {\r\n        entries[serverUrlKey] = creds;\r\n      }\r\n    }\r\n\r\n    return { version: 2, entries };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction migrateStoreV1ToV2(store: McpOauthStoreFileV1): McpOauthStoreFileV2 {\r\n  const entries: Record<string, MCPOAuthStoredCredentials> = {};\r\n\r\n  for (const byServer of Object.values(store.entries)) {\r\n    for (const creds of Object.values(byServer)) {\r\n      const serverUrlKey = normalizeServerUrlForComparison(creds.serverUrl);\r\n      if (!serverUrlKey) {\r\n        continue;\r\n      }\r\n\r\n      const existing = entries[serverUrlKey];\r\n      if (!existing || creds.updatedAtMs > existing.updatedAtMs) {\r\n        entries[serverUrlKey] = {\r\n          ...creds,\r\n          serverUrl: serverUrlKey,\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  return { version: 2, entries };\r\n}\r\n\r\nexport class McpOauthService {\r\n  private readonly storeFilePath: string;\r\n  private readonly storeLock = new MutexMap<string>();\r\n  private store: McpOauthStoreFile | null = null;\r\n\r\n  private readonly desktopFlows = new Map<string, DesktopFlow>();\r\n  private readonly serverFlows = new Map<string, ServerFlow>();\r\n  private readonly telemetryService?: TelemetryService;\r\n\r\n  constructor(\r\n    private readonly config: Config,\r\n    private readonly mcpConfigService: MCPConfigService,\r\n    private readonly windowService?: WindowService,\r\n    telemetryService?: TelemetryService\r\n  ) {\r\n    this.telemetryService = telemetryService;\r\n    this.storeFilePath = path.join(config.rootDir, STORE_FILE_NAME);\r\n  }\r\n\r\n  async dispose(): Promise<void> {\r\n    // Best-effort: cancel all in-flight flows.\r\n    const desktopFlowIds = [...this.desktopFlows.keys()];\r\n    const serverFlowIds = [...this.serverFlows.keys()];\r\n\r\n    await Promise.all([\r\n      ...desktopFlowIds.map((id) => this.finishDesktopFlow(id, Err(\"App shutting down\"))),\r\n      ...serverFlowIds.map((id) => this.finishServerFlow(id, Err(\"App shutting down\"))),\r\n    ]);\r\n\r\n    for (const flow of this.desktopFlows.values()) {\r\n      clearTimeout(flow.timeout);\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n    }\r\n\r\n    for (const flow of this.serverFlows.values()) {\r\n      clearTimeout(flow.timeout);\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n    }\r\n\r\n    this.desktopFlows.clear();\r\n    this.serverFlows.clear();\r\n  }\r\n\r\n  async getAuthStatus(input: { serverUrl: string }): Promise<MCPOAuthAuthStatus> {\r\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\r\n    if (!normalizedServerUrl) {\r\n      return { isLoggedIn: false, hasRefreshToken: false };\r\n    }\r\n\r\n    const creds = await this.getValidStoredCredentials({ serverUrl: normalizedServerUrl });\r\n\r\n    const tokens = creds?.tokens;\r\n    return {\r\n      serverUrl: normalizedServerUrl,\r\n      isLoggedIn: Boolean(tokens),\r\n      hasRefreshToken: Boolean(tokens?.refresh_token),\r\n      scope: tokens?.scope,\r\n      updatedAtMs: creds?.updatedAtMs,\r\n    };\r\n  }\r\n\r\n  async logout(input: { serverUrl: string }): Promise<Result<void, string>> {\r\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\r\n    if (!normalizedServerUrl) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    try {\r\n      await this.storeLock.withLock(this.storeFilePath, async () => {\r\n        const store = await this.ensureStoreLoadedLocked();\r\n        if (!store.entries[normalizedServerUrl]) {\r\n          return;\r\n        }\r\n\r\n        delete store.entries[normalizedServerUrl];\r\n        await this.persistStoreLocked(store);\r\n      });\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a provider suitable for attaching to an MCP HTTP/SSE transport.\r\n   *\r\n   * Critical: This must never trigger user-interactive auth in the background.\r\n   * Therefore we only return a provider when tokens exist and we ensure\r\n   * redirectToAuthorization never opens a browser.\r\n   */\r\n  async getAuthProviderForServer(input: {\r\n    serverUrl: string;\r\n    serverName?: string;\r\n  }): Promise<OAuthClientProvider | undefined> {\r\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\r\n    if (!normalizedServerUrl) {\r\n      return undefined;\r\n    }\r\n\r\n    const creds = await this.getValidStoredCredentials({ serverUrl: normalizedServerUrl });\r\n\r\n    if (!creds?.tokens || !creds.clientInformation) {\r\n      return undefined;\r\n    }\r\n\r\n    return this.createBackgroundProvider({\r\n      serverUrl: normalizedServerUrl,\r\n      serverName: input.serverName,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Used by MCPServerManager caching to restart servers when auth state changes.\r\n   */\r\n  async hasAuthTokens(input: { serverUrl: string }): Promise<boolean> {\r\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\r\n    if (!normalizedServerUrl) {\r\n      return false;\r\n    }\r\n\r\n    const creds = await this.getValidStoredCredentials({ serverUrl: normalizedServerUrl });\r\n    return Boolean(creds?.tokens && creds.clientInformation);\r\n  }\r\n\r\n  private async resolveServerForOauthFlow(input: {\r\n    projectPath: string;\r\n    serverName: string;\r\n    pendingServer?: MCPOAuthPendingServerConfig;\r\n  }): Promise<\r\n    Result<\r\n      {\r\n        serverUrlForDiscovery: string;\r\n        serverUrlForStoreKey: string;\r\n        transport: \"http\" | \"sse\" | \"auto\";\r\n      },\r\n      string\r\n    >\r\n  > {\r\n    if (input.pendingServer) {\r\n      // Defensive: pendingServer comes from user input (add-server form), so validate.\r\n      const transport = input.pendingServer.transport;\r\n      if (transport !== \"http\" && transport !== \"sse\" && transport !== \"auto\") {\r\n        return Err(\"OAuth is only supported for remote (http/sse) MCP servers\");\r\n      }\r\n\r\n      const serverUrlForDiscovery = sanitizeServerUrlForRequest(input.pendingServer.url);\r\n      if (!serverUrlForDiscovery) {\r\n        return Err(\"Invalid MCP server URL\");\r\n      }\r\n\r\n      const serverUrlForStoreKey = normalizeServerUrlForComparison(serverUrlForDiscovery);\r\n      if (!serverUrlForStoreKey) {\r\n        return Err(\"Invalid MCP server URL\");\r\n      }\r\n\r\n      return Ok({ serverUrlForDiscovery, serverUrlForStoreKey, transport });\r\n    }\r\n\r\n    const servers = await this.mcpConfigService.listServers(input.projectPath);\r\n    const server = servers[input.serverName];\r\n    if (!server) {\r\n      return Err(\"MCP server not found\");\r\n    }\r\n\r\n    if (server.transport === \"stdio\") {\r\n      return Err(\"OAuth is only supported for remote (http/sse) MCP servers\");\r\n    }\r\n\r\n    const serverUrlForDiscovery = sanitizeServerUrlForRequest(server.url);\r\n    if (!serverUrlForDiscovery) {\r\n      return Err(\"Invalid MCP server URL\");\r\n    }\r\n\r\n    const serverUrlForStoreKey = normalizeServerUrlForComparison(serverUrlForDiscovery);\r\n    if (!serverUrlForStoreKey) {\r\n      return Err(\"Invalid MCP server URL\");\r\n    }\r\n\r\n    return Ok({ serverUrlForDiscovery, serverUrlForStoreKey, transport: server.transport });\r\n  }\r\n\r\n  async startDesktopFlow(input: {\r\n    projectPath: string;\r\n    serverName: string;\r\n    pendingServer?: MCPOAuthPendingServerConfig;\r\n  }): Promise<Result<{ flowId: string; authorizeUrl: string; redirectUri: string }, string>> {\r\n    const serverConfig = await this.resolveServerForOauthFlow(input);\r\n    if (!serverConfig.success) {\r\n      return Err(serverConfig.error);\r\n    }\r\n\r\n    const serverUrlForDiscovery = serverConfig.data.serverUrlForDiscovery;\r\n    const serverUrlForStoreKey = serverConfig.data.serverUrlForStoreKey;\r\n    const transport = serverConfig.data.transport;\r\n\r\n    const projectKey = normalizeProjectPathKey(input.projectPath);\r\n\r\n    const flowId = crypto.randomUUID();\r\n    const { promise: resultPromise, resolve: resolveResult } =\r\n      createDeferred<Result<void, string>>();\r\n\r\n    const serverListener = http.createServer((req, res) => {\r\n      const reqUrl = req.url ?? \"/\";\r\n      const url = new URL(reqUrl, \"http://localhost\");\r\n\r\n      if (req.method !== \"GET\" || url.pathname !== \"/callback\") {\r\n        res.statusCode = 404;\r\n        res.end(\"Not found\");\r\n        return;\r\n      }\r\n\r\n      const state = url.searchParams.get(\"state\");\r\n      if (state !== flowId) {\r\n        res.statusCode = 400;\r\n        res.setHeader(\"Content-Type\", \"text/html\");\r\n        res.end(\"<h1>Invalid OAuth state</h1>\");\r\n\r\n        // Strict state validation: if we receive an OAuth callback that doesn't\r\n        // match the active flow state, fail the flow rather than waiting for a timeout.\r\n        //\r\n        // Note: We only fail once the flow has an authorizeUrl to avoid cancelling\r\n        // due to unrelated localhost probes against the ephemeral loopback port.\r\n        const flow = this.desktopFlows.get(flowId);\r\n        if (flow?.authorizeUrl && !flow?.settled) {\r\n          void this.finishDesktopFlow(flowId, Err(\"Invalid OAuth state\"));\r\n        }\r\n        return;\r\n      }\r\n\r\n      const code = url.searchParams.get(\"code\");\r\n      const error = url.searchParams.get(\"error\");\r\n      const errorDescription = url.searchParams.get(\"error_description\") ?? undefined;\r\n\r\n      void this.handleDesktopCallback({\r\n        flowId,\r\n        code,\r\n        error,\r\n        errorDescription,\r\n        res,\r\n      });\r\n    });\r\n\r\n    try {\r\n      await new Promise<void>((resolve, reject) => {\r\n        serverListener.once(\"error\", reject);\r\n        serverListener.listen(0, \"127.0.0.1\", () => resolve());\r\n      });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to start OAuth callback listener: ${message}`);\r\n    }\r\n\r\n    const address = serverListener.address();\r\n    if (!address || typeof address === \"string\") {\r\n      await closeServer(serverListener).catch(() => undefined);\r\n      return Err(\"Failed to determine OAuth callback listener port\");\r\n    }\r\n\r\n    const redirectUri = `http://127.0.0.1:${address.port}/callback`;\r\n\r\n    // Best-effort probe for OAuth hints (scope/resource_metadata). If it fails,\r\n    // @ai-sdk/mcp can still fall back to well-known discovery.\r\n    const challenge = await probeServerForBearerChallenge(serverUrlForDiscovery);\r\n\r\n    const flow: DesktopFlow = {\r\n      flowId,\r\n      projectPath: projectKey,\r\n      serverName: input.serverName,\r\n      serverUrlForDiscovery,\r\n      serverUrlForStoreKey,\r\n      transport,\r\n      startedAtMs: Date.now(),\r\n      clientInformation: null,\r\n      authorizeUrl: \"\",\r\n      redirectUri,\r\n      scope: challenge?.scope,\r\n      resourceMetadataUrl: challenge?.resourceMetadataUrl,\r\n      codeVerifier: null,\r\n      server: serverListener,\r\n      timeout: setTimeout(() => {\r\n        void this.finishDesktopFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\r\n      }, DEFAULT_DESKTOP_TIMEOUT_MS),\r\n      cleanupTimeout: null,\r\n      resultPromise,\r\n      resolveResult,\r\n      settled: false,\r\n    };\r\n\r\n    this.desktopFlows.set(flowId, flow);\r\n\r\n    this.captureTelemetry({\r\n      event: \"mcp_oauth_flow_started\",\r\n      properties: {\r\n        transport: flow.transport,\r\n        has_scope_hint: Boolean(flow.scope),\r\n        has_resource_metadata_hint: Boolean(flow.resourceMetadataUrl),\r\n      },\r\n    });\r\n\r\n    try {\r\n      // Force a user-interactive flow by not exposing existing tokens.\r\n      const provider = this.createFlowProvider(flow);\r\n\r\n      const result = await auth(provider, {\r\n        serverUrl: serverUrlForDiscovery,\r\n        scope: flow.scope,\r\n        resourceMetadataUrl: flow.resourceMetadataUrl,\r\n      });\r\n\r\n      if (result !== \"REDIRECT\" || !flow.authorizeUrl) {\r\n        // If auth() completes without redirecting the user, treat it as a failure\r\n        // and tear down the loopback listener.\r\n        await this.finishDesktopFlow(flowId, Err(\"Failed to start OAuth authorization\"));\r\n        return Err(\"Failed to start OAuth authorization\");\r\n      }\r\n\r\n      log.debug(\"[MCP OAuth] Desktop flow started\", {\r\n        flowId,\r\n        projectPath: projectKey,\r\n        serverName: input.serverName,\r\n      });\r\n\r\n      return Ok({ flowId, authorizeUrl: flow.authorizeUrl, redirectUri });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      await this.finishDesktopFlow(flowId, Err(message));\r\n      return Err(message);\r\n    }\r\n  }\r\n\r\n  async waitForDesktopFlow(\r\n    flowId: string,\r\n    opts?: { timeoutMs?: number }\r\n  ): Promise<Result<void, string>> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow) {\r\n      return Err(\"OAuth flow not found\");\r\n    }\r\n\r\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DESKTOP_TIMEOUT_MS;\r\n\r\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\r\n      timeoutHandle = setTimeout(() => {\r\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\r\n      }, timeoutMs);\r\n    });\r\n\r\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\r\n\r\n    if (timeoutHandle !== null) {\r\n      clearTimeout(timeoutHandle);\r\n    }\r\n\r\n    if (!result.success) {\r\n      void this.finishDesktopFlow(flowId, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  async cancelDesktopFlow(flowId: string): Promise<void> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow) return;\r\n\r\n    log.debug(\"[MCP OAuth] Desktop flow cancelled\", { flowId });\r\n    await this.finishDesktopFlow(flowId, Err(\"OAuth flow cancelled\"));\r\n  }\r\n\r\n  async startServerFlow(input: {\r\n    projectPath: string;\r\n    serverName: string;\r\n    redirectUri: string;\r\n    pendingServer?: MCPOAuthPendingServerConfig;\r\n  }): Promise<Result<{ flowId: string; authorizeUrl: string; redirectUri: string }, string>> {\r\n    const serverConfig = await this.resolveServerForOauthFlow(input);\r\n    if (!serverConfig.success) {\r\n      return Err(serverConfig.error);\r\n    }\r\n\r\n    const serverUrlForDiscovery = serverConfig.data.serverUrlForDiscovery;\r\n    const serverUrlForStoreKey = serverConfig.data.serverUrlForStoreKey;\r\n    const transport = serverConfig.data.transport;\r\n\r\n    let redirectUri: URL;\r\n    try {\r\n      redirectUri = new URL(input.redirectUri);\r\n    } catch {\r\n      return Err(\"Invalid OAuth redirect URI\");\r\n    }\r\n\r\n    if (redirectUri.protocol !== \"http:\" && redirectUri.protocol !== \"https:\") {\r\n      return Err(\"OAuth redirect URI must be http(s)\");\r\n    }\r\n\r\n    const projectKey = normalizeProjectPathKey(input.projectPath);\r\n\r\n    const flowId = crypto.randomUUID();\r\n    const { promise: resultPromise, resolve: resolveResult } =\r\n      createDeferred<Result<void, string>>();\r\n\r\n    // Best-effort probe for OAuth hints (scope/resource_metadata). If it fails,\r\n    // @ai-sdk/mcp can still fall back to well-known discovery.\r\n    const challenge = await probeServerForBearerChallenge(serverUrlForDiscovery);\r\n\r\n    const flow: ServerFlow = {\r\n      flowId,\r\n      projectPath: projectKey,\r\n      serverName: input.serverName,\r\n      serverUrlForDiscovery,\r\n      serverUrlForStoreKey,\r\n      transport,\r\n      startedAtMs: Date.now(),\r\n      clientInformation: null,\r\n      authorizeUrl: \"\",\r\n      redirectUri: redirectUri.toString(),\r\n      scope: challenge?.scope,\r\n      resourceMetadataUrl: challenge?.resourceMetadataUrl,\r\n      codeVerifier: null,\r\n      timeout: setTimeout(() => {\r\n        void this.finishServerFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\r\n      }, DEFAULT_SERVER_TIMEOUT_MS),\r\n      cleanupTimeout: null,\r\n      resultPromise,\r\n      resolveResult,\r\n      settled: false,\r\n    };\r\n\r\n    this.serverFlows.set(flowId, flow);\r\n\r\n    this.captureTelemetry({\r\n      event: \"mcp_oauth_flow_started\",\r\n      properties: {\r\n        transport: flow.transport,\r\n        has_scope_hint: Boolean(flow.scope),\r\n        has_resource_metadata_hint: Boolean(flow.resourceMetadataUrl),\r\n      },\r\n    });\r\n\r\n    try {\r\n      // Force a user-interactive flow by not exposing existing tokens.\r\n      const provider = this.createFlowProvider(flow);\r\n\r\n      const result = await auth(provider, {\r\n        serverUrl: serverUrlForDiscovery,\r\n        scope: flow.scope,\r\n        resourceMetadataUrl: flow.resourceMetadataUrl,\r\n      });\r\n\r\n      if (result !== \"REDIRECT\" || !flow.authorizeUrl) {\r\n        await this.finishServerFlow(flowId, Err(\"Failed to start OAuth authorization\"));\r\n        return Err(\"Failed to start OAuth authorization\");\r\n      }\r\n\r\n      log.debug(\"[MCP OAuth] Server flow started\", {\r\n        flowId,\r\n        projectPath: projectKey,\r\n        serverName: input.serverName,\r\n      });\r\n\r\n      return Ok({ flowId, authorizeUrl: flow.authorizeUrl, redirectUri: flow.redirectUri });\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      await this.finishServerFlow(flowId, Err(message));\r\n      return Err(message);\r\n    }\r\n  }\r\n\r\n  async waitForServerFlow(\r\n    flowId: string,\r\n    opts?: { timeoutMs?: number }\r\n  ): Promise<Result<void, string>> {\r\n    const flow = this.serverFlows.get(flowId);\r\n    if (!flow) {\r\n      return Err(\"OAuth flow not found\");\r\n    }\r\n\r\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_SERVER_TIMEOUT_MS;\r\n\r\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\r\n      timeoutHandle = setTimeout(() => {\r\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\r\n      }, timeoutMs);\r\n    });\r\n\r\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\r\n\r\n    if (timeoutHandle !== null) {\r\n      clearTimeout(timeoutHandle);\r\n    }\r\n\r\n    if (!result.success) {\r\n      void this.finishServerFlow(flowId, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  async cancelServerFlow(flowId: string): Promise<void> {\r\n    const flow = this.serverFlows.get(flowId);\r\n    if (!flow) return;\r\n\r\n    log.debug(\"[MCP OAuth] Server flow cancelled\", { flowId });\r\n    await this.finishServerFlow(flowId, Err(\"OAuth flow cancelled\"));\r\n  }\r\n\r\n  async handleServerCallbackAndExchange(input: {\r\n    state: string | null;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n  }): Promise<Result<void, string>> {\r\n    const state = input.state;\r\n    if (!state) {\r\n      return Err(\"Missing OAuth state\");\r\n    }\r\n\r\n    const flow = this.serverFlows.get(state);\r\n    if (!flow) {\r\n      return Err(\"Unknown OAuth state\");\r\n    }\r\n\r\n    if (flow.settled) {\r\n      return Err(\"OAuth flow already completed\");\r\n    }\r\n\r\n    log.debug(\"[MCP OAuth] Server callback received\", { flowId: state });\r\n\r\n    const result = await this.exchangeAuthorizationCode(flow, {\r\n      code: input.code,\r\n      error: input.error,\r\n      errorDescription: input.errorDescription,\r\n    });\r\n\r\n    await this.finishServerFlow(state, result);\r\n\r\n    return result;\r\n  }\r\n\r\n  private captureTelemetry(payload: Parameters<TelemetryService[\"capture\"]>[0]): void {\r\n    try {\r\n      this.telemetryService?.capture(payload);\r\n    } catch (error) {\r\n      // Telemetry must never block or crash OAuth flows.\r\n      log.debug(\"[MCP OAuth] Failed to capture telemetry\", { error });\r\n    }\r\n  }\r\n\r\n  private getOAuthFlowErrorCategory(\r\n    error: string\r\n  ): \"timeout\" | \"cancelled\" | \"state_mismatch\" | \"provider_error\" | \"unknown\" {\r\n    const lower = error.toLowerCase();\r\n\r\n    if (lower.includes(\"timed out\")) {\r\n      return \"timeout\";\r\n    }\r\n\r\n    if (lower.includes(\"cancelled\")) {\r\n      return \"cancelled\";\r\n    }\r\n\r\n    if (lower.includes(\"invalid oauth state\")) {\r\n      return \"state_mismatch\";\r\n    }\r\n\r\n    if (lower.includes(\"oauth\")) {\r\n      return \"provider_error\";\r\n    }\r\n\r\n    return \"unknown\";\r\n  }\r\n\r\n  private createFlowProvider(flow: OAuthFlowBase): OAuthClientProvider {\r\n    return {\r\n      tokens: () => Promise.resolve(undefined),\r\n      saveTokens: async (tokens) => {\r\n        await this.saveTokens({\r\n          serverUrl: flow.serverUrlForStoreKey,\r\n          tokens: tokens as unknown as MCPOAuthTokens,\r\n        });\r\n      },\r\n      redirectToAuthorization: (authorizationUrl) => {\r\n        flow.authorizeUrl = authorizationUrl.toString();\r\n        return Promise.resolve();\r\n      },\r\n      saveCodeVerifier: (codeVerifier) => {\r\n        flow.codeVerifier = codeVerifier;\r\n        return Promise.resolve();\r\n      },\r\n      codeVerifier: () => {\r\n        if (!flow.codeVerifier) {\r\n          return Promise.reject(new Error(\"Missing PKCE code verifier\"));\r\n        }\r\n        return Promise.resolve(flow.codeVerifier);\r\n      },\r\n      invalidateCredentials: async (scope) => {\r\n        await this.invalidateStoredCredentials({\r\n          serverUrl: flow.serverUrlForStoreKey,\r\n          scope,\r\n        });\r\n      },\r\n      get redirectUrl() {\r\n        return flow.redirectUri;\r\n      },\r\n      get clientMetadata() {\r\n        return {\r\n          redirect_uris: [flow.redirectUri],\r\n          response_types: [\"code\"],\r\n          grant_types: [\"authorization_code\", \"refresh_token\"],\r\n          token_endpoint_auth_method: \"none\",\r\n          client_name: \"Mux\",\r\n          scope: flow.scope,\r\n        };\r\n      },\r\n      clientInformation: () => {\r\n        // We intentionally register an OAuth client per interactive flow because the\r\n        // redirect URI may vary between environments (desktop loopback ports, proxied\r\n        // server origins, etc.).\r\n        return Promise.resolve(flow.clientInformation ?? undefined);\r\n      },\r\n      saveClientInformation: async (clientInformation) => {\r\n        const next = clientInformation as unknown as MCPOAuthClientInformation;\r\n        flow.clientInformation = next;\r\n\r\n        await this.saveClientInformation({\r\n          serverUrl: flow.serverUrlForStoreKey,\r\n          clientInformation: next,\r\n        });\r\n      },\r\n      state: () => Promise.resolve(flow.flowId),\r\n    };\r\n  }\r\n\r\n  private createBackgroundProvider(input: {\r\n    serverUrl: string;\r\n    serverName?: string;\r\n  }): OAuthClientProvider {\r\n    return {\r\n      tokens: async () => {\r\n        const creds = await this.getValidStoredCredentials({ serverUrl: input.serverUrl });\r\n        return creds?.tokens as unknown as MCPOAuthTokens | undefined;\r\n      },\r\n      saveTokens: async (tokens) => {\r\n        await this.saveTokens({\r\n          serverUrl: input.serverUrl,\r\n          tokens: tokens as unknown as MCPOAuthTokens,\r\n        });\r\n      },\r\n      redirectToAuthorization: async () => {\r\n        // Avoid any user-visible side effects during background tool calls.\r\n        // If we end up here, the server requires interactive auth.\r\n        await this.invalidateStoredCredentials({\r\n          serverUrl: input.serverUrl,\r\n          scope: \"tokens\",\r\n        });\r\n        throw new Error(\"MCP OAuth login required\");\r\n      },\r\n      saveCodeVerifier: () => {\r\n        // Background providers never start interactive flows.\r\n        return Promise.resolve();\r\n      },\r\n      codeVerifier: () => Promise.reject(new Error(\"PKCE verifier is not available\")),\r\n      invalidateCredentials: async (scope) => {\r\n        await this.invalidateStoredCredentials({\r\n          serverUrl: input.serverUrl,\r\n          scope,\r\n        });\r\n      },\r\n      get redirectUrl() {\r\n        // Unused in background mode.\r\n        return \"http://127.0.0.1/\";\r\n      },\r\n      get clientMetadata() {\r\n        // Unused in background mode; must still be present for the interface.\r\n        return {\r\n          redirect_uris: [\"http://127.0.0.1/\"],\r\n        };\r\n      },\r\n      clientInformation: async () => {\r\n        const creds = await this.getValidStoredCredentials({ serverUrl: input.serverUrl });\r\n        return creds?.clientInformation as unknown as MCPOAuthClientInformation | undefined;\r\n      },\r\n      saveClientInformation: async (clientInformation) => {\r\n        await this.saveClientInformation({\r\n          serverUrl: input.serverUrl,\r\n          clientInformation: clientInformation as unknown as MCPOAuthClientInformation,\r\n        });\r\n      },\r\n    };\r\n  }\r\n\r\n  private async handleDesktopCallback(input: {\r\n    flowId: string;\r\n    code: string | null;\r\n    error: string | null;\r\n    errorDescription?: string;\r\n    res: http.ServerResponse;\r\n  }): Promise<void> {\r\n    const flow = this.desktopFlows.get(input.flowId);\r\n    if (!flow || flow.settled) {\r\n      input.res.statusCode = 409;\r\n      input.res.setHeader(\"Content-Type\", \"text/html\");\r\n      input.res.end(\"<h1>OAuth flow already completed</h1>\");\r\n      return;\r\n    }\r\n\r\n    log.debug(\"[MCP OAuth] Callback received\", { flowId: input.flowId });\r\n\r\n    const result = await this.exchangeAuthorizationCode(flow, {\r\n      code: input.code,\r\n      error: input.error,\r\n      errorDescription: input.errorDescription,\r\n    });\r\n\r\n    const title = result.success ? \"Login complete\" : \"Login failed\";\r\n    const description = result.success\r\n      ? \"You can return to Mux. You may now close this tab.\"\r\n      : escapeHtml(result.error);\r\n\r\n    input.res.setHeader(\"Content-Type\", \"text/html\");\r\n    if (!result.success) {\r\n      input.res.statusCode = 400;\r\n    }\r\n\r\n    input.res.end(`<!doctype html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"utf-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <meta name=\"color-scheme\" content=\"dark light\" />\r\n    <title>${title}</title>\r\n  </head>\r\n  <body>\r\n    <h1>${title}</h1>\r\n    <p>${description}</p>\r\n  </body>\r\n</html>`);\r\n\r\n    await this.finishDesktopFlow(input.flowId, result);\r\n  }\r\n\r\n  private async exchangeAuthorizationCode(\r\n    flow: OAuthFlowBase,\r\n    input: { code: string | null; error: string | null; errorDescription?: string }\r\n  ): Promise<Result<void, string>> {\r\n    if (input.error) {\r\n      const message = input.errorDescription\r\n        ? `${input.error}: ${input.errorDescription}`\r\n        : input.error;\r\n      return Err(`MCP OAuth error: ${message}`);\r\n    }\r\n\r\n    if (!input.code) {\r\n      return Err(\"Missing OAuth code\");\r\n    }\r\n\r\n    try {\r\n      const provider = this.createFlowProvider(flow);\r\n\r\n      const result = await auth(provider, {\r\n        serverUrl: flow.serverUrlForDiscovery,\r\n        authorizationCode: input.code,\r\n        scope: flow.scope,\r\n        resourceMetadataUrl: flow.resourceMetadataUrl,\r\n      });\r\n\r\n      if (result !== \"AUTHORIZED\") {\r\n        return Err(\"OAuth exchange did not complete\");\r\n      }\r\n\r\n      this.windowService?.focusMainWindow();\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(message);\r\n    }\r\n  }\r\n\r\n  private async finishDesktopFlow(flowId: string, result: Result<void, string>): Promise<void> {\r\n    const flow = this.desktopFlows.get(flowId);\r\n    if (!flow || flow.settled) return;\r\n\r\n    flow.settled = true;\r\n    clearTimeout(flow.timeout);\r\n\r\n    const durationMs = Math.max(0, Date.now() - flow.startedAtMs);\r\n    const durationMsB2 = roundToBase2(durationMs);\r\n    const hasScopeHint = Boolean(flow.scope);\r\n    const hasResourceMetadataHint = Boolean(flow.resourceMetadataUrl);\r\n\r\n    if (result.success) {\r\n      this.captureTelemetry({\r\n        event: \"mcp_oauth_flow_completed\",\r\n        properties: {\r\n          transport: flow.transport,\r\n          duration_ms_b2: durationMsB2,\r\n          has_scope_hint: hasScopeHint,\r\n          has_resource_metadata_hint: hasResourceMetadataHint,\r\n        },\r\n      });\r\n    } else {\r\n      const errorCategory = this.getOAuthFlowErrorCategory(result.error);\r\n      this.captureTelemetry({\r\n        event: \"mcp_oauth_flow_failed\",\r\n        properties: {\r\n          transport: flow.transport,\r\n          duration_ms_b2: durationMsB2,\r\n          has_scope_hint: hasScopeHint,\r\n          has_resource_metadata_hint: hasResourceMetadataHint,\r\n          error_category: errorCategory,\r\n        },\r\n      });\r\n    }\r\n\r\n    try {\r\n      flow.resolveResult(result);\r\n\r\n      await closeServer(flow.server);\r\n    } catch (error) {\r\n      log.debug(\"[MCP OAuth] Failed to close OAuth callback listener\", { error });\r\n    } finally {\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n      flow.cleanupTimeout = setTimeout(() => {\r\n        this.desktopFlows.delete(flowId);\r\n      }, COMPLETED_FLOW_TTL_MS);\r\n    }\r\n  }\r\n\r\n  private finishServerFlow(flowId: string, result: Result<void, string>): Promise<void> {\r\n    const flow = this.serverFlows.get(flowId);\r\n    if (!flow || flow.settled) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    flow.settled = true;\r\n    clearTimeout(flow.timeout);\r\n\r\n    const durationMs = Math.max(0, Date.now() - flow.startedAtMs);\r\n    const durationMsB2 = roundToBase2(durationMs);\r\n    const hasScopeHint = Boolean(flow.scope);\r\n    const hasResourceMetadataHint = Boolean(flow.resourceMetadataUrl);\r\n\r\n    if (result.success) {\r\n      this.captureTelemetry({\r\n        event: \"mcp_oauth_flow_completed\",\r\n        properties: {\r\n          transport: flow.transport,\r\n          duration_ms_b2: durationMsB2,\r\n          has_scope_hint: hasScopeHint,\r\n          has_resource_metadata_hint: hasResourceMetadataHint,\r\n        },\r\n      });\r\n    } else {\r\n      const errorCategory = this.getOAuthFlowErrorCategory(result.error);\r\n      this.captureTelemetry({\r\n        event: \"mcp_oauth_flow_failed\",\r\n        properties: {\r\n          transport: flow.transport,\r\n          duration_ms_b2: durationMsB2,\r\n          has_scope_hint: hasScopeHint,\r\n          has_resource_metadata_hint: hasResourceMetadataHint,\r\n          error_category: errorCategory,\r\n        },\r\n      });\r\n    }\r\n\r\n    try {\r\n      flow.resolveResult(result);\r\n    } finally {\r\n      if (flow.cleanupTimeout !== null) {\r\n        clearTimeout(flow.cleanupTimeout);\r\n      }\r\n      flow.cleanupTimeout = setTimeout(() => {\r\n        this.serverFlows.delete(flowId);\r\n      }, COMPLETED_FLOW_TTL_MS);\r\n    }\r\n\r\n    return Promise.resolve();\r\n  }\r\n\r\n  private async getValidStoredCredentials(input: {\r\n    serverUrl: string;\r\n  }): Promise<MCPOAuthStoredCredentials | null> {\r\n    await this.ensureStoreLoaded();\r\n    const store = this.store;\r\n    if (!store) {\r\n      return null;\r\n    }\r\n\r\n    const creds = store.entries[input.serverUrl];\r\n    if (!creds) {\r\n      return null;\r\n    }\r\n\r\n    // Defensive: Never use credentials bound to a different (normalized) URL.\r\n    //\r\n    // This shouldn't happen in a well-formed v2 store, but it can happen if the\r\n    // store file is manually edited or corrupted.\r\n    const storedUrlKey = normalizeServerUrlForComparison(creds.serverUrl);\r\n    if (!storedUrlKey || storedUrlKey !== input.serverUrl) {\r\n      await this.logout({ serverUrl: input.serverUrl });\r\n      return null;\r\n    }\r\n\r\n    return creds;\r\n  }\r\n\r\n  private async invalidateStoredCredentials(input: {\r\n    serverUrl: string;\r\n    scope: \"all\" | \"client\" | \"tokens\" | \"verifier\";\r\n  }): Promise<void> {\r\n    await this.storeLock.withLock(this.storeFilePath, async () => {\r\n      const store = await this.ensureStoreLoadedLocked();\r\n      const creds = store.entries[input.serverUrl];\r\n      if (!creds) {\r\n        return;\r\n      }\r\n\r\n      if (input.scope === \"tokens\" || input.scope === \"all\") {\r\n        creds.tokens = undefined;\r\n      }\r\n\r\n      if (input.scope === \"client\" || input.scope === \"all\") {\r\n        creds.clientInformation = undefined;\r\n      }\r\n\r\n      // verifier is per-flow (in-memory) only.\r\n\r\n      creds.updatedAtMs = Date.now();\r\n\r\n      // If everything is gone, prune the entry.\r\n      if (!creds.tokens && !creds.clientInformation) {\r\n        delete store.entries[input.serverUrl];\r\n      }\r\n\r\n      await this.persistStoreLocked(store);\r\n    });\r\n  }\r\n\r\n  private async saveTokens(input: { serverUrl: string; tokens: MCPOAuthTokens }): Promise<void> {\r\n    await this.storeLock.withLock(this.storeFilePath, async () => {\r\n      const store = await this.ensureStoreLoadedLocked();\r\n      const creds = (store.entries[input.serverUrl] ??= {\r\n        serverUrl: input.serverUrl,\r\n        updatedAtMs: Date.now(),\r\n      });\r\n\r\n      // Defensive: Never keep tokens bound to a different URL.\r\n      if (normalizeServerUrlForComparison(creds.serverUrl) !== input.serverUrl) {\r\n        creds.clientInformation = undefined;\r\n      }\r\n\r\n      creds.serverUrl = input.serverUrl;\r\n      creds.tokens = input.tokens;\r\n      creds.updatedAtMs = Date.now();\r\n\r\n      await this.persistStoreLocked(store);\r\n    });\r\n  }\r\n\r\n  private async saveClientInformation(input: {\r\n    serverUrl: string;\r\n    clientInformation: MCPOAuthClientInformation;\r\n  }): Promise<void> {\r\n    await this.storeLock.withLock(this.storeFilePath, async () => {\r\n      const store = await this.ensureStoreLoadedLocked();\r\n      const creds = (store.entries[input.serverUrl] ??= {\r\n        serverUrl: input.serverUrl,\r\n        updatedAtMs: Date.now(),\r\n      });\r\n\r\n      // Defensive: Never keep client info bound to a different URL.\r\n      if (normalizeServerUrlForComparison(creds.serverUrl) !== input.serverUrl) {\r\n        creds.tokens = undefined;\r\n      }\r\n\r\n      // Defensive: Refresh tokens are bound to a specific OAuth client_id.\r\n      if (\r\n        creds.clientInformation?.client_id &&\r\n        creds.clientInformation.client_id !== input.clientInformation.client_id\r\n      ) {\r\n        creds.tokens = undefined;\r\n      }\r\n\r\n      creds.serverUrl = input.serverUrl;\r\n      creds.clientInformation = input.clientInformation;\r\n      creds.updatedAtMs = Date.now();\r\n\r\n      await this.persistStoreLocked(store);\r\n    });\r\n  }\r\n\r\n  private async ensureStoreLoaded(): Promise<void> {\r\n    if (this.store) {\r\n      return;\r\n    }\r\n\r\n    await this.storeLock.withLock(this.storeFilePath, async () => {\r\n      await this.ensureStoreLoadedLocked();\r\n    });\r\n  }\r\n\r\n  private async ensureStoreLoadedLocked(): Promise<McpOauthStoreFile> {\r\n    if (this.store) {\r\n      return this.store;\r\n    }\r\n\r\n    try {\r\n      const raw = await fsPromises.readFile(this.storeFilePath, \"utf-8\");\r\n      const parsed = parseStoreFile(raw);\r\n      if (!parsed) {\r\n        log.warn(\"[MCP OAuth] Invalid store file; resetting\", { filePath: this.storeFilePath });\r\n        this.store = createEmptyStore();\r\n        await this.persistStoreBestEffortLocked(this.store);\r\n        return this.store;\r\n      }\r\n\r\n      if (parsed.version === 1) {\r\n        const migrated = migrateStoreV1ToV2(parsed);\r\n        this.store = migrated;\r\n        await this.persistStoreBestEffortLocked(migrated);\r\n        return migrated;\r\n      }\r\n\r\n      this.store = parsed;\r\n      return parsed;\r\n    } catch (error) {\r\n      if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\r\n        this.store = createEmptyStore();\r\n        return this.store;\r\n      }\r\n\r\n      log.warn(\"[MCP OAuth] Failed to read store file; resetting\", { error });\r\n      this.store = createEmptyStore();\r\n      await this.persistStoreBestEffortLocked(this.store);\r\n      return this.store;\r\n    }\r\n  }\r\n\r\n  private async persistStoreBestEffortLocked(store: McpOauthStoreFile): Promise<void> {\r\n    try {\r\n      await this.persistStoreLocked(store);\r\n    } catch (error) {\r\n      // Store read/repair must never crash the app at startup.\r\n      log.warn(\"[MCP OAuth] Failed to persist store file; continuing with in-memory state\", {\r\n        error,\r\n      });\r\n    }\r\n  }\r\n\r\n  private async persistStoreLocked(store: McpOauthStoreFile): Promise<void> {\r\n    // Ensure ~/.mux exists.\r\n    await fsPromises.mkdir(this.config.rootDir, { recursive: true });\r\n\r\n    await writeFileAtomic(this.storeFilePath, JSON.stringify(store, null, 2), {\r\n      encoding: \"utf-8\",\r\n      mode: 0o600,\r\n    });\r\n  }\r\n}\r\n\r\nfunction escapeHtml(input: string): string {\r\n  return input\r\n    .replaceAll(\"&\", \"&amp;\")\r\n    .replaceAll(\"<\", \"&lt;\")\r\n    .replaceAll(\">\", \"&gt;\")\r\n    .replaceAll('\"', \"&quot;\")\r\n    .replaceAll(\"'\", \"&#39;\");\r\n}\r\n"]}