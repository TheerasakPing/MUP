{"version":3,"file":"mcpOauthService.js","sourceRoot":"","sources":["../../../src/node/services/mcpOauthService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as crypto from \"crypto\";\nimport * as http from \"http\";\nimport * as path from \"path\";\nimport * as fsPromises from \"fs/promises\";\nimport writeFileAtomic from \"write-file-atomic\";\nimport { auth, type OAuthClientProvider } from \"@ai-sdk/mcp\";\nimport type { Config } from \"@/node/config\";\nimport type { MCPConfigService } from \"@/node/services/mcpConfigService\";\nimport type { WindowService } from \"@/node/services/windowService\";\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\nimport { log } from \"@/node/services/log\";\nimport type { Result } from \"@/common/types/result\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport { roundToBase2 } from \"@/common/telemetry/utils\";\nimport type {\n  MCPOAuthAuthStatus,\n  MCPOAuthClientInformation,\n  MCPOAuthPendingServerConfig,\n  MCPOAuthStoredCredentials,\n  MCPOAuthTokens,\n} from \"@/common/types/mcpOauth\";\nimport { stripTrailingSlashes } from \"@/node/utils/pathUtils\";\nimport { MutexMap } from \"@/node/utils/concurrency/mutexMap\";\n\nconst DEFAULT_DESKTOP_TIMEOUT_MS = 5 * 60 * 1000;\nconst DEFAULT_SERVER_TIMEOUT_MS = 10 * 60 * 1000;\nconst COMPLETED_FLOW_TTL_MS = 60 * 1000;\nconst STORE_FILE_NAME = \"mcp-oauth.json\";\n\ninterface McpOauthStoreFileV1 {\n  version: 1;\n  /** projectPath -> serverName -> stored credentials */\n  entries: Record<string, Record<string, MCPOAuthStoredCredentials>>;\n}\n\ninterface McpOauthStoreFileV2 {\n  version: 2;\n  /**\n   * Global credentials store.\n   *\n   * Keyed by normalizeServerUrlForComparison(creds.serverUrl).\n   */\n  entries: Record<string, MCPOAuthStoredCredentials>;\n}\n\ntype McpOauthStoreFile = McpOauthStoreFileV2;\n\nfunction createEmptyStore(): McpOauthStoreFileV2 {\n  return { version: 2, entries: {} };\n}\n\n// Exported for focused unit tests (WWW-Authenticate parsing) without requiring\n// a real OAuth server.\nexport interface BearerChallenge {\n  /** The full raw WWW-Authenticate header value (best-effort). */\n  raw: string;\n  scope?: string;\n  resourceMetadataUrl?: URL;\n}\n\ninterface OAuthFlowBase {\n  flowId: string;\n  projectPath: string;\n  serverName: string;\n\n  /**\n   * The configured MCP server URL (hash stripped), used for OAuth discovery/authorization.\n   *\n   * Important: Do NOT normalize trailing slashes here. Some servers rely on a trailing\n   * slash (e.g. /mcp/) so relative OAuth discovery URLs resolve under that base path.\n   */\n  serverUrlForDiscovery: string;\n\n  /**\n   * Normalized MCP server URL used only for credential keying and comparison.\n   *\n   * We treat /foo and /foo/ as equivalent for stored credentials, so we strip a\n   * non-root trailing slash.\n   */\n  serverUrlForStoreKey: string;\n\n  transport: \"http\" | \"sse\" | \"auto\";\n  startedAtMs: number;\n\n  /**\n   * OAuth client information registered for this specific flow.\n   *\n   * We keep the per-flow client_id in memory for the subsequent authorization\n   * code exchange.\n   */\n  clientInformation: MCPOAuthClientInformation | null;\n\n  authorizeUrl: string;\n  redirectUri: string;\n\n  /** Optional values discovered from WWW-Authenticate. */\n  scope?: string;\n  resourceMetadataUrl?: URL;\n\n  /** PKCE verifier for this flow (set by @ai-sdk/mcp auth()). */\n  codeVerifier: string | null;\n\n  timeout: ReturnType<typeof setTimeout>;\n  cleanupTimeout: ReturnType<typeof setTimeout> | null;\n\n  resultPromise: Promise<Result<void, string>>;\n  resolveResult: (result: Result<void, string>) => void;\n  settled: boolean;\n}\n\ninterface DesktopFlow extends OAuthFlowBase {\n  server: http.Server;\n}\n\ntype ServerFlow = OAuthFlowBase;\n\nfunction closeServer(server: http.Server): Promise<void> {\n  return new Promise((resolve) => {\n    server.close(() => resolve());\n  });\n}\n\nfunction createDeferred<T>(): { promise: Promise<T>; resolve: (value: T) => void } {\n  let resolve!: (value: T) => void;\n  const promise = new Promise<T>((res) => {\n    resolve = res;\n  });\n  return { promise, resolve };\n}\n\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\n  return Boolean(value) && typeof value === \"object\" && !Array.isArray(value);\n}\n\nfunction normalizeProjectPathKey(projectPath: string): string {\n  // Keep keys stable across callers; config already strips trailing slashes.\n  return stripTrailingSlashes(projectPath);\n}\n\n/**\n * Normalizes an MCP server URL only for keying/comparing stored credentials.\n *\n * Important: This MUST NOT be used for OAuth discovery/authorization requests.\n * Removing a trailing slash changes how relative URLs resolve (e.g. /mcp vs /mcp/).\n */\nfunction normalizeServerUrlForComparison(serverUrl: string): string | null {\n  try {\n    const url = new URL(serverUrl);\n\n    // Avoid accidental mismatch from an irrelevant hash.\n    url.hash = \"\";\n\n    // Normalize trailing slashes for comparison (treat /foo and /foo/ as equivalent).\n    if (url.pathname.endsWith(\"/\") && url.pathname !== \"/\") {\n      url.pathname = url.pathname.slice(0, -1);\n    }\n\n    return url.toString();\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Sanitizes an MCP server URL for network requests.\n *\n * This intentionally does not normalize the pathname; we only strip the hash.\n */\nfunction sanitizeServerUrlForRequest(serverUrl: string): string | null {\n  try {\n    const url = new URL(serverUrl);\n\n    if (url.protocol !== \"http:\" && url.protocol !== \"https:\") {\n      return null;\n    }\n\n    // Avoid accidental mismatch from an irrelevant hash.\n    url.hash = \"\";\n\n    return url.toString();\n  } catch {\n    return null;\n  }\n}\n\nexport function parseBearerWwwAuthenticate(header: string): BearerChallenge | null {\n  const raw = header;\n\n  // Minimal, spec-friendly extraction. We intentionally avoid implementing a full\n  // RFC 7235 challenge parser; we only care about a subset of Bearer params.\n  if (!/\\bbearer\\b/i.test(raw)) {\n    return null;\n  }\n\n  const scopeMatch = /\\bscope=\"([^\"]*)\"/i.exec(raw) ?? /\\bscope=([^,\\s]+)/i.exec(raw);\n  const scope = scopeMatch ? scopeMatch[1] : undefined;\n\n  const resourceMetadataMatch =\n    /\\bresource_metadata=\"([^\"]*)\"/i.exec(raw) ?? /\\bresource_metadata=([^,\\s]+)/i.exec(raw);\n\n  let resourceMetadataUrl: URL | undefined;\n  if (resourceMetadataMatch) {\n    try {\n      resourceMetadataUrl = new URL(resourceMetadataMatch[1]);\n    } catch {\n      // Ignore invalid URLs.\n    }\n  }\n\n  return {\n    raw,\n    scope,\n    resourceMetadataUrl,\n  };\n}\n\nasync function probeServerForBearerChallenge(serverUrl: string): Promise<BearerChallenge | null> {\n  const requestUrl = sanitizeServerUrlForRequest(serverUrl);\n  if (!requestUrl) {\n    return null;\n  }\n\n  // Best-effort probe: do a simple unauthenticated request and parse WWW-Authenticate.\n  //\n  // We intentionally avoid sending MCP-specific headers here because the probe is\n  // only used to extract OAuth hints (scope/resource_metadata) and must not be\n  // protocol-version coupled.\n  const abortController = new AbortController();\n  const timeout = setTimeout(() => abortController.abort(), 5_000);\n\n  try {\n    const response = await fetch(requestUrl, {\n      method: \"GET\",\n      headers: {\n        Accept: \"text/event-stream\",\n      },\n      redirect: \"manual\",\n      signal: abortController.signal,\n    });\n\n    const header =\n      response.headers.get(\"www-authenticate\") ?? response.headers.get(\"WWW-Authenticate\");\n    if (!header) {\n      return null;\n    }\n\n    return parseBearerWwwAuthenticate(header);\n  } catch {\n    return null;\n  } finally {\n    clearTimeout(timeout);\n  }\n}\n\nfunction parseStoredCredentials(value: unknown): MCPOAuthStoredCredentials | null {\n  if (!isPlainObject(value)) {\n    return null;\n  }\n\n  const serverUrlRaw = typeof value.serverUrl === \"string\" ? value.serverUrl : null;\n  const updatedAtMs = typeof value.updatedAtMs === \"number\" ? value.updatedAtMs : null;\n\n  if (!serverUrlRaw || updatedAtMs === null || !Number.isFinite(updatedAtMs)) {\n    return null;\n  }\n\n  const serverUrl = normalizeServerUrlForComparison(serverUrlRaw);\n  if (!serverUrl) {\n    return null;\n  }\n\n  const clientInformationRaw = value.clientInformation;\n  const clientInformation: MCPOAuthClientInformation | undefined = isPlainObject(\n    clientInformationRaw\n  )\n    ? {\n        client_id:\n          typeof clientInformationRaw.client_id === \"string\" ? clientInformationRaw.client_id : \"\",\n        client_secret:\n          typeof clientInformationRaw.client_secret === \"string\"\n            ? clientInformationRaw.client_secret\n            : undefined,\n        client_id_issued_at:\n          typeof clientInformationRaw.client_id_issued_at === \"number\"\n            ? clientInformationRaw.client_id_issued_at\n            : undefined,\n        client_secret_expires_at:\n          typeof clientInformationRaw.client_secret_expires_at === \"number\"\n            ? clientInformationRaw.client_secret_expires_at\n            : undefined,\n      }\n    : undefined;\n\n  if (clientInformation && !clientInformation.client_id) {\n    // client_id is required if the object is present.\n    return null;\n  }\n\n  const tokensRaw = value.tokens;\n  const tokens: MCPOAuthTokens | undefined = isPlainObject(tokensRaw)\n    ? {\n        access_token: typeof tokensRaw.access_token === \"string\" ? tokensRaw.access_token : \"\",\n        id_token: typeof tokensRaw.id_token === \"string\" ? tokensRaw.id_token : undefined,\n        token_type: typeof tokensRaw.token_type === \"string\" ? tokensRaw.token_type : \"\",\n        expires_in: typeof tokensRaw.expires_in === \"number\" ? tokensRaw.expires_in : undefined,\n        scope: typeof tokensRaw.scope === \"string\" ? tokensRaw.scope : undefined,\n        refresh_token:\n          typeof tokensRaw.refresh_token === \"string\" ? tokensRaw.refresh_token : undefined,\n      }\n    : undefined;\n\n  if (tokens && (!tokens.access_token || !tokens.token_type)) {\n    return null;\n  }\n\n  return {\n    serverUrl,\n    clientInformation,\n    tokens,\n    updatedAtMs,\n  };\n}\n\nfunction parseStoreFile(raw: string): McpOauthStoreFileV1 | McpOauthStoreFileV2 | null {\n  try {\n    const parsed = JSON.parse(raw) as unknown;\n    if (!isPlainObject(parsed)) {\n      return null;\n    }\n\n    const version = parsed.version;\n    if (version !== 1 && version !== 2) {\n      return null;\n    }\n\n    const entriesRaw = parsed.entries;\n    if (!isPlainObject(entriesRaw)) {\n      return null;\n    }\n\n    if (version === 1) {\n      const entries: Record<string, Record<string, MCPOAuthStoredCredentials>> = {};\n\n      for (const [projectPath, byServerRaw] of Object.entries(entriesRaw)) {\n        if (!isPlainObject(byServerRaw)) {\n          continue;\n        }\n\n        const byServer: Record<string, MCPOAuthStoredCredentials> = {};\n\n        for (const [serverName, credRaw] of Object.entries(byServerRaw)) {\n          const creds = parseStoredCredentials(credRaw);\n          if (!creds) {\n            continue;\n          }\n\n          byServer[serverName] = creds;\n        }\n\n        if (Object.keys(byServer).length > 0) {\n          entries[projectPath] = byServer;\n        }\n      }\n\n      return { version: 1, entries };\n    }\n\n    // v2\n    const entries: Record<string, MCPOAuthStoredCredentials> = {};\n\n    for (const credRaw of Object.values(entriesRaw)) {\n      const creds = parseStoredCredentials(credRaw);\n      if (!creds) {\n        continue;\n      }\n\n      const serverUrlKey = creds.serverUrl;\n      const existing = entries[serverUrlKey];\n\n      if (!existing || creds.updatedAtMs > existing.updatedAtMs) {\n        entries[serverUrlKey] = creds;\n      }\n    }\n\n    return { version: 2, entries };\n  } catch {\n    return null;\n  }\n}\n\nfunction migrateStoreV1ToV2(store: McpOauthStoreFileV1): McpOauthStoreFileV2 {\n  const entries: Record<string, MCPOAuthStoredCredentials> = {};\n\n  for (const byServer of Object.values(store.entries)) {\n    for (const creds of Object.values(byServer)) {\n      const serverUrlKey = normalizeServerUrlForComparison(creds.serverUrl);\n      if (!serverUrlKey) {\n        continue;\n      }\n\n      const existing = entries[serverUrlKey];\n      if (!existing || creds.updatedAtMs > existing.updatedAtMs) {\n        entries[serverUrlKey] = {\n          ...creds,\n          serverUrl: serverUrlKey,\n        };\n      }\n    }\n  }\n\n  return { version: 2, entries };\n}\n\nexport class McpOauthService {\n  private readonly storeFilePath: string;\n  private readonly storeLock = new MutexMap<string>();\n  private store: McpOauthStoreFile | null = null;\n\n  private readonly desktopFlows = new Map<string, DesktopFlow>();\n  private readonly serverFlows = new Map<string, ServerFlow>();\n  private readonly telemetryService?: TelemetryService;\n\n  constructor(\n    private readonly config: Config,\n    private readonly mcpConfigService: MCPConfigService,\n    private readonly windowService?: WindowService,\n    telemetryService?: TelemetryService\n  ) {\n    this.telemetryService = telemetryService;\n    this.storeFilePath = path.join(config.rootDir, STORE_FILE_NAME);\n  }\n\n  async dispose(): Promise<void> {\n    // Best-effort: cancel all in-flight flows.\n    const desktopFlowIds = [...this.desktopFlows.keys()];\n    const serverFlowIds = [...this.serverFlows.keys()];\n\n    await Promise.all([\n      ...desktopFlowIds.map((id) => this.finishDesktopFlow(id, Err(\"App shutting down\"))),\n      ...serverFlowIds.map((id) => this.finishServerFlow(id, Err(\"App shutting down\"))),\n    ]);\n\n    for (const flow of this.desktopFlows.values()) {\n      clearTimeout(flow.timeout);\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n    }\n\n    for (const flow of this.serverFlows.values()) {\n      clearTimeout(flow.timeout);\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n    }\n\n    this.desktopFlows.clear();\n    this.serverFlows.clear();\n  }\n\n  async getAuthStatus(input: { serverUrl: string }): Promise<MCPOAuthAuthStatus> {\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\n    if (!normalizedServerUrl) {\n      return { isLoggedIn: false, hasRefreshToken: false };\n    }\n\n    const creds = await this.getValidStoredCredentials({ serverUrl: normalizedServerUrl });\n\n    const tokens = creds?.tokens;\n    return {\n      serverUrl: normalizedServerUrl,\n      isLoggedIn: Boolean(tokens),\n      hasRefreshToken: Boolean(tokens?.refresh_token),\n      scope: tokens?.scope,\n      updatedAtMs: creds?.updatedAtMs,\n    };\n  }\n\n  async logout(input: { serverUrl: string }): Promise<Result<void, string>> {\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\n    if (!normalizedServerUrl) {\n      return Ok(undefined);\n    }\n\n    try {\n      await this.storeLock.withLock(this.storeFilePath, async () => {\n        const store = await this.ensureStoreLoadedLocked();\n        if (!store.entries[normalizedServerUrl]) {\n          return;\n        }\n\n        delete store.entries[normalizedServerUrl];\n        await this.persistStoreLocked(store);\n      });\n\n      return Ok(undefined);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(message);\n    }\n  }\n\n  /**\n   * Returns a provider suitable for attaching to an MCP HTTP/SSE transport.\n   *\n   * Critical: This must never trigger user-interactive auth in the background.\n   * Therefore we only return a provider when tokens exist and we ensure\n   * redirectToAuthorization never opens a browser.\n   */\n  async getAuthProviderForServer(input: {\n    serverUrl: string;\n    serverName?: string;\n  }): Promise<OAuthClientProvider | undefined> {\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\n    if (!normalizedServerUrl) {\n      return undefined;\n    }\n\n    const creds = await this.getValidStoredCredentials({ serverUrl: normalizedServerUrl });\n\n    if (!creds?.tokens || !creds.clientInformation) {\n      return undefined;\n    }\n\n    return this.createBackgroundProvider({\n      serverUrl: normalizedServerUrl,\n      serverName: input.serverName,\n    });\n  }\n\n  /**\n   * Used by MCPServerManager caching to restart servers when auth state changes.\n   */\n  async hasAuthTokens(input: { serverUrl: string }): Promise<boolean> {\n    const normalizedServerUrl = normalizeServerUrlForComparison(input.serverUrl);\n    if (!normalizedServerUrl) {\n      return false;\n    }\n\n    const creds = await this.getValidStoredCredentials({ serverUrl: normalizedServerUrl });\n    return Boolean(creds?.tokens && creds.clientInformation);\n  }\n\n  private async resolveServerForOauthFlow(input: {\n    projectPath: string;\n    serverName: string;\n    pendingServer?: MCPOAuthPendingServerConfig;\n  }): Promise<\n    Result<\n      {\n        serverUrlForDiscovery: string;\n        serverUrlForStoreKey: string;\n        transport: \"http\" | \"sse\" | \"auto\";\n      },\n      string\n    >\n  > {\n    if (input.pendingServer) {\n      // Defensive: pendingServer comes from user input (add-server form), so validate.\n      const transport = input.pendingServer.transport;\n      if (transport !== \"http\" && transport !== \"sse\" && transport !== \"auto\") {\n        return Err(\"OAuth is only supported for remote (http/sse) MCP servers\");\n      }\n\n      const serverUrlForDiscovery = sanitizeServerUrlForRequest(input.pendingServer.url);\n      if (!serverUrlForDiscovery) {\n        return Err(\"Invalid MCP server URL\");\n      }\n\n      const serverUrlForStoreKey = normalizeServerUrlForComparison(serverUrlForDiscovery);\n      if (!serverUrlForStoreKey) {\n        return Err(\"Invalid MCP server URL\");\n      }\n\n      return Ok({ serverUrlForDiscovery, serverUrlForStoreKey, transport });\n    }\n\n    const servers = await this.mcpConfigService.listServers(input.projectPath);\n    const server = servers[input.serverName];\n    if (!server) {\n      return Err(\"MCP server not found\");\n    }\n\n    if (server.transport === \"stdio\") {\n      return Err(\"OAuth is only supported for remote (http/sse) MCP servers\");\n    }\n\n    const serverUrlForDiscovery = sanitizeServerUrlForRequest(server.url);\n    if (!serverUrlForDiscovery) {\n      return Err(\"Invalid MCP server URL\");\n    }\n\n    const serverUrlForStoreKey = normalizeServerUrlForComparison(serverUrlForDiscovery);\n    if (!serverUrlForStoreKey) {\n      return Err(\"Invalid MCP server URL\");\n    }\n\n    return Ok({ serverUrlForDiscovery, serverUrlForStoreKey, transport: server.transport });\n  }\n\n  async startDesktopFlow(input: {\n    projectPath: string;\n    serverName: string;\n    pendingServer?: MCPOAuthPendingServerConfig;\n  }): Promise<Result<{ flowId: string; authorizeUrl: string; redirectUri: string }, string>> {\n    const serverConfig = await this.resolveServerForOauthFlow(input);\n    if (!serverConfig.success) {\n      return Err(serverConfig.error);\n    }\n\n    const serverUrlForDiscovery = serverConfig.data.serverUrlForDiscovery;\n    const serverUrlForStoreKey = serverConfig.data.serverUrlForStoreKey;\n    const transport = serverConfig.data.transport;\n\n    const projectKey = normalizeProjectPathKey(input.projectPath);\n\n    const flowId = crypto.randomUUID();\n    const { promise: resultPromise, resolve: resolveResult } =\n      createDeferred<Result<void, string>>();\n\n    const serverListener = http.createServer((req, res) => {\n      const reqUrl = req.url ?? \"/\";\n      const url = new URL(reqUrl, \"http://localhost\");\n\n      if (req.method !== \"GET\" || url.pathname !== \"/callback\") {\n        res.statusCode = 404;\n        res.end(\"Not found\");\n        return;\n      }\n\n      const state = url.searchParams.get(\"state\");\n      if (state !== flowId) {\n        res.statusCode = 400;\n        res.setHeader(\"Content-Type\", \"text/html\");\n        res.end(\"<h1>Invalid OAuth state</h1>\");\n\n        // Strict state validation: if we receive an OAuth callback that doesn't\n        // match the active flow state, fail the flow rather than waiting for a timeout.\n        //\n        // Note: We only fail once the flow has an authorizeUrl to avoid cancelling\n        // due to unrelated localhost probes against the ephemeral loopback port.\n        const flow = this.desktopFlows.get(flowId);\n        if (flow?.authorizeUrl && !flow?.settled) {\n          void this.finishDesktopFlow(flowId, Err(\"Invalid OAuth state\"));\n        }\n        return;\n      }\n\n      const code = url.searchParams.get(\"code\");\n      const error = url.searchParams.get(\"error\");\n      const errorDescription = url.searchParams.get(\"error_description\") ?? undefined;\n\n      void this.handleDesktopCallback({\n        flowId,\n        code,\n        error,\n        errorDescription,\n        res,\n      });\n    });\n\n    try {\n      await new Promise<void>((resolve, reject) => {\n        serverListener.once(\"error\", reject);\n        serverListener.listen(0, \"127.0.0.1\", () => resolve());\n      });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(`Failed to start OAuth callback listener: ${message}`);\n    }\n\n    const address = serverListener.address();\n    if (!address || typeof address === \"string\") {\n      await closeServer(serverListener).catch(() => undefined);\n      return Err(\"Failed to determine OAuth callback listener port\");\n    }\n\n    const redirectUri = `http://127.0.0.1:${address.port}/callback`;\n\n    // Best-effort probe for OAuth hints (scope/resource_metadata). If it fails,\n    // @ai-sdk/mcp can still fall back to well-known discovery.\n    const challenge = await probeServerForBearerChallenge(serverUrlForDiscovery);\n\n    const flow: DesktopFlow = {\n      flowId,\n      projectPath: projectKey,\n      serverName: input.serverName,\n      serverUrlForDiscovery,\n      serverUrlForStoreKey,\n      transport,\n      startedAtMs: Date.now(),\n      clientInformation: null,\n      authorizeUrl: \"\",\n      redirectUri,\n      scope: challenge?.scope,\n      resourceMetadataUrl: challenge?.resourceMetadataUrl,\n      codeVerifier: null,\n      server: serverListener,\n      timeout: setTimeout(() => {\n        void this.finishDesktopFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\n      }, DEFAULT_DESKTOP_TIMEOUT_MS),\n      cleanupTimeout: null,\n      resultPromise,\n      resolveResult,\n      settled: false,\n    };\n\n    this.desktopFlows.set(flowId, flow);\n\n    this.captureTelemetry({\n      event: \"mcp_oauth_flow_started\",\n      properties: {\n        transport: flow.transport,\n        has_scope_hint: Boolean(flow.scope),\n        has_resource_metadata_hint: Boolean(flow.resourceMetadataUrl),\n      },\n    });\n\n    try {\n      // Force a user-interactive flow by not exposing existing tokens.\n      const provider = this.createFlowProvider(flow);\n\n      const result = await auth(provider, {\n        serverUrl: serverUrlForDiscovery,\n        scope: flow.scope,\n        resourceMetadataUrl: flow.resourceMetadataUrl,\n      });\n\n      if (result !== \"REDIRECT\" || !flow.authorizeUrl) {\n        // If auth() completes without redirecting the user, treat it as a failure\n        // and tear down the loopback listener.\n        await this.finishDesktopFlow(flowId, Err(\"Failed to start OAuth authorization\"));\n        return Err(\"Failed to start OAuth authorization\");\n      }\n\n      log.debug(\"[MCP OAuth] Desktop flow started\", {\n        flowId,\n        projectPath: projectKey,\n        serverName: input.serverName,\n      });\n\n      return Ok({ flowId, authorizeUrl: flow.authorizeUrl, redirectUri });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      await this.finishDesktopFlow(flowId, Err(message));\n      return Err(message);\n    }\n  }\n\n  async waitForDesktopFlow(\n    flowId: string,\n    opts?: { timeoutMs?: number }\n  ): Promise<Result<void, string>> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow) {\n      return Err(\"OAuth flow not found\");\n    }\n\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_DESKTOP_TIMEOUT_MS;\n\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\n      timeoutHandle = setTimeout(() => {\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\n      }, timeoutMs);\n    });\n\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\n\n    if (timeoutHandle !== null) {\n      clearTimeout(timeoutHandle);\n    }\n\n    if (!result.success) {\n      void this.finishDesktopFlow(flowId, result);\n    }\n\n    return result;\n  }\n\n  async cancelDesktopFlow(flowId: string): Promise<void> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow) return;\n\n    log.debug(\"[MCP OAuth] Desktop flow cancelled\", { flowId });\n    await this.finishDesktopFlow(flowId, Err(\"OAuth flow cancelled\"));\n  }\n\n  async startServerFlow(input: {\n    projectPath: string;\n    serverName: string;\n    redirectUri: string;\n    pendingServer?: MCPOAuthPendingServerConfig;\n  }): Promise<Result<{ flowId: string; authorizeUrl: string; redirectUri: string }, string>> {\n    const serverConfig = await this.resolveServerForOauthFlow(input);\n    if (!serverConfig.success) {\n      return Err(serverConfig.error);\n    }\n\n    const serverUrlForDiscovery = serverConfig.data.serverUrlForDiscovery;\n    const serverUrlForStoreKey = serverConfig.data.serverUrlForStoreKey;\n    const transport = serverConfig.data.transport;\n\n    let redirectUri: URL;\n    try {\n      redirectUri = new URL(input.redirectUri);\n    } catch {\n      return Err(\"Invalid OAuth redirect URI\");\n    }\n\n    if (redirectUri.protocol !== \"http:\" && redirectUri.protocol !== \"https:\") {\n      return Err(\"OAuth redirect URI must be http(s)\");\n    }\n\n    const projectKey = normalizeProjectPathKey(input.projectPath);\n\n    const flowId = crypto.randomUUID();\n    const { promise: resultPromise, resolve: resolveResult } =\n      createDeferred<Result<void, string>>();\n\n    // Best-effort probe for OAuth hints (scope/resource_metadata). If it fails,\n    // @ai-sdk/mcp can still fall back to well-known discovery.\n    const challenge = await probeServerForBearerChallenge(serverUrlForDiscovery);\n\n    const flow: ServerFlow = {\n      flowId,\n      projectPath: projectKey,\n      serverName: input.serverName,\n      serverUrlForDiscovery,\n      serverUrlForStoreKey,\n      transport,\n      startedAtMs: Date.now(),\n      clientInformation: null,\n      authorizeUrl: \"\",\n      redirectUri: redirectUri.toString(),\n      scope: challenge?.scope,\n      resourceMetadataUrl: challenge?.resourceMetadataUrl,\n      codeVerifier: null,\n      timeout: setTimeout(() => {\n        void this.finishServerFlow(flowId, Err(\"Timed out waiting for OAuth callback\"));\n      }, DEFAULT_SERVER_TIMEOUT_MS),\n      cleanupTimeout: null,\n      resultPromise,\n      resolveResult,\n      settled: false,\n    };\n\n    this.serverFlows.set(flowId, flow);\n\n    this.captureTelemetry({\n      event: \"mcp_oauth_flow_started\",\n      properties: {\n        transport: flow.transport,\n        has_scope_hint: Boolean(flow.scope),\n        has_resource_metadata_hint: Boolean(flow.resourceMetadataUrl),\n      },\n    });\n\n    try {\n      // Force a user-interactive flow by not exposing existing tokens.\n      const provider = this.createFlowProvider(flow);\n\n      const result = await auth(provider, {\n        serverUrl: serverUrlForDiscovery,\n        scope: flow.scope,\n        resourceMetadataUrl: flow.resourceMetadataUrl,\n      });\n\n      if (result !== \"REDIRECT\" || !flow.authorizeUrl) {\n        await this.finishServerFlow(flowId, Err(\"Failed to start OAuth authorization\"));\n        return Err(\"Failed to start OAuth authorization\");\n      }\n\n      log.debug(\"[MCP OAuth] Server flow started\", {\n        flowId,\n        projectPath: projectKey,\n        serverName: input.serverName,\n      });\n\n      return Ok({ flowId, authorizeUrl: flow.authorizeUrl, redirectUri: flow.redirectUri });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      await this.finishServerFlow(flowId, Err(message));\n      return Err(message);\n    }\n  }\n\n  async waitForServerFlow(\n    flowId: string,\n    opts?: { timeoutMs?: number }\n  ): Promise<Result<void, string>> {\n    const flow = this.serverFlows.get(flowId);\n    if (!flow) {\n      return Err(\"OAuth flow not found\");\n    }\n\n    const timeoutMs = opts?.timeoutMs ?? DEFAULT_SERVER_TIMEOUT_MS;\n\n    let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\n    const timeoutPromise = new Promise<Result<void, string>>((resolve) => {\n      timeoutHandle = setTimeout(() => {\n        resolve(Err(\"Timed out waiting for OAuth callback\"));\n      }, timeoutMs);\n    });\n\n    const result = await Promise.race([flow.resultPromise, timeoutPromise]);\n\n    if (timeoutHandle !== null) {\n      clearTimeout(timeoutHandle);\n    }\n\n    if (!result.success) {\n      void this.finishServerFlow(flowId, result);\n    }\n\n    return result;\n  }\n\n  async cancelServerFlow(flowId: string): Promise<void> {\n    const flow = this.serverFlows.get(flowId);\n    if (!flow) return;\n\n    log.debug(\"[MCP OAuth] Server flow cancelled\", { flowId });\n    await this.finishServerFlow(flowId, Err(\"OAuth flow cancelled\"));\n  }\n\n  async handleServerCallbackAndExchange(input: {\n    state: string | null;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n  }): Promise<Result<void, string>> {\n    const state = input.state;\n    if (!state) {\n      return Err(\"Missing OAuth state\");\n    }\n\n    const flow = this.serverFlows.get(state);\n    if (!flow) {\n      return Err(\"Unknown OAuth state\");\n    }\n\n    if (flow.settled) {\n      return Err(\"OAuth flow already completed\");\n    }\n\n    log.debug(\"[MCP OAuth] Server callback received\", { flowId: state });\n\n    const result = await this.exchangeAuthorizationCode(flow, {\n      code: input.code,\n      error: input.error,\n      errorDescription: input.errorDescription,\n    });\n\n    await this.finishServerFlow(state, result);\n\n    return result;\n  }\n\n  private captureTelemetry(payload: Parameters<TelemetryService[\"capture\"]>[0]): void {\n    try {\n      this.telemetryService?.capture(payload);\n    } catch (error) {\n      // Telemetry must never block or crash OAuth flows.\n      log.debug(\"[MCP OAuth] Failed to capture telemetry\", { error });\n    }\n  }\n\n  private getOAuthFlowErrorCategory(\n    error: string\n  ): \"timeout\" | \"cancelled\" | \"state_mismatch\" | \"provider_error\" | \"unknown\" {\n    const lower = error.toLowerCase();\n\n    if (lower.includes(\"timed out\")) {\n      return \"timeout\";\n    }\n\n    if (lower.includes(\"cancelled\")) {\n      return \"cancelled\";\n    }\n\n    if (lower.includes(\"invalid oauth state\")) {\n      return \"state_mismatch\";\n    }\n\n    if (lower.includes(\"oauth\")) {\n      return \"provider_error\";\n    }\n\n    return \"unknown\";\n  }\n\n  private createFlowProvider(flow: OAuthFlowBase): OAuthClientProvider {\n    return {\n      tokens: () => Promise.resolve(undefined),\n      saveTokens: async (tokens) => {\n        await this.saveTokens({\n          serverUrl: flow.serverUrlForStoreKey,\n          tokens: tokens as unknown as MCPOAuthTokens,\n        });\n      },\n      redirectToAuthorization: (authorizationUrl) => {\n        flow.authorizeUrl = authorizationUrl.toString();\n        return Promise.resolve();\n      },\n      saveCodeVerifier: (codeVerifier) => {\n        flow.codeVerifier = codeVerifier;\n        return Promise.resolve();\n      },\n      codeVerifier: () => {\n        if (!flow.codeVerifier) {\n          return Promise.reject(new Error(\"Missing PKCE code verifier\"));\n        }\n        return Promise.resolve(flow.codeVerifier);\n      },\n      invalidateCredentials: async (scope) => {\n        await this.invalidateStoredCredentials({\n          serverUrl: flow.serverUrlForStoreKey,\n          scope,\n        });\n      },\n      get redirectUrl() {\n        return flow.redirectUri;\n      },\n      get clientMetadata() {\n        return {\n          redirect_uris: [flow.redirectUri],\n          response_types: [\"code\"],\n          grant_types: [\"authorization_code\", \"refresh_token\"],\n          token_endpoint_auth_method: \"none\",\n          client_name: \"Mux\",\n          scope: flow.scope,\n        };\n      },\n      clientInformation: () => {\n        // We intentionally register an OAuth client per interactive flow because the\n        // redirect URI may vary between environments (desktop loopback ports, proxied\n        // server origins, etc.).\n        return Promise.resolve(flow.clientInformation ?? undefined);\n      },\n      saveClientInformation: async (clientInformation) => {\n        const next = clientInformation as unknown as MCPOAuthClientInformation;\n        flow.clientInformation = next;\n\n        await this.saveClientInformation({\n          serverUrl: flow.serverUrlForStoreKey,\n          clientInformation: next,\n        });\n      },\n      state: () => Promise.resolve(flow.flowId),\n    };\n  }\n\n  private createBackgroundProvider(input: {\n    serverUrl: string;\n    serverName?: string;\n  }): OAuthClientProvider {\n    return {\n      tokens: async () => {\n        const creds = await this.getValidStoredCredentials({ serverUrl: input.serverUrl });\n        return creds?.tokens as unknown as MCPOAuthTokens | undefined;\n      },\n      saveTokens: async (tokens) => {\n        await this.saveTokens({\n          serverUrl: input.serverUrl,\n          tokens: tokens as unknown as MCPOAuthTokens,\n        });\n      },\n      redirectToAuthorization: async () => {\n        // Avoid any user-visible side effects during background tool calls.\n        // If we end up here, the server requires interactive auth.\n        await this.invalidateStoredCredentials({\n          serverUrl: input.serverUrl,\n          scope: \"tokens\",\n        });\n        throw new Error(\"MCP OAuth login required\");\n      },\n      saveCodeVerifier: () => {\n        // Background providers never start interactive flows.\n        return Promise.resolve();\n      },\n      codeVerifier: () => Promise.reject(new Error(\"PKCE verifier is not available\")),\n      invalidateCredentials: async (scope) => {\n        await this.invalidateStoredCredentials({\n          serverUrl: input.serverUrl,\n          scope,\n        });\n      },\n      get redirectUrl() {\n        // Unused in background mode.\n        return \"http://127.0.0.1/\";\n      },\n      get clientMetadata() {\n        // Unused in background mode; must still be present for the interface.\n        return {\n          redirect_uris: [\"http://127.0.0.1/\"],\n        };\n      },\n      clientInformation: async () => {\n        const creds = await this.getValidStoredCredentials({ serverUrl: input.serverUrl });\n        return creds?.clientInformation as unknown as MCPOAuthClientInformation | undefined;\n      },\n      saveClientInformation: async (clientInformation) => {\n        await this.saveClientInformation({\n          serverUrl: input.serverUrl,\n          clientInformation: clientInformation as unknown as MCPOAuthClientInformation,\n        });\n      },\n    };\n  }\n\n  private async handleDesktopCallback(input: {\n    flowId: string;\n    code: string | null;\n    error: string | null;\n    errorDescription?: string;\n    res: http.ServerResponse;\n  }): Promise<void> {\n    const flow = this.desktopFlows.get(input.flowId);\n    if (!flow || flow.settled) {\n      input.res.statusCode = 409;\n      input.res.setHeader(\"Content-Type\", \"text/html\");\n      input.res.end(\"<h1>OAuth flow already completed</h1>\");\n      return;\n    }\n\n    log.debug(\"[MCP OAuth] Callback received\", { flowId: input.flowId });\n\n    const result = await this.exchangeAuthorizationCode(flow, {\n      code: input.code,\n      error: input.error,\n      errorDescription: input.errorDescription,\n    });\n\n    const title = result.success ? \"Login complete\" : \"Login failed\";\n    const description = result.success\n      ? \"You can return to Mux. You may now close this tab.\"\n      : escapeHtml(result.error);\n\n    input.res.setHeader(\"Content-Type\", \"text/html\");\n    if (!result.success) {\n      input.res.statusCode = 400;\n    }\n\n    input.res.end(`<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"dark light\" />\n    <title>${title}</title>\n  </head>\n  <body>\n    <h1>${title}</h1>\n    <p>${description}</p>\n  </body>\n</html>`);\n\n    await this.finishDesktopFlow(input.flowId, result);\n  }\n\n  private async exchangeAuthorizationCode(\n    flow: OAuthFlowBase,\n    input: { code: string | null; error: string | null; errorDescription?: string }\n  ): Promise<Result<void, string>> {\n    if (input.error) {\n      const message = input.errorDescription\n        ? `${input.error}: ${input.errorDescription}`\n        : input.error;\n      return Err(`MCP OAuth error: ${message}`);\n    }\n\n    if (!input.code) {\n      return Err(\"Missing OAuth code\");\n    }\n\n    try {\n      const provider = this.createFlowProvider(flow);\n\n      const result = await auth(provider, {\n        serverUrl: flow.serverUrlForDiscovery,\n        authorizationCode: input.code,\n        scope: flow.scope,\n        resourceMetadataUrl: flow.resourceMetadataUrl,\n      });\n\n      if (result !== \"AUTHORIZED\") {\n        return Err(\"OAuth exchange did not complete\");\n      }\n\n      this.windowService?.focusMainWindow();\n\n      return Ok(undefined);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(message);\n    }\n  }\n\n  private async finishDesktopFlow(flowId: string, result: Result<void, string>): Promise<void> {\n    const flow = this.desktopFlows.get(flowId);\n    if (!flow || flow.settled) return;\n\n    flow.settled = true;\n    clearTimeout(flow.timeout);\n\n    const durationMs = Math.max(0, Date.now() - flow.startedAtMs);\n    const durationMsB2 = roundToBase2(durationMs);\n    const hasScopeHint = Boolean(flow.scope);\n    const hasResourceMetadataHint = Boolean(flow.resourceMetadataUrl);\n\n    if (result.success) {\n      this.captureTelemetry({\n        event: \"mcp_oauth_flow_completed\",\n        properties: {\n          transport: flow.transport,\n          duration_ms_b2: durationMsB2,\n          has_scope_hint: hasScopeHint,\n          has_resource_metadata_hint: hasResourceMetadataHint,\n        },\n      });\n    } else {\n      const errorCategory = this.getOAuthFlowErrorCategory(result.error);\n      this.captureTelemetry({\n        event: \"mcp_oauth_flow_failed\",\n        properties: {\n          transport: flow.transport,\n          duration_ms_b2: durationMsB2,\n          has_scope_hint: hasScopeHint,\n          has_resource_metadata_hint: hasResourceMetadataHint,\n          error_category: errorCategory,\n        },\n      });\n    }\n\n    try {\n      flow.resolveResult(result);\n\n      await closeServer(flow.server);\n    } catch (error) {\n      log.debug(\"[MCP OAuth] Failed to close OAuth callback listener\", { error });\n    } finally {\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n      flow.cleanupTimeout = setTimeout(() => {\n        this.desktopFlows.delete(flowId);\n      }, COMPLETED_FLOW_TTL_MS);\n    }\n  }\n\n  private finishServerFlow(flowId: string, result: Result<void, string>): Promise<void> {\n    const flow = this.serverFlows.get(flowId);\n    if (!flow || flow.settled) {\n      return Promise.resolve();\n    }\n\n    flow.settled = true;\n    clearTimeout(flow.timeout);\n\n    const durationMs = Math.max(0, Date.now() - flow.startedAtMs);\n    const durationMsB2 = roundToBase2(durationMs);\n    const hasScopeHint = Boolean(flow.scope);\n    const hasResourceMetadataHint = Boolean(flow.resourceMetadataUrl);\n\n    if (result.success) {\n      this.captureTelemetry({\n        event: \"mcp_oauth_flow_completed\",\n        properties: {\n          transport: flow.transport,\n          duration_ms_b2: durationMsB2,\n          has_scope_hint: hasScopeHint,\n          has_resource_metadata_hint: hasResourceMetadataHint,\n        },\n      });\n    } else {\n      const errorCategory = this.getOAuthFlowErrorCategory(result.error);\n      this.captureTelemetry({\n        event: \"mcp_oauth_flow_failed\",\n        properties: {\n          transport: flow.transport,\n          duration_ms_b2: durationMsB2,\n          has_scope_hint: hasScopeHint,\n          has_resource_metadata_hint: hasResourceMetadataHint,\n          error_category: errorCategory,\n        },\n      });\n    }\n\n    try {\n      flow.resolveResult(result);\n    } finally {\n      if (flow.cleanupTimeout !== null) {\n        clearTimeout(flow.cleanupTimeout);\n      }\n      flow.cleanupTimeout = setTimeout(() => {\n        this.serverFlows.delete(flowId);\n      }, COMPLETED_FLOW_TTL_MS);\n    }\n\n    return Promise.resolve();\n  }\n\n  private async getValidStoredCredentials(input: {\n    serverUrl: string;\n  }): Promise<MCPOAuthStoredCredentials | null> {\n    await this.ensureStoreLoaded();\n    const store = this.store;\n    if (!store) {\n      return null;\n    }\n\n    const creds = store.entries[input.serverUrl];\n    if (!creds) {\n      return null;\n    }\n\n    // Defensive: Never use credentials bound to a different (normalized) URL.\n    //\n    // This shouldn't happen in a well-formed v2 store, but it can happen if the\n    // store file is manually edited or corrupted.\n    const storedUrlKey = normalizeServerUrlForComparison(creds.serverUrl);\n    if (!storedUrlKey || storedUrlKey !== input.serverUrl) {\n      await this.logout({ serverUrl: input.serverUrl });\n      return null;\n    }\n\n    return creds;\n  }\n\n  private async invalidateStoredCredentials(input: {\n    serverUrl: string;\n    scope: \"all\" | \"client\" | \"tokens\" | \"verifier\";\n  }): Promise<void> {\n    await this.storeLock.withLock(this.storeFilePath, async () => {\n      const store = await this.ensureStoreLoadedLocked();\n      const creds = store.entries[input.serverUrl];\n      if (!creds) {\n        return;\n      }\n\n      if (input.scope === \"tokens\" || input.scope === \"all\") {\n        creds.tokens = undefined;\n      }\n\n      if (input.scope === \"client\" || input.scope === \"all\") {\n        creds.clientInformation = undefined;\n      }\n\n      // verifier is per-flow (in-memory) only.\n\n      creds.updatedAtMs = Date.now();\n\n      // If everything is gone, prune the entry.\n      if (!creds.tokens && !creds.clientInformation) {\n        delete store.entries[input.serverUrl];\n      }\n\n      await this.persistStoreLocked(store);\n    });\n  }\n\n  private async saveTokens(input: { serverUrl: string; tokens: MCPOAuthTokens }): Promise<void> {\n    await this.storeLock.withLock(this.storeFilePath, async () => {\n      const store = await this.ensureStoreLoadedLocked();\n      const creds = (store.entries[input.serverUrl] ??= {\n        serverUrl: input.serverUrl,\n        updatedAtMs: Date.now(),\n      });\n\n      // Defensive: Never keep tokens bound to a different URL.\n      if (normalizeServerUrlForComparison(creds.serverUrl) !== input.serverUrl) {\n        creds.clientInformation = undefined;\n      }\n\n      creds.serverUrl = input.serverUrl;\n      creds.tokens = input.tokens;\n      creds.updatedAtMs = Date.now();\n\n      await this.persistStoreLocked(store);\n    });\n  }\n\n  private async saveClientInformation(input: {\n    serverUrl: string;\n    clientInformation: MCPOAuthClientInformation;\n  }): Promise<void> {\n    await this.storeLock.withLock(this.storeFilePath, async () => {\n      const store = await this.ensureStoreLoadedLocked();\n      const creds = (store.entries[input.serverUrl] ??= {\n        serverUrl: input.serverUrl,\n        updatedAtMs: Date.now(),\n      });\n\n      // Defensive: Never keep client info bound to a different URL.\n      if (normalizeServerUrlForComparison(creds.serverUrl) !== input.serverUrl) {\n        creds.tokens = undefined;\n      }\n\n      // Defensive: Refresh tokens are bound to a specific OAuth client_id.\n      if (\n        creds.clientInformation?.client_id &&\n        creds.clientInformation.client_id !== input.clientInformation.client_id\n      ) {\n        creds.tokens = undefined;\n      }\n\n      creds.serverUrl = input.serverUrl;\n      creds.clientInformation = input.clientInformation;\n      creds.updatedAtMs = Date.now();\n\n      await this.persistStoreLocked(store);\n    });\n  }\n\n  private async ensureStoreLoaded(): Promise<void> {\n    if (this.store) {\n      return;\n    }\n\n    await this.storeLock.withLock(this.storeFilePath, async () => {\n      await this.ensureStoreLoadedLocked();\n    });\n  }\n\n  private async ensureStoreLoadedLocked(): Promise<McpOauthStoreFile> {\n    if (this.store) {\n      return this.store;\n    }\n\n    try {\n      const raw = await fsPromises.readFile(this.storeFilePath, \"utf-8\");\n      const parsed = parseStoreFile(raw);\n      if (!parsed) {\n        log.warn(\"[MCP OAuth] Invalid store file; resetting\", { filePath: this.storeFilePath });\n        this.store = createEmptyStore();\n        await this.persistStoreBestEffortLocked(this.store);\n        return this.store;\n      }\n\n      if (parsed.version === 1) {\n        const migrated = migrateStoreV1ToV2(parsed);\n        this.store = migrated;\n        await this.persistStoreBestEffortLocked(migrated);\n        return migrated;\n      }\n\n      this.store = parsed;\n      return parsed;\n    } catch (error) {\n      if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n        this.store = createEmptyStore();\n        return this.store;\n      }\n\n      log.warn(\"[MCP OAuth] Failed to read store file; resetting\", { error });\n      this.store = createEmptyStore();\n      await this.persistStoreBestEffortLocked(this.store);\n      return this.store;\n    }\n  }\n\n  private async persistStoreBestEffortLocked(store: McpOauthStoreFile): Promise<void> {\n    try {\n      await this.persistStoreLocked(store);\n    } catch (error) {\n      // Store read/repair must never crash the app at startup.\n      log.warn(\"[MCP OAuth] Failed to persist store file; continuing with in-memory state\", {\n        error,\n      });\n    }\n  }\n\n  private async persistStoreLocked(store: McpOauthStoreFile): Promise<void> {\n    // Ensure ~/.mux exists.\n    await fsPromises.mkdir(this.config.rootDir, { recursive: true });\n\n    await writeFileAtomic(this.storeFilePath, JSON.stringify(store, null, 2), {\n      encoding: \"utf-8\",\n      mode: 0o600,\n    });\n  }\n}\n\nfunction escapeHtml(input: string): string {\n  return input\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#39;\");\n}\n"]}