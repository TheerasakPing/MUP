{"version":3,"file":"resolveToolPolicy.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/resolveToolPolicy.ts"],"names":[],"mappings":";;;AAAA,0DAAkG;AAqBlG,sEAAsE;AACtE,MAAM,kBAAkB,GAAe;IACrC,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,EAAE,SAAS,EAAE;IAClD,EAAE,WAAW,EAAE,mBAAmB,EAAE,MAAM,EAAE,SAAS,EAAE;CACxD,CAAC;AAEF,MAAM,eAAe,GAAe;IAClC,EAAE,WAAW,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE;IAC1C,EAAE,WAAW,EAAE,SAAS,EAAE,MAAM,EAAE,SAAS,EAAE;CAC9C,CAAC;AAEF;;;;;;;;;;;;;;;GAeG;AACH,mCAA0C,OAAiC,EAAc;IACvF,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,wBAAwB,EAAE,GAAG,OAAO,CAAC;IAEjE,+BAA+B;IAC/B,MAAM,WAAW,GAAe,CAAC,EAAE,WAAW,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;IAE3E,4CAA0C;IAC1C,MAAM,OAAO,GAAG,IAAA,gDAAmC,EAAC,MAAM,CAAC,CAAC;IAC5D,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;QAC7B,yDAAyD;QACzD,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;YACf,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;gBACjC,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACvB,WAAW,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAC/D,CAAC;YACH,CAAC;QACH,CAAC;QAED,iCAAiC;QACjC,IAAI,MAAM,CAAC,MAAM,EAAE,CAAC;YAClB,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,MAAM,EAAE,CAAC;gBACpC,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACvB,WAAW,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;gBAChE,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAED,4DAA4D;IAC5D,MAAM,aAAa,GAAe,EAAE,CAAC;IAErC,IAAI,wBAAwB,EAAE,CAAC;QAC7B,aAAa,CAAC,IAAI,CAAC,GAAG,eAAe,CAAC,CAAC;IACzC,CAAC;IAED,IAAI,UAAU,EAAE,CAAC;QACf,aAAa,CAAC,IAAI,CAAC,GAAG,kBAAkB,CAAC,CAAC;QAC1C,uDAAuD;QACvD,aAAa,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,CAAC;IACxE,CAAC;IAED,OAAO,CAAC,GAAG,WAAW,EAAE,GAAG,aAAa,CAAC,CAAC;AAAA,CAC3C","sourcesContent":["import { collectToolConfigsFromResolvedChain, type ToolsConfig } from \"@/common/utils/agentTools\";\r\nimport type { ToolPolicy } from \"@/common/utils/tools/toolPolicy\";\r\n\r\n/**\r\n * Minimal agent structure needed for tool policy resolution.\r\n * Compatible with AgentForInheritance from resolveAgentInheritanceChain.\r\n */\r\nexport interface AgentLikeForPolicy {\r\n  tools?: ToolsConfig;\r\n}\r\n\r\nexport interface ResolveToolPolicyOptions {\r\n  /**\r\n   * Pre-resolved inheritance chain from resolveAgentInheritanceChain.\r\n   * Ordered child → base (selected agent first, then its base, etc.).\r\n   */\r\n  agents: readonly AgentLikeForPolicy[];\r\n  isSubagent: boolean;\r\n  disableTaskToolsForDepth: boolean;\r\n}\r\n\r\n// Runtime restrictions that cannot be overridden by agent definitions\r\nconst SUBAGENT_HARD_DENY: ToolPolicy = [\r\n  { regex_match: \"propose_plan\", action: \"disable\" },\r\n  { regex_match: \"ask_user_question\", action: \"disable\" },\r\n];\r\n\r\nconst DEPTH_HARD_DENY: ToolPolicy = [\r\n  { regex_match: \"task\", action: \"disable\" },\r\n  { regex_match: \"task_.*\", action: \"disable\" },\r\n];\r\n\r\n/**\r\n * Resolves tool policy for an agent, including inherited tools from base agents.\r\n *\r\n * The policy is built from:\r\n * 1. Inheritance chain processed base → child:\r\n *    - Each layer's `tools.add` patterns (enable)\r\n *    - Each layer's `tools.remove` patterns (disable)\r\n * 2. Runtime restrictions (subagent limits, depth limits) applied last\r\n *\r\n * Example: ask (base: exec)\r\n * - exec has add: [.*], remove: [propose_plan, ask_user_question]\r\n * - ask has remove: [file_edit_.*]\r\n * - Result: deny-all → enable .* → disable propose_plan → disable ask_user_question → disable file_edit_.*\r\n *\r\n * Subagents always get `agent_report` enabled regardless of their tool list.\r\n */\r\nexport function resolveToolPolicyForAgent(options: ResolveToolPolicyOptions): ToolPolicy {\r\n  const { agents, isSubagent, disableTaskToolsForDepth } = options;\r\n\r\n  // Start with deny-all baseline\r\n  const agentPolicy: ToolPolicy = [{ regex_match: \".*\", action: \"disable\" }];\r\n\r\n  // Process inheritance chain: base → child\r\n  const configs = collectToolConfigsFromResolvedChain(agents);\r\n  for (const config of configs) {\r\n    // Enable tools from add list (treated as regex patterns)\r\n    if (config.add) {\r\n      for (const pattern of config.add) {\r\n        const trimmed = pattern.trim();\r\n        if (trimmed.length > 0) {\r\n          agentPolicy.push({ regex_match: trimmed, action: \"enable\" });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Disable tools from remove list\r\n    if (config.remove) {\r\n      for (const pattern of config.remove) {\r\n        const trimmed = pattern.trim();\r\n        if (trimmed.length > 0) {\r\n          agentPolicy.push({ regex_match: trimmed, action: \"disable\" });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Runtime restrictions (applied last, cannot be overridden)\r\n  const runtimePolicy: ToolPolicy = [];\r\n\r\n  if (disableTaskToolsForDepth) {\r\n    runtimePolicy.push(...DEPTH_HARD_DENY);\r\n  }\r\n\r\n  if (isSubagent) {\r\n    runtimePolicy.push(...SUBAGENT_HARD_DENY);\r\n    // Subagents always need agent_report to return results\r\n    runtimePolicy.push({ regex_match: \"agent_report\", action: \"enable\" });\r\n  }\r\n\r\n  return [...agentPolicy, ...runtimePolicy];\r\n}\r\n"]}