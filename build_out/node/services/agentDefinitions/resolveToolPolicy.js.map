{"version":3,"file":"resolveToolPolicy.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/resolveToolPolicy.ts"],"names":[],"mappings":";;;AAAA,0DAAkG;AAqBlG,sEAAsE;AACtE,MAAM,kBAAkB,GAAe;IACrC,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,EAAE,SAAS,EAAE;IAClD,EAAE,WAAW,EAAE,mBAAmB,EAAE,MAAM,EAAE,SAAS,EAAE;CACxD,CAAC;AAEF,MAAM,eAAe,GAAe;IAClC,EAAE,WAAW,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE;IAC1C,EAAE,WAAW,EAAE,SAAS,EAAE,MAAM,EAAE,SAAS,EAAE;CAC9C,CAAC;AAEF;;;;;;;;;;;;;;;GAeG;AACH,mCAA0C,OAAiC,EAAc;IACvF,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,wBAAwB,EAAE,GAAG,OAAO,CAAC;IAEjE,+BAA+B;IAC/B,MAAM,WAAW,GAAe,CAAC,EAAE,WAAW,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;IAE3E,4CAA0C;IAC1C,MAAM,OAAO,GAAG,IAAA,gDAAmC,EAAC,MAAM,CAAC,CAAC;IAC5D,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;QAC7B,yDAAyD;QACzD,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;YACf,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;gBACjC,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACvB,WAAW,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAC/D,CAAC;YACH,CAAC;QACH,CAAC;QAED,iCAAiC;QACjC,IAAI,MAAM,CAAC,MAAM,EAAE,CAAC;YAClB,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,MAAM,EAAE,CAAC;gBACpC,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACvB,WAAW,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;gBAChE,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAED,4DAA4D;IAC5D,MAAM,aAAa,GAAe,EAAE,CAAC;IAErC,IAAI,wBAAwB,EAAE,CAAC;QAC7B,aAAa,CAAC,IAAI,CAAC,GAAG,eAAe,CAAC,CAAC;IACzC,CAAC;IAED,IAAI,UAAU,EAAE,CAAC;QACf,aAAa,CAAC,IAAI,CAAC,GAAG,kBAAkB,CAAC,CAAC;QAC1C,uDAAuD;QACvD,aAAa,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,CAAC;IACxE,CAAC;IAED,OAAO,CAAC,GAAG,WAAW,EAAE,GAAG,aAAa,CAAC,CAAC;AAAA,CAC3C","sourcesContent":["import { collectToolConfigsFromResolvedChain, type ToolsConfig } from \"@/common/utils/agentTools\";\nimport type { ToolPolicy } from \"@/common/utils/tools/toolPolicy\";\n\n/**\n * Minimal agent structure needed for tool policy resolution.\n * Compatible with AgentForInheritance from resolveAgentInheritanceChain.\n */\nexport interface AgentLikeForPolicy {\n  tools?: ToolsConfig;\n}\n\nexport interface ResolveToolPolicyOptions {\n  /**\n   * Pre-resolved inheritance chain from resolveAgentInheritanceChain.\n   * Ordered child → base (selected agent first, then its base, etc.).\n   */\n  agents: readonly AgentLikeForPolicy[];\n  isSubagent: boolean;\n  disableTaskToolsForDepth: boolean;\n}\n\n// Runtime restrictions that cannot be overridden by agent definitions\nconst SUBAGENT_HARD_DENY: ToolPolicy = [\n  { regex_match: \"propose_plan\", action: \"disable\" },\n  { regex_match: \"ask_user_question\", action: \"disable\" },\n];\n\nconst DEPTH_HARD_DENY: ToolPolicy = [\n  { regex_match: \"task\", action: \"disable\" },\n  { regex_match: \"task_.*\", action: \"disable\" },\n];\n\n/**\n * Resolves tool policy for an agent, including inherited tools from base agents.\n *\n * The policy is built from:\n * 1. Inheritance chain processed base → child:\n *    - Each layer's `tools.add` patterns (enable)\n *    - Each layer's `tools.remove` patterns (disable)\n * 2. Runtime restrictions (subagent limits, depth limits) applied last\n *\n * Example: ask (base: exec)\n * - exec has add: [.*], remove: [propose_plan, ask_user_question]\n * - ask has remove: [file_edit_.*]\n * - Result: deny-all → enable .* → disable propose_plan → disable ask_user_question → disable file_edit_.*\n *\n * Subagents always get `agent_report` enabled regardless of their tool list.\n */\nexport function resolveToolPolicyForAgent(options: ResolveToolPolicyOptions): ToolPolicy {\n  const { agents, isSubagent, disableTaskToolsForDepth } = options;\n\n  // Start with deny-all baseline\n  const agentPolicy: ToolPolicy = [{ regex_match: \".*\", action: \"disable\" }];\n\n  // Process inheritance chain: base → child\n  const configs = collectToolConfigsFromResolvedChain(agents);\n  for (const config of configs) {\n    // Enable tools from add list (treated as regex patterns)\n    if (config.add) {\n      for (const pattern of config.add) {\n        const trimmed = pattern.trim();\n        if (trimmed.length > 0) {\n          agentPolicy.push({ regex_match: trimmed, action: \"enable\" });\n        }\n      }\n    }\n\n    // Disable tools from remove list\n    if (config.remove) {\n      for (const pattern of config.remove) {\n        const trimmed = pattern.trim();\n        if (trimmed.length > 0) {\n          agentPolicy.push({ regex_match: trimmed, action: \"disable\" });\n        }\n      }\n    }\n  }\n\n  // Runtime restrictions (applied last, cannot be overridden)\n  const runtimePolicy: ToolPolicy = [];\n\n  if (disableTaskToolsForDepth) {\n    runtimePolicy.push(...DEPTH_HARD_DENY);\n  }\n\n  if (isSubagent) {\n    runtimePolicy.push(...SUBAGENT_HARD_DENY);\n    // Subagents always need agent_report to return results\n    runtimePolicy.push({ regex_match: \"agent_report\", action: \"enable\" });\n  }\n\n  return [...agentPolicy, ...runtimePolicy];\n}\n"]}