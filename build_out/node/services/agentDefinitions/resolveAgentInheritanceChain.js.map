{"version":3,"file":"resolveAgentInheritanceChain.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/resolveAgentInheritanceChain.ts"],"names":[],"mappings":";;;AAGA,6CAA0C;AAE1C,uEAKmC;AAkBnC;;;;;;;;;GASG;AACI,KAAK,uCACV,OAA4C,EACZ;IAChC,MAAM,EAAE,OAAO,EAAE,aAAa,EAAE,OAAO,EAAE,eAAe,EAAE,WAAW,EAAE,GAAG,OAAO,CAAC;IAClF,MAAM,QAAQ,GAAG,OAAO,CAAC,QAAQ,IAAI,+CAAqB,CAAC;IAE3D,MAAM,oBAAoB,GAA0B,EAAE,CAAC;IACvD,MAAM,YAAY,GAAG,IAAI,GAAG,EAAU,CAAC;IACvC,IAAI,cAAc,GAAG,OAAO,CAAC;IAC7B,IAAI,iBAAiB,GAAG,eAAe,CAAC;IAExC,KAAK,IAAI,KAAK,GAAG,CAAC,EAAE,KAAK,GAAG,QAAQ,EAAE,KAAK,EAAE,EAAE,CAAC;QAC9C,MAAM,QAAQ,GAAG,IAAA,uCAAa,EAAC,iBAAiB,CAAC,EAAE,EAAE,iBAAiB,CAAC,KAAK,CAAC,CAAC;QAC9E,IAAI,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC/B,SAAG,CAAC,IAAI,CAAC,8DAA8D,EAAE;gBACvE,WAAW;gBACX,OAAO;gBACP,cAAc;gBACd,KAAK,EAAE,iBAAiB,CAAC,KAAK;aAC/B,CAAC,CAAC;YACH,MAAM;QACR,CAAC;QACD,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAE3B,oBAAoB,CAAC,IAAI,CAAC;YACxB,EAAE,EAAE,cAAc;YAClB,IAAI,EAAE,iBAAiB,CAAC,WAAW,CAAC,IAAI;YACxC,KAAK,EAAE,iBAAiB,CAAC,WAAW,CAAC,KAAK;YAC1C,OAAO,EAAE,iBAAiB,CAAC,WAAW,CAAC,EAAE,EAAE,KAAK;SACjD,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,iBAAiB,CAAC,WAAW,CAAC,IAAI,CAAC;QAClD,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM;QACR,CAAC;QAED,MAAM,eAAe,GAAG,IAAA,8CAAoB,EAAC,MAAM,EAAE,cAAc,EAAE,iBAAiB,CAAC,KAAK,CAAC,CAAC;QAC9F,cAAc,GAAG,MAAM,CAAC;QAExB,IAAI,CAAC;YACH,iBAAiB,GAAG,MAAM,IAAA,6CAAmB,EAAC,OAAO,EAAE,aAAa,EAAE,MAAM,EAAE;gBAC5E,eAAe;aAChB,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,IAAI,CAAC,uEAAuE,EAAE;gBAChF,WAAW;gBACX,OAAO;gBACP,MAAM;gBACN,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;aAC9D,CAAC,CAAC;YACH,MAAM;QACR,CAAC;IACH,CAAC;IAED,OAAO,oBAAoB,CAAC;AAAA,CAC7B","sourcesContent":["import type { Runtime } from \"@/node/runtime/Runtime\";\n\nimport type { AgentDefinitionPackage, AgentId } from \"@/common/types/agentDefinition\";\nimport { log } from \"@/node/services/log\";\n\nimport {\n  agentVisitKey,\n  computeBaseSkipScope,\n  MAX_INHERITANCE_DEPTH,\n  readAgentDefinition,\n} from \"./agentDefinitionsService\";\n\nexport interface AgentForInheritance {\n  id: AgentId;\n  base?: AgentId;\n  tools?: AgentDefinitionPackage[\"frontmatter\"][\"tools\"];\n  uiColor?: string;\n}\n\ninterface ResolveAgentInheritanceChainOptions {\n  runtime: Runtime;\n  workspacePath: string;\n  agentId: AgentId;\n  agentDefinition: AgentDefinitionPackage;\n  workspaceId: string;\n  maxDepth?: number;\n}\n\n/**\n * Resolve an agent's `base` inheritance chain (starting at the selected agent).\n *\n * IMPORTANT: Tool-policy computation requires the base chain to be present.\n * Building an \"all agents\" set in callers is error-prone because base agents\n * can be workspace-defined (project/global) rather than built-ins.\n *\n * When resolving a base with the same ID as the current agent (e.g., project-scope\n * `exec.md` with `base: exec`), we skip the current scope to find global/built-in.\n */\nexport async function resolveAgentInheritanceChain(\n  options: ResolveAgentInheritanceChainOptions\n): Promise<AgentForInheritance[]> {\n  const { runtime, workspacePath, agentId, agentDefinition, workspaceId } = options;\n  const maxDepth = options.maxDepth ?? MAX_INHERITANCE_DEPTH;\n\n  const agentsForInheritance: AgentForInheritance[] = [];\n  const seenPackages = new Set<string>();\n  let currentAgentId = agentId;\n  let currentDefinition = agentDefinition;\n\n  for (let depth = 0; depth < maxDepth; depth++) {\n    const visitKey = agentVisitKey(currentDefinition.id, currentDefinition.scope);\n    if (seenPackages.has(visitKey)) {\n      log.warn(\"Agent definition base chain has a cycle; stopping resolution\", {\n        workspaceId,\n        agentId,\n        currentAgentId,\n        scope: currentDefinition.scope,\n      });\n      break;\n    }\n    seenPackages.add(visitKey);\n\n    agentsForInheritance.push({\n      id: currentAgentId,\n      base: currentDefinition.frontmatter.base,\n      tools: currentDefinition.frontmatter.tools,\n      uiColor: currentDefinition.frontmatter.ui?.color,\n    });\n\n    const baseId = currentDefinition.frontmatter.base;\n    if (!baseId) {\n      break;\n    }\n\n    const skipScopesAbove = computeBaseSkipScope(baseId, currentAgentId, currentDefinition.scope);\n    currentAgentId = baseId;\n\n    try {\n      currentDefinition = await readAgentDefinition(runtime, workspacePath, baseId, {\n        skipScopesAbove,\n      });\n    } catch (error) {\n      log.warn(\"Failed to load base agent definition; stopping inheritance resolution\", {\n        workspaceId,\n        agentId,\n        baseId,\n        error: error instanceof Error ? error.message : String(error),\n      });\n      break;\n    }\n  }\n\n  return agentsForInheritance;\n}\n"]}