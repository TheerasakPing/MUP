{"version":3,"file":"resolveAgentInheritanceChain.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/resolveAgentInheritanceChain.ts"],"names":[],"mappings":";;;AAGA,6CAA0C;AAE1C,uEAKmC;AAkBnC;;;;;;;;;GASG;AACI,KAAK,uCACV,OAA4C,EACZ;IAChC,MAAM,EAAE,OAAO,EAAE,aAAa,EAAE,OAAO,EAAE,eAAe,EAAE,WAAW,EAAE,GAAG,OAAO,CAAC;IAClF,MAAM,QAAQ,GAAG,OAAO,CAAC,QAAQ,IAAI,+CAAqB,CAAC;IAE3D,MAAM,oBAAoB,GAA0B,EAAE,CAAC;IACvD,MAAM,YAAY,GAAG,IAAI,GAAG,EAAU,CAAC;IACvC,IAAI,cAAc,GAAG,OAAO,CAAC;IAC7B,IAAI,iBAAiB,GAAG,eAAe,CAAC;IAExC,KAAK,IAAI,KAAK,GAAG,CAAC,EAAE,KAAK,GAAG,QAAQ,EAAE,KAAK,EAAE,EAAE,CAAC;QAC9C,MAAM,QAAQ,GAAG,IAAA,uCAAa,EAAC,iBAAiB,CAAC,EAAE,EAAE,iBAAiB,CAAC,KAAK,CAAC,CAAC;QAC9E,IAAI,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC/B,SAAG,CAAC,IAAI,CAAC,8DAA8D,EAAE;gBACvE,WAAW;gBACX,OAAO;gBACP,cAAc;gBACd,KAAK,EAAE,iBAAiB,CAAC,KAAK;aAC/B,CAAC,CAAC;YACH,MAAM;QACR,CAAC;QACD,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAE3B,oBAAoB,CAAC,IAAI,CAAC;YACxB,EAAE,EAAE,cAAc;YAClB,IAAI,EAAE,iBAAiB,CAAC,WAAW,CAAC,IAAI;YACxC,KAAK,EAAE,iBAAiB,CAAC,WAAW,CAAC,KAAK;YAC1C,OAAO,EAAE,iBAAiB,CAAC,WAAW,CAAC,EAAE,EAAE,KAAK;SACjD,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,iBAAiB,CAAC,WAAW,CAAC,IAAI,CAAC;QAClD,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM;QACR,CAAC;QAED,MAAM,eAAe,GAAG,IAAA,8CAAoB,EAAC,MAAM,EAAE,cAAc,EAAE,iBAAiB,CAAC,KAAK,CAAC,CAAC;QAC9F,cAAc,GAAG,MAAM,CAAC;QAExB,IAAI,CAAC;YACH,iBAAiB,GAAG,MAAM,IAAA,6CAAmB,EAAC,OAAO,EAAE,aAAa,EAAE,MAAM,EAAE;gBAC5E,eAAe;aAChB,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,IAAI,CAAC,uEAAuE,EAAE;gBAChF,WAAW;gBACX,OAAO;gBACP,MAAM;gBACN,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;aAC9D,CAAC,CAAC;YACH,MAAM;QACR,CAAC;IACH,CAAC;IAED,OAAO,oBAAoB,CAAC;AAAA,CAC7B","sourcesContent":["import type { Runtime } from \"@/node/runtime/Runtime\";\r\n\r\nimport type { AgentDefinitionPackage, AgentId } from \"@/common/types/agentDefinition\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\nimport {\r\n  agentVisitKey,\r\n  computeBaseSkipScope,\r\n  MAX_INHERITANCE_DEPTH,\r\n  readAgentDefinition,\r\n} from \"./agentDefinitionsService\";\r\n\r\nexport interface AgentForInheritance {\r\n  id: AgentId;\r\n  base?: AgentId;\r\n  tools?: AgentDefinitionPackage[\"frontmatter\"][\"tools\"];\r\n  uiColor?: string;\r\n}\r\n\r\ninterface ResolveAgentInheritanceChainOptions {\r\n  runtime: Runtime;\r\n  workspacePath: string;\r\n  agentId: AgentId;\r\n  agentDefinition: AgentDefinitionPackage;\r\n  workspaceId: string;\r\n  maxDepth?: number;\r\n}\r\n\r\n/**\r\n * Resolve an agent's `base` inheritance chain (starting at the selected agent).\r\n *\r\n * IMPORTANT: Tool-policy computation requires the base chain to be present.\r\n * Building an \"all agents\" set in callers is error-prone because base agents\r\n * can be workspace-defined (project/global) rather than built-ins.\r\n *\r\n * When resolving a base with the same ID as the current agent (e.g., project-scope\r\n * `exec.md` with `base: exec`), we skip the current scope to find global/built-in.\r\n */\r\nexport async function resolveAgentInheritanceChain(\r\n  options: ResolveAgentInheritanceChainOptions\r\n): Promise<AgentForInheritance[]> {\r\n  const { runtime, workspacePath, agentId, agentDefinition, workspaceId } = options;\r\n  const maxDepth = options.maxDepth ?? MAX_INHERITANCE_DEPTH;\r\n\r\n  const agentsForInheritance: AgentForInheritance[] = [];\r\n  const seenPackages = new Set<string>();\r\n  let currentAgentId = agentId;\r\n  let currentDefinition = agentDefinition;\r\n\r\n  for (let depth = 0; depth < maxDepth; depth++) {\r\n    const visitKey = agentVisitKey(currentDefinition.id, currentDefinition.scope);\r\n    if (seenPackages.has(visitKey)) {\r\n      log.warn(\"Agent definition base chain has a cycle; stopping resolution\", {\r\n        workspaceId,\r\n        agentId,\r\n        currentAgentId,\r\n        scope: currentDefinition.scope,\r\n      });\r\n      break;\r\n    }\r\n    seenPackages.add(visitKey);\r\n\r\n    agentsForInheritance.push({\r\n      id: currentAgentId,\r\n      base: currentDefinition.frontmatter.base,\r\n      tools: currentDefinition.frontmatter.tools,\r\n      uiColor: currentDefinition.frontmatter.ui?.color,\r\n    });\r\n\r\n    const baseId = currentDefinition.frontmatter.base;\r\n    if (!baseId) {\r\n      break;\r\n    }\r\n\r\n    const skipScopesAbove = computeBaseSkipScope(baseId, currentAgentId, currentDefinition.scope);\r\n    currentAgentId = baseId;\r\n\r\n    try {\r\n      currentDefinition = await readAgentDefinition(runtime, workspacePath, baseId, {\r\n        skipScopesAbove,\r\n      });\r\n    } catch (error) {\r\n      log.warn(\"Failed to load base agent definition; stopping inheritance resolution\", {\r\n        workspaceId,\r\n        agentId,\r\n        baseId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      break;\r\n    }\r\n  }\r\n\r\n  return agentsForInheritance;\r\n}\r\n"]}