{"version":3,"file":"agentDefinitionsService.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/agentDefinitionsService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\r\nimport * as path from \"node:path\";\r\n\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { SSHRuntime } from \"@/node/runtime/SSHRuntime\";\r\nimport { execBuffered, readFileString } from \"@/node/utils/runtime/helpers\";\r\nimport { shellQuote } from \"@/node/runtime/backgroundCommands\";\r\n\r\nimport {\r\n  AgentDefinitionDescriptorSchema,\r\n  AgentDefinitionFrontmatterSchema,\r\n  AgentDefinitionPackageSchema,\r\n  AgentIdSchema,\r\n} from \"@/common/orpc/schemas\";\r\nimport type {\r\n  AgentDefinitionDescriptor,\r\n  AgentDefinitionPackage,\r\n  AgentDefinitionScope,\r\n  AgentId,\r\n} from \"@/common/types/agentDefinition\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { validateFileSize } from \"@/node/services/tools/fileCommon\";\r\n\r\nimport { getBuiltInAgentDefinitions } from \"./builtInAgentDefinitions\";\r\nimport {\r\n  AgentDefinitionParseError,\r\n  parseAgentDefinitionMarkdown,\r\n} from \"./parseAgentDefinitionMarkdown\";\r\n\r\nexport const MAX_INHERITANCE_DEPTH = 10;\r\n\r\n/**\r\n * Generate a unique visit key for cycle detection that distinguishes\r\n * same-name agents at different scopes (e.g., project/exec vs built-in/exec).\r\n */\r\nexport function agentVisitKey(id: AgentId, scope: AgentDefinitionScope): string {\r\n  return `${id}:${scope}`;\r\n}\r\n\r\n/**\r\n * Compute the skipScopesAbove value when resolving a base agent.\r\n * If the base has the same ID as the current agent, skip the current scope\r\n * to allow project/global agents to extend built-ins of the same name.\r\n */\r\nexport function computeBaseSkipScope(\r\n  baseId: AgentId,\r\n  currentId: AgentId,\r\n  currentScope: AgentDefinitionScope\r\n): AgentDefinitionScope | undefined {\r\n  return baseId === currentId ? currentScope : undefined;\r\n}\r\n\r\nconst GLOBAL_AGENTS_ROOT = \"~/.mux/agents\";\r\n\r\nfunction resolveUiSelectable(\r\n  ui: { hidden?: boolean; selectable?: boolean; disabled?: boolean } | undefined\r\n): boolean {\r\n  if (!ui) {\r\n    return true;\r\n  }\r\n\r\n  if (typeof ui.hidden === \"boolean\") {\r\n    return !ui.hidden;\r\n  }\r\n\r\n  if (typeof ui.selectable === \"boolean\") {\r\n    return ui.selectable;\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\nfunction resolveUiDisabled(ui: { disabled?: boolean } | undefined): boolean {\r\n  return ui?.disabled === true;\r\n}\r\n\r\n/**\r\n * Internal type for tracking agent definitions during discovery.\r\n * Includes a legacy `disabled` flag (from ui.disabled) for debugging/logging only.\r\n * Filtering is applied at higher layers so Settings can surface opt-in agents.\r\n */\r\ninterface AgentDiscoveryEntry {\r\n  descriptor: AgentDefinitionDescriptor;\r\n  disabled: boolean;\r\n}\r\n\r\nexport interface AgentDefinitionsRoots {\r\n  projectRoot: string;\r\n  globalRoot: string;\r\n}\r\n\r\nexport function getDefaultAgentDefinitionsRoots(\r\n  runtime: Runtime,\r\n  workspacePath: string\r\n): AgentDefinitionsRoots {\r\n  if (!workspacePath) {\r\n    throw new Error(\"getDefaultAgentDefinitionsRoots: workspacePath is required\");\r\n  }\r\n\r\n  return {\r\n    projectRoot: runtime.normalizePath(\".mux/agents\", workspacePath),\r\n    globalRoot: GLOBAL_AGENTS_ROOT,\r\n  };\r\n}\r\n\r\nfunction formatError(error: unknown): string {\r\n  return error instanceof Error ? error.message : String(error);\r\n}\r\n\r\nasync function listAgentFilesFromLocalFs(root: string): Promise<string[]> {\r\n  try {\r\n    const entries = await fs.readdir(root, { withFileTypes: true });\r\n    return entries\r\n      .filter((entry) => entry.isFile() && entry.name.toLowerCase().endsWith(\".md\"))\r\n      .map((entry) => entry.name);\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nasync function listAgentFilesFromRuntime(\r\n  runtime: Runtime,\r\n  root: string,\r\n  options: { cwd: string }\r\n): Promise<string[]> {\r\n  if (!options.cwd) {\r\n    throw new Error(\"listAgentFilesFromRuntime: options.cwd is required\");\r\n  }\r\n\r\n  const quotedRoot = shellQuote(root);\r\n  const command =\r\n    `if [ -d ${quotedRoot} ]; then ` +\r\n    `find ${quotedRoot} -mindepth 1 -maxdepth 1 -type f -name '*.md' -exec basename {} \\\\; ; ` +\r\n    `fi`;\r\n\r\n  const result = await execBuffered(runtime, command, { cwd: options.cwd, timeout: 10 });\r\n  if (result.exitCode !== 0) {\r\n    log.warn(`Failed to read agents directory ${root}: ${result.stderr || result.stdout}`);\r\n    return [];\r\n  }\r\n\r\n  return result.stdout\r\n    .split(\"\\n\")\r\n    .map((line) => line.trim())\r\n    .filter(Boolean);\r\n}\r\n\r\nfunction getAgentIdFromFilename(filename: string): AgentId | null {\r\n  const parsed = path.parse(filename);\r\n  if (parsed.ext.toLowerCase() !== \".md\") {\r\n    return null;\r\n  }\r\n\r\n  const idRaw = parsed.name.trim().toLowerCase();\r\n  const idParsed = AgentIdSchema.safeParse(idRaw);\r\n  if (!idParsed.success) {\r\n    return null;\r\n  }\r\n\r\n  return idParsed.data;\r\n}\r\n\r\nasync function readAgentDescriptorFromFileWithDisabled(\r\n  runtime: Runtime,\r\n  filePath: string,\r\n  agentId: AgentId,\r\n  scope: Exclude<AgentDefinitionScope, \"built-in\">\r\n): Promise<AgentDiscoveryEntry | null> {\r\n  let stat;\r\n  try {\r\n    stat = await runtime.stat(filePath);\r\n  } catch {\r\n    return null;\r\n  }\r\n\r\n  if (stat.isDirectory) {\r\n    return null;\r\n  }\r\n\r\n  const sizeValidation = validateFileSize(stat);\r\n  if (sizeValidation) {\r\n    log.warn(`Skipping agent '${agentId}' (${scope}): ${sizeValidation.error}`);\r\n    return null;\r\n  }\r\n\r\n  let content: string;\r\n  try {\r\n    content = await readFileString(runtime, filePath);\r\n  } catch (err) {\r\n    log.warn(`Failed to read agent definition ${filePath}: ${formatError(err)}`);\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const parsed = parseAgentDefinitionMarkdown({ content, byteSize: stat.size });\r\n\r\n    const uiSelectable = resolveUiSelectable(parsed.frontmatter.ui);\r\n    const uiColor = parsed.frontmatter.ui?.color;\r\n    const subagentRunnable = parsed.frontmatter.subagent?.runnable ?? false;\r\n    const disabled = resolveUiDisabled(parsed.frontmatter.ui);\r\n\r\n    const descriptor: AgentDefinitionDescriptor = {\r\n      id: agentId,\r\n      scope,\r\n      name: parsed.frontmatter.name,\r\n      description: parsed.frontmatter.description,\r\n      uiSelectable,\r\n      uiColor,\r\n      subagentRunnable,\r\n      base: parsed.frontmatter.base,\r\n      aiDefaults: parsed.frontmatter.ai,\r\n      tools: parsed.frontmatter.tools,\r\n    };\r\n\r\n    const validated = AgentDefinitionDescriptorSchema.safeParse(descriptor);\r\n    if (!validated.success) {\r\n      log.warn(`Invalid agent definition descriptor for ${agentId}: ${validated.error.message}`);\r\n      return null;\r\n    }\r\n\r\n    return { descriptor: validated.data, disabled };\r\n  } catch (err) {\r\n    const message = err instanceof AgentDefinitionParseError ? err.message : formatError(err);\r\n    log.warn(`Skipping invalid agent definition '${agentId}' (${scope}): ${message}`);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function discoverAgentDefinitions(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  options?: { roots?: AgentDefinitionsRoots }\r\n): Promise<AgentDefinitionDescriptor[]> {\r\n  if (!workspacePath) {\r\n    throw new Error(\"discoverAgentDefinitions: workspacePath is required\");\r\n  }\r\n\r\n  const roots = options?.roots ?? getDefaultAgentDefinitionsRoots(runtime, workspacePath);\r\n\r\n  const byId = new Map<AgentId, AgentDiscoveryEntry>();\r\n\r\n  // Seed built-ins (lowest precedence).\r\n  for (const pkg of getBuiltInAgentDefinitions()) {\r\n    const uiSelectable = resolveUiSelectable(pkg.frontmatter.ui);\r\n    const uiColor = pkg.frontmatter.ui?.color;\r\n    const subagentRunnable = pkg.frontmatter.subagent?.runnable ?? false;\r\n    const disabled = resolveUiDisabled(pkg.frontmatter.ui);\r\n\r\n    byId.set(pkg.id, {\r\n      descriptor: {\r\n        id: pkg.id,\r\n        scope: \"built-in\",\r\n        name: pkg.frontmatter.name,\r\n        description: pkg.frontmatter.description,\r\n        uiSelectable,\r\n        uiColor,\r\n        subagentRunnable,\r\n        base: pkg.frontmatter.base,\r\n        aiDefaults: pkg.frontmatter.ai,\r\n        tools: pkg.frontmatter.tools,\r\n      },\r\n      disabled,\r\n    });\r\n  }\r\n\r\n  const scans: Array<{ scope: Exclude<AgentDefinitionScope, \"built-in\">; root: string }> = [\r\n    { scope: \"global\", root: roots.globalRoot },\r\n    { scope: \"project\", root: roots.projectRoot },\r\n  ];\r\n\r\n  for (const scan of scans) {\r\n    let resolvedRoot: string;\r\n    try {\r\n      resolvedRoot = await runtime.resolvePath(scan.root);\r\n    } catch (err) {\r\n      log.warn(`Failed to resolve agents root ${scan.root}: ${formatError(err)}`);\r\n      continue;\r\n    }\r\n\r\n    const filenames =\r\n      runtime instanceof SSHRuntime\r\n        ? await listAgentFilesFromRuntime(runtime, resolvedRoot, { cwd: workspacePath })\r\n        : await listAgentFilesFromLocalFs(resolvedRoot);\r\n\r\n    for (const filename of filenames) {\r\n      const agentId = getAgentIdFromFilename(filename);\r\n      if (!agentId) {\r\n        log.warn(`Skipping invalid agent filename '${filename}' in ${resolvedRoot}`);\r\n        continue;\r\n      }\r\n\r\n      const filePath = runtime.normalizePath(filename, resolvedRoot);\r\n      const result = await readAgentDescriptorFromFileWithDisabled(\r\n        runtime,\r\n        filePath,\r\n        agentId,\r\n        scan.scope\r\n      );\r\n      if (!result) continue;\r\n\r\n      byId.set(agentId, result);\r\n    }\r\n  }\r\n\r\n  // Return all discovered agents (including those disabled by front-matter).\r\n  // Filtering is applied at higher layers (e.g., agents.list) so Settings can still surface opt-in agents.\r\n  return Array.from(byId.values())\r\n    .map((entry) => entry.descriptor)\r\n    .sort((a, b) => a.name.localeCompare(b.name));\r\n}\r\n\r\nexport interface ReadAgentDefinitionOptions {\r\n  roots?: AgentDefinitionsRoots;\r\n  /**\r\n   * Skip scopes at or above this level when resolving.\r\n   * Used for base resolution: when a project-scope agent has `base: exec`,\r\n   * we skip project scope to find the global/built-in exec, avoiding self-reference.\r\n   */\r\n  skipScopesAbove?: AgentDefinitionScope;\r\n}\r\n\r\nconst SCOPE_PRIORITY: AgentDefinitionScope[] = [\"project\", \"global\", \"built-in\"];\r\n\r\nexport async function readAgentDefinition(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  agentId: AgentId,\r\n  options?: ReadAgentDefinitionOptions\r\n): Promise<AgentDefinitionPackage> {\r\n  if (!workspacePath) {\r\n    throw new Error(\"readAgentDefinition: workspacePath is required\");\r\n  }\r\n\r\n  const roots = options?.roots ?? getDefaultAgentDefinitionsRoots(runtime, workspacePath);\r\n  const skipScopesAbove = options?.skipScopesAbove;\r\n\r\n  // Determine which scopes to skip based on skipScopesAbove\r\n  const skipScopes = new Set<AgentDefinitionScope>();\r\n  if (skipScopesAbove) {\r\n    const skipIndex = SCOPE_PRIORITY.indexOf(skipScopesAbove);\r\n    if (skipIndex !== -1) {\r\n      // Skip this scope and all higher-priority scopes\r\n      for (let i = 0; i <= skipIndex; i++) {\r\n        skipScopes.add(SCOPE_PRIORITY[i]);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Precedence: project overrides global overrides built-in.\r\n  const candidates: Array<{ scope: Exclude<AgentDefinitionScope, \"built-in\">; root: string }> = [\r\n    { scope: \"project\", root: roots.projectRoot },\r\n    { scope: \"global\", root: roots.globalRoot },\r\n  ];\r\n\r\n  for (const candidate of candidates) {\r\n    if (skipScopes.has(candidate.scope)) {\r\n      continue;\r\n    }\r\n\r\n    let resolvedRoot: string;\r\n    try {\r\n      resolvedRoot = await runtime.resolvePath(candidate.root);\r\n    } catch {\r\n      continue;\r\n    }\r\n\r\n    const filePath = runtime.normalizePath(`${agentId}.md`, resolvedRoot);\r\n\r\n    try {\r\n      const stat = await runtime.stat(filePath);\r\n      if (stat.isDirectory) {\r\n        continue;\r\n      }\r\n\r\n      const sizeValidation = validateFileSize(stat);\r\n      if (sizeValidation) {\r\n        throw new Error(sizeValidation.error);\r\n      }\r\n\r\n      const content = await readFileString(runtime, filePath);\r\n      const parsed = parseAgentDefinitionMarkdown({ content, byteSize: stat.size });\r\n\r\n      const pkg: AgentDefinitionPackage = {\r\n        id: agentId,\r\n        scope: candidate.scope,\r\n        frontmatter: parsed.frontmatter,\r\n        body: parsed.body,\r\n      };\r\n\r\n      const validated = AgentDefinitionPackageSchema.safeParse(pkg);\r\n      if (!validated.success) {\r\n        throw new Error(\r\n          `Invalid agent definition package for '${agentId}' (${candidate.scope}): ${validated.error.message}`\r\n        );\r\n      }\r\n\r\n      return validated.data;\r\n    } catch {\r\n      continue;\r\n    }\r\n  }\r\n\r\n  if (!skipScopes.has(\"built-in\")) {\r\n    const builtIn = getBuiltInAgentDefinitions().find((pkg) => pkg.id === agentId);\r\n    if (builtIn) {\r\n      const validated = AgentDefinitionPackageSchema.safeParse(builtIn);\r\n      if (!validated.success) {\r\n        throw new Error(\r\n          `Invalid built-in agent definition '${agentId}': ${validated.error.message}`\r\n        );\r\n      }\r\n      return validated.data;\r\n    }\r\n  }\r\n\r\n  throw new Error(`Agent definition not found: ${agentId}`);\r\n}\r\n\r\n/**\r\n * Resolve the effective system prompt body for an agent, including inherited content.\r\n *\r\n * By default (or with `prompt.append: true`), the agent's body is appended to its base's body.\r\n * Set `prompt.append: false` to replace the base body entirely.\r\n *\r\n * When resolving a base, we skip the current agent's scope to allow overriding built-ins:\r\n * - Project-scope `exec.md` with `base: exec` → resolves to global/built-in exec\r\n * - Global-scope `exec.md` with `base: exec` → resolves to built-in exec\r\n */\r\nexport async function resolveAgentBody(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  agentId: AgentId,\r\n  options?: { roots?: AgentDefinitionsRoots; skipScopesAbove?: AgentDefinitionScope }\r\n): Promise<string> {\r\n  const visited = new Set<string>();\r\n\r\n  function mergeSkipScopesAbove(\r\n    a: AgentDefinitionScope | undefined,\r\n    b: AgentDefinitionScope | undefined\r\n  ): AgentDefinitionScope | undefined {\r\n    if (!a) {\r\n      return b;\r\n    }\r\n    if (!b) {\r\n      return a;\r\n    }\r\n\r\n    const aIndex = SCOPE_PRIORITY.indexOf(a);\r\n    const bIndex = SCOPE_PRIORITY.indexOf(b);\r\n\r\n    // Defensive fallback. (In practice, both should always be in SCOPE_PRIORITY.)\r\n    if (aIndex === -1 || bIndex === -1) {\r\n      return a;\r\n    }\r\n\r\n    return aIndex > bIndex ? a : b;\r\n  }\r\n\r\n  async function resolve(\r\n    id: AgentId,\r\n    depth: number,\r\n    skipScopesAbove?: AgentDefinitionScope\r\n  ): Promise<string> {\r\n    if (depth > MAX_INHERITANCE_DEPTH) {\r\n      throw new Error(\r\n        `Agent inheritance depth exceeded for '${id}' (max: ${MAX_INHERITANCE_DEPTH})`\r\n      );\r\n    }\r\n\r\n    const pkg = await readAgentDefinition(runtime, workspacePath, id, {\r\n      roots: options?.roots,\r\n      skipScopesAbove,\r\n    });\r\n\r\n    const visitKey = agentVisitKey(pkg.id, pkg.scope);\r\n    if (visited.has(visitKey)) {\r\n      throw new Error(`Circular agent inheritance detected: ${pkg.id} (${pkg.scope})`);\r\n    }\r\n    visited.add(visitKey);\r\n\r\n    const baseId = pkg.frontmatter.base;\r\n    const shouldAppend = pkg.frontmatter.prompt?.append !== false;\r\n\r\n    if (!baseId || !shouldAppend) {\r\n      return pkg.body;\r\n    }\r\n\r\n    const baseBody = await resolve(\r\n      baseId,\r\n      depth + 1,\r\n      mergeSkipScopesAbove(skipScopesAbove, computeBaseSkipScope(baseId, id, pkg.scope))\r\n    );\r\n    const separator = baseBody.trim() && pkg.body.trim() ? \"\\n\\n\" : \"\";\r\n    return `${baseBody}${separator}${pkg.body}`;\r\n  }\r\n\r\n  return resolve(agentId, 0, options?.skipScopesAbove);\r\n}\r\n\r\nfunction formatZodIssues(\r\n  issues: ReadonlyArray<{ path: readonly PropertyKey[]; message: string }>\r\n): string {\r\n  return issues\r\n    .map((issue) => {\r\n      const issuePath =\r\n        issue.path.length > 0 ? issue.path.map((part) => String(part)).join(\".\") : \"<root>\";\r\n      return `${issuePath}: ${issue.message}`;\r\n    })\r\n    .join(\"; \");\r\n}\r\n\r\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\r\n  if (!value || typeof value !== \"object\" || Array.isArray(value)) {\r\n    return false;\r\n  }\r\n\r\n  const proto: unknown = Object.getPrototypeOf(value);\r\n  return proto === Object.prototype || proto === null;\r\n}\r\n\r\nfunction deepMergeAgentFrontmatter(\r\n  base: unknown,\r\n  overlay: unknown,\r\n  path: readonly string[]\r\n): unknown {\r\n  // Inherit base when the overlay isn't specified.\r\n  if (overlay === undefined) {\r\n    return base;\r\n  }\r\n\r\n  const pathKey = path.join(\".\");\r\n  if (\r\n    Array.isArray(base) &&\r\n    Array.isArray(overlay) &&\r\n    (pathKey === \"tools.add\" || pathKey === \"tools.remove\")\r\n  ) {\r\n    // Tool layers are processed in order (base first, then child).\r\n    return [...(base as unknown[]), ...(overlay as unknown[])];\r\n  }\r\n\r\n  if (isPlainObject(base) && isPlainObject(overlay)) {\r\n    const merged: Record<string, unknown> = { ...base };\r\n\r\n    for (const [key, overlayValue] of Object.entries(overlay)) {\r\n      merged[key] = deepMergeAgentFrontmatter(merged[key], overlayValue, [...path, key]);\r\n    }\r\n\r\n    return merged;\r\n  }\r\n\r\n  // Primitive, array (non-tools), or mismatched types: overlay wins.\r\n  return overlay;\r\n}\r\n\r\n/**\r\n * Resolve an agent's effective frontmatter by overlaying its base chain (base first, then child).\r\n *\r\n * Unlike prompt body inheritance, frontmatter inheritance is always applied when `base` is set.\r\n * This prevents same-name overrides (e.g. project exec.md with base: exec) from accidentally\r\n * dropping important base config like subagent.runnable or subagent.append_prompt.\r\n */\r\nexport async function resolveAgentFrontmatter(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  agentId: AgentId,\r\n  options?: { roots?: AgentDefinitionsRoots; skipScopesAbove?: AgentDefinitionScope }\r\n): Promise<AgentDefinitionPackage[\"frontmatter\"]> {\r\n  if (!workspacePath) {\r\n    throw new Error(\"resolveAgentFrontmatter: workspacePath is required\");\r\n  }\r\n\r\n  const visited = new Set<string>();\r\n\r\n  function mergeSkipScopesAbove(\r\n    a: AgentDefinitionScope | undefined,\r\n    b: AgentDefinitionScope | undefined\r\n  ): AgentDefinitionScope | undefined {\r\n    if (!a) {\r\n      return b;\r\n    }\r\n    if (!b) {\r\n      return a;\r\n    }\r\n\r\n    const aIndex = SCOPE_PRIORITY.indexOf(a);\r\n    const bIndex = SCOPE_PRIORITY.indexOf(b);\r\n\r\n    // Defensive fallback. (In practice, both should always be in SCOPE_PRIORITY.)\r\n    if (aIndex === -1 || bIndex === -1) {\r\n      return a;\r\n    }\r\n\r\n    // Prefer the scope that skips *more* (e.g. global skips project+global).\r\n    return aIndex > bIndex ? a : b;\r\n  }\r\n\r\n  async function resolve(\r\n    id: AgentId,\r\n    depth: number,\r\n    skipScopesAbove?: AgentDefinitionScope\r\n  ): Promise<AgentDefinitionPackage[\"frontmatter\"]> {\r\n    if (depth > MAX_INHERITANCE_DEPTH) {\r\n      throw new Error(\r\n        `Agent inheritance depth exceeded for '${id}' (max: ${MAX_INHERITANCE_DEPTH})`\r\n      );\r\n    }\r\n\r\n    const pkg = await readAgentDefinition(runtime, workspacePath, id, {\r\n      roots: options?.roots,\r\n      skipScopesAbove,\r\n    });\r\n\r\n    const visitKey = agentVisitKey(pkg.id, pkg.scope);\r\n    if (visited.has(visitKey)) {\r\n      throw new Error(`Circular agent inheritance detected: ${pkg.id} (${pkg.scope})`);\r\n    }\r\n    visited.add(visitKey);\r\n\r\n    const baseId = pkg.frontmatter.base;\r\n    if (!baseId) {\r\n      return pkg.frontmatter;\r\n    }\r\n\r\n    const baseFrontmatter = await resolve(\r\n      baseId,\r\n      depth + 1,\r\n      mergeSkipScopesAbove(skipScopesAbove, computeBaseSkipScope(baseId, id, pkg.scope))\r\n    );\r\n\r\n    const mergedRaw = deepMergeAgentFrontmatter(baseFrontmatter, pkg.frontmatter, []);\r\n    const merged = AgentDefinitionFrontmatterSchema.safeParse(mergedRaw);\r\n    if (!merged.success) {\r\n      throw new Error(\r\n        `Invalid merged frontmatter for '${id}': ${formatZodIssues(merged.error.issues)}`\r\n      );\r\n    }\r\n\r\n    return merged.data;\r\n  }\r\n\r\n  return resolve(agentId, 0, options?.skipScopesAbove);\r\n}\r\n"]}