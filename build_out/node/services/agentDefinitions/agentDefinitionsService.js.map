{"version":3,"file":"agentDefinitionsService.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/agentDefinitionsService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\n\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport { SSHRuntime } from \"@/node/runtime/SSHRuntime\";\nimport { execBuffered, readFileString } from \"@/node/utils/runtime/helpers\";\nimport { shellQuote } from \"@/node/runtime/backgroundCommands\";\n\nimport {\n  AgentDefinitionDescriptorSchema,\n  AgentDefinitionFrontmatterSchema,\n  AgentDefinitionPackageSchema,\n  AgentIdSchema,\n} from \"@/common/orpc/schemas\";\nimport type {\n  AgentDefinitionDescriptor,\n  AgentDefinitionPackage,\n  AgentDefinitionScope,\n  AgentId,\n} from \"@/common/types/agentDefinition\";\nimport { log } from \"@/node/services/log\";\nimport { validateFileSize } from \"@/node/services/tools/fileCommon\";\n\nimport { getBuiltInAgentDefinitions } from \"./builtInAgentDefinitions\";\nimport {\n  AgentDefinitionParseError,\n  parseAgentDefinitionMarkdown,\n} from \"./parseAgentDefinitionMarkdown\";\n\nexport const MAX_INHERITANCE_DEPTH = 10;\n\n/**\n * Generate a unique visit key for cycle detection that distinguishes\n * same-name agents at different scopes (e.g., project/exec vs built-in/exec).\n */\nexport function agentVisitKey(id: AgentId, scope: AgentDefinitionScope): string {\n  return `${id}:${scope}`;\n}\n\n/**\n * Compute the skipScopesAbove value when resolving a base agent.\n * If the base has the same ID as the current agent, skip the current scope\n * to allow project/global agents to extend built-ins of the same name.\n */\nexport function computeBaseSkipScope(\n  baseId: AgentId,\n  currentId: AgentId,\n  currentScope: AgentDefinitionScope\n): AgentDefinitionScope | undefined {\n  return baseId === currentId ? currentScope : undefined;\n}\n\nconst GLOBAL_AGENTS_ROOT = \"~/.mux/agents\";\n\nfunction resolveUiSelectable(\n  ui: { hidden?: boolean; selectable?: boolean; disabled?: boolean } | undefined\n): boolean {\n  if (!ui) {\n    return true;\n  }\n\n  if (typeof ui.hidden === \"boolean\") {\n    return !ui.hidden;\n  }\n\n  if (typeof ui.selectable === \"boolean\") {\n    return ui.selectable;\n  }\n\n  return true;\n}\n\nfunction resolveUiDisabled(ui: { disabled?: boolean } | undefined): boolean {\n  return ui?.disabled === true;\n}\n\n/**\n * Internal type for tracking agent definitions during discovery.\n * Includes a legacy `disabled` flag (from ui.disabled) for debugging/logging only.\n * Filtering is applied at higher layers so Settings can surface opt-in agents.\n */\ninterface AgentDiscoveryEntry {\n  descriptor: AgentDefinitionDescriptor;\n  disabled: boolean;\n}\n\nexport interface AgentDefinitionsRoots {\n  projectRoot: string;\n  globalRoot: string;\n}\n\nexport function getDefaultAgentDefinitionsRoots(\n  runtime: Runtime,\n  workspacePath: string\n): AgentDefinitionsRoots {\n  if (!workspacePath) {\n    throw new Error(\"getDefaultAgentDefinitionsRoots: workspacePath is required\");\n  }\n\n  return {\n    projectRoot: runtime.normalizePath(\".mux/agents\", workspacePath),\n    globalRoot: GLOBAL_AGENTS_ROOT,\n  };\n}\n\nfunction formatError(error: unknown): string {\n  return error instanceof Error ? error.message : String(error);\n}\n\nasync function listAgentFilesFromLocalFs(root: string): Promise<string[]> {\n  try {\n    const entries = await fs.readdir(root, { withFileTypes: true });\n    return entries\n      .filter((entry) => entry.isFile() && entry.name.toLowerCase().endsWith(\".md\"))\n      .map((entry) => entry.name);\n  } catch {\n    return [];\n  }\n}\n\nasync function listAgentFilesFromRuntime(\n  runtime: Runtime,\n  root: string,\n  options: { cwd: string }\n): Promise<string[]> {\n  if (!options.cwd) {\n    throw new Error(\"listAgentFilesFromRuntime: options.cwd is required\");\n  }\n\n  const quotedRoot = shellQuote(root);\n  const command =\n    `if [ -d ${quotedRoot} ]; then ` +\n    `find ${quotedRoot} -mindepth 1 -maxdepth 1 -type f -name '*.md' -exec basename {} \\\\; ; ` +\n    `fi`;\n\n  const result = await execBuffered(runtime, command, { cwd: options.cwd, timeout: 10 });\n  if (result.exitCode !== 0) {\n    log.warn(`Failed to read agents directory ${root}: ${result.stderr || result.stdout}`);\n    return [];\n  }\n\n  return result.stdout\n    .split(\"\\n\")\n    .map((line) => line.trim())\n    .filter(Boolean);\n}\n\nfunction getAgentIdFromFilename(filename: string): AgentId | null {\n  const parsed = path.parse(filename);\n  if (parsed.ext.toLowerCase() !== \".md\") {\n    return null;\n  }\n\n  const idRaw = parsed.name.trim().toLowerCase();\n  const idParsed = AgentIdSchema.safeParse(idRaw);\n  if (!idParsed.success) {\n    return null;\n  }\n\n  return idParsed.data;\n}\n\nasync function readAgentDescriptorFromFileWithDisabled(\n  runtime: Runtime,\n  filePath: string,\n  agentId: AgentId,\n  scope: Exclude<AgentDefinitionScope, \"built-in\">\n): Promise<AgentDiscoveryEntry | null> {\n  let stat;\n  try {\n    stat = await runtime.stat(filePath);\n  } catch {\n    return null;\n  }\n\n  if (stat.isDirectory) {\n    return null;\n  }\n\n  const sizeValidation = validateFileSize(stat);\n  if (sizeValidation) {\n    log.warn(`Skipping agent '${agentId}' (${scope}): ${sizeValidation.error}`);\n    return null;\n  }\n\n  let content: string;\n  try {\n    content = await readFileString(runtime, filePath);\n  } catch (err) {\n    log.warn(`Failed to read agent definition ${filePath}: ${formatError(err)}`);\n    return null;\n  }\n\n  try {\n    const parsed = parseAgentDefinitionMarkdown({ content, byteSize: stat.size });\n\n    const uiSelectable = resolveUiSelectable(parsed.frontmatter.ui);\n    const uiColor = parsed.frontmatter.ui?.color;\n    const subagentRunnable = parsed.frontmatter.subagent?.runnable ?? false;\n    const disabled = resolveUiDisabled(parsed.frontmatter.ui);\n\n    const descriptor: AgentDefinitionDescriptor = {\n      id: agentId,\n      scope,\n      name: parsed.frontmatter.name,\n      description: parsed.frontmatter.description,\n      uiSelectable,\n      uiColor,\n      subagentRunnable,\n      base: parsed.frontmatter.base,\n      aiDefaults: parsed.frontmatter.ai,\n      tools: parsed.frontmatter.tools,\n    };\n\n    const validated = AgentDefinitionDescriptorSchema.safeParse(descriptor);\n    if (!validated.success) {\n      log.warn(`Invalid agent definition descriptor for ${agentId}: ${validated.error.message}`);\n      return null;\n    }\n\n    return { descriptor: validated.data, disabled };\n  } catch (err) {\n    const message = err instanceof AgentDefinitionParseError ? err.message : formatError(err);\n    log.warn(`Skipping invalid agent definition '${agentId}' (${scope}): ${message}`);\n    return null;\n  }\n}\n\nexport async function discoverAgentDefinitions(\n  runtime: Runtime,\n  workspacePath: string,\n  options?: { roots?: AgentDefinitionsRoots }\n): Promise<AgentDefinitionDescriptor[]> {\n  if (!workspacePath) {\n    throw new Error(\"discoverAgentDefinitions: workspacePath is required\");\n  }\n\n  const roots = options?.roots ?? getDefaultAgentDefinitionsRoots(runtime, workspacePath);\n\n  const byId = new Map<AgentId, AgentDiscoveryEntry>();\n\n  // Seed built-ins (lowest precedence).\n  for (const pkg of getBuiltInAgentDefinitions()) {\n    const uiSelectable = resolveUiSelectable(pkg.frontmatter.ui);\n    const uiColor = pkg.frontmatter.ui?.color;\n    const subagentRunnable = pkg.frontmatter.subagent?.runnable ?? false;\n    const disabled = resolveUiDisabled(pkg.frontmatter.ui);\n\n    byId.set(pkg.id, {\n      descriptor: {\n        id: pkg.id,\n        scope: \"built-in\",\n        name: pkg.frontmatter.name,\n        description: pkg.frontmatter.description,\n        uiSelectable,\n        uiColor,\n        subagentRunnable,\n        base: pkg.frontmatter.base,\n        aiDefaults: pkg.frontmatter.ai,\n        tools: pkg.frontmatter.tools,\n      },\n      disabled,\n    });\n  }\n\n  const scans: Array<{ scope: Exclude<AgentDefinitionScope, \"built-in\">; root: string }> = [\n    { scope: \"global\", root: roots.globalRoot },\n    { scope: \"project\", root: roots.projectRoot },\n  ];\n\n  for (const scan of scans) {\n    let resolvedRoot: string;\n    try {\n      resolvedRoot = await runtime.resolvePath(scan.root);\n    } catch (err) {\n      log.warn(`Failed to resolve agents root ${scan.root}: ${formatError(err)}`);\n      continue;\n    }\n\n    const filenames =\n      runtime instanceof SSHRuntime\n        ? await listAgentFilesFromRuntime(runtime, resolvedRoot, { cwd: workspacePath })\n        : await listAgentFilesFromLocalFs(resolvedRoot);\n\n    for (const filename of filenames) {\n      const agentId = getAgentIdFromFilename(filename);\n      if (!agentId) {\n        log.warn(`Skipping invalid agent filename '${filename}' in ${resolvedRoot}`);\n        continue;\n      }\n\n      const filePath = runtime.normalizePath(filename, resolvedRoot);\n      const result = await readAgentDescriptorFromFileWithDisabled(\n        runtime,\n        filePath,\n        agentId,\n        scan.scope\n      );\n      if (!result) continue;\n\n      byId.set(agentId, result);\n    }\n  }\n\n  // Return all discovered agents (including those disabled by front-matter).\n  // Filtering is applied at higher layers (e.g., agents.list) so Settings can still surface opt-in agents.\n  return Array.from(byId.values())\n    .map((entry) => entry.descriptor)\n    .sort((a, b) => a.name.localeCompare(b.name));\n}\n\nexport interface ReadAgentDefinitionOptions {\n  roots?: AgentDefinitionsRoots;\n  /**\n   * Skip scopes at or above this level when resolving.\n   * Used for base resolution: when a project-scope agent has `base: exec`,\n   * we skip project scope to find the global/built-in exec, avoiding self-reference.\n   */\n  skipScopesAbove?: AgentDefinitionScope;\n}\n\nconst SCOPE_PRIORITY: AgentDefinitionScope[] = [\"project\", \"global\", \"built-in\"];\n\nexport async function readAgentDefinition(\n  runtime: Runtime,\n  workspacePath: string,\n  agentId: AgentId,\n  options?: ReadAgentDefinitionOptions\n): Promise<AgentDefinitionPackage> {\n  if (!workspacePath) {\n    throw new Error(\"readAgentDefinition: workspacePath is required\");\n  }\n\n  const roots = options?.roots ?? getDefaultAgentDefinitionsRoots(runtime, workspacePath);\n  const skipScopesAbove = options?.skipScopesAbove;\n\n  // Determine which scopes to skip based on skipScopesAbove\n  const skipScopes = new Set<AgentDefinitionScope>();\n  if (skipScopesAbove) {\n    const skipIndex = SCOPE_PRIORITY.indexOf(skipScopesAbove);\n    if (skipIndex !== -1) {\n      // Skip this scope and all higher-priority scopes\n      for (let i = 0; i <= skipIndex; i++) {\n        skipScopes.add(SCOPE_PRIORITY[i]);\n      }\n    }\n  }\n\n  // Precedence: project overrides global overrides built-in.\n  const candidates: Array<{ scope: Exclude<AgentDefinitionScope, \"built-in\">; root: string }> = [\n    { scope: \"project\", root: roots.projectRoot },\n    { scope: \"global\", root: roots.globalRoot },\n  ];\n\n  for (const candidate of candidates) {\n    if (skipScopes.has(candidate.scope)) {\n      continue;\n    }\n\n    let resolvedRoot: string;\n    try {\n      resolvedRoot = await runtime.resolvePath(candidate.root);\n    } catch {\n      continue;\n    }\n\n    const filePath = runtime.normalizePath(`${agentId}.md`, resolvedRoot);\n\n    try {\n      const stat = await runtime.stat(filePath);\n      if (stat.isDirectory) {\n        continue;\n      }\n\n      const sizeValidation = validateFileSize(stat);\n      if (sizeValidation) {\n        throw new Error(sizeValidation.error);\n      }\n\n      const content = await readFileString(runtime, filePath);\n      const parsed = parseAgentDefinitionMarkdown({ content, byteSize: stat.size });\n\n      const pkg: AgentDefinitionPackage = {\n        id: agentId,\n        scope: candidate.scope,\n        frontmatter: parsed.frontmatter,\n        body: parsed.body,\n      };\n\n      const validated = AgentDefinitionPackageSchema.safeParse(pkg);\n      if (!validated.success) {\n        throw new Error(\n          `Invalid agent definition package for '${agentId}' (${candidate.scope}): ${validated.error.message}`\n        );\n      }\n\n      return validated.data;\n    } catch {\n      continue;\n    }\n  }\n\n  if (!skipScopes.has(\"built-in\")) {\n    const builtIn = getBuiltInAgentDefinitions().find((pkg) => pkg.id === agentId);\n    if (builtIn) {\n      const validated = AgentDefinitionPackageSchema.safeParse(builtIn);\n      if (!validated.success) {\n        throw new Error(\n          `Invalid built-in agent definition '${agentId}': ${validated.error.message}`\n        );\n      }\n      return validated.data;\n    }\n  }\n\n  throw new Error(`Agent definition not found: ${agentId}`);\n}\n\n/**\n * Resolve the effective system prompt body for an agent, including inherited content.\n *\n * By default (or with `prompt.append: true`), the agent's body is appended to its base's body.\n * Set `prompt.append: false` to replace the base body entirely.\n *\n * When resolving a base, we skip the current agent's scope to allow overriding built-ins:\n * - Project-scope `exec.md` with `base: exec` → resolves to global/built-in exec\n * - Global-scope `exec.md` with `base: exec` → resolves to built-in exec\n */\nexport async function resolveAgentBody(\n  runtime: Runtime,\n  workspacePath: string,\n  agentId: AgentId,\n  options?: { roots?: AgentDefinitionsRoots; skipScopesAbove?: AgentDefinitionScope }\n): Promise<string> {\n  const visited = new Set<string>();\n\n  function mergeSkipScopesAbove(\n    a: AgentDefinitionScope | undefined,\n    b: AgentDefinitionScope | undefined\n  ): AgentDefinitionScope | undefined {\n    if (!a) {\n      return b;\n    }\n    if (!b) {\n      return a;\n    }\n\n    const aIndex = SCOPE_PRIORITY.indexOf(a);\n    const bIndex = SCOPE_PRIORITY.indexOf(b);\n\n    // Defensive fallback. (In practice, both should always be in SCOPE_PRIORITY.)\n    if (aIndex === -1 || bIndex === -1) {\n      return a;\n    }\n\n    return aIndex > bIndex ? a : b;\n  }\n\n  async function resolve(\n    id: AgentId,\n    depth: number,\n    skipScopesAbove?: AgentDefinitionScope\n  ): Promise<string> {\n    if (depth > MAX_INHERITANCE_DEPTH) {\n      throw new Error(\n        `Agent inheritance depth exceeded for '${id}' (max: ${MAX_INHERITANCE_DEPTH})`\n      );\n    }\n\n    const pkg = await readAgentDefinition(runtime, workspacePath, id, {\n      roots: options?.roots,\n      skipScopesAbove,\n    });\n\n    const visitKey = agentVisitKey(pkg.id, pkg.scope);\n    if (visited.has(visitKey)) {\n      throw new Error(`Circular agent inheritance detected: ${pkg.id} (${pkg.scope})`);\n    }\n    visited.add(visitKey);\n\n    const baseId = pkg.frontmatter.base;\n    const shouldAppend = pkg.frontmatter.prompt?.append !== false;\n\n    if (!baseId || !shouldAppend) {\n      return pkg.body;\n    }\n\n    const baseBody = await resolve(\n      baseId,\n      depth + 1,\n      mergeSkipScopesAbove(skipScopesAbove, computeBaseSkipScope(baseId, id, pkg.scope))\n    );\n    const separator = baseBody.trim() && pkg.body.trim() ? \"\\n\\n\" : \"\";\n    return `${baseBody}${separator}${pkg.body}`;\n  }\n\n  return resolve(agentId, 0, options?.skipScopesAbove);\n}\n\nfunction formatZodIssues(\n  issues: ReadonlyArray<{ path: readonly PropertyKey[]; message: string }>\n): string {\n  return issues\n    .map((issue) => {\n      const issuePath =\n        issue.path.length > 0 ? issue.path.map((part) => String(part)).join(\".\") : \"<root>\";\n      return `${issuePath}: ${issue.message}`;\n    })\n    .join(\"; \");\n}\n\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\n  if (!value || typeof value !== \"object\" || Array.isArray(value)) {\n    return false;\n  }\n\n  const proto: unknown = Object.getPrototypeOf(value);\n  return proto === Object.prototype || proto === null;\n}\n\nfunction deepMergeAgentFrontmatter(\n  base: unknown,\n  overlay: unknown,\n  path: readonly string[]\n): unknown {\n  // Inherit base when the overlay isn't specified.\n  if (overlay === undefined) {\n    return base;\n  }\n\n  const pathKey = path.join(\".\");\n  if (\n    Array.isArray(base) &&\n    Array.isArray(overlay) &&\n    (pathKey === \"tools.add\" || pathKey === \"tools.remove\")\n  ) {\n    // Tool layers are processed in order (base first, then child).\n    return [...(base as unknown[]), ...(overlay as unknown[])];\n  }\n\n  if (isPlainObject(base) && isPlainObject(overlay)) {\n    const merged: Record<string, unknown> = { ...base };\n\n    for (const [key, overlayValue] of Object.entries(overlay)) {\n      merged[key] = deepMergeAgentFrontmatter(merged[key], overlayValue, [...path, key]);\n    }\n\n    return merged;\n  }\n\n  // Primitive, array (non-tools), or mismatched types: overlay wins.\n  return overlay;\n}\n\n/**\n * Resolve an agent's effective frontmatter by overlaying its base chain (base first, then child).\n *\n * Unlike prompt body inheritance, frontmatter inheritance is always applied when `base` is set.\n * This prevents same-name overrides (e.g. project exec.md with base: exec) from accidentally\n * dropping important base config like subagent.runnable or subagent.append_prompt.\n */\nexport async function resolveAgentFrontmatter(\n  runtime: Runtime,\n  workspacePath: string,\n  agentId: AgentId,\n  options?: { roots?: AgentDefinitionsRoots; skipScopesAbove?: AgentDefinitionScope }\n): Promise<AgentDefinitionPackage[\"frontmatter\"]> {\n  if (!workspacePath) {\n    throw new Error(\"resolveAgentFrontmatter: workspacePath is required\");\n  }\n\n  const visited = new Set<string>();\n\n  function mergeSkipScopesAbove(\n    a: AgentDefinitionScope | undefined,\n    b: AgentDefinitionScope | undefined\n  ): AgentDefinitionScope | undefined {\n    if (!a) {\n      return b;\n    }\n    if (!b) {\n      return a;\n    }\n\n    const aIndex = SCOPE_PRIORITY.indexOf(a);\n    const bIndex = SCOPE_PRIORITY.indexOf(b);\n\n    // Defensive fallback. (In practice, both should always be in SCOPE_PRIORITY.)\n    if (aIndex === -1 || bIndex === -1) {\n      return a;\n    }\n\n    // Prefer the scope that skips *more* (e.g. global skips project+global).\n    return aIndex > bIndex ? a : b;\n  }\n\n  async function resolve(\n    id: AgentId,\n    depth: number,\n    skipScopesAbove?: AgentDefinitionScope\n  ): Promise<AgentDefinitionPackage[\"frontmatter\"]> {\n    if (depth > MAX_INHERITANCE_DEPTH) {\n      throw new Error(\n        `Agent inheritance depth exceeded for '${id}' (max: ${MAX_INHERITANCE_DEPTH})`\n      );\n    }\n\n    const pkg = await readAgentDefinition(runtime, workspacePath, id, {\n      roots: options?.roots,\n      skipScopesAbove,\n    });\n\n    const visitKey = agentVisitKey(pkg.id, pkg.scope);\n    if (visited.has(visitKey)) {\n      throw new Error(`Circular agent inheritance detected: ${pkg.id} (${pkg.scope})`);\n    }\n    visited.add(visitKey);\n\n    const baseId = pkg.frontmatter.base;\n    if (!baseId) {\n      return pkg.frontmatter;\n    }\n\n    const baseFrontmatter = await resolve(\n      baseId,\n      depth + 1,\n      mergeSkipScopesAbove(skipScopesAbove, computeBaseSkipScope(baseId, id, pkg.scope))\n    );\n\n    const mergedRaw = deepMergeAgentFrontmatter(baseFrontmatter, pkg.frontmatter, []);\n    const merged = AgentDefinitionFrontmatterSchema.safeParse(mergedRaw);\n    if (!merged.success) {\n      throw new Error(\n        `Invalid merged frontmatter for '${id}': ${formatZodIssues(merged.error.issues)}`\n      );\n    }\n\n    return merged.data;\n  }\n\n  return resolve(agentId, 0, options?.skipScopesAbove);\n}\n"]}