{"version":3,"file":"resolveToolPolicy.test.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/resolveToolPolicy.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\r\n\r\nimport type { AgentLikeForPolicy } from \"./resolveToolPolicy\";\r\nimport { resolveToolPolicyForAgent } from \"./resolveToolPolicy\";\r\n\r\n// Test helper: agents array is ordered child → base (as returned by resolveAgentInheritanceChain)\r\ndescribe(\"resolveToolPolicyForAgent\", () => {\r\n  test(\"no tools means all tools disabled\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{}];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([{ regex_match: \".*\", action: \"disable\" }]);\r\n  });\r\n\r\n  test(\"tools.add enables specified patterns\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [\"file_read\", \"bash.*\"] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"bash.*\", action: \"enable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"agents can include propose_plan in tools\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [\"propose_plan\", \"file_read\"] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"propose_plan\", action: \"enable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"subagents hard-deny interactive planning tools and always allow agent_report\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [\"task\", \"file_read\"] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: true,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"task\", action: \"enable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"propose_plan\", action: \"disable\" },\r\n      { regex_match: \"ask_user_question\", action: \"disable\" },\r\n      { regex_match: \"agent_report\", action: \"enable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"depth limit hard-denies task tools\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [\"task\", \"file_read\"] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: true,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"task\", action: \"enable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"task\", action: \"disable\" },\r\n      { regex_match: \"task_.*\", action: \"disable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"depth limit hard-denies task tools for subagents\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [\"task\", \"file_read\"] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: true,\r\n      disableTaskToolsForDepth: true,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"task\", action: \"enable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"task\", action: \"disable\" },\r\n      { regex_match: \"task_.*\", action: \"disable\" },\r\n      { regex_match: \"propose_plan\", action: \"disable\" },\r\n      { regex_match: \"ask_user_question\", action: \"disable\" },\r\n      { regex_match: \"agent_report\", action: \"enable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"empty tools.add array means no tools\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([{ regex_match: \".*\", action: \"disable\" }]);\r\n  });\r\n\r\n  test(\"whitespace in tool patterns is trimmed\", () => {\r\n    const agents: AgentLikeForPolicy[] = [{ tools: { add: [\"  file_read  \", \"  \", \"bash\"] } }];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"bash\", action: \"enable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"tools.remove disables specified patterns\", () => {\r\n    const agents: AgentLikeForPolicy[] = [\r\n      { tools: { add: [\"file_read\", \"bash\", \"task\"], remove: [\"task\"] } },\r\n    ];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"bash\", action: \"enable\" },\r\n      { regex_match: \"task\", action: \"enable\" },\r\n      { regex_match: \"task\", action: \"disable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"inherits tools from base agent\", () => {\r\n    // Chain: ask → exec (ordered child → base as returned by resolveAgentInheritanceChain)\r\n    const agents: AgentLikeForPolicy[] = [\r\n      { tools: { remove: [\"file_edit_.*\"] } }, // ask (child)\r\n      { tools: { add: [\".*\"], remove: [\"propose_plan\"] } }, // exec (base)\r\n    ];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    // exec: deny-all → enable .* → disable propose_plan\r\n    // ask: → disable file_edit_.*\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \".*\", action: \"enable\" },\r\n      { regex_match: \"propose_plan\", action: \"disable\" },\r\n      { regex_match: \"file_edit_.*\", action: \"disable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"multi-level inheritance\", () => {\r\n    // Chain: leaf → middle → base (ordered child → base)\r\n    const agents: AgentLikeForPolicy[] = [\r\n      { tools: { remove: [\"task\"] } }, // leaf (child)\r\n      { tools: { add: [\"task\"], remove: [\"bash\"] } }, // middle\r\n      { tools: { add: [\"file_read\", \"bash\"] } }, // base\r\n    ];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    // base: deny-all → enable file_read → enable bash\r\n    // middle: → enable task → disable bash\r\n    // leaf: → disable task\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"bash\", action: \"enable\" },\r\n      { regex_match: \"task\", action: \"enable\" },\r\n      { regex_match: \"bash\", action: \"disable\" },\r\n      { regex_match: \"task\", action: \"disable\" },\r\n    ]);\r\n  });\r\n\r\n  test(\"child can add tools not in base\", () => {\r\n    // Chain: child → base (ordered child → base)\r\n    const agents: AgentLikeForPolicy[] = [\r\n      { tools: { add: [\"bash\"] } }, // child\r\n      { tools: { add: [\"file_read\"] } }, // base\r\n    ];\r\n    const policy = resolveToolPolicyForAgent({\r\n      agents,\r\n      isSubagent: false,\r\n      disableTaskToolsForDepth: false,\r\n    });\r\n\r\n    expect(policy).toEqual([\r\n      { regex_match: \".*\", action: \"disable\" },\r\n      { regex_match: \"file_read\", action: \"enable\" },\r\n      { regex_match: \"bash\", action: \"enable\" },\r\n    ]);\r\n  });\r\n});\r\n"]}