{"version":3,"file":"parseAgentDefinitionMarkdown.test.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/parseAgentDefinitionMarkdown.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from \"bun:test\";\r\n\r\nimport {\r\n  AgentDefinitionParseError,\r\n  parseAgentDefinitionMarkdown,\r\n} from \"./parseAgentDefinitionMarkdown\";\r\n\r\ndescribe(\"parseAgentDefinitionMarkdown\", () => {\r\n  test(\"parses valid YAML frontmatter and body (ignores unknown keys)\", () => {\r\n    const content = `---\r\nname: My Agent\r\ndescription: Does stuff\r\nbase: exec\r\ntools:\r\n  add: [\"file_read\", \"bash.*\"]\r\nunknownTopLevel: 123\r\nui:\r\n  hidden: false\r\n  color: \"#ff00ff\"\r\n  unknownNested: 456\r\n---\r\n# Instructions\r\nDo the thing.\r\n`;\r\n\r\n    const result = parseAgentDefinitionMarkdown({\r\n      content,\r\n      byteSize: Buffer.byteLength(content, \"utf-8\"),\r\n    });\r\n\r\n    expect(result.frontmatter.name).toBe(\"My Agent\");\r\n    expect(result.frontmatter.description).toBe(\"Does stuff\");\r\n    expect(result.frontmatter.base).toBe(\"exec\");\r\n    expect(result.frontmatter.tools).toEqual({ add: [\"file_read\", \"bash.*\"] });\r\n    expect(result.frontmatter.ui?.hidden).toBe(false);\r\n    expect(result.frontmatter.ui?.color).toBe(\"#ff00ff\");\r\n\r\n    const frontmatterUnknown = result.frontmatter as unknown as Record<string, unknown>;\r\n    expect(frontmatterUnknown.unknownTopLevel).toBeUndefined();\r\n\r\n    if (!result.frontmatter.ui) {\r\n      throw new Error(\"Expected ui to be present\");\r\n    }\r\n    const uiUnknown = result.frontmatter.ui as unknown as Record<string, unknown>;\r\n    expect(uiUnknown.unknownNested).toBeUndefined();\r\n\r\n    expect(result.body).toContain(\"# Instructions\");\r\n  });\r\n\r\n  test(\"accepts legacy ui.selectable\", () => {\r\n    const content = `---\r\nname: Legacy UI\r\nui:\r\n  selectable: false\r\n---\r\nBody\r\n`;\r\n\r\n    const result = parseAgentDefinitionMarkdown({\r\n      content,\r\n      byteSize: Buffer.byteLength(content, \"utf-8\"),\r\n    });\r\n\r\n    expect(result.frontmatter.ui?.selectable).toBe(false);\r\n  });\r\n\r\n  test(\"parses ui.requires\", () => {\r\n    const content = `---\r\nname: Requires Plan\r\nui:\r\n  requires:\r\n    - plan\r\n---\r\nBody\r\n`;\r\n\r\n    const result = parseAgentDefinitionMarkdown({\r\n      content,\r\n      byteSize: Buffer.byteLength(content, \"utf-8\"),\r\n    });\r\n\r\n    expect(result.frontmatter.ui?.requires).toEqual([\"plan\"]);\r\n  });\r\n\r\n  test(\"parses subagent.skip_init_hook\", () => {\r\n    const content = `---\r\nname: Skip Init\r\nsubagent:\r\n  runnable: true\r\n  skip_init_hook: true\r\n---\r\nBody\r\n`;\r\n\r\n    const result = parseAgentDefinitionMarkdown({\r\n      content,\r\n      byteSize: Buffer.byteLength(content, \"utf-8\"),\r\n    });\r\n\r\n    expect(result.frontmatter.subagent?.skip_init_hook).toBe(true);\r\n  });\r\n\r\n  test(\"throws on missing frontmatter\", () => {\r\n    expect(() =>\r\n      parseAgentDefinitionMarkdown({\r\n        content: \"# No frontmatter\\n\",\r\n        byteSize: 14,\r\n      })\r\n    ).toThrow(AgentDefinitionParseError);\r\n  });\r\n\r\n  test(\"parses tools as add/remove patterns\", () => {\r\n    const content = `---\r\nname: Regex Tools\r\ntools:\r\n  add:\r\n    - file_read\r\n    - \"bash.*\"\r\n    - \"task_.*\"\r\n  remove:\r\n    - task\r\n---\r\nBody\r\n`;\r\n\r\n    const result = parseAgentDefinitionMarkdown({\r\n      content,\r\n      byteSize: Buffer.byteLength(content, \"utf-8\"),\r\n    });\r\n\r\n    expect(result.frontmatter.tools).toEqual({\r\n      add: [\"file_read\", \"bash.*\", \"task_.*\"],\r\n      remove: [\"task\"],\r\n    });\r\n  });\r\n});\r\n"]}