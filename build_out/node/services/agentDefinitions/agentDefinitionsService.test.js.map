{"version":3,"file":"agentDefinitionsService.test.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/agentDefinitionsService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\n\nimport { describe, expect, test } from \"bun:test\";\n\nimport { AgentIdSchema } from \"@/common/orpc/schemas\";\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\nimport {\n  discoverAgentDefinitions,\n  readAgentDefinition,\n  resolveAgentBody,\n  resolveAgentFrontmatter,\n} from \"./agentDefinitionsService\";\n\nasync function writeAgent(root: string, id: string, name: string): Promise<void> {\n  await fs.mkdir(root, { recursive: true });\n  const content = `---\nname: ${name}\npolicy:\n  base: exec\n---\nBody\n`;\n  await fs.writeFile(path.join(root, `${id}.md`), content, \"utf-8\");\n}\n\ndescribe(\"agentDefinitionsService\", () => {\n  test(\"project agents override global agents\", async () => {\n    using project = new DisposableTempDir(\"agent-defs-project\");\n    using global = new DisposableTempDir(\"agent-defs-global\");\n\n    const projectAgentsRoot = path.join(project.path, \".mux\", \"agents\");\n    const globalAgentsRoot = global.path;\n\n    await writeAgent(globalAgentsRoot, \"foo\", \"Foo (global)\");\n    await writeAgent(projectAgentsRoot, \"foo\", \"Foo (project)\");\n    await writeAgent(globalAgentsRoot, \"bar\", \"Bar (global)\");\n\n    const roots = { projectRoot: projectAgentsRoot, globalRoot: globalAgentsRoot };\n    const runtime = new LocalRuntime(project.path);\n\n    const agents = await discoverAgentDefinitions(runtime, project.path, { roots });\n\n    const foo = agents.find((a) => a.id === \"foo\");\n    expect(foo).toBeDefined();\n    expect(foo!.scope).toBe(\"project\");\n    expect(foo!.name).toBe(\"Foo (project)\");\n\n    const bar = agents.find((a) => a.id === \"bar\");\n    expect(bar).toBeDefined();\n    expect(bar!.scope).toBe(\"global\");\n  });\n\n  test(\"readAgentDefinition resolves project before global\", async () => {\n    using project = new DisposableTempDir(\"agent-defs-project\");\n    using global = new DisposableTempDir(\"agent-defs-global\");\n\n    const projectAgentsRoot = path.join(project.path, \".mux\", \"agents\");\n    const globalAgentsRoot = global.path;\n\n    await writeAgent(globalAgentsRoot, \"foo\", \"Foo (global)\");\n    await writeAgent(projectAgentsRoot, \"foo\", \"Foo (project)\");\n\n    const roots = { projectRoot: projectAgentsRoot, globalRoot: globalAgentsRoot };\n    const runtime = new LocalRuntime(project.path);\n\n    const agentId = AgentIdSchema.parse(\"foo\");\n    const pkg = await readAgentDefinition(runtime, project.path, agentId, { roots });\n\n    expect(pkg.scope).toBe(\"project\");\n    expect(pkg.frontmatter.name).toBe(\"Foo (project)\");\n  });\n\n  test(\"resolveAgentBody appends by default (new default), replaces when prompt.append is false\", async () => {\n    using tempDir = new DisposableTempDir(\"agent-body-test\");\n    const agentsRoot = path.join(tempDir.path, \".mux\", \"agents\");\n    await fs.mkdir(agentsRoot, { recursive: true });\n\n    // Create base agent\n    await fs.writeFile(\n      path.join(agentsRoot, \"base.md\"),\n      `---\nname: Base\ntools:\n  add:\n    - .*\n---\nBase instructions.\n`,\n      \"utf-8\"\n    );\n\n    // Create child agent that appends (default behavior)\n    await fs.writeFile(\n      path.join(agentsRoot, \"child.md\"),\n      `---\nname: Child\nbase: base\n---\nChild additions.\n`,\n      \"utf-8\"\n    );\n\n    // Create another child that explicitly replaces\n    await fs.writeFile(\n      path.join(agentsRoot, \"replacer.md\"),\n      `---\nname: Replacer\nbase: base\nprompt:\n  append: false\n---\nReplaced body.\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: agentsRoot, globalRoot: agentsRoot };\n    const runtime = new LocalRuntime(tempDir.path);\n\n    // Child without explicit prompt settings should append (new default)\n    const childBody = await resolveAgentBody(runtime, tempDir.path, \"child\", { roots });\n    expect(childBody).toContain(\"Base instructions.\");\n    expect(childBody).toContain(\"Child additions.\");\n\n    // Child with prompt.append: false should replace (explicit opt-out)\n    const replacerBody = await resolveAgentBody(runtime, tempDir.path, \"replacer\", { roots });\n    expect(replacerBody).toBe(\"Replaced body.\\n\");\n    expect(replacerBody).not.toContain(\"Base instructions\");\n  });\n\n  test(\"same-name override: project agent with base: self extends built-in/global, not itself\", async () => {\n    using project = new DisposableTempDir(\"agent-same-name\");\n    using global = new DisposableTempDir(\"agent-same-name-global\");\n\n    const projectAgentsRoot = path.join(project.path, \".mux\", \"agents\");\n    const globalAgentsRoot = global.path;\n\n    await fs.mkdir(projectAgentsRoot, { recursive: true });\n    await fs.mkdir(globalAgentsRoot, { recursive: true });\n\n    // Global \"foo\" agent (simulates built-in or global config)\n    await fs.writeFile(\n      path.join(globalAgentsRoot, \"foo.md\"),\n      `---\nname: Foo\ntools:\n  add:\n    - .*\n---\nGlobal foo instructions.\n`,\n      \"utf-8\"\n    );\n\n    // Project-local \"foo\" agent that extends the global one via base: foo\n    // This should NOT cause a circular dependency (would previously infinite loop)\n    await fs.writeFile(\n      path.join(projectAgentsRoot, \"foo.md\"),\n      `---\nname: Foo\nbase: foo\n---\nProject-specific additions.\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: projectAgentsRoot, globalRoot: globalAgentsRoot };\n    const runtime = new LocalRuntime(project.path);\n\n    // Verify project agent is discovered\n    const agents = await discoverAgentDefinitions(runtime, project.path, { roots });\n    const foo = agents.find((a) => a.id === \"foo\");\n    expect(foo).toBeDefined();\n    expect(foo!.scope).toBe(\"project\");\n    expect(foo!.base).toBe(\"foo\"); // Points to itself by name\n\n    // Verify body resolution correctly inherits from global (not self)\n    const body = await resolveAgentBody(runtime, project.path, \"foo\", { roots });\n    expect(body).toContain(\"Global foo instructions.\");\n    expect(body).toContain(\"Project-specific additions.\");\n  });\n\n  test(\"readAgentDefinition with skipScopesAbove skips higher-priority scopes\", async () => {\n    using project = new DisposableTempDir(\"agent-skip-scope\");\n    using global = new DisposableTempDir(\"agent-skip-scope-global\");\n\n    const projectAgentsRoot = path.join(project.path, \".mux\", \"agents\");\n    const globalAgentsRoot = global.path;\n\n    await fs.mkdir(projectAgentsRoot, { recursive: true });\n    await fs.mkdir(globalAgentsRoot, { recursive: true });\n\n    await fs.writeFile(\n      path.join(globalAgentsRoot, \"test.md\"),\n      `---\nname: Test Global\n---\nGlobal body.\n`,\n      \"utf-8\"\n    );\n\n    await fs.writeFile(\n      path.join(projectAgentsRoot, \"test.md\"),\n      `---\nname: Test Project\n---\nProject body.\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: projectAgentsRoot, globalRoot: globalAgentsRoot };\n    const runtime = new LocalRuntime(project.path);\n\n    // Without skip: project takes precedence\n    const normalPkg = await readAgentDefinition(runtime, project.path, \"test\", { roots });\n    expect(normalPkg.scope).toBe(\"project\");\n    expect(normalPkg.frontmatter.name).toBe(\"Test Project\");\n\n    // With skipScopesAbove: \"project\" â†’ skip project, return global\n    const skippedPkg = await readAgentDefinition(runtime, project.path, \"test\", {\n      roots,\n      skipScopesAbove: \"project\",\n    });\n    expect(skippedPkg.scope).toBe(\"global\");\n    expect(skippedPkg.frontmatter.name).toBe(\"Test Global\");\n  });\n\n  test(\"resolveAgentFrontmatter inherits omitted fields from base chain (same-name override)\", async () => {\n    using project = new DisposableTempDir(\"agent-frontmatter-project\");\n    using global = new DisposableTempDir(\"agent-frontmatter-global\");\n\n    const projectAgentsRoot = path.join(project.path, \".mux\", \"agents\");\n    const globalAgentsRoot = global.path;\n\n    await fs.mkdir(projectAgentsRoot, { recursive: true });\n    await fs.mkdir(globalAgentsRoot, { recursive: true });\n\n    await fs.writeFile(\n      path.join(globalAgentsRoot, \"foo.md\"),\n      `---\nname: Foo Base\ndescription: Base description\nui:\n  hidden: true\n  color: red\n  requires:\n    - plan\nsubagent:\n  runnable: true\n  append_prompt: Base subagent prompt\n  skip_init_hook: true\nai:\n  model: base-model\n  thinkingLevel: high\ntools:\n  add:\n    - baseAdd\n  remove:\n    - baseRemove\n---\nBase body.\n`,\n      \"utf-8\"\n    );\n\n    await fs.writeFile(\n      path.join(projectAgentsRoot, \"foo.md\"),\n      `---\nname: Foo Project\nbase: foo\nui:\n  color: blue\n---\nProject body.\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: projectAgentsRoot, globalRoot: globalAgentsRoot };\n    const runtime = new LocalRuntime(project.path);\n\n    const frontmatter = await resolveAgentFrontmatter(runtime, project.path, \"foo\", { roots });\n\n    expect(frontmatter.description).toBe(\"Base description\");\n    expect(frontmatter.ui?.hidden).toBe(true);\n    expect(frontmatter.ui?.color).toBe(\"blue\");\n    expect(frontmatter.ui?.requires).toEqual([\"plan\"]);\n    expect(frontmatter.subagent?.runnable).toBe(true);\n    expect(frontmatter.subagent?.append_prompt).toBe(\"Base subagent prompt\");\n    expect(frontmatter.subagent?.skip_init_hook).toBe(true);\n    expect(frontmatter.ai?.model).toBe(\"base-model\");\n    expect(frontmatter.ai?.thinkingLevel).toBe(\"high\");\n    expect(frontmatter.tools?.add).toEqual([\"baseAdd\"]);\n    expect(frontmatter.tools?.remove).toEqual([\"baseRemove\"]);\n  });\n\n  test(\"resolveAgentFrontmatter preserves explicit falsy overrides\", async () => {\n    using tempDir = new DisposableTempDir(\"agent-frontmatter-falsy\");\n    const agentsRoot = path.join(tempDir.path, \".mux\", \"agents\");\n    await fs.mkdir(agentsRoot, { recursive: true });\n\n    await fs.writeFile(\n      path.join(agentsRoot, \"base.md\"),\n      `---\nname: Base\nui:\n  hidden: true\nsubagent:\n  runnable: true\n  skip_init_hook: true\n---\n`,\n      \"utf-8\"\n    );\n\n    await fs.writeFile(\n      path.join(agentsRoot, \"child.md\"),\n      `---\nname: Child\nbase: base\nui:\n  hidden: false\nsubagent:\n  runnable: false\n  skip_init_hook: false\n---\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: agentsRoot, globalRoot: agentsRoot };\n    const runtime = new LocalRuntime(tempDir.path);\n\n    const frontmatter = await resolveAgentFrontmatter(runtime, tempDir.path, \"child\", { roots });\n\n    expect(frontmatter.ui?.hidden).toBe(false);\n    expect(frontmatter.subagent?.runnable).toBe(false);\n    expect(frontmatter.subagent?.skip_init_hook).toBe(false);\n  });\n\n  test(\"resolveAgentFrontmatter concatenates tools.add/tools.remove (base first)\", async () => {\n    using tempDir = new DisposableTempDir(\"agent-frontmatter-tools\");\n    const agentsRoot = path.join(tempDir.path, \".mux\", \"agents\");\n    await fs.mkdir(agentsRoot, { recursive: true });\n\n    await fs.writeFile(\n      path.join(agentsRoot, \"base.md\"),\n      `---\nname: Base\ntools:\n  add:\n    - a\n  remove:\n    - b\n---\n`,\n      \"utf-8\"\n    );\n\n    await fs.writeFile(\n      path.join(agentsRoot, \"child.md\"),\n      `---\nname: Child\nbase: base\ntools:\n  add:\n    - c\n  remove:\n    - d\n---\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: agentsRoot, globalRoot: agentsRoot };\n    const runtime = new LocalRuntime(tempDir.path);\n\n    const frontmatter = await resolveAgentFrontmatter(runtime, tempDir.path, \"child\", { roots });\n\n    expect(frontmatter.tools?.add).toEqual([\"a\", \"c\"]);\n    expect(frontmatter.tools?.remove).toEqual([\"b\", \"d\"]);\n  });\n\n  test(\"resolveAgentFrontmatter detects cycles\", async () => {\n    using tempDir = new DisposableTempDir(\"agent-frontmatter-cycle\");\n    const agentsRoot = path.join(tempDir.path, \".mux\", \"agents\");\n    await fs.mkdir(agentsRoot, { recursive: true });\n\n    await fs.writeFile(\n      path.join(agentsRoot, \"a.md\"),\n      `---\nname: A\nbase: b\n---\n`,\n      \"utf-8\"\n    );\n\n    await fs.writeFile(\n      path.join(agentsRoot, \"b.md\"),\n      `---\nname: B\nbase: a\n---\n`,\n      \"utf-8\"\n    );\n\n    const roots = { projectRoot: agentsRoot, globalRoot: agentsRoot };\n    const runtime = new LocalRuntime(tempDir.path);\n\n    expect(resolveAgentFrontmatter(runtime, tempDir.path, \"a\", { roots })).rejects.toThrow(\n      \"Circular agent inheritance detected\"\n    );\n  });\n});\n"]}