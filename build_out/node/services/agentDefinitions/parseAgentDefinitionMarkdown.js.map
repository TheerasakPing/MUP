{"version":3,"file":"parseAgentDefinitionMarkdown.js","sourceRoot":"","sources":["../../../../src/node/services/agentDefinitions/parseAgentDefinitionMarkdown.ts"],"names":[],"mappings":"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","sourcesContent":["import { AgentDefinitionFrontmatterSchema } from \"@/common/orpc/schemas\";\nimport type { AgentDefinitionFrontmatter } from \"@/common/types/agentDefinition\";\nimport { MAX_FILE_SIZE } from \"@/node/services/tools/fileCommon\";\nimport YAML from \"yaml\";\n\nexport class AgentDefinitionParseError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = \"AgentDefinitionParseError\";\n  }\n}\n\nexport interface ParsedAgentDefinitionMarkdown {\n  frontmatter: AgentDefinitionFrontmatter;\n  body: string;\n}\n\nfunction normalizeNewlines(input: string): string {\n  return input.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\\n\");\n}\n\nfunction stripUtf8Bom(input: string): string {\n  return input.startsWith(\"\\uFEFF\") ? input.slice(1) : input;\n}\n\nfunction assertObject(value: unknown, message: string): asserts value is Record<string, unknown> {\n  if (!value || typeof value !== \"object\" || Array.isArray(value)) {\n    throw new AgentDefinitionParseError(message);\n  }\n}\n\nfunction formatZodIssues(\n  issues: ReadonlyArray<{ path: readonly PropertyKey[]; message: string }>\n): string {\n  return issues\n    .map((issue) => {\n      const issuePath =\n        issue.path.length > 0 ? issue.path.map((part) => String(part)).join(\".\") : \"<root>\";\n      return `${issuePath}: ${issue.message}`;\n    })\n    .join(\"; \");\n}\n\n/**\n * Parse an agent definition markdown file into validated YAML frontmatter + markdown body.\n *\n * Defensive constraints:\n * - Enforces the shared 1MB max file size\n * - Requires YAML frontmatter delimited by `---` on its own line at the top\n */\nexport function parseAgentDefinitionMarkdown(input: {\n  content: string;\n  byteSize: number;\n}): ParsedAgentDefinitionMarkdown {\n  if (input.byteSize > MAX_FILE_SIZE) {\n    const sizeMB = (input.byteSize / (1024 * 1024)).toFixed(2);\n    const maxMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(2);\n    throw new AgentDefinitionParseError(\n      `Agent definition is too large (${sizeMB}MB). Maximum supported size is ${maxMB}MB.`\n    );\n  }\n\n  const content = normalizeNewlines(stripUtf8Bom(input.content));\n\n  if (!content.startsWith(\"---\")) {\n    throw new AgentDefinitionParseError(\n      \"Agent definition must start with YAML frontmatter delimited by '---'.\"\n    );\n  }\n\n  const lines = content.split(\"\\n\");\n  if ((lines[0] ?? \"\").trim() !== \"---\") {\n    throw new AgentDefinitionParseError(\n      \"Agent definition frontmatter start delimiter must be exactly '---'.\"\n    );\n  }\n\n  const endIndex = lines.findIndex((line, idx) => idx > 0 && line.trim() === \"---\");\n  if (endIndex === -1) {\n    throw new AgentDefinitionParseError(\n      \"Agent definition frontmatter is missing the closing '---' delimiter.\"\n    );\n  }\n\n  const yamlText = lines.slice(1, endIndex).join(\"\\n\");\n  const body = lines.slice(endIndex + 1).join(\"\\n\");\n\n  let raw: unknown;\n  try {\n    raw = YAML.parse(yamlText);\n  } catch (err) {\n    const message = err instanceof Error ? err.message : String(err);\n    throw new AgentDefinitionParseError(`Failed to parse YAML frontmatter: ${message}`);\n  }\n\n  assertObject(raw, \"Agent definition YAML frontmatter must be a mapping/object.\");\n\n  const parsed = AgentDefinitionFrontmatterSchema.safeParse(raw);\n  if (!parsed.success) {\n    throw new AgentDefinitionParseError(\n      `Invalid agent definition frontmatter: ${formatZodIssues(parsed.error.issues)}`\n    );\n  }\n\n  return { frontmatter: parsed.data, body };\n}\n"]}