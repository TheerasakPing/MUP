{"version":3,"file":"projectService.test.js","sourceRoot":"","sources":["../../../src/node/services/projectService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { execSync } from \"child_process\";\r\nimport { Config } from \"@/node/config\";\r\nimport { ProjectService } from \"./projectService\";\r\n\r\ndescribe(\"ProjectService\", () => {\r\n  let tempDir: string;\r\n  let config: Config;\r\n  let service: ProjectService;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"projectservice-test-\"));\r\n    config = new Config(tempDir);\r\n    service = new ProjectService(config);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  describe(\"listDirectory\", () => {\r\n    it(\"returns root node with the actual requested path, not empty string\", async () => {\r\n      // Create test directory structure\r\n      const testDir = path.join(tempDir, \"test-project\");\r\n      await fs.mkdir(testDir);\r\n      await fs.mkdir(path.join(testDir, \"subdir1\"));\r\n      await fs.mkdir(path.join(testDir, \"subdir2\"));\r\n      await fs.writeFile(path.join(testDir, \"file.txt\"), \"test\");\r\n\r\n      const result = await service.listDirectory(testDir);\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      // Critical regression test: root.path must be the actual path, not \"\"\r\n      // This was broken when buildFileTree() was used, which always returns path: \"\"\r\n      expect(result.data.path).toBe(testDir);\r\n      expect(result.data.name).toBe(testDir);\r\n      expect(result.data.isDirectory).toBe(true);\r\n    });\r\n\r\n    it(\"returns only immediate subdirectories as children\", async () => {\r\n      const testDir = path.join(tempDir, \"nested\");\r\n      await fs.mkdir(testDir);\r\n      await fs.mkdir(path.join(testDir, \"child1\"));\r\n      await fs.mkdir(path.join(testDir, \"child1\", \"grandchild\")); // nested\r\n      await fs.mkdir(path.join(testDir, \"child2\"));\r\n      await fs.writeFile(path.join(testDir, \"file.txt\"), \"test\"); // file, not dir\r\n\r\n      const result = await service.listDirectory(testDir);\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      // Should only have child1 and child2, not grandchild or file.txt\r\n      expect(result.data.children.length).toBe(2);\r\n      const childNames = result.data.children.map((c) => c.name).sort();\r\n      expect(childNames).toEqual([\"child1\", \"child2\"]);\r\n    });\r\n\r\n    it(\"children have correct full paths\", async () => {\r\n      const testDir = path.join(tempDir, \"paths-test\");\r\n      await fs.mkdir(testDir);\r\n      await fs.mkdir(path.join(testDir, \"mysubdir\"));\r\n\r\n      const result = await service.listDirectory(testDir);\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      expect(result.data.children.length).toBe(1);\r\n      const child = result.data.children[0];\r\n      expect(child.name).toBe(\"mysubdir\");\r\n      expect(child.path).toBe(path.join(testDir, \"mysubdir\"));\r\n      expect(child.isDirectory).toBe(true);\r\n    });\r\n\r\n    it(\"resolves relative paths to absolute\", async () => {\r\n      // Create a subdir in tempDir\r\n      const subdir = path.join(tempDir, \"relative-test\");\r\n      await fs.mkdir(subdir);\r\n\r\n      const result = await service.listDirectory(subdir);\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      // Should be resolved to absolute path\r\n      expect(path.isAbsolute(result.data.path)).toBe(true);\r\n      expect(result.data.path).toBe(subdir);\r\n    });\r\n\r\n    it(\"handles empty directory\", async () => {\r\n      const emptyDir = path.join(tempDir, \"empty\");\r\n      await fs.mkdir(emptyDir);\r\n\r\n      const result = await service.listDirectory(emptyDir);\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      expect(result.data.path).toBe(emptyDir);\r\n      expect(result.data.children).toEqual([]);\r\n    });\r\n\r\n    it(\"handles '.' path by resolving to current working directory\", async () => {\r\n      // Save cwd and change to tempDir for this test\r\n      const originalCwd = process.cwd();\r\n      // Use realpath to resolve symlinks (e.g., /var -> /private/var on macOS)\r\n      const realTempDir = await fs.realpath(tempDir);\r\n      process.chdir(realTempDir);\r\n\r\n      try {\r\n        const result = await service.listDirectory(\".\");\r\n\r\n        expect(result.success).toBe(true);\r\n        if (!result.success) throw new Error(\"Expected success\");\r\n\r\n        expect(result.data.path).toBe(realTempDir);\r\n        expect(path.isAbsolute(result.data.path)).toBe(true);\r\n      } finally {\r\n        process.chdir(originalCwd);\r\n      }\r\n    });\r\n\r\n    it(\"returns error for non-existent directory\", async () => {\r\n      const result = await service.listDirectory(path.join(tempDir, \"does-not-exist\"));\r\n\r\n      expect(result.success).toBe(false);\r\n      if (result.success) throw new Error(\"Expected failure\");\r\n      expect(result.error).toContain(\"ENOENT\");\r\n    });\r\n\r\n    it(\"expands ~ to home directory\", async () => {\r\n      const result = await service.listDirectory(\"~\");\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      expect(result.data.path).toBe(os.homedir());\r\n    });\r\n\r\n    it(\"expands ~/subpath to home directory subpath\", async () => {\r\n      const result = await service.listDirectory(\"~/.\");\r\n\r\n      expect(result.success).toBe(true);\r\n      if (!result.success) throw new Error(\"Expected success\");\r\n\r\n      expect(result.data.path).toBe(os.homedir());\r\n    });\r\n  });\r\n\r\n  describe(\"gitInit\", () => {\r\n    it(\"initializes git repo in non-git directory with initial commit\", async () => {\r\n      const testDir = path.join(tempDir, \"new-project\");\r\n      await fs.mkdir(testDir);\r\n\r\n      const result = await service.gitInit(testDir);\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      // Verify .git directory was created\r\n      const gitDir = path.join(testDir, \".git\");\r\n      const stat = await fs.stat(gitDir);\r\n      expect(stat.isDirectory()).toBe(true);\r\n\r\n      // Verify a branch exists (main) after the initial commit\r\n      const branchResult = await service.listBranches(testDir);\r\n      expect(branchResult.branches).toContain(\"main\");\r\n      expect(branchResult.recommendedTrunk).toBe(\"main\");\r\n    });\r\n\r\n    it(\"succeeds for unborn git repo (git init but no commits)\", async () => {\r\n      const testDir = path.join(tempDir, \"unborn-git\");\r\n      await fs.mkdir(testDir);\r\n\r\n      // Create an unborn repo (git init without commits)\r\n      execSync(\"git init -b main\", { cwd: testDir, stdio: \"ignore\" });\r\n\r\n      const result = await service.gitInit(testDir);\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      // Verify branch exists after the commit\r\n      const branchResult = await service.listBranches(testDir);\r\n      expect(branchResult.branches).toContain(\"main\");\r\n    });\r\n\r\n    it(\"returns error for git repo with existing commits\", async () => {\r\n      const testDir = path.join(tempDir, \"existing-git\");\r\n      await fs.mkdir(testDir);\r\n\r\n      // Create a repo with a commit\r\n      execSync(\"git init -b main\", { cwd: testDir, stdio: \"ignore\" });\r\n      execSync('git -c user.name=\"test\" -c user.email=\"test@test\" commit --allow-empty -m \"test\"', {\r\n        cwd: testDir,\r\n        stdio: \"ignore\",\r\n      });\r\n\r\n      const result = await service.gitInit(testDir);\r\n\r\n      expect(result.success).toBe(false);\r\n      if (result.success) throw new Error(\"Expected failure\");\r\n      expect(result.error).toContain(\"already a git repository\");\r\n    });\r\n\r\n    it(\"returns error for empty project path\", async () => {\r\n      const result = await service.gitInit(\"\");\r\n\r\n      expect(result.success).toBe(false);\r\n      if (result.success) throw new Error(\"Expected failure\");\r\n      expect(result.error).toContain(\"required\");\r\n    });\r\n\r\n    it(\"returns error for non-existent directory\", async () => {\r\n      const result = await service.gitInit(\"/non-existent-path-12345\");\r\n\r\n      expect(result.success).toBe(false);\r\n      if (result.success) throw new Error(\"Expected failure\");\r\n      expect(result.error).toContain(\"does not exist\");\r\n    });\r\n  });\r\n});\r\n"]}