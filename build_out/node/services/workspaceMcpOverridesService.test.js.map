{"version":3,"file":"workspaceMcpOverridesService.test.js","sourceRoot":"","sources":["../../../src/node/services/workspaceMcpOverridesService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport { Config } from \"@/node/config\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\r\nimport { WorkspaceMcpOverridesService } from \"./workspaceMcpOverridesService\";\r\n\r\nfunction getWorkspacePath(args: {\r\n  srcDir: string;\r\n  projectName: string;\r\n  workspaceName: string;\r\n}): string {\r\n  return path.join(args.srcDir, args.projectName, args.workspaceName);\r\n}\r\n\r\nasync function pathExists(filePath: string): Promise<boolean> {\r\n  try {\r\n    await fs.stat(filePath);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\ndescribe(\"WorkspaceMcpOverridesService\", () => {\r\n  let tempDir: string;\r\n  let config: Config;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-mcp-overrides-test-\"));\r\n    config = new Config(tempDir);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  it(\"returns empty overrides when no file and no legacy config\", async () => {\r\n    const projectPath = \"/fake/project\";\r\n    const workspaceId = \"ws-id\";\r\n    const workspaceName = \"branch\";\r\n\r\n    const workspacePath = getWorkspacePath({\r\n      srcDir: config.srcDir,\r\n      projectName: \"project\",\r\n      workspaceName,\r\n    });\r\n    await fs.mkdir(workspacePath, { recursive: true });\r\n\r\n    await config.editConfig((cfg) => {\r\n      cfg.projects.set(projectPath, {\r\n        workspaces: [\r\n          {\r\n            path: workspacePath,\r\n            id: workspaceId,\r\n            name: workspaceName,\r\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\r\n          },\r\n        ],\r\n      });\r\n      return cfg;\r\n    });\r\n\r\n    const service = new WorkspaceMcpOverridesService(config);\r\n    const overrides = await service.getOverridesForWorkspace(workspaceId);\r\n\r\n    expect(overrides).toEqual({});\r\n    expect(await pathExists(path.join(workspacePath, \".mux\", \"mcp.local.jsonc\"))).toBe(false);\r\n  });\r\n\r\n  it(\"adds .mux/mcp.local.jsonc to git exclude when writing overrides\", async () => {\r\n    const projectPath = \"/fake/project\";\r\n    const workspaceId = \"ws-id\";\r\n    const workspaceName = \"branch\";\r\n\r\n    const workspacePath = getWorkspacePath({\r\n      srcDir: config.srcDir,\r\n      projectName: \"project\",\r\n      workspaceName,\r\n    });\r\n    await fs.mkdir(workspacePath, { recursive: true });\r\n\r\n    const runtime = createRuntime({ type: \"local\" }, { projectPath: workspacePath });\r\n    const gitInitResult = await execBuffered(runtime, \"git init\", {\r\n      cwd: workspacePath,\r\n      timeout: 10,\r\n    });\r\n    expect(gitInitResult.exitCode).toBe(0);\r\n\r\n    await config.editConfig((cfg) => {\r\n      cfg.projects.set(projectPath, {\r\n        workspaces: [\r\n          {\r\n            path: workspacePath,\r\n            id: workspaceId,\r\n            name: workspaceName,\r\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\r\n          },\r\n        ],\r\n      });\r\n      return cfg;\r\n    });\r\n\r\n    const service = new WorkspaceMcpOverridesService(config);\r\n\r\n    const excludePathResult = await execBuffered(runtime, \"git rev-parse --git-path info/exclude\", {\r\n      cwd: workspacePath,\r\n      timeout: 10,\r\n    });\r\n    expect(excludePathResult.exitCode).toBe(0);\r\n\r\n    const excludePathRaw = excludePathResult.stdout.trim();\r\n    expect(excludePathRaw.length).toBeGreaterThan(0);\r\n\r\n    const excludePath = path.isAbsolute(excludePathRaw)\r\n      ? excludePathRaw\r\n      : path.join(workspacePath, excludePathRaw);\r\n\r\n    const before = (await pathExists(excludePath)) ? await fs.readFile(excludePath, \"utf-8\") : \"\";\r\n    expect(before).not.toContain(\".mux/mcp.local.jsonc\");\r\n\r\n    await service.setOverridesForWorkspace(workspaceId, {\r\n      disabledServers: [\"server-a\"],\r\n    });\r\n\r\n    const after = await fs.readFile(excludePath, \"utf-8\");\r\n    expect(after).toContain(\".mux/mcp.local.jsonc\");\r\n  });\r\n  it(\"persists overrides to .mux/mcp.local.jsonc and reads them back\", async () => {\r\n    const projectPath = \"/fake/project\";\r\n    const workspaceId = \"ws-id\";\r\n    const workspaceName = \"branch\";\r\n\r\n    const workspacePath = getWorkspacePath({\r\n      srcDir: config.srcDir,\r\n      projectName: \"project\",\r\n      workspaceName,\r\n    });\r\n    await fs.mkdir(workspacePath, { recursive: true });\r\n\r\n    await config.editConfig((cfg) => {\r\n      cfg.projects.set(projectPath, {\r\n        workspaces: [\r\n          {\r\n            path: workspacePath,\r\n            id: workspaceId,\r\n            name: workspaceName,\r\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\r\n          },\r\n        ],\r\n      });\r\n      return cfg;\r\n    });\r\n\r\n    const service = new WorkspaceMcpOverridesService(config);\r\n\r\n    await service.setOverridesForWorkspace(workspaceId, {\r\n      disabledServers: [\"server-a\", \"server-a\"],\r\n      toolAllowlist: { \"server-b\": [\"tool1\", \"tool1\", \"\"] },\r\n    });\r\n\r\n    const filePath = path.join(workspacePath, \".mux\", \"mcp.local.jsonc\");\r\n    expect(await pathExists(filePath)).toBe(true);\r\n\r\n    const roundTrip = await service.getOverridesForWorkspace(workspaceId);\r\n    expect(roundTrip).toEqual({\r\n      disabledServers: [\"server-a\"],\r\n      toolAllowlist: { \"server-b\": [\"tool1\"] },\r\n    });\r\n  });\r\n\r\n  it(\"removes workspace-local file when overrides are set to empty\", async () => {\r\n    const projectPath = \"/fake/project\";\r\n    const workspaceId = \"ws-id\";\r\n    const workspaceName = \"branch\";\r\n\r\n    const workspacePath = getWorkspacePath({\r\n      srcDir: config.srcDir,\r\n      projectName: \"project\",\r\n      workspaceName,\r\n    });\r\n    await fs.mkdir(workspacePath, { recursive: true });\r\n\r\n    await config.editConfig((cfg) => {\r\n      cfg.projects.set(projectPath, {\r\n        workspaces: [\r\n          {\r\n            path: workspacePath,\r\n            id: workspaceId,\r\n            name: workspaceName,\r\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\r\n          },\r\n        ],\r\n      });\r\n      return cfg;\r\n    });\r\n\r\n    const service = new WorkspaceMcpOverridesService(config);\r\n\r\n    await service.setOverridesForWorkspace(workspaceId, {\r\n      disabledServers: [\"server-a\"],\r\n    });\r\n\r\n    const filePath = path.join(workspacePath, \".mux\", \"mcp.local.jsonc\");\r\n    expect(await pathExists(filePath)).toBe(true);\r\n\r\n    await service.setOverridesForWorkspace(workspaceId, {});\r\n    expect(await pathExists(filePath)).toBe(false);\r\n  });\r\n\r\n  it(\"migrates legacy config.json overrides into workspace-local file\", async () => {\r\n    const projectPath = \"/fake/project\";\r\n    const workspaceId = \"ws-id\";\r\n    const workspaceName = \"branch\";\r\n\r\n    const workspacePath = getWorkspacePath({\r\n      srcDir: config.srcDir,\r\n      projectName: \"project\",\r\n      workspaceName,\r\n    });\r\n    await fs.mkdir(workspacePath, { recursive: true });\r\n\r\n    await config.editConfig((cfg) => {\r\n      cfg.projects.set(projectPath, {\r\n        workspaces: [\r\n          {\r\n            path: workspacePath,\r\n            id: workspaceId,\r\n            name: workspaceName,\r\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\r\n            mcp: {\r\n              disabledServers: [\"server-a\"],\r\n              toolAllowlist: { \"server-b\": [\"tool1\"] },\r\n            },\r\n          },\r\n        ],\r\n      });\r\n      return cfg;\r\n    });\r\n\r\n    const service = new WorkspaceMcpOverridesService(config);\r\n    const overrides = await service.getOverridesForWorkspace(workspaceId);\r\n\r\n    expect(overrides).toEqual({\r\n      disabledServers: [\"server-a\"],\r\n      toolAllowlist: { \"server-b\": [\"tool1\"] },\r\n    });\r\n\r\n    // File written\r\n    const filePath = path.join(workspacePath, \".mux\", \"mcp.local.jsonc\");\r\n    expect(await pathExists(filePath)).toBe(true);\r\n\r\n    // Legacy config cleared\r\n    const loaded = config.loadConfigOrDefault();\r\n    const projectConfig = loaded.projects.get(projectPath);\r\n    expect(projectConfig).toBeDefined();\r\n    expect(projectConfig!.workspaces[0].mcp).toBeUndefined();\r\n  });\r\n});\r\n"]}