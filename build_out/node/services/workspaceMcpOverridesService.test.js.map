{"version":3,"file":"workspaceMcpOverridesService.test.js","sourceRoot":"","sources":["../../../src/node/services/workspaceMcpOverridesService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\nimport { Config } from \"@/node/config\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\nimport { WorkspaceMcpOverridesService } from \"./workspaceMcpOverridesService\";\n\nfunction getWorkspacePath(args: {\n  srcDir: string;\n  projectName: string;\n  workspaceName: string;\n}): string {\n  return path.join(args.srcDir, args.projectName, args.workspaceName);\n}\n\nasync function pathExists(filePath: string): Promise<boolean> {\n  try {\n    await fs.stat(filePath);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\ndescribe(\"WorkspaceMcpOverridesService\", () => {\n  let tempDir: string;\n  let config: Config;\n\n  beforeEach(async () => {\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-mcp-overrides-test-\"));\n    config = new Config(tempDir);\n  });\n\n  afterEach(async () => {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  });\n\n  it(\"returns empty overrides when no file and no legacy config\", async () => {\n    const projectPath = \"/fake/project\";\n    const workspaceId = \"ws-id\";\n    const workspaceName = \"branch\";\n\n    const workspacePath = getWorkspacePath({\n      srcDir: config.srcDir,\n      projectName: \"project\",\n      workspaceName,\n    });\n    await fs.mkdir(workspacePath, { recursive: true });\n\n    await config.editConfig((cfg) => {\n      cfg.projects.set(projectPath, {\n        workspaces: [\n          {\n            path: workspacePath,\n            id: workspaceId,\n            name: workspaceName,\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\n          },\n        ],\n      });\n      return cfg;\n    });\n\n    const service = new WorkspaceMcpOverridesService(config);\n    const overrides = await service.getOverridesForWorkspace(workspaceId);\n\n    expect(overrides).toEqual({});\n    expect(await pathExists(path.join(workspacePath, \".mux\", \"mcp.local.jsonc\"))).toBe(false);\n  });\n\n  it(\"adds .mux/mcp.local.jsonc to git exclude when writing overrides\", async () => {\n    const projectPath = \"/fake/project\";\n    const workspaceId = \"ws-id\";\n    const workspaceName = \"branch\";\n\n    const workspacePath = getWorkspacePath({\n      srcDir: config.srcDir,\n      projectName: \"project\",\n      workspaceName,\n    });\n    await fs.mkdir(workspacePath, { recursive: true });\n\n    const runtime = createRuntime({ type: \"local\" }, { projectPath: workspacePath });\n    const gitInitResult = await execBuffered(runtime, \"git init\", {\n      cwd: workspacePath,\n      timeout: 10,\n    });\n    expect(gitInitResult.exitCode).toBe(0);\n\n    await config.editConfig((cfg) => {\n      cfg.projects.set(projectPath, {\n        workspaces: [\n          {\n            path: workspacePath,\n            id: workspaceId,\n            name: workspaceName,\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\n          },\n        ],\n      });\n      return cfg;\n    });\n\n    const service = new WorkspaceMcpOverridesService(config);\n\n    const excludePathResult = await execBuffered(runtime, \"git rev-parse --git-path info/exclude\", {\n      cwd: workspacePath,\n      timeout: 10,\n    });\n    expect(excludePathResult.exitCode).toBe(0);\n\n    const excludePathRaw = excludePathResult.stdout.trim();\n    expect(excludePathRaw.length).toBeGreaterThan(0);\n\n    const excludePath = path.isAbsolute(excludePathRaw)\n      ? excludePathRaw\n      : path.join(workspacePath, excludePathRaw);\n\n    const before = (await pathExists(excludePath)) ? await fs.readFile(excludePath, \"utf-8\") : \"\";\n    expect(before).not.toContain(\".mux/mcp.local.jsonc\");\n\n    await service.setOverridesForWorkspace(workspaceId, {\n      disabledServers: [\"server-a\"],\n    });\n\n    const after = await fs.readFile(excludePath, \"utf-8\");\n    expect(after).toContain(\".mux/mcp.local.jsonc\");\n  });\n  it(\"persists overrides to .mux/mcp.local.jsonc and reads them back\", async () => {\n    const projectPath = \"/fake/project\";\n    const workspaceId = \"ws-id\";\n    const workspaceName = \"branch\";\n\n    const workspacePath = getWorkspacePath({\n      srcDir: config.srcDir,\n      projectName: \"project\",\n      workspaceName,\n    });\n    await fs.mkdir(workspacePath, { recursive: true });\n\n    await config.editConfig((cfg) => {\n      cfg.projects.set(projectPath, {\n        workspaces: [\n          {\n            path: workspacePath,\n            id: workspaceId,\n            name: workspaceName,\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\n          },\n        ],\n      });\n      return cfg;\n    });\n\n    const service = new WorkspaceMcpOverridesService(config);\n\n    await service.setOverridesForWorkspace(workspaceId, {\n      disabledServers: [\"server-a\", \"server-a\"],\n      toolAllowlist: { \"server-b\": [\"tool1\", \"tool1\", \"\"] },\n    });\n\n    const filePath = path.join(workspacePath, \".mux\", \"mcp.local.jsonc\");\n    expect(await pathExists(filePath)).toBe(true);\n\n    const roundTrip = await service.getOverridesForWorkspace(workspaceId);\n    expect(roundTrip).toEqual({\n      disabledServers: [\"server-a\"],\n      toolAllowlist: { \"server-b\": [\"tool1\"] },\n    });\n  });\n\n  it(\"removes workspace-local file when overrides are set to empty\", async () => {\n    const projectPath = \"/fake/project\";\n    const workspaceId = \"ws-id\";\n    const workspaceName = \"branch\";\n\n    const workspacePath = getWorkspacePath({\n      srcDir: config.srcDir,\n      projectName: \"project\",\n      workspaceName,\n    });\n    await fs.mkdir(workspacePath, { recursive: true });\n\n    await config.editConfig((cfg) => {\n      cfg.projects.set(projectPath, {\n        workspaces: [\n          {\n            path: workspacePath,\n            id: workspaceId,\n            name: workspaceName,\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\n          },\n        ],\n      });\n      return cfg;\n    });\n\n    const service = new WorkspaceMcpOverridesService(config);\n\n    await service.setOverridesForWorkspace(workspaceId, {\n      disabledServers: [\"server-a\"],\n    });\n\n    const filePath = path.join(workspacePath, \".mux\", \"mcp.local.jsonc\");\n    expect(await pathExists(filePath)).toBe(true);\n\n    await service.setOverridesForWorkspace(workspaceId, {});\n    expect(await pathExists(filePath)).toBe(false);\n  });\n\n  it(\"migrates legacy config.json overrides into workspace-local file\", async () => {\n    const projectPath = \"/fake/project\";\n    const workspaceId = \"ws-id\";\n    const workspaceName = \"branch\";\n\n    const workspacePath = getWorkspacePath({\n      srcDir: config.srcDir,\n      projectName: \"project\",\n      workspaceName,\n    });\n    await fs.mkdir(workspacePath, { recursive: true });\n\n    await config.editConfig((cfg) => {\n      cfg.projects.set(projectPath, {\n        workspaces: [\n          {\n            path: workspacePath,\n            id: workspaceId,\n            name: workspaceName,\n            runtimeConfig: { type: \"worktree\", srcBaseDir: config.srcDir },\n            mcp: {\n              disabledServers: [\"server-a\"],\n              toolAllowlist: { \"server-b\": [\"tool1\"] },\n            },\n          },\n        ],\n      });\n      return cfg;\n    });\n\n    const service = new WorkspaceMcpOverridesService(config);\n    const overrides = await service.getOverridesForWorkspace(workspaceId);\n\n    expect(overrides).toEqual({\n      disabledServers: [\"server-a\"],\n      toolAllowlist: { \"server-b\": [\"tool1\"] },\n    });\n\n    // File written\n    const filePath = path.join(workspacePath, \".mux\", \"mcp.local.jsonc\");\n    expect(await pathExists(filePath)).toBe(true);\n\n    // Legacy config cleared\n    const loaded = config.loadConfigOrDefault();\n    const projectConfig = loaded.projects.get(projectPath);\n    expect(projectConfig).toBeDefined();\n    expect(projectConfig!.workspaces[0].mcp).toBeUndefined();\n  });\n});\n"]}