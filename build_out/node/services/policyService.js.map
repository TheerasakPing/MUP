{"version":3,"file":"policyService.js","sourceRoot":"","sources":["../../../src/node/services/policyService.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from \"events\";\nimport { readFile } from \"node:fs/promises\";\nimport { log } from \"@/node/services/log\";\nimport type { Config } from \"@/node/config\";\nimport { Err, Ok, type Result } from \"@/common/types/result\";\nimport {\n  PolicyFileSchema,\n  type EffectivePolicy,\n  type PolicyGetResponse,\n  type PolicyRuntimeId,\n  type PolicySource,\n} from \"@/common/orpc/schemas/policy\";\nimport type { ProviderName } from \"@/common/constants/providers\";\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\nimport type { MCPServerTransport } from \"@/common/types/mcp\";\nimport { compareVersions } from \"@/node/services/coderService\";\n\nimport packageJson from \"../../../package.json\";\n\nconst POLICY_FETCH_TIMEOUT_MS = 10 * 1000;\nconst POLICY_MAX_BYTES = 1024 * 1024;\nconst POLICY_REFRESH_INTERVAL_MS = 15 * 60 * 1000;\n\ntype ActivePolicySource =\n  | { kind: \"env\"; value: string }\n  | { kind: \"governor\"; origin: string; token: string }\n  | { kind: \"none\" };\n\nfunction stableNormalize(value: unknown): unknown {\n  if (Array.isArray(value)) {\n    return value.map(stableNormalize);\n  }\n  if (value && typeof value === \"object\") {\n    const obj = value as Record<string, unknown>;\n    return Object.fromEntries(\n      Object.keys(obj)\n        .sort()\n        .map((key) => [key, stableNormalize(obj[key])])\n    );\n  }\n  return value;\n}\n\nfunction stableStringify(value: unknown): string {\n  return JSON.stringify(stableNormalize(value));\n}\n\nasync function getClientVersion(): Promise<string> {\n  // Prefer Electron's app version when available (authoritative in packaged apps).\n  if (process.versions.electron) {\n    try {\n      // Intentionally lazy import to keep CLI/server mode light.\n      // eslint-disable-next-line no-restricted-syntax\n      const { app } = await import(\"electron\");\n      return app.getVersion();\n    } catch {\n      // Ignore and fall back.\n    }\n  }\n\n  // Fallback for CLI/headless.\n  if (typeof packageJson.version === \"string\") {\n    return packageJson.version;\n  }\n\n  return \"0.0.0\";\n}\n\nfunction isRemotePolicySource(source: string): boolean {\n  return source.startsWith(\"http://\") || source.startsWith(\"https://\");\n}\n\nfunction formatPolicySourceForLog(source: string): string {\n  if (!isRemotePolicySource(source)) {\n    return source;\n  }\n\n  try {\n    const url = new URL(source);\n    // Intentionally omit credentials and query string.\n    return `${url.origin}${url.pathname}`;\n  } catch {\n    return \"<policy-url>\";\n  }\n}\n\nasync function loadPolicyText(source: string): Promise<string> {\n  if (!isRemotePolicySource(source)) {\n    try {\n      return await readFile(source, \"utf8\");\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      throw new Error(`Failed to read policy file: ${message}`);\n    }\n  }\n\n  const abortController = new AbortController();\n  const timeout = setTimeout(() => abortController.abort(), POLICY_FETCH_TIMEOUT_MS);\n\n  try {\n    const response = await fetch(source, {\n      signal: abortController.signal,\n      headers: {\n        accept: \"application/json\",\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n\n    const text = await response.text();\n    const bytes = Buffer.byteLength(text, \"utf8\");\n    if (bytes > POLICY_MAX_BYTES) {\n      throw new Error(`Response too large (${bytes} bytes)`);\n    }\n\n    return text;\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    throw new Error(`Failed to fetch policy URL (${formatPolicySourceForLog(source)}): ${message}`);\n  } finally {\n    clearTimeout(timeout);\n  }\n}\n\nasync function loadGovernorPolicyText(input: {\n  governorOrigin: string;\n  token: string;\n}): Promise<string> {\n  const policyUrl = new URL(\"/api/v1/policy.json\", input.governorOrigin).toString();\n\n  const abortController = new AbortController();\n  const timeout = setTimeout(() => abortController.abort(), POLICY_FETCH_TIMEOUT_MS);\n\n  try {\n    const response = await fetch(policyUrl, {\n      signal: abortController.signal,\n      headers: {\n        accept: \"application/json\",\n        \"Mux-Governor-Session-Token\": input.token,\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n\n    const text = await response.text();\n    const bytes = Buffer.byteLength(text, \"utf8\");\n    if (bytes > POLICY_MAX_BYTES) {\n      throw new Error(`Response too large (${bytes} bytes)`);\n    }\n\n    return text;\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    throw new Error(\n      `Failed to fetch Governor policy (${formatPolicySourceForLog(policyUrl)}): ${message}`\n    );\n  } finally {\n    clearTimeout(timeout);\n  }\n}\nfunction normalizeForcedBaseUrl(value: string | undefined): string | undefined {\n  const trimmed = value?.trim();\n  if (!trimmed) {\n    return undefined;\n  }\n  return trimmed;\n}\n\nfunction parsePolicyFile(text: string): unknown {\n  // Policy files are strict JSON (no JS evaluation).\n  return JSON.parse(text) as unknown;\n}\n\nexport type PolicyStatus =\n  | { state: \"disabled\" }\n  | { state: \"enforced\" }\n  | { state: \"blocked\"; reason: string };\n\nexport class PolicyService {\n  private readonly emitter = new EventEmitter();\n  private refreshInterval: ReturnType<typeof setInterval> | null = null;\n\n  private source: PolicySource = \"none\";\n  private refreshInFlight: Promise<Result<void, string>> | null = null;\n\n  private status: PolicyStatus = { state: \"disabled\" };\n  private effectivePolicy: EffectivePolicy | null = null;\n  private signature: string = stableStringify({\n    source: this.source,\n    status: this.status,\n    policy: this.effectivePolicy,\n  });\n\n  constructor(private readonly config: Config) {\n    // Multiple windows can subscribe.\n    this.emitter.setMaxListeners(50);\n  }\n\n  async initialize(): Promise<void> {\n    await this.refreshPolicy({ isStartup: true });\n\n    if (!this.refreshInterval) {\n      this.refreshInterval = setInterval(() => {\n        void this.refreshPolicy({ isStartup: false });\n      }, POLICY_REFRESH_INTERVAL_MS);\n      this.refreshInterval.unref?.();\n    }\n  }\n\n  dispose(): void {\n    if (this.refreshInterval) {\n      clearInterval(this.refreshInterval);\n      this.refreshInterval = null;\n    }\n  }\n\n  async refreshNow(): Promise<Result<void, string>> {\n    return await this.refreshPolicy({ isStartup: false });\n  }\n  onPolicyChanged(callback: () => void): () => void {\n    this.emitter.on(\"policyChanged\", callback);\n    return () => this.emitter.off(\"policyChanged\", callback);\n  }\n\n  private emitPolicyChanged(): void {\n    this.emitter.emit(\"policyChanged\");\n  }\n\n  getPolicyGetResponse(): PolicyGetResponse {\n    return {\n      source: this.source,\n      status: this.toSchemaStatus(this.status),\n      policy: this.effectivePolicy,\n    };\n  }\n\n  getEffectivePolicy(): EffectivePolicy | null {\n    return this.effectivePolicy;\n  }\n\n  getStatus(): PolicyStatus {\n    return this.status;\n  }\n\n  isEnforced(): boolean {\n    // \"blocked\" should behave as deny-all enforcement so callers can't bypass the\n    // UI block by calling backend endpoints directly (CLI/headless/orpc).\n    return this.status.state !== \"disabled\";\n  }\n\n  isProviderAllowed(provider: ProviderName): boolean {\n    if (this.status.state === \"blocked\") {\n      return false;\n    }\n\n    const access = this.effectivePolicy?.providerAccess;\n    if (access == null) {\n      return true;\n    }\n\n    return access.some((p) => p.id === provider);\n  }\n\n  getForcedBaseUrl(provider: ProviderName): string | undefined {\n    return this.effectivePolicy?.providerAccess?.find((p) => p.id === provider)?.forcedBaseUrl;\n  }\n\n  isModelAllowed(provider: ProviderName, modelId: string): boolean {\n    if (this.status.state === \"blocked\") {\n      return false;\n    }\n\n    const access = this.effectivePolicy?.providerAccess;\n    if (access == null) {\n      return true;\n    }\n\n    const providerPolicy = access.find((p) => p.id === provider);\n    if (!providerPolicy) {\n      return false;\n    }\n\n    const allowedModels = providerPolicy.allowedModels ?? null;\n    if (allowedModels === null) {\n      return true;\n    }\n\n    return allowedModels.includes(modelId);\n  }\n\n  isMcpTransportAllowed(transport: MCPServerTransport): boolean {\n    if (this.status.state === \"blocked\") {\n      return false;\n    }\n\n    const policy = this.effectivePolicy;\n    if (!policy) {\n      return true;\n    }\n\n    const allow = policy.mcp.allowUserDefined;\n    if (transport === \"stdio\") {\n      return allow.stdio;\n    }\n\n    // http/sse/auto are all remote.\n    return allow.remote;\n  }\n\n  isRuntimeAllowed(runtimeConfig: RuntimeConfig | undefined): boolean {\n    if (this.status.state === \"blocked\") {\n      return false;\n    }\n\n    const runtimes = this.effectivePolicy?.runtimes;\n    if (runtimes == null) {\n      return true;\n    }\n\n    const runtimeId = this.getPolicyRuntimeId(runtimeConfig);\n    return runtimeId != null && runtimes.includes(runtimeId);\n  }\n\n  getPolicyRuntimeId(runtimeConfig: RuntimeConfig | undefined): PolicyRuntimeId | null {\n    if (!runtimeConfig) {\n      // This matches the server default in workspaceService.create().\n      return \"worktree\";\n    }\n\n    // Legacy local+srcBaseDir is treated as worktree.\n    if (runtimeConfig.type === \"local\" && \"srcBaseDir\" in runtimeConfig) {\n      return \"worktree\";\n    }\n\n    if (runtimeConfig.type === \"ssh\") {\n      return runtimeConfig.coder ? \"ssh+coder\" : \"ssh\";\n    }\n\n    return runtimeConfig.type;\n  }\n\n  private getActivePolicySource(): ActivePolicySource {\n    const filePath = process.env.MUX_POLICY_FILE?.trim();\n    if (filePath) {\n      return { kind: \"env\", value: filePath };\n    }\n\n    const config = this.config.loadConfigOrDefault();\n    const governorOrigin = config.muxGovernorUrl?.trim();\n    const governorToken = config.muxGovernorToken?.trim();\n\n    if (governorOrigin && governorToken) {\n      return { kind: \"governor\", origin: governorOrigin, token: governorToken };\n    }\n\n    return { kind: \"none\" };\n  }\n\n  private async refreshPolicy(options: { isStartup: boolean }): Promise<Result<void, string>> {\n    if (this.refreshInFlight) {\n      return this.refreshInFlight;\n    }\n\n    const promise = this.refreshPolicyOnce(options).finally(() => {\n      this.refreshInFlight = null;\n    });\n\n    this.refreshInFlight = promise;\n    return promise;\n  }\n\n  private async refreshPolicyOnce(options: { isStartup: boolean }): Promise<Result<void, string>> {\n    const policySource = this.getActivePolicySource();\n    if (policySource.kind === \"none\") {\n      // Policy is opt-in.\n      this.updateState({ source: \"none\", status: { state: \"disabled\" }, policy: null });\n      return Ok(undefined);\n    }\n\n    const schemaSource: PolicySource = policySource.kind === \"env\" ? \"env\" : \"governor\";\n\n    try {\n      const [clientVersion, fileText] = await Promise.all([\n        getClientVersion(),\n        policySource.kind === \"env\"\n          ? loadPolicyText(policySource.value)\n          : loadGovernorPolicyText({\n              governorOrigin: policySource.origin,\n              token: policySource.token,\n            }),\n      ]);\n\n      const raw = parsePolicyFile(fileText);\n      const parsed = PolicyFileSchema.parse(raw);\n\n      // Version gates\n      if (parsed.minimum_client_version) {\n        const min = parsed.minimum_client_version;\n        if (compareVersions(clientVersion, min) < 0) {\n          this.updateState({\n            source: schemaSource,\n            status: {\n              state: \"blocked\",\n              reason: `Mux ${clientVersion} is below required minimum_client_version ${min}`,\n            },\n            policy: null,\n          });\n          return Ok(undefined);\n        }\n      }\n\n      const providerAccess = (() => {\n        const list = parsed.provider_access;\n        if (!list || list.length === 0) {\n          return null;\n        }\n\n        return list.map((p) => {\n          const forcedBaseUrl = normalizeForcedBaseUrl(p.base_url);\n\n          const models = p.model_access;\n          if (!models || models.length === 0) {\n            return { id: p.id, forcedBaseUrl, allowedModels: null };\n          }\n\n          // Normalize + drop empties. An empty list means \"allow all\".\n          const normalized = models.map((m) => m.trim()).filter(Boolean);\n          if (normalized.length === 0) {\n            return { id: p.id, forcedBaseUrl, allowedModels: null };\n          }\n\n          return { id: p.id, forcedBaseUrl, allowedModels: normalized };\n        });\n      })();\n\n      const allowUserDefined = parsed.tools?.allow_user_defined_mcp;\n      const effective: EffectivePolicy = {\n        policyFormatVersion: \"0.1\",\n        serverVersion: parsed.server_version,\n        minimumClientVersion: parsed.minimum_client_version,\n\n        providerAccess,\n\n        mcp: {\n          allowUserDefined: {\n            stdio: allowUserDefined?.stdio ?? true,\n            remote: allowUserDefined?.remote ?? true,\n          },\n        },\n\n        runtimes:\n          parsed.runtimes && parsed.runtimes.length > 0 ? parsed.runtimes.map((r) => r.id) : null,\n      };\n\n      this.updateState({ source: schemaSource, status: { state: \"enforced\" }, policy: effective });\n      return Ok(undefined);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n\n      // Fail closed on startup, or if there's no existing enforced policy (e.g., first fetch\n      // after enrollment). This ensures enrollment can't silently bypass policy on a bad first fetch.\n      if (options.isStartup || this.effectivePolicy === null) {\n        this.updateState({\n          source: schemaSource,\n          status: { state: \"blocked\", reason: `Failed to load policy: ${message}` },\n          policy: null,\n        });\n        return Err(message);\n      }\n\n      // Refresh failures should not unlock the user; keep last-known-good.\n      log.warn(\"Policy refresh failed; keeping last-known-good policy\", { error: message });\n      return Err(message);\n    }\n  }\n\n  private updateState(next: {\n    source: PolicySource;\n    status: PolicyStatus;\n    policy: EffectivePolicy | null;\n  }): void {\n    const nextSignature = stableStringify(next);\n    if (nextSignature === this.signature) {\n      return;\n    }\n\n    this.source = next.source;\n    this.status = next.status;\n    this.effectivePolicy = next.policy;\n    this.signature = nextSignature;\n    this.emitPolicyChanged();\n  }\n\n  private toSchemaStatus(status: PolicyStatus): PolicyGetResponse[\"status\"] {\n    if (status.state === \"disabled\") {\n      return { state: \"disabled\" };\n    }\n    if (status.state === \"enforced\") {\n      return { state: \"enforced\" };\n    }\n    return { state: \"blocked\", reason: status.reason };\n  }\n}\n"]}