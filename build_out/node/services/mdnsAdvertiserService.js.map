{"version":3,"file":"mdnsAdvertiserService.js","sourceRoot":"","sources":["../../../src/node/services/mdnsAdvertiserService.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\nimport {\n  getResponder,\n  Protocol,\n  ServiceEvent,\n  type CiaoService,\n  type Responder,\n  type ServiceOptions,\n} from \"@homebridge/ciao\";\nimport * as net from \"node:net\";\nimport * as os from \"node:os\";\nimport { log } from \"./log\";\n\n// NOTE: Avoid \"mux\" here: it's an IANA-registered service name (\"Multiplexing Protocol\"),\n// and some discovery tools will display/handle it specially.\nexport const MUX_MDNS_SERVICE_TYPE = \"mux-api\";\n\ntype NetworkInterfaces = NodeJS.Dict<os.NetworkInterfaceInfo[]>;\n\nfunction getNonInternalInterfaceNames(\n  networkInterfaces: NetworkInterfaces,\n  family?: \"IPv4\" | \"IPv6\"\n): string[] {\n  const names: string[] = [];\n  const emptyInfos: os.NetworkInterfaceInfo[] = [];\n\n  for (const name of Object.keys(networkInterfaces)) {\n    const infos: os.NetworkInterfaceInfo[] = networkInterfaces[name] ?? emptyInfos;\n    for (const info of infos) {\n      const infoFamily = info.family;\n\n      if (family && infoFamily !== family) {\n        continue;\n      }\n\n      if (info.internal) {\n        continue;\n      }\n\n      const address = info.address;\n\n      // Filter out link-local addresses (they are rarely what users want to connect to).\n      if (infoFamily === \"IPv4\" && address.startsWith(\"169.254.\")) {\n        continue;\n      }\n      if (infoFamily === \"IPv6\" && address.toLowerCase().startsWith(\"fe80:\")) {\n        continue;\n      }\n\n      names.push(name);\n      break;\n    }\n  }\n\n  return Array.from(new Set(names)).sort();\n}\ntype ServiceTxtRecord = Record<string, string>;\n\nexport interface BuildMuxMdnsServiceOptions {\n  bindHost: string;\n  port: number;\n  instanceName: string;\n  version: string;\n  authRequired: boolean;\n  networkInterfaces?: NetworkInterfaces;\n}\n\nexport function buildMuxMdnsServiceOptions(options: BuildMuxMdnsServiceOptions): ServiceOptions {\n  const bindHost = options.bindHost.trim();\n  assert(bindHost, \"bindHost is required\");\n\n  assert(\n    Number.isInteger(options.port) && options.port >= 1 && options.port <= 65535,\n    \"invalid port\"\n  );\n\n  const rawInstanceName = options.instanceName.trim();\n  assert(rawInstanceName, \"instanceName is required\");\n\n  // DNS-SD service instance names are encoded as a single DNS label. Dots are legal characters\n  // in a label, but they must be escaped in the DNS wire format. `@homebridge/ciao` does not\n  // appear to escape dots, which results in *multi-label* instance names like:\n  //   mux-host.home._mux-api._tcp.local.\n  // Those don't show up via Apple's DNSServiceBrowse/DNSServiceResolve APIs (e.g. `dns-sd -B/-L`).\n  //\n  // To keep discovery tool/client behavior predictable, replace dots with hyphens.\n  const instanceName = rawInstanceName.replaceAll(\".\", \"-\");\n\n  const version = options.version.trim();\n  assert(version, \"version is required\");\n\n  const txt: ServiceTxtRecord = {\n    path: \"/orpc\",\n    wsPath: \"/orpc/ws\",\n    version,\n    authRequired: options.authRequired ? \"1\" : \"0\",\n  };\n\n  // Keep TXT payload intentionally small (think: \"hints\", not configuration).\n  // DNS-SD TXT uses an array of length-prefixed strings; this is a rough budget check.\n  const txtBytes = Object.entries(txt)\n    .map(([k, v]) => Buffer.byteLength(`${k}=${v}`, \"utf8\"))\n    .reduce((a, b) => a + b, 0);\n  assert(txtBytes <= 512, `TXT record too large (${txtBytes} bytes)`);\n\n  const serviceOptions: ServiceOptions = {\n    name: instanceName,\n    type: MUX_MDNS_SERVICE_TYPE,\n    protocol: Protocol.TCP,\n    port: options.port,\n    txt,\n  };\n\n  const networkInterfaces = options.networkInterfaces ?? os.networkInterfaces();\n\n  // If mux is bound to IPv4 wildcard only, don't advertise IPv6 addresses.\n  if (bindHost === \"0.0.0.0\") {\n    serviceOptions.disabledIpv6 = true;\n\n    // Avoid advertising loopback-only addresses (e.g. 127.0.0.1). Clients on other devices may\n    // naively pick the first resolved address and fail to connect.\n    const interfaceNames = getNonInternalInterfaceNames(networkInterfaces, \"IPv4\");\n    if (interfaceNames.length > 0) {\n      serviceOptions.restrictedAddresses = interfaceNames;\n    }\n  } else if (bindHost === \"::\") {\n    // Similar: when bound to IPv6 wildcard, don't include loopback-only addresses in DNS-SD records.\n    const interfaceNames = getNonInternalInterfaceNames(networkInterfaces);\n    if (interfaceNames.length > 0) {\n      serviceOptions.restrictedAddresses = interfaceNames;\n    }\n  } else if (net.isIP(bindHost)) {\n    // If mux is bound to a specific IP, only advertise that address (otherwise clients may\n    // discover an address that doesn't accept connections).\n    serviceOptions.restrictedAddresses = [bindHost];\n  }\n\n  return serviceOptions;\n}\n\nfunction stableTxtKey(txt: ServiceTxtRecord): string {\n  return Object.entries(txt)\n    .sort(([a], [b]) => a.localeCompare(b))\n    .map(([k, v]) => `${k}=${v}`)\n    .join(\"&\");\n}\n\nfunction stableServiceKey(options: ServiceOptions): string {\n  const restricted = options.restrictedAddresses\n    ? [...options.restrictedAddresses].sort().join(\",\")\n    : \"\";\n  const txt =\n    options.txt && typeof options.txt === \"object\"\n      ? stableTxtKey(options.txt as ServiceTxtRecord)\n      : \"\";\n  return [\n    options.name,\n    options.type,\n    options.protocol ?? \"tcp\",\n    String(options.port ?? \"\"),\n    restricted,\n    String(options.disabledIpv6 ?? false),\n    txt,\n  ].join(\"|\");\n}\n\nexport class MdnsAdvertiserService {\n  private responder: Responder | null = null;\n  private service: CiaoService | null = null;\n  private advertisedKey: string | null = null;\n  private chain: Promise<void> = Promise.resolve();\n\n  private enqueue(fn: () => Promise<void>): Promise<void> {\n    // Ensure a failed operation doesn't poison future start/stop calls.\n    this.chain = this.chain\n      .catch((err) => {\n        log.warn(\"mDNS advertiser previous operation failed:\", err);\n      })\n      .then(fn);\n    return this.chain;\n  }\n\n  start(serviceOptions: ServiceOptions): Promise<void> {\n    assert(serviceOptions.name, \"serviceOptions.name is required\");\n    assert(serviceOptions.type, \"serviceOptions.type is required\");\n\n    return this.enqueue(async () => {\n      const nextKey = stableServiceKey(serviceOptions);\n\n      if (this.service && this.advertisedKey === nextKey) {\n        return;\n      }\n\n      // If anything relevant changed (port, type, name, restrictions), republish.\n      if (this.service) {\n        await this.service.destroy();\n        this.service = null;\n        this.advertisedKey = null;\n      }\n\n      this.responder ??= getResponder();\n      const responder = this.responder;\n      assert(responder, \"responder must be initialized\");\n\n      const service = responder.createService(serviceOptions);\n      service.on(ServiceEvent.NAME_CHANGED, (name) => {\n        log.info(`mDNS service name changed due to conflict: ${name}`);\n      });\n      service.on(ServiceEvent.HOSTNAME_CHANGED, (hostname) => {\n        log.info(`mDNS hostname changed due to conflict: ${hostname}`);\n      });\n\n      await service.advertise();\n\n      log.info(\"mDNS service advertised\", {\n        name: serviceOptions.name,\n        type: serviceOptions.type,\n        protocol: serviceOptions.protocol ?? \"tcp\",\n        port: serviceOptions.port,\n        restrictedAddresses: serviceOptions.restrictedAddresses,\n        disabledIpv6: serviceOptions.disabledIpv6,\n        txt: serviceOptions.txt,\n      });\n\n      this.service = service;\n      this.advertisedKey = nextKey;\n    });\n  }\n\n  stop(): Promise<void> {\n    return this.enqueue(async () => {\n      const service = this.service;\n      this.service = null;\n      this.advertisedKey = null;\n\n      if (service) {\n        await service.destroy();\n      }\n\n      const responder = this.responder;\n      this.responder = null;\n\n      if (responder) {\n        await responder.shutdown();\n      }\n\n      if (service || responder) {\n        log.info(\"mDNS service stopped\");\n      }\n    });\n  }\n}\n"]}