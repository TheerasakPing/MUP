{"version":3,"file":"TodoListReminderSource.js","sourceRoot":"","sources":["../../../../../src/node/services/agentNotifications/sources/TodoListReminderSource.ts"],"names":[],"mappings":";;;;;;AAAA,mEAA2C;AAC3C,sDAAwE;AACxE,mEAA2E;AAQ3E,MAAM,8BAA8B,GAAG,CAAC,CAAC;AACzC,MAAM,2BAA2B,GAAG,EAAE,CAAC;AAEvC,SAAS,aAAa,CAAC,2BAAmC,EAAW;IACnE,IAAI,2BAA2B,KAAK,8BAA8B,EAAE,CAAC;QACnE,OAAO,IAAI,CAAC;IACd,CAAC;IAED,IAAI,2BAA2B,GAAG,8BAA8B,EAAE,CAAC;QACjE,OAAO,CACL,CAAC,2BAA2B,GAAG,8BAA8B,CAAC;YAC5D,2BAA2B;YAC7B,CAAC,CACF,CAAC;IACJ,CAAC;IAED,OAAO,KAAK,CAAC;AAAA,CACd;AAED;IACmB,mBAAmB,CAAS;IACrC,2BAA2B,GAAG,CAAC,CAAC;IAExC,YAAY,IAAqC,EAAE;QACjD,IAAA,gBAAM,EAAC,OAAO,IAAI,CAAC,mBAAmB,KAAK,QAAQ,EAAE,sCAAsC,CAAC,CAAC;QAC7F,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,mBAAmB,CAAC;IAAA,CACrD;IAED,KAAK,CAAC,IAAI,CAAC,GAA4B,EAAgC;QACrE,IAAA,gBAAM,EAAC,OAAO,GAAG,CAAC,QAAQ,KAAK,QAAQ,EAAE,2BAA2B,CAAC,CAAC;QAEtE,IAAI,GAAG,CAAC,QAAQ,KAAK,YAAY,EAAE,CAAC;YAClC,IAAI,GAAG,CAAC,aAAa,EAAE,CAAC;gBACtB,IAAI,CAAC,2BAA2B,GAAG,CAAC,CAAC;YACvC,CAAC;YACD,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,IAAI,CAAC,2BAA2B,IAAI,CAAC,CAAC;QAEtC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,2BAA2B,CAAC,EAAE,CAAC;YACrD,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,MAAM,KAAK,GAAG,MAAM,IAAA,oCAAsB,EAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;QACrE,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACvB,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,WAAW,CAAC,EAAE,CAAC;YACjD,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,MAAM,aAAa,GAAG,IAAA,wCAA6B,EAAC,KAAK,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,6BAA6B,IAAI,CAAC,2BAA2B,sIAAsI,aAAa,IAAI,WAAW,mBAAmB,CAAC;QAEnQ,OAAO;YACL;gBACE,MAAM,EAAE,oBAAoB;gBAC5B,OAAO;aACR;SACF,CAAC;IAAA,CACH;CACF","sourcesContent":["import assert from \"@/common/utils/assert\";\r\nimport { renderTodoItemsAsMarkdownList } from \"@/common/utils/todoList\";\r\nimport { readTodosForSessionDir } from \"@/node/services/todos/todoStorage\";\r\n\r\nimport type {\r\n  AgentNotification,\r\n  NotificationPollContext,\r\n  NotificationSource,\r\n} from \"@/node/services/agentNotifications/NotificationEngine\";\r\n\r\nconst FIRST_REMINDER_TOOL_CALL_COUNT = 5;\r\nconst REMINDER_TOOL_CALL_INTERVAL = 10;\r\n\r\nfunction isReminderDue(toolCallsSinceLastTodoWrite: number): boolean {\r\n  if (toolCallsSinceLastTodoWrite === FIRST_REMINDER_TOOL_CALL_COUNT) {\r\n    return true;\r\n  }\r\n\r\n  if (toolCallsSinceLastTodoWrite > FIRST_REMINDER_TOOL_CALL_COUNT) {\r\n    return (\r\n      (toolCallsSinceLastTodoWrite - FIRST_REMINDER_TOOL_CALL_COUNT) %\r\n        REMINDER_TOOL_CALL_INTERVAL ===\r\n      0\r\n    );\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport class TodoListReminderSource implements NotificationSource {\r\n  private readonly workspaceSessionDir: string;\r\n  private toolCallsSinceLastTodoWrite = 0;\r\n\r\n  constructor(args: { workspaceSessionDir: string }) {\r\n    assert(typeof args.workspaceSessionDir === \"string\", \"workspaceSessionDir must be a string\");\r\n    this.workspaceSessionDir = args.workspaceSessionDir;\r\n  }\r\n\r\n  async poll(ctx: NotificationPollContext): Promise<AgentNotification[]> {\r\n    assert(typeof ctx.toolName === \"string\", \"toolName must be a string\");\r\n\r\n    if (ctx.toolName === \"todo_write\") {\r\n      if (ctx.toolSucceeded) {\r\n        this.toolCallsSinceLastTodoWrite = 0;\r\n      }\r\n      return [];\r\n    }\r\n\r\n    this.toolCallsSinceLastTodoWrite += 1;\r\n\r\n    if (!isReminderDue(this.toolCallsSinceLastTodoWrite)) {\r\n      return [];\r\n    }\r\n\r\n    const todos = await readTodosForSessionDir(this.workspaceSessionDir);\r\n    if (todos.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    if (todos.every((t) => t.status === \"completed\")) {\r\n      return [];\r\n    }\r\n\r\n    const renderedTodos = renderTodoItemsAsMarkdownList(todos);\r\n    const content = `<notification>\\nIt's been ${this.toolCallsSinceLastTodoWrite} tool calls since you last updated the TODO list. If your progress changed, update it now using todo_write.\\n\\nCurrent TODO List:\\n${renderedTodos || \"- (empty)\"}\\n</notification>`;\r\n\r\n    return [\r\n      {\r\n        source: \"todo_list_reminder\",\r\n        content,\r\n      },\r\n    ];\r\n  }\r\n}\r\n"]}