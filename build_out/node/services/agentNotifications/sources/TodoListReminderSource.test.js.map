{"version":3,"file":"TodoListReminderSource.test.js","sourceRoot":"","sources":["../../../../../src/node/services/agentNotifications/sources/TodoListReminderSource.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { afterEach, beforeEach, describe, expect, test } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\nimport { setTodosForSessionDir } from \"@/node/services/tools/todo\";\n\nimport { TodoListReminderSource } from \"./TodoListReminderSource\";\n\ndescribe(\"TodoListReminderSource\", () => {\n  const workspaceId = \"ws-test\";\n  let workspaceSessionDir: string;\n\n  beforeEach(async () => {\n    workspaceSessionDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-todos-\"));\n    await setTodosForSessionDir(workspaceId, workspaceSessionDir, [\n      { content: \"Completed\", status: \"completed\" },\n      { content: \"In progress\", status: \"in_progress\" },\n      { content: \"Pending\", status: \"pending\" },\n    ]);\n  });\n\n  afterEach(async () => {\n    await fs.rm(workspaceSessionDir, { recursive: true, force: true });\n  });\n\n  test(\"reminds after 5 tool calls, then every 10\", async () => {\n    const source = new TodoListReminderSource({ workspaceSessionDir });\n\n    for (let i = 0; i < 4; i += 1) {\n      const notifications = await source.poll({ toolName: \"bash\", toolSucceeded: true, now: i });\n      expect(notifications).toEqual([]);\n    }\n\n    const fifth = await source.poll({ toolName: \"bash\", toolSucceeded: true, now: 4 });\n    expect(fifth.length).toBe(1);\n    expect(fifth[0].content).toContain(\"5 tool calls\");\n    expect(fifth[0].content).toContain(\"- [>] In progress\");\n\n    for (let i = 0; i < 9; i += 1) {\n      const notifications = await source.poll({\n        toolName: \"bash\",\n        toolSucceeded: true,\n        now: 5 + i,\n      });\n      expect(notifications).toEqual([]);\n    }\n\n    const fifteenth = await source.poll({ toolName: \"bash\", toolSucceeded: true, now: 14 });\n    expect(fifteenth.length).toBe(1);\n    expect(fifteenth[0].content).toContain(\"15 tool calls\");\n  });\n\n  test(\"resets after successful todo_write\", async () => {\n    const source = new TodoListReminderSource({ workspaceSessionDir });\n\n    for (let i = 0; i < 4; i += 1) {\n      await source.poll({ toolName: \"bash\", toolSucceeded: true, now: i });\n    }\n\n    const write = await source.poll({ toolName: \"todo_write\", toolSucceeded: true, now: 100 });\n    expect(write).toEqual([]);\n\n    for (let i = 0; i < 4; i += 1) {\n      const notifications = await source.poll({\n        toolName: \"bash\",\n        toolSucceeded: true,\n        now: 200 + i,\n      });\n      expect(notifications).toEqual([]);\n    }\n\n    const fifthAfterReset = await source.poll({ toolName: \"bash\", toolSucceeded: true, now: 205 });\n    expect(fifthAfterReset.length).toBe(1);\n    expect(fifthAfterReset[0].content).toContain(\"5 tool calls\");\n  });\n\n  test(\"suppresses reminder when todo list is empty\", async () => {\n    const emptyDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-todos-empty-\"));\n    const source = new TodoListReminderSource({ workspaceSessionDir: emptyDir });\n\n    try {\n      for (let i = 0; i < 5; i += 1) {\n        const notifications = await source.poll({ toolName: \"bash\", toolSucceeded: true, now: i });\n        expect(notifications).toEqual([]);\n      }\n    } finally {\n      await fs.rm(emptyDir, { recursive: true, force: true });\n    }\n  });\n\n  test(\"suppresses reminder when all todos are completed\", async () => {\n    await setTodosForSessionDir(workspaceId, workspaceSessionDir, [\n      { content: \"Done 1\", status: \"completed\" },\n      { content: \"Done 2\", status: \"completed\" },\n    ]);\n\n    const source = new TodoListReminderSource({ workspaceSessionDir });\n\n    for (let i = 0; i < 5; i += 1) {\n      const notifications = await source.poll({ toolName: \"bash\", toolSucceeded: true, now: i });\n      expect(notifications).toEqual([]);\n    }\n  });\n});\n"]}