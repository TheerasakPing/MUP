{"version":3,"file":"NotificationEngine.js","sourceRoot":"","sources":["../../../../src/node/services/agentNotifications/NotificationEngine.ts"],"names":[],"mappings":";;;;;;AAAA,mEAA2C;AAC3C,6CAA0C;AAiB1C;IACmB,OAAO,CAAuB;IAC9B,YAAY,GAAG,IAAI,GAAG,EAAU,CAAC;IAElD,YAAY,OAA6B,EAAE;QACzC,IAAA,gBAAM,EAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,0BAA0B,CAAC,CAAC;QAC3D,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IAAA,CACxB;IAED,KAAK,CAAC,iBAAiB,CAAC,GAA4B,EAAqB;QACvE,MAAM,OAAO,GAAa,EAAE,CAAC;QAE7B,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YAClC,IAAI,CAAC;gBACH,MAAM,aAAa,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBAC7C,KAAK,MAAM,YAAY,IAAI,aAAa,EAAE,CAAC;oBACzC,IAAI,CAAC,YAAY,EAAE,OAAO;wBAAE,SAAS;oBACrC,IAAI,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC;wBAAE,SAAS;oBAC1D,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;oBAC5C,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;gBACrC,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,MAAM,QAAQ,GAAI,MAA+C,CAAC,WAAW,EAAE,IAAI,CAAC;gBACpF,MAAM,UAAU,GAAG,OAAO,QAAQ,KAAK,QAAQ,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,SAAS,CAAC;gBAEvE,SAAG,CAAC,KAAK,CAAC,kCAAkC,EAAE;oBAC5C,KAAK;oBACL,MAAM,EAAE,UAAU;iBACnB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,OAAO,OAAO,CAAC;IAAA,CAChB;CACF","sourcesContent":["import assert from \"@/common/utils/assert\";\nimport { log } from \"@/node/services/log\";\n\nexport interface AgentNotification {\n  source: string;\n  content: string;\n}\n\nexport interface NotificationPollContext {\n  toolName: string;\n  toolSucceeded: boolean;\n  now: number;\n}\n\nexport interface NotificationSource {\n  poll(ctx: NotificationPollContext): Promise<AgentNotification[]>;\n}\n\nexport class NotificationEngine {\n  private readonly sources: NotificationSource[];\n  private readonly seenContents = new Set<string>();\n\n  constructor(sources: NotificationSource[]) {\n    assert(Array.isArray(sources), \"sources must be an array\");\n    this.sources = sources;\n  }\n\n  async pollAfterToolCall(ctx: NotificationPollContext): Promise<string[]> {\n    const results: string[] = [];\n\n    for (const source of this.sources) {\n      try {\n        const notifications = await source.poll(ctx);\n        for (const notification of notifications) {\n          if (!notification?.content) continue;\n          if (this.seenContents.has(notification.content)) continue;\n          this.seenContents.add(notification.content);\n          results.push(notification.content);\n        }\n      } catch (error) {\n        const ctorName = (source as { constructor?: { name?: unknown } }).constructor?.name;\n        const sourceName = typeof ctorName === \"string\" ? ctorName : \"unknown\";\n\n        log.debug(\"[NotificationEngine] poll failed\", {\n          error,\n          source: sourceName,\n        });\n      }\n    }\n\n    return results;\n  }\n}\n"]}