{"version":3,"file":"NotificationEngine.js","sourceRoot":"","sources":["../../../../src/node/services/agentNotifications/NotificationEngine.ts"],"names":[],"mappings":";;;;;;AAAA,mEAA2C;AAC3C,6CAA0C;AAiB1C;IACmB,OAAO,CAAuB;IAC9B,YAAY,GAAG,IAAI,GAAG,EAAU,CAAC;IAElD,YAAY,OAA6B,EAAE;QACzC,IAAA,gBAAM,EAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,0BAA0B,CAAC,CAAC;QAC3D,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IAAA,CACxB;IAED,KAAK,CAAC,iBAAiB,CAAC,GAA4B,EAAqB;QACvE,MAAM,OAAO,GAAa,EAAE,CAAC;QAE7B,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YAClC,IAAI,CAAC;gBACH,MAAM,aAAa,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBAC7C,KAAK,MAAM,YAAY,IAAI,aAAa,EAAE,CAAC;oBACzC,IAAI,CAAC,YAAY,EAAE,OAAO;wBAAE,SAAS;oBACrC,IAAI,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC;wBAAE,SAAS;oBAC1D,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;oBAC5C,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;gBACrC,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,MAAM,QAAQ,GAAI,MAA+C,CAAC,WAAW,EAAE,IAAI,CAAC;gBACpF,MAAM,UAAU,GAAG,OAAO,QAAQ,KAAK,QAAQ,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,SAAS,CAAC;gBAEvE,SAAG,CAAC,KAAK,CAAC,kCAAkC,EAAE;oBAC5C,KAAK;oBACL,MAAM,EAAE,UAAU;iBACnB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,OAAO,OAAO,CAAC;IAAA,CAChB;CACF","sourcesContent":["import assert from \"@/common/utils/assert\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\nexport interface AgentNotification {\r\n  source: string;\r\n  content: string;\r\n}\r\n\r\nexport interface NotificationPollContext {\r\n  toolName: string;\r\n  toolSucceeded: boolean;\r\n  now: number;\r\n}\r\n\r\nexport interface NotificationSource {\r\n  poll(ctx: NotificationPollContext): Promise<AgentNotification[]>;\r\n}\r\n\r\nexport class NotificationEngine {\r\n  private readonly sources: NotificationSource[];\r\n  private readonly seenContents = new Set<string>();\r\n\r\n  constructor(sources: NotificationSource[]) {\r\n    assert(Array.isArray(sources), \"sources must be an array\");\r\n    this.sources = sources;\r\n  }\r\n\r\n  async pollAfterToolCall(ctx: NotificationPollContext): Promise<string[]> {\r\n    const results: string[] = [];\r\n\r\n    for (const source of this.sources) {\r\n      try {\r\n        const notifications = await source.poll(ctx);\r\n        for (const notification of notifications) {\r\n          if (!notification?.content) continue;\r\n          if (this.seenContents.has(notification.content)) continue;\r\n          this.seenContents.add(notification.content);\r\n          results.push(notification.content);\r\n        }\r\n      } catch (error) {\r\n        const ctorName = (source as { constructor?: { name?: unknown } }).constructor?.name;\r\n        const sourceName = typeof ctorName === \"string\" ? ctorName : \"unknown\";\r\n\r\n        log.debug(\"[NotificationEngine] poll failed\", {\r\n          error,\r\n          source: sourceName,\r\n        });\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n}\r\n"]}