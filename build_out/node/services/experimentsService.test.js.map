{"version":3,"file":"experimentsService.test.js","sourceRoot":"","sources":["../../../src/node/services/experimentsService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, beforeEach, afterEach, mock } from \"bun:test\";\r\nimport { ExperimentsService } from \"./experimentsService\";\r\nimport { EXPERIMENT_IDS } from \"@/common/constants/experiments\";\r\nimport type { TelemetryService } from \"./telemetryService\";\r\nimport type { PostHog } from \"posthog-node\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\n\r\ndescribe(\"ExperimentsService\", () => {\r\n  let tempDir: string;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-experiments-test-\"));\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  test(\"loads cached experiment values from disk and exposes them\", async () => {\r\n    const cacheFilePath = path.join(tempDir, \"feature_flags.json\");\r\n    await fs.writeFile(\r\n      cacheFilePath,\r\n      JSON.stringify(\r\n        {\r\n          version: 1,\r\n          experiments: {\r\n            [EXPERIMENT_IDS.SYSTEM_1]: {\r\n              value: \"test\",\r\n              fetchedAtMs: Date.now(),\r\n            },\r\n          },\r\n        },\r\n        null,\r\n        2\r\n      ),\r\n      \"utf-8\"\r\n    );\r\n\r\n    const setFeatureFlagVariant = mock(() => undefined);\r\n    const fakePostHog = {\r\n      getFeatureFlag: mock(() => Promise.resolve(\"test\")),\r\n    } as unknown as PostHog;\r\n\r\n    const telemetryService = {\r\n      getPostHogClient: mock(() => fakePostHog),\r\n      getDistinctId: mock(() => \"distinct-id\"),\r\n      setFeatureFlagVariant,\r\n    } as unknown as TelemetryService;\r\n\r\n    const service = new ExperimentsService({\r\n      telemetryService,\r\n      muxHome: tempDir,\r\n      cacheTtlMs: 60 * 60 * 1000,\r\n    });\r\n\r\n    await service.initialize();\r\n\r\n    const values = service.getAll();\r\n    expect(values[EXPERIMENT_IDS.SYSTEM_1]).toEqual({\r\n      value: \"test\",\r\n      source: \"cache\",\r\n    });\r\n\r\n    expect(setFeatureFlagVariant).toHaveBeenCalledWith(EXPERIMENT_IDS.SYSTEM_1, \"test\");\r\n  });\r\n\r\n  test(\"refreshExperiment updates cache and writes it to disk\", async () => {\r\n    const setFeatureFlagVariant = mock(() => undefined);\r\n    const fakePostHog = {\r\n      getFeatureFlag: mock(() => Promise.resolve(\"test\")),\r\n    } as unknown as PostHog;\r\n\r\n    const telemetryService = {\r\n      getPostHogClient: mock(() => fakePostHog),\r\n      getDistinctId: mock(() => \"distinct-id\"),\r\n      setFeatureFlagVariant,\r\n    } as unknown as TelemetryService;\r\n\r\n    const service = new ExperimentsService({\r\n      telemetryService,\r\n      muxHome: tempDir,\r\n      cacheTtlMs: 0,\r\n    });\r\n\r\n    await service.initialize();\r\n    await service.refreshExperiment(EXPERIMENT_IDS.SYSTEM_1);\r\n\r\n    const value = service.getExperimentValue(EXPERIMENT_IDS.SYSTEM_1);\r\n    expect(value.value).toBe(\"test\");\r\n    expect(value.source).toBe(\"posthog\");\r\n\r\n    const cacheFilePath = path.join(tempDir, \"feature_flags.json\");\r\n    const disk = JSON.parse(await fs.readFile(cacheFilePath, \"utf-8\")) as unknown;\r\n    expect(typeof disk).toBe(\"object\");\r\n\r\n    expect((disk as { version: unknown }).version).toBe(1);\r\n    expect((disk as { experiments: Record<string, unknown> }).experiments).toHaveProperty(\r\n      EXPERIMENT_IDS.SYSTEM_1\r\n    );\r\n\r\n    expect(setFeatureFlagVariant).toHaveBeenCalledWith(EXPERIMENT_IDS.SYSTEM_1, \"test\");\r\n  });\r\n\r\n  test(\"returns disabled when telemetry is disabled\", async () => {\r\n    const telemetryService = {\r\n      getPostHogClient: mock(() => null),\r\n      getDistinctId: mock(() => null),\r\n      setFeatureFlagVariant: mock(() => undefined),\r\n    } as unknown as TelemetryService;\r\n\r\n    const service = new ExperimentsService({ telemetryService, muxHome: tempDir });\r\n    await service.initialize();\r\n\r\n    const values = service.getAll();\r\n    expect(values[EXPERIMENT_IDS.SYSTEM_1]).toEqual({\r\n      value: null,\r\n      source: \"disabled\",\r\n    });\r\n\r\n    expect(service.isExperimentEnabled(EXPERIMENT_IDS.SYSTEM_1)).toBe(false);\r\n  });\r\n});\r\n"]}