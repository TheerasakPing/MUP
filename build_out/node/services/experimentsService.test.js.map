{"version":3,"file":"experimentsService.test.js","sourceRoot":"","sources":["../../../src/node/services/experimentsService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, beforeEach, afterEach, mock } from \"bun:test\";\nimport { ExperimentsService } from \"./experimentsService\";\nimport { EXPERIMENT_IDS } from \"@/common/constants/experiments\";\nimport type { TelemetryService } from \"./telemetryService\";\nimport type { PostHog } from \"posthog-node\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\ndescribe(\"ExperimentsService\", () => {\n  let tempDir: string;\n\n  beforeEach(async () => {\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-experiments-test-\"));\n  });\n\n  afterEach(async () => {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  });\n\n  test(\"loads cached experiment values from disk and exposes them\", async () => {\n    const cacheFilePath = path.join(tempDir, \"feature_flags.json\");\n    await fs.writeFile(\n      cacheFilePath,\n      JSON.stringify(\n        {\n          version: 1,\n          experiments: {\n            [EXPERIMENT_IDS.SYSTEM_1]: {\n              value: \"test\",\n              fetchedAtMs: Date.now(),\n            },\n          },\n        },\n        null,\n        2\n      ),\n      \"utf-8\"\n    );\n\n    const setFeatureFlagVariant = mock(() => undefined);\n    const fakePostHog = {\n      getFeatureFlag: mock(() => Promise.resolve(\"test\")),\n    } as unknown as PostHog;\n\n    const telemetryService = {\n      getPostHogClient: mock(() => fakePostHog),\n      getDistinctId: mock(() => \"distinct-id\"),\n      setFeatureFlagVariant,\n    } as unknown as TelemetryService;\n\n    const service = new ExperimentsService({\n      telemetryService,\n      muxHome: tempDir,\n      cacheTtlMs: 60 * 60 * 1000,\n    });\n\n    await service.initialize();\n\n    const values = service.getAll();\n    expect(values[EXPERIMENT_IDS.SYSTEM_1]).toEqual({\n      value: \"test\",\n      source: \"cache\",\n    });\n\n    expect(setFeatureFlagVariant).toHaveBeenCalledWith(EXPERIMENT_IDS.SYSTEM_1, \"test\");\n  });\n\n  test(\"refreshExperiment updates cache and writes it to disk\", async () => {\n    const setFeatureFlagVariant = mock(() => undefined);\n    const fakePostHog = {\n      getFeatureFlag: mock(() => Promise.resolve(\"test\")),\n    } as unknown as PostHog;\n\n    const telemetryService = {\n      getPostHogClient: mock(() => fakePostHog),\n      getDistinctId: mock(() => \"distinct-id\"),\n      setFeatureFlagVariant,\n    } as unknown as TelemetryService;\n\n    const service = new ExperimentsService({\n      telemetryService,\n      muxHome: tempDir,\n      cacheTtlMs: 0,\n    });\n\n    await service.initialize();\n    await service.refreshExperiment(EXPERIMENT_IDS.SYSTEM_1);\n\n    const value = service.getExperimentValue(EXPERIMENT_IDS.SYSTEM_1);\n    expect(value.value).toBe(\"test\");\n    expect(value.source).toBe(\"posthog\");\n\n    const cacheFilePath = path.join(tempDir, \"feature_flags.json\");\n    const disk = JSON.parse(await fs.readFile(cacheFilePath, \"utf-8\")) as unknown;\n    expect(typeof disk).toBe(\"object\");\n\n    expect((disk as { version: unknown }).version).toBe(1);\n    expect((disk as { experiments: Record<string, unknown> }).experiments).toHaveProperty(\n      EXPERIMENT_IDS.SYSTEM_1\n    );\n\n    expect(setFeatureFlagVariant).toHaveBeenCalledWith(EXPERIMENT_IDS.SYSTEM_1, \"test\");\n  });\n\n  test(\"returns disabled when telemetry is disabled\", async () => {\n    const telemetryService = {\n      getPostHogClient: mock(() => null),\n      getDistinctId: mock(() => null),\n      setFeatureFlagVariant: mock(() => undefined),\n    } as unknown as TelemetryService;\n\n    const service = new ExperimentsService({ telemetryService, muxHome: tempDir });\n    await service.initialize();\n\n    const values = service.getAll();\n    expect(values[EXPERIMENT_IDS.SYSTEM_1]).toEqual({\n      value: null,\n      source: \"disabled\",\n    });\n\n    expect(service.isExperimentEnabled(EXPERIMENT_IDS.SYSTEM_1)).toBe(false);\n  });\n});\n"]}