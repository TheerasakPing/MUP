{"version":3,"file":"providerService.js","sourceRoot":"","sources":["../../../src/node/services/providerService.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from \"events\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { SUPPORTED_PROVIDERS, type ProviderName } from \"@/common/constants/providers\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport type {\r\n  AWSCredentialStatus,\r\n  ProviderConfigInfo,\r\n  CustomModelMetadata,\r\n  ProvidersConfigMap,\r\n} from \"@/common/orpc/types\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { checkProviderConfigured } from \"@/node/utils/providerRequirements\";\r\nimport { parseCodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\r\nimport type { PolicyService } from \"@/node/services/policyService\";\r\n\r\n// Re-export types for backward compatibility\r\nexport type { AWSCredentialStatus, ProviderConfigInfo, ProvidersConfigMap };\r\n\r\nexport class ProviderService {\r\n  private readonly policyService: PolicyService | null;\r\n  private readonly emitter = new EventEmitter();\r\n\r\n  constructor(\r\n    private readonly config: Config,\r\n    policyService?: PolicyService\r\n  ) {\r\n    this.policyService = policyService ?? null;\r\n    // The provider config subscription may have many concurrent listeners (e.g. multiple windows).\r\n    // Avoid noisy MaxListenersExceededWarning for normal usage.\r\n    this.emitter.setMaxListeners(50);\r\n  }\r\n\r\n  /**\r\n   * Subscribe to config change events. Used by oRPC subscription handler.\r\n   * Returns a cleanup function.\r\n   */\r\n  onConfigChanged(callback: () => void): () => void {\r\n    this.emitter.on(\"configChanged\", callback);\r\n    return () => this.emitter.off(\"configChanged\", callback);\r\n  }\r\n\r\n  private emitConfigChanged(): void {\r\n    this.emitter.emit(\"configChanged\");\r\n  }\r\n\r\n  public list(): ProviderName[] {\r\n    try {\r\n      const providers = [...SUPPORTED_PROVIDERS];\r\n\r\n      if (this.policyService?.isEnforced()) {\r\n        return providers.filter((p) => this.policyService!.isProviderAllowed(p));\r\n      }\r\n\r\n      return providers;\r\n    } catch (error) {\r\n      log.error(\"Failed to list providers:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the full providers config with safe info (no actual API keys)\r\n   */\r\n  public getConfig(): ProvidersConfigMap {\r\n    const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n    const result: ProvidersConfigMap = {};\r\n\r\n    for (const provider of this.list()) {\r\n      const config = (providersConfig[provider] ?? {}) as {\r\n        apiKey?: string;\r\n        baseUrl?: string;\r\n        models?: string[];\r\n        serviceTier?: unknown;\r\n        /** OpenAI-only: default auth precedence for Codex-OAuth-allowed models. */\r\n        codexOauthDefaultAuth?: unknown;\r\n        region?: string;\r\n        /** Optional AWS shared config profile name (equivalent to AWS_PROFILE). */\r\n        profile?: string;\r\n        bearerToken?: string;\r\n        accessKeyId?: string;\r\n        secretAccessKey?: string;\r\n        /** OpenAI-only: stored Codex OAuth tokens (never sent to frontend). */\r\n        codexOauth?: unknown;\r\n      };\r\n\r\n      const forcedBaseUrl = this.policyService?.isEnforced()\r\n        ? this.policyService.getForcedBaseUrl(provider)\r\n        : undefined;\r\n\r\n      const allowedModels = this.policyService?.isEnforced()\r\n        ? (this.policyService.getEffectivePolicy()?.providerAccess?.find((p) => p.id === provider)\r\n            ?.allowedModels ?? null)\r\n        : null;\r\n\r\n      const filteredModels =\r\n        Array.isArray(allowedModels) && config.models\r\n          ? config.models.filter((m) => allowedModels.includes(m))\r\n          : config.models;\r\n\r\n      const codexOauthSet =\r\n        provider === \"openai\" && parseCodexOauthAuth(config.codexOauth) !== null;\r\n\r\n      const providerInfo: ProviderConfigInfo = {\r\n        apiKeySet: !!config.apiKey,\r\n        isConfigured: false, // computed below\r\n        baseUrl: forcedBaseUrl ?? config.baseUrl,\r\n        models: filteredModels,\r\n      };\r\n\r\n      // OpenAI-specific fields\r\n      const serviceTier = config.serviceTier;\r\n      if (\r\n        provider === \"openai\" &&\r\n        (serviceTier === \"auto\" ||\r\n          serviceTier === \"default\" ||\r\n          serviceTier === \"flex\" ||\r\n          serviceTier === \"priority\")\r\n      ) {\r\n        providerInfo.serviceTier = serviceTier;\r\n      }\r\n\r\n      if (provider === \"openai\") {\r\n        providerInfo.codexOauthSet = codexOauthSet;\r\n\r\n        const codexOauthDefaultAuth = config.codexOauthDefaultAuth;\r\n        if (codexOauthDefaultAuth === \"oauth\" || codexOauthDefaultAuth === \"apiKey\") {\r\n          providerInfo.codexOauthDefaultAuth = codexOauthDefaultAuth;\r\n        }\r\n      }\r\n      // AWS/Bedrock-specific fields\r\n      if (provider === \"bedrock\") {\r\n        providerInfo.aws = {\r\n          region: config.region,\r\n          profile: config.profile,\r\n          bearerTokenSet: !!config.bearerToken,\r\n          accessKeyIdSet: !!config.accessKeyId,\r\n          secretAccessKeySet: !!config.secretAccessKey,\r\n        };\r\n      }\r\n\r\n      // Mux Gateway-specific fields (check couponCode first, fallback to legacy voucher)\r\n      if (provider === \"mux-gateway\") {\r\n        const muxConfig = config as { couponCode?: string; voucher?: string };\r\n        providerInfo.couponCodeSet = !!(muxConfig.couponCode ?? muxConfig.voucher);\r\n      }\r\n\r\n      // Compute isConfigured using shared utility (checks config + env vars)\r\n      providerInfo.isConfigured = checkProviderConfigured(provider, config).isConfigured;\r\n\r\n      if (provider === \"openai\" && codexOauthSet) {\r\n        providerInfo.isConfigured = true;\r\n      }\r\n\r\n      result[provider] = providerInfo;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Set custom models for a provider\r\n   */\r\n  public setModels(provider: string, models: string[]): Result<void, string> {\r\n    try {\r\n      if (this.policyService?.isEnforced()) {\r\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\r\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\r\n        }\r\n\r\n        const allowedModels =\r\n          this.policyService\r\n            .getEffectivePolicy()\r\n            ?.providerAccess?.find((p) => p.id === (provider as ProviderName))?.allowedModels ??\r\n          null;\r\n\r\n        if (Array.isArray(allowedModels)) {\r\n          const disallowed = models.filter((m) => !allowedModels.includes(m));\r\n          if (disallowed.length > 0) {\r\n            return {\r\n              success: false,\r\n              error: `One or more models are not allowed by policy: ${disallowed.join(\", \")}`,\r\n            };\r\n          }\r\n        }\r\n      }\r\n\r\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n\r\n      if (!providersConfig[provider]) {\r\n        providersConfig[provider] = {};\r\n      }\r\n\r\n      providersConfig[provider].models = models;\r\n      this.config.saveProvidersConfig(providersConfig);\r\n      this.emitConfigChanged();\r\n\r\n      return { success: true, data: undefined };\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return { success: false, error: `Failed to set models: ${message}` };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set custom metadata for a specific model\r\n   */\r\n  public setModelMetadata(\r\n    provider: string,\r\n    modelId: string,\r\n    metadata: CustomModelMetadata\r\n  ): Result<void, string> {\r\n    try {\r\n      if (this.policyService?.isEnforced()) {\r\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\r\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\r\n        }\r\n      }\r\n\r\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n\r\n      if (!providersConfig[provider]) {\r\n        providersConfig[provider] = {};\r\n      }\r\n\r\n      const providerConfig = providersConfig[provider] as Record<string, any>;\r\n      if (!providerConfig.modelMetadata) {\r\n        providerConfig.modelMetadata = {};\r\n      }\r\n\r\n      providerConfig.modelMetadata[modelId] = metadata;\r\n\r\n      this.config.saveProvidersConfig(providersConfig);\r\n      this.emitConfigChanged();\r\n\r\n      return { success: true, data: undefined };\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return { success: false, error: `Failed to set model metadata: ${message}` };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set provider config values that aren't representable as strings.\r\n   *\r\n   * Intended for persisted auth blobs (e.g. Codex OAuth tokens) that should never\r\n   * cross the frontend boundary.\r\n   */\r\n  public setConfigValue(provider: string, keyPath: string[], value: unknown): Result<void, string> {\r\n    try {\r\n      // Load current providers config or create empty\r\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n\r\n      if (this.policyService?.isEnforced()) {\r\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\r\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\r\n        }\r\n\r\n        const forcedBaseUrl = this.policyService.getForcedBaseUrl(provider as ProviderName);\r\n        const isBaseUrlEdit = keyPath.length === 1 && keyPath[0] === \"baseUrl\";\r\n        if (isBaseUrlEdit && forcedBaseUrl) {\r\n          return { success: false, error: `Provider ${provider} base URL is locked by policy` };\r\n        }\r\n      }\r\n\r\n      // Ensure provider exists\r\n      if (!providersConfig[provider]) {\r\n        providersConfig[provider] = {};\r\n      }\r\n\r\n      // Set nested property value\r\n      let current = providersConfig[provider] as Record<string, unknown>;\r\n      for (let i = 0; i < keyPath.length - 1; i++) {\r\n        const key = keyPath[i];\r\n        if (!(key in current) || typeof current[key] !== \"object\" || current[key] === null) {\r\n          current[key] = {};\r\n        }\r\n        current = current[key] as Record<string, unknown>;\r\n      }\r\n\r\n      if (keyPath.length > 0) {\r\n        const lastKey = keyPath[keyPath.length - 1];\r\n        if (value === undefined) {\r\n          delete current[lastKey];\r\n        } else {\r\n          current[lastKey] = value;\r\n        }\r\n      }\r\n\r\n      // Save updated config\r\n      this.config.saveProvidersConfig(providersConfig);\r\n      this.emitConfigChanged();\r\n\r\n      return { success: true, data: undefined };\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return { success: false, error: `Failed to set provider config: ${message}` };\r\n    }\r\n  }\r\n\r\n  public setConfig(provider: string, keyPath: string[], value: string): Result<void, string> {\r\n    try {\r\n      // Load current providers config or create empty\r\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n\r\n      if (this.policyService?.isEnforced()) {\r\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\r\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\r\n        }\r\n\r\n        const forcedBaseUrl = this.policyService.getForcedBaseUrl(provider as ProviderName);\r\n        const isBaseUrlEdit = keyPath.length === 1 && keyPath[0] === \"baseUrl\";\r\n        if (isBaseUrlEdit && forcedBaseUrl) {\r\n          return { success: false, error: `Provider ${provider} base URL is locked by policy` };\r\n        }\r\n      }\r\n\r\n      // Track if this is first time setting couponCode for mux-gateway\r\n      const isFirstMuxGatewayCoupon =\r\n        provider === \"mux-gateway\" &&\r\n        keyPath.length === 1 &&\r\n        keyPath[0] === \"couponCode\" &&\r\n        value !== \"\" &&\r\n        !providersConfig[provider]?.couponCode;\r\n\r\n      // Ensure provider exists\r\n      if (!providersConfig[provider]) {\r\n        providersConfig[provider] = {};\r\n      }\r\n\r\n      // Set nested property value\r\n      let current = providersConfig[provider] as Record<string, unknown>;\r\n      for (let i = 0; i < keyPath.length - 1; i++) {\r\n        const key = keyPath[i];\r\n        if (!(key in current) || typeof current[key] !== \"object\" || current[key] === null) {\r\n          current[key] = {};\r\n        }\r\n        current = current[key] as Record<string, unknown>;\r\n      }\r\n\r\n      if (keyPath.length > 0) {\r\n        const lastKey = keyPath[keyPath.length - 1];\r\n        // Delete key if value is empty string (used for clearing API keys), otherwise set it\r\n        if (value === \"\") {\r\n          delete current[lastKey];\r\n        } else {\r\n          current[lastKey] = value;\r\n        }\r\n      }\r\n\r\n      // Add default models when setting up mux-gateway for the first time\r\n      if (isFirstMuxGatewayCoupon) {\r\n        const providerConfig = providersConfig[provider] as Record<string, unknown>;\r\n        if (!providerConfig.models || (providerConfig.models as string[]).length === 0) {\r\n          providerConfig.models = [\r\n            \"anthropic/claude-sonnet-4-5\",\r\n            \"anthropic/claude-opus-4-5\",\r\n            \"openai/gpt-5.2\",\r\n            \"openai/gpt-5.1-codex\",\r\n          ];\r\n        }\r\n      }\r\n\r\n      // Save updated config\r\n      this.config.saveProvidersConfig(providersConfig);\r\n      this.emitConfigChanged();\r\n\r\n      return { success: true, data: undefined };\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return { success: false, error: `Failed to set provider config: ${message}` };\r\n    }\r\n  }\r\n}\r\n"]}