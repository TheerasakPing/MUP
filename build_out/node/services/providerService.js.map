{"version":3,"file":"providerService.js","sourceRoot":"","sources":["../../../src/node/services/providerService.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from \"events\";\nimport type { Config } from \"@/node/config\";\nimport { SUPPORTED_PROVIDERS, type ProviderName } from \"@/common/constants/providers\";\nimport type { Result } from \"@/common/types/result\";\nimport type {\n  AWSCredentialStatus,\n  ProviderConfigInfo,\n  CustomModelMetadata,\n  ProvidersConfigMap,\n} from \"@/common/orpc/types\";\nimport { log } from \"@/node/services/log\";\nimport { checkProviderConfigured } from \"@/node/utils/providerRequirements\";\nimport { parseCodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\nimport type { PolicyService } from \"@/node/services/policyService\";\n\n// Re-export types for backward compatibility\nexport type { AWSCredentialStatus, ProviderConfigInfo, ProvidersConfigMap };\n\nexport class ProviderService {\n  private readonly policyService: PolicyService | null;\n  private readonly emitter = new EventEmitter();\n\n  constructor(\n    private readonly config: Config,\n    policyService?: PolicyService\n  ) {\n    this.policyService = policyService ?? null;\n    // The provider config subscription may have many concurrent listeners (e.g. multiple windows).\n    // Avoid noisy MaxListenersExceededWarning for normal usage.\n    this.emitter.setMaxListeners(50);\n  }\n\n  /**\n   * Subscribe to config change events. Used by oRPC subscription handler.\n   * Returns a cleanup function.\n   */\n  onConfigChanged(callback: () => void): () => void {\n    this.emitter.on(\"configChanged\", callback);\n    return () => this.emitter.off(\"configChanged\", callback);\n  }\n\n  private emitConfigChanged(): void {\n    this.emitter.emit(\"configChanged\");\n  }\n\n  public list(): ProviderName[] {\n    try {\n      const providers = [...SUPPORTED_PROVIDERS];\n\n      if (this.policyService?.isEnforced()) {\n        return providers.filter((p) => this.policyService!.isProviderAllowed(p));\n      }\n\n      return providers;\n    } catch (error) {\n      log.error(\"Failed to list providers:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get the full providers config with safe info (no actual API keys)\n   */\n  public getConfig(): ProvidersConfigMap {\n    const providersConfig = this.config.loadProvidersConfig() ?? {};\n    const result: ProvidersConfigMap = {};\n\n    for (const provider of this.list()) {\n      const config = (providersConfig[provider] ?? {}) as {\n        apiKey?: string;\n        baseUrl?: string;\n        models?: string[];\n        serviceTier?: unknown;\n        /** OpenAI-only: default auth precedence for Codex-OAuth-allowed models. */\n        codexOauthDefaultAuth?: unknown;\n        region?: string;\n        /** Optional AWS shared config profile name (equivalent to AWS_PROFILE). */\n        profile?: string;\n        bearerToken?: string;\n        accessKeyId?: string;\n        secretAccessKey?: string;\n        /** OpenAI-only: stored Codex OAuth tokens (never sent to frontend). */\n        codexOauth?: unknown;\n      };\n\n      const forcedBaseUrl = this.policyService?.isEnforced()\n        ? this.policyService.getForcedBaseUrl(provider)\n        : undefined;\n\n      const allowedModels = this.policyService?.isEnforced()\n        ? (this.policyService.getEffectivePolicy()?.providerAccess?.find((p) => p.id === provider)\n            ?.allowedModels ?? null)\n        : null;\n\n      const filteredModels =\n        Array.isArray(allowedModels) && config.models\n          ? config.models.filter((m) => allowedModels.includes(m))\n          : config.models;\n\n      const codexOauthSet =\n        provider === \"openai\" && parseCodexOauthAuth(config.codexOauth) !== null;\n\n      const providerInfo: ProviderConfigInfo = {\n        apiKeySet: !!config.apiKey,\n        isConfigured: false, // computed below\n        baseUrl: forcedBaseUrl ?? config.baseUrl,\n        models: filteredModels,\n      };\n\n      // OpenAI-specific fields\n      const serviceTier = config.serviceTier;\n      if (\n        provider === \"openai\" &&\n        (serviceTier === \"auto\" ||\n          serviceTier === \"default\" ||\n          serviceTier === \"flex\" ||\n          serviceTier === \"priority\")\n      ) {\n        providerInfo.serviceTier = serviceTier;\n      }\n\n      if (provider === \"openai\") {\n        providerInfo.codexOauthSet = codexOauthSet;\n\n        const codexOauthDefaultAuth = config.codexOauthDefaultAuth;\n        if (codexOauthDefaultAuth === \"oauth\" || codexOauthDefaultAuth === \"apiKey\") {\n          providerInfo.codexOauthDefaultAuth = codexOauthDefaultAuth;\n        }\n      }\n      // AWS/Bedrock-specific fields\n      if (provider === \"bedrock\") {\n        providerInfo.aws = {\n          region: config.region,\n          profile: config.profile,\n          bearerTokenSet: !!config.bearerToken,\n          accessKeyIdSet: !!config.accessKeyId,\n          secretAccessKeySet: !!config.secretAccessKey,\n        };\n      }\n\n      // Mux Gateway-specific fields (check couponCode first, fallback to legacy voucher)\n      if (provider === \"mux-gateway\") {\n        const muxConfig = config as { couponCode?: string; voucher?: string };\n        providerInfo.couponCodeSet = !!(muxConfig.couponCode ?? muxConfig.voucher);\n      }\n\n      // Compute isConfigured using shared utility (checks config + env vars)\n      providerInfo.isConfigured = checkProviderConfigured(provider, config).isConfigured;\n\n      if (provider === \"openai\" && codexOauthSet) {\n        providerInfo.isConfigured = true;\n      }\n\n      result[provider] = providerInfo;\n    }\n\n    return result;\n  }\n\n  /**\n   * Set custom models for a provider\n   */\n  public setModels(provider: string, models: string[]): Result<void, string> {\n    try {\n      if (this.policyService?.isEnforced()) {\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\n        }\n\n        const allowedModels =\n          this.policyService\n            .getEffectivePolicy()\n            ?.providerAccess?.find((p) => p.id === (provider as ProviderName))?.allowedModels ??\n          null;\n\n        if (Array.isArray(allowedModels)) {\n          const disallowed = models.filter((m) => !allowedModels.includes(m));\n          if (disallowed.length > 0) {\n            return {\n              success: false,\n              error: `One or more models are not allowed by policy: ${disallowed.join(\", \")}`,\n            };\n          }\n        }\n      }\n\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\n\n      if (!providersConfig[provider]) {\n        providersConfig[provider] = {};\n      }\n\n      providersConfig[provider].models = models;\n      this.config.saveProvidersConfig(providersConfig);\n      this.emitConfigChanged();\n\n      return { success: true, data: undefined };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return { success: false, error: `Failed to set models: ${message}` };\n    }\n  }\n\n  /**\n   * Set custom metadata for a specific model\n   */\n  public setModelMetadata(\n    provider: string,\n    modelId: string,\n    metadata: CustomModelMetadata\n  ): Result<void, string> {\n    try {\n      if (this.policyService?.isEnforced()) {\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\n        }\n      }\n\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\n\n      if (!providersConfig[provider]) {\n        providersConfig[provider] = {};\n      }\n\n      const providerConfig = providersConfig[provider] as Record<string, any>;\n      if (!providerConfig.modelMetadata) {\n        providerConfig.modelMetadata = {};\n      }\n\n      providerConfig.modelMetadata[modelId] = metadata;\n\n      this.config.saveProvidersConfig(providersConfig);\n      this.emitConfigChanged();\n\n      return { success: true, data: undefined };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return { success: false, error: `Failed to set model metadata: ${message}` };\n    }\n  }\n\n  /**\n   * Set provider config values that aren't representable as strings.\n   *\n   * Intended for persisted auth blobs (e.g. Codex OAuth tokens) that should never\n   * cross the frontend boundary.\n   */\n  public setConfigValue(provider: string, keyPath: string[], value: unknown): Result<void, string> {\n    try {\n      // Load current providers config or create empty\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\n\n      if (this.policyService?.isEnforced()) {\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\n        }\n\n        const forcedBaseUrl = this.policyService.getForcedBaseUrl(provider as ProviderName);\n        const isBaseUrlEdit = keyPath.length === 1 && keyPath[0] === \"baseUrl\";\n        if (isBaseUrlEdit && forcedBaseUrl) {\n          return { success: false, error: `Provider ${provider} base URL is locked by policy` };\n        }\n      }\n\n      // Ensure provider exists\n      if (!providersConfig[provider]) {\n        providersConfig[provider] = {};\n      }\n\n      // Set nested property value\n      let current = providersConfig[provider] as Record<string, unknown>;\n      for (let i = 0; i < keyPath.length - 1; i++) {\n        const key = keyPath[i];\n        if (!(key in current) || typeof current[key] !== \"object\" || current[key] === null) {\n          current[key] = {};\n        }\n        current = current[key] as Record<string, unknown>;\n      }\n\n      if (keyPath.length > 0) {\n        const lastKey = keyPath[keyPath.length - 1];\n        if (value === undefined) {\n          delete current[lastKey];\n        } else {\n          current[lastKey] = value;\n        }\n      }\n\n      // Save updated config\n      this.config.saveProvidersConfig(providersConfig);\n      this.emitConfigChanged();\n\n      return { success: true, data: undefined };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return { success: false, error: `Failed to set provider config: ${message}` };\n    }\n  }\n\n  public setConfig(provider: string, keyPath: string[], value: string): Result<void, string> {\n    try {\n      // Load current providers config or create empty\n      const providersConfig = this.config.loadProvidersConfig() ?? {};\n\n      if (this.policyService?.isEnforced()) {\n        if (!this.policyService.isProviderAllowed(provider as ProviderName)) {\n          return { success: false, error: `Provider ${provider} is not allowed by policy` };\n        }\n\n        const forcedBaseUrl = this.policyService.getForcedBaseUrl(provider as ProviderName);\n        const isBaseUrlEdit = keyPath.length === 1 && keyPath[0] === \"baseUrl\";\n        if (isBaseUrlEdit && forcedBaseUrl) {\n          return { success: false, error: `Provider ${provider} base URL is locked by policy` };\n        }\n      }\n\n      // Track if this is first time setting couponCode for mux-gateway\n      const isFirstMuxGatewayCoupon =\n        provider === \"mux-gateway\" &&\n        keyPath.length === 1 &&\n        keyPath[0] === \"couponCode\" &&\n        value !== \"\" &&\n        !providersConfig[provider]?.couponCode;\n\n      // Ensure provider exists\n      if (!providersConfig[provider]) {\n        providersConfig[provider] = {};\n      }\n\n      // Set nested property value\n      let current = providersConfig[provider] as Record<string, unknown>;\n      for (let i = 0; i < keyPath.length - 1; i++) {\n        const key = keyPath[i];\n        if (!(key in current) || typeof current[key] !== \"object\" || current[key] === null) {\n          current[key] = {};\n        }\n        current = current[key] as Record<string, unknown>;\n      }\n\n      if (keyPath.length > 0) {\n        const lastKey = keyPath[keyPath.length - 1];\n        // Delete key if value is empty string (used for clearing API keys), otherwise set it\n        if (value === \"\") {\n          delete current[lastKey];\n        } else {\n          current[lastKey] = value;\n        }\n      }\n\n      // Add default models when setting up mux-gateway for the first time\n      if (isFirstMuxGatewayCoupon) {\n        const providerConfig = providersConfig[provider] as Record<string, unknown>;\n        if (!providerConfig.models || (providerConfig.models as string[]).length === 0) {\n          providerConfig.models = [\n            \"anthropic/claude-sonnet-4-5\",\n            \"anthropic/claude-opus-4-5\",\n            \"openai/gpt-5.2\",\n            \"openai/gpt-5.1-codex\",\n          ];\n        }\n      }\n\n      // Save updated config\n      this.config.saveProvidersConfig(providersConfig);\n      this.emitConfigChanged();\n\n      return { success: true, data: undefined };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return { success: false, error: `Failed to set provider config: ${message}` };\n    }\n  }\n}\n"]}