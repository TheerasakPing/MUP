{"version":3,"file":"bashExecutionService.js","sourceRoot":"","sources":["../../../src/node/services/bashExecutionService.ts"],"names":[],"mappings":"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","sourcesContent":["import { spawn } from \"child_process\";\r\nimport type { ChildProcess } from \"child_process\";\r\nimport { log } from \"./log\";\r\nimport { getBashPath } from \"@/node/utils/main/bashPath\";\r\n\r\n/**\r\n * Configuration for bash execution\r\n */\r\nexport interface BashExecutionConfig {\r\n  /** Working directory for command execution */\r\n  cwd: string;\r\n  /** Environment secrets to inject (e.g., API keys) */\r\n  secrets?: Record<string, string>;\r\n  /** Whether to spawn as detached process group (default: true) */\r\n  detached?: boolean;\r\n}\r\n\r\n/**\r\n * Callbacks for streaming execution mode\r\n */\r\nexport interface StreamingCallbacks {\r\n  /** Called for each complete line from stdout */\r\n  onStdout: (line: string) => void;\r\n  /** Called for each complete line from stderr */\r\n  onStderr: (line: string) => void;\r\n  /** Called when process exits */\r\n  onExit: (exitCode: number) => void;\r\n}\r\n\r\n/**\r\n * Wraps a ChildProcess to make it disposable for use with `using` statements.\r\n * Always kills the entire process group with SIGKILL to prevent zombie processes.\r\n * SIGKILL cannot be caught or ignored, guaranteeing immediate cleanup.\r\n */\r\nexport class DisposableProcess implements Disposable {\r\n  private disposed = false;\r\n\r\n  constructor(private readonly process: ChildProcess) {}\r\n\r\n  [Symbol.dispose](): void {\r\n    // Prevent double-signalling if dispose is called multiple times\r\n    if (this.disposed || this.process.pid === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.disposed = true;\r\n\r\n    try {\r\n      // Kill entire process group with SIGKILL - cannot be caught/ignored\r\n      process.kill(-this.process.pid, \"SIGKILL\");\r\n    } catch {\r\n      // Fallback: try killing just the main process\r\n      try {\r\n        this.process.kill(\"SIGKILL\");\r\n      } catch {\r\n        // Process already dead - ignore\r\n      }\r\n    }\r\n  }\r\n\r\n  get child(): ChildProcess {\r\n    return this.process;\r\n  }\r\n}\r\n\r\n/**\r\n * Centralized bash execution service.\r\n *\r\n * All workspace command execution goes through this service to:\r\n * - Maintain consistent environment setup across all bash execution\r\n * - Provide single abstraction point for future host migration (containers, remote, etc.)\r\n * - Eliminate duplication between init hooks and bash tool\r\n *\r\n * Provides two execution modes:\r\n * - Streaming: Line-by-line output callbacks (for init hooks, real-time feedback)\r\n * - Buffered: Collect all output, return at end (for bash tool, LLM consumption)\r\n */\r\nexport class BashExecutionService {\r\n  /**\r\n   * Create standardized bash environment.\r\n   * Prevents interactive prompts that would block execution.\r\n   */\r\n  private createBashEnvironment(secrets?: Record<string, string>): NodeJS.ProcessEnv {\r\n    return {\r\n      ...process.env,\r\n      // Inject secrets as environment variables\r\n      ...(secrets ?? {}),\r\n      // Prevent interactive editors from blocking bash execution\r\n      // Critical for git operations like rebase/commit that try to open editors\r\n      GIT_EDITOR: \"true\", // Git-specific editor (highest priority)\r\n      GIT_SEQUENCE_EDITOR: \"true\", // For interactive rebase sequences\r\n      EDITOR: \"true\", // General fallback for non-git commands\r\n      VISUAL: \"true\", // Another common editor environment variable\r\n      // Prevent git from prompting for credentials\r\n      // Critical for operations like fetch/pull that might try to authenticate\r\n      // Without this, git can hang waiting for user input if credentials aren't configured\r\n      GIT_TERMINAL_PROMPT: \"0\", // Disables git credential prompts\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Execute bash command with streaming output.\r\n   *\r\n   * Output is emitted line-by-line through callbacks as it arrives.\r\n   * Used by init hooks for real-time progress feedback.\r\n   *\r\n   * @param script Bash script to execute\r\n   * @param config Execution configuration\r\n   * @param callbacks Output and exit callbacks\r\n   * @returns DisposableProcess that can be killed with `using` statement\r\n   */\r\n  executeStreaming(\r\n    script: string,\r\n    config: BashExecutionConfig,\r\n    callbacks: StreamingCallbacks\r\n  ): DisposableProcess {\r\n    log.debug(`BashExecutionService: Executing streaming command in ${config.cwd}`);\r\n    log.debug(\r\n      `BashExecutionService: Script: ${script.substring(0, 100)}${script.length > 100 ? \"...\" : \"\"}`\r\n    );\r\n\r\n    const bashPath = getBashPath();\r\n    const spawnCommand = bashPath;\r\n    const spawnArgs = [\"-c\", script];\r\n\r\n    const child = spawn(spawnCommand, spawnArgs, {\r\n      cwd: config.cwd,\r\n      env: this.createBashEnvironment(config.secrets),\r\n      stdio: [\"ignore\", \"pipe\", \"pipe\"],\r\n      // Spawn as detached process group leader to prevent zombie processes\r\n      // When bash spawns background processes, detached:true allows killing\r\n      // the entire group via process.kill(-pid)\r\n      detached: config.detached ?? true,\r\n      // Prevent console window from appearing on Windows (WSL bash spawns steal focus otherwise)\r\n      windowsHide: true,\r\n    });\r\n\r\n    log.debug(`BashExecutionService: Spawned process with PID ${child.pid ?? \"unknown\"}`);\r\n\r\n    // Line-by-line streaming with incremental buffers\r\n    let outBuf = \"\";\r\n    let errBuf = \"\";\r\n\r\n    const flushLines = (buf: string, isStderr: boolean): string => {\r\n      const lines = buf.split(/\\r?\\n/);\r\n      // Keep the last partial line in buffer; emit full lines\r\n      const partial = lines.pop() ?? \"\";\r\n      for (const line of lines) {\r\n        if (line.length === 0) continue;\r\n        if (isStderr) {\r\n          callbacks.onStderr(line);\r\n        } else {\r\n          callbacks.onStdout(line);\r\n        }\r\n      }\r\n      return partial;\r\n    };\r\n\r\n    child.stdout?.on(\"data\", (chunk: Buffer) => {\r\n      outBuf += chunk.toString(\"utf8\");\r\n      outBuf = flushLines(outBuf, false);\r\n    });\r\n\r\n    child.stderr?.on(\"data\", (chunk: Buffer) => {\r\n      errBuf += chunk.toString(\"utf8\");\r\n      errBuf = flushLines(errBuf, true);\r\n    });\r\n\r\n    child.on(\"close\", (code: number | null, signal: NodeJS.Signals | null) => {\r\n      log.debug(\r\n        `BashExecutionService: Process exited with code ${code ?? \"null\"}, signal ${signal ?? \"none\"}`\r\n      );\r\n      // Flush any remaining partial lines\r\n      if (outBuf.trim().length > 0) {\r\n        callbacks.onStdout(outBuf);\r\n      }\r\n      if (errBuf.trim().length > 0) {\r\n        callbacks.onStderr(errBuf);\r\n      }\r\n\r\n      // Convert signal to exit code using Unix convention (128 + signal number)\r\n      // Common signals: SIGTERM=15 → 143, SIGKILL=9 → 137\r\n      let exitCode = code ?? 0;\r\n      if (code === null && signal) {\r\n        const signalNumbers: Record<string, number> = {\r\n          SIGHUP: 1,\r\n          SIGINT: 2,\r\n          SIGQUIT: 3,\r\n          SIGABRT: 6,\r\n          SIGKILL: 9,\r\n          SIGTERM: 15,\r\n        };\r\n        exitCode = 128 + (signalNumbers[signal] ?? 1);\r\n      }\r\n      callbacks.onExit(exitCode);\r\n    });\r\n\r\n    child.on(\"error\", (error: Error) => {\r\n      log.error(`BashExecutionService: Process error:`, error);\r\n    });\r\n\r\n    return new DisposableProcess(child);\r\n  }\r\n}\r\n"]}