{"version":3,"file":"sessionTimingService.js","sourceRoot":"","sources":["../../../src/node/services/sessionTimingService.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport { EventEmitter } from \"events\";\nimport writeFileAtomic from \"write-file-atomic\";\nimport type { Config } from \"@/node/config\";\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\nimport { normalizeGatewayModel } from \"@/common/utils/ai/models\";\nimport type { AgentMode } from \"@/common/types/mode\";\nimport {\n  ActiveStreamStatsSchema,\n  CompletedStreamStatsSchema,\n  SessionTimingFileSchema,\n} from \"@/common/orpc/schemas/workspaceStats\";\nimport type {\n  ActiveStreamStats,\n  CompletedStreamStats,\n  SessionTimingFile,\n  TimingAnomaly,\n  WorkspaceStatsSnapshot,\n} from \"@/common/orpc/schemas/workspaceStats\";\nimport type {\n  StreamStartEvent,\n  StreamDeltaEvent,\n  ReasoningDeltaEvent,\n  ToolCallStartEvent,\n  ToolCallDeltaEvent,\n  ToolCallEndEvent,\n  StreamEndEvent,\n  StreamAbortEvent,\n} from \"@/common/types/stream\";\nimport { createDeltaStorage, type DeltaRecordStorage } from \"@/common/utils/tokens/tps\";\nimport { log } from \"./log\";\nimport type { TelemetryService } from \"./telemetryService\";\nimport { roundToBase2 } from \"@/common/telemetry/utils\";\n\nconst SESSION_TIMING_FILE = \"session-timing.json\";\nconst SESSION_TIMING_VERSION = 2 as const;\n\n// Token/tool deltas can arrive very quickly; waking subscribers on every delta can create\n// unnecessary pressure throughout the backend. We rate-limit delta-driven change events\n// per-workspace.\nconst DELTA_EMIT_THROTTLE_MS = 100;\n\nexport type StatsTabVariant = \"control\" | \"stats\";\nexport type StatsTabOverride = \"default\" | \"on\" | \"off\";\n\nexport interface StatsTabState {\n  enabled: boolean;\n  variant: StatsTabVariant;\n  override: StatsTabOverride;\n}\n\ninterface ActiveStreamState {\n  workspaceId: string;\n  messageId: string;\n  model: string;\n  mode?: AgentMode;\n  agentId?: string;\n\n  startTimeMs: number;\n  firstTokenTimeMs: number | null;\n\n  /**\n   * Tool execution wall-clock time (union of overlapping tool calls) accumulated so far.\n   *\n   * Note: We intentionally do NOT sum per-tool durations, because tools can run concurrently.\n   */\n  toolWallMs: number;\n  /** Start time of the current \"â‰¥1 tool running\" segment, if any. */\n  toolWallStartMs: number | null;\n  pendingToolStarts: Map<string, number>;\n\n  outputTokensByDelta: number;\n  reasoningTokensByDelta: number;\n\n  deltaStorage: DeltaRecordStorage;\n\n  lastEventTimestampMs: number;\n}\n\nfunction getModelKey(model: string, mode: AgentMode | undefined, agentId?: string): string {\n  if (agentId) return `${model}:${agentId}`;\n  return mode ? `${model}:${mode}` : model;\n}\n\nfunction createEmptyTimingFile(): SessionTimingFile {\n  return {\n    version: SESSION_TIMING_VERSION,\n    session: {\n      totalDurationMs: 0,\n      totalToolExecutionMs: 0,\n      totalStreamingMs: 0,\n      totalTtftMs: 0,\n      ttftCount: 0,\n      responseCount: 0,\n      totalOutputTokens: 0,\n      totalReasoningTokens: 0,\n      byModel: {},\n    },\n  };\n}\n\nfunction isFiniteNumber(value: number): boolean {\n  return Number.isFinite(value);\n}\n\nfunction validateTiming(params: {\n  totalDurationMs: number;\n  toolExecutionMs: number;\n  ttftMs: number | null;\n  modelTimeMs: number;\n  streamingMs: number;\n}): { invalid: boolean; anomalies: TimingAnomaly[] } {\n  const anomalies: TimingAnomaly[] = [];\n\n  if (\n    !isFiniteNumber(params.totalDurationMs) ||\n    !isFiniteNumber(params.toolExecutionMs) ||\n    !isFiniteNumber(params.modelTimeMs) ||\n    !isFiniteNumber(params.streamingMs) ||\n    (params.ttftMs !== null && !isFiniteNumber(params.ttftMs))\n  ) {\n    anomalies.push(\"nan\");\n  }\n\n  if (\n    params.totalDurationMs < 0 ||\n    params.toolExecutionMs < 0 ||\n    params.modelTimeMs < 0 ||\n    params.streamingMs < 0 ||\n    (params.ttftMs !== null && params.ttftMs < 0)\n  ) {\n    anomalies.push(\"negative_duration\");\n  }\n\n  if (params.toolExecutionMs > params.totalDurationMs) {\n    anomalies.push(\"tool_gt_total\");\n  }\n\n  if (params.ttftMs !== null && params.ttftMs > params.totalDurationMs) {\n    anomalies.push(\"ttft_gt_total\");\n  }\n\n  if (params.totalDurationMs > 0) {\n    const toolPercent = (params.toolExecutionMs / params.totalDurationMs) * 100;\n    const modelPercent = (params.modelTimeMs / params.totalDurationMs) * 100;\n    if (\n      toolPercent < 0 ||\n      toolPercent > 100 ||\n      modelPercent < 0 ||\n      modelPercent > 100 ||\n      !Number.isFinite(toolPercent) ||\n      !Number.isFinite(modelPercent)\n    ) {\n      anomalies.push(\"percent_out_of_range\");\n    }\n  }\n\n  return { invalid: anomalies.length > 0, anomalies };\n}\n\n/**\n * SessionTimingService\n *\n * Backend source-of-truth for timing stats.\n * - Keeps active stream timing in memory\n * - Persists cumulative session timing to ~/.mux/sessions/{workspaceId}/session-timing.json\n * - Emits snapshots to oRPC subscribers\n */\nexport class SessionTimingService {\n  private readonly config: Config;\n  private readonly telemetryService: TelemetryService;\n  private readonly fileLocks = workspaceFileLocks;\n\n  private readonly activeStreams = new Map<string, ActiveStreamState>();\n  private readonly timingFileCache = new Map<string, SessionTimingFile>();\n\n  private readonly emitter = new EventEmitter();\n  private readonly subscriberCounts = new Map<string, number>();\n\n  // Serialize disk writes per workspace; useful for tests and crash-safe ordering.\n  private readonly pendingWrites = new Map<string, Promise<void>>();\n  private readonly writeEpoch = new Map<string, number>();\n  private readonly tickIntervals = new Map<string, ReturnType<typeof setInterval>>();\n\n  private readonly deltaEmitState = new Map<\n    string,\n    { lastEmitTimeMs: number; timer?: ReturnType<typeof setTimeout> }\n  >();\n\n  private statsTabState: StatsTabState = {\n    enabled: false,\n    variant: \"control\",\n    override: \"default\",\n  };\n\n  constructor(config: Config, telemetryService: TelemetryService) {\n    this.config = config;\n    this.telemetryService = telemetryService;\n  }\n\n  setStatsTabState(state: StatsTabState): void {\n    this.statsTabState = state;\n  }\n\n  isEnabled(): boolean {\n    return this.statsTabState.enabled;\n  }\n\n  addSubscriber(workspaceId: string): void {\n    const next = (this.subscriberCounts.get(workspaceId) ?? 0) + 1;\n    this.subscriberCounts.set(workspaceId, next);\n    this.ensureTicking(workspaceId);\n  }\n\n  removeSubscriber(workspaceId: string): void {\n    const current = this.subscriberCounts.get(workspaceId) ?? 0;\n    const next = Math.max(0, current - 1);\n    if (next === 0) {\n      this.subscriberCounts.delete(workspaceId);\n\n      const interval = this.tickIntervals.get(workspaceId);\n      if (interval) {\n        clearInterval(interval);\n        this.tickIntervals.delete(workspaceId);\n      }\n\n      this.clearDeltaEmitState(workspaceId);\n      return;\n    }\n    this.subscriberCounts.set(workspaceId, next);\n  }\n\n  onStatsChange(listener: (workspaceId: string) => void): void {\n    this.emitter.on(\"change\", listener);\n  }\n\n  offStatsChange(listener: (workspaceId: string) => void): void {\n    this.emitter.off(\"change\", listener);\n  }\n\n  private emitChange(workspaceId: string): void {\n    // Only wake subscribers if anyone is listening for this workspace.\n    if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\n      return;\n    }\n    this.emitter.emit(\"change\", workspaceId);\n  }\n\n  private clearDeltaEmitState(workspaceId: string): void {\n    const state = this.deltaEmitState.get(workspaceId);\n    if (!state) {\n      return;\n    }\n\n    if (state.timer) {\n      clearTimeout(state.timer);\n    }\n\n    this.deltaEmitState.delete(workspaceId);\n  }\n\n  private emitDeltaChangeImmediate(workspaceId: string): void {\n    // Avoid allocating timers/state when nothing is subscribed.\n    if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\n      return;\n    }\n\n    const state = this.deltaEmitState.get(workspaceId);\n    if (state?.timer) {\n      clearTimeout(state.timer);\n    }\n\n    this.deltaEmitState.set(workspaceId, { lastEmitTimeMs: Date.now() });\n    this.emitChange(workspaceId);\n  }\n\n  private emitDeltaChangeThrottled(workspaceId: string): void {\n    // Avoid allocating timers/state when nothing is subscribed.\n    if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\n      return;\n    }\n\n    const now = Date.now();\n\n    const state = this.deltaEmitState.get(workspaceId) ?? { lastEmitTimeMs: 0 };\n    const timeSinceLastEmit = now - state.lastEmitTimeMs;\n\n    // If enough time has passed, emit immediately.\n    if (timeSinceLastEmit >= DELTA_EMIT_THROTTLE_MS) {\n      if (state.timer) {\n        clearTimeout(state.timer);\n        state.timer = undefined;\n      }\n\n      state.lastEmitTimeMs = now;\n      this.deltaEmitState.set(workspaceId, state);\n      this.emitChange(workspaceId);\n      return;\n    }\n\n    // Otherwise, schedule one trailing emit at the first allowed time.\n    if (state.timer) {\n      this.deltaEmitState.set(workspaceId, state);\n      return;\n    }\n\n    const remainingTime = Math.max(0, DELTA_EMIT_THROTTLE_MS - timeSinceLastEmit);\n    const timer = setTimeout(() => {\n      // Timer may have been cleared/replaced by an immediate emit.\n      const currentState = this.deltaEmitState.get(workspaceId);\n      if (currentState?.timer !== timer) {\n        return;\n      }\n\n      currentState.timer = undefined;\n\n      // If there are no subscribers anymore, clean up.\n      if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\n        this.deltaEmitState.delete(workspaceId);\n        return;\n      }\n\n      currentState.lastEmitTimeMs = Date.now();\n      this.emitChange(workspaceId);\n    }, remainingTime);\n\n    // Avoid keeping Node (or Jest workers) alive due to a leaked throttle timer.\n    timer.unref?.();\n\n    state.timer = timer;\n    this.deltaEmitState.set(workspaceId, state);\n  }\n\n  private ensureTicking(workspaceId: string): void {\n    if (this.tickIntervals.has(workspaceId)) {\n      return;\n    }\n\n    // Tick only while there is an active stream.\n    const interval = setInterval(() => {\n      if (!this.activeStreams.has(workspaceId)) {\n        return;\n      }\n      this.emitChange(workspaceId);\n    }, 1000);\n\n    // Avoid keeping Node (or Jest workers) alive due to a leaked tick interval.\n    interval.unref?.();\n\n    this.tickIntervals.set(workspaceId, interval);\n  }\n\n  private getFilePath(workspaceId: string): string {\n    return path.join(this.config.getSessionDir(workspaceId), SESSION_TIMING_FILE);\n  }\n\n  private async readTimingFile(workspaceId: string): Promise<SessionTimingFile> {\n    try {\n      const data = await fs.readFile(this.getFilePath(workspaceId), \"utf-8\");\n      const parsed = JSON.parse(data) as unknown;\n\n      // Stats semantics may change over time. If we can't safely interpret old versions,\n      // reset without treating it as file corruption.\n      if (parsed && typeof parsed === \"object\" && \"version\" in parsed) {\n        const version = (parsed as { version?: unknown }).version;\n        if (version !== SESSION_TIMING_VERSION) {\n          return createEmptyTimingFile();\n        }\n      }\n\n      return SessionTimingFileSchema.parse(parsed);\n    } catch (error) {\n      if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n        return createEmptyTimingFile();\n      }\n      log.warn(`session-timing.json corrupted for ${workspaceId}; resetting`, { error });\n      return createEmptyTimingFile();\n    }\n  }\n\n  private async writeTimingFile(workspaceId: string, data: SessionTimingFile): Promise<void> {\n    const filePath = this.getFilePath(workspaceId);\n    await fs.mkdir(path.dirname(filePath), { recursive: true });\n    await writeFileAtomic(filePath, JSON.stringify(data, null, 2));\n  }\n\n  async waitForIdle(workspaceId: string): Promise<void> {\n    await (this.pendingWrites.get(workspaceId) ?? Promise.resolve());\n  }\n\n  private applyCompletedStreamToFile(\n    file: SessionTimingFile,\n    completed: CompletedStreamStats\n  ): void {\n    file.lastRequest = completed;\n\n    file.session.totalDurationMs += completed.totalDurationMs;\n    file.session.totalToolExecutionMs += completed.toolExecutionMs;\n    file.session.totalStreamingMs += completed.streamingMs;\n    if (completed.ttftMs !== null) {\n      file.session.totalTtftMs += completed.ttftMs;\n      file.session.ttftCount += 1;\n    }\n    file.session.responseCount += 1;\n    file.session.totalOutputTokens += completed.outputTokens;\n    file.session.totalReasoningTokens += completed.reasoningTokens;\n\n    const key = getModelKey(completed.model, completed.mode, completed.agentId);\n    const existing = file.session.byModel[key];\n    const base = existing ?? {\n      model: completed.model,\n      mode: completed.mode,\n      agentId: completed.agentId,\n      totalDurationMs: 0,\n      totalToolExecutionMs: 0,\n      totalStreamingMs: 0,\n      totalTtftMs: 0,\n      ttftCount: 0,\n      responseCount: 0,\n      totalOutputTokens: 0,\n      totalReasoningTokens: 0,\n    };\n\n    // Upgrade legacy entries (mode-only) as we observe agent ids.\n    base.mode ??= completed.mode;\n    base.agentId ??= completed.agentId;\n\n    base.totalDurationMs += completed.totalDurationMs;\n    base.totalToolExecutionMs += completed.toolExecutionMs;\n    base.totalStreamingMs += completed.streamingMs;\n    if (completed.ttftMs !== null) {\n      base.totalTtftMs += completed.ttftMs;\n      base.ttftCount += 1;\n    }\n    base.responseCount += 1;\n    base.totalOutputTokens += completed.outputTokens;\n    base.totalReasoningTokens += completed.reasoningTokens;\n\n    file.session.byModel[key] = base;\n  }\n\n  private queuePersistCompletedStream(workspaceId: string, completed: CompletedStreamStats): void {\n    const epoch = this.writeEpoch.get(workspaceId) ?? 0;\n\n    const previous = this.pendingWrites.get(workspaceId) ?? Promise.resolve();\n\n    const next = previous\n      .then(async () => {\n        await this.fileLocks.withLock(workspaceId, async () => {\n          // If a clear() happened after this persist was scheduled, skip.\n          if ((this.writeEpoch.get(workspaceId) ?? 0) !== epoch) {\n            return;\n          }\n\n          const current = await this.readTimingFile(workspaceId);\n          this.applyCompletedStreamToFile(current, completed);\n\n          await this.writeTimingFile(workspaceId, current);\n          this.timingFileCache.set(workspaceId, current);\n        });\n\n        // Telemetry (only when feature enabled)\n        const durationSecs = Math.max(0, completed.totalDurationMs / 1000);\n\n        const toolPercentBucket =\n          completed.totalDurationMs > 0\n            ? Math.max(\n                0,\n                Math.min(\n                  100,\n                  Math.round(((completed.toolExecutionMs / completed.totalDurationMs) * 100) / 5) *\n                    5\n                )\n              )\n            : 0;\n\n        const telemetryAgentId = completed.agentId ?? completed.mode ?? \"exec\";\n\n        this.telemetryService.capture({\n          event: \"stream_timing_computed\",\n          properties: {\n            model: completed.model,\n            agentId: telemetryAgentId,\n            duration_b2: roundToBase2(durationSecs),\n            ttft_ms_b2: completed.ttftMs !== null ? roundToBase2(completed.ttftMs) : 0,\n            tool_ms_b2: roundToBase2(completed.toolExecutionMs),\n            streaming_ms_b2: roundToBase2(completed.streamingMs),\n            tool_percent_bucket: toolPercentBucket,\n            invalid: completed.invalid,\n          },\n        });\n\n        if (completed.invalid) {\n          const reason = completed.anomalies[0] ?? \"unknown\";\n          this.telemetryService.capture({\n            event: \"stream_timing_invalid\",\n            properties: {\n              reason,\n            },\n          });\n        }\n      })\n      .catch((error) => {\n        log.warn(`Failed to persist session-timing.json for ${workspaceId}`, error);\n      });\n\n    this.pendingWrites.set(workspaceId, next);\n  }\n  private async getCachedTimingFile(workspaceId: string): Promise<SessionTimingFile> {\n    const cached = this.timingFileCache.get(workspaceId);\n    if (cached) {\n      return cached;\n    }\n\n    const loaded = await this.fileLocks.withLock(workspaceId, async () => {\n      return this.readTimingFile(workspaceId);\n    });\n    this.timingFileCache.set(workspaceId, loaded);\n    return loaded;\n  }\n\n  async clearTimingFile(workspaceId: string): Promise<void> {\n    // Invalidate any pending writes.\n    this.writeEpoch.set(workspaceId, (this.writeEpoch.get(workspaceId) ?? 0) + 1);\n\n    await this.fileLocks.withLock(workspaceId, async () => {\n      this.timingFileCache.delete(workspaceId);\n      try {\n        await fs.unlink(this.getFilePath(workspaceId));\n      } catch (error) {\n        if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\n          throw error;\n        }\n      }\n    });\n\n    this.emitChange(workspaceId);\n  }\n\n  /**\n   * Merge child timing into the parent workspace.\n   *\n   * Used to preserve sub-agent timing when the child workspace is deleted.\n   *\n   * IMPORTANT:\n   * - Does not update parent's lastRequest\n   * - Uses an on-disk idempotency ledger (rolledUpFrom) to prevent double-counting\n   */\n  async rollUpTimingIntoParent(\n    parentWorkspaceId: string,\n    childWorkspaceId: string\n  ): Promise<{ didRollUp: boolean }> {\n    assert(parentWorkspaceId.trim().length > 0, \"rollUpTimingIntoParent: parentWorkspaceId empty\");\n    assert(childWorkspaceId.trim().length > 0, \"rollUpTimingIntoParent: childWorkspaceId empty\");\n    assert(\n      parentWorkspaceId !== childWorkspaceId,\n      \"rollUpTimingIntoParent: parentWorkspaceId must differ from childWorkspaceId\"\n    );\n\n    // Defensive: don't create new session dirs for already-deleted parents.\n    if (!this.config.findWorkspace(parentWorkspaceId)) {\n      return { didRollUp: false };\n    }\n\n    // Read child timing before acquiring parent lock to avoid multi-workspace lock ordering issues.\n    const childTiming = await this.readTimingFile(childWorkspaceId);\n    if (childTiming.session.responseCount <= 0) {\n      return { didRollUp: false };\n    }\n\n    return this.fileLocks.withLock(parentWorkspaceId, async () => {\n      const parentTiming = await this.readTimingFile(parentWorkspaceId);\n\n      if (parentTiming.rolledUpFrom?.[childWorkspaceId]) {\n        return { didRollUp: false };\n      }\n\n      parentTiming.session.totalDurationMs += childTiming.session.totalDurationMs;\n      parentTiming.session.totalToolExecutionMs += childTiming.session.totalToolExecutionMs;\n      parentTiming.session.totalStreamingMs += childTiming.session.totalStreamingMs;\n      parentTiming.session.totalTtftMs += childTiming.session.totalTtftMs;\n      parentTiming.session.ttftCount += childTiming.session.ttftCount;\n      parentTiming.session.responseCount += childTiming.session.responseCount;\n      parentTiming.session.totalOutputTokens += childTiming.session.totalOutputTokens;\n      parentTiming.session.totalReasoningTokens += childTiming.session.totalReasoningTokens;\n\n      for (const childEntry of Object.values(childTiming.session.byModel)) {\n        const key = getModelKey(childEntry.model, childEntry.mode, childEntry.agentId);\n        const existing = parentTiming.session.byModel[key];\n        const base = existing ?? {\n          model: childEntry.model,\n          mode: childEntry.mode,\n          agentId: childEntry.agentId,\n          totalDurationMs: 0,\n          totalToolExecutionMs: 0,\n          totalStreamingMs: 0,\n          totalTtftMs: 0,\n          ttftCount: 0,\n          responseCount: 0,\n          totalOutputTokens: 0,\n          totalReasoningTokens: 0,\n        };\n\n        // Upgrade legacy entries (mode-only) as we observe agent ids.\n        base.mode ??= childEntry.mode;\n        base.agentId ??= childEntry.agentId;\n\n        // Defensive: key mismatches should not crash; prefer child data as source of truth.\n        const existingSplit = existing?.agentId ?? existing?.mode;\n        const incomingSplit = childEntry.agentId ?? childEntry.mode;\n        if (existing && (existing.model !== childEntry.model || existingSplit !== incomingSplit)) {\n          log.warn(\"Session timing byModel entry mismatch during roll-up\", {\n            parentWorkspaceId,\n            childWorkspaceId,\n            key,\n            existing: { model: existing.model, mode: existing.mode, agentId: existing.agentId },\n            incoming: {\n              model: childEntry.model,\n              mode: childEntry.mode,\n              agentId: childEntry.agentId,\n            },\n          });\n        }\n\n        base.totalDurationMs += childEntry.totalDurationMs;\n        base.totalToolExecutionMs += childEntry.totalToolExecutionMs;\n        base.totalStreamingMs += childEntry.totalStreamingMs;\n        base.totalTtftMs += childEntry.totalTtftMs;\n        base.ttftCount += childEntry.ttftCount;\n        base.responseCount += childEntry.responseCount;\n        base.totalOutputTokens += childEntry.totalOutputTokens;\n        base.totalReasoningTokens += childEntry.totalReasoningTokens;\n\n        parentTiming.session.byModel[key] = base;\n      }\n\n      parentTiming.rolledUpFrom = {\n        ...(parentTiming.rolledUpFrom ?? {}),\n        [childWorkspaceId]: true,\n      };\n\n      await this.writeTimingFile(parentWorkspaceId, parentTiming);\n      this.timingFileCache.set(parentWorkspaceId, parentTiming);\n\n      this.emitChange(parentWorkspaceId);\n\n      return { didRollUp: true };\n    });\n  }\n\n  getActiveStreamStats(workspaceId: string): ActiveStreamStats | undefined {\n    const state = this.activeStreams.get(workspaceId);\n    if (!state) return undefined;\n\n    const now = Date.now();\n    const elapsedMs = Math.max(0, now - state.startTimeMs);\n\n    let toolExecutionMs = state.toolWallMs;\n\n    if (state.toolWallStartMs !== null) {\n      toolExecutionMs += Math.max(0, now - state.toolWallStartMs);\n    } else if (state.pendingToolStarts.size > 0) {\n      // Defensive recovery: tools are running but we lost the current wall segment start.\n      const minStart = Math.min(...Array.from(state.pendingToolStarts.values()));\n      toolExecutionMs += Math.max(0, now - minStart);\n    }\n\n    const ttftMs =\n      state.firstTokenTimeMs !== null\n        ? Math.max(0, state.firstTokenTimeMs - state.startTimeMs)\n        : null;\n\n    const modelTimeMs = Math.max(0, elapsedMs - toolExecutionMs);\n    const streamingMs = Math.max(0, elapsedMs - toolExecutionMs - (ttftMs ?? 0));\n\n    const validation = validateTiming({\n      totalDurationMs: elapsedMs,\n      toolExecutionMs,\n      ttftMs,\n      modelTimeMs,\n      streamingMs,\n    });\n\n    const stats: ActiveStreamStats = {\n      messageId: state.messageId,\n      model: state.model,\n      mode: state.mode,\n      agentId: state.agentId,\n      elapsedMs,\n      ttftMs,\n      toolExecutionMs,\n      modelTimeMs,\n      streamingMs,\n      outputTokens: state.outputTokensByDelta,\n      reasoningTokens: state.reasoningTokensByDelta,\n      liveTokenCount: state.deltaStorage.getTokenCount(),\n      liveTPS: state.deltaStorage.calculateTPS(now),\n      invalid: validation.invalid,\n      anomalies: validation.anomalies,\n    };\n\n    return ActiveStreamStatsSchema.parse(stats);\n  }\n\n  async getSnapshot(workspaceId: string): Promise<WorkspaceStatsSnapshot> {\n    const file = await this.getCachedTimingFile(workspaceId);\n    const active = this.getActiveStreamStats(workspaceId);\n\n    return {\n      workspaceId,\n      generatedAt: Date.now(),\n      active,\n      lastRequest: file.lastRequest,\n      session: file.session,\n    };\n  }\n\n  // --- Stream event handlers (wired from AIService) ---\n\n  handleStreamStart(data: StreamStartEvent): void {\n    if (data.replay === true) return;\n    if (!this.isEnabled()) return;\n\n    assert(typeof data.workspaceId === \"string\" && data.workspaceId.length > 0);\n    assert(typeof data.messageId === \"string\" && data.messageId.length > 0);\n\n    const model = normalizeGatewayModel(data.model);\n\n    // Validate mode: stats schema only accepts \"plan\" | \"exec\" for now.\n    // Custom modes will need schema updates when supported.\n    const mode = data.mode === \"plan\" || data.mode === \"exec\" ? data.mode : undefined;\n    const agentId =\n      typeof data.agentId === \"string\" && data.agentId.trim().length > 0 ? data.agentId : undefined;\n\n    const state: ActiveStreamState = {\n      workspaceId: data.workspaceId,\n      messageId: data.messageId,\n      model,\n      mode,\n      agentId,\n      startTimeMs: data.startTime,\n      firstTokenTimeMs: null,\n      toolWallMs: 0,\n      toolWallStartMs: null,\n      pendingToolStarts: new Map(),\n      outputTokensByDelta: 0,\n      reasoningTokensByDelta: 0,\n      deltaStorage: createDeltaStorage(),\n      lastEventTimestampMs: data.startTime,\n    };\n\n    this.activeStreams.set(data.workspaceId, state);\n    this.emitChange(data.workspaceId);\n  }\n\n  handleStreamDelta(data: StreamDeltaEvent): void {\n    if (data.replay === true) return;\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) return;\n\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\n\n    const isFirstToken = data.delta.length > 0 && state.firstTokenTimeMs === null;\n    if (isFirstToken) {\n      state.firstTokenTimeMs = data.timestamp;\n    }\n\n    state.outputTokensByDelta += data.tokens;\n    state.deltaStorage.addDelta({ tokens: data.tokens, timestamp: data.timestamp, type: \"text\" });\n\n    if (isFirstToken) {\n      // TTFT is user-visible; emit immediately.\n      this.emitDeltaChangeImmediate(data.workspaceId);\n    } else {\n      this.emitDeltaChangeThrottled(data.workspaceId);\n    }\n  }\n\n  handleReasoningDelta(data: ReasoningDeltaEvent): void {\n    if (data.replay === true) return;\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) return;\n\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\n\n    const isFirstToken = data.delta.length > 0 && state.firstTokenTimeMs === null;\n    if (isFirstToken) {\n      state.firstTokenTimeMs = data.timestamp;\n    }\n\n    state.reasoningTokensByDelta += data.tokens;\n    state.deltaStorage.addDelta({\n      tokens: data.tokens,\n      timestamp: data.timestamp,\n      type: \"reasoning\",\n    });\n\n    if (isFirstToken) {\n      // TTFT is user-visible; emit immediately.\n      this.emitDeltaChangeImmediate(data.workspaceId);\n    } else {\n      this.emitDeltaChangeThrottled(data.workspaceId);\n    }\n  }\n\n  handleToolCallStart(data: ToolCallStartEvent): void {\n    if (data.replay === true) return;\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) return;\n\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\n\n    // Defensive: ignore duplicate tool-call-start events.\n    if (state.pendingToolStarts.has(data.toolCallId)) {\n      return;\n    }\n\n    if (state.pendingToolStarts.size === 0) {\n      state.toolWallStartMs = data.timestamp;\n    } else if (state.toolWallStartMs !== null) {\n      state.toolWallStartMs = Math.min(state.toolWallStartMs, data.timestamp);\n    } else {\n      // Should not happen: tools are running but we lost the current wall segment start.\n      // Recover using the earliest start we still know about.\n      state.toolWallStartMs = Math.min(\n        data.timestamp,\n        ...Array.from(state.pendingToolStarts.values())\n      );\n    }\n\n    state.pendingToolStarts.set(data.toolCallId, data.timestamp);\n\n    // Tool args contribute to the visible token count + TPS.\n    state.deltaStorage.addDelta({\n      tokens: data.tokens,\n      timestamp: data.timestamp,\n      type: \"tool-args\",\n    });\n\n    this.emitChange(data.workspaceId);\n  }\n\n  handleToolCallDelta(data: ToolCallDeltaEvent): void {\n    if (data.replay === true) return;\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) return;\n\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\n    state.deltaStorage.addDelta({\n      tokens: data.tokens,\n      timestamp: data.timestamp,\n      type: \"tool-args\",\n    });\n\n    this.emitDeltaChangeThrottled(data.workspaceId);\n  }\n\n  handleToolCallEnd(data: ToolCallEndEvent): void {\n    if (data.replay === true) return;\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) return;\n\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\n\n    const start = state.pendingToolStarts.get(data.toolCallId);\n    if (start === undefined) {\n      this.emitChange(data.workspaceId);\n      return;\n    }\n\n    state.pendingToolStarts.delete(data.toolCallId);\n\n    // If this was the last in-flight tool, close the current \"tool wall time\" segment.\n    if (state.pendingToolStarts.size === 0) {\n      const segmentStart = state.toolWallStartMs ?? start;\n      state.toolWallMs += Math.max(0, data.timestamp - segmentStart);\n      state.toolWallStartMs = null;\n    }\n\n    this.emitChange(data.workspaceId);\n  }\n\n  private isEmptyAbortForTiming(state: ActiveStreamState, usage: unknown): boolean {\n    const usageObj = usage as { outputTokens?: unknown; reasoningTokens?: unknown } | undefined;\n    const outputTokens = typeof usageObj?.outputTokens === \"number\" ? usageObj.outputTokens : 0;\n    const reasoningTokens =\n      typeof usageObj?.reasoningTokens === \"number\" ? usageObj.reasoningTokens : 0;\n\n    const hasUsageTokens = outputTokens > 0 || reasoningTokens > 0;\n\n    const hasAnyToolActivity =\n      state.toolWallMs > 0 || state.toolWallStartMs !== null || state.pendingToolStarts.size > 0;\n\n    const hasAnyTokenActivity = state.deltaStorage.getTokenCount() > 0;\n\n    return (\n      state.firstTokenTimeMs === null &&\n      !hasAnyToolActivity &&\n      !hasAnyTokenActivity &&\n      !hasUsageTokens\n    );\n  }\n\n  private computeCompletedStreamStats(params: {\n    state: ActiveStreamState;\n    messageId: string;\n    durationMs: number;\n    usage: unknown;\n  }): CompletedStreamStats {\n    const state = params.state;\n\n    const endTimestamp = Math.max(\n      state.lastEventTimestampMs,\n      state.startTimeMs + params.durationMs\n    );\n\n    let toolExecutionMs = state.toolWallMs;\n\n    // Close any open tool segment at stream end (can happen on abort/error).\n    if (state.toolWallStartMs !== null) {\n      toolExecutionMs += Math.max(0, endTimestamp - state.toolWallStartMs);\n    } else if (state.pendingToolStarts.size > 0) {\n      // Defensive recovery: tools are running but we lost the current wall segment start.\n      const minStart = Math.min(...Array.from(state.pendingToolStarts.values()));\n      toolExecutionMs += Math.max(0, endTimestamp - minStart);\n    }\n\n    const ttftMs =\n      state.firstTokenTimeMs !== null\n        ? Math.max(0, state.firstTokenTimeMs - state.startTimeMs)\n        : null;\n\n    const modelTimeMs = Math.max(0, params.durationMs - toolExecutionMs);\n    const streamingMs = Math.max(0, params.durationMs - toolExecutionMs - (ttftMs ?? 0));\n\n    const usage = params.usage as { outputTokens?: unknown; reasoningTokens?: unknown } | undefined;\n    const outputTokens =\n      typeof usage?.outputTokens === \"number\" ? usage.outputTokens : state.outputTokensByDelta;\n    const reasoningTokens =\n      typeof usage?.reasoningTokens === \"number\"\n        ? usage.reasoningTokens\n        : state.reasoningTokensByDelta;\n\n    const validation = validateTiming({\n      totalDurationMs: params.durationMs,\n      toolExecutionMs,\n      ttftMs,\n      modelTimeMs,\n      streamingMs,\n    });\n\n    const completed = {\n      messageId: params.messageId,\n      model: state.model,\n      mode: state.mode,\n      agentId: state.agentId,\n      totalDurationMs: params.durationMs,\n      ttftMs,\n      toolExecutionMs,\n      modelTimeMs,\n      streamingMs,\n      outputTokens,\n      reasoningTokens,\n      invalid: validation.invalid,\n      anomalies: validation.anomalies,\n    };\n\n    return CompletedStreamStatsSchema.parse(completed);\n  }\n\n  handleStreamAbort(data: StreamAbortEvent): void {\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) {\n      this.activeStreams.delete(data.workspaceId);\n      this.emitChange(data.workspaceId);\n      return;\n    }\n\n    // Stop tracking active stream state immediately.\n    this.activeStreams.delete(data.workspaceId);\n\n    const usage = data.metadata?.usage;\n\n    // Ignore aborted streams with no meaningful output or tool activity.\n    if (this.isEmptyAbortForTiming(state, usage)) {\n      this.emitChange(data.workspaceId);\n      return;\n    }\n\n    const durationFromMetadata = data.metadata?.duration;\n    const durationMs =\n      typeof durationFromMetadata === \"number\" && Number.isFinite(durationFromMetadata)\n        ? durationFromMetadata\n        : Math.max(0, Date.now() - state.startTimeMs);\n\n    const completedValidated = this.computeCompletedStreamStats({\n      state,\n      messageId: data.messageId,\n      durationMs,\n      usage,\n    });\n\n    // Optimistically update cache so subscribers see the updated session immediately.\n    const cached = this.timingFileCache.get(data.workspaceId);\n    if (cached) {\n      this.applyCompletedStreamToFile(cached, completedValidated);\n    }\n\n    this.queuePersistCompletedStream(data.workspaceId, completedValidated);\n\n    this.emitChange(data.workspaceId);\n  }\n\n  handleStreamEnd(data: StreamEndEvent): void {\n    const state = this.activeStreams.get(data.workspaceId);\n    if (!state) {\n      return;\n    }\n\n    // Stop tracking active stream state immediately.\n    this.activeStreams.delete(data.workspaceId);\n\n    const durationFromMetadata = data.metadata.duration;\n    const durationMs =\n      typeof durationFromMetadata === \"number\" && Number.isFinite(durationFromMetadata)\n        ? durationFromMetadata\n        : Math.max(0, Date.now() - state.startTimeMs);\n\n    const completedValidated = this.computeCompletedStreamStats({\n      state,\n      messageId: data.messageId,\n      durationMs,\n      usage: data.metadata.usage,\n    });\n\n    // Optimistically update cache so subscribers see the updated session immediately.\n    const cached = this.timingFileCache.get(data.workspaceId);\n    if (cached) {\n      this.applyCompletedStreamToFile(cached, completedValidated);\n    }\n\n    this.queuePersistCompletedStream(data.workspaceId, completedValidated);\n\n    this.emitChange(data.workspaceId);\n  }\n}\n"]}