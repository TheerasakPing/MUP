{"version":3,"file":"sessionTimingService.js","sourceRoot":"","sources":["../../../src/node/services/sessionTimingService.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,mEAA2C;AAC3C,MAAY,EAAE,wCAAoB;AAClC,MAAY,IAAI,iCAAa;AAC7B,mCAAsC;AACtC,0EAAgD;AAEhD,oFAAiF;AACjF,qDAAiE;AAEjE,yEAI8C;AAkB9C,mDAAwF;AACxF,+BAA4B;AAE5B,oDAAwD;AAExD,MAAM,mBAAmB,GAAG,qBAAqB,CAAC;AAClD,MAAM,sBAAsB,GAAG,CAAU,CAAC;AAE1C,0FAA0F;AAC1F,wFAAwF;AACxF,iBAAiB;AACjB,MAAM,sBAAsB,GAAG,GAAG,CAAC;AAuCnC,SAAS,WAAW,CAAC,KAAa,EAAE,IAA2B,EAAE,OAAgB,EAAU;IACzF,IAAI,OAAO;QAAE,OAAO,GAAG,KAAK,IAAI,OAAO,EAAE,CAAC;IAC1C,OAAO,IAAI,CAAC,CAAC,CAAC,GAAG,KAAK,IAAI,IAAI,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC;AAAA,CAC1C;AAED,SAAS,qBAAqB,GAAsB;IAClD,OAAO;QACL,OAAO,EAAE,sBAAsB;QAC/B,OAAO,EAAE;YACP,eAAe,EAAE,CAAC;YAClB,oBAAoB,EAAE,CAAC;YACvB,gBAAgB,EAAE,CAAC;YACnB,WAAW,EAAE,CAAC;YACd,SAAS,EAAE,CAAC;YACZ,aAAa,EAAE,CAAC;YAChB,iBAAiB,EAAE,CAAC;YACpB,oBAAoB,EAAE,CAAC;YACvB,OAAO,EAAE,EAAE;SACZ;KACF,CAAC;AAAA,CACH;AAED,SAAS,cAAc,CAAC,KAAa,EAAW;IAC9C,OAAO,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;AAAA,CAC/B;AAED,SAAS,cAAc,CAAC,MAMvB,EAAoD;IACnD,MAAM,SAAS,GAAoB,EAAE,CAAC;IAEtC,IACE,CAAC,cAAc,CAAC,MAAM,CAAC,eAAe,CAAC;QACvC,CAAC,cAAc,CAAC,MAAM,CAAC,eAAe,CAAC;QACvC,CAAC,cAAc,CAAC,MAAM,CAAC,WAAW,CAAC;QACnC,CAAC,cAAc,CAAC,MAAM,CAAC,WAAW,CAAC;QACnC,CAAC,MAAM,CAAC,MAAM,KAAK,IAAI,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAC1D,CAAC;QACD,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IACxB,CAAC;IAED,IACE,MAAM,CAAC,eAAe,GAAG,CAAC;QAC1B,MAAM,CAAC,eAAe,GAAG,CAAC;QAC1B,MAAM,CAAC,WAAW,GAAG,CAAC;QACtB,MAAM,CAAC,WAAW,GAAG,CAAC;QACtB,CAAC,MAAM,CAAC,MAAM,KAAK,IAAI,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,EAC7C,CAAC;QACD,SAAS,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;IACtC,CAAC;IAED,IAAI,MAAM,CAAC,eAAe,GAAG,MAAM,CAAC,eAAe,EAAE,CAAC;QACpD,SAAS,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;IAClC,CAAC;IAED,IAAI,MAAM,CAAC,MAAM,KAAK,IAAI,IAAI,MAAM,CAAC,MAAM,GAAG,MAAM,CAAC,eAAe,EAAE,CAAC;QACrE,SAAS,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;IAClC,CAAC;IAED,IAAI,MAAM,CAAC,eAAe,GAAG,CAAC,EAAE,CAAC;QAC/B,MAAM,WAAW,GAAG,CAAC,MAAM,CAAC,eAAe,GAAG,MAAM,CAAC,eAAe,CAAC,GAAG,GAAG,CAAC;QAC5E,MAAM,YAAY,GAAG,CAAC,MAAM,CAAC,WAAW,GAAG,MAAM,CAAC,eAAe,CAAC,GAAG,GAAG,CAAC;QACzE,IACE,WAAW,GAAG,CAAC;YACf,WAAW,GAAG,GAAG;YACjB,YAAY,GAAG,CAAC;YAChB,YAAY,GAAG,GAAG;YAClB,CAAC,MAAM,CAAC,QAAQ,CAAC,WAAW,CAAC;YAC7B,CAAC,MAAM,CAAC,QAAQ,CAAC,YAAY,CAAC,EAC9B,CAAC;YACD,SAAS,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC;QACzC,CAAC;IACH,CAAC;IAED,OAAO,EAAE,OAAO,EAAE,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,SAAS,EAAE,CAAC;AAAA,CACrD;AAED;;;;;;;GAOG;AACH;IACmB,MAAM,CAAS;IACf,gBAAgB,CAAmB;IACnC,SAAS,GAAG,uCAAkB,CAAC;IAE/B,aAAa,GAAG,IAAI,GAAG,EAA6B,CAAC;IACrD,eAAe,GAAG,IAAI,GAAG,EAA6B,CAAC;IAEvD,OAAO,GAAG,IAAI,qBAAY,EAAE,CAAC;IAC7B,gBAAgB,GAAG,IAAI,GAAG,EAAkB,CAAC;IAE9D,iFAAiF;IAChE,aAAa,GAAG,IAAI,GAAG,EAAyB,CAAC;IACjD,UAAU,GAAG,IAAI,GAAG,EAAkB,CAAC;IACvC,aAAa,GAAG,IAAI,GAAG,EAA0C,CAAC;IAElE,cAAc,GAAG,IAAI,GAAG,EAGtC,CAAC;IAEI,aAAa,GAAkB;QACrC,OAAO,EAAE,KAAK;QACd,OAAO,EAAE,SAAS;QAClB,QAAQ,EAAE,SAAS;KACpB,CAAC;IAEF,YAAY,MAAc,EAAE,gBAAkC,EAAE;QAC9D,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;IAAA,CAC1C;IAED,gBAAgB,CAAC,KAAoB,EAAQ;QAC3C,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC;IAAA,CAC5B;IAED,SAAS,GAAY;QACnB,OAAO,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC;IAAA,CACnC;IAED,aAAa,CAAC,WAAmB,EAAQ;QACvC,MAAM,IAAI,GAAG,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;QAC/D,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;QAC7C,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC;IAAA,CACjC;IAED,gBAAgB,CAAC,WAAmB,EAAQ;QAC1C,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAC5D,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,OAAO,GAAG,CAAC,CAAC,CAAC;QACtC,IAAI,IAAI,KAAK,CAAC,EAAE,CAAC;YACf,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;YAE1C,MAAM,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;YACrD,IAAI,QAAQ,EAAE,CAAC;gBACb,aAAa,CAAC,QAAQ,CAAC,CAAC;gBACxB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;YACzC,CAAC;YAED,IAAI,CAAC,mBAAmB,CAAC,WAAW,CAAC,CAAC;YACtC,OAAO;QACT,CAAC;QACD,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;IAAA,CAC9C;IAED,aAAa,CAAC,QAAuC,EAAQ;QAC3D,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;IAAA,CACrC;IAED,cAAc,CAAC,QAAuC,EAAQ;QAC5D,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;IAAA,CACtC;IAEO,UAAU,CAAC,WAAmB,EAAQ;QAC5C,mEAAmE;QACnE,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC;YACxD,OAAO;QACT,CAAC;QACD,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC;IAAA,CAC1C;IAEO,mBAAmB,CAAC,WAAmB,EAAQ;QACrD,MAAM,KAAK,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QACnD,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,OAAO;QACT,CAAC;QAED,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC;YAChB,YAAY,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC5B,CAAC;QAED,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;IAAA,CACzC;IAEO,wBAAwB,CAAC,WAAmB,EAAQ;QAC1D,4DAA4D;QAC5D,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC;YACxD,OAAO;QACT,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QACnD,IAAI,KAAK,EAAE,KAAK,EAAE,CAAC;YACjB,YAAY,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC5B,CAAC;QAED,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,cAAc,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;QACrE,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;IAAA,CAC9B;IAEO,wBAAwB,CAAC,WAAmB,EAAQ;QAC1D,4DAA4D;QAC5D,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC;YACxD,OAAO;QACT,CAAC;QAED,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEvB,MAAM,KAAK,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,EAAE,cAAc,EAAE,CAAC,EAAE,CAAC;QAC5E,MAAM,iBAAiB,GAAG,GAAG,GAAG,KAAK,CAAC,cAAc,CAAC;QAErD,+CAA+C;QAC/C,IAAI,iBAAiB,IAAI,sBAAsB,EAAE,CAAC;YAChD,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC;gBAChB,YAAY,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;gBAC1B,KAAK,CAAC,KAAK,GAAG,SAAS,CAAC;YAC1B,CAAC;YAED,KAAK,CAAC,cAAc,GAAG,GAAG,CAAC;YAC3B,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;YAC5C,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;YAC7B,OAAO;QACT,CAAC;QAED,mEAAmE;QACnE,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC;YAChB,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;YAC5C,OAAO;QACT,CAAC;QAED,MAAM,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,sBAAsB,GAAG,iBAAiB,CAAC,CAAC;QAC9E,MAAM,KAAK,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;YAC7B,6DAA6D;YAC7D,MAAM,YAAY,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;YAC1D,IAAI,YAAY,EAAE,KAAK,KAAK,KAAK,EAAE,CAAC;gBAClC,OAAO;YACT,CAAC;YAED,YAAY,CAAC,KAAK,GAAG,SAAS,CAAC;YAE/B,iDAAiD;YACjD,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC;gBACxD,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;gBACxC,OAAO;YACT,CAAC;YAED,YAAY,CAAC,cAAc,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACzC,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;QAAA,CAC9B,EAAE,aAAa,CAAC,CAAC;QAElB,6EAA6E;QAC7E,KAAK,CAAC,KAAK,EAAE,EAAE,CAAC;QAEhB,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;QACpB,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;IAAA,CAC7C;IAEO,aAAa,CAAC,WAAmB,EAAQ;QAC/C,IAAI,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC;YACxC,OAAO;QACT,CAAC;QAED,6CAA6C;QAC7C,MAAM,QAAQ,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;YACjC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC;gBACzC,OAAO;YACT,CAAC;YACD,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;QAAA,CAC9B,EAAE,IAAI,CAAC,CAAC;QAET,4EAA4E;QAC5E,QAAQ,CAAC,KAAK,EAAE,EAAE,CAAC;QAEnB,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC;IAAA,CAC/C;IAEO,WAAW,CAAC,WAAmB,EAAU;QAC/C,OAAO,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,WAAW,CAAC,EAAE,mBAAmB,CAAC,CAAC;IAAA,CAC/E;IAEO,KAAK,CAAC,cAAc,CAAC,WAAmB,EAA8B;QAC5E,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,EAAE,OAAO,CAAC,CAAC;YACvE,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAY,CAAC;YAE3C,mFAAmF;YACnF,gDAAgD;YAChD,IAAI,MAAM,IAAI,OAAO,MAAM,KAAK,QAAQ,IAAI,SAAS,IAAI,MAAM,EAAE,CAAC;gBAChE,MAAM,OAAO,GAAI,MAAgC,CAAC,OAAO,CAAC;gBAC1D,IAAI,OAAO,KAAK,sBAAsB,EAAE,CAAC;oBACvC,OAAO,qBAAqB,EAAE,CAAC;gBACjC,CAAC;YACH,CAAC;YAED,OAAO,wCAAuB,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;QAC/C,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,MAAM,IAAI,KAAK,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;gBACrF,OAAO,qBAAqB,EAAE,CAAC;YACjC,CAAC;YACD,SAAG,CAAC,IAAI,CAAC,qCAAqC,WAAW,aAAa,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YACnF,OAAO,qBAAqB,EAAE,CAAC;QACjC,CAAC;IAAA,CACF;IAEO,KAAK,CAAC,eAAe,CAAC,WAAmB,EAAE,IAAuB,EAAiB;QACzF,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;QAC/C,MAAM,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;QAC5D,MAAM,IAAA,2BAAe,EAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;IAAA,CAChE;IAED,KAAK,CAAC,WAAW,CAAC,WAAmB,EAAiB;QACpD,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC;IAAA,CAClE;IAEO,0BAA0B,CAChC,IAAuB,EACvB,SAA+B,EACzB;QACN,IAAI,CAAC,WAAW,GAAG,SAAS,CAAC;QAE7B,IAAI,CAAC,OAAO,CAAC,eAAe,IAAI,SAAS,CAAC,eAAe,CAAC;QAC1D,IAAI,CAAC,OAAO,CAAC,oBAAoB,IAAI,SAAS,CAAC,eAAe,CAAC;QAC/D,IAAI,CAAC,OAAO,CAAC,gBAAgB,IAAI,SAAS,CAAC,WAAW,CAAC;QACvD,IAAI,SAAS,CAAC,MAAM,KAAK,IAAI,EAAE,CAAC;YAC9B,IAAI,CAAC,OAAO,CAAC,WAAW,IAAI,SAAS,CAAC,MAAM,CAAC;YAC7C,IAAI,CAAC,OAAO,CAAC,SAAS,IAAI,CAAC,CAAC;QAC9B,CAAC;QACD,IAAI,CAAC,OAAO,CAAC,aAAa,IAAI,CAAC,CAAC;QAChC,IAAI,CAAC,OAAO,CAAC,iBAAiB,IAAI,SAAS,CAAC,YAAY,CAAC;QACzD,IAAI,CAAC,OAAO,CAAC,oBAAoB,IAAI,SAAS,CAAC,eAAe,CAAC;QAE/D,MAAM,GAAG,GAAG,WAAW,CAAC,SAAS,CAAC,KAAK,EAAE,SAAS,CAAC,IAAI,EAAE,SAAS,CAAC,OAAO,CAAC,CAAC;QAC5E,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAC3C,MAAM,IAAI,GAAG,QAAQ,IAAI;YACvB,KAAK,EAAE,SAAS,CAAC,KAAK;YACtB,IAAI,EAAE,SAAS,CAAC,IAAI;YACpB,OAAO,EAAE,SAAS,CAAC,OAAO;YAC1B,eAAe,EAAE,CAAC;YAClB,oBAAoB,EAAE,CAAC;YACvB,gBAAgB,EAAE,CAAC;YACnB,WAAW,EAAE,CAAC;YACd,SAAS,EAAE,CAAC;YACZ,aAAa,EAAE,CAAC;YAChB,iBAAiB,EAAE,CAAC;YACpB,oBAAoB,EAAE,CAAC;SACxB,CAAC;QAEF,8DAA8D;QAC9D,IAAI,CAAC,IAAI,KAAT,IAAI,CAAC,IAAI,GAAK,SAAS,CAAC,IAAI,EAAC;QAC7B,IAAI,CAAC,OAAO,KAAZ,IAAI,CAAC,OAAO,GAAK,SAAS,CAAC,OAAO,EAAC;QAEnC,IAAI,CAAC,eAAe,IAAI,SAAS,CAAC,eAAe,CAAC;QAClD,IAAI,CAAC,oBAAoB,IAAI,SAAS,CAAC,eAAe,CAAC;QACvD,IAAI,CAAC,gBAAgB,IAAI,SAAS,CAAC,WAAW,CAAC;QAC/C,IAAI,SAAS,CAAC,MAAM,KAAK,IAAI,EAAE,CAAC;YAC9B,IAAI,CAAC,WAAW,IAAI,SAAS,CAAC,MAAM,CAAC;YACrC,IAAI,CAAC,SAAS,IAAI,CAAC,CAAC;QACtB,CAAC;QACD,IAAI,CAAC,aAAa,IAAI,CAAC,CAAC;QACxB,IAAI,CAAC,iBAAiB,IAAI,SAAS,CAAC,YAAY,CAAC;QACjD,IAAI,CAAC,oBAAoB,IAAI,SAAS,CAAC,eAAe,CAAC;QAEvD,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC;IAAA,CAClC;IAEO,2BAA2B,CAAC,WAAmB,EAAE,SAA+B,EAAQ;QAC9F,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAEpD,MAAM,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,OAAO,CAAC,OAAO,EAAE,CAAC;QAE1E,MAAM,IAAI,GAAG,QAAQ;aAClB,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;YAChB,MAAM,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,EAAE,KAAK,IAAI,EAAE,CAAC;gBACrD,gEAAgE;gBAChE,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,KAAK,KAAK,EAAE,CAAC;oBACtD,OAAO;gBACT,CAAC;gBAED,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;gBACvD,IAAI,CAAC,0BAA0B,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC;gBAEpD,MAAM,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC;gBACjD,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC;YAAA,CAChD,CAAC,CAAC;YAEH,wCAAwC;YACxC,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,CAAC,eAAe,GAAG,IAAI,CAAC,CAAC;YAEnE,MAAM,iBAAiB,GACrB,SAAS,CAAC,eAAe,GAAG,CAAC;gBAC3B,CAAC,CAAC,IAAI,CAAC,GAAG,CACN,CAAC,EACD,IAAI,CAAC,GAAG,CACN,GAAG,EACH,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC,eAAe,GAAG,SAAS,CAAC,eAAe,CAAC,GAAG,GAAG,CAAC,GAAG,CAAC,CAAC;oBAC7E,CAAC,CACJ,CACF;gBACH,CAAC,CAAC,CAAC,CAAC;YAER,MAAM,gBAAgB,GAAG,SAAS,CAAC,OAAO,IAAI,SAAS,CAAC,IAAI,IAAI,MAAM,CAAC;YAEvE,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC;gBAC5B,KAAK,EAAE,wBAAwB;gBAC/B,UAAU,EAAE;oBACV,KAAK,EAAE,SAAS,CAAC,KAAK;oBACtB,OAAO,EAAE,gBAAgB;oBACzB,WAAW,EAAE,IAAA,oBAAY,EAAC,YAAY,CAAC;oBACvC,UAAU,EAAE,SAAS,CAAC,MAAM,KAAK,IAAI,CAAC,CAAC,CAAC,IAAA,oBAAY,EAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC1E,UAAU,EAAE,IAAA,oBAAY,EAAC,SAAS,CAAC,eAAe,CAAC;oBACnD,eAAe,EAAE,IAAA,oBAAY,EAAC,SAAS,CAAC,WAAW,CAAC;oBACpD,mBAAmB,EAAE,iBAAiB;oBACtC,OAAO,EAAE,SAAS,CAAC,OAAO;iBAC3B;aACF,CAAC,CAAC;YAEH,IAAI,SAAS,CAAC,OAAO,EAAE,CAAC;gBACtB,MAAM,MAAM,GAAG,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,IAAI,SAAS,CAAC;gBACnD,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC;oBAC5B,KAAK,EAAE,uBAAuB;oBAC9B,UAAU,EAAE;wBACV,MAAM;qBACP;iBACF,CAAC,CAAC;YACL,CAAC;QAAA,CACF,CAAC;aACD,KAAK,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC;YAChB,SAAG,CAAC,IAAI,CAAC,6CAA6C,WAAW,EAAE,EAAE,KAAK,CAAC,CAAC;QAAA,CAC7E,CAAC,CAAC;QAEL,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;IAAA,CAC3C;IACO,KAAK,CAAC,mBAAmB,CAAC,WAAmB,EAA8B;QACjF,MAAM,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QACrD,IAAI,MAAM,EAAE,CAAC;YACX,OAAO,MAAM,CAAC;QAChB,CAAC;QAED,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,EAAE,KAAK,IAAI,EAAE,CAAC;YACpE,OAAO,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;QAAA,CACzC,CAAC,CAAC;QACH,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC;QAC9C,OAAO,MAAM,CAAC;IAAA,CACf;IAED,KAAK,CAAC,eAAe,CAAC,WAAmB,EAAiB;QACxD,iCAAiC;QACjC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;QAE9E,MAAM,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,EAAE,KAAK,IAAI,EAAE,CAAC;YACrD,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;YACzC,IAAI,CAAC;gBACH,MAAM,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC,CAAC;YACjD,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,CAAC,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,MAAM,IAAI,KAAK,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,CAAC,EAAE,CAAC;oBACxF,MAAM,KAAK,CAAC;gBACd,CAAC;YACH,CAAC;QAAA,CACF,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;IAAA,CAC9B;IAED;;;;;;;;OAQG;IACH,KAAK,CAAC,sBAAsB,CAC1B,iBAAyB,EACzB,gBAAwB,EACS;QACjC,IAAA,gBAAM,EAAC,iBAAiB,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC,EAAE,iDAAiD,CAAC,CAAC;QAC/F,IAAA,gBAAM,EAAC,gBAAgB,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC,EAAE,gDAAgD,CAAC,CAAC;QAC7F,IAAA,gBAAM,EACJ,iBAAiB,KAAK,gBAAgB,EACtC,6EAA6E,CAC9E,CAAC;QAEF,wEAAwE;QACxE,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,iBAAiB,CAAC,EAAE,CAAC;YAClD,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;QAC9B,CAAC;QAED,gGAAgG;QAChG,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,gBAAgB,CAAC,CAAC;QAChE,IAAI,WAAW,CAAC,OAAO,CAAC,aAAa,IAAI,CAAC,EAAE,CAAC;YAC3C,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;QAC9B,CAAC;QAED,OAAO,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,iBAAiB,EAAE,KAAK,IAAI,EAAE,CAAC;YAC5D,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,iBAAiB,CAAC,CAAC;YAElE,IAAI,YAAY,CAAC,YAAY,EAAE,CAAC,gBAAgB,CAAC,EAAE,CAAC;gBAClD,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;YAC9B,CAAC;YAED,YAAY,CAAC,OAAO,CAAC,eAAe,IAAI,WAAW,CAAC,OAAO,CAAC,eAAe,CAAC;YAC5E,YAAY,CAAC,OAAO,CAAC,oBAAoB,IAAI,WAAW,CAAC,OAAO,CAAC,oBAAoB,CAAC;YACtF,YAAY,CAAC,OAAO,CAAC,gBAAgB,IAAI,WAAW,CAAC,OAAO,CAAC,gBAAgB,CAAC;YAC9E,YAAY,CAAC,OAAO,CAAC,WAAW,IAAI,WAAW,CAAC,OAAO,CAAC,WAAW,CAAC;YACpE,YAAY,CAAC,OAAO,CAAC,SAAS,IAAI,WAAW,CAAC,OAAO,CAAC,SAAS,CAAC;YAChE,YAAY,CAAC,OAAO,CAAC,aAAa,IAAI,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC;YACxE,YAAY,CAAC,OAAO,CAAC,iBAAiB,IAAI,WAAW,CAAC,OAAO,CAAC,iBAAiB,CAAC;YAChF,YAAY,CAAC,OAAO,CAAC,oBAAoB,IAAI,WAAW,CAAC,OAAO,CAAC,oBAAoB,CAAC;YAEtF,KAAK,MAAM,UAAU,IAAI,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC;gBACpE,MAAM,GAAG,GAAG,WAAW,CAAC,UAAU,CAAC,KAAK,EAAE,UAAU,CAAC,IAAI,EAAE,UAAU,CAAC,OAAO,CAAC,CAAC;gBAC/E,MAAM,QAAQ,GAAG,YAAY,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;gBACnD,MAAM,IAAI,GAAG,QAAQ,IAAI;oBACvB,KAAK,EAAE,UAAU,CAAC,KAAK;oBACvB,IAAI,EAAE,UAAU,CAAC,IAAI;oBACrB,OAAO,EAAE,UAAU,CAAC,OAAO;oBAC3B,eAAe,EAAE,CAAC;oBAClB,oBAAoB,EAAE,CAAC;oBACvB,gBAAgB,EAAE,CAAC;oBACnB,WAAW,EAAE,CAAC;oBACd,SAAS,EAAE,CAAC;oBACZ,aAAa,EAAE,CAAC;oBAChB,iBAAiB,EAAE,CAAC;oBACpB,oBAAoB,EAAE,CAAC;iBACxB,CAAC;gBAEF,8DAA8D;gBAC9D,IAAI,CAAC,IAAI,KAAT,IAAI,CAAC,IAAI,GAAK,UAAU,CAAC,IAAI,EAAC;gBAC9B,IAAI,CAAC,OAAO,KAAZ,IAAI,CAAC,OAAO,GAAK,UAAU,CAAC,OAAO,EAAC;gBAEpC,oFAAoF;gBACpF,MAAM,aAAa,GAAG,QAAQ,EAAE,OAAO,IAAI,QAAQ,EAAE,IAAI,CAAC;gBAC1D,MAAM,aAAa,GAAG,UAAU,CAAC,OAAO,IAAI,UAAU,CAAC,IAAI,CAAC;gBAC5D,IAAI,QAAQ,IAAI,CAAC,QAAQ,CAAC,KAAK,KAAK,UAAU,CAAC,KAAK,IAAI,aAAa,KAAK,aAAa,CAAC,EAAE,CAAC;oBACzF,SAAG,CAAC,IAAI,CAAC,sDAAsD,EAAE;wBAC/D,iBAAiB;wBACjB,gBAAgB;wBAChB,GAAG;wBACH,QAAQ,EAAE,EAAE,KAAK,EAAE,QAAQ,CAAC,KAAK,EAAE,IAAI,EAAE,QAAQ,CAAC,IAAI,EAAE,OAAO,EAAE,QAAQ,CAAC,OAAO,EAAE;wBACnF,QAAQ,EAAE;4BACR,KAAK,EAAE,UAAU,CAAC,KAAK;4BACvB,IAAI,EAAE,UAAU,CAAC,IAAI;4BACrB,OAAO,EAAE,UAAU,CAAC,OAAO;yBAC5B;qBACF,CAAC,CAAC;gBACL,CAAC;gBAED,IAAI,CAAC,eAAe,IAAI,UAAU,CAAC,eAAe,CAAC;gBACnD,IAAI,CAAC,oBAAoB,IAAI,UAAU,CAAC,oBAAoB,CAAC;gBAC7D,IAAI,CAAC,gBAAgB,IAAI,UAAU,CAAC,gBAAgB,CAAC;gBACrD,IAAI,CAAC,WAAW,IAAI,UAAU,CAAC,WAAW,CAAC;gBAC3C,IAAI,CAAC,SAAS,IAAI,UAAU,CAAC,SAAS,CAAC;gBACvC,IAAI,CAAC,aAAa,IAAI,UAAU,CAAC,aAAa,CAAC;gBAC/C,IAAI,CAAC,iBAAiB,IAAI,UAAU,CAAC,iBAAiB,CAAC;gBACvD,IAAI,CAAC,oBAAoB,IAAI,UAAU,CAAC,oBAAoB,CAAC;gBAE7D,YAAY,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC;YAC3C,CAAC;YAED,YAAY,CAAC,YAAY,GAAG;gBAC1B,GAAG,CAAC,YAAY,CAAC,YAAY,IAAI,EAAE,CAAC;gBACpC,CAAC,gBAAgB,CAAC,EAAE,IAAI;aACzB,CAAC;YAEF,MAAM,IAAI,CAAC,eAAe,CAAC,iBAAiB,EAAE,YAAY,CAAC,CAAC;YAC5D,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,iBAAiB,EAAE,YAAY,CAAC,CAAC;YAE1D,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,CAAC;YAEnC,OAAO,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;QAAA,CAC5B,CAAC,CAAC;IAAA,CACJ;IAED,oBAAoB,CAAC,WAAmB,EAAiC;QACvE,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QAClD,IAAI,CAAC,KAAK;YAAE,OAAO,SAAS,CAAC;QAE7B,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,GAAG,KAAK,CAAC,WAAW,CAAC,CAAC;QAEvD,IAAI,eAAe,GAAG,KAAK,CAAC,UAAU,CAAC;QAEvC,IAAI,KAAK,CAAC,eAAe,KAAK,IAAI,EAAE,CAAC;YACnC,eAAe,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,GAAG,KAAK,CAAC,eAAe,CAAC,CAAC;QAC9D,CAAC;aAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,IAAI,GAAG,CAAC,EAAE,CAAC;YAC5C,oFAAoF;YACpF,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;YAC3E,eAAe,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,GAAG,QAAQ,CAAC,CAAC;QACjD,CAAC;QAED,MAAM,MAAM,GACV,KAAK,CAAC,gBAAgB,KAAK,IAAI;YAC7B,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,CAAC,gBAAgB,GAAG,KAAK,CAAC,WAAW,CAAC;YACzD,CAAC,CAAC,IAAI,CAAC;QAEX,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,eAAe,CAAC,CAAC;QAC7D,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,eAAe,GAAG,CAAC,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC;QAE7E,MAAM,UAAU,GAAG,cAAc,CAAC;YAChC,eAAe,EAAE,SAAS;YAC1B,eAAe;YACf,MAAM;YACN,WAAW;YACX,WAAW;SACZ,CAAC,CAAC;QAEH,MAAM,KAAK,GAAsB;YAC/B,SAAS,EAAE,KAAK,CAAC,SAAS;YAC1B,KAAK,EAAE,KAAK,CAAC,KAAK;YAClB,IAAI,EAAE,KAAK,CAAC,IAAI;YAChB,OAAO,EAAE,KAAK,CAAC,OAAO;YACtB,SAAS;YACT,MAAM;YACN,eAAe;YACf,WAAW;YACX,WAAW;YACX,YAAY,EAAE,KAAK,CAAC,mBAAmB;YACvC,eAAe,EAAE,KAAK,CAAC,sBAAsB;YAC7C,cAAc,EAAE,KAAK,CAAC,YAAY,CAAC,aAAa,EAAE;YAClD,OAAO,EAAE,KAAK,CAAC,YAAY,CAAC,YAAY,CAAC,GAAG,CAAC;YAC7C,OAAO,EAAE,UAAU,CAAC,OAAO;YAC3B,SAAS,EAAE,UAAU,CAAC,SAAS;SAChC,CAAC;QAEF,OAAO,wCAAuB,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IAAA,CAC7C;IAED,KAAK,CAAC,WAAW,CAAC,WAAmB,EAAmC;QACtE,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,mBAAmB,CAAC,WAAW,CAAC,CAAC;QACzD,MAAM,MAAM,GAAG,IAAI,CAAC,oBAAoB,CAAC,WAAW,CAAC,CAAC;QAEtD,OAAO;YACL,WAAW;YACX,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;YACvB,MAAM;YACN,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,OAAO,EAAE,IAAI,CAAC,OAAO;SACtB,CAAC;IAAA,CACH;IAED,uDAAuD;IAEvD,iBAAiB,CAAC,IAAsB,EAAQ;QAC9C,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI;YAAE,OAAO;QACjC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;YAAE,OAAO;QAE9B,IAAA,gBAAM,EAAC,OAAO,IAAI,CAAC,WAAW,KAAK,QAAQ,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAC5E,IAAA,gBAAM,EAAC,OAAO,IAAI,CAAC,SAAS,KAAK,QAAQ,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAExE,MAAM,KAAK,GAAG,IAAA,8BAAqB,EAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAEhD,oEAAoE;QACpE,wDAAwD;QACxD,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,KAAK,MAAM,IAAI,IAAI,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC;QAClF,MAAM,OAAO,GACX,OAAO,IAAI,CAAC,OAAO,KAAK,QAAQ,IAAI,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;QAEhG,MAAM,KAAK,GAAsB;YAC/B,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,KAAK;YACL,IAAI;YACJ,OAAO;YACP,WAAW,EAAE,IAAI,CAAC,SAAS;YAC3B,gBAAgB,EAAE,IAAI;YACtB,UAAU,EAAE,CAAC;YACb,eAAe,EAAE,IAAI;YACrB,iBAAiB,EAAE,IAAI,GAAG,EAAE;YAC5B,mBAAmB,EAAE,CAAC;YACtB,sBAAsB,EAAE,CAAC;YACzB,YAAY,EAAE,IAAA,wBAAkB,GAAE;YAClC,oBAAoB,EAAE,IAAI,CAAC,SAAS;SACrC,CAAC;QAEF,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;QAChD,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAAA,CACnC;IAED,iBAAiB,CAAC,IAAsB,EAAQ;QAC9C,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI;YAAE,OAAO;QACjC,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK;YAAE,OAAO;QAEnB,KAAK,CAAC,oBAAoB,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,oBAAoB,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAElF,MAAM,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,KAAK,CAAC,gBAAgB,KAAK,IAAI,CAAC;QAC9E,IAAI,YAAY,EAAE,CAAC;YACjB,KAAK,CAAC,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC;QAC1C,CAAC;QAED,KAAK,CAAC,mBAAmB,IAAI,IAAI,CAAC,MAAM,CAAC;QACzC,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAE,MAAM,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,IAAI,CAAC,SAAS,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;QAE9F,IAAI,YAAY,EAAE,CAAC;YACjB,0CAA0C;YAC1C,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAClD,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAClD,CAAC;IAAA,CACF;IAED,oBAAoB,CAAC,IAAyB,EAAQ;QACpD,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI;YAAE,OAAO;QACjC,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK;YAAE,OAAO;QAEnB,KAAK,CAAC,oBAAoB,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,oBAAoB,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAElF,MAAM,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,KAAK,CAAC,gBAAgB,KAAK,IAAI,CAAC;QAC9E,IAAI,YAAY,EAAE,CAAC;YACjB,KAAK,CAAC,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC;QAC1C,CAAC;QAED,KAAK,CAAC,sBAAsB,IAAI,IAAI,CAAC,MAAM,CAAC;QAC5C,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC;YAC1B,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,IAAI,EAAE,WAAW;SAClB,CAAC,CAAC;QAEH,IAAI,YAAY,EAAE,CAAC;YACjB,0CAA0C;YAC1C,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAClD,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAClD,CAAC;IAAA,CACF;IAED,mBAAmB,CAAC,IAAwB,EAAQ;QAClD,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI;YAAE,OAAO;QACjC,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK;YAAE,OAAO;QAEnB,KAAK,CAAC,oBAAoB,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,oBAAoB,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAElF,sDAAsD;QACtD,IAAI,KAAK,CAAC,iBAAiB,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC;YACjD,OAAO;QACT,CAAC;QAED,IAAI,KAAK,CAAC,iBAAiB,CAAC,IAAI,KAAK,CAAC,EAAE,CAAC;YACvC,KAAK,CAAC,eAAe,GAAG,IAAI,CAAC,SAAS,CAAC;QACzC,CAAC;aAAM,IAAI,KAAK,CAAC,eAAe,KAAK,IAAI,EAAE,CAAC;YAC1C,KAAK,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,eAAe,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAC1E,CAAC;aAAM,CAAC;YACN,mFAAmF;YACnF,wDAAwD;YACxD,KAAK,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,CAC9B,IAAI,CAAC,SAAS,EACd,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,MAAM,EAAE,CAAC,CAChD,CAAC;QACJ,CAAC;QAED,KAAK,CAAC,iBAAiB,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAE7D,yDAAyD;QACzD,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC;YAC1B,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,IAAI,EAAE,WAAW;SAClB,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAAA,CACnC;IAED,mBAAmB,CAAC,IAAwB,EAAQ;QAClD,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI;YAAE,OAAO;QACjC,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK;YAAE,OAAO;QAEnB,KAAK,CAAC,oBAAoB,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,oBAAoB,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAClF,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC;YAC1B,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,IAAI,EAAE,WAAW;SAClB,CAAC,CAAC;QAEH,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAAA,CACjD;IAED,iBAAiB,CAAC,IAAsB,EAAQ;QAC9C,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI;YAAE,OAAO;QACjC,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK;YAAE,OAAO;QAEnB,KAAK,CAAC,oBAAoB,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,oBAAoB,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAElF,MAAM,KAAK,GAAG,KAAK,CAAC,iBAAiB,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAC3D,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;YACxB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAClC,OAAO;QACT,CAAC;QAED,KAAK,CAAC,iBAAiB,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAEhD,mFAAmF;QACnF,IAAI,KAAK,CAAC,iBAAiB,CAAC,IAAI,KAAK,CAAC,EAAE,CAAC;YACvC,MAAM,YAAY,GAAG,KAAK,CAAC,eAAe,IAAI,KAAK,CAAC;YACpD,KAAK,CAAC,UAAU,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,SAAS,GAAG,YAAY,CAAC,CAAC;YAC/D,KAAK,CAAC,eAAe,GAAG,IAAI,CAAC;QAC/B,CAAC;QAED,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAAA,CACnC;IAEO,qBAAqB,CAAC,KAAwB,EAAE,KAAc,EAAW;QAC/E,MAAM,QAAQ,GAAG,KAA0E,CAAC;QAC5F,MAAM,YAAY,GAAG,OAAO,QAAQ,EAAE,YAAY,KAAK,QAAQ,CAAC,CAAC,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC;QAC5F,MAAM,eAAe,GACnB,OAAO,QAAQ,EAAE,eAAe,KAAK,QAAQ,CAAC,CAAC,CAAC,QAAQ,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;QAE/E,MAAM,cAAc,GAAG,YAAY,GAAG,CAAC,IAAI,eAAe,GAAG,CAAC,CAAC;QAE/D,MAAM,kBAAkB,GACtB,KAAK,CAAC,UAAU,GAAG,CAAC,IAAI,KAAK,CAAC,eAAe,KAAK,IAAI,IAAI,KAAK,CAAC,iBAAiB,CAAC,IAAI,GAAG,CAAC,CAAC;QAE7F,MAAM,mBAAmB,GAAG,KAAK,CAAC,YAAY,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC;QAEnE,OAAO,CACL,KAAK,CAAC,gBAAgB,KAAK,IAAI;YAC/B,CAAC,kBAAkB;YACnB,CAAC,mBAAmB;YACpB,CAAC,cAAc,CAChB,CAAC;IAAA,CACH;IAEO,2BAA2B,CAAC,MAKnC,EAAwB;QACvB,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC;QAE3B,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,CAC3B,KAAK,CAAC,oBAAoB,EAC1B,KAAK,CAAC,WAAW,GAAG,MAAM,CAAC,UAAU,CACtC,CAAC;QAEF,IAAI,eAAe,GAAG,KAAK,CAAC,UAAU,CAAC;QAEvC,yEAAyE;QACzE,IAAI,KAAK,CAAC,eAAe,KAAK,IAAI,EAAE,CAAC;YACnC,eAAe,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,YAAY,GAAG,KAAK,CAAC,eAAe,CAAC,CAAC;QACvE,CAAC;aAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,IAAI,GAAG,CAAC,EAAE,CAAC;YAC5C,oFAAoF;YACpF,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;YAC3E,eAAe,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,YAAY,GAAG,QAAQ,CAAC,CAAC;QAC1D,CAAC;QAED,MAAM,MAAM,GACV,KAAK,CAAC,gBAAgB,KAAK,IAAI;YAC7B,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,CAAC,gBAAgB,GAAG,KAAK,CAAC,WAAW,CAAC;YACzD,CAAC,CAAC,IAAI,CAAC;QAEX,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,CAAC,UAAU,GAAG,eAAe,CAAC,CAAC;QACrE,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,CAAC,UAAU,GAAG,eAAe,GAAG,CAAC,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC;QAErF,MAAM,KAAK,GAAG,MAAM,CAAC,KAA0E,CAAC;QAChG,MAAM,YAAY,GAChB,OAAO,KAAK,EAAE,YAAY,KAAK,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC,KAAK,CAAC,mBAAmB,CAAC;QAC3F,MAAM,eAAe,GACnB,OAAO,KAAK,EAAE,eAAe,KAAK,QAAQ;YACxC,CAAC,CAAC,KAAK,CAAC,eAAe;YACvB,CAAC,CAAC,KAAK,CAAC,sBAAsB,CAAC;QAEnC,MAAM,UAAU,GAAG,cAAc,CAAC;YAChC,eAAe,EAAE,MAAM,CAAC,UAAU;YAClC,eAAe;YACf,MAAM;YACN,WAAW;YACX,WAAW;SACZ,CAAC,CAAC;QAEH,MAAM,SAAS,GAAG;YAChB,SAAS,EAAE,MAAM,CAAC,SAAS;YAC3B,KAAK,EAAE,KAAK,CAAC,KAAK;YAClB,IAAI,EAAE,KAAK,CAAC,IAAI;YAChB,OAAO,EAAE,KAAK,CAAC,OAAO;YACtB,eAAe,EAAE,MAAM,CAAC,UAAU;YAClC,MAAM;YACN,eAAe;YACf,WAAW;YACX,WAAW;YACX,YAAY;YACZ,eAAe;YACf,OAAO,EAAE,UAAU,CAAC,OAAO;YAC3B,SAAS,EAAE,UAAU,CAAC,SAAS;SAChC,CAAC;QAEF,OAAO,2CAA0B,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;IAAA,CACpD;IAED,iBAAiB,CAAC,IAAsB,EAAQ;QAC9C,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAC5C,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAClC,OAAO;QACT,CAAC;QAED,iDAAiD;QACjD,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAE5C,MAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,EAAE,KAAK,CAAC;QAEnC,qEAAqE;QACrE,IAAI,IAAI,CAAC,qBAAqB,CAAC,KAAK,EAAE,KAAK,CAAC,EAAE,CAAC;YAC7C,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAClC,OAAO;QACT,CAAC;QAED,MAAM,oBAAoB,GAAG,IAAI,CAAC,QAAQ,EAAE,QAAQ,CAAC;QACrD,MAAM,UAAU,GACd,OAAO,oBAAoB,KAAK,QAAQ,IAAI,MAAM,CAAC,QAAQ,CAAC,oBAAoB,CAAC;YAC/E,CAAC,CAAC,oBAAoB;YACtB,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK,CAAC,WAAW,CAAC,CAAC;QAElD,MAAM,kBAAkB,GAAG,IAAI,CAAC,2BAA2B,CAAC;YAC1D,KAAK;YACL,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,UAAU;YACV,KAAK;SACN,CAAC,CAAC;QAEH,kFAAkF;QAClF,MAAM,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAC1D,IAAI,MAAM,EAAE,CAAC;YACX,IAAI,CAAC,0BAA0B,CAAC,MAAM,EAAE,kBAAkB,CAAC,CAAC;QAC9D,CAAC;QAED,IAAI,CAAC,2BAA2B,CAAC,IAAI,CAAC,WAAW,EAAE,kBAAkB,CAAC,CAAC;QAEvE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAAA,CACnC;IAED,eAAe,CAAC,IAAoB,EAAQ;QAC1C,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,OAAO;QACT,CAAC;QAED,iDAAiD;QACjD,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAE5C,MAAM,oBAAoB,GAAG,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC;QACpD,MAAM,UAAU,GACd,OAAO,oBAAoB,KAAK,QAAQ,IAAI,MAAM,CAAC,QAAQ,CAAC,oBAAoB,CAAC;YAC/E,CAAC,CAAC,oBAAoB;YACtB,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK,CAAC,WAAW,CAAC,CAAC;QAElD,MAAM,kBAAkB,GAAG,IAAI,CAAC,2BAA2B,CAAC;YAC1D,KAAK;YACL,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,UAAU;YACV,KAAK,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK;SAC3B,CAAC,CAAC;QAEH,kFAAkF;QAClF,MAAM,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAC1D,IAAI,MAAM,EAAE,CAAC;YACX,IAAI,CAAC,0BAA0B,CAAC,MAAM,EAAE,kBAAkB,CAAC,CAAC;QAC9D,CAAC;QAED,IAAI,CAAC,2BAA2B,CAAC,IAAI,CAAC,WAAW,EAAE,kBAAkB,CAAC,CAAC;QAEvE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAAA,CACnC;CACF","sourcesContent":["import assert from \"@/common/utils/assert\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport { EventEmitter } from \"events\";\r\nimport writeFileAtomic from \"write-file-atomic\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\r\nimport { normalizeGatewayModel } from \"@/common/utils/ai/models\";\r\nimport type { AgentMode } from \"@/common/types/mode\";\r\nimport {\r\n  ActiveStreamStatsSchema,\r\n  CompletedStreamStatsSchema,\r\n  SessionTimingFileSchema,\r\n} from \"@/common/orpc/schemas/workspaceStats\";\r\nimport type {\r\n  ActiveStreamStats,\r\n  CompletedStreamStats,\r\n  SessionTimingFile,\r\n  TimingAnomaly,\r\n  WorkspaceStatsSnapshot,\r\n} from \"@/common/orpc/schemas/workspaceStats\";\r\nimport type {\r\n  StreamStartEvent,\r\n  StreamDeltaEvent,\r\n  ReasoningDeltaEvent,\r\n  ToolCallStartEvent,\r\n  ToolCallDeltaEvent,\r\n  ToolCallEndEvent,\r\n  StreamEndEvent,\r\n  StreamAbortEvent,\r\n} from \"@/common/types/stream\";\r\nimport { createDeltaStorage, type DeltaRecordStorage } from \"@/common/utils/tokens/tps\";\r\nimport { log } from \"./log\";\r\nimport type { TelemetryService } from \"./telemetryService\";\r\nimport { roundToBase2 } from \"@/common/telemetry/utils\";\r\n\r\nconst SESSION_TIMING_FILE = \"session-timing.json\";\r\nconst SESSION_TIMING_VERSION = 2 as const;\r\n\r\n// Token/tool deltas can arrive very quickly; waking subscribers on every delta can create\r\n// unnecessary pressure throughout the backend. We rate-limit delta-driven change events\r\n// per-workspace.\r\nconst DELTA_EMIT_THROTTLE_MS = 100;\r\n\r\nexport type StatsTabVariant = \"control\" | \"stats\";\r\nexport type StatsTabOverride = \"default\" | \"on\" | \"off\";\r\n\r\nexport interface StatsTabState {\r\n  enabled: boolean;\r\n  variant: StatsTabVariant;\r\n  override: StatsTabOverride;\r\n}\r\n\r\ninterface ActiveStreamState {\r\n  workspaceId: string;\r\n  messageId: string;\r\n  model: string;\r\n  mode?: AgentMode;\r\n  agentId?: string;\r\n\r\n  startTimeMs: number;\r\n  firstTokenTimeMs: number | null;\r\n\r\n  /**\r\n   * Tool execution wall-clock time (union of overlapping tool calls) accumulated so far.\r\n   *\r\n   * Note: We intentionally do NOT sum per-tool durations, because tools can run concurrently.\r\n   */\r\n  toolWallMs: number;\r\n  /** Start time of the current \"â‰¥1 tool running\" segment, if any. */\r\n  toolWallStartMs: number | null;\r\n  pendingToolStarts: Map<string, number>;\r\n\r\n  outputTokensByDelta: number;\r\n  reasoningTokensByDelta: number;\r\n\r\n  deltaStorage: DeltaRecordStorage;\r\n\r\n  lastEventTimestampMs: number;\r\n}\r\n\r\nfunction getModelKey(model: string, mode: AgentMode | undefined, agentId?: string): string {\r\n  if (agentId) return `${model}:${agentId}`;\r\n  return mode ? `${model}:${mode}` : model;\r\n}\r\n\r\nfunction createEmptyTimingFile(): SessionTimingFile {\r\n  return {\r\n    version: SESSION_TIMING_VERSION,\r\n    session: {\r\n      totalDurationMs: 0,\r\n      totalToolExecutionMs: 0,\r\n      totalStreamingMs: 0,\r\n      totalTtftMs: 0,\r\n      ttftCount: 0,\r\n      responseCount: 0,\r\n      totalOutputTokens: 0,\r\n      totalReasoningTokens: 0,\r\n      byModel: {},\r\n    },\r\n  };\r\n}\r\n\r\nfunction isFiniteNumber(value: number): boolean {\r\n  return Number.isFinite(value);\r\n}\r\n\r\nfunction validateTiming(params: {\r\n  totalDurationMs: number;\r\n  toolExecutionMs: number;\r\n  ttftMs: number | null;\r\n  modelTimeMs: number;\r\n  streamingMs: number;\r\n}): { invalid: boolean; anomalies: TimingAnomaly[] } {\r\n  const anomalies: TimingAnomaly[] = [];\r\n\r\n  if (\r\n    !isFiniteNumber(params.totalDurationMs) ||\r\n    !isFiniteNumber(params.toolExecutionMs) ||\r\n    !isFiniteNumber(params.modelTimeMs) ||\r\n    !isFiniteNumber(params.streamingMs) ||\r\n    (params.ttftMs !== null && !isFiniteNumber(params.ttftMs))\r\n  ) {\r\n    anomalies.push(\"nan\");\r\n  }\r\n\r\n  if (\r\n    params.totalDurationMs < 0 ||\r\n    params.toolExecutionMs < 0 ||\r\n    params.modelTimeMs < 0 ||\r\n    params.streamingMs < 0 ||\r\n    (params.ttftMs !== null && params.ttftMs < 0)\r\n  ) {\r\n    anomalies.push(\"negative_duration\");\r\n  }\r\n\r\n  if (params.toolExecutionMs > params.totalDurationMs) {\r\n    anomalies.push(\"tool_gt_total\");\r\n  }\r\n\r\n  if (params.ttftMs !== null && params.ttftMs > params.totalDurationMs) {\r\n    anomalies.push(\"ttft_gt_total\");\r\n  }\r\n\r\n  if (params.totalDurationMs > 0) {\r\n    const toolPercent = (params.toolExecutionMs / params.totalDurationMs) * 100;\r\n    const modelPercent = (params.modelTimeMs / params.totalDurationMs) * 100;\r\n    if (\r\n      toolPercent < 0 ||\r\n      toolPercent > 100 ||\r\n      modelPercent < 0 ||\r\n      modelPercent > 100 ||\r\n      !Number.isFinite(toolPercent) ||\r\n      !Number.isFinite(modelPercent)\r\n    ) {\r\n      anomalies.push(\"percent_out_of_range\");\r\n    }\r\n  }\r\n\r\n  return { invalid: anomalies.length > 0, anomalies };\r\n}\r\n\r\n/**\r\n * SessionTimingService\r\n *\r\n * Backend source-of-truth for timing stats.\r\n * - Keeps active stream timing in memory\r\n * - Persists cumulative session timing to ~/.mux/sessions/{workspaceId}/session-timing.json\r\n * - Emits snapshots to oRPC subscribers\r\n */\r\nexport class SessionTimingService {\r\n  private readonly config: Config;\r\n  private readonly telemetryService: TelemetryService;\r\n  private readonly fileLocks = workspaceFileLocks;\r\n\r\n  private readonly activeStreams = new Map<string, ActiveStreamState>();\r\n  private readonly timingFileCache = new Map<string, SessionTimingFile>();\r\n\r\n  private readonly emitter = new EventEmitter();\r\n  private readonly subscriberCounts = new Map<string, number>();\r\n\r\n  // Serialize disk writes per workspace; useful for tests and crash-safe ordering.\r\n  private readonly pendingWrites = new Map<string, Promise<void>>();\r\n  private readonly writeEpoch = new Map<string, number>();\r\n  private readonly tickIntervals = new Map<string, ReturnType<typeof setInterval>>();\r\n\r\n  private readonly deltaEmitState = new Map<\r\n    string,\r\n    { lastEmitTimeMs: number; timer?: ReturnType<typeof setTimeout> }\r\n  >();\r\n\r\n  private statsTabState: StatsTabState = {\r\n    enabled: false,\r\n    variant: \"control\",\r\n    override: \"default\",\r\n  };\r\n\r\n  constructor(config: Config, telemetryService: TelemetryService) {\r\n    this.config = config;\r\n    this.telemetryService = telemetryService;\r\n  }\r\n\r\n  setStatsTabState(state: StatsTabState): void {\r\n    this.statsTabState = state;\r\n  }\r\n\r\n  isEnabled(): boolean {\r\n    return this.statsTabState.enabled;\r\n  }\r\n\r\n  addSubscriber(workspaceId: string): void {\r\n    const next = (this.subscriberCounts.get(workspaceId) ?? 0) + 1;\r\n    this.subscriberCounts.set(workspaceId, next);\r\n    this.ensureTicking(workspaceId);\r\n  }\r\n\r\n  removeSubscriber(workspaceId: string): void {\r\n    const current = this.subscriberCounts.get(workspaceId) ?? 0;\r\n    const next = Math.max(0, current - 1);\r\n    if (next === 0) {\r\n      this.subscriberCounts.delete(workspaceId);\r\n\r\n      const interval = this.tickIntervals.get(workspaceId);\r\n      if (interval) {\r\n        clearInterval(interval);\r\n        this.tickIntervals.delete(workspaceId);\r\n      }\r\n\r\n      this.clearDeltaEmitState(workspaceId);\r\n      return;\r\n    }\r\n    this.subscriberCounts.set(workspaceId, next);\r\n  }\r\n\r\n  onStatsChange(listener: (workspaceId: string) => void): void {\r\n    this.emitter.on(\"change\", listener);\r\n  }\r\n\r\n  offStatsChange(listener: (workspaceId: string) => void): void {\r\n    this.emitter.off(\"change\", listener);\r\n  }\r\n\r\n  private emitChange(workspaceId: string): void {\r\n    // Only wake subscribers if anyone is listening for this workspace.\r\n    if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\r\n      return;\r\n    }\r\n    this.emitter.emit(\"change\", workspaceId);\r\n  }\r\n\r\n  private clearDeltaEmitState(workspaceId: string): void {\r\n    const state = this.deltaEmitState.get(workspaceId);\r\n    if (!state) {\r\n      return;\r\n    }\r\n\r\n    if (state.timer) {\r\n      clearTimeout(state.timer);\r\n    }\r\n\r\n    this.deltaEmitState.delete(workspaceId);\r\n  }\r\n\r\n  private emitDeltaChangeImmediate(workspaceId: string): void {\r\n    // Avoid allocating timers/state when nothing is subscribed.\r\n    if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\r\n      return;\r\n    }\r\n\r\n    const state = this.deltaEmitState.get(workspaceId);\r\n    if (state?.timer) {\r\n      clearTimeout(state.timer);\r\n    }\r\n\r\n    this.deltaEmitState.set(workspaceId, { lastEmitTimeMs: Date.now() });\r\n    this.emitChange(workspaceId);\r\n  }\r\n\r\n  private emitDeltaChangeThrottled(workspaceId: string): void {\r\n    // Avoid allocating timers/state when nothing is subscribed.\r\n    if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\r\n      return;\r\n    }\r\n\r\n    const now = Date.now();\r\n\r\n    const state = this.deltaEmitState.get(workspaceId) ?? { lastEmitTimeMs: 0 };\r\n    const timeSinceLastEmit = now - state.lastEmitTimeMs;\r\n\r\n    // If enough time has passed, emit immediately.\r\n    if (timeSinceLastEmit >= DELTA_EMIT_THROTTLE_MS) {\r\n      if (state.timer) {\r\n        clearTimeout(state.timer);\r\n        state.timer = undefined;\r\n      }\r\n\r\n      state.lastEmitTimeMs = now;\r\n      this.deltaEmitState.set(workspaceId, state);\r\n      this.emitChange(workspaceId);\r\n      return;\r\n    }\r\n\r\n    // Otherwise, schedule one trailing emit at the first allowed time.\r\n    if (state.timer) {\r\n      this.deltaEmitState.set(workspaceId, state);\r\n      return;\r\n    }\r\n\r\n    const remainingTime = Math.max(0, DELTA_EMIT_THROTTLE_MS - timeSinceLastEmit);\r\n    const timer = setTimeout(() => {\r\n      // Timer may have been cleared/replaced by an immediate emit.\r\n      const currentState = this.deltaEmitState.get(workspaceId);\r\n      if (currentState?.timer !== timer) {\r\n        return;\r\n      }\r\n\r\n      currentState.timer = undefined;\r\n\r\n      // If there are no subscribers anymore, clean up.\r\n      if ((this.subscriberCounts.get(workspaceId) ?? 0) === 0) {\r\n        this.deltaEmitState.delete(workspaceId);\r\n        return;\r\n      }\r\n\r\n      currentState.lastEmitTimeMs = Date.now();\r\n      this.emitChange(workspaceId);\r\n    }, remainingTime);\r\n\r\n    // Avoid keeping Node (or Jest workers) alive due to a leaked throttle timer.\r\n    timer.unref?.();\r\n\r\n    state.timer = timer;\r\n    this.deltaEmitState.set(workspaceId, state);\r\n  }\r\n\r\n  private ensureTicking(workspaceId: string): void {\r\n    if (this.tickIntervals.has(workspaceId)) {\r\n      return;\r\n    }\r\n\r\n    // Tick only while there is an active stream.\r\n    const interval = setInterval(() => {\r\n      if (!this.activeStreams.has(workspaceId)) {\r\n        return;\r\n      }\r\n      this.emitChange(workspaceId);\r\n    }, 1000);\r\n\r\n    // Avoid keeping Node (or Jest workers) alive due to a leaked tick interval.\r\n    interval.unref?.();\r\n\r\n    this.tickIntervals.set(workspaceId, interval);\r\n  }\r\n\r\n  private getFilePath(workspaceId: string): string {\r\n    return path.join(this.config.getSessionDir(workspaceId), SESSION_TIMING_FILE);\r\n  }\r\n\r\n  private async readTimingFile(workspaceId: string): Promise<SessionTimingFile> {\r\n    try {\r\n      const data = await fs.readFile(this.getFilePath(workspaceId), \"utf-8\");\r\n      const parsed = JSON.parse(data) as unknown;\r\n\r\n      // Stats semantics may change over time. If we can't safely interpret old versions,\r\n      // reset without treating it as file corruption.\r\n      if (parsed && typeof parsed === \"object\" && \"version\" in parsed) {\r\n        const version = (parsed as { version?: unknown }).version;\r\n        if (version !== SESSION_TIMING_VERSION) {\r\n          return createEmptyTimingFile();\r\n        }\r\n      }\r\n\r\n      return SessionTimingFileSchema.parse(parsed);\r\n    } catch (error) {\r\n      if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\r\n        return createEmptyTimingFile();\r\n      }\r\n      log.warn(`session-timing.json corrupted for ${workspaceId}; resetting`, { error });\r\n      return createEmptyTimingFile();\r\n    }\r\n  }\r\n\r\n  private async writeTimingFile(workspaceId: string, data: SessionTimingFile): Promise<void> {\r\n    const filePath = this.getFilePath(workspaceId);\r\n    await fs.mkdir(path.dirname(filePath), { recursive: true });\r\n    await writeFileAtomic(filePath, JSON.stringify(data, null, 2));\r\n  }\r\n\r\n  async waitForIdle(workspaceId: string): Promise<void> {\r\n    await (this.pendingWrites.get(workspaceId) ?? Promise.resolve());\r\n  }\r\n\r\n  private applyCompletedStreamToFile(\r\n    file: SessionTimingFile,\r\n    completed: CompletedStreamStats\r\n  ): void {\r\n    file.lastRequest = completed;\r\n\r\n    file.session.totalDurationMs += completed.totalDurationMs;\r\n    file.session.totalToolExecutionMs += completed.toolExecutionMs;\r\n    file.session.totalStreamingMs += completed.streamingMs;\r\n    if (completed.ttftMs !== null) {\r\n      file.session.totalTtftMs += completed.ttftMs;\r\n      file.session.ttftCount += 1;\r\n    }\r\n    file.session.responseCount += 1;\r\n    file.session.totalOutputTokens += completed.outputTokens;\r\n    file.session.totalReasoningTokens += completed.reasoningTokens;\r\n\r\n    const key = getModelKey(completed.model, completed.mode, completed.agentId);\r\n    const existing = file.session.byModel[key];\r\n    const base = existing ?? {\r\n      model: completed.model,\r\n      mode: completed.mode,\r\n      agentId: completed.agentId,\r\n      totalDurationMs: 0,\r\n      totalToolExecutionMs: 0,\r\n      totalStreamingMs: 0,\r\n      totalTtftMs: 0,\r\n      ttftCount: 0,\r\n      responseCount: 0,\r\n      totalOutputTokens: 0,\r\n      totalReasoningTokens: 0,\r\n    };\r\n\r\n    // Upgrade legacy entries (mode-only) as we observe agent ids.\r\n    base.mode ??= completed.mode;\r\n    base.agentId ??= completed.agentId;\r\n\r\n    base.totalDurationMs += completed.totalDurationMs;\r\n    base.totalToolExecutionMs += completed.toolExecutionMs;\r\n    base.totalStreamingMs += completed.streamingMs;\r\n    if (completed.ttftMs !== null) {\r\n      base.totalTtftMs += completed.ttftMs;\r\n      base.ttftCount += 1;\r\n    }\r\n    base.responseCount += 1;\r\n    base.totalOutputTokens += completed.outputTokens;\r\n    base.totalReasoningTokens += completed.reasoningTokens;\r\n\r\n    file.session.byModel[key] = base;\r\n  }\r\n\r\n  private queuePersistCompletedStream(workspaceId: string, completed: CompletedStreamStats): void {\r\n    const epoch = this.writeEpoch.get(workspaceId) ?? 0;\r\n\r\n    const previous = this.pendingWrites.get(workspaceId) ?? Promise.resolve();\r\n\r\n    const next = previous\r\n      .then(async () => {\r\n        await this.fileLocks.withLock(workspaceId, async () => {\r\n          // If a clear() happened after this persist was scheduled, skip.\r\n          if ((this.writeEpoch.get(workspaceId) ?? 0) !== epoch) {\r\n            return;\r\n          }\r\n\r\n          const current = await this.readTimingFile(workspaceId);\r\n          this.applyCompletedStreamToFile(current, completed);\r\n\r\n          await this.writeTimingFile(workspaceId, current);\r\n          this.timingFileCache.set(workspaceId, current);\r\n        });\r\n\r\n        // Telemetry (only when feature enabled)\r\n        const durationSecs = Math.max(0, completed.totalDurationMs / 1000);\r\n\r\n        const toolPercentBucket =\r\n          completed.totalDurationMs > 0\r\n            ? Math.max(\r\n                0,\r\n                Math.min(\r\n                  100,\r\n                  Math.round(((completed.toolExecutionMs / completed.totalDurationMs) * 100) / 5) *\r\n                    5\r\n                )\r\n              )\r\n            : 0;\r\n\r\n        const telemetryAgentId = completed.agentId ?? completed.mode ?? \"exec\";\r\n\r\n        this.telemetryService.capture({\r\n          event: \"stream_timing_computed\",\r\n          properties: {\r\n            model: completed.model,\r\n            agentId: telemetryAgentId,\r\n            duration_b2: roundToBase2(durationSecs),\r\n            ttft_ms_b2: completed.ttftMs !== null ? roundToBase2(completed.ttftMs) : 0,\r\n            tool_ms_b2: roundToBase2(completed.toolExecutionMs),\r\n            streaming_ms_b2: roundToBase2(completed.streamingMs),\r\n            tool_percent_bucket: toolPercentBucket,\r\n            invalid: completed.invalid,\r\n          },\r\n        });\r\n\r\n        if (completed.invalid) {\r\n          const reason = completed.anomalies[0] ?? \"unknown\";\r\n          this.telemetryService.capture({\r\n            event: \"stream_timing_invalid\",\r\n            properties: {\r\n              reason,\r\n            },\r\n          });\r\n        }\r\n      })\r\n      .catch((error) => {\r\n        log.warn(`Failed to persist session-timing.json for ${workspaceId}`, error);\r\n      });\r\n\r\n    this.pendingWrites.set(workspaceId, next);\r\n  }\r\n  private async getCachedTimingFile(workspaceId: string): Promise<SessionTimingFile> {\r\n    const cached = this.timingFileCache.get(workspaceId);\r\n    if (cached) {\r\n      return cached;\r\n    }\r\n\r\n    const loaded = await this.fileLocks.withLock(workspaceId, async () => {\r\n      return this.readTimingFile(workspaceId);\r\n    });\r\n    this.timingFileCache.set(workspaceId, loaded);\r\n    return loaded;\r\n  }\r\n\r\n  async clearTimingFile(workspaceId: string): Promise<void> {\r\n    // Invalidate any pending writes.\r\n    this.writeEpoch.set(workspaceId, (this.writeEpoch.get(workspaceId) ?? 0) + 1);\r\n\r\n    await this.fileLocks.withLock(workspaceId, async () => {\r\n      this.timingFileCache.delete(workspaceId);\r\n      try {\r\n        await fs.unlink(this.getFilePath(workspaceId));\r\n      } catch (error) {\r\n        if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\r\n          throw error;\r\n        }\r\n      }\r\n    });\r\n\r\n    this.emitChange(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Merge child timing into the parent workspace.\r\n   *\r\n   * Used to preserve sub-agent timing when the child workspace is deleted.\r\n   *\r\n   * IMPORTANT:\r\n   * - Does not update parent's lastRequest\r\n   * - Uses an on-disk idempotency ledger (rolledUpFrom) to prevent double-counting\r\n   */\r\n  async rollUpTimingIntoParent(\r\n    parentWorkspaceId: string,\r\n    childWorkspaceId: string\r\n  ): Promise<{ didRollUp: boolean }> {\r\n    assert(parentWorkspaceId.trim().length > 0, \"rollUpTimingIntoParent: parentWorkspaceId empty\");\r\n    assert(childWorkspaceId.trim().length > 0, \"rollUpTimingIntoParent: childWorkspaceId empty\");\r\n    assert(\r\n      parentWorkspaceId !== childWorkspaceId,\r\n      \"rollUpTimingIntoParent: parentWorkspaceId must differ from childWorkspaceId\"\r\n    );\r\n\r\n    // Defensive: don't create new session dirs for already-deleted parents.\r\n    if (!this.config.findWorkspace(parentWorkspaceId)) {\r\n      return { didRollUp: false };\r\n    }\r\n\r\n    // Read child timing before acquiring parent lock to avoid multi-workspace lock ordering issues.\r\n    const childTiming = await this.readTimingFile(childWorkspaceId);\r\n    if (childTiming.session.responseCount <= 0) {\r\n      return { didRollUp: false };\r\n    }\r\n\r\n    return this.fileLocks.withLock(parentWorkspaceId, async () => {\r\n      const parentTiming = await this.readTimingFile(parentWorkspaceId);\r\n\r\n      if (parentTiming.rolledUpFrom?.[childWorkspaceId]) {\r\n        return { didRollUp: false };\r\n      }\r\n\r\n      parentTiming.session.totalDurationMs += childTiming.session.totalDurationMs;\r\n      parentTiming.session.totalToolExecutionMs += childTiming.session.totalToolExecutionMs;\r\n      parentTiming.session.totalStreamingMs += childTiming.session.totalStreamingMs;\r\n      parentTiming.session.totalTtftMs += childTiming.session.totalTtftMs;\r\n      parentTiming.session.ttftCount += childTiming.session.ttftCount;\r\n      parentTiming.session.responseCount += childTiming.session.responseCount;\r\n      parentTiming.session.totalOutputTokens += childTiming.session.totalOutputTokens;\r\n      parentTiming.session.totalReasoningTokens += childTiming.session.totalReasoningTokens;\r\n\r\n      for (const childEntry of Object.values(childTiming.session.byModel)) {\r\n        const key = getModelKey(childEntry.model, childEntry.mode, childEntry.agentId);\r\n        const existing = parentTiming.session.byModel[key];\r\n        const base = existing ?? {\r\n          model: childEntry.model,\r\n          mode: childEntry.mode,\r\n          agentId: childEntry.agentId,\r\n          totalDurationMs: 0,\r\n          totalToolExecutionMs: 0,\r\n          totalStreamingMs: 0,\r\n          totalTtftMs: 0,\r\n          ttftCount: 0,\r\n          responseCount: 0,\r\n          totalOutputTokens: 0,\r\n          totalReasoningTokens: 0,\r\n        };\r\n\r\n        // Upgrade legacy entries (mode-only) as we observe agent ids.\r\n        base.mode ??= childEntry.mode;\r\n        base.agentId ??= childEntry.agentId;\r\n\r\n        // Defensive: key mismatches should not crash; prefer child data as source of truth.\r\n        const existingSplit = existing?.agentId ?? existing?.mode;\r\n        const incomingSplit = childEntry.agentId ?? childEntry.mode;\r\n        if (existing && (existing.model !== childEntry.model || existingSplit !== incomingSplit)) {\r\n          log.warn(\"Session timing byModel entry mismatch during roll-up\", {\r\n            parentWorkspaceId,\r\n            childWorkspaceId,\r\n            key,\r\n            existing: { model: existing.model, mode: existing.mode, agentId: existing.agentId },\r\n            incoming: {\r\n              model: childEntry.model,\r\n              mode: childEntry.mode,\r\n              agentId: childEntry.agentId,\r\n            },\r\n          });\r\n        }\r\n\r\n        base.totalDurationMs += childEntry.totalDurationMs;\r\n        base.totalToolExecutionMs += childEntry.totalToolExecutionMs;\r\n        base.totalStreamingMs += childEntry.totalStreamingMs;\r\n        base.totalTtftMs += childEntry.totalTtftMs;\r\n        base.ttftCount += childEntry.ttftCount;\r\n        base.responseCount += childEntry.responseCount;\r\n        base.totalOutputTokens += childEntry.totalOutputTokens;\r\n        base.totalReasoningTokens += childEntry.totalReasoningTokens;\r\n\r\n        parentTiming.session.byModel[key] = base;\r\n      }\r\n\r\n      parentTiming.rolledUpFrom = {\r\n        ...(parentTiming.rolledUpFrom ?? {}),\r\n        [childWorkspaceId]: true,\r\n      };\r\n\r\n      await this.writeTimingFile(parentWorkspaceId, parentTiming);\r\n      this.timingFileCache.set(parentWorkspaceId, parentTiming);\r\n\r\n      this.emitChange(parentWorkspaceId);\r\n\r\n      return { didRollUp: true };\r\n    });\r\n  }\r\n\r\n  getActiveStreamStats(workspaceId: string): ActiveStreamStats | undefined {\r\n    const state = this.activeStreams.get(workspaceId);\r\n    if (!state) return undefined;\r\n\r\n    const now = Date.now();\r\n    const elapsedMs = Math.max(0, now - state.startTimeMs);\r\n\r\n    let toolExecutionMs = state.toolWallMs;\r\n\r\n    if (state.toolWallStartMs !== null) {\r\n      toolExecutionMs += Math.max(0, now - state.toolWallStartMs);\r\n    } else if (state.pendingToolStarts.size > 0) {\r\n      // Defensive recovery: tools are running but we lost the current wall segment start.\r\n      const minStart = Math.min(...Array.from(state.pendingToolStarts.values()));\r\n      toolExecutionMs += Math.max(0, now - minStart);\r\n    }\r\n\r\n    const ttftMs =\r\n      state.firstTokenTimeMs !== null\r\n        ? Math.max(0, state.firstTokenTimeMs - state.startTimeMs)\r\n        : null;\r\n\r\n    const modelTimeMs = Math.max(0, elapsedMs - toolExecutionMs);\r\n    const streamingMs = Math.max(0, elapsedMs - toolExecutionMs - (ttftMs ?? 0));\r\n\r\n    const validation = validateTiming({\r\n      totalDurationMs: elapsedMs,\r\n      toolExecutionMs,\r\n      ttftMs,\r\n      modelTimeMs,\r\n      streamingMs,\r\n    });\r\n\r\n    const stats: ActiveStreamStats = {\r\n      messageId: state.messageId,\r\n      model: state.model,\r\n      mode: state.mode,\r\n      agentId: state.agentId,\r\n      elapsedMs,\r\n      ttftMs,\r\n      toolExecutionMs,\r\n      modelTimeMs,\r\n      streamingMs,\r\n      outputTokens: state.outputTokensByDelta,\r\n      reasoningTokens: state.reasoningTokensByDelta,\r\n      liveTokenCount: state.deltaStorage.getTokenCount(),\r\n      liveTPS: state.deltaStorage.calculateTPS(now),\r\n      invalid: validation.invalid,\r\n      anomalies: validation.anomalies,\r\n    };\r\n\r\n    return ActiveStreamStatsSchema.parse(stats);\r\n  }\r\n\r\n  async getSnapshot(workspaceId: string): Promise<WorkspaceStatsSnapshot> {\r\n    const file = await this.getCachedTimingFile(workspaceId);\r\n    const active = this.getActiveStreamStats(workspaceId);\r\n\r\n    return {\r\n      workspaceId,\r\n      generatedAt: Date.now(),\r\n      active,\r\n      lastRequest: file.lastRequest,\r\n      session: file.session,\r\n    };\r\n  }\r\n\r\n  // --- Stream event handlers (wired from AIService) ---\r\n\r\n  handleStreamStart(data: StreamStartEvent): void {\r\n    if (data.replay === true) return;\r\n    if (!this.isEnabled()) return;\r\n\r\n    assert(typeof data.workspaceId === \"string\" && data.workspaceId.length > 0);\r\n    assert(typeof data.messageId === \"string\" && data.messageId.length > 0);\r\n\r\n    const model = normalizeGatewayModel(data.model);\r\n\r\n    // Validate mode: stats schema only accepts \"plan\" | \"exec\" for now.\r\n    // Custom modes will need schema updates when supported.\r\n    const mode = data.mode === \"plan\" || data.mode === \"exec\" ? data.mode : undefined;\r\n    const agentId =\r\n      typeof data.agentId === \"string\" && data.agentId.trim().length > 0 ? data.agentId : undefined;\r\n\r\n    const state: ActiveStreamState = {\r\n      workspaceId: data.workspaceId,\r\n      messageId: data.messageId,\r\n      model,\r\n      mode,\r\n      agentId,\r\n      startTimeMs: data.startTime,\r\n      firstTokenTimeMs: null,\r\n      toolWallMs: 0,\r\n      toolWallStartMs: null,\r\n      pendingToolStarts: new Map(),\r\n      outputTokensByDelta: 0,\r\n      reasoningTokensByDelta: 0,\r\n      deltaStorage: createDeltaStorage(),\r\n      lastEventTimestampMs: data.startTime,\r\n    };\r\n\r\n    this.activeStreams.set(data.workspaceId, state);\r\n    this.emitChange(data.workspaceId);\r\n  }\r\n\r\n  handleStreamDelta(data: StreamDeltaEvent): void {\r\n    if (data.replay === true) return;\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) return;\r\n\r\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\r\n\r\n    const isFirstToken = data.delta.length > 0 && state.firstTokenTimeMs === null;\r\n    if (isFirstToken) {\r\n      state.firstTokenTimeMs = data.timestamp;\r\n    }\r\n\r\n    state.outputTokensByDelta += data.tokens;\r\n    state.deltaStorage.addDelta({ tokens: data.tokens, timestamp: data.timestamp, type: \"text\" });\r\n\r\n    if (isFirstToken) {\r\n      // TTFT is user-visible; emit immediately.\r\n      this.emitDeltaChangeImmediate(data.workspaceId);\r\n    } else {\r\n      this.emitDeltaChangeThrottled(data.workspaceId);\r\n    }\r\n  }\r\n\r\n  handleReasoningDelta(data: ReasoningDeltaEvent): void {\r\n    if (data.replay === true) return;\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) return;\r\n\r\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\r\n\r\n    const isFirstToken = data.delta.length > 0 && state.firstTokenTimeMs === null;\r\n    if (isFirstToken) {\r\n      state.firstTokenTimeMs = data.timestamp;\r\n    }\r\n\r\n    state.reasoningTokensByDelta += data.tokens;\r\n    state.deltaStorage.addDelta({\r\n      tokens: data.tokens,\r\n      timestamp: data.timestamp,\r\n      type: \"reasoning\",\r\n    });\r\n\r\n    if (isFirstToken) {\r\n      // TTFT is user-visible; emit immediately.\r\n      this.emitDeltaChangeImmediate(data.workspaceId);\r\n    } else {\r\n      this.emitDeltaChangeThrottled(data.workspaceId);\r\n    }\r\n  }\r\n\r\n  handleToolCallStart(data: ToolCallStartEvent): void {\r\n    if (data.replay === true) return;\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) return;\r\n\r\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\r\n\r\n    // Defensive: ignore duplicate tool-call-start events.\r\n    if (state.pendingToolStarts.has(data.toolCallId)) {\r\n      return;\r\n    }\r\n\r\n    if (state.pendingToolStarts.size === 0) {\r\n      state.toolWallStartMs = data.timestamp;\r\n    } else if (state.toolWallStartMs !== null) {\r\n      state.toolWallStartMs = Math.min(state.toolWallStartMs, data.timestamp);\r\n    } else {\r\n      // Should not happen: tools are running but we lost the current wall segment start.\r\n      // Recover using the earliest start we still know about.\r\n      state.toolWallStartMs = Math.min(\r\n        data.timestamp,\r\n        ...Array.from(state.pendingToolStarts.values())\r\n      );\r\n    }\r\n\r\n    state.pendingToolStarts.set(data.toolCallId, data.timestamp);\r\n\r\n    // Tool args contribute to the visible token count + TPS.\r\n    state.deltaStorage.addDelta({\r\n      tokens: data.tokens,\r\n      timestamp: data.timestamp,\r\n      type: \"tool-args\",\r\n    });\r\n\r\n    this.emitChange(data.workspaceId);\r\n  }\r\n\r\n  handleToolCallDelta(data: ToolCallDeltaEvent): void {\r\n    if (data.replay === true) return;\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) return;\r\n\r\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\r\n    state.deltaStorage.addDelta({\r\n      tokens: data.tokens,\r\n      timestamp: data.timestamp,\r\n      type: \"tool-args\",\r\n    });\r\n\r\n    this.emitDeltaChangeThrottled(data.workspaceId);\r\n  }\r\n\r\n  handleToolCallEnd(data: ToolCallEndEvent): void {\r\n    if (data.replay === true) return;\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) return;\r\n\r\n    state.lastEventTimestampMs = Math.max(state.lastEventTimestampMs, data.timestamp);\r\n\r\n    const start = state.pendingToolStarts.get(data.toolCallId);\r\n    if (start === undefined) {\r\n      this.emitChange(data.workspaceId);\r\n      return;\r\n    }\r\n\r\n    state.pendingToolStarts.delete(data.toolCallId);\r\n\r\n    // If this was the last in-flight tool, close the current \"tool wall time\" segment.\r\n    if (state.pendingToolStarts.size === 0) {\r\n      const segmentStart = state.toolWallStartMs ?? start;\r\n      state.toolWallMs += Math.max(0, data.timestamp - segmentStart);\r\n      state.toolWallStartMs = null;\r\n    }\r\n\r\n    this.emitChange(data.workspaceId);\r\n  }\r\n\r\n  private isEmptyAbortForTiming(state: ActiveStreamState, usage: unknown): boolean {\r\n    const usageObj = usage as { outputTokens?: unknown; reasoningTokens?: unknown } | undefined;\r\n    const outputTokens = typeof usageObj?.outputTokens === \"number\" ? usageObj.outputTokens : 0;\r\n    const reasoningTokens =\r\n      typeof usageObj?.reasoningTokens === \"number\" ? usageObj.reasoningTokens : 0;\r\n\r\n    const hasUsageTokens = outputTokens > 0 || reasoningTokens > 0;\r\n\r\n    const hasAnyToolActivity =\r\n      state.toolWallMs > 0 || state.toolWallStartMs !== null || state.pendingToolStarts.size > 0;\r\n\r\n    const hasAnyTokenActivity = state.deltaStorage.getTokenCount() > 0;\r\n\r\n    return (\r\n      state.firstTokenTimeMs === null &&\r\n      !hasAnyToolActivity &&\r\n      !hasAnyTokenActivity &&\r\n      !hasUsageTokens\r\n    );\r\n  }\r\n\r\n  private computeCompletedStreamStats(params: {\r\n    state: ActiveStreamState;\r\n    messageId: string;\r\n    durationMs: number;\r\n    usage: unknown;\r\n  }): CompletedStreamStats {\r\n    const state = params.state;\r\n\r\n    const endTimestamp = Math.max(\r\n      state.lastEventTimestampMs,\r\n      state.startTimeMs + params.durationMs\r\n    );\r\n\r\n    let toolExecutionMs = state.toolWallMs;\r\n\r\n    // Close any open tool segment at stream end (can happen on abort/error).\r\n    if (state.toolWallStartMs !== null) {\r\n      toolExecutionMs += Math.max(0, endTimestamp - state.toolWallStartMs);\r\n    } else if (state.pendingToolStarts.size > 0) {\r\n      // Defensive recovery: tools are running but we lost the current wall segment start.\r\n      const minStart = Math.min(...Array.from(state.pendingToolStarts.values()));\r\n      toolExecutionMs += Math.max(0, endTimestamp - minStart);\r\n    }\r\n\r\n    const ttftMs =\r\n      state.firstTokenTimeMs !== null\r\n        ? Math.max(0, state.firstTokenTimeMs - state.startTimeMs)\r\n        : null;\r\n\r\n    const modelTimeMs = Math.max(0, params.durationMs - toolExecutionMs);\r\n    const streamingMs = Math.max(0, params.durationMs - toolExecutionMs - (ttftMs ?? 0));\r\n\r\n    const usage = params.usage as { outputTokens?: unknown; reasoningTokens?: unknown } | undefined;\r\n    const outputTokens =\r\n      typeof usage?.outputTokens === \"number\" ? usage.outputTokens : state.outputTokensByDelta;\r\n    const reasoningTokens =\r\n      typeof usage?.reasoningTokens === \"number\"\r\n        ? usage.reasoningTokens\r\n        : state.reasoningTokensByDelta;\r\n\r\n    const validation = validateTiming({\r\n      totalDurationMs: params.durationMs,\r\n      toolExecutionMs,\r\n      ttftMs,\r\n      modelTimeMs,\r\n      streamingMs,\r\n    });\r\n\r\n    const completed = {\r\n      messageId: params.messageId,\r\n      model: state.model,\r\n      mode: state.mode,\r\n      agentId: state.agentId,\r\n      totalDurationMs: params.durationMs,\r\n      ttftMs,\r\n      toolExecutionMs,\r\n      modelTimeMs,\r\n      streamingMs,\r\n      outputTokens,\r\n      reasoningTokens,\r\n      invalid: validation.invalid,\r\n      anomalies: validation.anomalies,\r\n    };\r\n\r\n    return CompletedStreamStatsSchema.parse(completed);\r\n  }\r\n\r\n  handleStreamAbort(data: StreamAbortEvent): void {\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) {\r\n      this.activeStreams.delete(data.workspaceId);\r\n      this.emitChange(data.workspaceId);\r\n      return;\r\n    }\r\n\r\n    // Stop tracking active stream state immediately.\r\n    this.activeStreams.delete(data.workspaceId);\r\n\r\n    const usage = data.metadata?.usage;\r\n\r\n    // Ignore aborted streams with no meaningful output or tool activity.\r\n    if (this.isEmptyAbortForTiming(state, usage)) {\r\n      this.emitChange(data.workspaceId);\r\n      return;\r\n    }\r\n\r\n    const durationFromMetadata = data.metadata?.duration;\r\n    const durationMs =\r\n      typeof durationFromMetadata === \"number\" && Number.isFinite(durationFromMetadata)\r\n        ? durationFromMetadata\r\n        : Math.max(0, Date.now() - state.startTimeMs);\r\n\r\n    const completedValidated = this.computeCompletedStreamStats({\r\n      state,\r\n      messageId: data.messageId,\r\n      durationMs,\r\n      usage,\r\n    });\r\n\r\n    // Optimistically update cache so subscribers see the updated session immediately.\r\n    const cached = this.timingFileCache.get(data.workspaceId);\r\n    if (cached) {\r\n      this.applyCompletedStreamToFile(cached, completedValidated);\r\n    }\r\n\r\n    this.queuePersistCompletedStream(data.workspaceId, completedValidated);\r\n\r\n    this.emitChange(data.workspaceId);\r\n  }\r\n\r\n  handleStreamEnd(data: StreamEndEvent): void {\r\n    const state = this.activeStreams.get(data.workspaceId);\r\n    if (!state) {\r\n      return;\r\n    }\r\n\r\n    // Stop tracking active stream state immediately.\r\n    this.activeStreams.delete(data.workspaceId);\r\n\r\n    const durationFromMetadata = data.metadata.duration;\r\n    const durationMs =\r\n      typeof durationFromMetadata === \"number\" && Number.isFinite(durationFromMetadata)\r\n        ? durationFromMetadata\r\n        : Math.max(0, Date.now() - state.startTimeMs);\r\n\r\n    const completedValidated = this.computeCompletedStreamStats({\r\n      state,\r\n      messageId: data.messageId,\r\n      durationMs,\r\n      usage: data.metadata.usage,\r\n    });\r\n\r\n    // Optimistically update cache so subscribers see the updated session immediately.\r\n    const cached = this.timingFileCache.get(data.workspaceId);\r\n    if (cached) {\r\n      this.applyCompletedStreamToFile(cached, completedValidated);\r\n    }\r\n\r\n    this.queuePersistCompletedStream(data.workspaceId, completedValidated);\r\n\r\n    this.emitChange(data.workspaceId);\r\n  }\r\n}\r\n"]}