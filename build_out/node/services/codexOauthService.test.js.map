{"version":3,"file":"codexOauthService.test.js","sourceRoot":"","sources":["../../../src/node/services/codexOauthService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\n\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok } from \"@/common/types/result\";\r\nimport type { Config, ProvidersConfig } from \"@/node/config\";\r\nimport type { ProviderService } from \"@/node/services/providerService\";\r\nimport type { WindowService } from \"@/node/services/windowService\";\r\nimport type { CodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\r\nimport { CodexOauthService } from \"./codexOauthService\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Helpers\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Encode a claims object into a fake JWT (header.payload.signature). */\r\nfunction fakeJwt(claims: Record<string, unknown>): string {\r\n  const header = Buffer.from(JSON.stringify({ alg: \"none\" })).toString(\"base64url\");\r\n  const payload = Buffer.from(JSON.stringify(claims)).toString(\"base64url\");\r\n  return `${header}.${payload}.fakesig`;\r\n}\r\n\r\n/** Build a valid CodexOauthAuth that expires far in the future. */\r\nfunction validAuth(overrides?: Partial<CodexOauthAuth>): CodexOauthAuth {\r\n  return {\r\n    type: \"oauth\",\r\n    access: fakeJwt({ sub: \"user\" }),\r\n    refresh: \"rt_test\",\r\n    expires: Date.now() + 3_600_000, // 1h from now\r\n    ...overrides,\r\n  };\r\n}\r\n\r\n/** Build a CodexOauthAuth that is already expired. */\r\nfunction expiredAuth(overrides?: Partial<CodexOauthAuth>): CodexOauthAuth {\r\n  return validAuth({ expires: Date.now() - 60_000, ...overrides });\r\n}\r\n\r\n/** Build a mock fetch Response for token refresh. */\r\nfunction mockRefreshResponse(body: Record<string, unknown>, status = 200): Response {\r\n  return new Response(JSON.stringify(body), {\r\n    status,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n  });\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Mock dependencies\r\n// ---------------------------------------------------------------------------\r\n\r\ninterface MockDeps {\r\n  providersConfig: ProvidersConfig;\r\n  setConfigValueCalls: Array<{ provider: string; keyPath: string[]; value: unknown }>;\r\n  focusCalls: number;\r\n}\r\n\r\nfunction createMockDeps(): MockDeps {\r\n  return {\r\n    providersConfig: {},\r\n    setConfigValueCalls: [],\r\n    focusCalls: 0,\r\n  };\r\n}\r\n\r\nfunction createMockConfig(deps: MockDeps): Pick<Config, \"loadProvidersConfig\"> {\r\n  return {\r\n    loadProvidersConfig: () => deps.providersConfig,\r\n  };\r\n}\r\n\r\nfunction createMockProviderService(deps: MockDeps): Pick<ProviderService, \"setConfigValue\"> {\r\n  return {\r\n    setConfigValue: (provider: string, keyPath: string[], value: unknown): Result<void, string> => {\r\n      deps.setConfigValueCalls.push({ provider, keyPath, value });\r\n      // Also update the in-memory config so readStoredAuth() sees the write\r\n      if (provider === \"openai\" && keyPath[0] === \"codexOauth\") {\r\n        if (value === undefined) {\r\n          const openai = deps.providersConfig.openai;\r\n          if (openai) {\r\n            delete openai.codexOauth;\r\n          }\r\n        } else {\r\n          deps.providersConfig.openai ??= {};\r\n          deps.providersConfig.openai.codexOauth = value;\r\n        }\r\n      }\r\n      return Ok(undefined);\r\n    },\r\n  };\r\n}\r\n\r\nfunction createMockWindowService(deps: MockDeps): Pick<WindowService, \"focusMainWindow\"> {\r\n  return {\r\n    focusMainWindow: () => {\r\n      deps.focusCalls++;\r\n    },\r\n  };\r\n}\r\n\r\nfunction createService(deps: MockDeps): CodexOauthService {\r\n  return new CodexOauthService(\r\n    createMockConfig(deps) as Config,\r\n    createMockProviderService(deps) as ProviderService,\r\n    createMockWindowService(deps) as WindowService\r\n  );\r\n}\r\n\r\n// Helper to mock globalThis.fetch without needing the `preconnect` property.\r\nfunction mockFetch(fn: (input: RequestInfo | URL, init?: RequestInit) => Promise<Response>): void {\r\n  globalThis.fetch = Object.assign(fn, {\r\n    preconnect: (_url: string | URL) => {\r\n      // no-op in tests\r\n    },\r\n  }) as typeof fetch;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Tests\r\n// ---------------------------------------------------------------------------\r\n\r\ndescribe(\"CodexOauthService\", () => {\r\n  let deps: MockDeps;\r\n  let service: CodexOauthService;\r\n  const originalFetch = globalThis.fetch;\r\n\r\n  beforeEach(() => {\r\n    deps = createMockDeps();\r\n    service = createService(deps);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    globalThis.fetch = originalFetch;\r\n    await service.dispose();\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // getValidAuth - basic\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"getValidAuth\", () => {\r\n    it(\"returns error when no auth is stored\", async () => {\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"not configured\");\r\n      }\r\n    });\r\n\r\n    it(\"returns stored auth when token is not expired\", async () => {\r\n      const auth = validAuth();\r\n      deps.providersConfig = { openai: { codexOauth: auth } };\r\n\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data.access).toBe(auth.access);\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Token refresh coalescing (AsyncMutex)\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"token refresh coalescing\", () => {\r\n    it(\"only triggers one refresh for concurrent getValidAuth calls with expired tokens\", async () => {\r\n      const expired = expiredAuth();\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      let fetchCallCount = 0;\r\n      const newAccessToken = fakeJwt({ sub: \"refreshed\" });\r\n\r\n      mockFetch(async () => {\r\n        fetchCallCount++;\r\n        // Simulate a small delay so both callers are waiting\r\n        await new Promise((resolve) => setTimeout(resolve, 10));\r\n        return mockRefreshResponse({\r\n          access_token: newAccessToken,\r\n          refresh_token: \"rt_new\",\r\n          expires_in: 3600,\r\n        });\r\n      });\r\n\r\n      // Fire 3 concurrent calls\r\n      const results = await Promise.all([\r\n        service.getValidAuth(),\r\n        service.getValidAuth(),\r\n        service.getValidAuth(),\r\n      ]);\r\n\r\n      // Only ONE fetch should have happened thanks to AsyncMutex\r\n      expect(fetchCallCount).toBe(1);\r\n\r\n      // All three results should be successful with the refreshed token\r\n      for (const result of results) {\r\n        expect(result.success).toBe(true);\r\n        if (result.success) {\r\n          expect(result.data.access).toBe(newAccessToken);\r\n        }\r\n      }\r\n    });\r\n\r\n    it(\"after refresh, all callers get the updated token\", async () => {\r\n      const expired = expiredAuth();\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      const newAccessToken = fakeJwt({ sub: \"refreshed_user\" });\r\n\r\n      mockFetch(() =>\r\n        Promise.resolve(\r\n          mockRefreshResponse({\r\n            access_token: newAccessToken,\r\n            refresh_token: \"rt_updated\",\r\n            expires_in: 7200,\r\n          })\r\n        )\r\n      );\r\n\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data.access).toBe(newAccessToken);\r\n        expect(result.data.refresh).toBe(\"rt_updated\");\r\n      }\r\n\r\n      // Verify the auth was persisted\r\n      const persistCall = deps.setConfigValueCalls.find(\r\n        (c) => c.provider === \"openai\" && c.keyPath[0] === \"codexOauth\" && c.value !== undefined\r\n      );\r\n      expect(persistCall).toBeDefined();\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Invalid grant cleanup\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"invalid grant cleanup\", () => {\r\n    it(\"calls disconnect + clears stored auth on invalid_grant response\", async () => {\r\n      const expired = expiredAuth();\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      mockFetch(() =>\r\n        Promise.resolve(\r\n          new Response(JSON.stringify({ error: \"invalid_grant\" }), {\r\n            status: 400,\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n          })\r\n        )\r\n      );\r\n\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(false);\r\n\r\n      // Should have called setConfigValue to clear auth (disconnect)\r\n      const clearCall = deps.setConfigValueCalls.find(\r\n        (c) => c.provider === \"openai\" && c.keyPath[0] === \"codexOauth\" && c.value === undefined\r\n      );\r\n      expect(clearCall).toBeDefined();\r\n    });\r\n\r\n    it(\"clears auth when error text contains 'revoked'\", async () => {\r\n      const expired = expiredAuth();\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      mockFetch(() =>\r\n        Promise.resolve(\r\n          new Response(\"Token has been revoked\", {\r\n            status: 401,\r\n          })\r\n        )\r\n      );\r\n\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(false);\r\n\r\n      const clearCall = deps.setConfigValueCalls.find(\r\n        (c) => c.provider === \"openai\" && c.keyPath[0] === \"codexOauth\" && c.value === undefined\r\n      );\r\n      expect(clearCall).toBeDefined();\r\n    });\r\n\r\n    it(\"subsequent getValidAuth returns error after invalid_grant cleanup\", async () => {\r\n      const expired = expiredAuth();\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      mockFetch(() =>\r\n        Promise.resolve(\r\n          new Response(JSON.stringify({ error: \"invalid_grant\" }), {\r\n            status: 400,\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n          })\r\n        )\r\n      );\r\n\r\n      // First call triggers disconnect\r\n      await service.getValidAuth();\r\n\r\n      // Second call should see no stored auth\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"not configured\");\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // disconnect\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"disconnect\", () => {\r\n    it(\"clears stored codexOauth via providerService.setConfigValue\", () => {\r\n      const result = service.disconnect();\r\n      expect(result.success).toBe(true);\r\n      expect(deps.setConfigValueCalls).toHaveLength(1);\r\n      expect(deps.setConfigValueCalls[0]).toEqual({\r\n        provider: \"openai\",\r\n        keyPath: [\"codexOauth\"],\r\n        value: undefined,\r\n      });\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Desktop flow basics\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"startDesktopFlow\", () => {\r\n    it(\"starts HTTP server and returns flowId + authorizeUrl\", async () => {\r\n      const result = await service.startDesktopFlow();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data.flowId).toBeTruthy();\r\n        expect(result.data.authorizeUrl).toContain(\"https://auth.openai.com/oauth/authorize\");\r\n        expect(result.data.authorizeUrl).toContain(\"state=\");\r\n        expect(result.data.authorizeUrl).toContain(\"code_challenge=\");\r\n        expect(result.data.authorizeUrl).toContain(\"code_challenge_method=S256\");\r\n      }\r\n    });\r\n\r\n    it(\"authorize URL contains correct parameters\", async () => {\r\n      const result = await service.startDesktopFlow();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        const url = new URL(result.data.authorizeUrl);\r\n        expect(url.searchParams.get(\"response_type\")).toBe(\"code\");\r\n        expect(url.searchParams.get(\"redirect_uri\")).toBe(\"http://localhost:1455/auth/callback\");\r\n        expect(url.searchParams.get(\"state\")).toBe(result.data.flowId);\r\n        expect(url.searchParams.get(\"originator\")).toBe(\"mux\");\r\n      }\r\n    });\r\n\r\n    it(\"each flow gets a unique flowId\", async () => {\r\n      const first = await service.startDesktopFlow();\r\n      expect(first.success).toBe(true);\r\n      // Clean up the first server so the second can use port 1455\r\n      if (first.success) {\r\n        await service.cancelDesktopFlow(first.data.flowId);\r\n      }\r\n\r\n      const second = await service.startDesktopFlow();\r\n      expect(second.success).toBe(true);\r\n      if (first.success && second.success) {\r\n        expect(first.data.flowId).not.toBe(second.data.flowId);\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"cancelDesktopFlow\", () => {\r\n    it(\"resolves waitForDesktopFlow with cancellation error\", async () => {\r\n      const startResult = await service.startDesktopFlow();\r\n      expect(startResult.success).toBe(true);\r\n      if (!startResult.success) return;\r\n\r\n      const flowId = startResult.data.flowId;\r\n\r\n      // Start waiting (don't await yet)\r\n      const waitPromise = service.waitForDesktopFlow(flowId, { timeoutMs: 5000 });\r\n\r\n      // Cancel the flow\r\n      await service.cancelDesktopFlow(flowId);\r\n\r\n      const result = await waitPromise;\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"cancelled\");\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Token refresh preserves accountId\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"refresh preserves accountId\", () => {\r\n    it(\"keeps previous accountId when refreshed token has no account info\", async () => {\r\n      const expired = expiredAuth({ accountId: \"acct_original\" });\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      // Refreshed token has no account id in JWT claims\r\n      const newAccessToken = fakeJwt({ sub: \"user\" });\r\n\r\n      mockFetch(() =>\r\n        Promise.resolve(\r\n          mockRefreshResponse({\r\n            access_token: newAccessToken,\r\n            refresh_token: \"rt_new\",\r\n            expires_in: 3600,\r\n          })\r\n        )\r\n      );\r\n\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data.accountId).toBe(\"acct_original\");\r\n      }\r\n    });\r\n  });\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Refresh keeps old refresh token when server doesn't rotate it\r\n  // -------------------------------------------------------------------------\r\n\r\n  describe(\"refresh token rotation\", () => {\r\n    it(\"keeps old refresh token when server does not return a new one\", async () => {\r\n      const expired = expiredAuth({ refresh: \"rt_keep_me\" });\r\n      deps.providersConfig = { openai: { codexOauth: expired } };\r\n\r\n      mockFetch(() =>\r\n        Promise.resolve(\r\n          mockRefreshResponse({\r\n            access_token: fakeJwt({ sub: \"user\" }),\r\n            expires_in: 3600,\r\n            // No refresh_token in response\r\n          })\r\n        )\r\n      );\r\n\r\n      const result = await service.getValidAuth();\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data.refresh).toBe(\"rt_keep_me\");\r\n      }\r\n    });\r\n  });\r\n});\r\n"]}