{"version":3,"file":"codexOauthService.test.js","sourceRoot":"","sources":["../../../src/node/services/codexOauthService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\n\nimport type { Result } from \"@/common/types/result\";\nimport { Ok } from \"@/common/types/result\";\nimport type { Config, ProvidersConfig } from \"@/node/config\";\nimport type { ProviderService } from \"@/node/services/providerService\";\nimport type { WindowService } from \"@/node/services/windowService\";\nimport type { CodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\nimport { CodexOauthService } from \"./codexOauthService\";\n\n// ---------------------------------------------------------------------------\n// Helpers\n// ---------------------------------------------------------------------------\n\n/** Encode a claims object into a fake JWT (header.payload.signature). */\nfunction fakeJwt(claims: Record<string, unknown>): string {\n  const header = Buffer.from(JSON.stringify({ alg: \"none\" })).toString(\"base64url\");\n  const payload = Buffer.from(JSON.stringify(claims)).toString(\"base64url\");\n  return `${header}.${payload}.fakesig`;\n}\n\n/** Build a valid CodexOauthAuth that expires far in the future. */\nfunction validAuth(overrides?: Partial<CodexOauthAuth>): CodexOauthAuth {\n  return {\n    type: \"oauth\",\n    access: fakeJwt({ sub: \"user\" }),\n    refresh: \"rt_test\",\n    expires: Date.now() + 3_600_000, // 1h from now\n    ...overrides,\n  };\n}\n\n/** Build a CodexOauthAuth that is already expired. */\nfunction expiredAuth(overrides?: Partial<CodexOauthAuth>): CodexOauthAuth {\n  return validAuth({ expires: Date.now() - 60_000, ...overrides });\n}\n\n/** Build a mock fetch Response for token refresh. */\nfunction mockRefreshResponse(body: Record<string, unknown>, status = 200): Response {\n  return new Response(JSON.stringify(body), {\n    status,\n    headers: { \"Content-Type\": \"application/json\" },\n  });\n}\n\n// ---------------------------------------------------------------------------\n// Mock dependencies\n// ---------------------------------------------------------------------------\n\ninterface MockDeps {\n  providersConfig: ProvidersConfig;\n  setConfigValueCalls: Array<{ provider: string; keyPath: string[]; value: unknown }>;\n  focusCalls: number;\n}\n\nfunction createMockDeps(): MockDeps {\n  return {\n    providersConfig: {},\n    setConfigValueCalls: [],\n    focusCalls: 0,\n  };\n}\n\nfunction createMockConfig(deps: MockDeps): Pick<Config, \"loadProvidersConfig\"> {\n  return {\n    loadProvidersConfig: () => deps.providersConfig,\n  };\n}\n\nfunction createMockProviderService(deps: MockDeps): Pick<ProviderService, \"setConfigValue\"> {\n  return {\n    setConfigValue: (provider: string, keyPath: string[], value: unknown): Result<void, string> => {\n      deps.setConfigValueCalls.push({ provider, keyPath, value });\n      // Also update the in-memory config so readStoredAuth() sees the write\n      if (provider === \"openai\" && keyPath[0] === \"codexOauth\") {\n        if (value === undefined) {\n          const openai = deps.providersConfig.openai;\n          if (openai) {\n            delete openai.codexOauth;\n          }\n        } else {\n          deps.providersConfig.openai ??= {};\n          deps.providersConfig.openai.codexOauth = value;\n        }\n      }\n      return Ok(undefined);\n    },\n  };\n}\n\nfunction createMockWindowService(deps: MockDeps): Pick<WindowService, \"focusMainWindow\"> {\n  return {\n    focusMainWindow: () => {\n      deps.focusCalls++;\n    },\n  };\n}\n\nfunction createService(deps: MockDeps): CodexOauthService {\n  return new CodexOauthService(\n    createMockConfig(deps) as Config,\n    createMockProviderService(deps) as ProviderService,\n    createMockWindowService(deps) as WindowService\n  );\n}\n\n// Helper to mock globalThis.fetch without needing the `preconnect` property.\nfunction mockFetch(fn: (input: RequestInfo | URL, init?: RequestInit) => Promise<Response>): void {\n  globalThis.fetch = Object.assign(fn, {\n    preconnect: (_url: string | URL) => {\n      // no-op in tests\n    },\n  }) as typeof fetch;\n}\n\n// ---------------------------------------------------------------------------\n// Tests\n// ---------------------------------------------------------------------------\n\ndescribe(\"CodexOauthService\", () => {\n  let deps: MockDeps;\n  let service: CodexOauthService;\n  const originalFetch = globalThis.fetch;\n\n  beforeEach(() => {\n    deps = createMockDeps();\n    service = createService(deps);\n  });\n\n  afterEach(async () => {\n    globalThis.fetch = originalFetch;\n    await service.dispose();\n  });\n\n  // -------------------------------------------------------------------------\n  // getValidAuth - basic\n  // -------------------------------------------------------------------------\n\n  describe(\"getValidAuth\", () => {\n    it(\"returns error when no auth is stored\", async () => {\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"not configured\");\n      }\n    });\n\n    it(\"returns stored auth when token is not expired\", async () => {\n      const auth = validAuth();\n      deps.providersConfig = { openai: { codexOauth: auth } };\n\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.access).toBe(auth.access);\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Token refresh coalescing (AsyncMutex)\n  // -------------------------------------------------------------------------\n\n  describe(\"token refresh coalescing\", () => {\n    it(\"only triggers one refresh for concurrent getValidAuth calls with expired tokens\", async () => {\n      const expired = expiredAuth();\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      let fetchCallCount = 0;\n      const newAccessToken = fakeJwt({ sub: \"refreshed\" });\n\n      mockFetch(async () => {\n        fetchCallCount++;\n        // Simulate a small delay so both callers are waiting\n        await new Promise((resolve) => setTimeout(resolve, 10));\n        return mockRefreshResponse({\n          access_token: newAccessToken,\n          refresh_token: \"rt_new\",\n          expires_in: 3600,\n        });\n      });\n\n      // Fire 3 concurrent calls\n      const results = await Promise.all([\n        service.getValidAuth(),\n        service.getValidAuth(),\n        service.getValidAuth(),\n      ]);\n\n      // Only ONE fetch should have happened thanks to AsyncMutex\n      expect(fetchCallCount).toBe(1);\n\n      // All three results should be successful with the refreshed token\n      for (const result of results) {\n        expect(result.success).toBe(true);\n        if (result.success) {\n          expect(result.data.access).toBe(newAccessToken);\n        }\n      }\n    });\n\n    it(\"after refresh, all callers get the updated token\", async () => {\n      const expired = expiredAuth();\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      const newAccessToken = fakeJwt({ sub: \"refreshed_user\" });\n\n      mockFetch(() =>\n        Promise.resolve(\n          mockRefreshResponse({\n            access_token: newAccessToken,\n            refresh_token: \"rt_updated\",\n            expires_in: 7200,\n          })\n        )\n      );\n\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.access).toBe(newAccessToken);\n        expect(result.data.refresh).toBe(\"rt_updated\");\n      }\n\n      // Verify the auth was persisted\n      const persistCall = deps.setConfigValueCalls.find(\n        (c) => c.provider === \"openai\" && c.keyPath[0] === \"codexOauth\" && c.value !== undefined\n      );\n      expect(persistCall).toBeDefined();\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Invalid grant cleanup\n  // -------------------------------------------------------------------------\n\n  describe(\"invalid grant cleanup\", () => {\n    it(\"calls disconnect + clears stored auth on invalid_grant response\", async () => {\n      const expired = expiredAuth();\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      mockFetch(() =>\n        Promise.resolve(\n          new Response(JSON.stringify({ error: \"invalid_grant\" }), {\n            status: 400,\n            headers: { \"Content-Type\": \"application/json\" },\n          })\n        )\n      );\n\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(false);\n\n      // Should have called setConfigValue to clear auth (disconnect)\n      const clearCall = deps.setConfigValueCalls.find(\n        (c) => c.provider === \"openai\" && c.keyPath[0] === \"codexOauth\" && c.value === undefined\n      );\n      expect(clearCall).toBeDefined();\n    });\n\n    it(\"clears auth when error text contains 'revoked'\", async () => {\n      const expired = expiredAuth();\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      mockFetch(() =>\n        Promise.resolve(\n          new Response(\"Token has been revoked\", {\n            status: 401,\n          })\n        )\n      );\n\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(false);\n\n      const clearCall = deps.setConfigValueCalls.find(\n        (c) => c.provider === \"openai\" && c.keyPath[0] === \"codexOauth\" && c.value === undefined\n      );\n      expect(clearCall).toBeDefined();\n    });\n\n    it(\"subsequent getValidAuth returns error after invalid_grant cleanup\", async () => {\n      const expired = expiredAuth();\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      mockFetch(() =>\n        Promise.resolve(\n          new Response(JSON.stringify({ error: \"invalid_grant\" }), {\n            status: 400,\n            headers: { \"Content-Type\": \"application/json\" },\n          })\n        )\n      );\n\n      // First call triggers disconnect\n      await service.getValidAuth();\n\n      // Second call should see no stored auth\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"not configured\");\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // disconnect\n  // -------------------------------------------------------------------------\n\n  describe(\"disconnect\", () => {\n    it(\"clears stored codexOauth via providerService.setConfigValue\", () => {\n      const result = service.disconnect();\n      expect(result.success).toBe(true);\n      expect(deps.setConfigValueCalls).toHaveLength(1);\n      expect(deps.setConfigValueCalls[0]).toEqual({\n        provider: \"openai\",\n        keyPath: [\"codexOauth\"],\n        value: undefined,\n      });\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Desktop flow basics\n  // -------------------------------------------------------------------------\n\n  describe(\"startDesktopFlow\", () => {\n    it(\"starts HTTP server and returns flowId + authorizeUrl\", async () => {\n      const result = await service.startDesktopFlow();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.flowId).toBeTruthy();\n        expect(result.data.authorizeUrl).toContain(\"https://auth.openai.com/oauth/authorize\");\n        expect(result.data.authorizeUrl).toContain(\"state=\");\n        expect(result.data.authorizeUrl).toContain(\"code_challenge=\");\n        expect(result.data.authorizeUrl).toContain(\"code_challenge_method=S256\");\n      }\n    });\n\n    it(\"authorize URL contains correct parameters\", async () => {\n      const result = await service.startDesktopFlow();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        const url = new URL(result.data.authorizeUrl);\n        expect(url.searchParams.get(\"response_type\")).toBe(\"code\");\n        expect(url.searchParams.get(\"redirect_uri\")).toBe(\"http://localhost:1455/auth/callback\");\n        expect(url.searchParams.get(\"state\")).toBe(result.data.flowId);\n        expect(url.searchParams.get(\"originator\")).toBe(\"mux\");\n      }\n    });\n\n    it(\"each flow gets a unique flowId\", async () => {\n      const first = await service.startDesktopFlow();\n      expect(first.success).toBe(true);\n      // Clean up the first server so the second can use port 1455\n      if (first.success) {\n        await service.cancelDesktopFlow(first.data.flowId);\n      }\n\n      const second = await service.startDesktopFlow();\n      expect(second.success).toBe(true);\n      if (first.success && second.success) {\n        expect(first.data.flowId).not.toBe(second.data.flowId);\n      }\n    });\n  });\n\n  describe(\"cancelDesktopFlow\", () => {\n    it(\"resolves waitForDesktopFlow with cancellation error\", async () => {\n      const startResult = await service.startDesktopFlow();\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) return;\n\n      const flowId = startResult.data.flowId;\n\n      // Start waiting (don't await yet)\n      const waitPromise = service.waitForDesktopFlow(flowId, { timeoutMs: 5000 });\n\n      // Cancel the flow\n      await service.cancelDesktopFlow(flowId);\n\n      const result = await waitPromise;\n      expect(result.success).toBe(false);\n      if (!result.success) {\n        expect(result.error).toContain(\"cancelled\");\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Token refresh preserves accountId\n  // -------------------------------------------------------------------------\n\n  describe(\"refresh preserves accountId\", () => {\n    it(\"keeps previous accountId when refreshed token has no account info\", async () => {\n      const expired = expiredAuth({ accountId: \"acct_original\" });\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      // Refreshed token has no account id in JWT claims\n      const newAccessToken = fakeJwt({ sub: \"user\" });\n\n      mockFetch(() =>\n        Promise.resolve(\n          mockRefreshResponse({\n            access_token: newAccessToken,\n            refresh_token: \"rt_new\",\n            expires_in: 3600,\n          })\n        )\n      );\n\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.accountId).toBe(\"acct_original\");\n      }\n    });\n  });\n\n  // -------------------------------------------------------------------------\n  // Refresh keeps old refresh token when server doesn't rotate it\n  // -------------------------------------------------------------------------\n\n  describe(\"refresh token rotation\", () => {\n    it(\"keeps old refresh token when server does not return a new one\", async () => {\n      const expired = expiredAuth({ refresh: \"rt_keep_me\" });\n      deps.providersConfig = { openai: { codexOauth: expired } };\n\n      mockFetch(() =>\n        Promise.resolve(\n          mockRefreshResponse({\n            access_token: fakeJwt({ sub: \"user\" }),\n            expires_in: 3600,\n            // No refresh_token in response\n          })\n        )\n      );\n\n      const result = await service.getValidAuth();\n      expect(result.success).toBe(true);\n      if (result.success) {\n        expect(result.data.refresh).toBe(\"rt_keep_me\");\n      }\n    });\n  });\n});\n"]}