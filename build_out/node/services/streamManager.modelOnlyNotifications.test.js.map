{"version":3,"file":"streamManager.modelOnlyNotifications.test.js","sourceRoot":"","sources":["../../../src/node/services/streamManager.modelOnlyNotifications.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { afterEach, beforeEach, describe, expect, mock, test } from \"bun:test\";\r\n\r\nimport { StreamManager } from \"./streamManager\";\r\n\r\nimport type { HistoryService } from \"./historyService\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { PartialService } from \"./partialService\";\r\n\r\ndescribe(\"StreamManager - model-only tool notifications\", () => {\r\n  let historyService: HistoryService;\r\n  let historyCleanup: () => Promise<void>;\r\n\r\n  beforeEach(async () => {\r\n    ({ historyService, cleanup: historyCleanup } = await createTestHistoryService());\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await historyCleanup();\r\n  });\r\n\r\n  test(\"strips __mux_notifications before emitting tool-call-end\", async () => {\r\n    const partialService: PartialService = {\r\n      writePartial: mock(() => Promise.resolve({ success: true })),\r\n      readPartial: mock(() => Promise.resolve(null)),\r\n      deletePartial: mock(() => Promise.resolve({ success: true })),\r\n      commitToHistory: mock(() => Promise.resolve({ success: true })),\r\n    } as unknown as PartialService;\r\n\r\n    const streamManager = new StreamManager(historyService, partialService);\r\n\r\n    // Avoid tokenizer worker usage in unit tests.\r\n    (streamManager as unknown as { tokenTracker: unknown }).tokenTracker = {\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      setModel: async () => undefined,\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      countTokens: async () => 0,\r\n    };\r\n\r\n    const events: Array<{ toolName?: string; result?: unknown }> = [];\r\n    streamManager.on(\"tool-call-end\", (data: { toolName: string; result: unknown }) => {\r\n      events.push({ toolName: data.toolName, result: data.result });\r\n    });\r\n\r\n    const mockStreamResult = {\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      fullStream: (async function* () {\r\n        yield {\r\n          type: \"tool-call\",\r\n          toolCallId: \"call-1\",\r\n          toolName: \"bash\",\r\n          input: { script: \"echo hi\" },\r\n        };\r\n\r\n        yield {\r\n          type: \"tool-result\",\r\n          toolCallId: \"call-1\",\r\n          toolName: \"bash\",\r\n          output: {\r\n            ok: true,\r\n            __mux_notifications: [\"<notification>hello</notification>\"],\r\n          },\r\n        };\r\n      })(),\r\n      totalUsage: Promise.resolve({ inputTokens: 0, outputTokens: 0, totalTokens: 0 }),\r\n      usage: Promise.resolve({ inputTokens: 0, outputTokens: 0, totalTokens: 0 }),\r\n      providerMetadata: Promise.resolve({}),\r\n      steps: Promise.resolve([]),\r\n    };\r\n\r\n    const streamInfo = {\r\n      state: 2, // STREAMING\r\n      streamResult: mockStreamResult,\r\n      abortController: new AbortController(),\r\n      messageId: \"test-message-1\",\r\n      token: \"test-token\",\r\n      startTime: Date.now(),\r\n      model: \"noop:model\",\r\n      historySequence: 1,\r\n      parts: [],\r\n      lastPartialWriteTime: 0,\r\n      partialWritePromise: undefined,\r\n      partialWriteTimer: undefined,\r\n      processingPromise: Promise.resolve(),\r\n      softInterrupt: { pending: false },\r\n      runtimeTempDir: \"\", // Skip cleanup rm -rf\r\n      runtime: {},\r\n      cumulativeUsage: { inputTokens: 0, outputTokens: 0, totalTokens: 0 },\r\n      cumulativeProviderMetadata: undefined,\r\n      lastStepUsage: undefined,\r\n      lastStepProviderMetadata: undefined,\r\n    };\r\n\r\n    const method = Reflect.get(streamManager, \"processStreamWithCleanup\") as unknown;\r\n    expect(typeof method).toBe(\"function\");\r\n\r\n    await (\r\n      method as (workspaceId: string, streamInfo: unknown, historySequence: number) => Promise<void>\r\n    ).call(streamManager, \"test-workspace\", streamInfo, 1);\r\n\r\n    const toolEnd = events.find((e) => e.toolName === \"bash\");\r\n    expect(toolEnd).toBeDefined();\r\n\r\n    expect(toolEnd?.result && typeof toolEnd.result === \"object\").toBe(true);\r\n    expect(\"__mux_notifications\" in (toolEnd!.result as Record<string, unknown>)).toBe(false);\r\n  });\r\n\r\n  test(\"persists orphan web_search tool-result when tool-call mapping is missing\", async () => {\r\n    const partialService: PartialService = {\r\n      writePartial: mock(() => Promise.resolve({ success: true })),\r\n      readPartial: mock(() => Promise.resolve(null)),\r\n      deletePartial: mock(() => Promise.resolve({ success: true })),\r\n      commitToHistory: mock(() => Promise.resolve({ success: true })),\r\n    } as unknown as PartialService;\r\n\r\n    const streamManager = new StreamManager(historyService, partialService);\r\n\r\n    // Avoid tokenizer worker usage in unit tests.\r\n    (streamManager as unknown as { tokenTracker: unknown }).tokenTracker = {\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      setModel: async () => undefined,\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      countTokens: async () => 0,\r\n    };\r\n\r\n    const events: Array<{ toolName?: string; result?: unknown }> = [];\r\n    streamManager.on(\"tool-call-end\", (data: { toolName: string; result: unknown }) => {\r\n      events.push({ toolName: data.toolName, result: data.result });\r\n    });\r\n\r\n    const mockStreamResult = {\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      fullStream: (async function* () {\r\n        yield {\r\n          type: \"tool-result\",\r\n          toolCallId: \"orphan-web-search-1\",\r\n          toolName: \"web_search\",\r\n          output: {\r\n            type: \"json\",\r\n            value: [\r\n              {\r\n                title: \"Example\",\r\n                url: \"https://example.com\",\r\n                encryptedContent: \"encrypted-payload\",\r\n              },\r\n            ],\r\n          },\r\n        };\r\n      })(),\r\n      totalUsage: Promise.resolve({ inputTokens: 0, outputTokens: 0, totalTokens: 0 }),\r\n      usage: Promise.resolve({ inputTokens: 0, outputTokens: 0, totalTokens: 0 }),\r\n      providerMetadata: Promise.resolve({}),\r\n      steps: Promise.resolve([]),\r\n    };\r\n\r\n    const streamInfo = {\r\n      state: 2, // STREAMING\r\n      streamResult: mockStreamResult,\r\n      abortController: new AbortController(),\r\n      messageId: \"test-message-orphan-web-search\",\r\n      token: \"test-token\",\r\n      startTime: Date.now(),\r\n      model: \"noop:model\",\r\n      historySequence: 1,\r\n      parts: [],\r\n      lastPartialWriteTime: 0,\r\n      partialWritePromise: undefined,\r\n      partialWriteTimer: undefined,\r\n      processingPromise: Promise.resolve(),\r\n      softInterrupt: { pending: false },\r\n      runtimeTempDir: \"\", // Skip cleanup rm -rf\r\n      runtime: {},\r\n      cumulativeUsage: { inputTokens: 0, outputTokens: 0, totalTokens: 0 },\r\n      cumulativeProviderMetadata: undefined,\r\n      lastStepUsage: undefined,\r\n      lastStepProviderMetadata: undefined,\r\n    };\r\n\r\n    const method = Reflect.get(streamManager, \"processStreamWithCleanup\") as unknown;\r\n    expect(typeof method).toBe(\"function\");\r\n\r\n    await (\r\n      method as (workspaceId: string, streamInfo: unknown, historySequence: number) => Promise<void>\r\n    ).call(streamManager, \"test-workspace\", streamInfo, 1);\r\n\r\n    const webSearchPart = streamInfo.parts.find(\r\n      (part: { toolCallId?: string }) => part.toolCallId === \"orphan-web-search-1\"\r\n    ) as\r\n      | {\r\n          state?: string;\r\n          input?: unknown;\r\n          output?: unknown;\r\n        }\r\n      | undefined;\r\n\r\n    expect(webSearchPart).toBeDefined();\r\n    expect(webSearchPart?.state).toBe(\"output-available\");\r\n    expect(webSearchPart?.input).toBeNull();\r\n\r\n    expect(webSearchPart?.output && typeof webSearchPart.output === \"object\").toBe(true);\r\n    const outputRecord = webSearchPart?.output as Record<string, unknown> | undefined;\r\n    expect(outputRecord?.type).toBe(\"json\");\r\n\r\n    expect(Array.isArray(outputRecord?.value)).toBe(true);\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment -- test assertion on dynamic tool output shape\r\n    const firstResult = Array.isArray(outputRecord?.value) ? outputRecord.value[0] : undefined;\r\n    expect(firstResult && typeof firstResult === \"object\").toBe(true);\r\n    if (!firstResult || typeof firstResult !== \"object\") {\r\n      throw new Error(\"Expected first web_search result object\");\r\n    }\r\n    expect(\"encryptedContent\" in firstResult).toBe(false);\r\n\r\n    const toolEnd = events.find((event) => event.toolName === \"web_search\");\r\n    expect(toolEnd).toBeDefined();\r\n  });\r\n});\r\n"]}