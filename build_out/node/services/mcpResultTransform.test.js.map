{"version":3,"file":"mcpResultTransform.test.js","sourceRoot":"","sources":["../../../src/node/services/mcpResultTransform.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport { transformMCPResult, MAX_IMAGE_DATA_BYTES } from \"./mcpResultTransform\";\r\n\r\ndescribe(\"transformMCPResult\", () => {\r\n  describe(\"image data overflow handling\", () => {\r\n    it(\"should pass through small images unchanged\", () => {\r\n      const smallImageData = \"a\".repeat(1000); // 1KB of base64 data\r\n      const result = transformMCPResult({\r\n        content: [\r\n          { type: \"text\", text: \"Screenshot taken\" },\r\n          { type: \"image\", data: smallImageData, mimeType: \"image/png\" },\r\n        ],\r\n      });\r\n\r\n      expect(result).toEqual({\r\n        type: \"content\",\r\n        value: [\r\n          { type: \"text\", text: \"Screenshot taken\" },\r\n          { type: \"media\", data: smallImageData, mediaType: \"image/png\" },\r\n        ],\r\n      });\r\n    });\r\n\r\n    it(\"should omit large image data to prevent context overflow\", () => {\r\n      // Create a large base64 string that simulates a screenshot\r\n      // Even 50KB of base64 would be ~12,500 tokens when treated as text\r\n      const largeImageData = \"x\".repeat(MAX_IMAGE_DATA_BYTES + 10_000);\r\n      const result = transformMCPResult({\r\n        content: [\r\n          { type: \"text\", text: \"Screenshot taken\" },\r\n          { type: \"image\", data: largeImageData, mimeType: \"image/png\" },\r\n        ],\r\n      });\r\n\r\n      const transformed = result as {\r\n        type: \"content\";\r\n        value: Array<{ type: string; text?: string; data?: string; mediaType?: string }>;\r\n      };\r\n\r\n      expect(transformed.type).toBe(\"content\");\r\n      expect(transformed.value).toHaveLength(2);\r\n      expect(transformed.value[0]).toEqual({ type: \"text\", text: \"Screenshot taken\" });\r\n\r\n      // The image should be replaced with a text message explaining why it was omitted\r\n      const imageResult = transformed.value[1];\r\n      expect(imageResult.type).toBe(\"text\");\r\n      expect(imageResult.text).toContain(\"Image omitted\");\r\n      expect(imageResult.text).toContain(\"per-image guard\");\r\n    });\r\n\r\n    it(\"should handle multiple images, omitting only the oversized ones\", () => {\r\n      const smallImageData = \"small\".repeat(100);\r\n      const largeImageData = \"x\".repeat(MAX_IMAGE_DATA_BYTES + 5_000);\r\n\r\n      const result = transformMCPResult({\r\n        content: [\r\n          { type: \"image\", data: smallImageData, mimeType: \"image/png\" },\r\n          { type: \"image\", data: largeImageData, mimeType: \"image/jpeg\" },\r\n        ],\r\n      });\r\n\r\n      const transformed = result as {\r\n        type: \"content\";\r\n        value: Array<{ type: string; text?: string; data?: string; mediaType?: string }>;\r\n      };\r\n\r\n      expect(transformed.value).toHaveLength(2);\r\n      // Small image passes through\r\n      expect(transformed.value[0]).toEqual({\r\n        type: \"media\",\r\n        data: smallImageData,\r\n        mediaType: \"image/png\",\r\n      });\r\n      // Large image gets omitted with explanation\r\n      expect(transformed.value[1].type).toBe(\"text\");\r\n      expect(transformed.value[1].text).toContain(\"Image omitted\");\r\n    });\r\n\r\n    it(\"should mention size and guard limit in omission message\", () => {\r\n      // 100KB of base64 data should trigger the guard if limit is smaller, but we keep it big here\r\n      const largeImageData = \"y\".repeat(MAX_IMAGE_DATA_BYTES + 1_000);\r\n      const result = transformMCPResult({\r\n        content: [{ type: \"image\", data: largeImageData, mimeType: \"image/png\" }],\r\n      });\r\n\r\n      const transformed = result as {\r\n        type: \"content\";\r\n        value: Array<{ type: string; text?: string }>;\r\n      };\r\n\r\n      expect(transformed.value[0].type).toBe(\"text\");\r\n      // Should mention size and guard\r\n      expect(transformed.value[0].text).toMatch(/Image omitted/);\r\n      expect(transformed.value[0].text).toMatch(/per-image guard/i);\r\n      expect(transformed.value[0].text).toMatch(/MB|KB/);\r\n    });\r\n  });\r\n\r\n  describe(\"existing functionality\", () => {\r\n    it(\"should pass through error results unchanged\", () => {\r\n      const errorResult = {\r\n        isError: true,\r\n        content: [{ type: \"text\" as const, text: \"Error!\" }],\r\n      };\r\n      expect(transformMCPResult(errorResult)).toBe(errorResult);\r\n    });\r\n\r\n    it(\"should pass through toolResult unchanged\", () => {\r\n      const toolResult = { toolResult: { foo: \"bar\" } };\r\n      expect(transformMCPResult(toolResult)).toBe(toolResult);\r\n    });\r\n\r\n    it(\"should pass through results without content array\", () => {\r\n      const noContent = { something: \"else\" };\r\n      expect(transformMCPResult(noContent as never)).toBe(noContent);\r\n    });\r\n\r\n    it(\"should pass through text-only content without transformation wrapper\", () => {\r\n      const textOnly = {\r\n        content: [\r\n          { type: \"text\" as const, text: \"Hello\" },\r\n          { type: \"text\" as const, text: \"World\" },\r\n        ],\r\n      };\r\n      // No images = no transformation needed\r\n      expect(transformMCPResult(textOnly)).toBe(textOnly);\r\n    });\r\n\r\n    it(\"should convert resource content to text\", () => {\r\n      const result = transformMCPResult({\r\n        content: [\r\n          { type: \"image\", data: \"abc\", mimeType: \"image/png\" },\r\n          { type: \"resource\", resource: { uri: \"file:///test.txt\", text: \"File content\" } },\r\n        ],\r\n      });\r\n\r\n      const transformed = result as {\r\n        type: \"content\";\r\n        value: Array<{ type: string; text?: string; data?: string }>;\r\n      };\r\n\r\n      expect(transformed.value[1]).toEqual({ type: \"text\", text: \"File content\" });\r\n    });\r\n\r\n    it(\"should default to image/png when mimeType is missing\", () => {\r\n      const result = transformMCPResult({\r\n        content: [{ type: \"image\", data: \"abc\", mimeType: \"\" }],\r\n      });\r\n\r\n      const transformed = result as {\r\n        type: \"content\";\r\n        value: Array<{ type: string; mediaType?: string }>;\r\n      };\r\n\r\n      expect(transformed.value[0].mediaType).toBe(\"image/png\");\r\n    });\r\n  });\r\n});\r\n"]}