{"version":3,"file":"taskUtils.js","sourceRoot":"","sources":["../../../src/node/services/taskUtils.ts"],"names":[],"mappings":";;;;;;;;;AAAA;;;GAGG;AACH,gEAAwC;AAGxC,0DAA4D;AAE5D,8BAAqC,KAAc,EAAsB;IACvE,IAAI,OAAO,KAAK,KAAK,QAAQ;QAAE,OAAO,SAAS,CAAC;IAChD,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;IAC7B,OAAO,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;AAAA,CACjD;AAEM,KAAK,kCACV,OAAgB,EAChB,aAAqB,EACQ;IAC7B,IAAA,gBAAM,EAAC,aAAa,CAAC,MAAM,GAAG,CAAC,EAAE,0DAA0D,CAAC,CAAC;IAE7F,IAAI,CAAC;QACH,MAAM,MAAM,GAAG,MAAM,IAAA,sBAAY,EAAC,OAAO,EAAE,oBAAoB,EAAE;YAC/D,GAAG,EAAE,aAAa;YAClB,OAAO,EAAE,EAAE;SACZ,CAAC,CAAC;QACH,IAAI,MAAM,CAAC,QAAQ,KAAK,CAAC,EAAE,CAAC;YAC1B,OAAO,SAAS,CAAC;QACnB,CAAC;QAED,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QACjC,OAAO,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CAAC;IAC1C,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,SAAS,CAAC;IACnB,CAAC;AAAA,CACF;AAED,4BACE,MAAiD,EACjD,WAAmB,EAC8C;IACjE,KAAK,MAAM,CAAC,WAAW,EAAE,OAAO,CAAC,IAAI,MAAM,CAAC,QAAQ,EAAE,CAAC;QACrD,KAAK,MAAM,SAAS,IAAI,OAAO,CAAC,UAAU,EAAE,CAAC;YAC3C,IAAI,SAAS,CAAC,EAAE,KAAK,WAAW,EAAE,CAAC;gBACjC,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,CAAC;YACpC,CAAC;QACH,CAAC;IACH,CAAC;IACD,OAAO,IAAI,CAAC;AAAA,CACb;AAED;;;GAGG;AACH,gCACE,MAAiD,EACjD,WAAmB,EACX;IACR,MAAM,UAAU,GAAG,IAAI,GAAG,EAA8B,CAAC;IACzD,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,EAAE,CAAC;QAC/C,KAAK,MAAM,SAAS,IAAI,OAAO,CAAC,UAAU,EAAE,CAAC;YAC3C,IAAI,CAAC,SAAS,CAAC,EAAE;gBAAE,SAAS;YAC5B,UAAU,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,EAAE,SAAS,CAAC,iBAAiB,CAAC,CAAC;QAC5D,CAAC;IACH,CAAC;IAED,IAAI,KAAK,GAAG,CAAC,CAAC;IACd,IAAI,OAAO,GAAG,WAAW,CAAC;IAC1B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;QAC5B,MAAM,MAAM,GAAG,UAAU,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACvC,IAAI,CAAC,MAAM;YAAE,MAAM;QACnB,KAAK,IAAI,CAAC,CAAC;QACX,OAAO,GAAG,MAAM,CAAC;IACnB,CAAC;IAED,IAAI,KAAK,IAAI,EAAE,EAAE,CAAC;QAChB,MAAM,IAAI,KAAK,CACb,wEAAwE,WAAW,EAAE,CACtF,CAAC;IACJ,CAAC;IAED,OAAO,KAAK,CAAC;AAAA,CACd","sourcesContent":["/**\r\n * Small pure helpers shared by TaskService and GitPatchArtifactService.\r\n * Extracted to a standalone module to avoid circular imports.\r\n */\r\nimport assert from \"node:assert/strict\";\r\nimport type { Config, Workspace as WorkspaceConfigEntry } from \"@/node/config\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\r\n\r\nexport function coerceNonEmptyString(value: unknown): string | undefined {\r\n  if (typeof value !== \"string\") return undefined;\r\n  const trimmed = value.trim();\r\n  return trimmed.length > 0 ? trimmed : undefined;\r\n}\r\n\r\nexport async function tryReadGitHeadCommitSha(\r\n  runtime: Runtime,\r\n  workspacePath: string\r\n): Promise<string | undefined> {\r\n  assert(workspacePath.length > 0, \"tryReadGitHeadCommitSha: workspacePath must be non-empty\");\r\n\r\n  try {\r\n    const result = await execBuffered(runtime, \"git rev-parse HEAD\", {\r\n      cwd: workspacePath,\r\n      timeout: 10,\r\n    });\r\n    if (result.exitCode !== 0) {\r\n      return undefined;\r\n    }\r\n\r\n    const sha = result.stdout.trim();\r\n    return sha.length > 0 ? sha : undefined;\r\n  } catch {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport function findWorkspaceEntry(\r\n  config: ReturnType<Config[\"loadConfigOrDefault\"]>,\r\n  workspaceId: string\r\n): { projectPath: string; workspace: WorkspaceConfigEntry } | null {\r\n  for (const [projectPath, project] of config.projects) {\r\n    for (const workspace of project.workspaces) {\r\n      if (workspace.id === workspaceId) {\r\n        return { projectPath, workspace };\r\n      }\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Walk the parentWorkspaceId chain to compute task nesting depth.\r\n * Detects cycles (max 32 hops).\r\n */\r\nexport function getTaskDepthFromConfig(\r\n  config: ReturnType<Config[\"loadConfigOrDefault\"]>,\r\n  workspaceId: string\r\n): number {\r\n  const parentById = new Map<string, string | undefined>();\r\n  for (const project of config.projects.values()) {\r\n    for (const workspace of project.workspaces) {\r\n      if (!workspace.id) continue;\r\n      parentById.set(workspace.id, workspace.parentWorkspaceId);\r\n    }\r\n  }\r\n\r\n  let depth = 0;\r\n  let current = workspaceId;\r\n  for (let i = 0; i < 32; i++) {\r\n    const parent = parentById.get(current);\r\n    if (!parent) break;\r\n    depth += 1;\r\n    current = parent;\r\n  }\r\n\r\n  if (depth >= 32) {\r\n    throw new Error(\r\n      `getTaskDepthFromConfig: possible parentWorkspaceId cycle starting at ${workspaceId}`\r\n    );\r\n  }\r\n\r\n  return depth;\r\n}\r\n"]}