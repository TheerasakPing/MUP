{"version":3,"file":"taskUtils.js","sourceRoot":"","sources":["../../../src/node/services/taskUtils.ts"],"names":[],"mappings":";;;;;;;;;AAAA;;;GAGG;AACH,gEAAwC;AAGxC,0DAA4D;AAE5D,8BAAqC,KAAc,EAAsB;IACvE,IAAI,OAAO,KAAK,KAAK,QAAQ;QAAE,OAAO,SAAS,CAAC;IAChD,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;IAC7B,OAAO,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;AAAA,CACjD;AAEM,KAAK,kCACV,OAAgB,EAChB,aAAqB,EACQ;IAC7B,IAAA,gBAAM,EAAC,aAAa,CAAC,MAAM,GAAG,CAAC,EAAE,0DAA0D,CAAC,CAAC;IAE7F,IAAI,CAAC;QACH,MAAM,MAAM,GAAG,MAAM,IAAA,sBAAY,EAAC,OAAO,EAAE,oBAAoB,EAAE;YAC/D,GAAG,EAAE,aAAa;YAClB,OAAO,EAAE,EAAE;SACZ,CAAC,CAAC;QACH,IAAI,MAAM,CAAC,QAAQ,KAAK,CAAC,EAAE,CAAC;YAC1B,OAAO,SAAS,CAAC;QACnB,CAAC;QAED,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QACjC,OAAO,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CAAC;IAC1C,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,SAAS,CAAC;IACnB,CAAC;AAAA,CACF;AAED,4BACE,MAAiD,EACjD,WAAmB,EAC8C;IACjE,KAAK,MAAM,CAAC,WAAW,EAAE,OAAO,CAAC,IAAI,MAAM,CAAC,QAAQ,EAAE,CAAC;QACrD,KAAK,MAAM,SAAS,IAAI,OAAO,CAAC,UAAU,EAAE,CAAC;YAC3C,IAAI,SAAS,CAAC,EAAE,KAAK,WAAW,EAAE,CAAC;gBACjC,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,CAAC;YACpC,CAAC;QACH,CAAC;IACH,CAAC;IACD,OAAO,IAAI,CAAC;AAAA,CACb;AAED;;;GAGG;AACH,gCACE,MAAiD,EACjD,WAAmB,EACX;IACR,MAAM,UAAU,GAAG,IAAI,GAAG,EAA8B,CAAC;IACzD,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,EAAE,CAAC;QAC/C,KAAK,MAAM,SAAS,IAAI,OAAO,CAAC,UAAU,EAAE,CAAC;YAC3C,IAAI,CAAC,SAAS,CAAC,EAAE;gBAAE,SAAS;YAC5B,UAAU,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,EAAE,SAAS,CAAC,iBAAiB,CAAC,CAAC;QAC5D,CAAC;IACH,CAAC;IAED,IAAI,KAAK,GAAG,CAAC,CAAC;IACd,IAAI,OAAO,GAAG,WAAW,CAAC;IAC1B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;QAC5B,MAAM,MAAM,GAAG,UAAU,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACvC,IAAI,CAAC,MAAM;YAAE,MAAM;QACnB,KAAK,IAAI,CAAC,CAAC;QACX,OAAO,GAAG,MAAM,CAAC;IACnB,CAAC;IAED,IAAI,KAAK,IAAI,EAAE,EAAE,CAAC;QAChB,MAAM,IAAI,KAAK,CACb,wEAAwE,WAAW,EAAE,CACtF,CAAC;IACJ,CAAC;IAED,OAAO,KAAK,CAAC;AAAA,CACd","sourcesContent":["/**\n * Small pure helpers shared by TaskService and GitPatchArtifactService.\n * Extracted to a standalone module to avoid circular imports.\n */\nimport assert from \"node:assert/strict\";\nimport type { Config, Workspace as WorkspaceConfigEntry } from \"@/node/config\";\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\n\nexport function coerceNonEmptyString(value: unknown): string | undefined {\n  if (typeof value !== \"string\") return undefined;\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : undefined;\n}\n\nexport async function tryReadGitHeadCommitSha(\n  runtime: Runtime,\n  workspacePath: string\n): Promise<string | undefined> {\n  assert(workspacePath.length > 0, \"tryReadGitHeadCommitSha: workspacePath must be non-empty\");\n\n  try {\n    const result = await execBuffered(runtime, \"git rev-parse HEAD\", {\n      cwd: workspacePath,\n      timeout: 10,\n    });\n    if (result.exitCode !== 0) {\n      return undefined;\n    }\n\n    const sha = result.stdout.trim();\n    return sha.length > 0 ? sha : undefined;\n  } catch {\n    return undefined;\n  }\n}\n\nexport function findWorkspaceEntry(\n  config: ReturnType<Config[\"loadConfigOrDefault\"]>,\n  workspaceId: string\n): { projectPath: string; workspace: WorkspaceConfigEntry } | null {\n  for (const [projectPath, project] of config.projects) {\n    for (const workspace of project.workspaces) {\n      if (workspace.id === workspaceId) {\n        return { projectPath, workspace };\n      }\n    }\n  }\n  return null;\n}\n\n/**\n * Walk the parentWorkspaceId chain to compute task nesting depth.\n * Detects cycles (max 32 hops).\n */\nexport function getTaskDepthFromConfig(\n  config: ReturnType<Config[\"loadConfigOrDefault\"]>,\n  workspaceId: string\n): number {\n  const parentById = new Map<string, string | undefined>();\n  for (const project of config.projects.values()) {\n    for (const workspace of project.workspaces) {\n      if (!workspace.id) continue;\n      parentById.set(workspace.id, workspace.parentWorkspaceId);\n    }\n  }\n\n  let depth = 0;\n  let current = workspaceId;\n  for (let i = 0; i < 32; i++) {\n    const parent = parentById.get(current);\n    if (!parent) break;\n    depth += 1;\n    current = parent;\n  }\n\n  if (depth >= 32) {\n    throw new Error(\n      `getTaskDepthFromConfig: possible parentWorkspaceId cycle starting at ${workspaceId}`\n    );\n  }\n\n  return depth;\n}\n"]}