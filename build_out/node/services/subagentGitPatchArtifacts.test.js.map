{"version":3,"file":"subagentGitPatchArtifacts.test.js","sourceRoot":"","sources":["../../../src/node/services/subagentGitPatchArtifacts.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\n\r\nimport {\r\n  getSubagentGitPatchArtifactsFilePath,\r\n  markSubagentGitPatchArtifactApplied,\r\n  readSubagentGitPatchArtifactsFile,\r\n  upsertSubagentGitPatchArtifact,\r\n} from \"@/node/services/subagentGitPatchArtifacts\";\r\n\r\ndescribe(\"subagentGitPatchArtifacts\", () => {\r\n  let testDir: string;\r\n\r\n  beforeEach(async () => {\r\n    testDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-subagent-git-patch-\"));\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fsPromises.rm(testDir, { recursive: true, force: true });\r\n  });\r\n\r\n  test(\"readSubagentGitPatchArtifactsFile returns empty file when missing\", async () => {\r\n    const file = await readSubagentGitPatchArtifactsFile(testDir);\r\n    expect(file.version).toBe(1);\r\n    expect(file.artifactsByChildTaskId).toEqual({});\r\n  });\r\n\r\n  test(\"upsertSubagentGitPatchArtifact writes and updates artifacts\", async () => {\r\n    const workspaceId = \"parent-1\";\r\n    const childTaskId = \"child-1\";\r\n\r\n    const createdAtMs = Date.now();\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: testDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs,\r\n        updatedAtMs: createdAtMs,\r\n        status: \"ready\",\r\n        commitCount: 2,\r\n        mboxPath: \"/tmp/series.mbox\",\r\n      }),\r\n    });\r\n\r\n    const pathOnDisk = getSubagentGitPatchArtifactsFilePath(testDir);\r\n    await fsPromises.stat(pathOnDisk);\r\n\r\n    const file = await readSubagentGitPatchArtifactsFile(testDir);\r\n    const artifact = file.artifactsByChildTaskId[childTaskId];\r\n    expect(artifact).toBeTruthy();\r\n    expect(artifact?.childTaskId).toBe(childTaskId);\r\n    expect(artifact?.parentWorkspaceId).toBe(workspaceId);\r\n    expect(artifact?.createdAtMs).toBe(createdAtMs);\r\n    expect(artifact?.status).toBe(\"ready\");\r\n    expect(artifact?.commitCount).toBe(2);\r\n  });\r\n\r\n  test(\"markSubagentGitPatchArtifactApplied sets appliedAtMs\", async () => {\r\n    const workspaceId = \"parent-1\";\r\n    const childTaskId = \"child-1\";\r\n    const createdAtMs = Date.now();\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: testDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs,\r\n        updatedAtMs: createdAtMs,\r\n        status: \"ready\",\r\n        commitCount: 1,\r\n        mboxPath: \"/tmp/series.mbox\",\r\n      }),\r\n    });\r\n\r\n    const appliedAtMs = createdAtMs + 1234;\r\n    const updated = await markSubagentGitPatchArtifactApplied({\r\n      workspaceId,\r\n      workspaceSessionDir: testDir,\r\n      childTaskId,\r\n      appliedAtMs,\r\n    });\r\n\r\n    expect(updated?.appliedAtMs).toBe(appliedAtMs);\r\n    expect(updated?.updatedAtMs).toBe(appliedAtMs);\r\n\r\n    const file = await readSubagentGitPatchArtifactsFile(testDir);\r\n    expect(file.artifactsByChildTaskId[childTaskId]?.appliedAtMs).toBe(appliedAtMs);\r\n  });\r\n});\r\n"]}