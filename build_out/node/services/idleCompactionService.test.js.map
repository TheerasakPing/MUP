{"version":3,"file":"idleCompactionService.test.js","sourceRoot":"","sources":["../../../src/node/services/idleCompactionService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, beforeEach, mock, afterEach, spyOn } from \"bun:test\";\nimport { IdleCompactionService } from \"./idleCompactionService\";\nimport type { Config } from \"@/node/config\";\nimport type { HistoryService } from \"./historyService\";\nimport type { ExtensionMetadataService } from \"./ExtensionMetadataService\";\nimport type { ProjectConfig, ProjectsConfig } from \"@/common/types/project\";\nimport { createMuxMessage } from \"@/common/types/message\";\nimport { Ok } from \"@/common/types/result\";\nimport { createTestHistoryService } from \"./testHistoryService\";\n\ndescribe(\"IdleCompactionService\", () => {\n  // Mock services\n  let mockConfig: Config;\n  let historyService: HistoryService;\n  let mockExtensionMetadata: ExtensionMetadataService;\n  let emitIdleCompactionNeededMock: ReturnType<typeof mock<(workspaceId: string) => void>>;\n  let service: IdleCompactionService;\n  let cleanup: () => Promise<void>;\n\n  // Test data\n  const testWorkspaceId = \"test-workspace-id\";\n  const testProjectPath = \"/test/project\";\n  const now = Date.now();\n  const oneHourMs = 60 * 60 * 1000;\n\n  beforeEach(async () => {\n    // Create mock config\n    mockConfig = {\n      loadConfigOrDefault: mock(() => ({\n        projects: new Map<string, ProjectConfig>([\n          [\n            testProjectPath,\n            {\n              workspaces: [{ id: testWorkspaceId, path: \"/test/path\", name: \"test\" }],\n              idleCompactionHours: 24,\n            },\n          ],\n        ]),\n      })),\n    } as unknown as Config;\n\n    // Create real history service and seed default idle messages (25 hours ago)\n    ({ historyService, cleanup } = await createTestHistoryService());\n    const idleTimestamp = now - 25 * oneHourMs;\n    await historyService.appendToHistory(\n      testWorkspaceId,\n      createMuxMessage(\"1\", \"user\", \"Hello\", { timestamp: idleTimestamp })\n    );\n    await historyService.appendToHistory(\n      testWorkspaceId,\n      createMuxMessage(\"2\", \"assistant\", \"Hi there!\", { timestamp: idleTimestamp })\n    );\n\n    // Create mock extension metadata service\n    mockExtensionMetadata = {\n      getMetadata: mock(() =>\n        Promise.resolve({\n          workspaceId: testWorkspaceId,\n          recency: now - 25 * oneHourMs, // 25 hours ago\n          streaming: false,\n          lastModel: null,\n          lastThinkingLevel: null,\n          updatedAt: now - 25 * oneHourMs,\n        })\n      ),\n    } as unknown as ExtensionMetadataService;\n\n    // Create mock for emitIdleCompactionNeeded callback\n    emitIdleCompactionNeededMock = mock(() => {\n      // noop mock\n    });\n\n    // Create service with callback\n    service = new IdleCompactionService(\n      mockConfig,\n      historyService,\n      mockExtensionMetadata,\n      emitIdleCompactionNeededMock\n    );\n  });\n\n  afterEach(async () => {\n    service.stop();\n    await cleanup();\n  });\n\n  describe(\"checkEligibility\", () => {\n    const threshold24h = 24 * oneHourMs;\n\n    test(\"returns eligible for idle workspace with messages\", async () => {\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(true);\n    });\n\n    test(\"returns ineligible when workspace is currently streaming\", async () => {\n      // Idle messages already seeded in beforeEach; workspace is streaming\n      const idleTimestamp = now - 25 * oneHourMs;\n      (mockExtensionMetadata.getMetadata as ReturnType<typeof mock>).mockResolvedValueOnce({\n        workspaceId: testWorkspaceId,\n        recency: idleTimestamp,\n        streaming: true, // Currently streaming\n        lastModel: null,\n        lastThinkingLevel: null,\n        updatedAt: idleTimestamp,\n      });\n\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(false);\n      expect(result.reason).toBe(\"currently_streaming\");\n    });\n\n    test(\"returns ineligible when workspace has no messages\", async () => {\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(Ok([]));\n\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(false);\n      expect(result.reason).toBe(\"no_messages\");\n    });\n\n    test(\"returns ineligible when last message is already compacted\", async () => {\n      const idleTimestamp = now - 25 * oneHourMs;\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\n        Ok([\n          createMuxMessage(\"1\", \"assistant\", \"Summary\", {\n            compacted: true,\n            timestamp: idleTimestamp,\n          }),\n        ])\n      );\n\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(false);\n      expect(result.reason).toBe(\"already_compacted\");\n    });\n\n    test(\"returns ineligible when not idle long enough\", async () => {\n      // Messages with recent timestamps (only 1 hour ago)\n      const recentTimestamp = now - 1 * oneHourMs;\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\n        Ok([\n          createMuxMessage(\"1\", \"user\", \"Hello\", { timestamp: recentTimestamp }),\n          createMuxMessage(\"2\", \"assistant\", \"Hi!\", { timestamp: recentTimestamp }),\n        ])\n      );\n\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(false);\n      expect(result.reason).toBe(\"not_idle_enough\");\n    });\n\n    test(\"returns ineligible when last message is from user (awaiting response)\", async () => {\n      const idleTimestamp = now - 25 * oneHourMs;\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\n        Ok([\n          createMuxMessage(\"1\", \"user\", \"Hello\", { timestamp: idleTimestamp }),\n          createMuxMessage(\"2\", \"assistant\", \"Hi!\", { timestamp: idleTimestamp }),\n          createMuxMessage(\"3\", \"user\", \"Another question?\", { timestamp: idleTimestamp }), // Last message is user\n        ])\n      );\n\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(false);\n      expect(result.reason).toBe(\"awaiting_response\");\n    });\n\n    test(\"returns ineligible when messages have no timestamps\", async () => {\n      // Messages without timestamps - can't determine recency\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\n        Ok([createMuxMessage(\"1\", \"user\", \"Hello\"), createMuxMessage(\"2\", \"assistant\", \"Hi!\")])\n      );\n\n      const result = await service.checkEligibility(testWorkspaceId, threshold24h, now);\n      expect(result.eligible).toBe(false);\n      expect(result.reason).toBe(\"no_recency_data\");\n    });\n  });\n\n  describe(\"checkAllWorkspaces\", () => {\n    test(\"skips projects without idleCompactionHours set\", async () => {\n      (mockConfig.loadConfigOrDefault as ReturnType<typeof mock>).mockReturnValueOnce({\n        projects: new Map([\n          [\n            testProjectPath,\n            {\n              workspaces: [{ id: testWorkspaceId, path: \"/test/path\", name: \"test\" }],\n              // idleCompactionHours not set\n            },\n          ],\n        ]),\n      } as ProjectsConfig);\n\n      await service.checkAllWorkspaces();\n\n      // Should not attempt to notify\n      expect(emitIdleCompactionNeededMock).not.toHaveBeenCalled();\n    });\n\n    test(\"marks workspace as needing compaction when eligible\", async () => {\n      await service.checkAllWorkspaces();\n\n      // Should have emitted idle compaction needed event\n      expect(emitIdleCompactionNeededMock).toHaveBeenCalledTimes(1);\n      expect(emitIdleCompactionNeededMock).toHaveBeenCalledWith(testWorkspaceId);\n    });\n\n    test(\"continues checking other workspaces if one fails\", async () => {\n      // Setup two workspaces in different projects\n      const workspace2Id = \"workspace-2\";\n      const idleTimestamp = now - 25 * oneHourMs;\n      (mockConfig.loadConfigOrDefault as ReturnType<typeof mock>).mockReturnValueOnce({\n        projects: new Map([\n          [\n            testProjectPath,\n            {\n              workspaces: [{ id: testWorkspaceId, path: \"/test/path\", name: \"test\" }],\n              idleCompactionHours: 24,\n            },\n          ],\n          [\n            \"/another/project\",\n            {\n              workspaces: [{ id: workspace2Id, path: \"/another/path\", name: \"test2\" }],\n              idleCompactionHours: 24,\n            },\n          ],\n        ]),\n      } as ProjectsConfig);\n\n      // Make first workspace fail eligibility check (history throws)\n      let callCount = 0;\n      spyOn(historyService, \"getLastMessages\").mockImplementation(() => {\n        callCount++;\n        if (callCount === 1) {\n          throw new Error(\"History fetch failed\");\n        }\n        return Promise.resolve(\n          Ok([\n            createMuxMessage(\"1\", \"user\", \"Hello\", { timestamp: idleTimestamp }),\n            createMuxMessage(\"2\", \"assistant\", \"Hi!\", { timestamp: idleTimestamp }),\n          ])\n        );\n      });\n\n      await service.checkAllWorkspaces();\n\n      // Should still have tried to process the second workspace\n      expect(callCount).toBe(2);\n    });\n  });\n\n  describe(\"workspace ID resolution\", () => {\n    test(\"falls back to workspace name when id is not set\", async () => {\n      const workspaceName = \"test-workspace-name\";\n      const idleTimestamp = now - 25 * oneHourMs;\n      (mockConfig.loadConfigOrDefault as ReturnType<typeof mock>).mockReturnValueOnce({\n        projects: new Map([\n          [\n            testProjectPath,\n            {\n              workspaces: [{ name: workspaceName, path: \"/test/path\" }], // No id field\n              idleCompactionHours: 24,\n            },\n          ],\n        ]),\n      });\n\n      // Spy on history to return idle messages for the name-based ID\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\n        Ok([\n          createMuxMessage(\"1\", \"user\", \"Hello\", { timestamp: idleTimestamp }),\n          createMuxMessage(\"2\", \"assistant\", \"Hi!\", { timestamp: idleTimestamp }),\n        ])\n      );\n\n      await service.checkAllWorkspaces();\n\n      // Should have emitted with the name as workspaceId\n      expect(emitIdleCompactionNeededMock).toHaveBeenCalledWith(workspaceName);\n    });\n\n    test(\"skips workspace when neither id nor name is set\", async () => {\n      (mockConfig.loadConfigOrDefault as ReturnType<typeof mock>).mockReturnValueOnce({\n        projects: new Map([\n          [\n            testProjectPath,\n            {\n              workspaces: [{ path: \"/test/path\" }], // No id or name\n              idleCompactionHours: 24,\n            },\n          ],\n        ]),\n      });\n\n      await service.checkAllWorkspaces();\n\n      // Should not attempt any compaction\n      expect(emitIdleCompactionNeededMock).not.toHaveBeenCalled();\n    });\n  });\n});\n"]}