{"version":3,"file":"historyService.test.js","sourceRoot":"","sources":["../../../src/node/services/historyService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport { HistoryService } from \"./historyService\";\r\nimport { Config } from \"@/node/config\";\r\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\r\nimport assert from \"node:assert\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\n\r\n/** Collect all messages via iterateFullHistory (replaces removed getFullHistory). */\r\nasync function collectFullHistory(service: HistoryService, workspaceId: string) {\r\n  const messages: MuxMessage[] = [];\r\n  const result = await service.iterateFullHistory(workspaceId, \"forward\", (chunk) => {\r\n    messages.push(...chunk);\r\n  });\r\n  assert(result.success, `collectFullHistory failed: ${result.success ? \"\" : result.error}`);\r\n  return messages;\r\n}\r\n\r\ndescribe(\"HistoryService\", () => {\r\n  let service: HistoryService;\r\n  let config: Config;\r\n  let tempDir: string;\r\n\r\n  beforeEach(async () => {\r\n    // Create a temporary directory for test files\r\n    tempDir = path.join(os.tmpdir(), `mux-test-${Date.now()}-${Math.random()}`);\r\n    await fs.mkdir(tempDir, { recursive: true });\r\n\r\n    // Create a Config with the temp directory\r\n    config = new Config(tempDir);\r\n    service = new HistoryService(config);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    // Clean up temp directory\r\n    try {\r\n      await fs.rm(tempDir, { recursive: true, force: true });\r\n    } catch {\r\n      // Ignore cleanup errors\r\n    }\r\n  });\r\n\r\n  describe(\"getHistory\", () => {\r\n    it(\"should return empty array when no history exists\", async () => {\r\n      const messages = await collectFullHistory(service, \"workspace1\");\r\n      expect(messages).toEqual([]);\r\n    });\r\n\r\n    it(\"should read messages from chat.jsonl\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Hi there\", {\r\n        historySequence: 1,\r\n      });\r\n\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      await fs.writeFile(\r\n        chatPath,\r\n        JSON.stringify({ ...msg1, workspaceId }) +\r\n          \"\\n\" +\r\n          JSON.stringify({ ...msg2, workspaceId }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(2);\r\n      expect(messages[0].id).toBe(\"msg1\");\r\n      expect(messages[1].id).toBe(\"msg2\");\r\n    });\r\n\r\n    it(\"should skip malformed JSON lines\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      await fs.writeFile(\r\n        chatPath,\r\n        JSON.stringify({ ...msg1, workspaceId }) +\r\n          \"\\n\" +\r\n          \"invalid json line\\n\" +\r\n          JSON.stringify({\r\n            ...createMuxMessage(\"msg2\", \"user\", \"World\", { historySequence: 1 }),\r\n            workspaceId,\r\n          }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(2);\r\n      expect(messages[0].id).toBe(\"msg1\");\r\n      expect(messages[1].id).toBe(\"msg2\");\r\n    });\r\n\r\n    it(\"hydrates legacy cmuxMetadata entries\", async () => {\r\n      const workspaceId = \"workspace-legacy\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const legacyMessage = createMuxMessage(\"msg-legacy\", \"user\", \"legacy\", {\r\n        historySequence: 0,\r\n      });\r\n      (legacyMessage.metadata as Record<string, unknown>).cmuxMetadata = { type: \"normal\" };\r\n\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      await fs.writeFile(chatPath, JSON.stringify({ ...legacyMessage, workspaceId }) + \"\\n\");\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.muxMetadata?.type).toBe(\"normal\");\r\n    });\r\n    it(\"should handle empty lines in history file\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      await fs.writeFile(\r\n        chatPath,\r\n        JSON.stringify({ ...msg1, workspaceId }) + \"\\n\\n\\n\" // Extra empty lines\r\n      );\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(1);\r\n      expect(messages[0].id).toBe(\"msg1\");\r\n    });\r\n  });\r\n\r\n  describe(\"appendToHistory\", () => {\r\n    it(\"should create workspace directory if it doesn't exist\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      const result = await service.appendToHistory(workspaceId, msg);\r\n\r\n      expect(result.success).toBe(true);\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      const exists = await fs\r\n        .access(workspaceDir)\r\n        .then(() => true)\r\n        .catch(() => false);\r\n      expect(exists).toBe(true);\r\n    });\r\n\r\n    it(\"should assign historySequence to message without metadata\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      const result = await service.appendToHistory(workspaceId, msg);\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n    });\r\n\r\n    it(\"should assign sequential historySequence numbers\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Hi\");\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"How are you?\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n      await service.appendToHistory(workspaceId, msg3);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(3);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n      expect(messages[1].metadata?.historySequence).toBe(1);\r\n      expect(messages[2].metadata?.historySequence).toBe(2);\r\n    });\r\n\r\n    it(\"should preserve existing historySequence if provided\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 5 });\r\n\r\n      const result = await service.appendToHistory(workspaceId, msg);\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.historySequence).toBe(5);\r\n    });\r\n\r\n    it(\"should reject malformed provided historySequence values\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 5.5 });\r\n\r\n      const result = await service.appendToHistory(workspaceId, msg);\r\n\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"non-negative integer\");\r\n      }\r\n    });\r\n\r\n    it(\"should update sequence counter when message has higher sequence\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 10 });\r\n      const msg2 = createMuxMessage(\"msg2\", \"user\", \"World\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.historySequence).toBe(10);\r\n      expect(messages[1].metadata?.historySequence).toBe(11);\r\n    });\r\n\r\n    it(\"should preserve other metadata fields\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\", {\r\n        timestamp: 123456,\r\n        model: \"claude-opus-4\",\r\n        providerMetadata: { test: \"data\" },\r\n      });\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.timestamp).toBe(123456);\r\n      expect(messages[0].metadata?.model).toBe(\"claude-opus-4\");\r\n      expect(messages[0].metadata?.providerMetadata).toEqual({ test: \"data\" });\r\n      expect(messages[0].metadata?.historySequence).toBeDefined();\r\n    });\r\n\r\n    it(\"should include workspaceId in persisted message\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      const content = await fs.readFile(chatPath, \"utf-8\");\r\n      const persisted = JSON.parse(content.trim()) as {\r\n        workspaceId: string;\r\n        id: string;\r\n        role: string;\r\n      };\r\n\r\n      expect(persisted.workspaceId).toBe(workspaceId);\r\n    });\r\n  });\r\n\r\n  describe(\"updateHistory\", () => {\r\n    it(\"should update message by historySequence\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Hi\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      const updatedMsg = createMuxMessage(\"msg1\", \"user\", \"Updated Hello\", {\r\n        historySequence: messages[0].metadata?.historySequence,\r\n      });\r\n\r\n      const result = await service.updateHistory(workspaceId, updatedMsg);\r\n      expect(result.success).toBe(true);\r\n\r\n      const newMessages = await collectFullHistory(service, workspaceId);\r\n      expect(newMessages[0].parts[0]).toMatchObject({\r\n        type: \"text\",\r\n        text: \"Updated Hello\",\r\n      });\r\n      expect(newMessages[0].metadata?.historySequence).toBe(0);\r\n    });\r\n\r\n    it(\"should return error if message has no historySequence\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      const result = await service.updateHistory(workspaceId, msg);\r\n\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"without historySequence\");\r\n      }\r\n    });\r\n\r\n    it(\"should return error if message with historySequence not found\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n\r\n      const msg2 = createMuxMessage(\"msg2\", \"user\", \"Not found\", { historySequence: 99 });\r\n      const result = await service.updateHistory(workspaceId, msg2);\r\n\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"No message found\");\r\n      }\r\n    });\r\n\r\n    it(\"should preserve historySequence when updating\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      const originalSequence = messages[0].metadata?.historySequence;\r\n      const updatedMsg = createMuxMessage(\"msg1\", \"user\", \"Updated\", {\r\n        historySequence: originalSequence,\r\n      });\r\n\r\n      await service.updateHistory(workspaceId, updatedMsg);\r\n\r\n      const newMessages = await collectFullHistory(service, workspaceId);\r\n      expect(newMessages[0].metadata?.historySequence).toBe(originalSequence);\r\n    });\r\n\r\n    it(\"preserves durable compaction metadata across late in-place rewrites\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const placeholder = createMuxMessage(\"summary-msg\", \"assistant\", \"\", {\r\n        model: \"openai:gpt-5\",\r\n      });\r\n\r\n      await service.appendToHistory(workspaceId, placeholder);\r\n\r\n      const messagesAfterAppend = await collectFullHistory(service, workspaceId);\r\n\r\n      const sequence = messagesAfterAppend[0]?.metadata?.historySequence;\r\n      expect(typeof sequence).toBe(\"number\");\r\n      if (typeof sequence !== \"number\") {\r\n        return;\r\n      }\r\n\r\n      // Simulate compaction finishing first and upgrading the streamed placeholder in place.\r\n      const compactionSummary = createMuxMessage(\"summary-msg\", \"assistant\", \"Compacted summary\", {\r\n        historySequence: sequence,\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        compactionEpoch: 1,\r\n        muxMetadata: { type: \"compaction-summary\" },\r\n      });\r\n      const compactionUpdateResult = await service.updateHistory(workspaceId, compactionSummary);\r\n      expect(compactionUpdateResult.success).toBe(true);\r\n\r\n      // Simulate a late stream rewrite (e.g., simulateToolPolicyNoop path) that omits\r\n      // compaction metadata. The durable boundary markers must survive this rewrite.\r\n      const lateRewrite = createMuxMessage(\r\n        \"summary-msg\",\r\n        \"assistant\",\r\n        \"Tool execution skipped because the requested tool is disabled by policy.\",\r\n        {\r\n          historySequence: sequence,\r\n          model: \"openai:gpt-5\",\r\n        }\r\n      );\r\n      const lateRewriteResult = await service.updateHistory(workspaceId, lateRewrite);\r\n      expect(lateRewriteResult.success).toBe(true);\r\n\r\n      const finalMessages = await collectFullHistory(service, workspaceId);\r\n      expect(finalMessages).toHaveLength(1);\r\n      const finalMessage = finalMessages[0];\r\n      expect(finalMessage.parts[0]).toMatchObject({\r\n        type: \"text\",\r\n        text: \"Tool execution skipped because the requested tool is disabled by policy.\",\r\n      });\r\n      expect(finalMessage.metadata?.compacted).toBe(\"user\");\r\n      expect(finalMessage.metadata?.compactionBoundary).toBe(true);\r\n      expect(finalMessage.metadata?.compactionEpoch).toBe(1);\r\n      expect(finalMessage.metadata?.muxMetadata).toEqual({ type: \"compaction-summary\" });\r\n    });\r\n\r\n    it(\"self-heals by not preserving malformed compaction boundary metadata\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const placeholder = createMuxMessage(\"summary-msg\", \"assistant\", \"\", {\r\n        model: \"openai:gpt-5\",\r\n      });\r\n\r\n      await service.appendToHistory(workspaceId, placeholder);\r\n\r\n      const messagesAfterAppend = await collectFullHistory(service, workspaceId);\r\n\r\n      const sequence = messagesAfterAppend[0]?.metadata?.historySequence;\r\n      expect(typeof sequence).toBe(\"number\");\r\n      if (typeof sequence !== \"number\") {\r\n        return;\r\n      }\r\n\r\n      // Simulate malformed persisted boundary metadata (invalid epoch).\r\n      const malformedCompactionSummary = createMuxMessage(\r\n        \"summary-msg\",\r\n        \"assistant\",\r\n        \"Compacted summary\",\r\n        {\r\n          historySequence: sequence,\r\n          compacted: \"user\",\r\n          compactionBoundary: true,\r\n          compactionEpoch: 0,\r\n        }\r\n      );\r\n      const malformedUpdateResult = await service.updateHistory(\r\n        workspaceId,\r\n        malformedCompactionSummary\r\n      );\r\n      expect(malformedUpdateResult.success).toBe(true);\r\n\r\n      const lateRewrite = createMuxMessage(\"summary-msg\", \"assistant\", \"Late rewrite\", {\r\n        historySequence: sequence,\r\n        model: \"openai:gpt-5\",\r\n      });\r\n      const lateRewriteResult = await service.updateHistory(workspaceId, lateRewrite);\r\n      expect(lateRewriteResult.success).toBe(true);\r\n\r\n      const finalMessages = await collectFullHistory(service, workspaceId);\r\n      const finalMessage = finalMessages[0];\r\n      expect(finalMessage.metadata?.compactionBoundary).toBeUndefined();\r\n      expect(finalMessage.metadata?.compactionEpoch).toBeUndefined();\r\n    });\r\n\r\n    it(\"self-heals by not preserving malformed compacted markers in compaction boundaries\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const placeholder = createMuxMessage(\"summary-msg\", \"assistant\", \"\", {\r\n        model: \"openai:gpt-5\",\r\n      });\r\n\r\n      await service.appendToHistory(workspaceId, placeholder);\r\n\r\n      const messagesAfterAppend = await collectFullHistory(service, workspaceId);\r\n\r\n      const sequence = messagesAfterAppend[0]?.metadata?.historySequence;\r\n      expect(typeof sequence).toBe(\"number\");\r\n      if (typeof sequence !== \"number\") {\r\n        return;\r\n      }\r\n\r\n      const malformedCompactionSummary = createMuxMessage(\r\n        \"summary-msg\",\r\n        \"assistant\",\r\n        \"Compacted summary\",\r\n        {\r\n          historySequence: sequence,\r\n          compactionBoundary: true,\r\n          compactionEpoch: 1,\r\n        }\r\n      );\r\n      if (malformedCompactionSummary.metadata) {\r\n        (malformedCompactionSummary.metadata as Record<string, unknown>).compacted = \"corrupt\";\r\n      }\r\n\r\n      const malformedUpdateResult = await service.updateHistory(\r\n        workspaceId,\r\n        malformedCompactionSummary\r\n      );\r\n      expect(malformedUpdateResult.success).toBe(true);\r\n\r\n      const lateRewrite = createMuxMessage(\"summary-msg\", \"assistant\", \"Late rewrite\", {\r\n        historySequence: sequence,\r\n        model: \"openai:gpt-5\",\r\n      });\r\n      const lateRewriteResult = await service.updateHistory(workspaceId, lateRewrite);\r\n      expect(lateRewriteResult.success).toBe(true);\r\n\r\n      const finalMessages = await collectFullHistory(service, workspaceId);\r\n      const finalMessage = finalMessages[0];\r\n      expect(finalMessage.metadata?.compacted).toBeUndefined();\r\n      expect(finalMessage.metadata?.compactionBoundary).toBeUndefined();\r\n      expect(finalMessage.metadata?.compactionEpoch).toBeUndefined();\r\n    });\r\n  });\r\n\r\n  describe(\"deleteMessage\", () => {\r\n    it(\"should remove only the targeted message and preserve subsequent messages\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"First\");\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Second\");\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"Third\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n      await service.appendToHistory(workspaceId, msg3);\r\n\r\n      const result = await service.deleteMessage(workspaceId, \"msg2\");\r\n      expect(result.success).toBe(true);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(2);\r\n      expect(messages.map((message) => message.id)).toEqual([\"msg1\", \"msg3\"]);\r\n\r\n      const msg4 = createMuxMessage(\"msg4\", \"assistant\", \"Fourth\");\r\n      await service.appendToHistory(workspaceId, msg4);\r\n\r\n      const messagesAfterAppend = await collectFullHistory(service, workspaceId);\r\n      const msg3Seq = messagesAfterAppend.find((message) => message.id === \"msg3\")?.metadata\r\n        ?.historySequence;\r\n      const msg4Seq = messagesAfterAppend.find((message) => message.id === \"msg4\")?.metadata\r\n        ?.historySequence;\r\n\r\n      expect(msg3Seq).toBeDefined();\r\n      expect(msg4Seq).toBeDefined();\r\n      expect(msg4Seq).toBeGreaterThan(msg3Seq ?? -1);\r\n    });\r\n\r\n    it(\"should return error if message not found\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const result = await service.deleteMessage(workspaceId, \"nonexistent\");\r\n\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"not found\");\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"truncateAfterMessage\", () => {\r\n    it(\"should remove message and all subsequent messages\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"First\");\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Second\");\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"Third\");\r\n      const msg4 = createMuxMessage(\"msg4\", \"assistant\", \"Fourth\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n      await service.appendToHistory(workspaceId, msg3);\r\n      await service.appendToHistory(workspaceId, msg4);\r\n\r\n      const result = await service.truncateAfterMessage(workspaceId, \"msg2\");\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(1);\r\n      expect(messages[0].id).toBe(\"msg1\");\r\n    });\r\n\r\n    it(\"should update sequence counter after truncation\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"First\");\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Second\");\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"Third\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n      await service.appendToHistory(workspaceId, msg3);\r\n\r\n      await service.truncateAfterMessage(workspaceId, \"msg2\");\r\n\r\n      // Append a new message and check its sequence\r\n      const msg4 = createMuxMessage(\"msg4\", \"user\", \"New message\");\r\n      await service.appendToHistory(workspaceId, msg4);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(2);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n      expect(messages[1].metadata?.historySequence).toBe(1);\r\n    });\r\n\r\n    it(\"should reset sequence counter when truncating all messages\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"First\");\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Second\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.appendToHistory(workspaceId, msg2);\r\n\r\n      await service.truncateAfterMessage(workspaceId, \"msg1\");\r\n\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"New\");\r\n      await service.appendToHistory(workspaceId, msg3);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages).toHaveLength(1);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n    });\r\n\r\n    it(\"should return error if message not found\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const result = await service.truncateAfterMessage(workspaceId, \"nonexistent\");\r\n\r\n      expect(result.success).toBe(false);\r\n      if (!result.success) {\r\n        expect(result.error).toContain(\"not found\");\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"clearHistory\", () => {\r\n    it(\"should delete chat.jsonl file\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const result = await service.clearHistory(workspaceId);\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      const exists = await fs\r\n        .access(chatPath)\r\n        .then(() => true)\r\n        .catch(() => false);\r\n      expect(exists).toBe(false);\r\n    });\r\n\r\n    it(\"should reset sequence counter\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\");\r\n\r\n      await service.appendToHistory(workspaceId, msg1);\r\n      await service.clearHistory(workspaceId);\r\n\r\n      const msg2 = createMuxMessage(\"msg2\", \"user\", \"New message\");\r\n      await service.appendToHistory(workspaceId, msg2);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n    });\r\n\r\n    it(\"should succeed when clearing non-existent history\", async () => {\r\n      const workspaceId = \"workspace-no-history\";\r\n\r\n      const result = await service.clearHistory(workspaceId);\r\n\r\n      expect(result.success).toBe(true);\r\n    });\r\n\r\n    it(\"should reset sequence counter even when file doesn't exist\", async () => {\r\n      const workspaceId = \"workspace-no-history\";\r\n\r\n      await service.clearHistory(workspaceId);\r\n\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"First\");\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n    });\r\n  });\r\n\r\n  describe(\"sequence number initialization\", () => {\r\n    it(\"should initialize sequence from existing history\", async () => {\r\n      const workspaceId = \"workspace1\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      // Manually create history with specific sequences\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Hi\", { historySequence: 1 });\r\n\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      await fs.writeFile(\r\n        chatPath,\r\n        JSON.stringify({ ...msg1, workspaceId }) +\r\n          \"\\n\" +\r\n          JSON.stringify({ ...msg2, workspaceId }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      // Create new service instance to ensure fresh initialization\r\n      const newService = new HistoryService(config);\r\n\r\n      // Append a new message - should get sequence 2\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"How are you?\");\r\n      await newService.appendToHistory(workspaceId, msg3);\r\n\r\n      const messages = await collectFullHistory(newService, workspaceId);\r\n      expect(messages).toHaveLength(3);\r\n      expect(messages[2].metadata?.historySequence).toBe(2);\r\n    });\r\n\r\n    it(\"should ignore malformed persisted numeric sequences when initializing counters\", async () => {\r\n      const workspaceId = \"workspace-with-malformed-sequences\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const validMessage = createMuxMessage(\"msg-valid\", \"user\", \"Hello\", { historySequence: 3 });\r\n      const malformedMessage = createMuxMessage(\"msg-malformed\", \"assistant\", \"Hi\", {\r\n        historySequence: 42,\r\n      });\r\n      if (malformedMessage.metadata) {\r\n        (malformedMessage.metadata as Record<string, unknown>).historySequence = 99.5;\r\n      }\r\n\r\n      const chatPath = path.join(workspaceDir, \"chat.jsonl\");\r\n      await fs.writeFile(\r\n        chatPath,\r\n        JSON.stringify({ ...validMessage, workspaceId }) +\r\n          \"\\n\" +\r\n          JSON.stringify({ ...malformedMessage, workspaceId }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      const newService = new HistoryService(config);\r\n      const msg3 = createMuxMessage(\"msg3\", \"user\", \"How are you?\");\r\n      const appendResult = await newService.appendToHistory(workspaceId, msg3);\r\n      expect(appendResult.success).toBe(true);\r\n\r\n      const messages = await collectFullHistory(newService, workspaceId);\r\n      expect(messages).toHaveLength(3);\r\n      const appended = messages.find((msg) => msg.id === \"msg3\");\r\n      expect(appended?.metadata?.historySequence).toBe(4);\r\n    });\r\n\r\n    it(\"should start from 0 for new workspace\", async () => {\r\n      const workspaceId = \"new-workspace\";\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"First message\");\r\n\r\n      await service.appendToHistory(workspaceId, msg);\r\n\r\n      const messages = await collectFullHistory(service, workspaceId);\r\n      expect(messages[0].metadata?.historySequence).toBe(0);\r\n    });\r\n  });\r\n\r\n  //  Optimized read path tests \r\n\r\n  /**\r\n   * Helper: write a chat.jsonl file with messages that include a compaction boundary.\r\n   * Returns { preBoundaryIds, boundaryId, postBoundaryIds }.\r\n   */\r\n  async function writeChatWithBoundary(\r\n    cfg: Config,\r\n    workspaceId: string,\r\n    opts: { preBoundaryCount: number; postBoundaryCount: number; epoch?: number }\r\n  ) {\r\n    const workspaceDir = cfg.getSessionDir(workspaceId);\r\n    await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n    const epoch = opts.epoch ?? 1;\r\n    const lines: string[] = [];\r\n    const preBoundaryIds: string[] = [];\r\n    const postBoundaryIds: string[] = [];\r\n    let seq = 0;\r\n\r\n    // Pre-boundary messages\r\n    for (let i = 0; i < opts.preBoundaryCount; i++) {\r\n      const id = `pre-${i}`;\r\n      preBoundaryIds.push(id);\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(id, \"user\", `message ${i}`, { historySequence: seq++ }),\r\n          workspaceId,\r\n        })\r\n      );\r\n    }\r\n\r\n    // Compaction boundary message\r\n    const boundaryId = `boundary-${epoch}`;\r\n    lines.push(\r\n      JSON.stringify({\r\n        ...createMuxMessage(boundaryId, \"assistant\", \"Compaction summary\", {\r\n          historySequence: seq++,\r\n          compactionBoundary: true,\r\n          compacted: \"user\",\r\n          compactionEpoch: epoch,\r\n        }),\r\n        workspaceId,\r\n      })\r\n    );\r\n\r\n    // Post-boundary messages\r\n    for (let i = 0; i < opts.postBoundaryCount; i++) {\r\n      const id = `post-${i}`;\r\n      postBoundaryIds.push(id);\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(id, \"user\", `post message ${i}`, { historySequence: seq++ }),\r\n          workspaceId,\r\n        })\r\n      );\r\n    }\r\n\r\n    await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n    return { preBoundaryIds, boundaryId, postBoundaryIds };\r\n  }\r\n\r\n  describe(\"getHistoryFromLatestBoundary\", () => {\r\n    it(\"should return full history when no boundary exists\", async () => {\r\n      const workspaceId = \"ws-no-boundary\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Hi\", { historySequence: 1 });\r\n      await fs.writeFile(\r\n        path.join(workspaceDir, \"chat.jsonl\"),\r\n        JSON.stringify({ ...msg1, workspaceId }) +\r\n          \"\\n\" +\r\n          JSON.stringify({ ...msg2, workspaceId }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      const result = await service.getHistoryFromLatestBoundary(workspaceId);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(2);\r\n        expect(result.data[0].id).toBe(\"msg1\");\r\n        expect(result.data[1].id).toBe(\"msg2\");\r\n      }\r\n    });\r\n\r\n    it(\"should return empty array when no history exists\", async () => {\r\n      const result = await service.getHistoryFromLatestBoundary(\"nonexistent\");\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toEqual([]);\r\n      }\r\n    });\r\n\r\n    it(\"should return only messages from the latest boundary onward\", async () => {\r\n      const workspaceId = \"ws-with-boundary\";\r\n      const { boundaryId, postBoundaryIds } = await writeChatWithBoundary(config, workspaceId, {\r\n        preBoundaryCount: 5,\r\n        postBoundaryCount: 3,\r\n      });\r\n\r\n      const result = await service.getHistoryFromLatestBoundary(workspaceId);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        // Should include boundary + post-boundary messages\r\n        expect(result.data).toHaveLength(4); // 1 boundary + 3 post\r\n        expect(result.data[0].id).toBe(boundaryId);\r\n        for (let i = 0; i < postBoundaryIds.length; i++) {\r\n          expect(result.data[i + 1].id).toBe(postBoundaryIds[i]);\r\n        }\r\n      }\r\n    });\r\n\r\n    it(\"should find the latest boundary with multiple compaction epochs\", async () => {\r\n      const workspaceId = \"ws-multi-epoch\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const lines: string[] = [];\r\n      let seq = 0;\r\n\r\n      // Epoch 1 messages + boundary\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"e1-user\", \"user\", \"msg\", { historySequence: seq++ }),\r\n          workspaceId,\r\n        })\r\n      );\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"e1-boundary\", \"assistant\", \"Summary 1\", {\r\n            historySequence: seq++,\r\n            compactionBoundary: true,\r\n            compacted: \"user\",\r\n            compactionEpoch: 1,\r\n          }),\r\n          workspaceId,\r\n        })\r\n      );\r\n\r\n      // Epoch 2 messages + boundary\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"e2-user\", \"user\", \"msg\", { historySequence: seq++ }),\r\n          workspaceId,\r\n        })\r\n      );\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"e2-boundary\", \"assistant\", \"Summary 2\", {\r\n            historySequence: seq++,\r\n            compactionBoundary: true,\r\n            compacted: \"idle\",\r\n            compactionEpoch: 2,\r\n          }),\r\n          workspaceId,\r\n        })\r\n      );\r\n\r\n      // Post-epoch-2 message\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"post-e2\", \"user\", \"after both\", { historySequence: seq++ }),\r\n          workspaceId,\r\n        })\r\n      );\r\n\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n\r\n      // Default skip=0: reads from the latest boundary\r\n      const result = await service.getHistoryFromLatestBoundary(workspaceId);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(2); // epoch-2 boundary + post message\r\n        expect(result.data[0].id).toBe(\"e2-boundary\");\r\n        expect(result.data[1].id).toBe(\"post-e2\");\r\n      }\r\n\r\n      // skip=1: reads from the penultimate boundary\r\n      const penultimate = await service.getHistoryFromLatestBoundary(workspaceId, 1);\r\n      expect(penultimate.success).toBe(true);\r\n      if (penultimate.success) {\r\n        expect(penultimate.data).toHaveLength(4);\r\n        expect(penultimate.data[0].id).toBe(\"e1-boundary\");\r\n        expect(penultimate.data[1].id).toBe(\"e2-user\");\r\n        expect(penultimate.data[2].id).toBe(\"e2-boundary\");\r\n        expect(penultimate.data[3].id).toBe(\"post-e2\");\r\n      }\r\n    });\r\n\r\n    it(\"should skip malformed lines in boundary region\", async () => {\r\n      const workspaceId = \"ws-malformed\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const boundary = createMuxMessage(\"boundary\", \"assistant\", \"Summary\", {\r\n        historySequence: 0,\r\n        compactionBoundary: true,\r\n        compacted: \"user\",\r\n        compactionEpoch: 1,\r\n      });\r\n      const post = createMuxMessage(\"post\", \"user\", \"after\", { historySequence: 1 });\r\n\r\n      await fs.writeFile(\r\n        path.join(workspaceDir, \"chat.jsonl\"),\r\n        JSON.stringify({ ...boundary, workspaceId }) +\r\n          \"\\n\" +\r\n          \"MALFORMED LINE\\n\" +\r\n          JSON.stringify({ ...post, workspaceId }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      const result = await service.getHistoryFromLatestBoundary(workspaceId);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(2); // boundary + post (malformed skipped)\r\n        expect(result.data[0].id).toBe(\"boundary\");\r\n        expect(result.data[1].id).toBe(\"post\");\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"getLastMessages\", () => {\r\n    it(\"should return empty array when no history exists\", async () => {\r\n      const result = await service.getLastMessages(\"nonexistent\", 5);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toEqual([]);\r\n      }\r\n    });\r\n\r\n    it(\"should return the last N messages in chronological order\", async () => {\r\n      const workspaceId = \"ws-last-n\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const lines: string[] = [];\r\n      for (let i = 0; i < 10; i++) {\r\n        lines.push(\r\n          JSON.stringify({\r\n            ...createMuxMessage(`msg-${i}`, \"user\", `message ${i}`, { historySequence: i }),\r\n            workspaceId,\r\n          })\r\n        );\r\n      }\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n\r\n      const result = await service.getLastMessages(workspaceId, 3);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(3);\r\n        expect(result.data[0].id).toBe(\"msg-7\");\r\n        expect(result.data[1].id).toBe(\"msg-8\");\r\n        expect(result.data[2].id).toBe(\"msg-9\");\r\n      }\r\n    });\r\n\r\n    it(\"should return all messages when N exceeds total count\", async () => {\r\n      const workspaceId = \"ws-last-all\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const lines: string[] = [];\r\n      for (let i = 0; i < 3; i++) {\r\n        lines.push(\r\n          JSON.stringify({\r\n            ...createMuxMessage(`msg-${i}`, \"user\", `message ${i}`, { historySequence: i }),\r\n            workspaceId,\r\n          })\r\n        );\r\n      }\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n\r\n      const result = await service.getLastMessages(workspaceId, 100);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(3);\r\n        expect(result.data[0].id).toBe(\"msg-0\");\r\n        expect(result.data[1].id).toBe(\"msg-1\");\r\n        expect(result.data[2].id).toBe(\"msg-2\");\r\n      }\r\n    });\r\n\r\n    it(\"should return exactly 1 message when requested\", async () => {\r\n      const workspaceId = \"ws-last-1\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const lines: string[] = [];\r\n      for (let i = 0; i < 5; i++) {\r\n        lines.push(\r\n          JSON.stringify({\r\n            ...createMuxMessage(`msg-${i}`, \"user\", `message ${i}`, { historySequence: i }),\r\n            workspaceId,\r\n          })\r\n        );\r\n      }\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n\r\n      const result = await service.getLastMessages(workspaceId, 1);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(1);\r\n        expect(result.data[0].id).toBe(\"msg-4\");\r\n      }\r\n    });\r\n\r\n    it(\"should skip malformed lines\", async () => {\r\n      const workspaceId = \"ws-last-malformed\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const msg1 = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n      const msg2 = createMuxMessage(\"msg2\", \"assistant\", \"Hi\", { historySequence: 1 });\r\n\r\n      await fs.writeFile(\r\n        path.join(workspaceDir, \"chat.jsonl\"),\r\n        JSON.stringify({ ...msg1, workspaceId }) +\r\n          \"\\n\" +\r\n          \"BAD LINE\\n\" +\r\n          JSON.stringify({ ...msg2, workspaceId }) +\r\n          \"\\n\"\r\n      );\r\n\r\n      const result = await service.getLastMessages(workspaceId, 2);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(2);\r\n        expect(result.data[0].id).toBe(\"msg1\");\r\n        expect(result.data[1].id).toBe(\"msg2\");\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"multi-byte UTF-8 handling\", () => {\r\n    it(\"should correctly find boundary and read messages with non-ASCII content\", async () => {\r\n      const workspaceId = \"ws-utf8\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      // Use multi-byte UTF-8 characters (emoji, CJK) in message content\r\n      // to verify byte offset calculations handle non-ASCII correctly.\r\n      const lines: string[] = [];\r\n      let seq = 0;\r\n\r\n      // Pre-boundary: message with emoji (4-byte UTF-8 chars)\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"emoji-msg\", \"user\", \"Hello  world\", {\r\n            historySequence: seq++,\r\n          }),\r\n          workspaceId,\r\n        })\r\n      );\r\n\r\n      // Boundary with CJK characters (3-byte UTF-8 chars)\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"boundary-utf8\", \"assistant\", \"\", {\r\n            historySequence: seq++,\r\n            compactionBoundary: true,\r\n            compacted: \"user\",\r\n            compactionEpoch: 1,\r\n          }),\r\n          workspaceId,\r\n        })\r\n      );\r\n\r\n      // Post-boundary: message with mixed scripts\r\n      lines.push(\r\n        JSON.stringify({\r\n          ...createMuxMessage(\"post-utf8\", \"user\", \"oo caf rsum ber \", {\r\n            historySequence: seq++,\r\n          }),\r\n          workspaceId,\r\n        })\r\n      );\r\n\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n\r\n      // getHistoryFromLatestBoundary should find the boundary correctly\r\n      const boundaryResult = await service.getHistoryFromLatestBoundary(workspaceId);\r\n      expect(boundaryResult.success).toBe(true);\r\n      if (boundaryResult.success) {\r\n        expect(boundaryResult.data).toHaveLength(2); // boundary + post\r\n        expect(boundaryResult.data[0].id).toBe(\"boundary-utf8\");\r\n        expect(boundaryResult.data[1].id).toBe(\"post-utf8\");\r\n      }\r\n\r\n      // getLastMessages should also handle multi-byte content correctly\r\n      const lastResult = await service.getLastMessages(workspaceId, 2);\r\n      expect(lastResult.success).toBe(true);\r\n      if (lastResult.success) {\r\n        expect(lastResult.data).toHaveLength(2);\r\n        expect(lastResult.data[0].id).toBe(\"boundary-utf8\");\r\n        expect(lastResult.data[1].id).toBe(\"post-utf8\");\r\n      }\r\n    });\r\n\r\n    it(\"should handle messages where all content is multi-byte\", async () => {\r\n      const workspaceId = \"ws-utf8-all\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const lines: string[] = [];\r\n      // Every message uses multi-byte characters exclusively\r\n      for (let i = 0; i < 5; i++) {\r\n        lines.push(\r\n          JSON.stringify({\r\n            ...createMuxMessage(`utf8-${i}`, \"user\", ` ${i} `, {\r\n              historySequence: i,\r\n            }),\r\n            workspaceId,\r\n          })\r\n        );\r\n      }\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), lines.join(\"\\n\") + \"\\n\");\r\n\r\n      const result = await service.getLastMessages(workspaceId, 3);\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.data).toHaveLength(3);\r\n        expect(result.data[0].id).toBe(\"utf8-2\");\r\n        expect(result.data[1].id).toBe(\"utf8-3\");\r\n        expect(result.data[2].id).toBe(\"utf8-4\");\r\n      }\r\n    });\r\n  });\r\n\r\n  describe(\"hasHistory\", () => {\r\n    it(\"should return false when no history file exists\", async () => {\r\n      const result = await service.hasHistory(\"nonexistent\");\r\n      expect(result).toBe(false);\r\n    });\r\n\r\n    it(\"should return false for empty file\", async () => {\r\n      const workspaceId = \"ws-empty\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), \"\");\r\n\r\n      const result = await service.hasHistory(workspaceId);\r\n      expect(result).toBe(false);\r\n    });\r\n\r\n    it(\"should return true when history exists\", async () => {\r\n      const workspaceId = \"ws-has-history\";\r\n      const workspaceDir = config.getSessionDir(workspaceId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const msg = createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 0 });\r\n      await fs.writeFile(\r\n        path.join(workspaceDir, \"chat.jsonl\"),\r\n        JSON.stringify({ ...msg, workspaceId }) + \"\\n\"\r\n      );\r\n\r\n      const result = await service.hasHistory(workspaceId);\r\n      expect(result).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe(\"iterateFullHistory\", () => {\r\n    const wsId = \"workspace1\";\r\n\r\n    it(\"should iterate forward in chronological order\", async () => {\r\n      const msgs = Array.from({ length: 5 }, (_, i) =>\r\n        createMuxMessage(`msg-${i}`, \"user\", `Message ${i}`)\r\n      );\r\n      for (const msg of msgs) {\r\n        await service.appendToHistory(wsId, msg);\r\n      }\r\n\r\n      const collected: MuxMessage[] = [];\r\n      const result = await service.iterateFullHistory(wsId, \"forward\", (chunk) => {\r\n        collected.push(...chunk);\r\n      });\r\n      expect(result.success).toBe(true);\r\n      expect(collected.length).toBe(5);\r\n      expect(collected.map((m) => m.id)).toEqual([\"msg-0\", \"msg-1\", \"msg-2\", \"msg-3\", \"msg-4\"]);\r\n    });\r\n\r\n    it(\"should iterate backward with newest first\", async () => {\r\n      const msgs = Array.from({ length: 5 }, (_, i) =>\r\n        createMuxMessage(`msg-${i}`, \"user\", `Message ${i}`)\r\n      );\r\n      for (const msg of msgs) {\r\n        await service.appendToHistory(wsId, msg);\r\n      }\r\n\r\n      const collected: MuxMessage[] = [];\r\n      const result = await service.iterateFullHistory(wsId, \"backward\", (chunk) => {\r\n        collected.push(...chunk);\r\n      });\r\n      expect(result.success).toBe(true);\r\n      expect(collected.length).toBe(5);\r\n      // Backward: newest first\r\n      expect(collected.map((m) => m.id)).toEqual([\"msg-4\", \"msg-3\", \"msg-2\", \"msg-1\", \"msg-0\"]);\r\n    });\r\n\r\n    it(\"should support early exit by returning false\", async () => {\r\n      const msgs = Array.from({ length: 10 }, (_, i) =>\r\n        createMuxMessage(`msg-${i}`, \"user\", `Message ${i}`)\r\n      );\r\n      for (const msg of msgs) {\r\n        await service.appendToHistory(wsId, msg);\r\n      }\r\n\r\n      let found: MuxMessage | undefined;\r\n      await service.iterateFullHistory(wsId, \"forward\", (chunk) => {\r\n        for (const msg of chunk) {\r\n          if (msg.id === \"msg-3\") {\r\n            found = msg;\r\n            return false; // stop early\r\n          }\r\n        }\r\n      });\r\n      expect(found).toBeTruthy();\r\n      expect(found!.id).toBe(\"msg-3\");\r\n    });\r\n\r\n    it(\"should support early exit in backward direction\", async () => {\r\n      const msgs = Array.from({ length: 10 }, (_, i) =>\r\n        createMuxMessage(`msg-${i}`, \"user\", `Message ${i}`)\r\n      );\r\n      for (const msg of msgs) {\r\n        await service.appendToHistory(wsId, msg);\r\n      }\r\n\r\n      // Find the first message encountered when reading backward (should be msg-9)\r\n      let firstSeen: MuxMessage | undefined;\r\n      await service.iterateFullHistory(wsId, \"backward\", (chunk) => {\r\n        firstSeen = chunk[0];\r\n        return false; // stop after first chunk\r\n      });\r\n      expect(firstSeen).toBeTruthy();\r\n      expect(firstSeen!.id).toBe(\"msg-9\");\r\n    });\r\n\r\n    it(\"should return success for empty history\", async () => {\r\n      const collected: MuxMessage[] = [];\r\n      const result = await service.iterateFullHistory(wsId, \"forward\", (chunk) => {\r\n        collected.push(...chunk);\r\n      });\r\n      expect(result.success).toBe(true);\r\n      expect(collected.length).toBe(0);\r\n    });\r\n\r\n    it(\"should skip malformed lines during iteration\", async () => {\r\n      const workspaceDir = config.getSessionDir(wsId);\r\n      await fs.mkdir(workspaceDir, { recursive: true });\r\n\r\n      const validMsg = createMuxMessage(\"valid-1\", \"user\", \"Valid message\");\r\n      const content = [\r\n        \"not valid json\",\r\n        JSON.stringify({ ...validMsg, workspaceId: wsId }),\r\n        \"{malformed\",\r\n      ].join(\"\\n\");\r\n\r\n      await fs.writeFile(path.join(workspaceDir, \"chat.jsonl\"), content + \"\\n\");\r\n\r\n      const collected: MuxMessage[] = [];\r\n      const result = await service.iterateFullHistory(wsId, \"forward\", (chunk) => {\r\n        collected.push(...chunk);\r\n      });\r\n      expect(result.success).toBe(true);\r\n      expect(collected.length).toBe(1);\r\n      expect(collected[0].id).toBe(\"valid-1\");\r\n    });\r\n  });\r\n});\r\n"]}