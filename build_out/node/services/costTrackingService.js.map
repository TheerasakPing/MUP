{"version":3,"file":"costTrackingService.js","sourceRoot":"","sources":["../../../src/node/services/costTrackingService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport writeFileAtomic from \"write-file-atomic\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { log } from \"./log\";\r\nimport { createDisplayUsage } from \"@/common/utils/tokens/displayUsage\";\r\nimport type { LanguageModelV2Usage } from \"@ai-sdk/provider\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Types\r\n// ---------------------------------------------------------------------------\r\n\r\nexport interface CostEntry {\r\n    timestamp: number;\r\n    workspaceId: string;\r\n    model: string;\r\n    inputTokens: number;\r\n    outputTokens: number;\r\n    cachedTokens: number;\r\n    cacheCreateTokens: number;\r\n    reasoningTokens: number;\r\n    cost: number; // USD\r\n}\r\n\r\nexport interface DailySummary {\r\n    date: string; // \"YYYY-MM-DD\"\r\n    totalCost: number;\r\n    requestCount: number;\r\n    byModel: Record<string, { cost: number; requests: number; tokens: number }>;\r\n}\r\n\r\ninterface CostHistoryFile {\r\n    version: 1;\r\n    entries: CostEntry[];\r\n    dailySummaries: Record<string, DailySummary>;\r\n}\r\n\r\nexport interface CostHistoryRange {\r\n    start?: number; // timestamp\r\n    end?: number;   // timestamp\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Service\r\n// ---------------------------------------------------------------------------\r\n\r\nconst EMPTY_FILE: CostHistoryFile = { version: 1, entries: [], dailySummaries: {} };\r\nconst DEFAULT_RETENTION_DAYS = 90;\r\n\r\nexport class CostTrackingService {\r\n    private readonly filePath: string;\r\n    private readonly config: Config;\r\n\r\n    constructor(config: Config) {\r\n        this.config = config;\r\n        this.filePath = path.join(config.rootDir, \"cost-history.json\");\r\n    }\r\n\r\n    // -- Read / Write ---------------------------------------------------------\r\n\r\n    private async read(): Promise<CostHistoryFile> {\r\n        try {\r\n            const raw = await fs.readFile(this.filePath, \"utf-8\");\r\n            const data = JSON.parse(raw) as CostHistoryFile;\r\n            if (data.version !== 1) return { ...EMPTY_FILE };\r\n            return data;\r\n        } catch {\r\n            return { ...EMPTY_FILE };\r\n        }\r\n    }\r\n\r\n    private async write(data: CostHistoryFile): Promise<void> {\r\n        const dir = path.dirname(this.filePath);\r\n        await fs.mkdir(dir, { recursive: true });\r\n        await writeFileAtomic(this.filePath, JSON.stringify(data, null, 2));\r\n    }\r\n\r\n    // -- Public API -----------------------------------------------------------\r\n\r\n    /**\r\n     * Record a cost entry from a completed stream.\r\n     * Also updates the daily summary atomically.\r\n     */\r\n    async recordCost(entry: CostEntry): Promise<void> {\r\n        const data = await this.read();\r\n        data.entries.push(entry);\r\n\r\n        // Update daily summary\r\n        const dateKey = new Date(entry.timestamp).toISOString().slice(0, 10);\r\n        const summary = data.dailySummaries[dateKey] ?? {\r\n            date: dateKey,\r\n            totalCost: 0,\r\n            requestCount: 0,\r\n            byModel: {},\r\n        };\r\n\r\n        summary.totalCost += entry.cost;\r\n        summary.requestCount += 1;\r\n\r\n        const modelSummary = summary.byModel[entry.model] ?? { cost: 0, requests: 0, tokens: 0 };\r\n        modelSummary.cost += entry.cost;\r\n        modelSummary.requests += 1;\r\n        modelSummary.tokens +=\r\n            entry.inputTokens + entry.outputTokens + entry.cachedTokens + entry.reasoningTokens;\r\n        summary.byModel[entry.model] = modelSummary;\r\n\r\n        // Ensure the summary is assigned back to the data object\r\n        data.dailySummaries[dateKey] = summary;\r\n\r\n        await this.write(data);\r\n    }\r\n\r\n    /**\r\n     * Calculate cost and record it.\r\n     */\r\n    async trackCost(\r\n        workspaceId: string,\r\n        model: string,\r\n        usage: LanguageModelV2Usage,\r\n        providerMetadata?: Record<string, unknown>\r\n    ): Promise<void> {\r\n        // Load latest config to check for custom model prices\r\n        const currentConfig = this.config.loadConfigOrDefault();\r\n        const customPrice = currentConfig.customModelPrices?.[model];\r\n\r\n        const displayUsage = createDisplayUsage(usage, model, providerMetadata, customPrice);\r\n        if (!displayUsage) return;\r\n\r\n        const totalCost =\r\n            (displayUsage.input.cost_usd ?? 0) +\r\n            (displayUsage.output.cost_usd ?? 0) +\r\n            (displayUsage.cached.cost_usd ?? 0) +\r\n            (displayUsage.cacheCreate.cost_usd ?? 0) +\r\n            (displayUsage.reasoning.cost_usd ?? 0);\r\n\r\n        const entry: CostEntry = {\r\n            timestamp: Date.now(),\r\n            workspaceId,\r\n            model,\r\n            inputTokens: displayUsage.input.tokens,\r\n            outputTokens: displayUsage.output.tokens,\r\n            cachedTokens: displayUsage.cached.tokens,\r\n            cacheCreateTokens: displayUsage.cacheCreate.tokens,\r\n            reasoningTokens: displayUsage.reasoning.tokens,\r\n            cost: totalCost,\r\n        };\r\n\r\n        await this.recordCost(entry);\r\n    }\r\n\r\n    /**\r\n     * Get cost entries within a time range.\r\n     */\r\n    async getCostHistory(range?: CostHistoryRange): Promise<CostEntry[]> {\r\n        const data = await this.read();\r\n        if (!range?.start && !range?.end) return data.entries;\r\n        return data.entries.filter((e) => {\r\n            if (range.start && e.timestamp < range.start) return false;\r\n            if (range.end && e.timestamp > range.end) return false;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get daily summaries within a date range.\r\n     */\r\n    async getDailySummaries(\r\n        startDate?: string,\r\n        endDate?: string,\r\n    ): Promise<DailySummary[]> {\r\n        const data = await this.read();\r\n        const summaries = Object.values(data.dailySummaries).sort(\r\n            (a, b) => a.date.localeCompare(b.date),\r\n        );\r\n        if (!startDate && !endDate) return summaries;\r\n        return summaries.filter((s) => {\r\n            if (startDate && s.date < startDate) return false;\r\n            if (endDate && s.date > endDate) return false;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get per-model cost breakdown for the given range.\r\n     */\r\n    async getModelBreakdown(\r\n        range?: CostHistoryRange,\r\n    ): Promise<Record<string, { cost: number; requests: number; tokens: number }>> {\r\n        const entries = await this.getCostHistory(range);\r\n        const breakdown: Record<string, { cost: number; requests: number; tokens: number }> = {};\r\n        for (const e of entries) {\r\n            const m = breakdown[e.model] ?? { cost: 0, requests: 0, tokens: 0 };\r\n            m.cost += e.cost;\r\n            m.requests += 1;\r\n            m.tokens += e.inputTokens + e.outputTokens + e.cachedTokens + e.reasoningTokens;\r\n            breakdown[e.model] = m;\r\n        }\r\n        return breakdown;\r\n    }\r\n\r\n    /**\r\n     * Remove entries older than retentionDays from the file.\r\n     */\r\n    async pruneOldEntries(retentionDays: number = DEFAULT_RETENTION_DAYS): Promise<number> {\r\n        const data = await this.read();\r\n        const cutoff = Date.now() - retentionDays * 86_400_000;\r\n        const cutoffDate = new Date(cutoff).toISOString().slice(0, 10);\r\n        const before = data.entries.length;\r\n        data.entries = data.entries.filter((e) => e.timestamp >= cutoff);\r\n\r\n        // Prune daily summaries too\r\n        for (const key of Object.keys(data.dailySummaries)) {\r\n            if (key < cutoffDate) delete data.dailySummaries[key];\r\n        }\r\n\r\n        const pruned = before - data.entries.length;\r\n        if (pruned > 0) {\r\n            await this.write(data);\r\n            log.info(`Pruned ${pruned} old cost entries (retention: ${retentionDays}d)`);\r\n        }\r\n        return pruned;\r\n    }\r\n\r\n    /**\r\n     * Get summary totals for today, this week, and this month.\r\n     */\r\n    async getSummaryTotals(): Promise<{\r\n        today: number;\r\n        thisWeek: number;\r\n        thisMonth: number;\r\n        previousDay: number;\r\n        previousWeek: number;\r\n        previousMonth: number;\r\n    }> {\r\n        const now = new Date();\r\n        const todayStr = now.toISOString().slice(0, 10);\r\n\r\n        // Week start (Monday)\r\n        const dayOfWeek = now.getDay();\r\n        const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\r\n        const weekStart = new Date(now);\r\n        weekStart.setDate(now.getDate() - mondayOffset);\r\n        weekStart.setHours(0, 0, 0, 0);\r\n\r\n        // Month start\r\n        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\r\n\r\n        // Previous periods for comparison\r\n        const prevDayStr = new Date(now.getTime() - 86_400_000).toISOString().slice(0, 10);\r\n        const prevWeekStart = new Date(weekStart.getTime() - 7 * 86_400_000);\r\n        const prevMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n        const prevMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);\r\n\r\n        const data = await this.read();\r\n        const summaries = data.dailySummaries;\r\n\r\n        let today = 0;\r\n        let thisWeek = 0;\r\n        let thisMonth = 0;\r\n        let previousDay = 0;\r\n        let previousWeek = 0;\r\n        let previousMonth = 0;\r\n\r\n        for (const [date, summary] of Object.entries(summaries)) {\r\n            if (date === todayStr) today += summary.totalCost;\r\n            if (date === prevDayStr) previousDay += summary.totalCost;\r\n\r\n            if (date >= weekStart.toISOString().slice(0, 10) && date <= todayStr) {\r\n                thisWeek += summary.totalCost;\r\n            }\r\n            if (\r\n                date >= prevWeekStart.toISOString().slice(0, 10) &&\r\n                date < weekStart.toISOString().slice(0, 10)\r\n            ) {\r\n                previousWeek += summary.totalCost;\r\n            }\r\n\r\n            if (date >= monthStart.toISOString().slice(0, 10) && date <= todayStr) {\r\n                thisMonth += summary.totalCost;\r\n            }\r\n            if (\r\n                date >= prevMonthStart.toISOString().slice(0, 10) &&\r\n                date <= prevMonthEnd.toISOString().slice(0, 10)\r\n            ) {\r\n                previousMonth += summary.totalCost;\r\n            }\r\n        }\r\n\r\n        return { today, thisWeek, thisMonth, previousDay, previousWeek, previousMonth };\r\n    }\r\n}\r\n"]}