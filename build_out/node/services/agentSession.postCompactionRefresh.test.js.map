{"version":3,"file":"agentSession.postCompactionRefresh.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.postCompactionRefresh.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, mock, afterEach } from \"bun:test\";\r\nimport { AgentSession } from \"./agentSession\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport type { AIService } from \"./aiService\";\r\nimport type { InitStateManager } from \"./initStateManager\";\r\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { CostTrackingService } from \"./costTrackingService\";\r\n\r\n// NOTE: These tests focus on the event wiring (tool-call-end -> callback).\r\n// The actual post-compaction state computation is covered elsewhere.\r\n\r\ndescribe(\"AgentSession post-compaction refresh trigger\", () => {\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  test(\"triggers callback on file_edit_* tool-call-end\", async () => {\r\n    const handlers = new Map<string, (...args: unknown[]) => void>();\r\n\r\n    const aiService: AIService = {\r\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        handlers.set(String(eventName), listener);\r\n        return this;\r\n      },\r\n      off(_eventName: string | symbol, _listener: (...args: unknown[]) => void) {\r\n        return this;\r\n      },\r\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as AIService;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const initStateManager: InitStateManager = {\r\n      on(_eventName: string | symbol, _listener: (...args: unknown[]) => void) {\r\n        return this;\r\n      },\r\n      off(_eventName: string | symbol, _listener: (...args: unknown[]) => void) {\r\n        return this;\r\n      },\r\n    } as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager: BackgroundProcessManager = {\r\n      setMessageQueued: mock(() => undefined),\r\n      cleanup: mock(() => Promise.resolve()),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const config: Config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: mock(() => \"/tmp\"),\r\n    } as unknown as Config;\r\n    const partialService: PartialService = {} as unknown as PartialService;\r\n\r\n    const onPostCompactionStateChange = mock(() => undefined);\r\n\r\n    const session = new AgentSession({\r\n      workspaceId: \"ws\",\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n      onPostCompactionStateChange,\r\n    });\r\n\r\n    const toolEnd = handlers.get(\"tool-call-end\");\r\n    expect(toolEnd).toBeDefined();\r\n\r\n    toolEnd!({\r\n      type: \"tool-call-end\",\r\n      workspaceId: \"ws\",\r\n      messageId: \"m1\",\r\n      toolCallId: \"t1b\",\r\n      toolName: \"file_edit_replace_lines\",\r\n      result: {},\r\n      timestamp: Date.now(),\r\n    });\r\n\r\n    toolEnd!({\r\n      type: \"tool-call-end\",\r\n      workspaceId: \"ws\",\r\n      messageId: \"m1\",\r\n      toolCallId: \"t1\",\r\n      toolName: \"file_edit_insert\",\r\n      result: {},\r\n      timestamp: Date.now(),\r\n    });\r\n\r\n    toolEnd!({\r\n      type: \"tool-call-end\",\r\n      workspaceId: \"ws\",\r\n      messageId: \"m1\",\r\n      toolCallId: \"t2\",\r\n      toolName: \"bash\",\r\n      result: {},\r\n      timestamp: Date.now(),\r\n    });\r\n\r\n    expect(onPostCompactionStateChange).toHaveBeenCalledTimes(2);\r\n\r\n    session.dispose();\r\n  });\r\n});\r\n"]}