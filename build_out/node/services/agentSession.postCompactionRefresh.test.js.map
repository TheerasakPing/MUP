{"version":3,"file":"agentSession.postCompactionRefresh.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.postCompactionRefresh.test.ts"],"names":[],"mappings":";;AAAA,uCAAmE;AACnE,iDAA8C;AAM9C,6DAAgE;AAGhE,2EAA2E;AAC3E,qEAAqE;AAErE,IAAA,mBAAQ,EAAC,8CAA8C,EAAE,GAAG,EAAE,CAAC;IAC7D,IAAI,cAAiD,CAAC;IACtD,IAAA,oBAAS,EAAC,KAAK,IAAI,EAAE,CAAC;QACpB,MAAM,cAAc,EAAE,EAAE,CAAC;IAAA,CAC1B,CAAC,CAAC;IAEH,IAAA,eAAI,EAAC,gDAAgD,EAAE,KAAK,IAAI,EAAE,CAAC;QACjE,MAAM,QAAQ,GAAG,IAAI,GAAG,EAAwC,CAAC;QAEjE,MAAM,SAAS,GAAc;YAC3B,EAAE,CAAC,SAA0B,EAAE,QAAsC,EAAE;gBACrE,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,EAAE,QAAQ,CAAC,CAAC;gBAC1C,OAAO,IAAI,CAAC;YAAA,CACb;YACD,GAAG,CAAC,UAA2B,EAAE,SAAuC,EAAE;gBACxE,OAAO,IAAI,CAAC;YAAA,CACb;YACD,UAAU,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,IAAa,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAC;SAC7D,CAAC;QAE1B,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;QACrE,cAAc,GAAG,OAAO,CAAC;QAEzB,MAAM,gBAAgB,GAAqB;YACzC,EAAE,CAAC,UAA2B,EAAE,SAAuC,EAAE;gBACvE,OAAO,IAAI,CAAC;YAAA,CACb;YACD,GAAG,CAAC,UAA2B,EAAE,SAAuC,EAAE;gBACxE,OAAO,IAAI,CAAC;YAAA,CACb;SAC6B,CAAC;QAEjC,MAAM,wBAAwB,GAA6B;YACzD,gBAAgB,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,SAAS,CAAC;YACvC,OAAO,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;SACA,CAAC;QAEzC,MAAM,MAAM,GAAW;YACrB,MAAM,EAAE,MAAM;YACd,aAAa,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,MAAM,CAAC;SACb,CAAC;QACvB,MAAM,cAAc,GAAmB,EAA+B,CAAC;QAEvE,MAAM,2BAA2B,GAAG,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC;QAE1D,MAAM,OAAO,GAAG,IAAI,2BAAY,CAAC;YAC/B,WAAW,EAAE,IAAI;YACjB,MAAM;YACN,cAAc;YACd,cAAc;YACd,SAAS;YACT,gBAAgB;YAChB,mBAAmB,EAAE,EAAoC;YACzD,wBAAwB;YACxB,2BAA2B;SAC5B,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,QAAQ,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;QAC9C,IAAA,iBAAM,EAAC,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC;QAE9B,OAAQ,CAAC;YACP,IAAI,EAAE,eAAe;YACrB,WAAW,EAAE,IAAI;YACjB,SAAS,EAAE,IAAI;YACf,UAAU,EAAE,KAAK;YACjB,QAAQ,EAAE,yBAAyB;YACnC,MAAM,EAAE,EAAE;YACV,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC,CAAC;QAEH,OAAQ,CAAC;YACP,IAAI,EAAE,eAAe;YACrB,WAAW,EAAE,IAAI;YACjB,SAAS,EAAE,IAAI;YACf,UAAU,EAAE,IAAI;YAChB,QAAQ,EAAE,kBAAkB;YAC5B,MAAM,EAAE,EAAE;YACV,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC,CAAC;QAEH,OAAQ,CAAC;YACP,IAAI,EAAE,eAAe;YACrB,WAAW,EAAE,IAAI;YACjB,SAAS,EAAE,IAAI;YACf,UAAU,EAAE,IAAI;YAChB,QAAQ,EAAE,MAAM;YAChB,MAAM,EAAE,EAAE;YACV,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,2BAA2B,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QAE7D,OAAO,CAAC,OAAO,EAAE,CAAC;IAAA,CACnB,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, expect, test, mock, afterEach } from \"bun:test\";\nimport { AgentSession } from \"./agentSession\";\nimport type { Config } from \"@/node/config\";\nimport type { PartialService } from \"./partialService\";\nimport type { AIService } from \"./aiService\";\nimport type { InitStateManager } from \"./initStateManager\";\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport type { CostTrackingService } from \"./costTrackingService\";\n\n// NOTE: These tests focus on the event wiring (tool-call-end -> callback).\n// The actual post-compaction state computation is covered elsewhere.\n\ndescribe(\"AgentSession post-compaction refresh trigger\", () => {\n  let historyCleanup: (() => Promise<void>) | undefined;\n  afterEach(async () => {\n    await historyCleanup?.();\n  });\n\n  test(\"triggers callback on file_edit_* tool-call-end\", async () => {\n    const handlers = new Map<string, (...args: unknown[]) => void>();\n\n    const aiService: AIService = {\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        handlers.set(String(eventName), listener);\n        return this;\n      },\n      off(_eventName: string | symbol, _listener: (...args: unknown[]) => void) {\n        return this;\n      },\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as AIService;\n\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n\n    const initStateManager: InitStateManager = {\n      on(_eventName: string | symbol, _listener: (...args: unknown[]) => void) {\n        return this;\n      },\n      off(_eventName: string | symbol, _listener: (...args: unknown[]) => void) {\n        return this;\n      },\n    } as unknown as InitStateManager;\n\n    const backgroundProcessManager: BackgroundProcessManager = {\n      setMessageQueued: mock(() => undefined),\n      cleanup: mock(() => Promise.resolve()),\n    } as unknown as BackgroundProcessManager;\n\n    const config: Config = {\n      srcDir: \"/tmp\",\n      getSessionDir: mock(() => \"/tmp\"),\n    } as unknown as Config;\n    const partialService: PartialService = {} as unknown as PartialService;\n\n    const onPostCompactionStateChange = mock(() => undefined);\n\n    const session = new AgentSession({\n      workspaceId: \"ws\",\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService: {} as unknown as CostTrackingService,\n      backgroundProcessManager,\n      onPostCompactionStateChange,\n    });\n\n    const toolEnd = handlers.get(\"tool-call-end\");\n    expect(toolEnd).toBeDefined();\n\n    toolEnd!({\n      type: \"tool-call-end\",\n      workspaceId: \"ws\",\n      messageId: \"m1\",\n      toolCallId: \"t1b\",\n      toolName: \"file_edit_replace_lines\",\n      result: {},\n      timestamp: Date.now(),\n    });\n\n    toolEnd!({\n      type: \"tool-call-end\",\n      workspaceId: \"ws\",\n      messageId: \"m1\",\n      toolCallId: \"t1\",\n      toolName: \"file_edit_insert\",\n      result: {},\n      timestamp: Date.now(),\n    });\n\n    toolEnd!({\n      type: \"tool-call-end\",\n      workspaceId: \"ws\",\n      messageId: \"m1\",\n      toolCallId: \"t2\",\n      toolName: \"bash\",\n      result: {},\n      timestamp: Date.now(),\n    });\n\n    expect(onPostCompactionStateChange).toHaveBeenCalledTimes(2);\n\n    session.dispose();\n  });\n});\n"]}