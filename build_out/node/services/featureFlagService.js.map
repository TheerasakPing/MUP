{"version":3,"file":"featureFlagService.js","sourceRoot":"","sources":["../../../src/node/services/featureFlagService.ts"],"names":[],"mappings":";;;AAEA,kEAAoE;AAGpE,MAAM,iBAAiB,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;AAEzC;IACmB,MAAM,CAAS;IACf,gBAAgB,CAAmB;IAE5C,aAAa,GAAyD,IAAI,CAAC;IAEnF,YAAY,MAAc,EAAE,gBAAkC,EAAE;QAC9D,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;IAAA,CAC1C;IAEO,WAAW,GAAqB;QACtC,OAAO,IAAI,CAAC,MAAM,CAAC,sBAAsB,CAAC,gCAAiB,CAAC,UAAU,CAAC,CAAC;IAAA,CACzE;IAEO,KAAK,CAAC,UAAU,GAA6B;QACnD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,IAAI,IAAI,CAAC,aAAa,IAAI,GAAG,GAAG,IAAI,CAAC,aAAa,CAAC,SAAS,GAAG,iBAAiB,EAAE,CAAC;YACjF,OAAO,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC;QAClC,CAAC;QAED,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,gCAAiB,CAAC,UAAU,CAAC,CAAC;QAEvF,MAAM,OAAO,GAAoB,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;QAE3F,IAAI,CAAC,aAAa,GAAG,EAAE,KAAK,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG,EAAE,CAAC;QACxD,OAAO,OAAO,CAAC;IAAA,CAChB;IAED,KAAK,CAAC,gBAAgB,GAA2B;QAC/C,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QACpC,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,EAAE,CAAC;QAExC,6EAA6E;QAC7E,EAAE;QACF,0BAA0B;QAC1B,iDAAiD;QACjD,MAAM,OAAO,GAAG,QAAQ,KAAK,KAAK,CAAC;QAEnC,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC;IAAA,CACvC;IAED,KAAK,CAAC,mBAAmB,CAAC,QAA0B,EAA0B;QAC5E,MAAM,IAAI,CAAC,MAAM,CAAC,sBAAsB,CAAC,gCAAiB,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;QACjF,OAAO,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAAA,CAChC;CACF","sourcesContent":["import type { Config } from \"@/node/config\";\r\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\r\nimport { FEATURE_FLAG_KEYS } from \"@/common/constants/featureFlags\";\r\nimport type { StatsTabOverride, StatsTabState, StatsTabVariant } from \"./sessionTimingService\";\r\n\r\nconst FLAG_CACHE_TTL_MS = 10 * 60 * 1000;\r\n\r\nexport class FeatureFlagService {\r\n  private readonly config: Config;\r\n  private readonly telemetryService: TelemetryService;\r\n\r\n  private cachedVariant: { value: StatsTabVariant; fetchedAt: number } | null = null;\r\n\r\n  constructor(config: Config, telemetryService: TelemetryService) {\r\n    this.config = config;\r\n    this.telemetryService = telemetryService;\r\n  }\r\n\r\n  private getOverride(): StatsTabOverride {\r\n    return this.config.getFeatureFlagOverride(FEATURE_FLAG_KEYS.statsTabV1);\r\n  }\r\n\r\n  private async getVariant(): Promise<StatsTabVariant> {\r\n    const now = Date.now();\r\n    if (this.cachedVariant && now - this.cachedVariant.fetchedAt < FLAG_CACHE_TTL_MS) {\r\n      return this.cachedVariant.value;\r\n    }\r\n\r\n    const value = await this.telemetryService.getFeatureFlag(FEATURE_FLAG_KEYS.statsTabV1);\r\n\r\n    const variant: StatsTabVariant = value === true || value === \"stats\" ? \"stats\" : \"control\";\r\n\r\n    this.cachedVariant = { value: variant, fetchedAt: now };\r\n    return variant;\r\n  }\r\n\r\n  async getStatsTabState(): Promise<StatsTabState> {\r\n    const override = this.getOverride();\r\n    const variant = await this.getVariant();\r\n\r\n    // Stats tab is now default-on. Keep the persisted override as a kill switch.\r\n    //\r\n    // - \"off\": force disabled\r\n    // - \"on\" | \"default\": enabled (default behavior)\r\n    const enabled = override !== \"off\";\r\n\r\n    return { enabled, variant, override };\r\n  }\r\n\r\n  async setStatsTabOverride(override: StatsTabOverride): Promise<StatsTabState> {\r\n    await this.config.setFeatureFlagOverride(FEATURE_FLAG_KEYS.statsTabV1, override);\r\n    return this.getStatsTabState();\r\n  }\r\n}\r\n"]}