{"version":3,"file":"featureFlagService.js","sourceRoot":"","sources":["../../../src/node/services/featureFlagService.ts"],"names":[],"mappings":";;;AAEA,kEAAoE;AAGpE,MAAM,iBAAiB,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;AAEzC;IACmB,MAAM,CAAS;IACf,gBAAgB,CAAmB;IAE5C,aAAa,GAAyD,IAAI,CAAC;IAEnF,YAAY,MAAc,EAAE,gBAAkC,EAAE;QAC9D,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;IAAA,CAC1C;IAEO,WAAW,GAAqB;QACtC,OAAO,IAAI,CAAC,MAAM,CAAC,sBAAsB,CAAC,gCAAiB,CAAC,UAAU,CAAC,CAAC;IAAA,CACzE;IAEO,KAAK,CAAC,UAAU,GAA6B;QACnD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,IAAI,IAAI,CAAC,aAAa,IAAI,GAAG,GAAG,IAAI,CAAC,aAAa,CAAC,SAAS,GAAG,iBAAiB,EAAE,CAAC;YACjF,OAAO,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC;QAClC,CAAC;QAED,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,gCAAiB,CAAC,UAAU,CAAC,CAAC;QAEvF,MAAM,OAAO,GAAoB,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;QAE3F,IAAI,CAAC,aAAa,GAAG,EAAE,KAAK,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG,EAAE,CAAC;QACxD,OAAO,OAAO,CAAC;IAAA,CAChB;IAED,KAAK,CAAC,gBAAgB,GAA2B;QAC/C,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QACpC,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,EAAE,CAAC;QAExC,6EAA6E;QAC7E,EAAE;QACF,0BAA0B;QAC1B,iDAAiD;QACjD,MAAM,OAAO,GAAG,QAAQ,KAAK,KAAK,CAAC;QAEnC,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC;IAAA,CACvC;IAED,KAAK,CAAC,mBAAmB,CAAC,QAA0B,EAA0B;QAC5E,MAAM,IAAI,CAAC,MAAM,CAAC,sBAAsB,CAAC,gCAAiB,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;QACjF,OAAO,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAAA,CAChC;CACF","sourcesContent":["import type { Config } from \"@/node/config\";\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\nimport { FEATURE_FLAG_KEYS } from \"@/common/constants/featureFlags\";\nimport type { StatsTabOverride, StatsTabState, StatsTabVariant } from \"./sessionTimingService\";\n\nconst FLAG_CACHE_TTL_MS = 10 * 60 * 1000;\n\nexport class FeatureFlagService {\n  private readonly config: Config;\n  private readonly telemetryService: TelemetryService;\n\n  private cachedVariant: { value: StatsTabVariant; fetchedAt: number } | null = null;\n\n  constructor(config: Config, telemetryService: TelemetryService) {\n    this.config = config;\n    this.telemetryService = telemetryService;\n  }\n\n  private getOverride(): StatsTabOverride {\n    return this.config.getFeatureFlagOverride(FEATURE_FLAG_KEYS.statsTabV1);\n  }\n\n  private async getVariant(): Promise<StatsTabVariant> {\n    const now = Date.now();\n    if (this.cachedVariant && now - this.cachedVariant.fetchedAt < FLAG_CACHE_TTL_MS) {\n      return this.cachedVariant.value;\n    }\n\n    const value = await this.telemetryService.getFeatureFlag(FEATURE_FLAG_KEYS.statsTabV1);\n\n    const variant: StatsTabVariant = value === true || value === \"stats\" ? \"stats\" : \"control\";\n\n    this.cachedVariant = { value: variant, fetchedAt: now };\n    return variant;\n  }\n\n  async getStatsTabState(): Promise<StatsTabState> {\n    const override = this.getOverride();\n    const variant = await this.getVariant();\n\n    // Stats tab is now default-on. Keep the persisted override as a kill switch.\n    //\n    // - \"off\": force disabled\n    // - \"on\" | \"default\": enabled (default behavior)\n    const enabled = override !== \"off\";\n\n    return { enabled, variant, override };\n  }\n\n  async setStatsTabOverride(override: StatsTabOverride): Promise<StatsTabState> {\n    await this.config.setFeatureFlagOverride(FEATURE_FLAG_KEYS.statsTabV1, override);\n    return this.getStatsTabState();\n  }\n}\n"]}