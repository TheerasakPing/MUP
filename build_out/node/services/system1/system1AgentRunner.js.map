{"version":3,"file":"system1AgentRunner.js","sourceRoot":"","sources":["../../../../src/node/services/system1/system1AgentRunner.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\r\n\r\nimport { generateText, type LanguageModel, type Tool } from \"ai\";\r\n\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\n\r\nimport { resolveAgentBody } from \"@/node/services/agentDefinitions/agentDefinitionsService\";\r\nimport { createSystem1KeepRangesTool } from \"@/node/services/tools/system1_keep_ranges\";\r\nimport type { System1KeepRange } from \"@/node/services/system1/bashOutputFiltering\";\r\nimport { linkAbortSignal } from \"@/node/utils/abort\";\r\n\r\nexport type GenerateTextLike = (\r\n  args: Parameters<typeof generateText>[0]\r\n) => Promise<{ finishReason?: string }>;\r\nexport interface RunSystem1KeepRangesParams {\r\n  runtime: Runtime;\r\n  agentDiscoveryPath: string;\r\n  runtimeTempDir: string;\r\n\r\n  model: LanguageModel;\r\n  modelString: string;\r\n  providerOptions?: Record<string, unknown>;\r\n\r\n  // Optional short label describing what the bash command is doing (intent hint).\r\n  // This is intentionally lightweight to avoid bloating the System 1 prompt.\r\n  displayName?: string;\r\n\r\n  script: string;\r\n  numberedOutput: string;\r\n  maxKeptLines: number;\r\n\r\n  timeoutMs: number;\r\n  abortSignal?: AbortSignal;\r\n  onTimeout?: () => void;\r\n\r\n  // Testing hook: allows unit tests to stub the AI SDK call.\r\n  generateTextImpl?: GenerateTextLike;\r\n}\r\n\r\nexport async function runSystem1KeepRangesForBashOutput(\r\n  params: RunSystem1KeepRangesParams\r\n): Promise<\r\n  { keepRanges: System1KeepRange[]; finishReason?: string; timedOut: boolean } | undefined\r\n> {\r\n  assert(params, \"params is required\");\r\n  assert(params.runtime, \"runtime is required\");\r\n  assert(\r\n    typeof params.agentDiscoveryPath === \"string\" && params.agentDiscoveryPath.length > 0,\r\n    \"agentDiscoveryPath must be a non-empty string\"\r\n  );\r\n  assert(\r\n    typeof params.runtimeTempDir === \"string\" && params.runtimeTempDir.length > 0,\r\n    \"runtimeTempDir must be a non-empty string\"\r\n  );\r\n  assert(params.model, \"model is required\");\r\n  assert(\r\n    params.displayName === undefined || typeof params.displayName === \"string\",\r\n    \"displayName must be a string when provided\"\r\n  );\r\n  assert(\r\n    typeof params.modelString === \"string\" && params.modelString.length > 0,\r\n    \"modelString must be a non-empty string\"\r\n  );\r\n  assert(typeof params.script === \"string\", \"script must be a string\");\r\n  assert(\r\n    typeof params.numberedOutput === \"string\" && params.numberedOutput.length > 0,\r\n    \"numberedOutput must be a non-empty string\"\r\n  );\r\n  assert(\r\n    Number.isInteger(params.maxKeptLines) && params.maxKeptLines > 0,\r\n    \"maxKeptLines must be a positive integer\"\r\n  );\r\n  assert(\r\n    Number.isInteger(params.timeoutMs) && params.timeoutMs > 0,\r\n    \"timeoutMs must be a positive integer\"\r\n  );\r\n\r\n  // Intentionally keep the System 1 prompt minimal to avoid consuming context budget.\r\n  //\r\n  // Use the built-in definition for this internal agent. Allowing project/global overrides\r\n  // would introduce a new footgun compared to the previously hard-coded System1 prompt.\r\n  const systemPrompt = await resolveAgentBody(\r\n    params.runtime,\r\n    params.agentDiscoveryPath,\r\n    \"system1_bash\",\r\n    { skipScopesAbove: \"global\" }\r\n  );\r\n\r\n  const userMessageParts = [`maxKeptLines: ${params.maxKeptLines}`, \"\"];\r\n\r\n  const displayName =\r\n    typeof params.displayName === \"string\" && params.displayName.trim().length > 0\r\n      ? params.displayName.trim()\r\n      : undefined;\r\n  if (displayName) {\r\n    userMessageParts.push(`Display name:\\n${displayName}`, \"\");\r\n  }\r\n\r\n  userMessageParts.push(\r\n    `Bash script:\\n${params.script}`,\r\n    \"\",\r\n    `Numbered output:\\n${params.numberedOutput}`\r\n  );\r\n\r\n  const userMessage = userMessageParts.join(\"\\n\");\r\n\r\n  const system1AbortController = new AbortController();\r\n  const unlink = linkAbortSignal(params.abortSignal, system1AbortController);\r\n\r\n  let timedOut = false;\r\n  const timeout = setTimeout(() => {\r\n    timedOut = true;\r\n    params.onTimeout?.();\r\n    system1AbortController.abort();\r\n  }, params.timeoutMs);\r\n  timeout.unref?.();\r\n\r\n  // Some providers (Anthropic) reject requests that force tool use while also enabling\r\n  // \"thinking\". Since the System 1 agent already mandates tool usage, keep requests\r\n  // provider-agnostic and retry once with a stronger reminder if needed.\r\n  const attemptMessages: Array<NonNullable<Parameters<typeof generateText>[0][\"messages\"]>> = [\r\n    [{ role: \"user\", content: userMessage }],\r\n    [\r\n      { role: \"user\", content: userMessage },\r\n      {\r\n        role: \"user\",\r\n        content:\r\n          \"Reminder: You MUST call `system1_keep_ranges` exactly once. Do not output any text; only the tool call.\",\r\n      },\r\n    ],\r\n  ];\r\n\r\n  const generate = params.generateTextImpl ?? generateText;\r\n\r\n  try {\r\n    for (const messages of attemptMessages) {\r\n      let keepRanges: System1KeepRange[] | undefined;\r\n\r\n      const tools: Record<string, Tool> = {\r\n        system1_keep_ranges: createSystem1KeepRangesTool(\r\n          // This tool is pure/side-effect-free; config is unused.\r\n          // Provide a minimal config object for interface compatibility.\r\n          {\r\n            cwd: params.agentDiscoveryPath,\r\n            runtime: params.runtime,\r\n            runtimeTempDir: params.runtimeTempDir,\r\n          },\r\n          {\r\n            onKeepRanges: (ranges) => {\r\n              keepRanges = ranges;\r\n            },\r\n          }\r\n        ),\r\n      };\r\n\r\n      let response: Awaited<ReturnType<GenerateTextLike>>;\r\n      try {\r\n        response = await generate({\r\n          model: params.model,\r\n          system: systemPrompt,\r\n          messages,\r\n          tools,\r\n          abortSignal: system1AbortController.signal,\r\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-assignment\r\n          providerOptions: params.providerOptions as any,\r\n          maxOutputTokens: 300,\r\n          maxRetries: 0,\r\n        });\r\n      } catch (error) {\r\n        const errorName = error instanceof Error ? error.name : undefined;\r\n        if (errorName === \"AbortError\") {\r\n          return undefined;\r\n        }\r\n        throw error;\r\n      }\r\n\r\n      if (keepRanges && keepRanges.length > 0) {\r\n        return {\r\n          keepRanges,\r\n          finishReason: response.finishReason,\r\n          timedOut,\r\n        };\r\n      }\r\n    }\r\n\r\n    return undefined;\r\n  } finally {\r\n    clearTimeout(timeout);\r\n    unlink();\r\n  }\r\n}\r\n"]}