{"version":3,"file":"system1AgentRunner.js","sourceRoot":"","sources":["../../../../src/node/services/system1/system1AgentRunner.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\n\nimport { generateText, type LanguageModel, type Tool } from \"ai\";\n\nimport type { Runtime } from \"@/node/runtime/Runtime\";\n\nimport { resolveAgentBody } from \"@/node/services/agentDefinitions/agentDefinitionsService\";\nimport { createSystem1KeepRangesTool } from \"@/node/services/tools/system1_keep_ranges\";\nimport type { System1KeepRange } from \"@/node/services/system1/bashOutputFiltering\";\nimport { linkAbortSignal } from \"@/node/utils/abort\";\n\nexport type GenerateTextLike = (\n  args: Parameters<typeof generateText>[0]\n) => Promise<{ finishReason?: string }>;\nexport interface RunSystem1KeepRangesParams {\n  runtime: Runtime;\n  agentDiscoveryPath: string;\n  runtimeTempDir: string;\n\n  model: LanguageModel;\n  modelString: string;\n  providerOptions?: Record<string, unknown>;\n\n  // Optional short label describing what the bash command is doing (intent hint).\n  // This is intentionally lightweight to avoid bloating the System 1 prompt.\n  displayName?: string;\n\n  script: string;\n  numberedOutput: string;\n  maxKeptLines: number;\n\n  timeoutMs: number;\n  abortSignal?: AbortSignal;\n  onTimeout?: () => void;\n\n  // Testing hook: allows unit tests to stub the AI SDK call.\n  generateTextImpl?: GenerateTextLike;\n}\n\nexport async function runSystem1KeepRangesForBashOutput(\n  params: RunSystem1KeepRangesParams\n): Promise<\n  { keepRanges: System1KeepRange[]; finishReason?: string; timedOut: boolean } | undefined\n> {\n  assert(params, \"params is required\");\n  assert(params.runtime, \"runtime is required\");\n  assert(\n    typeof params.agentDiscoveryPath === \"string\" && params.agentDiscoveryPath.length > 0,\n    \"agentDiscoveryPath must be a non-empty string\"\n  );\n  assert(\n    typeof params.runtimeTempDir === \"string\" && params.runtimeTempDir.length > 0,\n    \"runtimeTempDir must be a non-empty string\"\n  );\n  assert(params.model, \"model is required\");\n  assert(\n    params.displayName === undefined || typeof params.displayName === \"string\",\n    \"displayName must be a string when provided\"\n  );\n  assert(\n    typeof params.modelString === \"string\" && params.modelString.length > 0,\n    \"modelString must be a non-empty string\"\n  );\n  assert(typeof params.script === \"string\", \"script must be a string\");\n  assert(\n    typeof params.numberedOutput === \"string\" && params.numberedOutput.length > 0,\n    \"numberedOutput must be a non-empty string\"\n  );\n  assert(\n    Number.isInteger(params.maxKeptLines) && params.maxKeptLines > 0,\n    \"maxKeptLines must be a positive integer\"\n  );\n  assert(\n    Number.isInteger(params.timeoutMs) && params.timeoutMs > 0,\n    \"timeoutMs must be a positive integer\"\n  );\n\n  // Intentionally keep the System 1 prompt minimal to avoid consuming context budget.\n  //\n  // Use the built-in definition for this internal agent. Allowing project/global overrides\n  // would introduce a new footgun compared to the previously hard-coded System1 prompt.\n  const systemPrompt = await resolveAgentBody(\n    params.runtime,\n    params.agentDiscoveryPath,\n    \"system1_bash\",\n    { skipScopesAbove: \"global\" }\n  );\n\n  const userMessageParts = [`maxKeptLines: ${params.maxKeptLines}`, \"\"];\n\n  const displayName =\n    typeof params.displayName === \"string\" && params.displayName.trim().length > 0\n      ? params.displayName.trim()\n      : undefined;\n  if (displayName) {\n    userMessageParts.push(`Display name:\\n${displayName}`, \"\");\n  }\n\n  userMessageParts.push(\n    `Bash script:\\n${params.script}`,\n    \"\",\n    `Numbered output:\\n${params.numberedOutput}`\n  );\n\n  const userMessage = userMessageParts.join(\"\\n\");\n\n  const system1AbortController = new AbortController();\n  const unlink = linkAbortSignal(params.abortSignal, system1AbortController);\n\n  let timedOut = false;\n  const timeout = setTimeout(() => {\n    timedOut = true;\n    params.onTimeout?.();\n    system1AbortController.abort();\n  }, params.timeoutMs);\n  timeout.unref?.();\n\n  // Some providers (Anthropic) reject requests that force tool use while also enabling\n  // \"thinking\". Since the System 1 agent already mandates tool usage, keep requests\n  // provider-agnostic and retry once with a stronger reminder if needed.\n  const attemptMessages: Array<NonNullable<Parameters<typeof generateText>[0][\"messages\"]>> = [\n    [{ role: \"user\", content: userMessage }],\n    [\n      { role: \"user\", content: userMessage },\n      {\n        role: \"user\",\n        content:\n          \"Reminder: You MUST call `system1_keep_ranges` exactly once. Do not output any text; only the tool call.\",\n      },\n    ],\n  ];\n\n  const generate = params.generateTextImpl ?? generateText;\n\n  try {\n    for (const messages of attemptMessages) {\n      let keepRanges: System1KeepRange[] | undefined;\n\n      const tools: Record<string, Tool> = {\n        system1_keep_ranges: createSystem1KeepRangesTool(\n          // This tool is pure/side-effect-free; config is unused.\n          // Provide a minimal config object for interface compatibility.\n          {\n            cwd: params.agentDiscoveryPath,\n            runtime: params.runtime,\n            runtimeTempDir: params.runtimeTempDir,\n          },\n          {\n            onKeepRanges: (ranges) => {\n              keepRanges = ranges;\n            },\n          }\n        ),\n      };\n\n      let response: Awaited<ReturnType<GenerateTextLike>>;\n      try {\n        response = await generate({\n          model: params.model,\n          system: systemPrompt,\n          messages,\n          tools,\n          abortSignal: system1AbortController.signal,\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-assignment\n          providerOptions: params.providerOptions as any,\n          maxOutputTokens: 300,\n          maxRetries: 0,\n        });\n      } catch (error) {\n        const errorName = error instanceof Error ? error.name : undefined;\n        if (errorName === \"AbortError\") {\n          return undefined;\n        }\n        throw error;\n      }\n\n      if (keepRanges && keepRanges.length > 0) {\n        return {\n          keepRanges,\n          finishReason: response.finishReason,\n          timedOut,\n        };\n      }\n    }\n\n    return undefined;\n  } finally {\n    clearTimeout(timeout);\n    unlink();\n  }\n}\n"]}