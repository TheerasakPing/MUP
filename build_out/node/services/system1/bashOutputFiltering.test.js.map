{"version":3,"file":"bashOutputFiltering.test.js","sourceRoot":"","sources":["../../../../src/node/services/system1/bashOutputFiltering.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport {\n  applySystem1KeepRangesToOutput,\n  formatNumberedLinesForSystem1,\n  getHeuristicKeepRangesForBashOutput,\n  formatSystem1BashFilterNotice,\n  splitBashOutputLines,\n} from \"./bashOutputFiltering\";\n\ndescribe(\"bashOutputFiltering\", () => {\n  describe(\"splitBashOutputLines\", () => {\n    it(\"returns [] for empty output\", () => {\n      expect(splitBashOutputLines(\"\")).toEqual([]);\n    });\n\n    it(\"splits on newlines\", () => {\n      expect(splitBashOutputLines(\"a\\nb\\nc\")).toEqual([\"a\", \"b\", \"c\"]);\n    });\n  });\n\n  describe(\"formatNumberedLinesForSystem1\", () => {\n    it(\"adds 1-based line numbers\", () => {\n      expect(formatNumberedLinesForSystem1([\"a\", \"b\"]).split(\"\\n\")).toEqual([\"0001| a\", \"0002| b\"]);\n    });\n  });\n\n  describe(\"formatSystem1BashFilterNotice\", () => {\n    it(\"includes a cleanup warning when fullOutputPath is present\", () => {\n      const notice = formatSystem1BashFilterNotice({\n        keptLines: 1,\n        totalLines: 2,\n        trigger: \"lines\",\n        fullOutputPath: \"/tmp/bash-s1.txt\",\n      });\n\n      expect(notice).toContain(\"Full output saved to /tmp/bash-s1.txt\");\n      expect(notice).toContain(\"automatically cleaned up\");\n      expect(notice).toContain(\"may already be gone\");\n    });\n\n    it(\"omits the full output path when fullOutputPath is missing\", () => {\n      const notice = formatSystem1BashFilterNotice({\n        keptLines: 1,\n        totalLines: 2,\n        trigger: \"bytes\",\n      });\n\n      expect(notice).toBe(\"Auto-filtered output: kept 1/2 lines (trigger: bytes).\");\n    });\n  });\n\n  describe(\"getHeuristicKeepRangesForBashOutput\", () => {\n    it(\"keeps error context and respects maxKeptLines\", () => {\n      const rawOutput = [\n        \"starting...\",\n        \"step 1 ok\",\n        \"ERROR: expected X, got Y\",\n        \"  at path/to/file.ts:12:3\",\n        \"done\",\n      ].join(\"\\n\");\n\n      const lines = splitBashOutputLines(rawOutput);\n      const keepRanges = getHeuristicKeepRangesForBashOutput({\n        lines,\n        maxKeptLines: 3,\n      });\n\n      const applied = applySystem1KeepRangesToOutput({\n        rawOutput,\n        keepRanges,\n        maxKeptLines: 3,\n      });\n\n      expect(applied).toBeDefined();\n      expect(applied?.keptLines).toBeLessThanOrEqual(3);\n      expect(applied?.filteredOutput).toContain(\"ERROR:\");\n    });\n\n    it(\"treats git conflict markers as important lines\", () => {\n      const rawOutput = [\n        \"start\",\n        \"src/foo.ts:1:<<<<<<< HEAD\",\n        \"src/foo.ts:2:=======\",\n        \"src/foo.ts:3:>>>>>>> main\",\n        \"end\",\n      ].join(\"\\n\");\n\n      const lines = splitBashOutputLines(rawOutput);\n      const keepRanges = getHeuristicKeepRangesForBashOutput({\n        lines,\n        maxKeptLines: 10,\n      });\n\n      const applied = applySystem1KeepRangesToOutput({\n        rawOutput,\n        keepRanges,\n        maxKeptLines: 10,\n      });\n\n      expect(applied).toBeDefined();\n      expect(applied?.filteredOutput).toContain(\"<<<<<<<\");\n      expect(applied?.filteredOutput).toContain(\"=======\");\n      expect(applied?.filteredOutput).toContain(\">>>>>>>\");\n    });\n  });\n\n  describe(\"applySystem1KeepRangesToOutput\", () => {\n    it(\"returns undefined when keep ranges are empty\", () => {\n      const applied = applySystem1KeepRangesToOutput({\n        rawOutput: \"a\\nb\\nc\",\n        keepRanges: [],\n        maxKeptLines: 10,\n      });\n      expect(applied).toBeUndefined();\n    });\n\n    it(\"clamps and swaps out-of-order ranges\", () => {\n      const applied = applySystem1KeepRangesToOutput({\n        rawOutput: \"a\\nb\\nc\\nd\\ne\",\n        keepRanges: [{ start: 10, end: 2 }],\n        maxKeptLines: 10,\n      });\n\n      expect(applied).toEqual({\n        filteredOutput: \"b\\nc\\nd\\ne\",\n        keptLines: 4,\n        totalLines: 5,\n      });\n    });\n\n    it(\"merges overlapping ranges and enforces maxKeptLines\", () => {\n      const applied = applySystem1KeepRangesToOutput({\n        rawOutput: \"a\\nb\\nc\\nd\\ne\\nf\",\n        keepRanges: [\n          { start: 2, end: 4 },\n          { start: 4, end: 6 },\n        ],\n        maxKeptLines: 3,\n      });\n\n      expect(applied).toEqual({\n        filteredOutput: \"b\\nc\\nd\",\n        keptLines: 3,\n        totalLines: 6,\n      });\n\n      // Subset-only guarantee: every kept line must exist in the original output.\n      const rawLines = splitBashOutputLines(\"a\\nb\\nc\\nd\\ne\\nf\");\n      const keptLines = splitBashOutputLines(applied!.filteredOutput);\n      for (const line of keptLines) {\n        expect(rawLines.includes(line)).toBe(true);\n      }\n    });\n  });\n});\n"]}