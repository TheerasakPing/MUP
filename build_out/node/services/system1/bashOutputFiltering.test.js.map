{"version":3,"file":"bashOutputFiltering.test.js","sourceRoot":"","sources":["../../../../src/node/services/system1/bashOutputFiltering.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport {\r\n  applySystem1KeepRangesToOutput,\r\n  formatNumberedLinesForSystem1,\r\n  getHeuristicKeepRangesForBashOutput,\r\n  formatSystem1BashFilterNotice,\r\n  splitBashOutputLines,\r\n} from \"./bashOutputFiltering\";\r\n\r\ndescribe(\"bashOutputFiltering\", () => {\r\n  describe(\"splitBashOutputLines\", () => {\r\n    it(\"returns [] for empty output\", () => {\r\n      expect(splitBashOutputLines(\"\")).toEqual([]);\r\n    });\r\n\r\n    it(\"splits on newlines\", () => {\r\n      expect(splitBashOutputLines(\"a\\nb\\nc\")).toEqual([\"a\", \"b\", \"c\"]);\r\n    });\r\n  });\r\n\r\n  describe(\"formatNumberedLinesForSystem1\", () => {\r\n    it(\"adds 1-based line numbers\", () => {\r\n      expect(formatNumberedLinesForSystem1([\"a\", \"b\"]).split(\"\\n\")).toEqual([\"0001| a\", \"0002| b\"]);\r\n    });\r\n  });\r\n\r\n  describe(\"formatSystem1BashFilterNotice\", () => {\r\n    it(\"includes a cleanup warning when fullOutputPath is present\", () => {\r\n      const notice = formatSystem1BashFilterNotice({\r\n        keptLines: 1,\r\n        totalLines: 2,\r\n        trigger: \"lines\",\r\n        fullOutputPath: \"/tmp/bash-s1.txt\",\r\n      });\r\n\r\n      expect(notice).toContain(\"Full output saved to /tmp/bash-s1.txt\");\r\n      expect(notice).toContain(\"automatically cleaned up\");\r\n      expect(notice).toContain(\"may already be gone\");\r\n    });\r\n\r\n    it(\"omits the full output path when fullOutputPath is missing\", () => {\r\n      const notice = formatSystem1BashFilterNotice({\r\n        keptLines: 1,\r\n        totalLines: 2,\r\n        trigger: \"bytes\",\r\n      });\r\n\r\n      expect(notice).toBe(\"Auto-filtered output: kept 1/2 lines (trigger: bytes).\");\r\n    });\r\n  });\r\n\r\n  describe(\"getHeuristicKeepRangesForBashOutput\", () => {\r\n    it(\"keeps error context and respects maxKeptLines\", () => {\r\n      const rawOutput = [\r\n        \"starting...\",\r\n        \"step 1 ok\",\r\n        \"ERROR: expected X, got Y\",\r\n        \"  at path/to/file.ts:12:3\",\r\n        \"done\",\r\n      ].join(\"\\n\");\r\n\r\n      const lines = splitBashOutputLines(rawOutput);\r\n      const keepRanges = getHeuristicKeepRangesForBashOutput({\r\n        lines,\r\n        maxKeptLines: 3,\r\n      });\r\n\r\n      const applied = applySystem1KeepRangesToOutput({\r\n        rawOutput,\r\n        keepRanges,\r\n        maxKeptLines: 3,\r\n      });\r\n\r\n      expect(applied).toBeDefined();\r\n      expect(applied?.keptLines).toBeLessThanOrEqual(3);\r\n      expect(applied?.filteredOutput).toContain(\"ERROR:\");\r\n    });\r\n\r\n    it(\"treats git conflict markers as important lines\", () => {\r\n      const rawOutput = [\r\n        \"start\",\r\n        \"src/foo.ts:1:<<<<<<< HEAD\",\r\n        \"src/foo.ts:2:=======\",\r\n        \"src/foo.ts:3:>>>>>>> main\",\r\n        \"end\",\r\n      ].join(\"\\n\");\r\n\r\n      const lines = splitBashOutputLines(rawOutput);\r\n      const keepRanges = getHeuristicKeepRangesForBashOutput({\r\n        lines,\r\n        maxKeptLines: 10,\r\n      });\r\n\r\n      const applied = applySystem1KeepRangesToOutput({\r\n        rawOutput,\r\n        keepRanges,\r\n        maxKeptLines: 10,\r\n      });\r\n\r\n      expect(applied).toBeDefined();\r\n      expect(applied?.filteredOutput).toContain(\"<<<<<<<\");\r\n      expect(applied?.filteredOutput).toContain(\"=======\");\r\n      expect(applied?.filteredOutput).toContain(\">>>>>>>\");\r\n    });\r\n  });\r\n\r\n  describe(\"applySystem1KeepRangesToOutput\", () => {\r\n    it(\"returns undefined when keep ranges are empty\", () => {\r\n      const applied = applySystem1KeepRangesToOutput({\r\n        rawOutput: \"a\\nb\\nc\",\r\n        keepRanges: [],\r\n        maxKeptLines: 10,\r\n      });\r\n      expect(applied).toBeUndefined();\r\n    });\r\n\r\n    it(\"clamps and swaps out-of-order ranges\", () => {\r\n      const applied = applySystem1KeepRangesToOutput({\r\n        rawOutput: \"a\\nb\\nc\\nd\\ne\",\r\n        keepRanges: [{ start: 10, end: 2 }],\r\n        maxKeptLines: 10,\r\n      });\r\n\r\n      expect(applied).toEqual({\r\n        filteredOutput: \"b\\nc\\nd\\ne\",\r\n        keptLines: 4,\r\n        totalLines: 5,\r\n      });\r\n    });\r\n\r\n    it(\"merges overlapping ranges and enforces maxKeptLines\", () => {\r\n      const applied = applySystem1KeepRangesToOutput({\r\n        rawOutput: \"a\\nb\\nc\\nd\\ne\\nf\",\r\n        keepRanges: [\r\n          { start: 2, end: 4 },\r\n          { start: 4, end: 6 },\r\n        ],\r\n        maxKeptLines: 3,\r\n      });\r\n\r\n      expect(applied).toEqual({\r\n        filteredOutput: \"b\\nc\\nd\",\r\n        keptLines: 3,\r\n        totalLines: 6,\r\n      });\r\n\r\n      // Subset-only guarantee: every kept line must exist in the original output.\r\n      const rawLines = splitBashOutputLines(\"a\\nb\\nc\\nd\\ne\\nf\");\r\n      const keptLines = splitBashOutputLines(applied!.filteredOutput);\r\n      for (const line of keptLines) {\r\n        expect(rawLines.includes(line)).toBe(true);\r\n      }\r\n    });\r\n  });\r\n});\r\n"]}