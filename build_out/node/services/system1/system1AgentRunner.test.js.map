{"version":3,"file":"system1AgentRunner.test.js","sourceRoot":"","sources":["../../../../src/node/services/system1/system1AgentRunner.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport type { LanguageModel } from \"ai\";\r\nimport * as fs from \"node:fs/promises\";\r\nimport * as os from \"node:os\";\r\nimport * as path from \"node:path\";\r\n\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport { runSystem1KeepRangesForBashOutput } from \"./system1AgentRunner\";\r\n\r\n// NOTE: These tests do not exercise a real model.\r\n// We inject a stub generateTextImpl that simulates the model calling the tool.\r\n\r\ndescribe(\"system1AgentRunner\", () => {\r\n  it(\"returns keep ranges when the model calls system1_keep_ranges\", async () => {\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n\r\n    let calls = 0;\r\n\r\n    const result = await runSystem1KeepRangesForBashOutput({\r\n      runtime,\r\n      agentDiscoveryPath: process.cwd(),\r\n      runtimeTempDir: os.tmpdir(),\r\n      model: {} as unknown as LanguageModel,\r\n      modelString: \"openai:gpt-5.1-codex-mini\",\r\n      providerOptions: {},\r\n      script: \"echo hi\",\r\n      numberedOutput: \"0001| hi\\n0002| ERROR: bad\\n0003| at x\",\r\n      maxKeptLines: 10,\r\n      timeoutMs: 5_000,\r\n      generateTextImpl: async (args) => {\r\n        calls += 1;\r\n\r\n        // Tool use is mandated by the system1_bash agent prompt.\r\n        // Do not force tool_choice at the API layer (some providers reject that + thinking).\r\n        expect((args as { toolChoice?: unknown }).toolChoice).toBeUndefined();\r\n\r\n        const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\r\n        expect(tools && \"system1_keep_ranges\" in tools).toBe(true);\r\n\r\n        // Simulate the model calling the tool.\r\n        const keepRangesTool = tools!.system1_keep_ranges as {\r\n          execute: (input: unknown, options: unknown) => unknown;\r\n        };\r\n\r\n        await keepRangesTool.execute({ keep_ranges: [{ start: 2, end: 3, reason: \"error\" }] }, {});\r\n\r\n        return { finishReason: \"stop\" };\r\n      },\r\n    });\r\n\r\n    expect(calls).toBe(1);\r\n    expect(result).toEqual({\r\n      keepRanges: [{ start: 2, end: 3, reason: \"error\" }],\r\n      finishReason: \"stop\",\r\n      timedOut: false,\r\n    });\r\n  });\r\n\r\n  it(\"includes display name in the user message when provided\", async () => {\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n\r\n    let calls = 0;\r\n\r\n    const result = await runSystem1KeepRangesForBashOutput({\r\n      runtime,\r\n      agentDiscoveryPath: process.cwd(),\r\n      runtimeTempDir: os.tmpdir(),\r\n      model: {} as unknown as LanguageModel,\r\n      modelString: \"openai:gpt-5.1-codex-mini\",\r\n      providerOptions: {},\r\n      displayName: \"List files\",\r\n      script: \"ls\",\r\n      numberedOutput: \"0001| a\\n0002| b\\n0003| c\",\r\n      maxKeptLines: 10,\r\n      timeoutMs: 5_000,\r\n      generateTextImpl: async (args) => {\r\n        calls += 1;\r\n\r\n        const messages = (args as { messages?: unknown }).messages as\r\n          | Array<{ content?: unknown }>\r\n          | undefined;\r\n        expect(Array.isArray(messages)).toBe(true);\r\n\r\n        const firstContent = messages?.[0]?.content;\r\n        expect(typeof firstContent).toBe(\"string\");\r\n        expect(firstContent as string).toContain(\"Display name:\");\r\n        expect(firstContent as string).toContain(\"List files\");\r\n\r\n        const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\r\n\r\n        // Simulate the model calling the tool.\r\n        const keepRangesTool = tools!.system1_keep_ranges as {\r\n          execute: (input: unknown, options: unknown) => unknown;\r\n        };\r\n\r\n        await keepRangesTool.execute({ keep_ranges: [{ start: 1, end: 1, reason: \"first\" }] }, {});\r\n\r\n        return { finishReason: \"stop\" };\r\n      },\r\n    });\r\n\r\n    expect(calls).toBe(1);\r\n    expect(result).toEqual({\r\n      keepRanges: [{ start: 1, end: 1, reason: \"first\" }],\r\n      finishReason: \"stop\",\r\n      timedOut: false,\r\n    });\r\n  });\r\n\r\n  it(\"ignores project overrides of the internal system1_bash agent prompt\", async () => {\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n\r\n    const projectDir = await fs.mkdtemp(path.join(os.tmpdir(), \"system1-runner-project-\"));\r\n    try {\r\n      const agentsDir = path.join(projectDir, \".mux\", \"agents\");\r\n      await fs.mkdir(agentsDir, { recursive: true });\r\n      await fs.writeFile(\r\n        path.join(agentsDir, \"system1_bash.md\"),\r\n        [\r\n          \"---\",\r\n          \"name: Override System1 Bash\",\r\n          \"ui:\",\r\n          \"  hidden: true\",\r\n          \"subagent:\",\r\n          \"  runnable: false\",\r\n          \"---\",\r\n          \"OVERRIDE_DO_NOT_USE\",\r\n          \"\",\r\n        ].join(\"\\n\"),\r\n        \"utf8\"\r\n      );\r\n\r\n      const result = await runSystem1KeepRangesForBashOutput({\r\n        runtime,\r\n        agentDiscoveryPath: projectDir,\r\n        runtimeTempDir: os.tmpdir(),\r\n        model: {} as unknown as LanguageModel,\r\n        modelString: \"openai:gpt-5.1-codex-mini\",\r\n        providerOptions: {},\r\n        script: \"echo hi\",\r\n        numberedOutput: \"0001| hi\",\r\n        maxKeptLines: 10,\r\n        timeoutMs: 5_000,\r\n        generateTextImpl: async (args) => {\r\n          expect((args as { toolChoice?: unknown }).toolChoice).toBeUndefined();\r\n\r\n          const system = (args as { system?: unknown }).system;\r\n          expect(typeof system).toBe(\"string\");\r\n          expect(system).not.toContain(\"OVERRIDE_DO_NOT_USE\");\r\n\r\n          const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\r\n          expect(tools && \"system1_keep_ranges\" in tools).toBe(true);\r\n\r\n          const keepRangesTool = tools!.system1_keep_ranges as {\r\n            execute: (input: unknown, options: unknown) => unknown;\r\n          };\r\n          await keepRangesTool.execute({ keep_ranges: [{ start: 1, end: 1, reason: \"hi\" }] }, {});\r\n\r\n          return { finishReason: \"stop\" };\r\n        },\r\n      });\r\n\r\n      expect(result).toEqual({\r\n        keepRanges: [{ start: 1, end: 1, reason: \"hi\" }],\r\n        finishReason: \"stop\",\r\n        timedOut: false,\r\n      });\r\n    } finally {\r\n      await fs.rm(projectDir, { recursive: true, force: true });\r\n    }\r\n  });\r\n\r\n  it(\"retries once with a reminder if the model does not call the tool\", async () => {\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n\r\n    let calls = 0;\r\n\r\n    const result = await runSystem1KeepRangesForBashOutput({\r\n      runtime,\r\n      agentDiscoveryPath: process.cwd(),\r\n      runtimeTempDir: os.tmpdir(),\r\n      model: {} as unknown as LanguageModel,\r\n      modelString: \"openai:gpt-5.1-codex-mini\",\r\n      providerOptions: {},\r\n      script: \"echo hi\",\r\n      numberedOutput: \"0001| hi\",\r\n      maxKeptLines: 10,\r\n      timeoutMs: 5_000,\r\n      generateTextImpl: async (args) => {\r\n        calls += 1;\r\n\r\n        const messages = (args as { messages?: unknown }).messages as\r\n          | Array<{ content?: unknown }>\r\n          | undefined;\r\n        expect(Array.isArray(messages)).toBe(true);\r\n\r\n        if (calls === 1) {\r\n          expect(messages!.length).toBe(1);\r\n          return { finishReason: \"stop\" };\r\n        }\r\n\r\n        expect(messages!.length).toBe(2);\r\n        expect(messages![1]?.content).toBe(\r\n          \"Reminder: You MUST call `system1_keep_ranges` exactly once. Do not output any text; only the tool call.\"\r\n        );\r\n\r\n        const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\r\n        const keepRangesTool = tools!.system1_keep_ranges as {\r\n          execute: (input: unknown, options: unknown) => unknown;\r\n        };\r\n\r\n        await keepRangesTool.execute({ keep_ranges: [{ start: 1, end: 1, reason: \"hi\" }] }, {});\r\n        return { finishReason: \"stop\" };\r\n      },\r\n    });\r\n\r\n    expect(calls).toBe(2);\r\n    expect(result).toEqual({\r\n      keepRanges: [{ start: 1, end: 1, reason: \"hi\" }],\r\n      finishReason: \"stop\",\r\n      timedOut: false,\r\n    });\r\n  });\r\n\r\n  it(\"returns undefined when the model does not call the tool\", async () => {\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n\r\n    let calls = 0;\r\n\r\n    const result = await runSystem1KeepRangesForBashOutput({\r\n      runtime,\r\n      agentDiscoveryPath: process.cwd(),\r\n      runtimeTempDir: os.tmpdir(),\r\n      model: {} as unknown as LanguageModel,\r\n      modelString: \"openai:gpt-5.1-codex-mini\",\r\n      providerOptions: {},\r\n      script: \"echo hi\",\r\n      numberedOutput: \"0001| hi\",\r\n      maxKeptLines: 10,\r\n      timeoutMs: 5_000,\r\n      generateTextImpl: () => {\r\n        calls += 1;\r\n        return Promise.resolve({ finishReason: \"stop\" });\r\n      },\r\n    });\r\n\r\n    expect(calls).toBe(2);\r\n    expect(result).toBeUndefined();\r\n  });\r\n\r\n  it(\"returns undefined on AbortError\", async () => {\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n\r\n    let calls = 0;\r\n\r\n    const result = await runSystem1KeepRangesForBashOutput({\r\n      runtime,\r\n      agentDiscoveryPath: process.cwd(),\r\n      runtimeTempDir: os.tmpdir(),\r\n      model: {} as unknown as LanguageModel,\r\n      modelString: \"openai:gpt-5.1-codex-mini\",\r\n      providerOptions: {},\r\n      script: \"echo hi\",\r\n      numberedOutput: \"0001| hi\",\r\n      maxKeptLines: 10,\r\n      timeoutMs: 5_000,\r\n      generateTextImpl: () => {\r\n        calls += 1;\r\n        const err = new Error(\"aborted\");\r\n        err.name = \"AbortError\";\r\n        return Promise.reject(err);\r\n      },\r\n    });\r\n\r\n    expect(calls).toBe(1);\r\n    expect(result).toBeUndefined();\r\n  });\r\n});\r\n"]}