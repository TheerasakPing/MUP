{"version":3,"file":"system1AgentRunner.test.js","sourceRoot":"","sources":["../../../../src/node/services/system1/system1AgentRunner.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport type { LanguageModel } from \"ai\";\nimport * as fs from \"node:fs/promises\";\nimport * as os from \"node:os\";\nimport * as path from \"node:path\";\n\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\nimport { runSystem1KeepRangesForBashOutput } from \"./system1AgentRunner\";\n\n// NOTE: These tests do not exercise a real model.\n// We inject a stub generateTextImpl that simulates the model calling the tool.\n\ndescribe(\"system1AgentRunner\", () => {\n  it(\"returns keep ranges when the model calls system1_keep_ranges\", async () => {\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\n\n    let calls = 0;\n\n    const result = await runSystem1KeepRangesForBashOutput({\n      runtime,\n      agentDiscoveryPath: process.cwd(),\n      runtimeTempDir: os.tmpdir(),\n      model: {} as unknown as LanguageModel,\n      modelString: \"openai:gpt-5.1-codex-mini\",\n      providerOptions: {},\n      script: \"echo hi\",\n      numberedOutput: \"0001| hi\\n0002| ERROR: bad\\n0003| at x\",\n      maxKeptLines: 10,\n      timeoutMs: 5_000,\n      generateTextImpl: async (args) => {\n        calls += 1;\n\n        // Tool use is mandated by the system1_bash agent prompt.\n        // Do not force tool_choice at the API layer (some providers reject that + thinking).\n        expect((args as { toolChoice?: unknown }).toolChoice).toBeUndefined();\n\n        const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\n        expect(tools && \"system1_keep_ranges\" in tools).toBe(true);\n\n        // Simulate the model calling the tool.\n        const keepRangesTool = tools!.system1_keep_ranges as {\n          execute: (input: unknown, options: unknown) => unknown;\n        };\n\n        await keepRangesTool.execute({ keep_ranges: [{ start: 2, end: 3, reason: \"error\" }] }, {});\n\n        return { finishReason: \"stop\" };\n      },\n    });\n\n    expect(calls).toBe(1);\n    expect(result).toEqual({\n      keepRanges: [{ start: 2, end: 3, reason: \"error\" }],\n      finishReason: \"stop\",\n      timedOut: false,\n    });\n  });\n\n  it(\"includes display name in the user message when provided\", async () => {\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\n\n    let calls = 0;\n\n    const result = await runSystem1KeepRangesForBashOutput({\n      runtime,\n      agentDiscoveryPath: process.cwd(),\n      runtimeTempDir: os.tmpdir(),\n      model: {} as unknown as LanguageModel,\n      modelString: \"openai:gpt-5.1-codex-mini\",\n      providerOptions: {},\n      displayName: \"List files\",\n      script: \"ls\",\n      numberedOutput: \"0001| a\\n0002| b\\n0003| c\",\n      maxKeptLines: 10,\n      timeoutMs: 5_000,\n      generateTextImpl: async (args) => {\n        calls += 1;\n\n        const messages = (args as { messages?: unknown }).messages as\n          | Array<{ content?: unknown }>\n          | undefined;\n        expect(Array.isArray(messages)).toBe(true);\n\n        const firstContent = messages?.[0]?.content;\n        expect(typeof firstContent).toBe(\"string\");\n        expect(firstContent as string).toContain(\"Display name:\");\n        expect(firstContent as string).toContain(\"List files\");\n\n        const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\n\n        // Simulate the model calling the tool.\n        const keepRangesTool = tools!.system1_keep_ranges as {\n          execute: (input: unknown, options: unknown) => unknown;\n        };\n\n        await keepRangesTool.execute({ keep_ranges: [{ start: 1, end: 1, reason: \"first\" }] }, {});\n\n        return { finishReason: \"stop\" };\n      },\n    });\n\n    expect(calls).toBe(1);\n    expect(result).toEqual({\n      keepRanges: [{ start: 1, end: 1, reason: \"first\" }],\n      finishReason: \"stop\",\n      timedOut: false,\n    });\n  });\n\n  it(\"ignores project overrides of the internal system1_bash agent prompt\", async () => {\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\n\n    const projectDir = await fs.mkdtemp(path.join(os.tmpdir(), \"system1-runner-project-\"));\n    try {\n      const agentsDir = path.join(projectDir, \".mux\", \"agents\");\n      await fs.mkdir(agentsDir, { recursive: true });\n      await fs.writeFile(\n        path.join(agentsDir, \"system1_bash.md\"),\n        [\n          \"---\",\n          \"name: Override System1 Bash\",\n          \"ui:\",\n          \"  hidden: true\",\n          \"subagent:\",\n          \"  runnable: false\",\n          \"---\",\n          \"OVERRIDE_DO_NOT_USE\",\n          \"\",\n        ].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const result = await runSystem1KeepRangesForBashOutput({\n        runtime,\n        agentDiscoveryPath: projectDir,\n        runtimeTempDir: os.tmpdir(),\n        model: {} as unknown as LanguageModel,\n        modelString: \"openai:gpt-5.1-codex-mini\",\n        providerOptions: {},\n        script: \"echo hi\",\n        numberedOutput: \"0001| hi\",\n        maxKeptLines: 10,\n        timeoutMs: 5_000,\n        generateTextImpl: async (args) => {\n          expect((args as { toolChoice?: unknown }).toolChoice).toBeUndefined();\n\n          const system = (args as { system?: unknown }).system;\n          expect(typeof system).toBe(\"string\");\n          expect(system).not.toContain(\"OVERRIDE_DO_NOT_USE\");\n\n          const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\n          expect(tools && \"system1_keep_ranges\" in tools).toBe(true);\n\n          const keepRangesTool = tools!.system1_keep_ranges as {\n            execute: (input: unknown, options: unknown) => unknown;\n          };\n          await keepRangesTool.execute({ keep_ranges: [{ start: 1, end: 1, reason: \"hi\" }] }, {});\n\n          return { finishReason: \"stop\" };\n        },\n      });\n\n      expect(result).toEqual({\n        keepRanges: [{ start: 1, end: 1, reason: \"hi\" }],\n        finishReason: \"stop\",\n        timedOut: false,\n      });\n    } finally {\n      await fs.rm(projectDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"retries once with a reminder if the model does not call the tool\", async () => {\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\n\n    let calls = 0;\n\n    const result = await runSystem1KeepRangesForBashOutput({\n      runtime,\n      agentDiscoveryPath: process.cwd(),\n      runtimeTempDir: os.tmpdir(),\n      model: {} as unknown as LanguageModel,\n      modelString: \"openai:gpt-5.1-codex-mini\",\n      providerOptions: {},\n      script: \"echo hi\",\n      numberedOutput: \"0001| hi\",\n      maxKeptLines: 10,\n      timeoutMs: 5_000,\n      generateTextImpl: async (args) => {\n        calls += 1;\n\n        const messages = (args as { messages?: unknown }).messages as\n          | Array<{ content?: unknown }>\n          | undefined;\n        expect(Array.isArray(messages)).toBe(true);\n\n        if (calls === 1) {\n          expect(messages!.length).toBe(1);\n          return { finishReason: \"stop\" };\n        }\n\n        expect(messages!.length).toBe(2);\n        expect(messages![1]?.content).toBe(\n          \"Reminder: You MUST call `system1_keep_ranges` exactly once. Do not output any text; only the tool call.\"\n        );\n\n        const tools = (args as { tools?: unknown }).tools as Record<string, unknown> | undefined;\n        const keepRangesTool = tools!.system1_keep_ranges as {\n          execute: (input: unknown, options: unknown) => unknown;\n        };\n\n        await keepRangesTool.execute({ keep_ranges: [{ start: 1, end: 1, reason: \"hi\" }] }, {});\n        return { finishReason: \"stop\" };\n      },\n    });\n\n    expect(calls).toBe(2);\n    expect(result).toEqual({\n      keepRanges: [{ start: 1, end: 1, reason: \"hi\" }],\n      finishReason: \"stop\",\n      timedOut: false,\n    });\n  });\n\n  it(\"returns undefined when the model does not call the tool\", async () => {\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\n\n    let calls = 0;\n\n    const result = await runSystem1KeepRangesForBashOutput({\n      runtime,\n      agentDiscoveryPath: process.cwd(),\n      runtimeTempDir: os.tmpdir(),\n      model: {} as unknown as LanguageModel,\n      modelString: \"openai:gpt-5.1-codex-mini\",\n      providerOptions: {},\n      script: \"echo hi\",\n      numberedOutput: \"0001| hi\",\n      maxKeptLines: 10,\n      timeoutMs: 5_000,\n      generateTextImpl: () => {\n        calls += 1;\n        return Promise.resolve({ finishReason: \"stop\" });\n      },\n    });\n\n    expect(calls).toBe(2);\n    expect(result).toBeUndefined();\n  });\n\n  it(\"returns undefined on AbortError\", async () => {\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\n\n    let calls = 0;\n\n    const result = await runSystem1KeepRangesForBashOutput({\n      runtime,\n      agentDiscoveryPath: process.cwd(),\n      runtimeTempDir: os.tmpdir(),\n      model: {} as unknown as LanguageModel,\n      modelString: \"openai:gpt-5.1-codex-mini\",\n      providerOptions: {},\n      script: \"echo hi\",\n      numberedOutput: \"0001| hi\",\n      maxKeptLines: 10,\n      timeoutMs: 5_000,\n      generateTextImpl: () => {\n        calls += 1;\n        const err = new Error(\"aborted\");\n        err.name = \"AbortError\";\n        return Promise.reject(err);\n      },\n    });\n\n    expect(calls).toBe(1);\n    expect(result).toBeUndefined();\n  });\n});\n"]}