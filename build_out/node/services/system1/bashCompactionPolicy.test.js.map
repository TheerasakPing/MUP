{"version":3,"file":"bashCompactionPolicy.test.js","sourceRoot":"","sources":["../../../../src/node/services/system1/bashCompactionPolicy.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport { homedir } from \"os\";\r\n\r\nimport {\r\n  classifyBashIntent,\r\n  decideBashOutputCompaction,\r\n  isBashOutputAlreadyTargeted,\r\n} from \"./bashCompactionPolicy\";\r\n\r\ndescribe(\"bashCompactionPolicy\", () => {\r\n  describe(\"isBashOutputAlreadyTargeted\", () => {\r\n    it(\"detects common output-slicing commands\", () => {\r\n      expect(isBashOutputAlreadyTargeted(\"sudo head -n 1 some.log\")).toBe(true);\r\n      expect(isBashOutputAlreadyTargeted(\"rg foo . | head -n 50\")).toBe(true);\r\n      expect(isBashOutputAlreadyTargeted(\"tail -n 100 some.log\")).toBe(true);\r\n      expect(isBashOutputAlreadyTargeted(\"sed -n '1,200p' file.txt\")).toBe(true);\r\n      expect(isBashOutputAlreadyTargeted(\"awk 'NR>=10 && NR<=20 {print}' file.txt\")).toBe(true);\r\n    });\r\n\r\n    it(\"returns false for non-targeted scripts\", () => {\r\n      expect(isBashOutputAlreadyTargeted(\"ls -la\")).toBe(false);\r\n      expect(isBashOutputAlreadyTargeted(\"rg foo .\")).toBe(false);\r\n      expect(isBashOutputAlreadyTargeted(\"git rev-parse HEAD\")).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"classifyBashIntent\", () => {\r\n    it(\"classifies exploration via display name keywords\", () => {\r\n      expect(classifyBashIntent({ script: \"echo hi\", displayName: \"List files\" })).toBe(\r\n        \"exploration\"\r\n      );\r\n      expect(classifyBashIntent({ script: \"echo hi\", displayName: \"Search repo\" })).toBe(\r\n        \"exploration\"\r\n      );\r\n    });\r\n\r\n    it(\"classifies exploration via common commands\", () => {\r\n      expect(classifyBashIntent({ script: \"ls -la\" })).toBe(\"exploration\");\r\n      expect(classifyBashIntent({ script: \"git status --porcelain\" })).toBe(\"exploration\");\r\n      expect(classifyBashIntent({ script: \"find . -maxdepth 2 -type f\" })).toBe(\"exploration\");\r\n    });\r\n\r\n    it(\"classifies logs for build/test commands\", () => {\r\n      expect(classifyBashIntent({ script: \"make test\" })).toBe(\"logs\");\r\n      expect(classifyBashIntent({ script: \"bun test\" })).toBe(\"logs\");\r\n    });\r\n  });\r\n\r\n  describe(\"decideBashOutputCompaction\", () => {\r\n    it(\"skips when output is below configured thresholds\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"ls\",\r\n        totalLines: 5,\r\n        totalBytes: 1_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.shouldCompact).toBe(false);\r\n      expect(decision.skipReason).toBe(\"below_threshold\");\r\n      expect(decision.triggeredByLines).toBe(false);\r\n      expect(decision.triggeredByBytes).toBe(false);\r\n    });\r\n\r\n    it(\"skips compaction for already-targeted scripts\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"rg foo . | head -n 50\",\r\n        totalLines: 200,\r\n        totalBytes: 10_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.shouldCompact).toBe(false);\r\n      expect(decision.skipReason).toBe(\"already_targeted_script\");\r\n    });\r\n\r\n    it(\"skips compaction when script reads the configured plan file\", () => {\r\n      const planFilePath = \"~/.mux/plans/my-project/my-workspace.md\";\r\n      const scripts = [\r\n        `cat ${planFilePath}`,\r\n        `bat ${planFilePath}`,\r\n        `python -c \"print(open('${planFilePath}').read())\"`,\r\n      ];\r\n\r\n      for (const script of scripts) {\r\n        const decision = decideBashOutputCompaction({\r\n          toolName: \"bash\",\r\n          script,\r\n          planFilePath,\r\n          totalLines: 200,\r\n          totalBytes: 10_000,\r\n          minLines: 10,\r\n          minTotalBytes: 4 * 1024,\r\n          maxKeptLines: 40,\r\n        });\r\n\r\n        expect(decision.shouldCompact).toBe(false);\r\n        expect(decision.skipReason).toBe(\"plan_file_in_script\");\r\n      }\r\n    });\r\n\r\n    it(\"skips compaction when script and planFilePath use different home path forms\", () => {\r\n      const homePosix = homedir().replaceAll(\"\\\\\\\\\", \"/\");\r\n      const tildePlanFilePath = \"~/.mux/plans/my-project/my-workspace.md\";\r\n      const expandedPlanFilePath = `${homePosix}/.mux/plans/my-project/my-workspace.md`;\r\n\r\n      const tildeDecision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: `cat ${tildePlanFilePath}`,\r\n        planFilePath: expandedPlanFilePath,\r\n        totalLines: 200,\r\n        totalBytes: 10_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(tildeDecision.shouldCompact).toBe(false);\r\n      expect(tildeDecision.skipReason).toBe(\"plan_file_in_script\");\r\n\r\n      const expandedDecision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: `cat ${expandedPlanFilePath}`,\r\n        planFilePath: tildePlanFilePath,\r\n        totalLines: 200,\r\n        totalBytes: 10_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(expandedDecision.shouldCompact).toBe(false);\r\n      expect(expandedDecision.skipReason).toBe(\"plan_file_in_script\");\r\n    });\r\n\r\n    it(\"keeps default compaction behavior for non-plan file scripts\", () => {\r\n      const planFilePath = \"~/.mux/plans/my-project/my-workspace.md\";\r\n      const scripts = [\"cat ./stdout.log\", \"cat file | rg needle\"];\r\n\r\n      for (const script of scripts) {\r\n        const decision = decideBashOutputCompaction({\r\n          toolName: \"bash\",\r\n          script,\r\n          planFilePath,\r\n          totalLines: 200,\r\n          totalBytes: 10_000,\r\n          minLines: 10,\r\n          minTotalBytes: 4 * 1024,\r\n          maxKeptLines: 40,\r\n        });\r\n\r\n        expect(decision.shouldCompact).toBe(true);\r\n        expect(decision.skipReason).toBeUndefined();\r\n      }\r\n    });\r\n\r\n    it(\"skips compaction for small exploration output\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"ls\",\r\n        totalLines: 50,\r\n        totalBytes: 8_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.intent).toBe(\"exploration\");\r\n      expect(decision.shouldCompact).toBe(false);\r\n      expect(decision.skipReason).toBe(\"exploration_output_small\");\r\n    });\r\n\r\n    it(\"skips compaction for conflict-marker searches when output is within tool limits\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: 'rg \"<<<<<<<|=======|>>>>>>>\" .',\r\n        totalLines: 150,\r\n        totalBytes: 10_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.shouldCompact).toBe(false);\r\n      expect(decision.skipReason).toBe(\"conflict_marker_search_within_limits\");\r\n    });\r\n\r\n    it(\"boosts maxKeptLines for conflict-marker searches when output exceeds tool limits\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: 'rg \"<<<<<<<|=======|>>>>>>>\" .',\r\n        totalLines: 400,\r\n        totalBytes: 20_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.shouldCompact).toBe(true);\r\n      expect(decision.skipReason).toBeUndefined();\r\n      expect(decision.effectiveMaxKeptLines).toBe(300);\r\n    });\r\n\r\n    it(\"respects user maxKeptLines for small exploration output\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"ls\",\r\n        totalLines: 50,\r\n        totalBytes: 8_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 20,\r\n      });\r\n\r\n      expect(decision.intent).toBe(\"exploration\");\r\n      expect(decision.shouldCompact).toBe(true);\r\n      expect(decision.skipReason).toBeUndefined();\r\n      expect(decision.effectiveMaxKeptLines).toBe(20);\r\n    });\r\n\r\n    it(\"respects user thresholds for small exploration output\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"ls\",\r\n        totalLines: 50,\r\n        totalBytes: 8_000,\r\n        minLines: 0,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.intent).toBe(\"exploration\");\r\n      expect(decision.shouldCompact).toBe(true);\r\n      expect(decision.skipReason).toBeUndefined();\r\n      expect(decision.effectiveMaxKeptLines).toBe(40);\r\n    });\r\n\r\n    it(\"does not boost maxKeptLines when thresholds are user-set\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"find . -type f\",\r\n        totalLines: 200,\r\n        totalBytes: 14_000,\r\n        minLines: 0,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.intent).toBe(\"exploration\");\r\n      expect(decision.shouldCompact).toBe(true);\r\n      expect(decision.skipReason).toBeUndefined();\r\n      expect(decision.effectiveMaxKeptLines).toBe(40);\r\n    });\r\n\r\n    it(\"boosts maxKeptLines for large exploration output when using the default budget\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"find . -type f\",\r\n        totalLines: 200,\r\n        totalBytes: 14_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.intent).toBe(\"exploration\");\r\n      expect(decision.shouldCompact).toBe(true);\r\n      expect(decision.effectiveMaxKeptLines).toBe(120);\r\n    });\r\n\r\n    it(\"keeps default behavior for logs\", () => {\r\n      const decision = decideBashOutputCompaction({\r\n        toolName: \"bash\",\r\n        script: \"make test\",\r\n        totalLines: 200,\r\n        totalBytes: 14_000,\r\n        minLines: 10,\r\n        minTotalBytes: 4 * 1024,\r\n        maxKeptLines: 40,\r\n      });\r\n\r\n      expect(decision.intent).toBe(\"logs\");\r\n      expect(decision.shouldCompact).toBe(true);\r\n      expect(decision.effectiveMaxKeptLines).toBe(40);\r\n    });\r\n  });\r\n});\r\n"]}