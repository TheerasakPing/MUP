{"version":3,"file":"bashCompactionPolicy.js","sourceRoot":"","sources":["../../../../src/node/services/system1/bashCompactionPolicy.ts"],"names":[],"mappings":"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","sourcesContent":["import { homedir } from \"os\";\r\n\r\nimport assert from \"@/common/utils/assert\";\r\nimport { BASH_HARD_MAX_LINES, BASH_MAX_TOTAL_BYTES } from \"@/common/constants/toolLimits\";\r\nimport { SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS } from \"@/common/types/tasks\";\r\n\r\nexport type BashOutputIntent = \"exploration\" | \"logs\" | \"unknown\";\r\n\r\nexport function isBashOutputAlreadyTargeted(script: string): boolean {\r\n  assert(typeof script === \"string\", \"script must be a string\");\r\n\r\n  const trimmed = script.trim();\r\n  if (trimmed.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  // If the script already limits output to a slice (head/tail/line ranges), further denoising is\r\n  // likely to drop exactly what the caller asked to see.\r\n  //\r\n  // NOTE: Avoid false positives like `git rev-parse HEAD`.\r\n  const statementSegments = trimmed\r\n    .split(/(?:\\r?\\n|&&|;)+/)\r\n    .map((part) => part.trim())\r\n    .filter(Boolean);\r\n\r\n  const slicingCommands = new Set([\"head\", \"tail\"]);\r\n  for (const statement of statementSegments) {\r\n    const pipeSegments = statement\r\n      .split(\"|\")\r\n      .map((part) => part.trim())\r\n      .filter(Boolean);\r\n\r\n    for (const pipeSegment of pipeSegments) {\r\n      const tokens = pipeSegment.split(/\\s+/).filter(Boolean);\r\n      if (tokens.length === 0) {\r\n        continue;\r\n      }\r\n\r\n      const cmd0 = (tokens[0] ?? \"\").toLowerCase();\r\n      const cmd1 = (tokens[1] ?? \"\").toLowerCase();\r\n\r\n      if (slicingCommands.has(cmd0)) {\r\n        return true;\r\n      }\r\n\r\n      // Common wrapper: `sudo head ...`.\r\n      if ((cmd0 === \"sudo\" || cmd0 === \"command\") && slicingCommands.has(cmd1)) {\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (/\\bsed\\b[^\\n]*\\s-n\\s+['\"]?\\d+\\s*,\\s*\\d+\\s*p['\"]?/i.test(trimmed)) {\r\n    return true;\r\n  }\r\n\r\n  if (/\\bawk\\b[^\\n]*\\bNR\\s*(==|!=|>=|<=|>|<)\\s*\\d+/i.test(trimmed)) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction normalizeDisplayName(displayName: string | undefined): string | undefined {\r\n  if (typeof displayName !== \"string\") {\r\n    return undefined;\r\n  }\r\n\r\n  const trimmed = displayName.trim();\r\n  return trimmed.length > 0 ? trimmed : undefined;\r\n}\r\n\r\nfunction getFirstNonTrivialCommand(script: string): { cmd: string; args: string[] } | undefined {\r\n  const segments = script\r\n    .split(/(?:\\r?\\n|&&|;)+/)\r\n    .map((part) => part.trim())\r\n    .filter(Boolean);\r\n\r\n  const ignoredCommands = new Set([\"cd\", \"pushd\", \"popd\", \"export\", \"set\"]);\r\n\r\n  for (const segment of segments) {\r\n    const tokens = segment.split(/\\s+/).filter(Boolean);\r\n    if (tokens.length === 0) {\r\n      continue;\r\n    }\r\n\r\n    const rawCmd = tokens[0] ?? \"\";\r\n    const cmd = rawCmd.replace(/^\\\\/, \"\");\r\n\r\n    if (!cmd || ignoredCommands.has(cmd)) {\r\n      continue;\r\n    }\r\n\r\n    return { cmd, args: tokens.slice(1) };\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport function classifyBashIntent(params: {\r\n  script: string;\r\n  displayName?: string;\r\n}): BashOutputIntent {\r\n  assert(params, \"params is required\");\r\n  assert(typeof params.script === \"string\", \"script must be a string\");\r\n\r\n  const displayName = normalizeDisplayName(params.displayName);\r\n  if (displayName) {\r\n    const normalized = displayName.toLowerCase();\r\n    if (/\\b(list|explore|search|scan)\\b/.test(normalized)) {\r\n      return \"exploration\";\r\n    }\r\n  }\r\n\r\n  const first = getFirstNonTrivialCommand(params.script);\r\n  if (first) {\r\n    const cmd = first.cmd.toLowerCase();\r\n    const arg0 = first.args[0]?.toLowerCase();\r\n\r\n    const explorationCommands = new Set([\"ls\", \"find\", \"fd\", \"tree\", \"rg\", \"grep\"]);\r\n    if (explorationCommands.has(cmd)) {\r\n      return \"exploration\";\r\n    }\r\n\r\n    if (cmd === \"git\" && (arg0 === \"ls-files\" || arg0 === \"status\")) {\r\n      return \"exploration\";\r\n    }\r\n\r\n    const logCommands = new Set([\"make\", \"bun\", \"npm\", \"yarn\", \"pnpm\"]);\r\n    if (logCommands.has(cmd)) {\r\n      return \"logs\";\r\n    }\r\n  }\r\n\r\n  return \"unknown\";\r\n}\r\n\r\nfunction isGitConflictMarkerSearch(script: string): boolean {\r\n  assert(typeof script === \"string\", \"script must be a string\");\r\n\r\n  const trimmed = script.trim();\r\n  if (trimmed.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  const literalNeedles = [\"<<<<<<<\", \">>>>>>>\", \"=======\", \"|||||||\"];\r\n  for (const needle of literalNeedles) {\r\n    if (trimmed.includes(needle)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  // Common regex quantifier forms (used in `rg`/`grep` patterns).\r\n  const quantifierNeedles = [\"<{7}\", \">{7}\", \"={7}\", \"|{7}\"];\r\n  for (const needle of quantifierNeedles) {\r\n    if (trimmed.includes(needle)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction scriptMentionsPlanFile(script: string, planFilePath: string | undefined): boolean {\r\n  assert(typeof script === \"string\", \"script must be a string\");\r\n\r\n  if (typeof planFilePath !== \"string\") {\r\n    return false;\r\n  }\r\n\r\n  const trimmedPlanFilePath = planFilePath.trim();\r\n  if (trimmedPlanFilePath.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  const needles = new Set<string>();\r\n\r\n  const addNeedle = (needle: string): void => {\r\n    const trimmed = needle.trim();\r\n    if (trimmed.length === 0) {\r\n      return;\r\n    }\r\n\r\n    needles.add(trimmed);\r\n  };\r\n\r\n  const addNeedleVariants = (needle: string): void => {\r\n    addNeedle(needle);\r\n    addNeedle(needle.replaceAll(\"\\\\\\\\\", \"/\"));\r\n  };\r\n\r\n  addNeedleVariants(trimmedPlanFilePath);\r\n\r\n  const home = homedir();\r\n  const homePosix = home.replaceAll(\"\\\\\\\\\", \"/\");\r\n\r\n  if (trimmedPlanFilePath === \"~\") {\r\n    addNeedleVariants(home);\r\n    addNeedleVariants(homePosix);\r\n  } else if (trimmedPlanFilePath.startsWith(\"~/\") || trimmedPlanFilePath.startsWith(\"~\\\\\\\\\")) {\r\n    const suffix = trimmedPlanFilePath.slice(1);\r\n    addNeedleVariants(`${home}${suffix}`);\r\n    addNeedleVariants(`${homePosix}${suffix.replaceAll(\"\\\\\\\\\", \"/\")}`);\r\n  }\r\n\r\n  // Also match the `~` form when the configured plan path is already expanded.\r\n  for (const candidateHome of [home, homePosix]) {\r\n    if (!trimmedPlanFilePath.startsWith(candidateHome)) {\r\n      continue;\r\n    }\r\n\r\n    const suffix = trimmedPlanFilePath.slice(candidateHome.length);\r\n    if (suffix.length > 0 && !suffix.startsWith(\"/\") && !suffix.startsWith(\"\\\\\\\\\")) {\r\n      continue;\r\n    }\r\n\r\n    addNeedleVariants(`~${suffix}`);\r\n  }\r\n\r\n  for (const needle of needles) {\r\n    if (script.includes(needle)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport type BashOutputCompactionSkipReason =\r\n  | \"below_threshold\"\r\n  | \"already_targeted_script\"\r\n  | \"plan_file_in_script\"\r\n  | \"exploration_output_small\"\r\n  | \"conflict_marker_search_within_limits\";\r\n\r\nexport interface BashOutputCompactionDecision {\r\n  shouldCompact: boolean;\r\n  skipReason?: BashOutputCompactionSkipReason;\r\n\r\n  triggeredByLines: boolean;\r\n  triggeredByBytes: boolean;\r\n\r\n  alreadyTargeted: boolean;\r\n  intent: BashOutputIntent;\r\n\r\n  effectiveMaxKeptLines: number;\r\n}\r\n\r\nconst EXPLORATION_SKIP_MAX_LINES = 120;\r\nconst EXPLORATION_SKIP_MAX_BYTES = 12 * 1024;\r\nconst EXPLORATION_BOOST_MAX_KEPT_LINES = 120;\r\n\r\nexport function decideBashOutputCompaction(params: {\r\n  toolName: string;\r\n  script: string;\r\n  displayName?: string;\r\n  planFilePath?: string;\r\n\r\n  totalLines: number;\r\n  totalBytes: number;\r\n\r\n  minLines: number;\r\n  minTotalBytes: number;\r\n  maxKeptLines: number;\r\n}): BashOutputCompactionDecision {\r\n  assert(params, \"params is required\");\r\n  assert(\r\n    typeof params.toolName === \"string\" && params.toolName.length > 0,\r\n    \"toolName must be a non-empty string\"\r\n  );\r\n  assert(typeof params.script === \"string\", \"script must be a string\");\r\n  assert(\r\n    typeof params.planFilePath === \"string\" || typeof params.planFilePath === \"undefined\",\r\n    \"planFilePath must be a string if provided\"\r\n  );\r\n  assert(\r\n    Number.isInteger(params.totalLines) && params.totalLines >= 0,\r\n    \"totalLines must be a non-negative integer\"\r\n  );\r\n  assert(\r\n    Number.isInteger(params.totalBytes) && params.totalBytes >= 0,\r\n    \"totalBytes must be a non-negative integer\"\r\n  );\r\n  assert(Number.isInteger(params.minLines) && params.minLines >= 0, \"minLines must be >= 0\");\r\n  assert(\r\n    Number.isInteger(params.minTotalBytes) && params.minTotalBytes >= 0,\r\n    \"minTotalBytes must be >= 0\"\r\n  );\r\n  assert(\r\n    Number.isInteger(params.maxKeptLines) && params.maxKeptLines > 0,\r\n    \"maxKeptLines must be a positive integer\"\r\n  );\r\n\r\n  const triggeredByLines = params.totalLines > params.minLines;\r\n  const triggeredByBytes = params.totalBytes > params.minTotalBytes;\r\n\r\n  let intent: BashOutputIntent = \"unknown\";\r\n  let alreadyTargeted = false;\r\n  let effectiveMaxKeptLines = params.maxKeptLines;\r\n\r\n  if (!triggeredByLines && !triggeredByBytes) {\r\n    return {\r\n      shouldCompact: false,\r\n      skipReason: \"below_threshold\",\r\n      triggeredByLines,\r\n      triggeredByBytes,\r\n      alreadyTargeted,\r\n      intent,\r\n      effectiveMaxKeptLines,\r\n    };\r\n  }\r\n\r\n  if (params.toolName === \"bash\") {\r\n    alreadyTargeted = isBashOutputAlreadyTargeted(params.script);\r\n    intent = classifyBashIntent({ script: params.script, displayName: params.displayName });\r\n\r\n    if (scriptMentionsPlanFile(params.script, params.planFilePath)) {\r\n      // Plan Mode invariant: the plan file is the source of truth. System1 compaction can drop\r\n      // the middle of the document, forcing extra tool calls and/or leading to incorrect plans.\r\n      return {\r\n        shouldCompact: false,\r\n        skipReason: \"plan_file_in_script\",\r\n        triggeredByLines,\r\n        triggeredByBytes,\r\n        alreadyTargeted,\r\n        intent,\r\n        effectiveMaxKeptLines,\r\n      };\r\n    }\r\n\r\n    if (alreadyTargeted) {\r\n      return {\r\n        shouldCompact: false,\r\n        skipReason: \"already_targeted_script\",\r\n        triggeredByLines,\r\n        triggeredByBytes,\r\n        alreadyTargeted,\r\n        intent,\r\n        effectiveMaxKeptLines,\r\n      };\r\n    }\r\n\r\n    const defaultMinLines =\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default;\r\n    const defaultMinTotalBytes =\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default;\r\n    const defaultMaxKeptLines =\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default;\r\n\r\n    // If a user has customized compaction settings, respect those limits even for exploration output.\r\n    const isDefaultCompactionConfig =\r\n      params.minLines === defaultMinLines &&\r\n      params.minTotalBytes === defaultMinTotalBytes &&\r\n      params.maxKeptLines === defaultMaxKeptLines;\r\n\r\n    const isConflictMarkerSearch = isGitConflictMarkerSearch(params.script);\r\n\r\n    if (\r\n      isDefaultCompactionConfig &&\r\n      isConflictMarkerSearch &&\r\n      params.totalLines <= BASH_HARD_MAX_LINES &&\r\n      params.totalBytes <= BASH_MAX_TOTAL_BYTES\r\n    ) {\r\n      return {\r\n        shouldCompact: false,\r\n        skipReason: \"conflict_marker_search_within_limits\",\r\n        triggeredByLines,\r\n        triggeredByBytes,\r\n        alreadyTargeted,\r\n        intent,\r\n        effectiveMaxKeptLines,\r\n      };\r\n    }\r\n\r\n    if (\r\n      intent === \"exploration\" &&\r\n      params.totalLines <= EXPLORATION_SKIP_MAX_LINES &&\r\n      params.totalBytes <= EXPLORATION_SKIP_MAX_BYTES\r\n    ) {\r\n      // Skip the System1 call only when compaction settings are at their defaults. This avoids\r\n      // bypassing explicit user limits (e.g. when they've lowered max-kept-lines or forced compaction).\r\n      if (isDefaultCompactionConfig) {\r\n        return {\r\n          shouldCompact: false,\r\n          skipReason: \"exploration_output_small\",\r\n          triggeredByLines,\r\n          triggeredByBytes,\r\n          alreadyTargeted,\r\n          intent,\r\n          effectiveMaxKeptLines,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Guardrail: only override when the caller still uses the default budget and thresholds.\r\n    if (isDefaultCompactionConfig) {\r\n      if (isConflictMarkerSearch) {\r\n        effectiveMaxKeptLines = BASH_HARD_MAX_LINES;\r\n      } else if (intent === \"exploration\") {\r\n        effectiveMaxKeptLines = Math.min(\r\n          BASH_HARD_MAX_LINES,\r\n          Math.max(params.maxKeptLines, EXPLORATION_BOOST_MAX_KEPT_LINES)\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  assert(\r\n    Number.isInteger(effectiveMaxKeptLines) && effectiveMaxKeptLines > 0,\r\n    \"effectiveMaxKeptLines must be a positive integer\"\r\n  );\r\n\r\n  return {\r\n    shouldCompact: true,\r\n    triggeredByLines,\r\n    triggeredByBytes,\r\n    alreadyTargeted,\r\n    intent,\r\n    effectiveMaxKeptLines,\r\n  };\r\n}\r\n"]}