{"version":3,"file":"bashCompactionPolicy.js","sourceRoot":"","sources":["../../../../src/node/services/system1/bashCompactionPolicy.ts"],"names":[],"mappings":"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","sourcesContent":["import { homedir } from \"os\";\n\nimport assert from \"@/common/utils/assert\";\nimport { BASH_HARD_MAX_LINES, BASH_MAX_TOTAL_BYTES } from \"@/common/constants/toolLimits\";\nimport { SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS } from \"@/common/types/tasks\";\n\nexport type BashOutputIntent = \"exploration\" | \"logs\" | \"unknown\";\n\nexport function isBashOutputAlreadyTargeted(script: string): boolean {\n  assert(typeof script === \"string\", \"script must be a string\");\n\n  const trimmed = script.trim();\n  if (trimmed.length === 0) {\n    return false;\n  }\n\n  // If the script already limits output to a slice (head/tail/line ranges), further denoising is\n  // likely to drop exactly what the caller asked to see.\n  //\n  // NOTE: Avoid false positives like `git rev-parse HEAD`.\n  const statementSegments = trimmed\n    .split(/(?:\\r?\\n|&&|;)+/)\n    .map((part) => part.trim())\n    .filter(Boolean);\n\n  const slicingCommands = new Set([\"head\", \"tail\"]);\n  for (const statement of statementSegments) {\n    const pipeSegments = statement\n      .split(\"|\")\n      .map((part) => part.trim())\n      .filter(Boolean);\n\n    for (const pipeSegment of pipeSegments) {\n      const tokens = pipeSegment.split(/\\s+/).filter(Boolean);\n      if (tokens.length === 0) {\n        continue;\n      }\n\n      const cmd0 = (tokens[0] ?? \"\").toLowerCase();\n      const cmd1 = (tokens[1] ?? \"\").toLowerCase();\n\n      if (slicingCommands.has(cmd0)) {\n        return true;\n      }\n\n      // Common wrapper: `sudo head ...`.\n      if ((cmd0 === \"sudo\" || cmd0 === \"command\") && slicingCommands.has(cmd1)) {\n        return true;\n      }\n    }\n  }\n\n  if (/\\bsed\\b[^\\n]*\\s-n\\s+['\"]?\\d+\\s*,\\s*\\d+\\s*p['\"]?/i.test(trimmed)) {\n    return true;\n  }\n\n  if (/\\bawk\\b[^\\n]*\\bNR\\s*(==|!=|>=|<=|>|<)\\s*\\d+/i.test(trimmed)) {\n    return true;\n  }\n\n  return false;\n}\n\nfunction normalizeDisplayName(displayName: string | undefined): string | undefined {\n  if (typeof displayName !== \"string\") {\n    return undefined;\n  }\n\n  const trimmed = displayName.trim();\n  return trimmed.length > 0 ? trimmed : undefined;\n}\n\nfunction getFirstNonTrivialCommand(script: string): { cmd: string; args: string[] } | undefined {\n  const segments = script\n    .split(/(?:\\r?\\n|&&|;)+/)\n    .map((part) => part.trim())\n    .filter(Boolean);\n\n  const ignoredCommands = new Set([\"cd\", \"pushd\", \"popd\", \"export\", \"set\"]);\n\n  for (const segment of segments) {\n    const tokens = segment.split(/\\s+/).filter(Boolean);\n    if (tokens.length === 0) {\n      continue;\n    }\n\n    const rawCmd = tokens[0] ?? \"\";\n    const cmd = rawCmd.replace(/^\\\\/, \"\");\n\n    if (!cmd || ignoredCommands.has(cmd)) {\n      continue;\n    }\n\n    return { cmd, args: tokens.slice(1) };\n  }\n\n  return undefined;\n}\n\nexport function classifyBashIntent(params: {\n  script: string;\n  displayName?: string;\n}): BashOutputIntent {\n  assert(params, \"params is required\");\n  assert(typeof params.script === \"string\", \"script must be a string\");\n\n  const displayName = normalizeDisplayName(params.displayName);\n  if (displayName) {\n    const normalized = displayName.toLowerCase();\n    if (/\\b(list|explore|search|scan)\\b/.test(normalized)) {\n      return \"exploration\";\n    }\n  }\n\n  const first = getFirstNonTrivialCommand(params.script);\n  if (first) {\n    const cmd = first.cmd.toLowerCase();\n    const arg0 = first.args[0]?.toLowerCase();\n\n    const explorationCommands = new Set([\"ls\", \"find\", \"fd\", \"tree\", \"rg\", \"grep\"]);\n    if (explorationCommands.has(cmd)) {\n      return \"exploration\";\n    }\n\n    if (cmd === \"git\" && (arg0 === \"ls-files\" || arg0 === \"status\")) {\n      return \"exploration\";\n    }\n\n    const logCommands = new Set([\"make\", \"bun\", \"npm\", \"yarn\", \"pnpm\"]);\n    if (logCommands.has(cmd)) {\n      return \"logs\";\n    }\n  }\n\n  return \"unknown\";\n}\n\nfunction isGitConflictMarkerSearch(script: string): boolean {\n  assert(typeof script === \"string\", \"script must be a string\");\n\n  const trimmed = script.trim();\n  if (trimmed.length === 0) {\n    return false;\n  }\n\n  const literalNeedles = [\"<<<<<<<\", \">>>>>>>\", \"=======\", \"|||||||\"];\n  for (const needle of literalNeedles) {\n    if (trimmed.includes(needle)) {\n      return true;\n    }\n  }\n\n  // Common regex quantifier forms (used in `rg`/`grep` patterns).\n  const quantifierNeedles = [\"<{7}\", \">{7}\", \"={7}\", \"|{7}\"];\n  for (const needle of quantifierNeedles) {\n    if (trimmed.includes(needle)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nfunction scriptMentionsPlanFile(script: string, planFilePath: string | undefined): boolean {\n  assert(typeof script === \"string\", \"script must be a string\");\n\n  if (typeof planFilePath !== \"string\") {\n    return false;\n  }\n\n  const trimmedPlanFilePath = planFilePath.trim();\n  if (trimmedPlanFilePath.length === 0) {\n    return false;\n  }\n\n  const needles = new Set<string>();\n\n  const addNeedle = (needle: string): void => {\n    const trimmed = needle.trim();\n    if (trimmed.length === 0) {\n      return;\n    }\n\n    needles.add(trimmed);\n  };\n\n  const addNeedleVariants = (needle: string): void => {\n    addNeedle(needle);\n    addNeedle(needle.replaceAll(\"\\\\\\\\\", \"/\"));\n  };\n\n  addNeedleVariants(trimmedPlanFilePath);\n\n  const home = homedir();\n  const homePosix = home.replaceAll(\"\\\\\\\\\", \"/\");\n\n  if (trimmedPlanFilePath === \"~\") {\n    addNeedleVariants(home);\n    addNeedleVariants(homePosix);\n  } else if (trimmedPlanFilePath.startsWith(\"~/\") || trimmedPlanFilePath.startsWith(\"~\\\\\\\\\")) {\n    const suffix = trimmedPlanFilePath.slice(1);\n    addNeedleVariants(`${home}${suffix}`);\n    addNeedleVariants(`${homePosix}${suffix.replaceAll(\"\\\\\\\\\", \"/\")}`);\n  }\n\n  // Also match the `~` form when the configured plan path is already expanded.\n  for (const candidateHome of [home, homePosix]) {\n    if (!trimmedPlanFilePath.startsWith(candidateHome)) {\n      continue;\n    }\n\n    const suffix = trimmedPlanFilePath.slice(candidateHome.length);\n    if (suffix.length > 0 && !suffix.startsWith(\"/\") && !suffix.startsWith(\"\\\\\\\\\")) {\n      continue;\n    }\n\n    addNeedleVariants(`~${suffix}`);\n  }\n\n  for (const needle of needles) {\n    if (script.includes(needle)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nexport type BashOutputCompactionSkipReason =\n  | \"below_threshold\"\n  | \"already_targeted_script\"\n  | \"plan_file_in_script\"\n  | \"exploration_output_small\"\n  | \"conflict_marker_search_within_limits\";\n\nexport interface BashOutputCompactionDecision {\n  shouldCompact: boolean;\n  skipReason?: BashOutputCompactionSkipReason;\n\n  triggeredByLines: boolean;\n  triggeredByBytes: boolean;\n\n  alreadyTargeted: boolean;\n  intent: BashOutputIntent;\n\n  effectiveMaxKeptLines: number;\n}\n\nconst EXPLORATION_SKIP_MAX_LINES = 120;\nconst EXPLORATION_SKIP_MAX_BYTES = 12 * 1024;\nconst EXPLORATION_BOOST_MAX_KEPT_LINES = 120;\n\nexport function decideBashOutputCompaction(params: {\n  toolName: string;\n  script: string;\n  displayName?: string;\n  planFilePath?: string;\n\n  totalLines: number;\n  totalBytes: number;\n\n  minLines: number;\n  minTotalBytes: number;\n  maxKeptLines: number;\n}): BashOutputCompactionDecision {\n  assert(params, \"params is required\");\n  assert(\n    typeof params.toolName === \"string\" && params.toolName.length > 0,\n    \"toolName must be a non-empty string\"\n  );\n  assert(typeof params.script === \"string\", \"script must be a string\");\n  assert(\n    typeof params.planFilePath === \"string\" || typeof params.planFilePath === \"undefined\",\n    \"planFilePath must be a string if provided\"\n  );\n  assert(\n    Number.isInteger(params.totalLines) && params.totalLines >= 0,\n    \"totalLines must be a non-negative integer\"\n  );\n  assert(\n    Number.isInteger(params.totalBytes) && params.totalBytes >= 0,\n    \"totalBytes must be a non-negative integer\"\n  );\n  assert(Number.isInteger(params.minLines) && params.minLines >= 0, \"minLines must be >= 0\");\n  assert(\n    Number.isInteger(params.minTotalBytes) && params.minTotalBytes >= 0,\n    \"minTotalBytes must be >= 0\"\n  );\n  assert(\n    Number.isInteger(params.maxKeptLines) && params.maxKeptLines > 0,\n    \"maxKeptLines must be a positive integer\"\n  );\n\n  const triggeredByLines = params.totalLines > params.minLines;\n  const triggeredByBytes = params.totalBytes > params.minTotalBytes;\n\n  let intent: BashOutputIntent = \"unknown\";\n  let alreadyTargeted = false;\n  let effectiveMaxKeptLines = params.maxKeptLines;\n\n  if (!triggeredByLines && !triggeredByBytes) {\n    return {\n      shouldCompact: false,\n      skipReason: \"below_threshold\",\n      triggeredByLines,\n      triggeredByBytes,\n      alreadyTargeted,\n      intent,\n      effectiveMaxKeptLines,\n    };\n  }\n\n  if (params.toolName === \"bash\") {\n    alreadyTargeted = isBashOutputAlreadyTargeted(params.script);\n    intent = classifyBashIntent({ script: params.script, displayName: params.displayName });\n\n    if (scriptMentionsPlanFile(params.script, params.planFilePath)) {\n      // Plan Mode invariant: the plan file is the source of truth. System1 compaction can drop\n      // the middle of the document, forcing extra tool calls and/or leading to incorrect plans.\n      return {\n        shouldCompact: false,\n        skipReason: \"plan_file_in_script\",\n        triggeredByLines,\n        triggeredByBytes,\n        alreadyTargeted,\n        intent,\n        effectiveMaxKeptLines,\n      };\n    }\n\n    if (alreadyTargeted) {\n      return {\n        shouldCompact: false,\n        skipReason: \"already_targeted_script\",\n        triggeredByLines,\n        triggeredByBytes,\n        alreadyTargeted,\n        intent,\n        effectiveMaxKeptLines,\n      };\n    }\n\n    const defaultMinLines =\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default;\n    const defaultMinTotalBytes =\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default;\n    const defaultMaxKeptLines =\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default;\n\n    // If a user has customized compaction settings, respect those limits even for exploration output.\n    const isDefaultCompactionConfig =\n      params.minLines === defaultMinLines &&\n      params.minTotalBytes === defaultMinTotalBytes &&\n      params.maxKeptLines === defaultMaxKeptLines;\n\n    const isConflictMarkerSearch = isGitConflictMarkerSearch(params.script);\n\n    if (\n      isDefaultCompactionConfig &&\n      isConflictMarkerSearch &&\n      params.totalLines <= BASH_HARD_MAX_LINES &&\n      params.totalBytes <= BASH_MAX_TOTAL_BYTES\n    ) {\n      return {\n        shouldCompact: false,\n        skipReason: \"conflict_marker_search_within_limits\",\n        triggeredByLines,\n        triggeredByBytes,\n        alreadyTargeted,\n        intent,\n        effectiveMaxKeptLines,\n      };\n    }\n\n    if (\n      intent === \"exploration\" &&\n      params.totalLines <= EXPLORATION_SKIP_MAX_LINES &&\n      params.totalBytes <= EXPLORATION_SKIP_MAX_BYTES\n    ) {\n      // Skip the System1 call only when compaction settings are at their defaults. This avoids\n      // bypassing explicit user limits (e.g. when they've lowered max-kept-lines or forced compaction).\n      if (isDefaultCompactionConfig) {\n        return {\n          shouldCompact: false,\n          skipReason: \"exploration_output_small\",\n          triggeredByLines,\n          triggeredByBytes,\n          alreadyTargeted,\n          intent,\n          effectiveMaxKeptLines,\n        };\n      }\n    }\n\n    // Guardrail: only override when the caller still uses the default budget and thresholds.\n    if (isDefaultCompactionConfig) {\n      if (isConflictMarkerSearch) {\n        effectiveMaxKeptLines = BASH_HARD_MAX_LINES;\n      } else if (intent === \"exploration\") {\n        effectiveMaxKeptLines = Math.min(\n          BASH_HARD_MAX_LINES,\n          Math.max(params.maxKeptLines, EXPLORATION_BOOST_MAX_KEPT_LINES)\n        );\n      }\n    }\n  }\n\n  assert(\n    Number.isInteger(effectiveMaxKeptLines) && effectiveMaxKeptLines > 0,\n    \"effectiveMaxKeptLines must be a positive integer\"\n  );\n\n  return {\n    shouldCompact: true,\n    triggeredByLines,\n    triggeredByBytes,\n    alreadyTargeted,\n    intent,\n    effectiveMaxKeptLines,\n  };\n}\n"]}