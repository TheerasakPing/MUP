{"version":3,"file":"iconThemeService.js","sourceRoot":"","sources":["../../../src/node/services/iconThemeService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport JSZip from \"jszip\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { Config } from \"@/node/config\";\r\nimport {\r\n    IconThemeDocument,\r\n    InstalledIconTheme,\r\n    DEFAULT_MUP_THEME_ID,\r\n} from \"@/common/types/iconTheme\";\r\nimport { getMuxHome } from \"@/common/constants/paths\";\r\n\r\n/**\r\n * Service to manage icon themes in MUP.\r\n * Handles loading, activating, and listing icon themes.\r\n */\r\nexport class IconThemeService {\r\n    private config: Config;\r\n    private iconThemesDir: string;\r\n\r\n    constructor(config: Config) {\r\n        this.config = config;\r\n        this.iconThemesDir = path.join(getMuxHome(), \"icon-themes\");\r\n\r\n        // Ensure icon themes directory exists\r\n        if (!fs.existsSync(this.iconThemesDir)) {\r\n            try {\r\n                fs.mkdirSync(this.iconThemesDir, { recursive: true });\r\n            } catch (err) {\r\n                log.error(\"Failed to create icon themes directory:\", err);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the ID of the currently active icon theme.\r\n     */\r\n    public getActiveThemeId(): string {\r\n        const config = this.config.loadConfigOrDefault();\r\n        return config.iconThemeConfig?.activeThemeId ?? DEFAULT_MUP_THEME_ID;\r\n    }\r\n\r\n    /**\r\n     * Set the active icon theme.\r\n     */\r\n    public async setActiveTheme(themeId: string): Promise<void> {\r\n        await this.config.editConfig((config) => {\r\n            const currentConfig = config.iconThemeConfig ?? {\r\n                activeThemeId: DEFAULT_MUP_THEME_ID,\r\n                installedThemes: [],\r\n            };\r\n\r\n            return {\r\n                ...config,\r\n                iconThemeConfig: {\r\n                    ...currentConfig,\r\n                    activeThemeId: themeId,\r\n                },\r\n            };\r\n        });\r\n\r\n        log.info(`Active icon theme set to: ${themeId}`);\r\n    }\r\n\r\n    /**\r\n     * Get the list of all installed icon themes.\r\n     */\r\n    public getInstalledThemes(): InstalledIconTheme[] {\r\n        const config = this.config.loadConfigOrDefault();\r\n        const installed = config.iconThemeConfig?.installedThemes ?? [];\r\n\r\n        // Always include the built-in MUP default theme if not present\r\n        const hasDefault = installed.some(t => t.id === DEFAULT_MUP_THEME_ID);\r\n        if (!hasDefault) {\r\n            return [this.getBuiltinThemeDefinition(), ...installed];\r\n        }\r\n\r\n        return installed;\r\n    }\r\n\r\n    /**\r\n     * Get the built-in MUP default theme definition.\r\n     * This theme uses the legacy hardcoded icons.\r\n     */\r\n    private getBuiltinThemeDefinition(): InstalledIconTheme {\r\n        // For now, the built-in theme doesn't have a real JSON file or folder on disk\r\n        // In Phase 5, we will bundle it properly.\r\n        return {\r\n            id: DEFAULT_MUP_THEME_ID,\r\n            label: \"MUP Default\",\r\n            description: \"Default MUP file icons\",\r\n            isBuiltin: true,\r\n            themeDir: \"\", // Built-in, handled specially on frontend\r\n            themeJsonPath: \"\",\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get the IconThemeDocument for the currently active theme.\r\n     */\r\n    public async getActiveThemeDocument(): Promise<IconThemeDocument | null> {\r\n        const activeId = this.getActiveThemeId();\r\n        return this.loadThemeDocument(activeId);\r\n    }\r\n\r\n    /**\r\n     * Load the IconThemeDocument (JSON) for a given theme ID.\r\n     * Returns null if theme not found or invalid.\r\n     */\r\n    public async loadThemeDocument(themeId: string): Promise<IconThemeDocument | null> {\r\n        if (themeId === DEFAULT_MUP_THEME_ID) {\r\n            // Built-in theme is handled by frontend fallback logic for now (Phase 3/5)\r\n            // or we could return a minimal JSON here.\r\n            return null;\r\n        }\r\n\r\n        const themes = this.getInstalledThemes();\r\n        const theme = themes.find(t => t.id === themeId);\r\n\r\n        if (!theme) {\r\n            log.warn(`Icon theme not found: ${themeId}`);\r\n            return null;\r\n        }\r\n\r\n        try {\r\n            const jsonPath = path.join(theme.themeDir, theme.themeJsonPath);\r\n            if (!fs.existsSync(jsonPath)) {\r\n                log.error(`Icon theme JSON file missing: ${jsonPath}`);\r\n                return null;\r\n            }\r\n\r\n            const content = await fs.promises.readFile(jsonPath, \"utf-8\");\r\n            return JSON.parse(content) as IconThemeDocument;\r\n        } catch (err) {\r\n            log.error(`Failed to load icon theme ${themeId}:`, err);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Delete an installed theme by ID.\r\n     * Cannot delete built-in themes.\r\n     */\r\n    public async deleteTheme(themeId: string): Promise<boolean> {\r\n        if (themeId === DEFAULT_MUP_THEME_ID) {\r\n            return false; // Cannot delete built-in theme\r\n        }\r\n\r\n        const config = this.config.loadConfigOrDefault();\r\n        const installed = config.iconThemeConfig?.installedThemes ?? [];\r\n        const themeIndex = installed.findIndex(t => t.id === themeId);\r\n\r\n        if (themeIndex === -1) {\r\n            return false; // Theme not found\r\n        }\r\n\r\n        const theme = installed[themeIndex];\r\n        if (theme.isBuiltin) {\r\n            return false; // Should satisfy check above, but safe guard\r\n        }\r\n\r\n        // 1. Remove from config\r\n        await this.config.editConfig((cfg) => {\r\n            const currentConfig = cfg.iconThemeConfig;\r\n            if (!currentConfig) return cfg;\r\n\r\n            const newInstalled = [...currentConfig.installedThemes];\r\n            newInstalled.splice(themeIndex, 1);\r\n\r\n            // If deleted theme was active, revert to default\r\n            let newActiveId = currentConfig.activeThemeId;\r\n            if (newActiveId === themeId) {\r\n                newActiveId = DEFAULT_MUP_THEME_ID;\r\n            }\r\n\r\n            return {\r\n                ...cfg,\r\n                iconThemeConfig: {\r\n                    ...currentConfig,\r\n                    activeThemeId: newActiveId,\r\n                    installedThemes: newInstalled,\r\n                },\r\n            };\r\n        });\r\n\r\n        // 2. Delete files from disk\r\n        try {\r\n            if (theme.themeDir && theme.themeDir.startsWith(this.iconThemesDir)) {\r\n                await fs.promises.rm(theme.themeDir, { recursive: true, force: true });\r\n                log.info(`Deleted icon theme files: ${theme.themeDir}`);\r\n            }\r\n        } catch (err) {\r\n            log.error(`Failed to delete theme directory: ${theme.themeDir}`, err);\r\n            // We still return true because it's removed from config\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Import an icon theme from a .vsix file (base64-encoded).\r\n     * Extracts the ZIP, parses package.json for contributes.iconThemes,\r\n     * stores the theme files to disk, and registers in config.\r\n     */\r\n    public async importVsix(vsixBase64: string): Promise<{ importedThemeIds: string[]; errors: string[] }> {\r\n        const importedThemeIds: string[] = [];\r\n        const errors: string[] = [];\r\n\r\n        try {\r\n            const buffer = Buffer.from(vsixBase64, \"base64\");\r\n            const zip = await JSZip.loadAsync(buffer);\r\n\r\n            // Find package.json inside the extension\r\n            const packageJsonFile =\r\n                zip.file(\"extension/package.json\") ??\r\n                zip.file(\"package.json\");\r\n\r\n            if (!packageJsonFile) {\r\n                return { importedThemeIds, errors: [\"No package.json found in .vsix\"] };\r\n            }\r\n\r\n            const packageJsonStr = await packageJsonFile.async(\"string\");\r\n            const packageJson = JSON.parse(packageJsonStr) as {\r\n                name?: string;\r\n                publisher?: string;\r\n                version?: string;\r\n                displayName?: string;\r\n                contributes?: {\r\n                    iconThemes?: Array<{\r\n                        id: string;\r\n                        label: string;\r\n                        path: string;\r\n                    }>;\r\n                };\r\n            };\r\n\r\n            const iconThemes = packageJson.contributes?.iconThemes;\r\n            if (!iconThemes || iconThemes.length === 0) {\r\n                return { importedThemeIds, errors: [\"No icon themes found in extension contributes\"] };\r\n            }\r\n\r\n            // Determine the prefix for files inside the ZIP\r\n            // .vsix files typically have files under \"extension/\"\r\n            const hasExtensionPrefix = zip.file(\"extension/package.json\") !== null;\r\n            const zipPrefix = hasExtensionPrefix ? \"extension/\" : \"\";\r\n\r\n            for (const themeContrib of iconThemes) {\r\n                try {\r\n                    const themeId = `${packageJson.publisher ?? \"unknown\"}.${packageJson.name ?? \"unknown\"}-${themeContrib.id}`;\r\n                    const themeDir = path.join(this.iconThemesDir, themeId);\r\n\r\n                    // Clean existing directory if re-importing\r\n                    if (fs.existsSync(themeDir)) {\r\n                        await fs.promises.rm(themeDir, { recursive: true, force: true });\r\n                    }\r\n                    await fs.promises.mkdir(themeDir, { recursive: true });\r\n\r\n                    // Extract all files from extension/ to the theme directory\r\n                    const zipEntries = Object.keys(zip.files);\r\n                    for (const entryName of zipEntries) {\r\n                        const entry = zip.files[entryName];\r\n                        if (entry.dir) continue;\r\n                        if (!entryName.startsWith(zipPrefix)) continue;\r\n\r\n                        // Strip the prefix to get relative path\r\n                        const relativePath = entryName.slice(zipPrefix.length);\r\n                        if (!relativePath) continue;\r\n\r\n                        const targetPath = path.join(themeDir, relativePath);\r\n                        const targetDir = path.dirname(targetPath);\r\n\r\n                        // Security: ensure target stays within themeDir\r\n                        const resolvedTarget = path.resolve(targetPath);\r\n                        const resolvedThemeDir = path.resolve(themeDir);\r\n                        if (!resolvedTarget.startsWith(resolvedThemeDir)) {\r\n                            log.warn(`Skipping suspicious path in .vsix: ${entryName}`);\r\n                            continue;\r\n                        }\r\n\r\n                        await fs.promises.mkdir(targetDir, { recursive: true });\r\n                        const content = await entry.async(\"nodebuffer\");\r\n                        await fs.promises.writeFile(targetPath, content);\r\n                    }\r\n\r\n                    // Normalize the theme JSON path (remove leading ./)\r\n                    const themeJsonPath = themeContrib.path.replace(/^\\.[\\/\\\\]/, \"\");\r\n\r\n                    // Verify the theme JSON file was extracted\r\n                    const fullThemeJsonPath = path.join(themeDir, themeJsonPath);\r\n                    if (!fs.existsSync(fullThemeJsonPath)) {\r\n                        errors.push(`Theme JSON not found after extraction: ${themeJsonPath}`);\r\n                        continue;\r\n                    }\r\n\r\n                    // Register the theme in config\r\n                    const newTheme: InstalledIconTheme = {\r\n                        id: themeId,\r\n                        label: themeContrib.label || packageJson.displayName || themeContrib.id,\r\n                        description: `Imported from ${packageJson.publisher ?? \"unknown\"}.${packageJson.name ?? \"unknown\"}`,\r\n                        publisher: packageJson.publisher,\r\n                        version: packageJson.version,\r\n                        themeDir,\r\n                        themeJsonPath,\r\n                        isBuiltin: false,\r\n                    };\r\n\r\n                    await this.config.editConfig((cfg) => {\r\n                        const currentConfig = cfg.iconThemeConfig ?? {\r\n                            activeThemeId: DEFAULT_MUP_THEME_ID,\r\n                            installedThemes: [],\r\n                        };\r\n\r\n                        // Remove existing theme with same ID if re-importing\r\n                        const filteredThemes = currentConfig.installedThemes.filter(\r\n                            (t) => t.id !== themeId\r\n                        );\r\n\r\n                        return {\r\n                            ...cfg,\r\n                            iconThemeConfig: {\r\n                                ...currentConfig,\r\n                                installedThemes: [...filteredThemes, newTheme],\r\n                            },\r\n                        };\r\n                    });\r\n\r\n                    importedThemeIds.push(themeId);\r\n                    log.info(`Imported icon theme: ${themeId} â†’ ${themeDir}`);\r\n                } catch (themeErr) {\r\n                    const msg = themeErr instanceof Error ? themeErr.message : String(themeErr);\r\n                    errors.push(`Failed to import theme ${themeContrib.id}: ${msg}`);\r\n                    log.error(`Failed to import theme ${themeContrib.id}:`, themeErr);\r\n                }\r\n            }\r\n        } catch (err) {\r\n            const msg = err instanceof Error ? err.message : String(err);\r\n            errors.push(`Failed to parse .vsix file: ${msg}`);\r\n            log.error(\"Failed to parse .vsix file:\", err);\r\n        }\r\n\r\n        return { importedThemeIds, errors };\r\n    }\r\n\r\n    /**\r\n     * Get the content of an icon file from a theme directory.\r\n     * Returns base64-encoded data and MIME type.\r\n     */\r\n    public async getIconFile(\r\n        themeId: string,\r\n        iconPath: string\r\n    ): Promise<{ data: string; mimeType: string } | null> {\r\n        const themes = this.getInstalledThemes();\r\n        const theme = themes.find((t) => t.id === themeId);\r\n        if (!theme || !theme.themeDir) return null;\r\n\r\n        // Resolve and validate path (prevent traversal)\r\n        const fullPath = path.resolve(theme.themeDir, iconPath);\r\n        const resolvedThemeDir = path.resolve(theme.themeDir);\r\n        if (!fullPath.startsWith(resolvedThemeDir)) {\r\n            log.warn(`Path traversal attempt blocked: ${iconPath}`);\r\n            return null;\r\n        }\r\n\r\n        if (!fs.existsSync(fullPath)) return null;\r\n\r\n        const content = await fs.promises.readFile(fullPath);\r\n        const ext = path.extname(fullPath).toLowerCase();\r\n        const mimeType = this.getMimeType(ext);\r\n\r\n        return {\r\n            data: content.toString(\"base64\"),\r\n            mimeType,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get the base directory path for icon themes (for static file serving).\r\n     */\r\n    public getIconThemesDir(): string {\r\n        return this.iconThemesDir;\r\n    }\r\n\r\n    private getMimeType(ext: string): string {\r\n        const mimeMap: Record<string, string> = {\r\n            \".svg\": \"image/svg+xml\",\r\n            \".png\": \"image/png\",\r\n            \".jpg\": \"image/jpeg\",\r\n            \".jpeg\": \"image/jpeg\",\r\n            \".gif\": \"image/gif\",\r\n            \".webp\": \"image/webp\",\r\n            \".ico\": \"image/x-icon\",\r\n            \".woff\": \"font/woff\",\r\n            \".woff2\": \"font/woff2\",\r\n            \".ttf\": \"font/ttf\",\r\n        };\r\n        return mimeMap[ext] ?? \"application/octet-stream\";\r\n    }\r\n}\r\n"]}