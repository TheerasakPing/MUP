{"version":3,"file":"providerModelFactory.js","sourceRoot":"","sources":["../../../src/node/services/providerModelFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import type { XaiProviderOptions } from \"@ai-sdk/xai\";\nimport { fromNodeProviderChain } from \"@aws-sdk/credential-providers\";\nimport type { LanguageModel } from \"ai\";\nimport type { ThinkingLevel } from \"@/common/types/thinking\";\nimport { Ok, Err } from \"@/common/types/result\";\nimport type { Result } from \"@/common/types/result\";\nimport type { SendMessageError } from \"@/common/types/errors\";\nimport {\n  PROVIDER_REGISTRY,\n  PROVIDER_DEFINITIONS,\n  MUX_GATEWAY_SUPPORTED_PROVIDERS,\n  type ProviderName,\n} from \"@/common/constants/providers\";\nimport {\n  CODEX_ENDPOINT,\n  isCodexOauthAllowedModelId,\n  isCodexOauthRequiredModelId,\n} from \"@/common/constants/codexOAuth\";\nimport { parseCodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\nimport type { Config, ProviderConfig } from \"@/node/config\";\nimport type { MuxProviderOptions } from \"@/common/types/providerOptions\";\nimport type { PolicyService } from \"@/node/services/policyService\";\nimport type { ProviderService } from \"@/node/services/providerService\";\nimport type { CodexOauthService } from \"@/node/services/codexOauthService\";\nimport { normalizeGatewayModel, supports1MContext } from \"@/common/utils/ai/models\";\nimport { MUX_APP_ATTRIBUTION_TITLE, MUX_APP_ATTRIBUTION_URL } from \"@/constants/appAttribution\";\nimport { resolveProviderCredentials } from \"@/node/utils/providerRequirements\";\nimport {\n  normalizeGatewayStreamUsage,\n  normalizeGatewayGenerateResult,\n} from \"@/node/utils/gatewayStreamNormalization\";\nimport { EnvHttpProxyAgent, type Dispatcher } from \"undici\";\n\n// ---------------------------------------------------------------------------\n// Undici agent with unlimited timeouts for AI streaming requests.\n// Safe because users control cancellation via AbortSignal from the UI.\n// Uses EnvHttpProxyAgent to automatically respect HTTP_PROXY, HTTPS_PROXY,\n// and NO_PROXY environment variables for debugging/corporate network support.\n// ---------------------------------------------------------------------------\n\nconst unlimitedTimeoutAgent = new EnvHttpProxyAgent({\n  bodyTimeout: 0, // No timeout - prevents BodyTimeoutError on long reasoning pauses\n  headersTimeout: 0, // No timeout for headers\n});\n\n// Extend RequestInit with undici-specific dispatcher property (Node.js only)\ntype RequestInitWithDispatcher = RequestInit & { dispatcher?: Dispatcher };\n\n/**\n * Default fetch function with unlimited timeouts for AI streaming.\n * Uses undici Agent to remove artificial timeout limits while still\n * respecting user cancellation via AbortSignal.\n *\n * Note: If users provide custom fetch in providers.jsonc, they are\n * responsible for configuring timeouts appropriately. Custom fetch\n * implementations using undici should set bodyTimeout: 0 and\n * headersTimeout: 0 to prevent BodyTimeoutError on long-running\n * reasoning models.\n */\nconst defaultFetchWithUnlimitedTimeout = (async (\n  input: RequestInfo | URL,\n  init?: RequestInit\n): Promise<Response> => {\n  // dispatcher is a Node.js undici-specific property for custom HTTP agents\n  const requestInit: RequestInitWithDispatcher = {\n    ...(init ?? {}),\n    dispatcher: unlimitedTimeoutAgent,\n  };\n  return fetch(input, requestInit);\n}) as typeof fetch;\n\ntype FetchWithBunExtensions = typeof fetch & {\n  preconnect?: typeof fetch extends { preconnect: infer P } ? P : unknown;\n  certificate?: typeof fetch extends { certificate: infer C } ? C : unknown;\n};\n\nconst globalFetchWithExtras = fetch as FetchWithBunExtensions;\nconst defaultFetchWithExtras = defaultFetchWithUnlimitedTimeout as FetchWithBunExtensions;\n\nif (typeof globalFetchWithExtras.preconnect === \"function\") {\n  defaultFetchWithExtras.preconnect = globalFetchWithExtras.preconnect.bind(globalFetchWithExtras);\n}\n\nif (typeof globalFetchWithExtras.certificate === \"function\") {\n  defaultFetchWithExtras.certificate =\n    globalFetchWithExtras.certificate.bind(globalFetchWithExtras);\n}\n\n// ---------------------------------------------------------------------------\n// Fetch wrappers\n// ---------------------------------------------------------------------------\n\n/**\n * Wrap fetch to inject Anthropic cache_control directly into the request body.\n * The AI SDK's providerOptions.anthropic.cacheControl doesn't get translated\n * to raw cache_control for tools or message content parts, so we inject it\n * at the HTTP level.\n *\n * Injects cache_control on:\n * 1. Last tool (caches all tool definitions)\n * 2. Last message's last content part (caches entire conversation)\n */\nfunction wrapFetchWithAnthropicCacheControl(baseFetch: typeof fetch): typeof fetch {\n  const cachingFetch = async (\n    input: Parameters<typeof fetch>[0],\n    init?: Parameters<typeof fetch>[1]\n  ): Promise<Response> => {\n    // Only modify POST requests with JSON body\n    if (init?.method?.toUpperCase() !== \"POST\" || typeof init?.body !== \"string\") {\n      return baseFetch(input, init);\n    }\n\n    try {\n      const json = JSON.parse(init.body) as Record<string, unknown>;\n\n      // Inject cache_control on the last tool if tools array exists\n      if (Array.isArray(json.tools) && json.tools.length > 0) {\n        const lastTool = json.tools[json.tools.length - 1] as Record<string, unknown>;\n        lastTool.cache_control ??= { type: \"ephemeral\" };\n      }\n\n      // Inject cache_control on last message's last content part\n      // This caches the entire conversation\n      // Handle both formats:\n      // - Direct Anthropic provider: json.messages (Anthropic API format)\n      // - Gateway provider: json.prompt (AI SDK internal format)\n      const messages = Array.isArray(json.messages)\n        ? json.messages\n        : Array.isArray(json.prompt)\n          ? json.prompt\n          : null;\n\n      if (messages && messages.length >= 1) {\n        const lastMsg = messages[messages.length - 1] as Record<string, unknown>;\n\n        // For gateway: add providerOptions.anthropic.cacheControl at message level\n        // (gateway validates schema strictly, doesn't allow raw cache_control on messages)\n        if (Array.isArray(json.prompt)) {\n          const providerOpts = (lastMsg.providerOptions ?? {}) as Record<string, unknown>;\n          const anthropicOpts = (providerOpts.anthropic ?? {}) as Record<string, unknown>;\n          anthropicOpts.cacheControl ??= { type: \"ephemeral\" };\n          providerOpts.anthropic = anthropicOpts;\n          lastMsg.providerOptions = providerOpts;\n        }\n\n        // For direct Anthropic: add cache_control to last content part\n        const content = lastMsg.content;\n        if (Array.isArray(content) && content.length > 0) {\n          const lastPart = content[content.length - 1] as Record<string, unknown>;\n          lastPart.cache_control ??= { type: \"ephemeral\" };\n        }\n      }\n\n      // Update body with modified JSON\n      const newBody = JSON.stringify(json);\n      const headers = new Headers(init?.headers);\n      headers.delete(\"content-length\"); // Body size changed\n      return baseFetch(input, { ...init, headers, body: newBody });\n    } catch {\n      // If parsing fails, pass through unchanged\n      return baseFetch(input, init);\n    }\n  };\n\n  return Object.assign(cachingFetch, baseFetch) as typeof fetch;\n}\n\n/**\n * Wrap fetch so any mux-gateway 401 response clears local credentials (best-effort).\n *\n * This ensures the UI immediately reflects that the user has been logged out\n * when the gateway session expires.\n */\nfunction wrapFetchWithMuxGatewayAutoLogout(\n  baseFetch: typeof fetch,\n  providerService: ProviderService\n): typeof fetch {\n  const wrappedFetch = async (\n    input: Parameters<typeof fetch>[0],\n    init?: Parameters<typeof fetch>[1]\n  ): Promise<Response> => {\n    const response = await baseFetch(input, init);\n\n    if (response.status === 401) {\n      try {\n        providerService.setConfig(\"mux-gateway\", [\"couponCode\"], \"\");\n        providerService.setConfig(\"mux-gateway\", [\"voucher\"], \"\");\n      } catch {\n        // Ignore failures clearing local credentials\n      }\n    }\n\n    return response;\n  };\n\n  return Object.assign(wrappedFetch, baseFetch) as typeof fetch;\n}\n\n/**\n * Get fetch function for provider - use custom if provided, otherwise unlimited timeout default\n */\nfunction getProviderFetch(providerConfig: ProviderConfig): typeof fetch {\n  return typeof providerConfig.fetch === \"function\"\n    ? (providerConfig.fetch as typeof fetch)\n    : defaultFetchWithUnlimitedTimeout;\n}\n\n// ---------------------------------------------------------------------------\n// Exported helpers (re-exported from aiService.ts for backward compatibility)\n// ---------------------------------------------------------------------------\n\n/**\n * Normalize Anthropic base URL to ensure it ends with /v1 suffix.\n *\n * The Anthropic SDK expects baseURL to include /v1 (default: https://api.anthropic.com/v1).\n * Many users configure base URLs without the /v1 suffix, which causes API calls to fail.\n * This function automatically appends /v1 if missing.\n *\n * @param baseURL - The base URL to normalize (may or may not have /v1)\n * @returns The base URL with /v1 suffix\n */\nexport function normalizeAnthropicBaseURL(baseURL: string): string {\n  const trimmed = baseURL.replace(/\\/+$/, \"\"); // Remove trailing slashes\n  if (trimmed.endsWith(\"/v1\")) {\n    return trimmed;\n  }\n  return `${trimmed}/v1`;\n}\n\n/** Header value for Anthropic 1M context beta */\nexport const ANTHROPIC_1M_CONTEXT_HEADER = \"context-1m-2025-08-07\";\n\n/**\n * Build headers for Anthropic provider, optionally including the 1M context beta header.\n * Exported for testing.\n */\nexport function buildAnthropicHeaders(\n  existingHeaders: Record<string, string> | undefined,\n  use1MContext: boolean | undefined\n): Record<string, string> | undefined {\n  if (!use1MContext) {\n    return existingHeaders;\n  }\n  if (existingHeaders) {\n    return { ...existingHeaders, \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER };\n  }\n  return { \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER };\n}\n\n/**\n * Build app attribution headers used by OpenRouter (and other compatible platforms).\n *\n * Attribution docs:\n * - OpenRouter: https://openrouter.ai/docs/app-attribution\n * - Vercel AI Gateway: https://vercel.com/docs/ai-gateway/app-attribution\n *\n * Exported for testing.\n */\nexport function buildAppAttributionHeaders(\n  existingHeaders: Record<string, string> | undefined\n): Record<string, string> {\n  // Clone to avoid mutating caller-provided objects.\n  const headers: Record<string, string> = existingHeaders ? { ...existingHeaders } : {};\n\n  // Header names are case-insensitive. Preserve user-provided values by never overwriting.\n  const existingLowercaseKeys = new Set(Object.keys(headers).map((key) => key.toLowerCase()));\n\n  if (!existingLowercaseKeys.has(\"http-referer\")) {\n    headers[\"HTTP-Referer\"] = MUX_APP_ATTRIBUTION_URL;\n  }\n\n  if (!existingLowercaseKeys.has(\"x-title\")) {\n    headers[\"X-Title\"] = MUX_APP_ATTRIBUTION_TITLE;\n  }\n\n  return headers;\n}\n\n/**\n * Preload AI SDK provider modules to avoid race conditions in concurrent test environments.\n * This function loads @ai-sdk/anthropic, @ai-sdk/openai, and ollama-ai-provider-v2 eagerly\n * so that subsequent dynamic imports in createModel() hit the module cache instead of racing.\n *\n * In production, providers are lazy-loaded on first use to optimize startup time.\n * In tests, we preload them once during setup to ensure reliable concurrent execution.\n */\nexport async function preloadAISDKProviders(): Promise<void> {\n  // Preload providers to ensure they're in the module cache before concurrent tests run\n  await Promise.all(Object.values(PROVIDER_REGISTRY).map((importFn) => importFn()));\n}\n\n/**\n * Parse provider and model ID from model string.\n * Handles model IDs with colons (e.g., \"ollama:gpt-oss:20b\").\n * Only splits on the first colon to support Ollama model naming convention.\n *\n * @param modelString - Model string in format \"provider:model-id\"\n * @returns Tuple of [providerName, modelId]\n * @example\n * parseModelString(\"anthropic:claude-opus-4\") // [\"anthropic\", \"claude-opus-4\"]\n * parseModelString(\"ollama:gpt-oss:20b\") // [\"ollama\", \"gpt-oss:20b\"]\n */\nexport function parseModelString(modelString: string): [string, string] {\n  const colonIndex = modelString.indexOf(\":\");\n  const providerName = colonIndex !== -1 ? modelString.slice(0, colonIndex) : modelString;\n  const modelId = colonIndex !== -1 ? modelString.slice(colonIndex + 1) : \"\";\n  return [providerName, modelId];\n}\n\n// ---------------------------------------------------------------------------\n// Model cost tracking\n// ---------------------------------------------------------------------------\n\nconst MUX_MODEL_COSTS_INCLUDED = Symbol(\"mux:modelCostsIncluded\");\n\ntype LanguageModelWithMuxCostsIncluded = LanguageModel & {\n  [MUX_MODEL_COSTS_INCLUDED]?: true;\n};\n\nfunction markModelCostsIncluded(model: LanguageModel): void {\n  (model as LanguageModelWithMuxCostsIncluded)[MUX_MODEL_COSTS_INCLUDED] = true;\n}\n\nexport function modelCostsIncluded(model: LanguageModel): boolean {\n  return (model as LanguageModelWithMuxCostsIncluded)[MUX_MODEL_COSTS_INCLUDED] === true;\n}\n\n// ---------------------------------------------------------------------------\n// Content extraction\n// ---------------------------------------------------------------------------\n\n/**\n * Extract text from AI SDK message content.\n * Content may be a plain string or a structured array like [{type:\"text\", text:\"...\"}].\n */\nfunction extractTextContent(content: unknown): string {\n  if (typeof content === \"string\") return content.trim();\n  if (Array.isArray(content)) {\n    return (content as unknown[])\n      .filter(\n        (part): part is { type: string; text: string } =>\n          typeof part === \"object\" &&\n          part !== null &&\n          (part as { type?: unknown }).type === \"text\" &&\n          typeof (part as { text?: unknown }).text === \"string\"\n      )\n      .map((part) => part.text)\n      .join(\"\")\n      .trim();\n  }\n  return \"\";\n}\n\n// ---------------------------------------------------------------------------\n// ProviderModelFactory\n// ---------------------------------------------------------------------------\n\n/**\n * Factory responsible for creating AI SDK LanguageModel instances from model strings.\n *\n * Extracted from AIService to isolate provider/model construction logic from the\n * streaming and orchestration concerns that AIService owns.\n */\nexport class ProviderModelFactory {\n  private readonly config: Config;\n  private readonly providerService: ProviderService;\n  private readonly policyService?: PolicyService;\n  codexOauthService?: CodexOauthService;\n\n  constructor(\n    config: Config,\n    providerService: ProviderService,\n    policyService?: PolicyService,\n    codexOauthService?: CodexOauthService\n  ) {\n    this.config = config;\n    this.providerService = providerService;\n    this.policyService = policyService;\n    this.codexOauthService = codexOauthService;\n  }\n\n  /**\n   * Create an AI SDK model from a model string (e.g., \"anthropic:claude-opus-4-1\")\n   *\n   * IMPORTANT: We ONLY use providers.jsonc as the single source of truth for provider configuration.\n   * We DO NOT use environment variables or default constructors that might read them.\n   * This ensures consistent, predictable configuration management.\n   *\n   * Provider configuration from providers.jsonc is passed verbatim to the provider\n   * constructor, ensuring automatic parity with Vercel AI SDK - any configuration options\n   * supported by the provider will work without modification.\n   */\n  async createModel(\n    modelString: string,\n    muxProviderOptions?: MuxProviderOptions\n  ): Promise<Result<LanguageModel, SendMessageError>> {\n    try {\n      // Parse model string (format: \"provider:model-id\")\n      // Parse provider and model ID from model string\n      const [providerName, modelId] = parseModelString(modelString);\n\n      if (!providerName || !modelId) {\n        return Err({\n          type: \"invalid_model_string\",\n          message: `Invalid model string format: \"${modelString}\". Expected \"provider:model-id\"`,\n        });\n      }\n\n      // Check if provider is supported (prevents silent failures when adding to PROVIDER_REGISTRY\n      // but forgetting to implement handler below)\n      if (!(providerName in PROVIDER_REGISTRY)) {\n        return Err({\n          type: \"provider_not_supported\",\n          provider: providerName,\n        });\n      }\n\n      if (this.policyService?.isEnforced()) {\n        const provider = providerName as ProviderName;\n        if (!this.policyService.isProviderAllowed(provider)) {\n          return Err({\n            type: \"policy_denied\",\n            message: `Provider ${providerName} is not allowed by policy`,\n          });\n        }\n\n        if (!this.policyService.isModelAllowed(provider, modelId)) {\n          return Err({\n            type: \"policy_denied\",\n            message: `Model ${providerName}:${modelId} is not allowed by policy`,\n          });\n        }\n      }\n\n      // Load providers configuration - the ONLY source of truth\n      const providersConfig = this.config.loadProvidersConfig();\n      let providerConfig = providersConfig?.[providerName] ?? {};\n\n      // Map baseUrl to baseURL if present (SDK expects baseURL)\n      const { baseUrl, ...configWithoutBaseUrl } = providerConfig;\n      providerConfig = baseUrl\n        ? { ...configWithoutBaseUrl, baseURL: baseUrl }\n        : configWithoutBaseUrl;\n\n      // Policy: force provider base URL (if configured).\n      const forcedBaseUrl = this.policyService?.isEnforced()\n        ? this.policyService.getForcedBaseUrl(providerName as ProviderName)\n        : undefined;\n      if (forcedBaseUrl) {\n        providerConfig = { ...providerConfig, baseURL: forcedBaseUrl };\n      }\n\n      // Inject app attribution headers (used by OpenRouter and other compatible platforms).\n      // We never overwrite user-provided values (case-insensitive header matching).\n      providerConfig = {\n        ...providerConfig,\n        headers: buildAppAttributionHeaders(providerConfig.headers),\n      };\n\n      // Handle Anthropic provider\n      if (providerName === \"anthropic\") {\n        // Resolve credentials from config + env (single source of truth)\n        const creds = resolveProviderCredentials(\"anthropic\", providerConfig);\n        if (!creds.isConfigured) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n\n        // Build config with resolved credentials\n        const configWithApiKey = creds.apiKey\n          ? { ...providerConfig, apiKey: creds.apiKey }\n          : providerConfig;\n\n        // Normalize base URL to ensure /v1 suffix (SDK expects it)\n        const effectiveBaseURL = configWithApiKey.baseURL ?? creds.baseUrl?.trim();\n        const normalizedConfig = effectiveBaseURL\n          ? { ...configWithApiKey, baseURL: normalizeAnthropicBaseURL(effectiveBaseURL) }\n          : configWithApiKey;\n\n        // Add 1M context beta header if requested and model supports it.\n        // Check both per-model list (use1MContextModels) and legacy global flag (use1MContext).\n        const fullModelId = `anthropic:${modelId}`;\n        const is1MEnabled =\n          ((muxProviderOptions?.anthropic?.use1MContextModels?.includes(fullModelId) ?? false) ||\n            muxProviderOptions?.anthropic?.use1MContext === true) &&\n          supports1MContext(fullModelId);\n        const headers = buildAnthropicHeaders(normalizedConfig.headers, is1MEnabled);\n\n        // Lazy-load Anthropic provider to reduce startup time\n        const { createAnthropic } = await PROVIDER_REGISTRY.anthropic();\n        // Wrap fetch to inject cache_control on tools and messages\n        // (SDK doesn't translate providerOptions to cache_control for these)\n        // Use getProviderFetch to preserve any user-configured custom fetch (e.g., proxies)\n        const baseFetch = getProviderFetch(providerConfig);\n        const fetchWithCacheControl = wrapFetchWithAnthropicCacheControl(baseFetch);\n        const provider = createAnthropic({\n          ...normalizedConfig,\n          headers,\n          fetch: fetchWithCacheControl,\n        });\n        return Ok(provider(modelId));\n      }\n\n      // Handle OpenAI provider (using Responses API)\n      if (providerName === \"openai\") {\n        const fullModelId = `${providerName}:${modelId}`;\n\n        const codexOauthAllowed = isCodexOauthAllowedModelId(fullModelId);\n        const codexOauthRequired = isCodexOauthRequiredModelId(fullModelId);\n\n        const storedCodexOauth = parseCodexOauthAuth(\n          (providerConfig as { codexOauth?: unknown }).codexOauth\n        );\n\n        // Resolve credentials from config + env BEFORE OAuth checks so we can\n        // fall back to an API key when OAuth is not connected.\n        const creds = resolveProviderCredentials(\"openai\", providerConfig);\n\n        // When a model requires Codex OAuth but the user hasn't connected it,\n        // fall back to their API key instead of blocking entirely.  If the model\n        // truly only works through OAuth, OpenAI's API will return a clear error.\n        if (codexOauthRequired && !storedCodexOauth && !creds.isConfigured) {\n          return Err({ type: \"oauth_not_connected\", provider: providerName });\n        }\n\n        const codexOauthDefaultAuthRaw = (providerConfig as { codexOauthDefaultAuth?: unknown })\n          .codexOauthDefaultAuth;\n        const codexOauthDefaultAuth = codexOauthDefaultAuthRaw === \"apiKey\" ? \"apiKey\" : \"oauth\";\n\n        // Codex OAuth routing:\n        // - Required models route through ChatGPT OAuth when connected.\n        // - If OAuth is not connected, fall back to API key (if available).\n        // - Allowed models route through OAuth only when:\n        //   - no API key is configured, OR\n        //   - the user prefers OAuth when both are set.\n        const shouldRouteThroughCodexOauth = (() => {\n          if (!codexOauthAllowed || !storedCodexOauth) {\n            return false;\n          }\n\n          if (codexOauthRequired) {\n            return true;\n          }\n\n          if (!creds.isConfigured) {\n            return true;\n          }\n\n          return codexOauthDefaultAuth === \"oauth\";\n        })();\n\n        if (!shouldRouteThroughCodexOauth && !creds.isConfigured) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n\n        // Merge resolved credentials into config\n        const configWithCreds = {\n          ...providerConfig,\n          // When using Codex OAuth, we overwrite auth headers in fetch(), so the OpenAI API key\n          // isn't required. Still pass a placeholder to ensure the SDK never reads env vars.\n          apiKey: shouldRouteThroughCodexOauth ? (creds.apiKey ?? \"codex-oauth\") : creds.apiKey,\n          ...(creds.baseUrl && !providerConfig.baseURL && { baseURL: creds.baseUrl }),\n          ...(creds.organization && { organization: creds.organization }),\n        };\n\n        // Extract serviceTier from config to pass through to buildProviderOptions\n        const configServiceTier = providerConfig.serviceTier as string | undefined;\n        if (configServiceTier && muxProviderOptions) {\n          muxProviderOptions.openai = {\n            ...muxProviderOptions.openai,\n            serviceTier: configServiceTier as \"auto\" | \"default\" | \"flex\" | \"priority\",\n          };\n        }\n\n        const baseFetch = getProviderFetch(providerConfig);\n        const codexOauthService = this.codexOauthService;\n\n        // Wrap fetch to default truncation to \"disabled\" for OpenAI Responses API calls.\n        // This preserves our compaction handling while still allowing explicit truncation (e.g., auto).\n        const fetchWithOpenAITruncation = Object.assign(\n          async (\n            input: Parameters<typeof fetch>[0],\n            init?: Parameters<typeof fetch>[1]\n          ): Promise<Response> => {\n            try {\n              const urlString = (() => {\n                if (typeof input === \"string\") {\n                  return input;\n                }\n                if (input instanceof URL) {\n                  return input.toString();\n                }\n                if (typeof input === \"object\" && input !== null && \"url\" in input) {\n                  const possibleUrl = (input as { url?: unknown }).url;\n                  if (typeof possibleUrl === \"string\") {\n                    return possibleUrl;\n                  }\n                }\n                return \"\";\n              })();\n\n              const method = (init?.method ?? \"GET\").toUpperCase();\n              const isOpenAIResponses = /\\/v1\\/responses(\\?|$)/.test(urlString);\n              const isOpenAIChatCompletions = /\\/chat\\/completions(\\?|$)/.test(urlString);\n\n              let nextInput: Parameters<typeof fetch>[0] = input;\n              let nextInit: Parameters<typeof fetch>[1] | undefined = init;\n\n              const body = init?.body;\n              // Only parse the JSON body when routing through Codex OAuth  it needs\n              // instruction lifting, store=false, and truncation enforcement.  For\n              // non-Codex requests the SDK already sends the correct truncation value\n              // via providerOptions, so we skip the expensive parse + re-stringify.\n              if (\n                shouldRouteThroughCodexOauth &&\n                isOpenAIResponses &&\n                method === \"POST\" &&\n                typeof body === \"string\"\n              ) {\n                try {\n                  const json = JSON.parse(body) as Record<string, unknown>;\n                  const truncation = json.truncation;\n                  if (truncation !== \"auto\" && truncation !== \"disabled\") {\n                    json.truncation = \"disabled\";\n                  }\n\n                  // Codex OAuth (chatgpt.com/backend-api/codex/responses) rejects requests unless\n                  // `instructions` is present and non-empty, and `store` is set to false.\n                  // The AI SDK maps `system` prompts into the `input` array\n                  // (role: system|developer) but does *not* automatically populate\n                  // `instructions`, so we lift all system prompts into `instructions` when\n                  // routing through Codex OAuth.\n\n                  // Codex endpoint requires store=false and only accepts a subset of the\n                  // standard OpenAI Responses API parameters. Use an allowlist to strip\n                  // everything the endpoint doesn't understand (it rejects unknown params\n                  // with 400).\n                  json.store = false;\n\n                  const CODEX_ALLOWED_PARAMS = new Set([\n                    \"model\",\n                    \"input\",\n                    \"instructions\",\n                    \"tools\",\n                    \"tool_choice\",\n                    \"parallel_tool_calls\",\n                    \"stream\",\n                    \"store\",\n                    \"prompt_cache_key\",\n                    \"reasoning\",\n                    \"temperature\",\n                    \"top_p\",\n                    \"include\",\n                    \"text\", // structured output via Output.object  text.format\n                  ]);\n\n                  for (const key of Object.keys(json)) {\n                    if (!CODEX_ALLOWED_PARAMS.has(key)) {\n                      delete json[key];\n                    }\n                  }\n\n                  // Filter out item_reference entries from the input. The AI SDK sends\n                  // these as an optimization when store=true  bare { type: \"item_reference\",\n                  // id: \"rs_...\" } objects that the server expands by looking up stored\n                  // content. With store=false (required for Codex), these lookups fail.\n                  // The full inline content is always present alongside references, so\n                  // removing them doesn't lose conversation context.\n                  if (Array.isArray(json.input)) {\n                    json.input = (json.input as Array<Record<string, unknown>>).filter(\n                      (item) =>\n                        !(item && typeof item === \"object\" && item.type === \"item_reference\")\n                    );\n                  }\n\n                  const existingInstructions =\n                    typeof json.instructions === \"string\" ? json.instructions.trim() : \"\";\n\n                  if (existingInstructions.length === 0) {\n                    const derivedParts: string[] = [];\n                    const keptInput: unknown[] = [];\n\n                    const responseInput = json.input;\n                    if (Array.isArray(responseInput)) {\n                      for (const item of responseInput as unknown[]) {\n                        if (!item || typeof item !== \"object\") {\n                          keptInput.push(item);\n                          continue;\n                        }\n\n                        const role = (item as { role?: unknown }).role;\n                        if (role !== \"system\" && role !== \"developer\") {\n                          keptInput.push(item);\n                          continue;\n                        }\n\n                        // Extract text from string content or structured content arrays\n                        // (AI SDK may produce [{type:\"text\", text:\"...\"}])\n                        const content = (item as { content?: unknown }).content;\n                        const text = extractTextContent(content);\n                        if (text.length > 0) {\n                          derivedParts.push(text);\n                        }\n                        // Drop this system/developer item from input (don't push to keptInput)\n                      }\n\n                      json.input = keptInput;\n                    }\n\n                    const joined = derivedParts.join(\"\\n\\n\").trim();\n                    json.instructions = joined.length > 0 ? joined : \"You are a helpful assistant.\";\n                  }\n\n                  // Clone headers to avoid mutating caller-provided objects\n                  const headers = new Headers(init?.headers);\n                  // Remove content-length if present, since body will change\n                  headers.delete(\"content-length\");\n\n                  const newBody = JSON.stringify(json);\n                  nextInit = { ...init, headers, body: newBody };\n                } catch {\n                  // If body isn't JSON, fall through to normal fetch (but still allow Codex routing).\n                }\n              }\n\n              if (shouldRouteThroughCodexOauth && (isOpenAIResponses || isOpenAIChatCompletions)) {\n                if (!codexOauthService) {\n                  throw new Error(\"Codex OAuth service not initialized\");\n                }\n\n                const authResult = await codexOauthService.getValidAuth();\n                if (!authResult.success) {\n                  throw new Error(authResult.error);\n                }\n\n                const headers = new Headers(nextInit?.headers);\n                headers.set(\"Authorization\", `Bearer ${authResult.data.access}`);\n                if (authResult.data.accountId) {\n                  headers.set(\"ChatGPT-Account-Id\", authResult.data.accountId);\n                }\n\n                nextInput = CODEX_ENDPOINT;\n                nextInit = { ...(nextInit ?? {}), headers };\n              }\n\n              return baseFetch(nextInput, nextInit);\n            } catch (error) {\n              // For normal OpenAI (API key) requests, fall back to the original fetch on unexpected errors.\n              // For Codex OAuth routing, failures should surface (falling back would hit api.openai.com).\n              if (shouldRouteThroughCodexOauth) {\n                throw error;\n              }\n              return baseFetch(input, init);\n            }\n          },\n          \"preconnect\" in baseFetch && typeof baseFetch.preconnect === \"function\"\n            ? {\n                preconnect: baseFetch.preconnect.bind(baseFetch),\n              }\n            : {}\n        );\n\n        // Lazy-load OpenAI provider to reduce startup time\n        const { createOpenAI } = await PROVIDER_REGISTRY.openai();\n        const provider = createOpenAI({\n          ...configWithCreds,\n          // Cast is safe: our fetch implementation is compatible with the SDK's fetch type.\n          // The preconnect method is optional in our implementation but required by the SDK type.\n          fetch: fetchWithOpenAITruncation as typeof fetch,\n        });\n        // Use Responses API for persistence and built-in tools\n        // OpenAI manages reasoning state via previousResponseId - no middleware needed\n        const model = provider.responses(modelId);\n        if (shouldRouteThroughCodexOauth) {\n          markModelCostsIncluded(model);\n\n          // Wrap model to inject store=false into providerOptions so the SDK\n          // sends full inline content instead of item_reference lookups.\n          // The Codex endpoint requires store=false; without this, the SDK\n          // defaults to store=true and sends bare { type: \"item_reference\" }\n          // items that can't be resolved.\n          const injectStoreFlag = (\n            options: Parameters<typeof model.doStream>[0]\n          ): Parameters<typeof model.doStream>[0] => {\n            const openaiOpts =\n              (options.providerOptions?.openai as Record<string, unknown> | undefined) ?? {};\n            return {\n              ...options,\n              providerOptions: {\n                ...options.providerOptions,\n                openai: {\n                  ...openaiOpts,\n                  store: false,\n                },\n              },\n            };\n          };\n\n          const originalDoStream = model.doStream.bind(model);\n          const originalDoGenerate = model.doGenerate.bind(model);\n          model.doStream = (options) => originalDoStream(injectStoreFlag(options));\n          model.doGenerate = (options) => originalDoGenerate(injectStoreFlag(options));\n        }\n        return Ok(model);\n      }\n\n      // Handle xAI provider\n      if (providerName === \"xai\") {\n        // Resolve credentials from config + env (single source of truth)\n        const creds = resolveProviderCredentials(\"xai\", providerConfig);\n        if (!creds.isConfigured) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n\n        const baseFetch = getProviderFetch(providerConfig);\n        const { apiKey: _apiKey, baseURL, headers, ...extraOptions } = providerConfig;\n\n        const { searchParameters, ...restOptions } = extraOptions as {\n          searchParameters?: Record<string, unknown>;\n        } & Record<string, unknown>;\n\n        if (searchParameters && muxProviderOptions) {\n          const existingXaiOverrides = muxProviderOptions.xai ?? {};\n          muxProviderOptions.xai = {\n            ...existingXaiOverrides,\n            searchParameters:\n              existingXaiOverrides.searchParameters ??\n              (searchParameters as XaiProviderOptions[\"searchParameters\"]),\n          };\n        }\n\n        const { createXai } = await PROVIDER_REGISTRY.xai();\n        const provider = createXai({\n          apiKey: creds.apiKey,\n          baseURL: creds.baseUrl ?? baseURL,\n          headers,\n          ...restOptions,\n          fetch: baseFetch,\n        });\n        return Ok(provider(modelId));\n      }\n\n      // Handle Ollama provider\n      if (providerName === \"ollama\") {\n        // Ollama doesn't require API key - it's a local service\n        const baseFetch = getProviderFetch(providerConfig);\n\n        // Lazy-load Ollama provider to reduce startup time\n        const { createOllama } = await PROVIDER_REGISTRY.ollama();\n        const provider = createOllama({\n          ...providerConfig,\n          fetch: baseFetch,\n          // Use strict mode for better compatibility with Ollama API\n          compatibility: \"strict\",\n        });\n        return Ok(provider(modelId));\n      }\n\n      // Handle OpenRouter provider\n      if (providerName === \"openrouter\") {\n        // Resolve credentials from config + env (single source of truth)\n        const creds = resolveProviderCredentials(\"openrouter\", providerConfig);\n        if (!creds.isConfigured) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n        const baseFetch = getProviderFetch(providerConfig);\n\n        // Extract standard provider settings (apiKey, baseUrl, headers, fetch)\n        const {\n          apiKey: _apiKey,\n          baseUrl,\n          headers,\n          fetch: _fetch,\n          ...extraOptions\n        } = providerConfig;\n\n        // OpenRouter routing options that need to be nested under \"provider\" in API request\n        // See: https://openrouter.ai/docs/features/provider-routing\n        const OPENROUTER_ROUTING_OPTIONS = [\n          \"order\",\n          \"allow_fallbacks\",\n          \"only\",\n          \"ignore\",\n          \"require_parameters\",\n          \"data_collection\",\n          \"sort\",\n          \"quantizations\",\n        ];\n\n        // Build extraBody: routing options go under \"provider\", others stay at root\n        const routingOptions: Record<string, unknown> = {};\n        const otherOptions: Record<string, unknown> = {};\n\n        for (const [key, value] of Object.entries(extraOptions)) {\n          if (OPENROUTER_ROUTING_OPTIONS.includes(key)) {\n            routingOptions[key] = value;\n          } else {\n            otherOptions[key] = value;\n          }\n        }\n\n        // Build extraBody with provider nesting if routing options exist\n        let extraBody: Record<string, unknown> | undefined;\n        if (Object.keys(routingOptions).length > 0) {\n          extraBody = { provider: routingOptions, ...otherOptions };\n        } else if (Object.keys(otherOptions).length > 0) {\n          extraBody = otherOptions;\n        }\n\n        // Lazy-load OpenRouter provider to reduce startup time\n        const { createOpenRouter } = await PROVIDER_REGISTRY.openrouter();\n        const provider = createOpenRouter({\n          apiKey: creds.apiKey,\n          baseURL: creds.baseUrl ?? baseUrl,\n          headers,\n          fetch: baseFetch,\n          extraBody,\n        });\n        return Ok(provider(modelId));\n      }\n\n      // Handle Amazon Bedrock provider\n      if (providerName === \"bedrock\") {\n        // Resolve region from config + env (single source of truth)\n        const creds = resolveProviderCredentials(\"bedrock\", providerConfig);\n        if (!creds.isConfigured || !creds.region) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n        const { region } = creds;\n\n        // Optional AWS shared config profile name (equivalent to AWS_PROFILE).\n        // Useful for SSO profiles when Mux isn't launched with AWS_PROFILE set.\n        const profile =\n          typeof providerConfig.profile === \"string\" && providerConfig.profile.trim()\n            ? providerConfig.profile.trim()\n            : undefined;\n\n        const baseFetch = getProviderFetch(providerConfig);\n        const { createAmazonBedrock } = await PROVIDER_REGISTRY.bedrock();\n\n        // Check if explicit credentials are provided in config\n        const hasExplicitCredentials = providerConfig.accessKeyId && providerConfig.secretAccessKey;\n\n        if (hasExplicitCredentials) {\n          // Use explicit credentials from providers.jsonc\n          const provider = createAmazonBedrock({\n            ...providerConfig,\n            region,\n            fetch: baseFetch,\n          });\n          return Ok(provider(modelId));\n        }\n\n        // Check for Bedrock bearer token (simplest auth) - from config or environment\n        // The SDK's apiKey option maps to AWS_BEARER_TOKEN_BEDROCK\n        const bearerToken =\n          typeof providerConfig.bearerToken === \"string\" ? providerConfig.bearerToken : undefined;\n\n        if (bearerToken) {\n          const provider = createAmazonBedrock({\n            region,\n            apiKey: bearerToken,\n            fetch: baseFetch,\n          });\n          return Ok(provider(modelId));\n        }\n\n        // Check if AWS_BEARER_TOKEN_BEDROCK env var is set\n        if (process.env.AWS_BEARER_TOKEN_BEDROCK) {\n          // SDK automatically picks this up via apiKey option\n          const provider = createAmazonBedrock({\n            region,\n            fetch: baseFetch,\n          });\n          return Ok(provider(modelId));\n        }\n\n        // Use AWS credential provider chain for flexible authentication:\n        // - Environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)\n        // - Shared credentials file (~/.aws/credentials)\n        // - EC2 instance profiles\n        // - ECS task roles\n        // - EKS service account (IRSA)\n        // - SSO credentials\n        // - And more...\n        const provider = createAmazonBedrock({\n          region,\n          credentialProvider: fromNodeProviderChain(profile ? { profile } : {}),\n          fetch: baseFetch,\n        });\n        return Ok(provider(modelId));\n      }\n\n      // Handle Mux Gateway provider\n      if (providerName === \"mux-gateway\") {\n        // Resolve couponCode from config (single source of truth)\n        const creds = resolveProviderCredentials(\"mux-gateway\", providerConfig);\n        if (!creds.isConfigured || !creds.couponCode) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n        const { couponCode } = creds;\n\n        const { createGateway } = await PROVIDER_REGISTRY[\"mux-gateway\"]();\n        // For Anthropic models via gateway, wrap fetch to inject cache_control on tools\n        // (gateway provider doesn't process providerOptions.anthropic.cacheControl)\n        // Use getProviderFetch to preserve any user-configured custom fetch (e.g., proxies)\n        const baseFetch = getProviderFetch(providerConfig);\n        const isAnthropicModel = modelId.startsWith(\"anthropic/\");\n        const fetchWithCacheControl = isAnthropicModel\n          ? wrapFetchWithAnthropicCacheControl(baseFetch)\n          : baseFetch;\n        const fetchWithAutoLogout = wrapFetchWithMuxGatewayAutoLogout(\n          fetchWithCacheControl,\n          this.providerService\n        );\n        // Use configured baseURL or fall back to default gateway URL\n        const gatewayBaseURL =\n          providerConfig.baseURL ?? \"https://gateway.mux.coder.com/api/v1/ai-gateway/v1/ai\";\n        const gateway = createGateway({\n          apiKey: couponCode,\n          baseURL: gatewayBaseURL,\n          fetch: fetchWithAutoLogout,\n        });\n        const model = gateway(modelId);\n\n        // Normalize usage format from the gateway server.\n        // The gateway SDK declares specificationVersion \"v3\", so the AI SDK core\n        // expects nested v3 usage: { inputTokens: { total, ... }, outputTokens: { total, ... } }.\n        // However the gateway server may return flat v2-style usage\n        // (e.g. { inputTokens: 123, outputTokens: 456 }), causing\n        // asLanguageModelUsage to produce undefined  0 for all token counts.\n        // These wrappers detect flat usage and convert to v3 nested format.\n        const originalDoStream = model.doStream.bind(model);\n        model.doStream = async (options) => {\n          const result = await originalDoStream(options);\n          return {\n            ...result,\n            // Type assertion safe: the transform only modifies the shape of usage/finishReason\n            // fields within existing chunks, it doesn't change the stream part types.\n            stream: result.stream.pipeThrough(\n              normalizeGatewayStreamUsage()\n            ) as typeof result.stream,\n          };\n        };\n\n        const originalDoGenerate = model.doGenerate.bind(model);\n        model.doGenerate = async (options) => {\n          const result = await originalDoGenerate(options);\n          return normalizeGatewayGenerateResult(result);\n        };\n\n        return Ok(model);\n      }\n\n      // GitHub Copilot  OpenAI-compatible with custom auth headers\n      if (providerName === \"github-copilot\") {\n        const creds = resolveProviderCredentials(\"github-copilot\" as ProviderName, providerConfig);\n        if (!creds.isConfigured) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n\n        const { createOpenAICompatible } = await PROVIDER_REGISTRY[\"github-copilot\"]();\n\n        const baseFetch = getProviderFetch(providerConfig);\n        const copilotFetchFn = async (\n          input: Parameters<typeof fetch>[0],\n          init?: Parameters<typeof fetch>[1]\n        ) => {\n          const headers = new Headers(init?.headers);\n          headers.set(\"Authorization\", `Bearer ${creds.apiKey ?? \"\"}`);\n          headers.set(\"Openai-Intent\", \"conversation-edits\");\n          headers.delete(\"x-api-key\");\n          return baseFetch(input, { ...init, headers });\n        };\n        const copilotFetch = Object.assign(copilotFetchFn, baseFetch) as typeof fetch;\n\n        const baseURL = providerConfig.baseURL ?? \"https://api.githubcopilot.com\";\n        const provider = createOpenAICompatible({\n          name: \"github-copilot\",\n          baseURL,\n          apiKey: \"copilot\", // placeholder  actual auth via custom fetch\n          fetch: copilotFetch,\n        });\n        return Ok(provider.chatModel(modelId));\n      }\n\n      // Generic handler for simple providers (standard API key + factory pattern)\n      // Providers with custom logic (anthropic, openai, xai, ollama, openrouter, bedrock, mux-gateway,\n      // github-copilot) are handled explicitly above. New providers using the standard pattern need\n      // only be added to PROVIDER_DEFINITIONS - no code changes required here.\n      const providerDef = PROVIDER_DEFINITIONS[providerName as ProviderName];\n      if (providerDef) {\n        // Resolve credentials from config + env (single source of truth)\n        const creds = resolveProviderCredentials(providerName as ProviderName, providerConfig);\n        if (providerDef.requiresApiKey && !creds.isConfigured) {\n          return Err({ type: \"api_key_not_found\", provider: providerName });\n        }\n\n        // Lazy-load and create provider using factoryName from definition\n        const providerModule = (await providerDef.import()) as unknown as Record<\n          string,\n          (config: Record<string, unknown>) => (modelId: string) => LanguageModel\n        >;\n        const factory = providerModule[providerDef.factoryName];\n        if (!factory) {\n          return Err({\n            type: \"provider_not_supported\",\n            provider: providerName,\n          });\n        }\n\n        // Merge resolved credentials into config\n        const configWithCreds = {\n          ...providerConfig,\n          ...(creds.apiKey && { apiKey: creds.apiKey }),\n          ...(creds.baseUrl && !providerConfig.baseURL && { baseURL: creds.baseUrl }),\n        };\n\n        const provider = factory({\n          ...configWithCreds,\n          fetch: getProviderFetch(providerConfig),\n        });\n        return Ok(provider(modelId));\n      }\n\n      return Err({\n        type: \"provider_not_supported\",\n        provider: providerName,\n      });\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      return Err({ type: \"unknown\", raw: `Failed to create model: ${errorMessage}` });\n    }\n  }\n\n  /**\n   * Resolve model string (xAI variant mapping + gateway routing) and create the model.\n   *\n   * Combines the xAI thinking-level variant swap, gateway resolution, and model\n   * creation into a single call. Previously this logic was inlined in\n   * `AIService.streamMessage()`.\n   *\n   * @returns On success: the created model + resolution metadata.\n   */\n  async resolveAndCreateModel(\n    modelString: string,\n    thinkingLevel: ThinkingLevel,\n    muxProviderOptions?: MuxProviderOptions\n  ): Promise<\n    Result<\n      {\n        model: LanguageModel;\n        /** Model string after gateway routing (may have `mux-gateway:` prefix). */\n        effectiveModelString: string;\n        /** Model string with gateway prefix stripped (canonical provider:model). */\n        canonicalModelString: string;\n        /** Provider name from the canonical model string. */\n        canonicalProviderName: string;\n        /** Model ID from the canonical model string. */\n        canonicalModelId: string;\n        /** Whether the request is being routed through the Mux gateway. */\n        routedThroughGateway: boolean;\n      },\n      SendMessageError\n    >\n  > {\n    const explicitlyRequestedGateway = modelString.trim().startsWith(\"mux-gateway:\");\n    const canonicalModelString = normalizeGatewayModel(modelString);\n    let effectiveModelString = canonicalModelString;\n    const [canonicalProviderName, canonicalModelId] = parseModelString(canonicalModelString);\n\n    // xAI Grok: swap between reasoning and non-reasoning variants based on thinking level.\n    // xAI only supports full reasoning (no medium/low).\n    if (canonicalProviderName === \"xai\" && canonicalModelId === \"grok-4-1-fast\") {\n      const variant =\n        thinkingLevel !== \"off\" ? \"grok-4-1-fast-reasoning\" : \"grok-4-1-fast-non-reasoning\";\n      effectiveModelString = `xai:${variant}`;\n    }\n\n    effectiveModelString = this.resolveGatewayModelString(\n      effectiveModelString,\n      canonicalModelString,\n      explicitlyRequestedGateway\n    );\n\n    const routedThroughGateway = effectiveModelString.startsWith(\"mux-gateway:\");\n    const modelResult = await this.createModel(effectiveModelString, muxProviderOptions);\n    if (!modelResult.success) {\n      return Err(modelResult.error);\n    }\n\n    return Ok({\n      model: modelResult.data,\n      effectiveModelString,\n      canonicalModelString,\n      canonicalProviderName,\n      canonicalModelId,\n      routedThroughGateway,\n    });\n  }\n  resolveGatewayModelString(\n    modelString: string,\n    modelKey?: string,\n    explicitlyRequestedGateway = false\n  ): string {\n    // Backend-authoritative routing avoids frontend localStorage races (issue #1769).\n    const canonicalModelString = normalizeGatewayModel(modelString);\n    const normalizedModelKey = modelKey ? normalizeGatewayModel(modelKey) : canonicalModelString;\n    const [providerName, modelId] = parseModelString(canonicalModelString);\n\n    if (!providerName || !modelId) {\n      return canonicalModelString;\n    }\n\n    if (providerName === \"mux-gateway\" || !(providerName in PROVIDER_REGISTRY)) {\n      return canonicalModelString;\n    }\n\n    const typedProvider = providerName as ProviderName;\n    if (!MUX_GATEWAY_SUPPORTED_PROVIDERS.has(typedProvider)) {\n      return canonicalModelString;\n    }\n\n    const config = this.config.loadConfigOrDefault();\n    const gatewayEnabled = config.muxGatewayEnabled !== false;\n    const gatewayModels = config.muxGatewayModels ?? [];\n    // Legacy clients may still send mux-gateway model IDs before the backend config\n    // has synchronized their allowlist, so honor an explicit mux-gateway prefix as\n    // an implicit opt-in to avoid first-message API key failures.\n    const isGatewayModelEnabled =\n      explicitlyRequestedGateway ||\n      gatewayModels.includes(canonicalModelString) ||\n      gatewayModels.includes(normalizedModelKey);\n\n    if (!gatewayEnabled || !isGatewayModelEnabled) {\n      return canonicalModelString;\n    }\n\n    const providersConfig = this.config.loadProvidersConfig() ?? {};\n    const gatewayConfig = providersConfig[\"mux-gateway\"] ?? {};\n    const gatewayConfigured = resolveProviderCredentials(\"mux-gateway\", gatewayConfig).isConfigured;\n\n    if (!gatewayConfigured) {\n      return canonicalModelString;\n    }\n\n    return `mux-gateway:${providerName}/${modelId}`;\n  }\n}\n"]}