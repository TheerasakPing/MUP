{"version":3,"file":"providerModelFactory.js","sourceRoot":"","sources":["../../../src/node/services/providerModelFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import type { XaiProviderOptions } from \"@ai-sdk/xai\";\r\nimport { fromNodeProviderChain } from \"@aws-sdk/credential-providers\";\r\nimport type { LanguageModel } from \"ai\";\r\nimport type { ThinkingLevel } from \"@/common/types/thinking\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport {\r\n  PROVIDER_REGISTRY,\r\n  PROVIDER_DEFINITIONS,\r\n  MUX_GATEWAY_SUPPORTED_PROVIDERS,\r\n  type ProviderName,\r\n} from \"@/common/constants/providers\";\r\nimport {\r\n  CODEX_ENDPOINT,\r\n  isCodexOauthAllowedModelId,\r\n  isCodexOauthRequiredModelId,\r\n} from \"@/common/constants/codexOAuth\";\r\nimport { parseCodexOauthAuth } from \"@/node/utils/codexOauthAuth\";\r\nimport type { Config, ProviderConfig } from \"@/node/config\";\r\nimport type { MuxProviderOptions } from \"@/common/types/providerOptions\";\r\nimport type { PolicyService } from \"@/node/services/policyService\";\r\nimport type { ProviderService } from \"@/node/services/providerService\";\r\nimport type { CodexOauthService } from \"@/node/services/codexOauthService\";\r\nimport { normalizeGatewayModel, supports1MContext } from \"@/common/utils/ai/models\";\r\nimport { MUX_APP_ATTRIBUTION_TITLE, MUX_APP_ATTRIBUTION_URL } from \"@/constants/appAttribution\";\r\nimport { resolveProviderCredentials } from \"@/node/utils/providerRequirements\";\r\nimport {\r\n  normalizeGatewayStreamUsage,\r\n  normalizeGatewayGenerateResult,\r\n} from \"@/node/utils/gatewayStreamNormalization\";\r\nimport { EnvHttpProxyAgent, type Dispatcher } from \"undici\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Undici agent with unlimited timeouts for AI streaming requests.\r\n// Safe because users control cancellation via AbortSignal from the UI.\r\n// Uses EnvHttpProxyAgent to automatically respect HTTP_PROXY, HTTPS_PROXY,\r\n// and NO_PROXY environment variables for debugging/corporate network support.\r\n// ---------------------------------------------------------------------------\r\n\r\nconst unlimitedTimeoutAgent = new EnvHttpProxyAgent({\r\n  bodyTimeout: 0, // No timeout - prevents BodyTimeoutError on long reasoning pauses\r\n  headersTimeout: 0, // No timeout for headers\r\n});\r\n\r\n// Extend RequestInit with undici-specific dispatcher property (Node.js only)\r\ntype RequestInitWithDispatcher = RequestInit & { dispatcher?: Dispatcher };\r\n\r\n/**\r\n * Default fetch function with unlimited timeouts for AI streaming.\r\n * Uses undici Agent to remove artificial timeout limits while still\r\n * respecting user cancellation via AbortSignal.\r\n *\r\n * Note: If users provide custom fetch in providers.jsonc, they are\r\n * responsible for configuring timeouts appropriately. Custom fetch\r\n * implementations using undici should set bodyTimeout: 0 and\r\n * headersTimeout: 0 to prevent BodyTimeoutError on long-running\r\n * reasoning models.\r\n */\r\nconst defaultFetchWithUnlimitedTimeout = (async (\r\n  input: RequestInfo | URL,\r\n  init?: RequestInit\r\n): Promise<Response> => {\r\n  // dispatcher is a Node.js undici-specific property for custom HTTP agents\r\n  const requestInit: RequestInitWithDispatcher = {\r\n    ...(init ?? {}),\r\n    dispatcher: unlimitedTimeoutAgent,\r\n  };\r\n  return fetch(input, requestInit);\r\n}) as typeof fetch;\r\n\r\ntype FetchWithBunExtensions = typeof fetch & {\r\n  preconnect?: typeof fetch extends { preconnect: infer P } ? P : unknown;\r\n  certificate?: typeof fetch extends { certificate: infer C } ? C : unknown;\r\n};\r\n\r\nconst globalFetchWithExtras = fetch as FetchWithBunExtensions;\r\nconst defaultFetchWithExtras = defaultFetchWithUnlimitedTimeout as FetchWithBunExtensions;\r\n\r\nif (typeof globalFetchWithExtras.preconnect === \"function\") {\r\n  defaultFetchWithExtras.preconnect = globalFetchWithExtras.preconnect.bind(globalFetchWithExtras);\r\n}\r\n\r\nif (typeof globalFetchWithExtras.certificate === \"function\") {\r\n  defaultFetchWithExtras.certificate =\r\n    globalFetchWithExtras.certificate.bind(globalFetchWithExtras);\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Fetch wrappers\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Wrap fetch to inject Anthropic cache_control directly into the request body.\r\n * The AI SDK's providerOptions.anthropic.cacheControl doesn't get translated\r\n * to raw cache_control for tools or message content parts, so we inject it\r\n * at the HTTP level.\r\n *\r\n * Injects cache_control on:\r\n * 1. Last tool (caches all tool definitions)\r\n * 2. Last message's last content part (caches entire conversation)\r\n */\r\nfunction wrapFetchWithAnthropicCacheControl(baseFetch: typeof fetch): typeof fetch {\r\n  const cachingFetch = async (\r\n    input: Parameters<typeof fetch>[0],\r\n    init?: Parameters<typeof fetch>[1]\r\n  ): Promise<Response> => {\r\n    // Only modify POST requests with JSON body\r\n    if (init?.method?.toUpperCase() !== \"POST\" || typeof init?.body !== \"string\") {\r\n      return baseFetch(input, init);\r\n    }\r\n\r\n    try {\r\n      const json = JSON.parse(init.body) as Record<string, unknown>;\r\n\r\n      // Inject cache_control on the last tool if tools array exists\r\n      if (Array.isArray(json.tools) && json.tools.length > 0) {\r\n        const lastTool = json.tools[json.tools.length - 1] as Record<string, unknown>;\r\n        lastTool.cache_control ??= { type: \"ephemeral\" };\r\n      }\r\n\r\n      // Inject cache_control on last message's last content part\r\n      // This caches the entire conversation\r\n      // Handle both formats:\r\n      // - Direct Anthropic provider: json.messages (Anthropic API format)\r\n      // - Gateway provider: json.prompt (AI SDK internal format)\r\n      const messages = Array.isArray(json.messages)\r\n        ? json.messages\r\n        : Array.isArray(json.prompt)\r\n          ? json.prompt\r\n          : null;\r\n\r\n      if (messages && messages.length >= 1) {\r\n        const lastMsg = messages[messages.length - 1] as Record<string, unknown>;\r\n\r\n        // For gateway: add providerOptions.anthropic.cacheControl at message level\r\n        // (gateway validates schema strictly, doesn't allow raw cache_control on messages)\r\n        if (Array.isArray(json.prompt)) {\r\n          const providerOpts = (lastMsg.providerOptions ?? {}) as Record<string, unknown>;\r\n          const anthropicOpts = (providerOpts.anthropic ?? {}) as Record<string, unknown>;\r\n          anthropicOpts.cacheControl ??= { type: \"ephemeral\" };\r\n          providerOpts.anthropic = anthropicOpts;\r\n          lastMsg.providerOptions = providerOpts;\r\n        }\r\n\r\n        // For direct Anthropic: add cache_control to last content part\r\n        const content = lastMsg.content;\r\n        if (Array.isArray(content) && content.length > 0) {\r\n          const lastPart = content[content.length - 1] as Record<string, unknown>;\r\n          lastPart.cache_control ??= { type: \"ephemeral\" };\r\n        }\r\n      }\r\n\r\n      // Update body with modified JSON\r\n      const newBody = JSON.stringify(json);\r\n      const headers = new Headers(init?.headers);\r\n      headers.delete(\"content-length\"); // Body size changed\r\n      return baseFetch(input, { ...init, headers, body: newBody });\r\n    } catch {\r\n      // If parsing fails, pass through unchanged\r\n      return baseFetch(input, init);\r\n    }\r\n  };\r\n\r\n  return Object.assign(cachingFetch, baseFetch) as typeof fetch;\r\n}\r\n\r\n/**\r\n * Wrap fetch so any mux-gateway 401 response clears local credentials (best-effort).\r\n *\r\n * This ensures the UI immediately reflects that the user has been logged out\r\n * when the gateway session expires.\r\n */\r\nfunction wrapFetchWithMuxGatewayAutoLogout(\r\n  baseFetch: typeof fetch,\r\n  providerService: ProviderService\r\n): typeof fetch {\r\n  const wrappedFetch = async (\r\n    input: Parameters<typeof fetch>[0],\r\n    init?: Parameters<typeof fetch>[1]\r\n  ): Promise<Response> => {\r\n    const response = await baseFetch(input, init);\r\n\r\n    if (response.status === 401) {\r\n      try {\r\n        providerService.setConfig(\"mux-gateway\", [\"couponCode\"], \"\");\r\n        providerService.setConfig(\"mux-gateway\", [\"voucher\"], \"\");\r\n      } catch {\r\n        // Ignore failures clearing local credentials\r\n      }\r\n    }\r\n\r\n    return response;\r\n  };\r\n\r\n  return Object.assign(wrappedFetch, baseFetch) as typeof fetch;\r\n}\r\n\r\n/**\r\n * Get fetch function for provider - use custom if provided, otherwise unlimited timeout default\r\n */\r\nfunction getProviderFetch(providerConfig: ProviderConfig): typeof fetch {\r\n  return typeof providerConfig.fetch === \"function\"\r\n    ? (providerConfig.fetch as typeof fetch)\r\n    : defaultFetchWithUnlimitedTimeout;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Exported helpers (re-exported from aiService.ts for backward compatibility)\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Normalize Anthropic base URL to ensure it ends with /v1 suffix.\r\n *\r\n * The Anthropic SDK expects baseURL to include /v1 (default: https://api.anthropic.com/v1).\r\n * Many users configure base URLs without the /v1 suffix, which causes API calls to fail.\r\n * This function automatically appends /v1 if missing.\r\n *\r\n * @param baseURL - The base URL to normalize (may or may not have /v1)\r\n * @returns The base URL with /v1 suffix\r\n */\r\nexport function normalizeAnthropicBaseURL(baseURL: string): string {\r\n  const trimmed = baseURL.replace(/\\/+$/, \"\"); // Remove trailing slashes\r\n  if (trimmed.endsWith(\"/v1\")) {\r\n    return trimmed;\r\n  }\r\n  return `${trimmed}/v1`;\r\n}\r\n\r\n/** Header value for Anthropic 1M context beta */\r\nexport const ANTHROPIC_1M_CONTEXT_HEADER = \"context-1m-2025-08-07\";\r\n\r\n/**\r\n * Build headers for Anthropic provider, optionally including the 1M context beta header.\r\n * Exported for testing.\r\n */\r\nexport function buildAnthropicHeaders(\r\n  existingHeaders: Record<string, string> | undefined,\r\n  use1MContext: boolean | undefined\r\n): Record<string, string> | undefined {\r\n  if (!use1MContext) {\r\n    return existingHeaders;\r\n  }\r\n  if (existingHeaders) {\r\n    return { ...existingHeaders, \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER };\r\n  }\r\n  return { \"anthropic-beta\": ANTHROPIC_1M_CONTEXT_HEADER };\r\n}\r\n\r\n/**\r\n * Build app attribution headers used by OpenRouter (and other compatible platforms).\r\n *\r\n * Attribution docs:\r\n * - OpenRouter: https://openrouter.ai/docs/app-attribution\r\n * - Vercel AI Gateway: https://vercel.com/docs/ai-gateway/app-attribution\r\n *\r\n * Exported for testing.\r\n */\r\nexport function buildAppAttributionHeaders(\r\n  existingHeaders: Record<string, string> | undefined\r\n): Record<string, string> {\r\n  // Clone to avoid mutating caller-provided objects.\r\n  const headers: Record<string, string> = existingHeaders ? { ...existingHeaders } : {};\r\n\r\n  // Header names are case-insensitive. Preserve user-provided values by never overwriting.\r\n  const existingLowercaseKeys = new Set(Object.keys(headers).map((key) => key.toLowerCase()));\r\n\r\n  if (!existingLowercaseKeys.has(\"http-referer\")) {\r\n    headers[\"HTTP-Referer\"] = MUX_APP_ATTRIBUTION_URL;\r\n  }\r\n\r\n  if (!existingLowercaseKeys.has(\"x-title\")) {\r\n    headers[\"X-Title\"] = MUX_APP_ATTRIBUTION_TITLE;\r\n  }\r\n\r\n  return headers;\r\n}\r\n\r\n/**\r\n * Preload AI SDK provider modules to avoid race conditions in concurrent test environments.\r\n * This function loads @ai-sdk/anthropic, @ai-sdk/openai, and ollama-ai-provider-v2 eagerly\r\n * so that subsequent dynamic imports in createModel() hit the module cache instead of racing.\r\n *\r\n * In production, providers are lazy-loaded on first use to optimize startup time.\r\n * In tests, we preload them once during setup to ensure reliable concurrent execution.\r\n */\r\nexport async function preloadAISDKProviders(): Promise<void> {\r\n  // Preload providers to ensure they're in the module cache before concurrent tests run\r\n  await Promise.all(Object.values(PROVIDER_REGISTRY).map((importFn) => importFn()));\r\n}\r\n\r\n/**\r\n * Parse provider and model ID from model string.\r\n * Handles model IDs with colons (e.g., \"ollama:gpt-oss:20b\").\r\n * Only splits on the first colon to support Ollama model naming convention.\r\n *\r\n * @param modelString - Model string in format \"provider:model-id\"\r\n * @returns Tuple of [providerName, modelId]\r\n * @example\r\n * parseModelString(\"anthropic:claude-opus-4\") // [\"anthropic\", \"claude-opus-4\"]\r\n * parseModelString(\"ollama:gpt-oss:20b\") // [\"ollama\", \"gpt-oss:20b\"]\r\n */\r\nexport function parseModelString(modelString: string): [string, string] {\r\n  const colonIndex = modelString.indexOf(\":\");\r\n  const providerName = colonIndex !== -1 ? modelString.slice(0, colonIndex) : modelString;\r\n  const modelId = colonIndex !== -1 ? modelString.slice(colonIndex + 1) : \"\";\r\n  return [providerName, modelId];\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Model cost tracking\r\n// ---------------------------------------------------------------------------\r\n\r\nconst MUX_MODEL_COSTS_INCLUDED = Symbol(\"mux:modelCostsIncluded\");\r\n\r\ntype LanguageModelWithMuxCostsIncluded = LanguageModel & {\r\n  [MUX_MODEL_COSTS_INCLUDED]?: true;\r\n};\r\n\r\nfunction markModelCostsIncluded(model: LanguageModel): void {\r\n  (model as LanguageModelWithMuxCostsIncluded)[MUX_MODEL_COSTS_INCLUDED] = true;\r\n}\r\n\r\nexport function modelCostsIncluded(model: LanguageModel): boolean {\r\n  return (model as LanguageModelWithMuxCostsIncluded)[MUX_MODEL_COSTS_INCLUDED] === true;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Content extraction\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Extract text from AI SDK message content.\r\n * Content may be a plain string or a structured array like [{type:\"text\", text:\"...\"}].\r\n */\r\nfunction extractTextContent(content: unknown): string {\r\n  if (typeof content === \"string\") return content.trim();\r\n  if (Array.isArray(content)) {\r\n    return (content as unknown[])\r\n      .filter(\r\n        (part): part is { type: string; text: string } =>\r\n          typeof part === \"object\" &&\r\n          part !== null &&\r\n          (part as { type?: unknown }).type === \"text\" &&\r\n          typeof (part as { text?: unknown }).text === \"string\"\r\n      )\r\n      .map((part) => part.text)\r\n      .join(\"\")\r\n      .trim();\r\n  }\r\n  return \"\";\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// ProviderModelFactory\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Factory responsible for creating AI SDK LanguageModel instances from model strings.\r\n *\r\n * Extracted from AIService to isolate provider/model construction logic from the\r\n * streaming and orchestration concerns that AIService owns.\r\n */\r\nexport class ProviderModelFactory {\r\n  private readonly config: Config;\r\n  private readonly providerService: ProviderService;\r\n  private readonly policyService?: PolicyService;\r\n  codexOauthService?: CodexOauthService;\r\n\r\n  constructor(\r\n    config: Config,\r\n    providerService: ProviderService,\r\n    policyService?: PolicyService,\r\n    codexOauthService?: CodexOauthService\r\n  ) {\r\n    this.config = config;\r\n    this.providerService = providerService;\r\n    this.policyService = policyService;\r\n    this.codexOauthService = codexOauthService;\r\n  }\r\n\r\n  /**\r\n   * Create an AI SDK model from a model string (e.g., \"anthropic:claude-opus-4-1\")\r\n   *\r\n   * IMPORTANT: We ONLY use providers.jsonc as the single source of truth for provider configuration.\r\n   * We DO NOT use environment variables or default constructors that might read them.\r\n   * This ensures consistent, predictable configuration management.\r\n   *\r\n   * Provider configuration from providers.jsonc is passed verbatim to the provider\r\n   * constructor, ensuring automatic parity with Vercel AI SDK - any configuration options\r\n   * supported by the provider will work without modification.\r\n   */\r\n  async createModel(\r\n    modelString: string,\r\n    muxProviderOptions?: MuxProviderOptions\r\n  ): Promise<Result<LanguageModel, SendMessageError>> {\r\n    try {\r\n      // Parse model string (format: \"provider:model-id\")\r\n      // Parse provider and model ID from model string\r\n      const [providerName, modelId] = parseModelString(modelString);\r\n\r\n      if (!providerName || !modelId) {\r\n        return Err({\r\n          type: \"invalid_model_string\",\r\n          message: `Invalid model string format: \"${modelString}\". Expected \"provider:model-id\"`,\r\n        });\r\n      }\r\n\r\n      // Check if provider is supported (prevents silent failures when adding to PROVIDER_REGISTRY\r\n      // but forgetting to implement handler below)\r\n      if (!(providerName in PROVIDER_REGISTRY)) {\r\n        return Err({\r\n          type: \"provider_not_supported\",\r\n          provider: providerName,\r\n        });\r\n      }\r\n\r\n      if (this.policyService?.isEnforced()) {\r\n        const provider = providerName as ProviderName;\r\n        if (!this.policyService.isProviderAllowed(provider)) {\r\n          return Err({\r\n            type: \"policy_denied\",\r\n            message: `Provider ${providerName} is not allowed by policy`,\r\n          });\r\n        }\r\n\r\n        if (!this.policyService.isModelAllowed(provider, modelId)) {\r\n          return Err({\r\n            type: \"policy_denied\",\r\n            message: `Model ${providerName}:${modelId} is not allowed by policy`,\r\n          });\r\n        }\r\n      }\r\n\r\n      // Load providers configuration - the ONLY source of truth\r\n      const providersConfig = this.config.loadProvidersConfig();\r\n      let providerConfig = providersConfig?.[providerName] ?? {};\r\n\r\n      // Map baseUrl to baseURL if present (SDK expects baseURL)\r\n      const { baseUrl, ...configWithoutBaseUrl } = providerConfig;\r\n      providerConfig = baseUrl\r\n        ? { ...configWithoutBaseUrl, baseURL: baseUrl }\r\n        : configWithoutBaseUrl;\r\n\r\n      // Policy: force provider base URL (if configured).\r\n      const forcedBaseUrl = this.policyService?.isEnforced()\r\n        ? this.policyService.getForcedBaseUrl(providerName as ProviderName)\r\n        : undefined;\r\n      if (forcedBaseUrl) {\r\n        providerConfig = { ...providerConfig, baseURL: forcedBaseUrl };\r\n      }\r\n\r\n      // Inject app attribution headers (used by OpenRouter and other compatible platforms).\r\n      // We never overwrite user-provided values (case-insensitive header matching).\r\n      providerConfig = {\r\n        ...providerConfig,\r\n        headers: buildAppAttributionHeaders(providerConfig.headers),\r\n      };\r\n\r\n      // Handle Anthropic provider\r\n      if (providerName === \"anthropic\") {\r\n        // Resolve credentials from config + env (single source of truth)\r\n        const creds = resolveProviderCredentials(\"anthropic\", providerConfig);\r\n        if (!creds.isConfigured) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n\r\n        // Build config with resolved credentials\r\n        const configWithApiKey = creds.apiKey\r\n          ? { ...providerConfig, apiKey: creds.apiKey }\r\n          : providerConfig;\r\n\r\n        // Normalize base URL to ensure /v1 suffix (SDK expects it)\r\n        const effectiveBaseURL = configWithApiKey.baseURL ?? creds.baseUrl?.trim();\r\n        const normalizedConfig = effectiveBaseURL\r\n          ? { ...configWithApiKey, baseURL: normalizeAnthropicBaseURL(effectiveBaseURL) }\r\n          : configWithApiKey;\r\n\r\n        // Add 1M context beta header if requested and model supports it.\r\n        // Check both per-model list (use1MContextModels) and legacy global flag (use1MContext).\r\n        const fullModelId = `anthropic:${modelId}`;\r\n        const is1MEnabled =\r\n          ((muxProviderOptions?.anthropic?.use1MContextModels?.includes(fullModelId) ?? false) ||\r\n            muxProviderOptions?.anthropic?.use1MContext === true) &&\r\n          supports1MContext(fullModelId);\r\n        const headers = buildAnthropicHeaders(normalizedConfig.headers, is1MEnabled);\r\n\r\n        // Lazy-load Anthropic provider to reduce startup time\r\n        const { createAnthropic } = await PROVIDER_REGISTRY.anthropic();\r\n        // Wrap fetch to inject cache_control on tools and messages\r\n        // (SDK doesn't translate providerOptions to cache_control for these)\r\n        // Use getProviderFetch to preserve any user-configured custom fetch (e.g., proxies)\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n        const fetchWithCacheControl = wrapFetchWithAnthropicCacheControl(baseFetch);\r\n        const provider = createAnthropic({\r\n          ...normalizedConfig,\r\n          headers,\r\n          fetch: fetchWithCacheControl,\r\n        });\r\n        return Ok(provider(modelId));\r\n      }\r\n\r\n      // Handle OpenAI provider (using Responses API)\r\n      if (providerName === \"openai\") {\r\n        const fullModelId = `${providerName}:${modelId}`;\r\n\r\n        const codexOauthAllowed = isCodexOauthAllowedModelId(fullModelId);\r\n        const codexOauthRequired = isCodexOauthRequiredModelId(fullModelId);\r\n\r\n        const storedCodexOauth = parseCodexOauthAuth(\r\n          (providerConfig as { codexOauth?: unknown }).codexOauth\r\n        );\r\n\r\n        // Resolve credentials from config + env BEFORE OAuth checks so we can\r\n        // fall back to an API key when OAuth is not connected.\r\n        const creds = resolveProviderCredentials(\"openai\", providerConfig);\r\n\r\n        // When a model requires Codex OAuth but the user hasn't connected it,\r\n        // fall back to their API key instead of blocking entirely.  If the model\r\n        // truly only works through OAuth, OpenAI's API will return a clear error.\r\n        if (codexOauthRequired && !storedCodexOauth && !creds.isConfigured) {\r\n          return Err({ type: \"oauth_not_connected\", provider: providerName });\r\n        }\r\n\r\n        const codexOauthDefaultAuthRaw = (providerConfig as { codexOauthDefaultAuth?: unknown })\r\n          .codexOauthDefaultAuth;\r\n        const codexOauthDefaultAuth = codexOauthDefaultAuthRaw === \"apiKey\" ? \"apiKey\" : \"oauth\";\r\n\r\n        // Codex OAuth routing:\r\n        // - Required models route through ChatGPT OAuth when connected.\r\n        // - If OAuth is not connected, fall back to API key (if available).\r\n        // - Allowed models route through OAuth only when:\r\n        //   - no API key is configured, OR\r\n        //   - the user prefers OAuth when both are set.\r\n        const shouldRouteThroughCodexOauth = (() => {\r\n          if (!codexOauthAllowed || !storedCodexOauth) {\r\n            return false;\r\n          }\r\n\r\n          if (codexOauthRequired) {\r\n            return true;\r\n          }\r\n\r\n          if (!creds.isConfigured) {\r\n            return true;\r\n          }\r\n\r\n          return codexOauthDefaultAuth === \"oauth\";\r\n        })();\r\n\r\n        if (!shouldRouteThroughCodexOauth && !creds.isConfigured) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n\r\n        // Merge resolved credentials into config\r\n        const configWithCreds = {\r\n          ...providerConfig,\r\n          // When using Codex OAuth, we overwrite auth headers in fetch(), so the OpenAI API key\r\n          // isn't required. Still pass a placeholder to ensure the SDK never reads env vars.\r\n          apiKey: shouldRouteThroughCodexOauth ? (creds.apiKey ?? \"codex-oauth\") : creds.apiKey,\r\n          ...(creds.baseUrl && !providerConfig.baseURL && { baseURL: creds.baseUrl }),\r\n          ...(creds.organization && { organization: creds.organization }),\r\n        };\r\n\r\n        // Extract serviceTier from config to pass through to buildProviderOptions\r\n        const configServiceTier = providerConfig.serviceTier as string | undefined;\r\n        if (configServiceTier && muxProviderOptions) {\r\n          muxProviderOptions.openai = {\r\n            ...muxProviderOptions.openai,\r\n            serviceTier: configServiceTier as \"auto\" | \"default\" | \"flex\" | \"priority\",\r\n          };\r\n        }\r\n\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n        const codexOauthService = this.codexOauthService;\r\n\r\n        // Wrap fetch to default truncation to \"disabled\" for OpenAI Responses API calls.\r\n        // This preserves our compaction handling while still allowing explicit truncation (e.g., auto).\r\n        const fetchWithOpenAITruncation = Object.assign(\r\n          async (\r\n            input: Parameters<typeof fetch>[0],\r\n            init?: Parameters<typeof fetch>[1]\r\n          ): Promise<Response> => {\r\n            try {\r\n              const urlString = (() => {\r\n                if (typeof input === \"string\") {\r\n                  return input;\r\n                }\r\n                if (input instanceof URL) {\r\n                  return input.toString();\r\n                }\r\n                if (typeof input === \"object\" && input !== null && \"url\" in input) {\r\n                  const possibleUrl = (input as { url?: unknown }).url;\r\n                  if (typeof possibleUrl === \"string\") {\r\n                    return possibleUrl;\r\n                  }\r\n                }\r\n                return \"\";\r\n              })();\r\n\r\n              const method = (init?.method ?? \"GET\").toUpperCase();\r\n              const isOpenAIResponses = /\\/v1\\/responses(\\?|$)/.test(urlString);\r\n              const isOpenAIChatCompletions = /\\/chat\\/completions(\\?|$)/.test(urlString);\r\n\r\n              let nextInput: Parameters<typeof fetch>[0] = input;\r\n              let nextInit: Parameters<typeof fetch>[1] | undefined = init;\r\n\r\n              const body = init?.body;\r\n              // Only parse the JSON body when routing through Codex OAuth  it needs\r\n              // instruction lifting, store=false, and truncation enforcement.  For\r\n              // non-Codex requests the SDK already sends the correct truncation value\r\n              // via providerOptions, so we skip the expensive parse + re-stringify.\r\n              if (\r\n                shouldRouteThroughCodexOauth &&\r\n                isOpenAIResponses &&\r\n                method === \"POST\" &&\r\n                typeof body === \"string\"\r\n              ) {\r\n                try {\r\n                  const json = JSON.parse(body) as Record<string, unknown>;\r\n                  const truncation = json.truncation;\r\n                  if (truncation !== \"auto\" && truncation !== \"disabled\") {\r\n                    json.truncation = \"disabled\";\r\n                  }\r\n\r\n                  // Codex OAuth (chatgpt.com/backend-api/codex/responses) rejects requests unless\r\n                  // `instructions` is present and non-empty, and `store` is set to false.\r\n                  // The AI SDK maps `system` prompts into the `input` array\r\n                  // (role: system|developer) but does *not* automatically populate\r\n                  // `instructions`, so we lift all system prompts into `instructions` when\r\n                  // routing through Codex OAuth.\r\n\r\n                  // Codex endpoint requires store=false and only accepts a subset of the\r\n                  // standard OpenAI Responses API parameters. Use an allowlist to strip\r\n                  // everything the endpoint doesn't understand (it rejects unknown params\r\n                  // with 400).\r\n                  json.store = false;\r\n\r\n                  const CODEX_ALLOWED_PARAMS = new Set([\r\n                    \"model\",\r\n                    \"input\",\r\n                    \"instructions\",\r\n                    \"tools\",\r\n                    \"tool_choice\",\r\n                    \"parallel_tool_calls\",\r\n                    \"stream\",\r\n                    \"store\",\r\n                    \"prompt_cache_key\",\r\n                    \"reasoning\",\r\n                    \"temperature\",\r\n                    \"top_p\",\r\n                    \"include\",\r\n                    \"text\", // structured output via Output.object  text.format\r\n                  ]);\r\n\r\n                  for (const key of Object.keys(json)) {\r\n                    if (!CODEX_ALLOWED_PARAMS.has(key)) {\r\n                      delete json[key];\r\n                    }\r\n                  }\r\n\r\n                  // Filter out item_reference entries from the input. The AI SDK sends\r\n                  // these as an optimization when store=true  bare { type: \"item_reference\",\r\n                  // id: \"rs_...\" } objects that the server expands by looking up stored\r\n                  // content. With store=false (required for Codex), these lookups fail.\r\n                  // The full inline content is always present alongside references, so\r\n                  // removing them doesn't lose conversation context.\r\n                  if (Array.isArray(json.input)) {\r\n                    json.input = (json.input as Array<Record<string, unknown>>).filter(\r\n                      (item) =>\r\n                        !(item && typeof item === \"object\" && item.type === \"item_reference\")\r\n                    );\r\n                  }\r\n\r\n                  const existingInstructions =\r\n                    typeof json.instructions === \"string\" ? json.instructions.trim() : \"\";\r\n\r\n                  if (existingInstructions.length === 0) {\r\n                    const derivedParts: string[] = [];\r\n                    const keptInput: unknown[] = [];\r\n\r\n                    const responseInput = json.input;\r\n                    if (Array.isArray(responseInput)) {\r\n                      for (const item of responseInput as unknown[]) {\r\n                        if (!item || typeof item !== \"object\") {\r\n                          keptInput.push(item);\r\n                          continue;\r\n                        }\r\n\r\n                        const role = (item as { role?: unknown }).role;\r\n                        if (role !== \"system\" && role !== \"developer\") {\r\n                          keptInput.push(item);\r\n                          continue;\r\n                        }\r\n\r\n                        // Extract text from string content or structured content arrays\r\n                        // (AI SDK may produce [{type:\"text\", text:\"...\"}])\r\n                        const content = (item as { content?: unknown }).content;\r\n                        const text = extractTextContent(content);\r\n                        if (text.length > 0) {\r\n                          derivedParts.push(text);\r\n                        }\r\n                        // Drop this system/developer item from input (don't push to keptInput)\r\n                      }\r\n\r\n                      json.input = keptInput;\r\n                    }\r\n\r\n                    const joined = derivedParts.join(\"\\n\\n\").trim();\r\n                    json.instructions = joined.length > 0 ? joined : \"You are a helpful assistant.\";\r\n                  }\r\n\r\n                  // Clone headers to avoid mutating caller-provided objects\r\n                  const headers = new Headers(init?.headers);\r\n                  // Remove content-length if present, since body will change\r\n                  headers.delete(\"content-length\");\r\n\r\n                  const newBody = JSON.stringify(json);\r\n                  nextInit = { ...init, headers, body: newBody };\r\n                } catch {\r\n                  // If body isn't JSON, fall through to normal fetch (but still allow Codex routing).\r\n                }\r\n              }\r\n\r\n              if (shouldRouteThroughCodexOauth && (isOpenAIResponses || isOpenAIChatCompletions)) {\r\n                if (!codexOauthService) {\r\n                  throw new Error(\"Codex OAuth service not initialized\");\r\n                }\r\n\r\n                const authResult = await codexOauthService.getValidAuth();\r\n                if (!authResult.success) {\r\n                  throw new Error(authResult.error);\r\n                }\r\n\r\n                const headers = new Headers(nextInit?.headers);\r\n                headers.set(\"Authorization\", `Bearer ${authResult.data.access}`);\r\n                if (authResult.data.accountId) {\r\n                  headers.set(\"ChatGPT-Account-Id\", authResult.data.accountId);\r\n                }\r\n\r\n                nextInput = CODEX_ENDPOINT;\r\n                nextInit = { ...(nextInit ?? {}), headers };\r\n              }\r\n\r\n              return baseFetch(nextInput, nextInit);\r\n            } catch (error) {\r\n              // For normal OpenAI (API key) requests, fall back to the original fetch on unexpected errors.\r\n              // For Codex OAuth routing, failures should surface (falling back would hit api.openai.com).\r\n              if (shouldRouteThroughCodexOauth) {\r\n                throw error;\r\n              }\r\n              return baseFetch(input, init);\r\n            }\r\n          },\r\n          \"preconnect\" in baseFetch && typeof baseFetch.preconnect === \"function\"\r\n            ? {\r\n                preconnect: baseFetch.preconnect.bind(baseFetch),\r\n              }\r\n            : {}\r\n        );\r\n\r\n        // Lazy-load OpenAI provider to reduce startup time\r\n        const { createOpenAI } = await PROVIDER_REGISTRY.openai();\r\n        const provider = createOpenAI({\r\n          ...configWithCreds,\r\n          // Cast is safe: our fetch implementation is compatible with the SDK's fetch type.\r\n          // The preconnect method is optional in our implementation but required by the SDK type.\r\n          fetch: fetchWithOpenAITruncation as typeof fetch,\r\n        });\r\n        // Use Responses API for persistence and built-in tools\r\n        // OpenAI manages reasoning state via previousResponseId - no middleware needed\r\n        const model = provider.responses(modelId);\r\n        if (shouldRouteThroughCodexOauth) {\r\n          markModelCostsIncluded(model);\r\n\r\n          // Wrap model to inject store=false into providerOptions so the SDK\r\n          // sends full inline content instead of item_reference lookups.\r\n          // The Codex endpoint requires store=false; without this, the SDK\r\n          // defaults to store=true and sends bare { type: \"item_reference\" }\r\n          // items that can't be resolved.\r\n          const injectStoreFlag = (\r\n            options: Parameters<typeof model.doStream>[0]\r\n          ): Parameters<typeof model.doStream>[0] => {\r\n            const openaiOpts =\r\n              (options.providerOptions?.openai as Record<string, unknown> | undefined) ?? {};\r\n            return {\r\n              ...options,\r\n              providerOptions: {\r\n                ...options.providerOptions,\r\n                openai: {\r\n                  ...openaiOpts,\r\n                  store: false,\r\n                },\r\n              },\r\n            };\r\n          };\r\n\r\n          const originalDoStream = model.doStream.bind(model);\r\n          const originalDoGenerate = model.doGenerate.bind(model);\r\n          model.doStream = (options) => originalDoStream(injectStoreFlag(options));\r\n          model.doGenerate = (options) => originalDoGenerate(injectStoreFlag(options));\r\n        }\r\n        return Ok(model);\r\n      }\r\n\r\n      // Handle xAI provider\r\n      if (providerName === \"xai\") {\r\n        // Resolve credentials from config + env (single source of truth)\r\n        const creds = resolveProviderCredentials(\"xai\", providerConfig);\r\n        if (!creds.isConfigured) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n        const { apiKey: _apiKey, baseURL, headers, ...extraOptions } = providerConfig;\r\n\r\n        const { searchParameters, ...restOptions } = extraOptions as {\r\n          searchParameters?: Record<string, unknown>;\r\n        } & Record<string, unknown>;\r\n\r\n        if (searchParameters && muxProviderOptions) {\r\n          const existingXaiOverrides = muxProviderOptions.xai ?? {};\r\n          muxProviderOptions.xai = {\r\n            ...existingXaiOverrides,\r\n            searchParameters:\r\n              existingXaiOverrides.searchParameters ??\r\n              (searchParameters as XaiProviderOptions[\"searchParameters\"]),\r\n          };\r\n        }\r\n\r\n        const { createXai } = await PROVIDER_REGISTRY.xai();\r\n        const provider = createXai({\r\n          apiKey: creds.apiKey,\r\n          baseURL: creds.baseUrl ?? baseURL,\r\n          headers,\r\n          ...restOptions,\r\n          fetch: baseFetch,\r\n        });\r\n        return Ok(provider(modelId));\r\n      }\r\n\r\n      // Handle Ollama provider\r\n      if (providerName === \"ollama\") {\r\n        // Ollama doesn't require API key - it's a local service\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n\r\n        // Lazy-load Ollama provider to reduce startup time\r\n        const { createOllama } = await PROVIDER_REGISTRY.ollama();\r\n        const provider = createOllama({\r\n          ...providerConfig,\r\n          fetch: baseFetch,\r\n          // Use strict mode for better compatibility with Ollama API\r\n          compatibility: \"strict\",\r\n        });\r\n        return Ok(provider(modelId));\r\n      }\r\n\r\n      // Handle OpenRouter provider\r\n      if (providerName === \"openrouter\") {\r\n        // Resolve credentials from config + env (single source of truth)\r\n        const creds = resolveProviderCredentials(\"openrouter\", providerConfig);\r\n        if (!creds.isConfigured) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n\r\n        // Extract standard provider settings (apiKey, baseUrl, headers, fetch)\r\n        const {\r\n          apiKey: _apiKey,\r\n          baseUrl,\r\n          headers,\r\n          fetch: _fetch,\r\n          ...extraOptions\r\n        } = providerConfig;\r\n\r\n        // OpenRouter routing options that need to be nested under \"provider\" in API request\r\n        // See: https://openrouter.ai/docs/features/provider-routing\r\n        const OPENROUTER_ROUTING_OPTIONS = [\r\n          \"order\",\r\n          \"allow_fallbacks\",\r\n          \"only\",\r\n          \"ignore\",\r\n          \"require_parameters\",\r\n          \"data_collection\",\r\n          \"sort\",\r\n          \"quantizations\",\r\n        ];\r\n\r\n        // Build extraBody: routing options go under \"provider\", others stay at root\r\n        const routingOptions: Record<string, unknown> = {};\r\n        const otherOptions: Record<string, unknown> = {};\r\n\r\n        for (const [key, value] of Object.entries(extraOptions)) {\r\n          if (OPENROUTER_ROUTING_OPTIONS.includes(key)) {\r\n            routingOptions[key] = value;\r\n          } else {\r\n            otherOptions[key] = value;\r\n          }\r\n        }\r\n\r\n        // Build extraBody with provider nesting if routing options exist\r\n        let extraBody: Record<string, unknown> | undefined;\r\n        if (Object.keys(routingOptions).length > 0) {\r\n          extraBody = { provider: routingOptions, ...otherOptions };\r\n        } else if (Object.keys(otherOptions).length > 0) {\r\n          extraBody = otherOptions;\r\n        }\r\n\r\n        // Lazy-load OpenRouter provider to reduce startup time\r\n        const { createOpenRouter } = await PROVIDER_REGISTRY.openrouter();\r\n        const provider = createOpenRouter({\r\n          apiKey: creds.apiKey,\r\n          baseURL: creds.baseUrl ?? baseUrl,\r\n          headers,\r\n          fetch: baseFetch,\r\n          extraBody,\r\n        });\r\n        return Ok(provider(modelId));\r\n      }\r\n\r\n      // Handle Amazon Bedrock provider\r\n      if (providerName === \"bedrock\") {\r\n        // Resolve region from config + env (single source of truth)\r\n        const creds = resolveProviderCredentials(\"bedrock\", providerConfig);\r\n        if (!creds.isConfigured || !creds.region) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n        const { region } = creds;\r\n\r\n        // Optional AWS shared config profile name (equivalent to AWS_PROFILE).\r\n        // Useful for SSO profiles when Mux isn't launched with AWS_PROFILE set.\r\n        const profile =\r\n          typeof providerConfig.profile === \"string\" && providerConfig.profile.trim()\r\n            ? providerConfig.profile.trim()\r\n            : undefined;\r\n\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n        const { createAmazonBedrock } = await PROVIDER_REGISTRY.bedrock();\r\n\r\n        // Check if explicit credentials are provided in config\r\n        const hasExplicitCredentials = providerConfig.accessKeyId && providerConfig.secretAccessKey;\r\n\r\n        if (hasExplicitCredentials) {\r\n          // Use explicit credentials from providers.jsonc\r\n          const provider = createAmazonBedrock({\r\n            ...providerConfig,\r\n            region,\r\n            fetch: baseFetch,\r\n          });\r\n          return Ok(provider(modelId));\r\n        }\r\n\r\n        // Check for Bedrock bearer token (simplest auth) - from config or environment\r\n        // The SDK's apiKey option maps to AWS_BEARER_TOKEN_BEDROCK\r\n        const bearerToken =\r\n          typeof providerConfig.bearerToken === \"string\" ? providerConfig.bearerToken : undefined;\r\n\r\n        if (bearerToken) {\r\n          const provider = createAmazonBedrock({\r\n            region,\r\n            apiKey: bearerToken,\r\n            fetch: baseFetch,\r\n          });\r\n          return Ok(provider(modelId));\r\n        }\r\n\r\n        // Check if AWS_BEARER_TOKEN_BEDROCK env var is set\r\n        if (process.env.AWS_BEARER_TOKEN_BEDROCK) {\r\n          // SDK automatically picks this up via apiKey option\r\n          const provider = createAmazonBedrock({\r\n            region,\r\n            fetch: baseFetch,\r\n          });\r\n          return Ok(provider(modelId));\r\n        }\r\n\r\n        // Use AWS credential provider chain for flexible authentication:\r\n        // - Environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)\r\n        // - Shared credentials file (~/.aws/credentials)\r\n        // - EC2 instance profiles\r\n        // - ECS task roles\r\n        // - EKS service account (IRSA)\r\n        // - SSO credentials\r\n        // - And more...\r\n        const provider = createAmazonBedrock({\r\n          region,\r\n          credentialProvider: fromNodeProviderChain(profile ? { profile } : {}),\r\n          fetch: baseFetch,\r\n        });\r\n        return Ok(provider(modelId));\r\n      }\r\n\r\n      // Handle Mux Gateway provider\r\n      if (providerName === \"mux-gateway\") {\r\n        // Resolve couponCode from config (single source of truth)\r\n        const creds = resolveProviderCredentials(\"mux-gateway\", providerConfig);\r\n        if (!creds.isConfigured || !creds.couponCode) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n        const { couponCode } = creds;\r\n\r\n        const { createGateway } = await PROVIDER_REGISTRY[\"mux-gateway\"]();\r\n        // For Anthropic models via gateway, wrap fetch to inject cache_control on tools\r\n        // (gateway provider doesn't process providerOptions.anthropic.cacheControl)\r\n        // Use getProviderFetch to preserve any user-configured custom fetch (e.g., proxies)\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n        const isAnthropicModel = modelId.startsWith(\"anthropic/\");\r\n        const fetchWithCacheControl = isAnthropicModel\r\n          ? wrapFetchWithAnthropicCacheControl(baseFetch)\r\n          : baseFetch;\r\n        const fetchWithAutoLogout = wrapFetchWithMuxGatewayAutoLogout(\r\n          fetchWithCacheControl,\r\n          this.providerService\r\n        );\r\n        // Use configured baseURL or fall back to default gateway URL\r\n        const gatewayBaseURL =\r\n          providerConfig.baseURL ?? \"https://gateway.mux.coder.com/api/v1/ai-gateway/v1/ai\";\r\n        const gateway = createGateway({\r\n          apiKey: couponCode,\r\n          baseURL: gatewayBaseURL,\r\n          fetch: fetchWithAutoLogout,\r\n        });\r\n        const model = gateway(modelId);\r\n\r\n        // Normalize usage format from the gateway server.\r\n        // The gateway SDK declares specificationVersion \"v3\", so the AI SDK core\r\n        // expects nested v3 usage: { inputTokens: { total, ... }, outputTokens: { total, ... } }.\r\n        // However the gateway server may return flat v2-style usage\r\n        // (e.g. { inputTokens: 123, outputTokens: 456 }), causing\r\n        // asLanguageModelUsage to produce undefined  0 for all token counts.\r\n        // These wrappers detect flat usage and convert to v3 nested format.\r\n        const originalDoStream = model.doStream.bind(model);\r\n        model.doStream = async (options) => {\r\n          const result = await originalDoStream(options);\r\n          return {\r\n            ...result,\r\n            // Type assertion safe: the transform only modifies the shape of usage/finishReason\r\n            // fields within existing chunks, it doesn't change the stream part types.\r\n            stream: result.stream.pipeThrough(\r\n              normalizeGatewayStreamUsage()\r\n            ) as typeof result.stream,\r\n          };\r\n        };\r\n\r\n        const originalDoGenerate = model.doGenerate.bind(model);\r\n        model.doGenerate = async (options) => {\r\n          const result = await originalDoGenerate(options);\r\n          return normalizeGatewayGenerateResult(result);\r\n        };\r\n\r\n        return Ok(model);\r\n      }\r\n\r\n      // GitHub Copilot  OpenAI-compatible with custom auth headers\r\n      if (providerName === \"github-copilot\") {\r\n        const creds = resolveProviderCredentials(\"github-copilot\" as ProviderName, providerConfig);\r\n        if (!creds.isConfigured) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n\r\n        const { createOpenAICompatible } = await PROVIDER_REGISTRY[\"github-copilot\"]();\r\n\r\n        const baseFetch = getProviderFetch(providerConfig);\r\n        const copilotFetchFn = async (\r\n          input: Parameters<typeof fetch>[0],\r\n          init?: Parameters<typeof fetch>[1]\r\n        ) => {\r\n          const headers = new Headers(init?.headers);\r\n          headers.set(\"Authorization\", `Bearer ${creds.apiKey ?? \"\"}`);\r\n          headers.set(\"Openai-Intent\", \"conversation-edits\");\r\n          headers.delete(\"x-api-key\");\r\n          return baseFetch(input, { ...init, headers });\r\n        };\r\n        const copilotFetch = Object.assign(copilotFetchFn, baseFetch) as typeof fetch;\r\n\r\n        const baseURL = providerConfig.baseURL ?? \"https://api.githubcopilot.com\";\r\n        const provider = createOpenAICompatible({\r\n          name: \"github-copilot\",\r\n          baseURL,\r\n          apiKey: \"copilot\", // placeholder  actual auth via custom fetch\r\n          fetch: copilotFetch,\r\n        });\r\n        return Ok(provider.chatModel(modelId));\r\n      }\r\n\r\n      // Generic handler for simple providers (standard API key + factory pattern)\r\n      // Providers with custom logic (anthropic, openai, xai, ollama, openrouter, bedrock, mux-gateway,\r\n      // github-copilot) are handled explicitly above. New providers using the standard pattern need\r\n      // only be added to PROVIDER_DEFINITIONS - no code changes required here.\r\n      const providerDef = PROVIDER_DEFINITIONS[providerName as ProviderName];\r\n      if (providerDef) {\r\n        // Resolve credentials from config + env (single source of truth)\r\n        const creds = resolveProviderCredentials(providerName as ProviderName, providerConfig);\r\n        if (providerDef.requiresApiKey && !creds.isConfigured) {\r\n          return Err({ type: \"api_key_not_found\", provider: providerName });\r\n        }\r\n\r\n        // Lazy-load and create provider using factoryName from definition\r\n        const providerModule = (await providerDef.import()) as unknown as Record<\r\n          string,\r\n          (config: Record<string, unknown>) => (modelId: string) => LanguageModel\r\n        >;\r\n        const factory = providerModule[providerDef.factoryName];\r\n        if (!factory) {\r\n          return Err({\r\n            type: \"provider_not_supported\",\r\n            provider: providerName,\r\n          });\r\n        }\r\n\r\n        // Merge resolved credentials into config\r\n        const configWithCreds = {\r\n          ...providerConfig,\r\n          ...(creds.apiKey && { apiKey: creds.apiKey }),\r\n          ...(creds.baseUrl && !providerConfig.baseURL && { baseURL: creds.baseUrl }),\r\n        };\r\n\r\n        const provider = factory({\r\n          ...configWithCreds,\r\n          fetch: getProviderFetch(providerConfig),\r\n        });\r\n        return Ok(provider(modelId));\r\n      }\r\n\r\n      return Err({\r\n        type: \"provider_not_supported\",\r\n        provider: providerName,\r\n      });\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      return Err({ type: \"unknown\", raw: `Failed to create model: ${errorMessage}` });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resolve model string (xAI variant mapping + gateway routing) and create the model.\r\n   *\r\n   * Combines the xAI thinking-level variant swap, gateway resolution, and model\r\n   * creation into a single call. Previously this logic was inlined in\r\n   * `AIService.streamMessage()`.\r\n   *\r\n   * @returns On success: the created model + resolution metadata.\r\n   */\r\n  async resolveAndCreateModel(\r\n    modelString: string,\r\n    thinkingLevel: ThinkingLevel,\r\n    muxProviderOptions?: MuxProviderOptions\r\n  ): Promise<\r\n    Result<\r\n      {\r\n        model: LanguageModel;\r\n        /** Model string after gateway routing (may have `mux-gateway:` prefix). */\r\n        effectiveModelString: string;\r\n        /** Model string with gateway prefix stripped (canonical provider:model). */\r\n        canonicalModelString: string;\r\n        /** Provider name from the canonical model string. */\r\n        canonicalProviderName: string;\r\n        /** Model ID from the canonical model string. */\r\n        canonicalModelId: string;\r\n        /** Whether the request is being routed through the Mux gateway. */\r\n        routedThroughGateway: boolean;\r\n      },\r\n      SendMessageError\r\n    >\r\n  > {\r\n    const explicitlyRequestedGateway = modelString.trim().startsWith(\"mux-gateway:\");\r\n    const canonicalModelString = normalizeGatewayModel(modelString);\r\n    let effectiveModelString = canonicalModelString;\r\n    const [canonicalProviderName, canonicalModelId] = parseModelString(canonicalModelString);\r\n\r\n    // xAI Grok: swap between reasoning and non-reasoning variants based on thinking level.\r\n    // xAI only supports full reasoning (no medium/low).\r\n    if (canonicalProviderName === \"xai\" && canonicalModelId === \"grok-4-1-fast\") {\r\n      const variant =\r\n        thinkingLevel !== \"off\" ? \"grok-4-1-fast-reasoning\" : \"grok-4-1-fast-non-reasoning\";\r\n      effectiveModelString = `xai:${variant}`;\r\n    }\r\n\r\n    effectiveModelString = this.resolveGatewayModelString(\r\n      effectiveModelString,\r\n      canonicalModelString,\r\n      explicitlyRequestedGateway\r\n    );\r\n\r\n    const routedThroughGateway = effectiveModelString.startsWith(\"mux-gateway:\");\r\n    const modelResult = await this.createModel(effectiveModelString, muxProviderOptions);\r\n    if (!modelResult.success) {\r\n      return Err(modelResult.error);\r\n    }\r\n\r\n    return Ok({\r\n      model: modelResult.data,\r\n      effectiveModelString,\r\n      canonicalModelString,\r\n      canonicalProviderName,\r\n      canonicalModelId,\r\n      routedThroughGateway,\r\n    });\r\n  }\r\n  resolveGatewayModelString(\r\n    modelString: string,\r\n    modelKey?: string,\r\n    explicitlyRequestedGateway = false\r\n  ): string {\r\n    // Backend-authoritative routing avoids frontend localStorage races (issue #1769).\r\n    const canonicalModelString = normalizeGatewayModel(modelString);\r\n    const normalizedModelKey = modelKey ? normalizeGatewayModel(modelKey) : canonicalModelString;\r\n    const [providerName, modelId] = parseModelString(canonicalModelString);\r\n\r\n    if (!providerName || !modelId) {\r\n      return canonicalModelString;\r\n    }\r\n\r\n    if (providerName === \"mux-gateway\" || !(providerName in PROVIDER_REGISTRY)) {\r\n      return canonicalModelString;\r\n    }\r\n\r\n    const typedProvider = providerName as ProviderName;\r\n    if (!MUX_GATEWAY_SUPPORTED_PROVIDERS.has(typedProvider)) {\r\n      return canonicalModelString;\r\n    }\r\n\r\n    const config = this.config.loadConfigOrDefault();\r\n    const gatewayEnabled = config.muxGatewayEnabled !== false;\r\n    const gatewayModels = config.muxGatewayModels ?? [];\r\n    // Legacy clients may still send mux-gateway model IDs before the backend config\r\n    // has synchronized their allowlist, so honor an explicit mux-gateway prefix as\r\n    // an implicit opt-in to avoid first-message API key failures.\r\n    const isGatewayModelEnabled =\r\n      explicitlyRequestedGateway ||\r\n      gatewayModels.includes(canonicalModelString) ||\r\n      gatewayModels.includes(normalizedModelKey);\r\n\r\n    if (!gatewayEnabled || !isGatewayModelEnabled) {\r\n      return canonicalModelString;\r\n    }\r\n\r\n    const providersConfig = this.config.loadProvidersConfig() ?? {};\r\n    const gatewayConfig = providersConfig[\"mux-gateway\"] ?? {};\r\n    const gatewayConfigured = resolveProviderCredentials(\"mux-gateway\", gatewayConfig).isConfigured;\r\n\r\n    if (!gatewayConfigured) {\r\n      return canonicalModelString;\r\n    }\r\n\r\n    return `mux-gateway:${providerName}/${modelId}`;\r\n  }\r\n}\r\n"]}