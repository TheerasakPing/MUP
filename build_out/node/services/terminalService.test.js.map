{"version":3,"file":"terminalService.test.js","sourceRoot":"","sources":["../../../src/node/services/terminalService.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAA+F;AAC/F,uDAAoD;AAKpD,MAAY,YAAY,0CAAsB;AAC9C,MAAY,EAAE,wCAAoB;AAElC,oBAAoB;AACpB,MAAM,UAAU,GAAG;IACjB,uBAAuB,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CACjC,OAAO,CAAC,OAAO,CAAC;QACd;YACE,EAAE,EAAE,MAAM;YACV,WAAW,EAAE,cAAc;YAC3B,IAAI,EAAE,MAAM;YACZ,aAAa,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,UAAU,EAAE,MAAM,EAAE;SACrD;KACF,CAAC,CACH;IACD,MAAM,EAAE,MAAM;CACM,CAAC;AAEvB,MAAM,iBAAiB,GAAG,IAAA,eAAI,EAC5B,CACE,MAA4B,EAC5B,QAAiB,EACjB,KAAa,EACb,MAA2B,EAC3B,OAA+B,EAC/B,EAAE,CAAC;IACH,qDAAqD;IACrD,MAAM,CAAC,cAAc,CAAC,CAAC;IACvB,OAAO,OAAO,CAAC,OAAO,CAAC;QACrB,SAAS,EAAE,WAAW;QACtB,WAAW,EAAE,MAAM,CAAC,WAAW;QAC/B,IAAI,EAAE,EAAE;QACR,IAAI,EAAE,EAAE;KACT,CAAC,CAAC;AAAA,CACJ,CACF,CAAC;AAEF,MAAM,UAAU,GAAG,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC;IAC5B,WAAW;AADkB,CAE9B,CAAC,CAAC;AACH,MAAM,aAAa,GAAG,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC;IAC/B,WAAW;AADqB,CAEjC,CAAC,CAAC;AACH,MAAM,gBAAgB,GAAG,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC;IAClC,WAAW;AADwB,CAEpC,CAAC,CAAC;AAEH,MAAM,cAAc,GAAG;IACrB,aAAa,EAAE,iBAAiB;IAChC,YAAY,EAAE,gBAAgB;IAC9B,MAAM,EAAE,UAAU;IAClB,SAAS,EAAE,aAAa;CACA,CAAC;AAE3B,MAAM,sBAAsB,GAAG,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC;AAC7D,MAAM,uBAAuB,GAAG,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC;IACzC,WAAW;AAD+B,CAE3C,CAAC,CAAC;AAEH,MAAM,iBAAiB,GAAG;IACxB,kBAAkB,EAAE,sBAAsB;IAC1C,mBAAmB,EAAE,uBAAuB;CACT,CAAC;AAEtC,IAAA,mBAAQ,EAAC,iBAAiB,EAAE,GAAG,EAAE,CAAC;IAChC,IAAI,OAAwB,CAAC;IAE7B,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;QACf,OAAO,GAAG,IAAI,iCAAe,CAAC,UAAU,EAAE,cAAc,CAAC,CAAC;QAC1D,OAAO,CAAC,wBAAwB,CAAC,iBAAiB,CAAC,CAAC;QACpD,iBAAiB,CAAC,SAAS,EAAE,CAAC;QAC9B,UAAU,CAAC,SAAS,EAAE,CAAC;QACvB,aAAa,CAAC,SAAS,EAAE,CAAC;QAC1B,sBAAsB,CAAC,SAAS,EAAE,CAAC;IAAA,CACpC,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,yBAAyB,EAAE,KAAK,IAAI,EAAE,CAAC;QACxC,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,MAAM,CAAC;YACnC,WAAW,EAAE,MAAM;YACnB,IAAI,EAAE,EAAE;YACR,IAAI,EAAE,EAAE;SACT,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,OAAO,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAC5C,IAAA,iBAAM,EAAC,OAAO,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACzC,IAAA,iBAAM,EAAC,iBAAiB,CAAC,CAAC,gBAAgB,EAAE,CAAC;IAAA,CAC9C,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,wBAAwB,EAAE,GAAG,EAAE,CAAC;QACjC,OAAO,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,WAAW,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC;QAChE,IAAA,iBAAM,EAAC,UAAU,CAAC,CAAC,oBAAoB,CAAC;YACtC,SAAS,EAAE,WAAW;YACtB,IAAI,EAAE,GAAG;YACT,IAAI,EAAE,EAAE;SACT,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE,CAAC;QACtE,IAAI,cAAoD,CAAC;QAEzD,0CAA0C;QAC1C,8DAA8D;QAC7D,cAAc,CAAC,aAAqB,GAAG,IAAA,eAAI,EAC1C,CACE,MAA4B,EAC5B,QAAiB,EACjB,KAAa,EACb,MAA2B,EAC3B,OAA+B,EAC/B,EAAE,CAAC;YACH,cAAc,GAAG,MAAM,CAAC;YACxB,OAAO,OAAO,CAAC,OAAO,CAAC;gBACrB,SAAS,EAAE,aAAa;gBACxB,WAAW,EAAE,MAAM,CAAC,WAAW;gBAC/B,IAAI,EAAE,MAAM,CAAC,IAAI;gBACjB,IAAI,EAAE,MAAM,CAAC,IAAI;aAClB,CAAC,CAAC;QAAA,CACJ,CACF,CAAC;QAEF,MAAM,OAAO,CAAC,MAAM,CAAC,EAAE,WAAW,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC;QAElE,IAAI,CAAC,cAAc,EAAE,CAAC;YACpB,MAAM,IAAI,KAAK,CAAC,mDAAmD,CAAC,CAAC;QACvE,CAAC;QAED,0EAA0E;QAC1E,cAAc,CAAC,SAAS,CAAC,CAAC;QAE1B,kDAAkD;QAClD,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,CAAC;QAExD,IAAA,iBAAM,EAAC,aAAa,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAEzC,MAAM,KAAK,GAAG,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC;QACvC,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACvB,MAAM,IAAI,KAAK,CAAC,mDAAmD,CAAC,CAAC;QACvE,CAAC;QAED,MAAM,CAAC,eAAe,EAAE,QAAQ,CAAC,GAAG,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAgC,CAAC;QAC3F,IAAA,iBAAM,EAAC,eAAe,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;QAC5C,IAAA,iBAAM,EAAC,QAAQ,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACjD,IAAA,iBAAM,EAAC,QAAQ,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAE1C,+DAA+D;QAC/D,8DAA8D;QAC7D,cAAc,CAAC,aAAqB,GAAG,iBAAiB,CAAC;IAAA,CAC3D,CAAC,CAAC;IACH,IAAA,aAAE,EAAC,qBAAqB,EAAE,GAAG,EAAE,CAAC;QAC9B,OAAO,CAAC,SAAS,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC;QACvC,IAAA,iBAAM,EAAC,aAAa,CAAC,CAAC,oBAAoB,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC;IAAA,CACjE,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,yCAAyC,EAAE,KAAK,IAAI,EAAE,CAAC;QACxD,MAAM,OAAO,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACjC,sFAAsF;QACtF,IAAA,iBAAM,EAAC,sBAAsB,CAAC,CAAC,oBAAoB,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;IAAA,CACxE,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,4BAA4B,EAAE,KAAK,IAAI,EAAE,CAAC;QAC3C,iEAAiE;QACjE,IAAI,cAAoD,CAAC;QAEzD,0CAA0C;QAC1C,8DAA8D;QAC7D,cAAc,CAAC,aAAqB,GAAG,IAAA,eAAI,EAC1C,CACE,MAA4B,EAC5B,QAAiB,EACjB,KAAa,EACb,OAAgB,EAChB,MAA8B,EAC9B,EAAE,CAAC;YACH,cAAc,GAAG,MAAM,CAAC;YACxB,OAAO,OAAO,CAAC,OAAO,CAAC;gBACrB,SAAS,EAAE,WAAW;gBACtB,WAAW,EAAE,MAAM,CAAC,WAAW;gBAC/B,IAAI,EAAE,EAAE;gBACR,IAAI,EAAE,EAAE;aACT,CAAC,CAAC;QAAA,CACJ,CACF,CAAC;QAEF,MAAM,OAAO,CAAC,MAAM,CAAC,EAAE,WAAW,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC;QAElE,IAAI,QAAQ,GAAkB,IAAI,CAAC;QACnC,OAAO,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC;YACpC,QAAQ,GAAG,IAAI,CAAC;QAAA,CACjB,CAAC,CAAC;QAEH,gBAAgB;QAChB,IAAI,cAAc;YAAE,cAAc,CAAC,CAAC,CAAC,CAAC;QAEtC,IAAA,iBAAM,EAAC,QAA6B,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAE9C,iGAAiG;QACjG,+BAA+B;QAC/B,8HAA8H;QAC9H,oDAAoD;QACpD,8CAA8C;QAC9C,8DAA8D;QAC7D,cAAc,CAAC,aAAqB,GAAG,iBAAiB,CAAC;IAAA,CAC3D,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC;AAEH,IAAA,mBAAQ,EAAC,4BAA4B,EAAE,GAAG,EAAE,CAAC;IAC3C,IAAI,OAAwB,CAAC;IAC7B,oEAAoE;IACpE,8DAA8D;IAC9D,IAAI,QAAmB,CAAC;IACxB,8DAA8D;IAC9D,IAAI,YAAuB,CAAC;IAC5B,8DAA8D;IAC9D,IAAI,SAAoB,CAAC;IACzB,IAAI,gBAAiC,CAAC;IAEtC,wCAAwC;IACxC,MAAM,sBAAsB,GAAG,GAAG,EAAE,CAClC,CAAC;QACC,KAAK,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,SAAS,CAAC;QAC5B,EAAE,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,SAAS,CAAC;QACzB,GAAG,EAAE,KAAK;KACX,CAAqD,CAAC;IAEzD,8BAA8B;IAC9B,MAAM,wBAAwB,GAAG;QAC/B,uBAAuB,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CACjC,OAAO,CAAC,OAAO,CAAC;YACd;gBACE,EAAE,EAAE,UAAU;gBACd,WAAW,EAAE,cAAc;gBAC3B,IAAI,EAAE,MAAM;gBACZ,kBAAkB,EAAE,mBAAmB;gBACvC,aAAa,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,UAAU,EAAE,MAAM,EAAE;aACrD;SACF,CAAC,CACH;QACD,MAAM,EAAE,MAAM;KACM,CAAC;IAEvB,4BAA4B;IAC5B,MAAM,sBAAsB,GAAG;QAC7B,uBAAuB,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CACjC,OAAO,CAAC,OAAO,CAAC;YACd;gBACE,EAAE,EAAE,QAAQ;gBACZ,WAAW,EAAE,oBAAoB;gBACjC,IAAI,EAAE,SAAS;gBACf,kBAAkB,EAAE,4BAA4B;gBAChD,aAAa,EAAE;oBACb,IAAI,EAAE,KAAK;oBACX,IAAI,EAAE,oBAAoB;oBAC1B,IAAI,EAAE,IAAI;oBACV,YAAY,EAAE,eAAe;iBAC9B;aACF;SACF,CAAC,CACH;QACD,MAAM,EAAE,MAAM;KACM,CAAC;IAEvB,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;QACf,0BAA0B;QAC1B,gBAAgB,GAAG,OAAO,CAAC,QAAQ,CAAC;QAEpC,oEAAoE;QACpE,4DAA4D;QAC5D,QAAQ,GAAG,IAAA,gBAAK,EAAC,YAAY,EAAE,OAAO,CAAC,CAAC,kBAAkB,CAAC,CAAC,GAAG,EAAE,CAC/D,sBAAsB,EAAE,CAAyC,CAAC,CAAC;QAErE,mDAAmD;QACnD,YAAY,GAAG,IAAA,gBAAK,EAAC,YAAY,EAAE,WAAW,CAAC,CAAC,kBAAkB,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC;YACzE,MAAM,EAAE,CAAC;YACT,MAAM,EAAE,CAAC,IAAI,EAAE,cAAc,CAAC;SAC/B,CAAC,CAA6C,CAAC,CAAC;QAEjD,6DAA6D;QAC7D,SAAS,GAAG,IAAA,gBAAK,EAAC,EAAE,EAAE,MAAM,CAAC,CAAC,kBAAkB,CAAC,CAAC,GAAG,EAAE,CACrD,OAAO,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,QAAQ,CAAC,CAAC,CAA8B,CAAC,CAAC;IAAA,CACtE,CAAC,CAAC;IAEH,IAAA,oBAAS,EAAC,GAAG,EAAE,CAAC;QACd,4BAA4B;QAC5B,MAAM,CAAC,cAAc,CAAC,OAAO,EAAE,UAAU,EAAE,EAAE,KAAK,EAAE,gBAAgB,EAAE,CAAC,CAAC;QACxE,gBAAgB;QAChB,QAAQ,CAAC,WAAW,EAAE,CAAC;QACvB,YAAY,CAAC,WAAW,EAAE,CAAC;QAC3B,SAAS,CAAC,WAAW,EAAE,CAAC;IAAA,CACzB,CAAC,CAAC;IAEH;;OAEG;IACH,SAAS,WAAW,CAAC,QAAyB,EAAE;QAC9C,MAAM,CAAC,cAAc,CAAC,OAAO,EAAE,UAAU,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC;IAAA,CACjE;IAED,IAAA,mBAAQ,EAAC,gBAAgB,EAAE,GAAG,EAAE,CAAC;QAC/B,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;YACf,WAAW,CAAC,QAAQ,CAAC,CAAC;QAAA,CACvB,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,4EAA4E,EAAE,KAAK,IAAI,EAAE,CAAC;YAC3F,+DAA+D;YAC/D,YAAY,CAAC,kBAAkB,CAAC,CAAC,GAAW,EAAE,IAAc,EAAE,EAAE,CAAC;gBAC/D,IAAI,GAAG,KAAK,OAAO,IAAI,IAAI,EAAE,CAAC,CAAC,CAAC,KAAK,SAAS,EAAE,CAAC;oBAC/C,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,oBAAoB;gBAC5C,CAAC;gBACD,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,2BAA2B;YAA5B,CACtB,CAAC,CAAC;YAEH,OAAO,GAAG,IAAI,iCAAe,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YAExE,MAAM,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAErC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,+DAA+D;YAC/D,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC7B,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,UAAU,EAAE,mBAAmB,CAAC,CAAC,CAAC;YACjE,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACrC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAAA,CACvC,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE,CAAC;YACvE,2DAA2D;YAC3D,SAAS,CAAC,kBAAkB,CAAC,CAAC,IAAY,EAAE,EAAE,CAAC;gBAC7C,IAAI,IAAI,KAAK,kDAAkD,EAAE,CAAC;oBAChE,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC;gBAC9D,CAAC;gBACD,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC;YAAA,CAC5C,CAAC,CAAC;YAEH,OAAO,GAAG,IAAI,iCAAe,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YAExE,MAAM,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAErC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC7B,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;YACrC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,mBAAmB,CAAC,CAAC;QAAA,CAChD,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE,CAAC;YACzE,uBAAuB;YACvB,YAAY,CAAC,kBAAkB,CAAC,CAAC,GAAW,EAAE,IAAc,EAAE,EAAE,CAAC;gBAC/D,IAAI,GAAG,KAAK,OAAO,IAAI,IAAI,EAAE,CAAC,CAAC,CAAC,KAAK,SAAS,EAAE,CAAC;oBAC/C,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;gBACvB,CAAC;gBACD,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;YAAA,CACtB,CAAC,CAAC;YAEH,OAAO,GAAG,IAAI,iCAAe,CAAC,sBAAsB,EAAE,cAAc,CAAC,CAAC;YAEtE,MAAM,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;YAEnC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAClC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAChC,+DAA+D;YAC/D,MAAM,MAAM,GAAG,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YAC5B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC;YACxD,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,OAAO;YAC5C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,SAAS,CAAC,kBAAkB,CAAC,CAAC,CAAC,gBAAgB;YAC9D,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,SAAS,CAAC,oBAAoB,CAAC,CAAC,CAAC,OAAO;QAAR,CAChD,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,mBAAQ,EAAC,iBAAiB,EAAE,GAAG,EAAE,CAAC;QAChC,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;YACf,WAAW,CAAC,OAAO,CAAC,CAAC;QAAA,CACtB,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,qCAAqC,EAAE,KAAK,IAAI,EAAE,CAAC;YACpD,OAAO,GAAG,IAAI,iCAAe,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YAExE,MAAM,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAErC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAC5B,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,mBAAmB,CAAC,CAAC,CAAC;YACvF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAAA,CACnC,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE,CAAC;YAC3D,OAAO,GAAG,IAAI,iCAAe,CAAC,sBAAsB,EAAE,cAAc,CAAC,CAAC;YAEtE,MAAM,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;YAEnC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAC5B,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACnC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YACjC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YAClC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,oBAAoB,CAAC,CAAC;QAAA,CACjD,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,mBAAQ,EAAC,OAAO,EAAE,GAAG,EAAE,CAAC;QACtB,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;YACf,WAAW,CAAC,OAAO,CAAC,CAAC;QAAA,CACtB,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,sDAAsD,EAAE,KAAK,IAAI,EAAE,CAAC;YACrE,0CAA0C;YAC1C,YAAY,CAAC,kBAAkB,CAAC,CAAC,GAAW,EAAE,IAAc,EAAE,EAAE,CAAC;gBAC/D,IAAI,GAAG,KAAK,OAAO,EAAE,CAAC;oBACpB,MAAM,QAAQ,GAAG,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;oBAC3B,oEAAoE;oBACpE,uBAAuB;oBACvB,IAAI,QAAQ,KAAK,gBAAgB,EAAE,CAAC;wBAClC,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;oBACvB,CAAC;oBACD,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;gBACvB,CAAC;gBACD,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;YAAA,CACtB,CAAC,CAAC;YAEH,OAAO,GAAG,IAAI,iCAAe,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YAExE,MAAM,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAErC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YACvC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,qBAAqB,CAAC,CAAC;YACjD,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,mBAAmB,CAAC,CAAC;QAAA,CAChD,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE,CAAC;YACtE,0BAA0B;YAC1B,YAAY,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;YAEvD,OAAO,GAAG,IAAI,iCAAe,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YAExE,6DAA6D;YAC7D,MAAM,IAAA,iBAAM,EAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,4BAA4B,CAAC,CAAC;QAAA,CAC5F,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,oDAAoD,EAAE,KAAK,IAAI,EAAE,CAAC;YACnE,2BAA2B;YAC3B,YAAY,CAAC,kBAAkB,CAAC,CAAC,GAAW,EAAE,IAAc,EAAE,EAAE,CAAC;gBAC/D,IAAI,GAAG,KAAK,OAAO,IAAI,IAAI,EAAE,CAAC,CAAC,CAAC,KAAK,WAAW,EAAE,CAAC;oBACjD,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;gBACvB,CAAC;gBACD,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;YAAA,CACtB,CAAC,CAAC;YAEH,OAAO,GAAG,IAAI,iCAAe,CAAC,sBAAsB,EAAE,cAAc,CAAC,CAAC;YAEtE,MAAM,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;YAEnC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAkD,CAAC;YACrF,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAClC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YACjC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;QAAA,CACnC,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,mBAAQ,EAAC,gBAAgB,EAAE,GAAG,EAAE,CAAC;QAC/B,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;YACf,WAAW,CAAC,QAAQ,CAAC,CAAC;YACtB,YAAY,CAAC,kBAAkB,CAAC,GAAG,EAAE,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;QAAA,CACxD,CAAC,CAAC;QAEH,IAAA,aAAE,EAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE,CAAC;YAC9D,OAAO,GAAG,IAAI,iCAAe,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YAExE,6DAA6D;YAC7D,MAAM,IAAA,iBAAM,EAAC,OAAO,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAC9D,mCAAmC,CACpC,CAAC;QAAA,CACH,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, it, expect, mock, beforeEach, afterEach, spyOn, type Mock } from \"bun:test\";\nimport { TerminalService } from \"./terminalService\";\nimport type { PTYService } from \"./ptyService\";\nimport type { Config } from \"@/node/config\";\nimport type { TerminalWindowManager } from \"@/desktop/terminalWindowManager\";\nimport type { TerminalCreateParams } from \"@/common/types/terminal\";\nimport * as childProcess from \"child_process\";\nimport * as fs from \"fs/promises\";\n\n// Mock dependencies\nconst mockConfig = {\n  getAllWorkspaceMetadata: mock(() =>\n    Promise.resolve([\n      {\n        id: \"ws-1\",\n        projectPath: \"/tmp/project\",\n        name: \"main\",\n        runtimeConfig: { type: \"local\", srcBaseDir: \"/tmp\" },\n      },\n    ])\n  ),\n  srcDir: \"/tmp\",\n} as unknown as Config;\n\nconst createSessionMock = mock(\n  (\n    params: TerminalCreateParams,\n    _runtime: unknown,\n    _path: string,\n    onData: (d: string) => void,\n    _onExit: (code: number) => void\n  ) => {\n    // Simulate immediate data emission to test buffering\n    onData(\"initial data\");\n    return Promise.resolve({\n      sessionId: \"session-1\",\n      workspaceId: params.workspaceId,\n      cols: 80,\n      rows: 24,\n    });\n  }\n);\n\nconst resizeMock = mock(() => {\n  /* no-op */\n});\nconst sendInputMock = mock(() => {\n  /* no-op */\n});\nconst closeSessionMock = mock(() => {\n  /* no-op */\n});\n\nconst mockPTYService = {\n  createSession: createSessionMock,\n  closeSession: closeSessionMock,\n  resize: resizeMock,\n  sendInput: sendInputMock,\n} as unknown as PTYService;\n\nconst openTerminalWindowMock = mock(() => Promise.resolve());\nconst closeTerminalWindowMock = mock(() => {\n  /* no-op */\n});\n\nconst mockWindowManager = {\n  openTerminalWindow: openTerminalWindowMock,\n  closeTerminalWindow: closeTerminalWindowMock,\n} as unknown as TerminalWindowManager;\n\ndescribe(\"TerminalService\", () => {\n  let service: TerminalService;\n\n  beforeEach(() => {\n    service = new TerminalService(mockConfig, mockPTYService);\n    service.setTerminalWindowManager(mockWindowManager);\n    createSessionMock.mockClear();\n    resizeMock.mockClear();\n    sendInputMock.mockClear();\n    openTerminalWindowMock.mockClear();\n  });\n\n  it(\"should create a session\", async () => {\n    const session = await service.create({\n      workspaceId: \"ws-1\",\n      cols: 80,\n      rows: 24,\n    });\n\n    expect(session.sessionId).toBe(\"session-1\");\n    expect(session.workspaceId).toBe(\"ws-1\");\n    expect(createSessionMock).toHaveBeenCalled();\n  });\n\n  it(\"should handle resizing\", () => {\n    service.resize({ sessionId: \"session-1\", cols: 100, rows: 30 });\n    expect(resizeMock).toHaveBeenCalledWith({\n      sessionId: \"session-1\",\n      cols: 100,\n      rows: 30,\n    });\n  });\n\n  it(\"should respond to DA1 terminal queries on the backend\", async () => {\n    let capturedOnData: ((data: string) => void) | undefined;\n\n    // Override mock temporarily for this test\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (mockPTYService.createSession as any) = mock(\n      (\n        params: TerminalCreateParams,\n        _runtime: unknown,\n        _path: string,\n        onData: (d: string) => void,\n        _onExit: (code: number) => void\n      ) => {\n        capturedOnData = onData;\n        return Promise.resolve({\n          sessionId: \"session-da1\",\n          workspaceId: params.workspaceId,\n          cols: params.cols,\n          rows: params.rows,\n        });\n      }\n    );\n\n    await service.create({ workspaceId: \"ws-1\", cols: 80, rows: 24 });\n\n    if (!capturedOnData) {\n      throw new Error(\"Expected createSession to capture onData callback\");\n    }\n\n    // DA1 (Primary Device Attributes) query sent by many TUIs during startup.\n    capturedOnData(\"\\x1b[0c\");\n\n    // xterm/headless processes writes asynchronously.\n    await new Promise((resolve) => setTimeout(resolve, 10));\n\n    expect(sendInputMock).toHaveBeenCalled();\n\n    const calls = sendInputMock.mock.calls;\n    if (calls.length === 0) {\n      throw new Error(\"Expected sendInput to be called with DA1 response\");\n    }\n\n    const [calledSessionId, response] = calls[calls.length - 1] as unknown as [string, string];\n    expect(calledSessionId).toBe(\"session-da1\");\n    expect(response.startsWith(\"\\x1b[?\")).toBe(true);\n    expect(response.endsWith(\"c\")).toBe(true);\n\n    // Restore mock (since we replaced the reference on the object)\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (mockPTYService.createSession as any) = createSessionMock;\n  });\n  it(\"should handle input\", () => {\n    service.sendInput(\"session-1\", \"ls\\n\");\n    expect(sendInputMock).toHaveBeenCalledWith(\"session-1\", \"ls\\n\");\n  });\n\n  it(\"should open terminal window via manager\", async () => {\n    await service.openWindow(\"ws-1\");\n    // openWindow(workspaceId, sessionId?) passes sessionId as undefined when not provided\n    expect(openTerminalWindowMock).toHaveBeenCalledWith(\"ws-1\", undefined);\n  });\n\n  it(\"should handle session exit\", async () => {\n    // We need to capture the onExit callback passed to createSession\n    let capturedOnExit: ((code: number) => void) | undefined;\n\n    // Override mock temporarily for this test\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (mockPTYService.createSession as any) = mock(\n      (\n        params: TerminalCreateParams,\n        _runtime: unknown,\n        _path: string,\n        _onData: unknown,\n        onExit: (code: number) => void\n      ) => {\n        capturedOnExit = onExit;\n        return Promise.resolve({\n          sessionId: \"session-2\",\n          workspaceId: params.workspaceId,\n          cols: 80,\n          rows: 24,\n        });\n      }\n    );\n\n    await service.create({ workspaceId: \"ws-1\", cols: 80, rows: 24 });\n\n    let exitCode: number | null = null;\n    service.onExit(\"session-2\", (code) => {\n      exitCode = code;\n    });\n\n    // Simulate exit\n    if (capturedOnExit) capturedOnExit(0);\n\n    expect(exitCode as unknown as number).toBe(0);\n\n    // Restore mock (optional if beforeEach resets, but we are replacing the reference on the object)\n    // Actually best to restore it.\n    // However, since we defined mockPTYService as a const object, we can't easily replace properties safely if they are readonly.\n    // But they are not readonly in the mock definition.\n    // Let's just restore it to createSessionMock.\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (mockPTYService.createSession as any) = createSessionMock;\n  });\n});\n\ndescribe(\"TerminalService.openNative\", () => {\n  let service: TerminalService;\n  // Using simplified mock types since spawnSync has complex overloads\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let spawnSpy: Mock<any>;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let spawnSyncSpy: Mock<any>;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let fsStatSpy: Mock<any>;\n  let originalPlatform: NodeJS.Platform;\n\n  // Helper to create a mock child process\n  const createMockChildProcess = () =>\n    ({\n      unref: mock(() => undefined),\n      on: mock(() => undefined),\n      pid: 12345,\n    }) as unknown as ReturnType<typeof childProcess.spawn>;\n\n  // Config with local workspace\n  const configWithLocalWorkspace = {\n    getAllWorkspaceMetadata: mock(() =>\n      Promise.resolve([\n        {\n          id: \"ws-local\",\n          projectPath: \"/tmp/project\",\n          name: \"main\",\n          namedWorkspacePath: \"/tmp/project/main\",\n          runtimeConfig: { type: \"local\", srcBaseDir: \"/tmp\" },\n        },\n      ])\n    ),\n    srcDir: \"/tmp\",\n  } as unknown as Config;\n\n  // Config with SSH workspace\n  const configWithSSHWorkspace = {\n    getAllWorkspaceMetadata: mock(() =>\n      Promise.resolve([\n        {\n          id: \"ws-ssh\",\n          projectPath: \"/home/user/project\",\n          name: \"feature\",\n          namedWorkspacePath: \"/home/user/project/feature\",\n          runtimeConfig: {\n            type: \"ssh\",\n            host: \"remote.example.com\",\n            port: 2222,\n            identityFile: \"~/.ssh/id_rsa\",\n          },\n        },\n      ])\n    ),\n    srcDir: \"/tmp\",\n  } as unknown as Config;\n\n  beforeEach(() => {\n    // Store original platform\n    originalPlatform = process.platform;\n\n    // Spy on spawn to capture calls without actually spawning processes\n    // Using `as unknown as` to bypass complex overload matching\n    spawnSpy = spyOn(childProcess, \"spawn\").mockImplementation((() =>\n      createMockChildProcess()) as unknown as typeof childProcess.spawn);\n\n    // Spy on spawnSync for command availability checks\n    spawnSyncSpy = spyOn(childProcess, \"spawnSync\").mockImplementation((() => ({\n      status: 0,\n      output: [null, \"/usr/bin/cmd\"],\n    })) as unknown as typeof childProcess.spawnSync);\n\n    // Spy on fs.stat to reject (no ghostty installed by default)\n    fsStatSpy = spyOn(fs, \"stat\").mockImplementation((() =>\n      Promise.reject(new Error(\"ENOENT\"))) as unknown as typeof fs.stat);\n  });\n\n  afterEach(() => {\n    // Restore original platform\n    Object.defineProperty(process, \"platform\", { value: originalPlatform });\n    // Restore spies\n    spawnSpy.mockRestore();\n    spawnSyncSpy.mockRestore();\n    fsStatSpy.mockRestore();\n  });\n\n  /**\n   * Helper to set the platform for testing\n   */\n  function setPlatform(platform: NodeJS.Platform) {\n    Object.defineProperty(process, \"platform\", { value: platform });\n  }\n\n  describe(\"macOS (darwin)\", () => {\n    beforeEach(() => {\n      setPlatform(\"darwin\");\n    });\n\n    it(\"should open Terminal.app for local workspace when ghostty is not available\", async () => {\n      // spawnSync returns non-zero for ghostty check (not available)\n      spawnSyncSpy.mockImplementation((cmd: string, args: string[]) => {\n        if (cmd === \"which\" && args?.[0] === \"ghostty\") {\n          return { status: 1 }; // ghostty not found\n        }\n        return { status: 0 }; // other commands available\n      });\n\n      service = new TerminalService(configWithLocalWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-local\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      // Type assertion for spawn call args: [command, args, options]\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"open\");\n      expect(call[1]).toEqual([\"-a\", \"Terminal\", \"/tmp/project/main\"]);\n      expect(call[2]?.detached).toBe(true);\n      expect(call[2]?.stdio).toBe(\"ignore\");\n    });\n\n    it(\"should open Ghostty for local workspace when available\", async () => {\n      // Make ghostty available via fs.stat (common install path)\n      fsStatSpy.mockImplementation((path: string) => {\n        if (path === \"/Applications/Ghostty.app/Contents/MacOS/ghostty\") {\n          return Promise.resolve({ isFile: () => true, mode: 0o755 });\n        }\n        return Promise.reject(new Error(\"ENOENT\"));\n      });\n\n      service = new TerminalService(configWithLocalWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-local\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"open\");\n      expect(call[1]).toContain(\"-a\");\n      expect(call[1]).toContain(\"Ghostty\");\n      expect(call[1]).toContain(\"/tmp/project/main\");\n    });\n\n    it(\"should use osascript for SSH workspace with Terminal.app\", async () => {\n      // No ghostty available\n      spawnSyncSpy.mockImplementation((cmd: string, args: string[]) => {\n        if (cmd === \"which\" && args?.[0] === \"ghostty\") {\n          return { status: 1 };\n        }\n        return { status: 0 };\n      });\n\n      service = new TerminalService(configWithSSHWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-ssh\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"osascript\");\n      expect(call[1]?.[0]).toBe(\"-e\");\n      // Verify the AppleScript contains SSH command with proper args\n      const script = call[1]?.[1];\n      expect(script).toContain('tell application \"Terminal\"');\n      expect(script).toContain(\"ssh\");\n      expect(script).toContain(\"-p 2222\"); // port\n      expect(script).toContain(\"-i ~/.ssh/id_rsa\"); // identity file\n      expect(script).toContain(\"remote.example.com\"); // host\n    });\n  });\n\n  describe(\"Windows (win32)\", () => {\n    beforeEach(() => {\n      setPlatform(\"win32\");\n    });\n\n    it(\"should open cmd for local workspace\", async () => {\n      service = new TerminalService(configWithLocalWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-local\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"cmd\");\n      expect(call[1]).toEqual([\"/c\", \"start\", \"cmd\", \"/K\", \"cd\", \"/D\", \"/tmp/project/main\"]);\n      expect(call[2]?.shell).toBe(true);\n    });\n\n    it(\"should open cmd with SSH for SSH workspace\", async () => {\n      service = new TerminalService(configWithSSHWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-ssh\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"cmd\");\n      expect(call[1]?.[0]).toBe(\"/c\");\n      expect(call[1]?.[1]).toBe(\"start\");\n      expect(call[1]).toContain(\"ssh\");\n      expect(call[1]).toContain(\"-p\");\n      expect(call[1]).toContain(\"2222\");\n      expect(call[1]).toContain(\"remote.example.com\");\n    });\n  });\n\n  describe(\"Linux\", () => {\n    beforeEach(() => {\n      setPlatform(\"linux\");\n    });\n\n    it(\"should try terminal emulators in order of preference\", async () => {\n      // Make gnome-terminal the first available\n      spawnSyncSpy.mockImplementation((cmd: string, args: string[]) => {\n        if (cmd === \"which\") {\n          const terminal = args?.[0];\n          // x-terminal-emulator, ghostty, alacritty, kitty, wezterm not found\n          // gnome-terminal found\n          if (terminal === \"gnome-terminal\") {\n            return { status: 0 };\n          }\n          return { status: 1 };\n        }\n        return { status: 0 };\n      });\n\n      service = new TerminalService(configWithLocalWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-local\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"gnome-terminal\");\n      expect(call[1]).toContain(\"--working-directory\");\n      expect(call[1]).toContain(\"/tmp/project/main\");\n    });\n\n    it(\"should throw error when no terminal emulator is found\", async () => {\n      // All terminals not found\n      spawnSyncSpy.mockImplementation(() => ({ status: 1 }));\n\n      service = new TerminalService(configWithLocalWorkspace, mockPTYService);\n\n      // eslint-disable-next-line @typescript-eslint/await-thenable\n      await expect(service.openNative(\"ws-local\")).rejects.toThrow(\"No terminal emulator found\");\n    });\n\n    it(\"should pass SSH args to terminal for SSH workspace\", async () => {\n      // Make alacritty available\n      spawnSyncSpy.mockImplementation((cmd: string, args: string[]) => {\n        if (cmd === \"which\" && args?.[0] === \"alacritty\") {\n          return { status: 0 };\n        }\n        return { status: 1 };\n      });\n\n      service = new TerminalService(configWithSSHWorkspace, mockPTYService);\n\n      await service.openNative(\"ws-ssh\");\n\n      expect(spawnSpy).toHaveBeenCalledTimes(1);\n      const call = spawnSpy.mock.calls[0] as [string, string[], childProcess.SpawnOptions];\n      expect(call[0]).toBe(\"alacritty\");\n      expect(call[1]).toContain(\"-e\");\n      expect(call[1]).toContain(\"ssh\");\n      expect(call[1]).toContain(\"-p\");\n      expect(call[1]).toContain(\"2222\");\n    });\n  });\n\n  describe(\"error handling\", () => {\n    beforeEach(() => {\n      setPlatform(\"darwin\");\n      spawnSyncSpy.mockImplementation(() => ({ status: 0 }));\n    });\n\n    it(\"should throw error for non-existent workspace\", async () => {\n      service = new TerminalService(configWithLocalWorkspace, mockPTYService);\n\n      // eslint-disable-next-line @typescript-eslint/await-thenable\n      await expect(service.openNative(\"non-existent\")).rejects.toThrow(\n        \"Workspace not found: non-existent\"\n      );\n    });\n  });\n});\n"]}