{"version":3,"file":"hooks.js","sourceRoot":"","sources":["../../../src/node/services/hooks.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Tool Hook System\r\n *\r\n * Provides a mechanism for users to wrap tool executions with custom pre/post logic.\r\n * Hooks can be used for:\r\n * - Environment setup (direnv, nvm, virtualenv)\r\n * - Linting/type-checking after file edits\r\n * - Blocking dangerous operations\r\n * - Custom logging/metrics\r\n *\r\n * Hook Location:\r\n *   1. .mux/tool_hook (project-level, committed)\r\n *   2. ~/.mux/tool_hook (user-level, personal)\r\n *\r\n * Protocol:\r\n *   1. Hook receives MUX_TOOL, MUX_TOOL_INPUT, MUX_EXEC, etc. as env vars\r\n *   2. Hook runs pre-logic\r\n *   3. Hook prints $MUX_EXEC (the unique marker) to signal readiness\r\n *   4. Mux executes the tool, sends result JSON to hook's stdin\r\n *   5. Hook reads result, runs post-logic\r\n *   6. Hook exits (non-zero = failure fed back to LLM)\r\n *\r\n * Runtime Support:\r\n *   Hooks execute via the Runtime abstraction, so they work correctly for both\r\n *   local and SSH workspaces. For SSH, the hook file must exist on the remote machine.\r\n */\r\n\r\nimport * as crypto from \"crypto\";\r\nimport * as path from \"path\";\r\nimport { flattenToolHookValueToEnv } from \"@/common/utils/tools/toolHookEnv\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { execBuffered, writeFileString } from \"@/node/utils/runtime/helpers\";\r\n\r\nconst HOOK_FILENAME = \"tool_hook\";\r\nconst PRE_HOOK_FILENAME = \"tool_pre\";\r\nconst POST_HOOK_FILENAME = \"tool_post\";\r\nconst TOOL_ENV_FILENAME = \"tool_env\";\r\nconst TOOL_INPUT_ENV_LIMIT = 8_000;\r\nconst FLATTENED_TOOL_ENV_MAX_VARS = 200;\r\nconst FLATTENED_TOOL_ENV_MAX_ARRAY_LENGTH = 50;\r\nconst DEFAULT_HOOK_PHASE_TIMEOUT_MS = 10_000; // 10 seconds\r\nconst EXEC_MARKER_PREFIX = \"MUX_EXEC_\";\r\n\r\n/** Shell-escape a string for safe use in bash -c commands */\r\nfunction shellEscape(str: string): string {\r\n  // Wrap in single quotes and escape any embedded single quotes\r\n  return `'${str.replace(/'/g, \"'\\\\''\")}'`;\r\n}\r\n\r\nfunction isAsyncIterable(value: unknown): value is AsyncIterable<unknown> {\r\n  return (\r\n    typeof value === \"object\" &&\r\n    value !== null &&\r\n    Symbol.asyncIterator in value &&\r\n    typeof (value as Record<symbol, unknown>)[Symbol.asyncIterator] === \"function\"\r\n  );\r\n}\r\nfunction joinPathLike(basePath: string, ...parts: string[]): string {\r\n  // For SSH runtimes (and most Unix paths), we want POSIX joins.\r\n  // For Windows-style paths, use native joins.\r\n  if (basePath.includes(\"\\\\\") || /^[a-zA-Z]:/.test(basePath)) {\r\n    return path.join(basePath, ...parts);\r\n  }\r\n  return path.posix.join(basePath, ...parts);\r\n}\r\n\r\nfunction getToolInputValueForEnv(context: {\r\n  toolInput: string;\r\n  toolInputValue?: unknown;\r\n}): unknown {\r\n  if (context.toolInputValue !== undefined) {\r\n    return context.toolInputValue;\r\n  }\r\n\r\n  try {\r\n    return JSON.parse(context.toolInput) as unknown;\r\n  } catch {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport interface HookContext {\r\n  /** Tool name (e.g., \"bash\", \"file_edit_replace_string\") */\r\n  tool: string;\r\n  /** Tool input as JSON string */\r\n  toolInput: string;\r\n  /**\r\n   * Tool input as a structured value (best-effort), used for flattened env vars.\r\n   *\r\n   * Optional for backwards compatibility; when omitted we'll attempt to parse\r\n   * `toolInput` as JSON.\r\n   */\r\n  toolInputValue?: unknown;\r\n  /** Workspace ID */\r\n  workspaceId: string;\r\n  /** Runtime temp dir for hook scratch files (paths in the runtime's context) */\r\n  runtimeTempDir?: string;\r\n  /** Project directory (cwd) */\r\n  projectDir: string;\r\n  /** Additional environment variables to pass to hook */\r\n  env?: Record<string, string>;\r\n  /** External abort signal (e.g., from workspace deletion) */\r\n  abortSignal?: AbortSignal;\r\n}\r\n\r\nexport interface HookResult {\r\n  /** Whether the hook succeeded (exit code 0) */\r\n  success: boolean;\r\n  /** Stdout output from hook before the __MUX_EXEC__ marker */\r\n  stdoutBeforeExec: string;\r\n  /** Stdout output from hook (after __MUX_EXEC__ marker) */\r\n  stdout: string;\r\n  /** Stderr output from hook */\r\n  stderr: string;\r\n  /** Hook process exit code */\r\n  exitCode: number;\r\n  /** Whether the tool was executed (hook printed __MUX_EXEC__) */\r\n  toolExecuted: boolean;\r\n}\r\n\r\n/**\r\n * Find the tool_hook executable for a given project directory.\r\n * Uses runtime abstraction so it works for both local and SSH workspaces.\r\n * Returns null if no hook exists.\r\n *\r\n * Note: We don't check execute permissions via runtime since FileStat doesn't\r\n * expose mode bits. The hook will fail at execution time if not executable.\r\n */\r\nexport async function getHookPath(runtime: Runtime, projectDir: string): Promise<string | null> {\r\n  // Check project-level hook first\r\n  const projectHook = joinPathLike(projectDir, \".mux\", HOOK_FILENAME);\r\n  if (await isFile(runtime, projectHook)) {\r\n    return projectHook;\r\n  }\r\n\r\n  // Fall back to user-level hook (resolve ~ for SSH compatibility)\r\n  try {\r\n    const homeDir = await runtime.resolvePath(\"~\");\r\n    const userHook = joinPathLike(homeDir, \".mux\", HOOK_FILENAME);\r\n    if (await isFile(runtime, userHook)) {\r\n      return userHook;\r\n    }\r\n  } catch {\r\n    // resolvePath failed - skip user hook\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Find the tool_env file for a given project directory.\r\n * This file is sourced before bash tool scripts to set up environment.\r\n * Returns null if no tool_env exists.\r\n */\r\nexport async function getToolEnvPath(runtime: Runtime, projectDir: string): Promise<string | null> {\r\n  // Check project-level tool_env first\r\n  const projectEnv = joinPathLike(projectDir, \".mux\", TOOL_ENV_FILENAME);\r\n  if (await isFile(runtime, projectEnv)) {\r\n    return projectEnv;\r\n  }\r\n\r\n  // Fall back to user-level tool_env (resolve ~ for SSH compatibility)\r\n  try {\r\n    const homeDir = await runtime.resolvePath(\"~\");\r\n    const userEnv = joinPathLike(homeDir, \".mux\", TOOL_ENV_FILENAME);\r\n    if (await isFile(runtime, userEnv)) {\r\n      return userEnv;\r\n    }\r\n  } catch {\r\n    // resolvePath failed - skip user tool_env\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Find the tool_pre executable for a given project directory.\r\n * This hook runs before tool execution; exit non-zero to block.\r\n * Returns null if no tool_pre exists.\r\n */\r\nexport async function getPreHookPath(runtime: Runtime, projectDir: string): Promise<string | null> {\r\n  const projectHook = joinPathLike(projectDir, \".mux\", PRE_HOOK_FILENAME);\r\n  if (await isFile(runtime, projectHook)) {\r\n    return projectHook;\r\n  }\r\n\r\n  try {\r\n    const homeDir = await runtime.resolvePath(\"~\");\r\n    const userHook = joinPathLike(homeDir, \".mux\", PRE_HOOK_FILENAME);\r\n    if (await isFile(runtime, userHook)) {\r\n      return userHook;\r\n    }\r\n  } catch {\r\n    // resolvePath failed - skip user hook\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Find the tool_post executable for a given project directory.\r\n * This hook runs after tool execution with result available.\r\n * Returns null if no tool_post exists.\r\n */\r\nexport async function getPostHookPath(\r\n  runtime: Runtime,\r\n  projectDir: string\r\n): Promise<string | null> {\r\n  const projectHook = joinPathLike(projectDir, \".mux\", POST_HOOK_FILENAME);\r\n  if (await isFile(runtime, projectHook)) {\r\n    return projectHook;\r\n  }\r\n\r\n  try {\r\n    const homeDir = await runtime.resolvePath(\"~\");\r\n    const userHook = joinPathLike(homeDir, \".mux\", POST_HOOK_FILENAME);\r\n    if (await isFile(runtime, userHook)) {\r\n      return userHook;\r\n    }\r\n  } catch {\r\n    // resolvePath failed - skip user hook\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n// When probing hook files over SSH, avoid hanging on dead connections.\r\n// Hook discovery is best-effort; a short timeout keeps tool execution responsive.\r\nconst HOOK_FILE_STAT_TIMEOUT_MS = 2000;\r\n\r\nasync function isFile(runtime: Runtime, filePath: string): Promise<boolean> {\r\n  try {\r\n    const stat = await runtime.stat(filePath, AbortSignal.timeout(HOOK_FILE_STAT_TIMEOUT_MS));\r\n    return !stat.isDirectory;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/** Options for hook timing warnings */\r\nexport interface HookTimingOptions {\r\n  /** Threshold in ms before warning about slow hooks (default: 10000) */\r\n  slowThresholdMs?: number;\r\n  /** Maximum time allowed for hook pre-logic (until __MUX_EXEC__). Defaults to 10 seconds. */\r\n  preHookTimeoutMs?: number;\r\n  /** Maximum time allowed for hook post-logic (after tool result is sent). Defaults to 10 seconds. */\r\n  postHookTimeoutMs?: number;\r\n  /** Callback when hook phase exceeds threshold */\r\n  onSlowHook?: (phase: \"pre\" | \"post\", elapsedMs: number) => void;\r\n}\r\n\r\n/**\r\n * Execute a tool with hook wrapping.\r\n * Uses runtime.exec() so hooks work for both local and SSH workspaces.\r\n *\r\n * @param runtime Runtime to execute the hook in\r\n * @param hookPath Path to the hook executable\r\n * @param context Hook context with tool info\r\n * @param executeTool Callback to execute the actual tool (called when hook signals __MUX_EXEC__)\r\n * @param timingOptions Optional timing/warning configuration\r\n * @returns Hook result with success status and any stderr output\r\n */\r\nexport async function runWithHook<T>(\r\n  runtime: Runtime,\r\n  hookPath: string,\r\n  context: HookContext,\r\n  executeTool: () => Promise<T | AsyncIterable<T>>,\r\n  timingOptions?: HookTimingOptions\r\n): Promise<{ result: T | AsyncIterable<T> | undefined; hook: HookResult }> {\r\n  const slowThresholdMs = timingOptions?.slowThresholdMs ?? 10000;\r\n  const onSlowHook = timingOptions?.onSlowHook;\r\n  const preHookTimeoutMs = timingOptions?.preHookTimeoutMs ?? DEFAULT_HOOK_PHASE_TIMEOUT_MS;\r\n  const postHookTimeoutMs = timingOptions?.postHookTimeoutMs ?? DEFAULT_HOOK_PHASE_TIMEOUT_MS;\r\n  const hookStartTime = Date.now();\r\n\r\n  // Generate a unique marker for this invocation to prevent accidental triggers\r\n  const execMarker = `${EXEC_MARKER_PREFIX}${crypto.randomUUID().replace(/-/g, \"\")}`;\r\n\r\n  let toolInputPath: string | undefined;\r\n  let toolInputEnv = context.toolInput;\r\n  if (context.toolInput.length > TOOL_INPUT_ENV_LIMIT) {\r\n    // Tool input can be massive (file_edit_* old/new strings) and can exceed limits\r\n    // when injected as env vars (especially over SSH, where env is embedded into a\r\n    // single bash -c command string). Prefer writing the full JSON to a temp file.\r\n    try {\r\n      const tempDir = context.runtimeTempDir ?? \"/tmp\";\r\n      toolInputPath = joinPathLike(\r\n        tempDir,\r\n        `mux-tool-input-${Date.now()}-${crypto.randomUUID()}.json`\r\n      );\r\n      await writeFileString(runtime, toolInputPath, context.toolInput);\r\n      toolInputEnv = \"__MUX_TOOL_INPUT_FILE__\";\r\n    } catch (err) {\r\n      log.debug(\"[hooks] Failed to write tool input to temp file; falling back to truncation\", {\r\n        error: err,\r\n      });\r\n      toolInputPath = undefined;\r\n      toolInputEnv = context.toolInput.slice(0, TOOL_INPUT_ENV_LIMIT);\r\n    }\r\n  }\r\n\r\n  const toolInputValueForEnv = getToolInputValueForEnv(context);\r\n\r\n  const hookEnv: Record<string, string> = {\r\n    ...(context.env ?? {}),\r\n    MUX_TOOL: context.tool,\r\n    ...flattenToolHookValueToEnv(toolInputValueForEnv, \"MUX_TOOL_INPUT\", {\r\n      maxValueLength: TOOL_INPUT_ENV_LIMIT,\r\n      maxVars: FLATTENED_TOOL_ENV_MAX_VARS,\r\n      maxArrayLength: FLATTENED_TOOL_ENV_MAX_ARRAY_LENGTH,\r\n    }),\r\n    // Ensure the base JSON env var cannot be overwritten by flattened fields.\r\n    MUX_TOOL_INPUT: toolInputEnv,\r\n    MUX_WORKSPACE_ID: context.workspaceId,\r\n    MUX_PROJECT_DIR: context.projectDir,\r\n    MUX_EXEC: execMarker,\r\n  };\r\n  if (toolInputPath) {\r\n    hookEnv.MUX_TOOL_INPUT_PATH = toolInputPath;\r\n  }\r\n\r\n  const abortController = new AbortController();\r\n  let timeoutPhase: \"pre\" | \"post\" | \"external\" | undefined;\r\n  let preTimeoutHandle: ReturnType<typeof setTimeout> | undefined;\r\n  let postTimeoutHandle: ReturnType<typeof setTimeout> | undefined;\r\n\r\n  // Forward external abort signal (e.g., workspace deletion)\r\n  if (context.abortSignal) {\r\n    if (context.abortSignal.aborted) {\r\n      timeoutPhase = \"external\";\r\n      abortController.abort();\r\n    } else {\r\n      context.abortSignal.addEventListener(\r\n        \"abort\",\r\n        () => {\r\n          timeoutPhase = \"external\";\r\n          abortController.abort();\r\n        },\r\n        { once: true }\r\n      );\r\n    }\r\n  }\r\n\r\n  if (preHookTimeoutMs > 0) {\r\n    preTimeoutHandle = setTimeout(() => {\r\n      timeoutPhase = \"pre\";\r\n      abortController.abort();\r\n    }, preHookTimeoutMs);\r\n  }\r\n\r\n  let stream;\r\n  try {\r\n    // Shell-escape the hook path to handle spaces and special characters\r\n    // runtime.exec() uses bash -c, so unquoted paths would break\r\n    stream = await runtime.exec(shellEscape(hookPath), {\r\n      cwd: context.projectDir,\r\n      env: hookEnv,\r\n      abortSignal: abortController.signal,\r\n    });\r\n  } catch (err) {\r\n    if (preTimeoutHandle) {\r\n      clearTimeout(preTimeoutHandle);\r\n      preTimeoutHandle = undefined;\r\n    }\r\n    log.error(\"[hooks] Failed to spawn hook\", { hookPath, error: err });\r\n    if (toolInputPath) {\r\n      try {\r\n        await execBuffered(runtime, `rm -f ${shellEscape(toolInputPath)}`, {\r\n          cwd: context.projectDir,\r\n          timeout: 5,\r\n        });\r\n      } catch {\r\n        // Best-effort cleanup\r\n      }\r\n    }\r\n    return {\r\n      result: undefined,\r\n      hook: {\r\n        success: false,\r\n        stdoutBeforeExec: \"\",\r\n        stdout: \"\",\r\n        stderr: `Failed to execute hook: ${err instanceof Error ? err.message : String(err)}`,\r\n        exitCode: -1,\r\n        toolExecuted: false,\r\n      },\r\n    };\r\n  }\r\n\r\n  let toolResult: T | AsyncIterable<T> | undefined;\r\n  let toolError: Error | undefined;\r\n  let hookStdinWriteError: Error | undefined;\r\n  let toolExecuted = false;\r\n  let toolResultSentTime: number | undefined;\r\n  let stderrOutput = \"\";\r\n  let stdoutBuffer = \"\";\r\n  let stdoutBeforeExec = \"\";\r\n  let stdoutAfterMarker = \"\";\r\n  let toolPromise: Promise<void> | undefined;\r\n\r\n  // Read stderr in background\r\n  const stderrReader = stream.stderr.getReader();\r\n  const stderrPromise = (async () => {\r\n    const decoder = new TextDecoder();\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await stderrReader.read();\r\n        if (done) break;\r\n        stderrOutput += decoder.decode(value, { stream: true });\r\n      }\r\n    } catch {\r\n      // Ignore stream errors (e.g. abort)\r\n    } finally {\r\n      stderrReader.releaseLock();\r\n    }\r\n  })();\r\n\r\n  // Read stdout, watching for __MUX_EXEC__ marker\r\n  const stdoutReader = stream.stdout.getReader();\r\n  const decoder = new TextDecoder();\r\n  try {\r\n    while (true) {\r\n      const { done, value } = await stdoutReader.read();\r\n      if (done) break;\r\n\r\n      const chunk = decoder.decode(value, { stream: true });\r\n\r\n      if (toolExecuted) {\r\n        // After marker: capture for hook output\r\n        stdoutAfterMarker += chunk;\r\n        continue;\r\n      }\r\n\r\n      stdoutBuffer += chunk;\r\n\r\n      const markerIdx = stdoutBuffer.indexOf(execMarker);\r\n      if (markerIdx === -1) {\r\n        continue;\r\n      }\r\n\r\n      // Marker detected: allow tool execution.\r\n      // Stop the pre-hook timeout clock and start the tool.\r\n      if (preTimeoutHandle) {\r\n        clearTimeout(preTimeoutHandle);\r\n        preTimeoutHandle = undefined;\r\n      }\r\n\r\n      // Check pre-hook timing before marking as executed\r\n      const preHookElapsed = Date.now() - hookStartTime;\r\n      if (onSlowHook && preHookElapsed > slowThresholdMs) {\r\n        onSlowHook(\"pre\", preHookElapsed);\r\n      }\r\n\r\n      toolExecuted = true;\r\n      stdoutBeforeExec = stdoutBuffer.slice(0, markerIdx);\r\n      stdoutAfterMarker = stdoutBuffer.slice(markerIdx + execMarker.length);\r\n\r\n      // Execute tool + send result to hook stdin in the background so we can\r\n      // continue draining stdout (hooks may log after __MUX_EXEC__).\r\n      toolPromise = (async () => {\r\n        try {\r\n          try {\r\n            toolResult = await executeTool();\r\n          } catch (err) {\r\n            toolError = err instanceof Error ? err : new Error(String(err));\r\n          }\r\n\r\n          const payload = toolError ? { error: toolError.message } : toolResult;\r\n          const payloadForHook = isAsyncIterable(payload) ? { streaming: true } : payload;\r\n\r\n          const writer = stream.stdin.getWriter();\r\n          try {\r\n            await writer.write(new TextEncoder().encode(JSON.stringify(payloadForHook) + \"\\n\"));\r\n          } catch (err) {\r\n            hookStdinWriteError = err instanceof Error ? err : new Error(String(err));\r\n          } finally {\r\n            try {\r\n              await writer.close();\r\n            } catch {\r\n              // Ignore close errors (e.g. EPIPE if hook exited)\r\n            }\r\n            toolResultSentTime = Date.now();\r\n\r\n            if (postHookTimeoutMs > 0) {\r\n              postTimeoutHandle = setTimeout(() => {\r\n                timeoutPhase = \"post\";\r\n                abortController.abort();\r\n              }, postHookTimeoutMs);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          // This should never throw, but guard to avoid unhandled rejections.\r\n          hookStdinWriteError = err instanceof Error ? err : new Error(String(err));\r\n        }\r\n      })();\r\n    }\r\n  } catch {\r\n    // Ignore stream errors (e.g. abort)\r\n  } finally {\r\n    stdoutReader.releaseLock();\r\n  }\r\n\r\n  // If hook exited before __MUX_EXEC__, close stdin\r\n  if (!toolExecuted) {\r\n    // Cancel the pre-hook timeout.\r\n    if (preTimeoutHandle) {\r\n      clearTimeout(preTimeoutHandle);\r\n      preTimeoutHandle = undefined;\r\n    }\r\n    const writer = stream.stdin.getWriter();\r\n    try {\r\n      await writer.close();\r\n    } catch {\r\n      // Ignore close errors (e.g. hook already exited)\r\n    }\r\n  }\r\n\r\n  // Wait for tool execution (if started), stderr collection, and exit code\r\n  await toolPromise;\r\n  await stderrPromise;\r\n  const exitCode = await stream.exitCode;\r\n\r\n  if (postTimeoutHandle) {\r\n    clearTimeout(postTimeoutHandle);\r\n    postTimeoutHandle = undefined;\r\n  }\r\n\r\n  // Check post-hook timing (time from result sent to hook exit)\r\n  if (onSlowHook && toolResultSentTime) {\r\n    const postHookElapsed = Date.now() - toolResultSentTime;\r\n    if (postHookElapsed > slowThresholdMs) {\r\n      onSlowHook(\"post\", postHookElapsed);\r\n    }\r\n  }\r\n\r\n  if (timeoutPhase === \"pre\") {\r\n    stderrOutput += `\\nHook timed out before $MUX_EXEC marker (${preHookTimeoutMs}ms)`;\r\n  } else if (timeoutPhase === \"post\") {\r\n    stderrOutput += `\\nHook timed out after tool result was sent (${postHookTimeoutMs}ms)`;\r\n  } else if (timeoutPhase === \"external\") {\r\n    stderrOutput += `\\nHook aborted (workspace deleted or request cancelled)`;\r\n  }\r\n  if (hookStdinWriteError) {\r\n    stderrOutput += `\\nFailed to write tool result to hook stdin: ${hookStdinWriteError.message}`;\r\n  }\r\n\r\n  if (toolInputPath) {\r\n    try {\r\n      await execBuffered(runtime, `rm -f ${shellEscape(toolInputPath)}`, {\r\n        cwd: context.projectDir,\r\n        timeout: 5,\r\n      });\r\n    } catch {\r\n      // Best-effort cleanup\r\n    }\r\n  }\r\n\r\n  // If tool threw an error, rethrow it after hook completes\r\n  // This ensures tool failures propagate even when hooks are present\r\n  if (toolError) {\r\n    throw toolError;\r\n  }\r\n\r\n  return {\r\n    result: toolResult,\r\n    hook: {\r\n      success: exitCode === 0,\r\n      stdoutBeforeExec: (toolExecuted ? stdoutBeforeExec : stdoutBuffer).trim(),\r\n      stdout: stdoutAfterMarker.trim(),\r\n      stderr: stderrOutput.trim(),\r\n      exitCode,\r\n      toolExecuted,\r\n    },\r\n  };\r\n}\r\n\r\n/** Result from running a pre-hook */\r\nexport interface PreHookResult {\r\n  /** Whether the tool is allowed to proceed (exit code 0) */\r\n  allowed: boolean;\r\n  /** Combined stdout + stderr output */\r\n  output: string;\r\n  /** Hook process exit code */\r\n  exitCode: number;\r\n}\r\n\r\n/** Result from running a post-hook */\r\nexport interface PostHookResult {\r\n  /** Whether the hook succeeded (exit code 0) */\r\n  success: boolean;\r\n  /** Combined stdout + stderr output */\r\n  output: string;\r\n  /** Hook process exit code */\r\n  exitCode: number;\r\n}\r\n\r\n/** Context for pre/post hooks (simpler than HookContext) */\r\nexport interface SimpleHookContext {\r\n  /** Tool name */\r\n  tool: string;\r\n  /** Tool input as JSON string */\r\n  toolInput: string;\r\n  /**\r\n   * Tool input as a structured value (best-effort), used for flattened env vars.\r\n   *\r\n   * Optional for backwards compatibility; when omitted we'll attempt to parse\r\n   * `toolInput` as JSON.\r\n   */\r\n  toolInputValue?: unknown;\r\n  /** Workspace ID */\r\n  workspaceId: string;\r\n  /** Project directory */\r\n  projectDir: string;\r\n  /** Runtime temp dir for scratch files */\r\n  runtimeTempDir?: string;\r\n  /** Additional environment variables */\r\n  env?: Record<string, string>;\r\n  /** External abort signal */\r\n  abortSignal?: AbortSignal;\r\n}\r\n\r\n/** Options for pre/post hook execution */\r\nexport interface SimpleHookOptions {\r\n  /** Timeout in ms (default: 5 minutes) */\r\n  timeoutMs?: number;\r\n}\r\n\r\n/**\r\n * Run a pre-hook (tool_pre) before tool execution.\r\n * Simple model: spawn hook, wait for exit, check exit code.\r\n * Exit 0 = allow tool, non-zero = block tool.\r\n */\r\nexport async function runPreHook(\r\n  runtime: Runtime,\r\n  hookPath: string,\r\n  context: SimpleHookContext,\r\n  options?: SimpleHookOptions\r\n): Promise<PreHookResult> {\r\n  const timeoutMs = options?.timeoutMs ?? DEFAULT_HOOK_PHASE_TIMEOUT_MS;\r\n\r\n  // Prepare tool input (file if large)\r\n  const { toolInputEnv, toolInputPath, cleanup } = await prepareToolInput(\r\n    runtime,\r\n    context.toolInput,\r\n    context.runtimeTempDir,\r\n    context.projectDir\r\n  );\r\n\r\n  const toolInputValueForEnv = getToolInputValueForEnv(context);\r\n\r\n  const hookEnv: Record<string, string> = {\r\n    ...(context.env ?? {}),\r\n    MUX_TOOL: context.tool,\r\n    ...flattenToolHookValueToEnv(toolInputValueForEnv, \"MUX_TOOL_INPUT\", {\r\n      maxValueLength: TOOL_INPUT_ENV_LIMIT,\r\n      maxVars: FLATTENED_TOOL_ENV_MAX_VARS,\r\n      maxArrayLength: FLATTENED_TOOL_ENV_MAX_ARRAY_LENGTH,\r\n    }),\r\n    // Ensure the base JSON env var cannot be overwritten by flattened fields.\r\n    MUX_TOOL_INPUT: toolInputEnv,\r\n    MUX_WORKSPACE_ID: context.workspaceId,\r\n    MUX_PROJECT_DIR: context.projectDir,\r\n  };\r\n  if (toolInputPath) {\r\n    hookEnv.MUX_TOOL_INPUT_PATH = toolInputPath;\r\n  }\r\n\r\n  try {\r\n    const result = await execBuffered(runtime, shellEscape(hookPath), {\r\n      cwd: context.projectDir,\r\n      env: hookEnv,\r\n      timeout: Math.ceil(timeoutMs / 1000),\r\n      abortSignal: context.abortSignal,\r\n    });\r\n\r\n    const output = [result.stdout, result.stderr].filter(Boolean).join(\"\\n\").trim();\r\n    return {\r\n      allowed: result.exitCode === 0,\r\n      output,\r\n      exitCode: result.exitCode ?? -1,\r\n    };\r\n  } catch (err) {\r\n    log.error(\"[hooks] Pre-hook execution failed\", { hookPath, error: err });\r\n    return {\r\n      allowed: false,\r\n      output: `Pre-hook failed: ${err instanceof Error ? err.message : String(err)}`,\r\n      exitCode: -1,\r\n    };\r\n  } finally {\r\n    await cleanup();\r\n  }\r\n}\r\n\r\n/**\r\n * Run a post-hook (tool_post) after tool execution.\r\n * Simple model: spawn hook with result in env/file, wait for exit.\r\n */\r\nexport async function runPostHook(\r\n  runtime: Runtime,\r\n  hookPath: string,\r\n  context: SimpleHookContext,\r\n  toolResult: unknown,\r\n  options?: SimpleHookOptions\r\n): Promise<PostHookResult> {\r\n  const timeoutMs = options?.timeoutMs ?? DEFAULT_HOOK_PHASE_TIMEOUT_MS;\r\n  const resultJson = JSON.stringify(toolResult);\r\n\r\n  // Prepare tool input (file if large)\r\n  const {\r\n    toolInputEnv,\r\n    toolInputPath,\r\n    cleanup: cleanupInput,\r\n  } = await prepareToolInput(\r\n    runtime,\r\n    context.toolInput,\r\n    context.runtimeTempDir,\r\n    context.projectDir\r\n  );\r\n\r\n  // Prepare tool result (best-effort file; env var placeholder if large)\r\n  const resultPath = joinPathLike(\r\n    context.runtimeTempDir ?? \"/tmp\",\r\n    `mux-tool-result-${Date.now()}-${crypto.randomUUID()}.json`\r\n  );\r\n  let resultPathForEnv: string | undefined;\r\n  let resultEnv = resultJson;\r\n  try {\r\n    await writeFileString(runtime, resultPath, resultJson);\r\n    resultPathForEnv = resultPath;\r\n    if (resultJson.length > TOOL_INPUT_ENV_LIMIT) {\r\n      resultEnv = \"__MUX_TOOL_RESULT_FILE__\";\r\n    }\r\n  } catch (err) {\r\n    log.debug(\"[hooks] Failed to write tool result to temp file\", { error: err });\r\n    resultPathForEnv = undefined;\r\n    resultEnv = resultJson.slice(0, TOOL_INPUT_ENV_LIMIT);\r\n  }\r\n\r\n  const toolInputValueForEnv = getToolInputValueForEnv(context);\r\n\r\n  const hookEnv: Record<string, string> = {\r\n    ...(context.env ?? {}),\r\n    MUX_TOOL: context.tool,\r\n    ...flattenToolHookValueToEnv(toolInputValueForEnv, \"MUX_TOOL_INPUT\", {\r\n      maxValueLength: TOOL_INPUT_ENV_LIMIT,\r\n      maxVars: FLATTENED_TOOL_ENV_MAX_VARS,\r\n      maxArrayLength: FLATTENED_TOOL_ENV_MAX_ARRAY_LENGTH,\r\n    }),\r\n    ...flattenToolHookValueToEnv(toolResult, \"MUX_TOOL_RESULT\", {\r\n      maxValueLength: TOOL_INPUT_ENV_LIMIT,\r\n      maxVars: FLATTENED_TOOL_ENV_MAX_VARS,\r\n      maxArrayLength: FLATTENED_TOOL_ENV_MAX_ARRAY_LENGTH,\r\n    }),\r\n    // Ensure base JSON env vars cannot be overwritten by flattened fields.\r\n    MUX_TOOL_INPUT: toolInputEnv,\r\n    MUX_WORKSPACE_ID: context.workspaceId,\r\n    MUX_PROJECT_DIR: context.projectDir,\r\n    MUX_TOOL_RESULT: resultEnv,\r\n  };\r\n  if (toolInputPath) {\r\n    hookEnv.MUX_TOOL_INPUT_PATH = toolInputPath;\r\n  }\r\n  if (resultPathForEnv) {\r\n    hookEnv.MUX_TOOL_RESULT_PATH = resultPathForEnv;\r\n  }\r\n\r\n  const cleanup = async () => {\r\n    await cleanupInput();\r\n    if (!resultPathForEnv) return;\r\n\r\n    try {\r\n      await execBuffered(runtime, `rm -f ${shellEscape(resultPathForEnv)}`, {\r\n        cwd: context.projectDir,\r\n        timeout: 5,\r\n      });\r\n    } catch {\r\n      // Best-effort\r\n    }\r\n  };\r\n\r\n  try {\r\n    const result = await execBuffered(runtime, shellEscape(hookPath), {\r\n      cwd: context.projectDir,\r\n      env: hookEnv,\r\n      timeout: Math.ceil(timeoutMs / 1000),\r\n      abortSignal: context.abortSignal,\r\n    });\r\n\r\n    const output = [result.stdout, result.stderr].filter(Boolean).join(\"\\n\").trim();\r\n    return {\r\n      success: result.exitCode === 0,\r\n      output,\r\n      exitCode: result.exitCode ?? -1,\r\n    };\r\n  } catch (err) {\r\n    log.error(\"[hooks] Post-hook execution failed\", { hookPath, error: err });\r\n    return {\r\n      success: false,\r\n      output: `Post-hook failed: ${err instanceof Error ? err.message : String(err)}`,\r\n      exitCode: -1,\r\n    };\r\n  } finally {\r\n    await cleanup();\r\n  }\r\n}\r\n\r\n/** Helper to prepare tool input (write to file if large) */\r\nasync function prepareToolInput(\r\n  runtime: Runtime,\r\n  toolInput: string,\r\n  runtimeTempDir: string | undefined,\r\n  projectDir: string\r\n): Promise<{\r\n  toolInputEnv: string;\r\n  toolInputPath: string | undefined;\r\n  cleanup: () => Promise<void>;\r\n}> {\r\n  let toolInputPath: string | undefined;\r\n  let toolInputEnv = toolInput;\r\n\r\n  if (toolInput.length > TOOL_INPUT_ENV_LIMIT) {\r\n    try {\r\n      const tempDir = runtimeTempDir ?? \"/tmp\";\r\n      toolInputPath = joinPathLike(\r\n        tempDir,\r\n        `mux-tool-input-${Date.now()}-${crypto.randomUUID()}.json`\r\n      );\r\n      await writeFileString(runtime, toolInputPath, toolInput);\r\n      toolInputEnv = \"__MUX_TOOL_INPUT_FILE__\";\r\n    } catch (err) {\r\n      log.debug(\"[hooks] Failed to write tool input to temp file\", { error: err });\r\n      toolInputPath = undefined;\r\n      toolInputEnv = toolInput.slice(0, TOOL_INPUT_ENV_LIMIT);\r\n    }\r\n  }\r\n\r\n  const cleanup = async () => {\r\n    if (toolInputPath) {\r\n      try {\r\n        await execBuffered(runtime, `rm -f ${shellEscape(toolInputPath)}`, {\r\n          cwd: projectDir,\r\n          timeout: 5,\r\n        });\r\n      } catch {\r\n        // Best-effort\r\n      }\r\n    }\r\n  };\r\n\r\n  return { toolInputEnv, toolInputPath, cleanup };\r\n}\r\n"]}