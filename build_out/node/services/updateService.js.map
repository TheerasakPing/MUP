{"version":3,"file":"updateService.js","sourceRoot":"","sources":["../../../src/node/services/updateService.ts"],"names":[],"mappings":"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","sourcesContent":["import { log } from \"@/node/services/log\";\nimport type { UpdateStatus } from \"@/common/orpc/types\";\nimport { parseDebugUpdater } from \"@/common/utils/env\";\n\n// Interface matching the implementation class in desktop/updater.ts\n// We redefine it here to avoid importing the class directly which brings in electron-updater\ninterface DesktopUpdaterService {\n  checkForUpdates(): void;\n  downloadUpdate(): Promise<void>;\n  installUpdate(): void;\n  subscribe(callback: (status: UpdateStatus) => void): () => void;\n  getStatus(): UpdateStatus;\n}\n\nexport class UpdateService {\n  private impl: DesktopUpdaterService | null = null;\n  private currentStatus: UpdateStatus = { type: \"idle\" };\n  private subscribers = new Set<(status: UpdateStatus) => void>();\n\n  constructor() {\n    this.initialize().catch((err) => {\n      log.error(\"Failed to initialize UpdateService:\", err);\n    });\n  }\n\n  private async initialize() {\n    // Check if running in Electron Main process\n    if (process.versions.electron) {\n      try {\n        // Dynamic import to avoid loading electron-updater in CLI\n        // eslint-disable-next-line no-restricted-syntax\n        const { UpdaterService: DesktopUpdater } = await import(\"@/desktop/updater\");\n        this.impl = new DesktopUpdater();\n\n        // Forward updates\n        this.impl.subscribe((status: UpdateStatus) => {\n          this.currentStatus = status;\n          this.notifySubscribers();\n        });\n\n        // Sync initial status\n        this.currentStatus = this.impl.getStatus();\n      } catch (err) {\n        log.debug(\n          \"UpdateService: Failed to load desktop updater (likely CLI mode or missing dep):\",\n          err\n        );\n      }\n    }\n  }\n\n  async check(): Promise<void> {\n    if (this.impl) {\n      if (process.versions.electron) {\n        try {\n          // eslint-disable-next-line no-restricted-syntax\n          const { app } = await import(\"electron\");\n\n          const debugConfig = parseDebugUpdater(process.env.DEBUG_UPDATER);\n          if (!app.isPackaged && !debugConfig.enabled) {\n            log.debug(\"UpdateService: Updates disabled in dev mode\");\n            // Ensure status is idle so frontend doesn't show spinner.\n            // Always notify so frontend clears isCheckingOnHover state.\n            this.currentStatus = { type: \"idle\" };\n            this.notifySubscribers();\n            return;\n          }\n        } catch (err) {\n          // Ignore errors (e.g. if modules not found), proceed to check\n          log.debug(\"UpdateService: Error checking env:\", err);\n        }\n      }\n      this.impl.checkForUpdates();\n    } else {\n      log.debug(\"UpdateService: check() called but no implementation (CLI mode)\");\n    }\n  }\n\n  async download(): Promise<void> {\n    if (this.impl) {\n      await this.impl.downloadUpdate();\n    }\n  }\n\n  install(): void {\n    if (this.impl) {\n      this.impl.installUpdate();\n    }\n  }\n\n  onStatus(callback: (status: UpdateStatus) => void): () => void {\n    // Send current status immediately\n    callback(this.currentStatus);\n\n    this.subscribers.add(callback);\n    return () => {\n      this.subscribers.delete(callback);\n    };\n  }\n\n  private notifySubscribers() {\n    for (const sub of this.subscribers) {\n      try {\n        sub(this.currentStatus);\n      } catch (err) {\n        log.error(\"Error in UpdateService subscriber:\", err);\n      }\n    }\n  }\n}\n"]}