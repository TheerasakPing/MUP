{"version":3,"file":"telemetryService.featureFlags.test.js","sourceRoot":"","sources":["../../../src/node/services/telemetryService.featureFlags.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, beforeEach, afterEach, mock } from \"bun:test\";\nimport { TelemetryService } from \"./telemetryService\";\nimport type { TelemetryEventPayload } from \"@/common/telemetry/payload\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\ndescribe(\"TelemetryService feature flag properties\", () => {\n  let tempDir: string;\n\n  beforeEach(async () => {\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-telemetry-test-\"));\n  });\n\n  afterEach(async () => {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  });\n\n  test(\"capture includes $feature/<flagKey> properties when set\", () => {\n    // The capture method checks isTelemetryDisabledByEnv which checks NODE_ENV=test,\n    // JEST_WORKER_ID, VITEST, CI, etc. We need to temporarily clear these for the test.\n    const savedEnv = {\n      NODE_ENV: process.env.NODE_ENV,\n      JEST_WORKER_ID: process.env.JEST_WORKER_ID,\n      VITEST: process.env.VITEST,\n      CI: process.env.CI,\n      GITHUB_ACTIONS: process.env.GITHUB_ACTIONS,\n      MUX_DISABLE_TELEMETRY: process.env.MUX_DISABLE_TELEMETRY,\n      MUX_E2E: process.env.MUX_E2E,\n      TEST_INTEGRATION: process.env.TEST_INTEGRATION,\n    };\n\n    // Clear all telemetry-disabling env vars\n    process.env.NODE_ENV = \"production\";\n    delete process.env.JEST_WORKER_ID;\n    delete process.env.VITEST;\n    delete process.env.CI;\n    delete process.env.GITHUB_ACTIONS;\n    delete process.env.MUX_DISABLE_TELEMETRY;\n    delete process.env.MUX_E2E;\n    delete process.env.TEST_INTEGRATION;\n\n    try {\n      const telemetry = new TelemetryService(tempDir);\n\n      const capture = mock((_args: unknown) => undefined);\n\n      // NOTE: TelemetryService only checks that client + distinctId are set.\n      // We set them directly to avoid any real network calls.\n      // @ts-expect-error - Accessing private property for test\n      telemetry.client = { capture };\n      // @ts-expect-error - Accessing private property for test\n      telemetry.distinctId = \"distinct-id\";\n\n      telemetry.setFeatureFlagVariant(\"system-1\", \"test\");\n\n      const payload: TelemetryEventPayload = {\n        event: \"message_sent\",\n        properties: {\n          workspaceId: \"workspace-id\",\n          model: \"test-model\",\n          agentId: \"exec\",\n          message_length_b2: 128,\n          runtimeType: \"local\",\n          frontendPlatform: {\n            userAgent: \"ua\",\n            platform: \"platform\",\n          },\n          thinkingLevel: \"off\",\n        },\n      };\n\n      telemetry.capture(payload);\n\n      expect(capture).toHaveBeenCalled();\n\n      const call = capture.mock.calls[0]?.[0] as\n        | { properties?: Record<string, unknown> }\n        | undefined;\n      expect(call?.properties).toBeDefined();\n      expect(call?.properties?.[\"$feature/system-1\"]).toBe(\"test\");\n    } finally {\n      // Restore all env vars\n      for (const [key, value] of Object.entries(savedEnv)) {\n        if (value === undefined) {\n          delete process.env[key];\n        } else {\n          process.env[key] = value;\n        }\n      }\n    }\n  });\n});\n"]}