{"version":3,"file":"telemetryService.featureFlags.test.js","sourceRoot":"","sources":["../../../src/node/services/telemetryService.featureFlags.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, beforeEach, afterEach, mock } from \"bun:test\";\r\nimport { TelemetryService } from \"./telemetryService\";\r\nimport type { TelemetryEventPayload } from \"@/common/telemetry/payload\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\n\r\ndescribe(\"TelemetryService feature flag properties\", () => {\r\n  let tempDir: string;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-telemetry-test-\"));\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  test(\"capture includes $feature/<flagKey> properties when set\", () => {\r\n    // The capture method checks isTelemetryDisabledByEnv which checks NODE_ENV=test,\r\n    // JEST_WORKER_ID, VITEST, CI, etc. We need to temporarily clear these for the test.\r\n    const savedEnv = {\r\n      NODE_ENV: process.env.NODE_ENV,\r\n      JEST_WORKER_ID: process.env.JEST_WORKER_ID,\r\n      VITEST: process.env.VITEST,\r\n      CI: process.env.CI,\r\n      GITHUB_ACTIONS: process.env.GITHUB_ACTIONS,\r\n      MUX_DISABLE_TELEMETRY: process.env.MUX_DISABLE_TELEMETRY,\r\n      MUX_E2E: process.env.MUX_E2E,\r\n      TEST_INTEGRATION: process.env.TEST_INTEGRATION,\r\n    };\r\n\r\n    // Clear all telemetry-disabling env vars\r\n    process.env.NODE_ENV = \"production\";\r\n    delete process.env.JEST_WORKER_ID;\r\n    delete process.env.VITEST;\r\n    delete process.env.CI;\r\n    delete process.env.GITHUB_ACTIONS;\r\n    delete process.env.MUX_DISABLE_TELEMETRY;\r\n    delete process.env.MUX_E2E;\r\n    delete process.env.TEST_INTEGRATION;\r\n\r\n    try {\r\n      const telemetry = new TelemetryService(tempDir);\r\n\r\n      const capture = mock((_args: unknown) => undefined);\r\n\r\n      // NOTE: TelemetryService only checks that client + distinctId are set.\r\n      // We set them directly to avoid any real network calls.\r\n      // @ts-expect-error - Accessing private property for test\r\n      telemetry.client = { capture };\r\n      // @ts-expect-error - Accessing private property for test\r\n      telemetry.distinctId = \"distinct-id\";\r\n\r\n      telemetry.setFeatureFlagVariant(\"system-1\", \"test\");\r\n\r\n      const payload: TelemetryEventPayload = {\r\n        event: \"message_sent\",\r\n        properties: {\r\n          workspaceId: \"workspace-id\",\r\n          model: \"test-model\",\r\n          agentId: \"exec\",\r\n          message_length_b2: 128,\r\n          runtimeType: \"local\",\r\n          frontendPlatform: {\r\n            userAgent: \"ua\",\r\n            platform: \"platform\",\r\n          },\r\n          thinkingLevel: \"off\",\r\n        },\r\n      };\r\n\r\n      telemetry.capture(payload);\r\n\r\n      expect(capture).toHaveBeenCalled();\r\n\r\n      const call = capture.mock.calls[0]?.[0] as\r\n        | { properties?: Record<string, unknown> }\r\n        | undefined;\r\n      expect(call?.properties).toBeDefined();\r\n      expect(call?.properties?.[\"$feature/system-1\"]).toBe(\"test\");\r\n    } finally {\r\n      // Restore all env vars\r\n      for (const [key, value] of Object.entries(savedEnv)) {\r\n        if (value === undefined) {\r\n          delete process.env[key];\r\n        } else {\r\n          process.env[key] = value;\r\n        }\r\n      }\r\n    }\r\n  });\r\n});\r\n"]}