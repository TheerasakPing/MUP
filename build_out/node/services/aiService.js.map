{"version":3,"file":"aiService.js","sourceRoot":"","sources":["../../../src/node/services/aiService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\r\nimport { EventEmitter } from \"events\";\r\n\r\nimport { type LanguageModel, type Tool } from \"ai\";\r\n\r\nimport { linkAbortSignal } from \"@/node/utils/abort\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\r\nimport type { SendMessageOptions } from \"@/common/orpc/types\";\r\n\r\nimport type { DebugLlmRequestSnapshot } from \"@/common/types/debugLlmRequest\";\r\n\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { StreamManager } from \"./streamManager\";\r\nimport type { InitStateManager } from \"./initStateManager\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport { getToolsForModel } from \"@/common/utils/tools/tools\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport { getMuxEnv, getRuntimeType } from \"@/node/runtime/initHook\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { secretsToRecord } from \"@/common/types/secrets\";\r\nimport type { MuxProviderOptions } from \"@/common/types/providerOptions\";\r\nimport type { PolicyService } from \"@/node/services/policyService\";\r\nimport type { ProviderService } from \"@/node/services/providerService\";\r\nimport type { CodexOauthService } from \"@/node/services/codexOauthService\";\r\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport type { FileState, EditedFileAttachment } from \"@/node/services/agentSession\";\r\nimport { log } from \"./log\";\r\nimport {\r\n  addInterruptedSentinel,\r\n  filterEmptyAssistantMessages,\r\n} from \"@/browser/utils/messages/modelMessageTransform\";\r\nimport type { PostCompactionAttachment } from \"@/common/types/attachment\";\r\n\r\nimport type { HistoryService } from \"./historyService\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport { createErrorEvent } from \"./utils/sendMessageError\";\r\nimport { createAssistantMessageId } from \"./utils/messageIds\";\r\nimport type { SessionUsageService } from \"./sessionUsageService\";\r\nimport { sumUsageHistory, getTotalCost } from \"@/common/utils/tokens/usageAggregator\";\r\nimport { readToolInstructions } from \"./systemMessage\";\r\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\r\n\r\nimport type { WorkspaceMCPOverrides } from \"@/common/types/mcp\";\r\nimport type { MCPServerManager, MCPWorkspaceStats } from \"@/node/services/mcpServerManager\";\r\nimport { WorkspaceMcpOverridesService } from \"./workspaceMcpOverridesService\";\r\nimport type { TaskService } from \"@/node/services/taskService\";\r\nimport { buildProviderOptions } from \"@/common/utils/ai/providerOptions\";\r\nimport { sliceMessagesFromLatestCompactionBoundary } from \"@/common/utils/messages/compactionBoundary\";\r\n\r\nimport { THINKING_LEVEL_OFF, type ThinkingLevel } from \"@/common/types/thinking\";\r\n\r\nimport type { StreamAbortEvent, StreamAbortReason, StreamEndEvent } from \"@/common/types/stream\";\r\nimport type { ToolPolicy } from \"@/common/utils/tools/toolPolicy\";\r\nimport type { PTCEventWithParent } from \"@/node/services/tools/code_execution\";\r\nimport { MockAiStreamPlayer } from \"./mock/mockAiStreamPlayer\";\r\nimport { ProviderModelFactory, modelCostsIncluded } from \"./providerModelFactory\";\r\nimport { wrapToolsWithSystem1 } from \"./system1ToolWrapper\";\r\nimport { prepareMessagesForProvider } from \"./messagePipeline\";\r\nimport { resolveAgentForStream } from \"./agentResolution\";\r\nimport { buildPlanInstructions, buildStreamSystemContext } from \"./streamContextBuilder\";\r\nimport {\r\n  simulateContextLimitError,\r\n  simulateToolPolicyNoop,\r\n  type SimulationContext,\r\n} from \"./streamSimulation\";\r\nimport { applyToolPolicyAndExperiments, captureMcpToolTelemetry } from \"./toolAssembly\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// streamMessage options\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Options bag for {@link AIService.streamMessage}. */\r\nexport interface StreamMessageOptions {\r\n  messages: MuxMessage[];\r\n  workspaceId: string;\r\n  modelString: string;\r\n  thinkingLevel?: ThinkingLevel;\r\n  toolPolicy?: ToolPolicy;\r\n  abortSignal?: AbortSignal;\r\n  additionalSystemInstructions?: string;\r\n  maxOutputTokens?: number;\r\n  muxProviderOptions?: MuxProviderOptions;\r\n  agentId?: string;\r\n  recordFileState?: (filePath: string, state: FileState) => void;\r\n  changedFileAttachments?: EditedFileAttachment[];\r\n  postCompactionAttachments?: PostCompactionAttachment[] | null;\r\n  experiments?: SendMessageOptions[\"experiments\"];\r\n  system1Model?: string;\r\n  system1ThinkingLevel?: ThinkingLevel;\r\n  disableWorkspaceAgents?: boolean;\r\n  hasQueuedMessage?: () => boolean;\r\n  openaiTruncationModeOverride?: \"auto\" | \"disabled\";\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Utility: deep-clone with structuredClone fallback\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Deep-clone a value using structuredClone (with JSON fallback). */\r\nfunction safeClone<T>(value: T): T {\r\n  return typeof structuredClone === \"function\"\r\n    ? structuredClone(value)\r\n    : (JSON.parse(JSON.stringify(value)) as T);\r\n}\r\n\r\nexport class AIService extends EventEmitter {\r\n  private readonly streamManager: StreamManager;\r\n  private readonly historyService: HistoryService;\r\n  private readonly partialService: PartialService;\r\n  private readonly config: Config;\r\n  private readonly workspaceMcpOverridesService: WorkspaceMcpOverridesService;\r\n  private mcpServerManager?: MCPServerManager;\r\n  private readonly policyService?: PolicyService;\r\n  private readonly telemetryService?: TelemetryService;\r\n  private readonly initStateManager: InitStateManager;\r\n  private mockModeEnabled: boolean;\r\n  private mockAiStreamPlayer?: MockAiStreamPlayer;\r\n  private readonly backgroundProcessManager?: BackgroundProcessManager;\r\n  private readonly sessionUsageService?: SessionUsageService;\r\n  private readonly providerModelFactory: ProviderModelFactory;\r\n\r\n  // Tracks in-flight stream startup (before StreamManager emits stream-start).\r\n  // This enables user interrupts (Esc/Ctrl+C) during the UI \"starting...\" phase.\r\n  private readonly pendingStreamStarts = new Map<\r\n    string,\r\n    { abortController: AbortController; startTime: number; syntheticMessageId: string }\r\n  >();\r\n\r\n  // Debug: captured LLM request payloads for last send per workspace\r\n  private lastLlmRequestByWorkspace = new Map<string, DebugLlmRequestSnapshot>();\r\n  private taskService?: TaskService;\r\n  private extraTools?: Record<string, Tool>;\r\n\r\n  constructor(\r\n    config: Config,\r\n    historyService: HistoryService,\r\n    partialService: PartialService,\r\n    initStateManager: InitStateManager,\r\n    providerService: ProviderService,\r\n    backgroundProcessManager?: BackgroundProcessManager,\r\n    sessionUsageService?: SessionUsageService,\r\n    workspaceMcpOverridesService?: WorkspaceMcpOverridesService,\r\n    policyService?: PolicyService,\r\n    telemetryService?: TelemetryService\r\n  ) {\r\n    super();\r\n    // Increase max listeners to accommodate multiple concurrent workspace listeners\r\n    // Each workspace subscribes to stream events, and we expect >10 concurrent workspaces\r\n    this.setMaxListeners(50);\r\n    this.workspaceMcpOverridesService =\r\n      workspaceMcpOverridesService ?? new WorkspaceMcpOverridesService(config);\r\n    this.config = config;\r\n    this.historyService = historyService;\r\n    this.partialService = partialService;\r\n    this.initStateManager = initStateManager;\r\n    this.backgroundProcessManager = backgroundProcessManager;\r\n    this.sessionUsageService = sessionUsageService;\r\n    this.policyService = policyService;\r\n    this.telemetryService = telemetryService;\r\n    this.streamManager = new StreamManager(historyService, partialService, sessionUsageService);\r\n    this.providerModelFactory = new ProviderModelFactory(config, providerService, policyService);\r\n    void this.ensureSessionsDir();\r\n    this.setupStreamEventForwarding();\r\n    this.mockModeEnabled = false;\r\n\r\n    if (process.env.MUX_MOCK_AI === \"1\") {\r\n      log.info(\"AIService running in MUX_MOCK_AI mode\");\r\n      this.enableMockMode();\r\n    }\r\n  }\r\n\r\n  setCodexOauthService(service: CodexOauthService): void {\r\n    this.providerModelFactory.codexOauthService = service;\r\n  }\r\n  setMCPServerManager(manager: MCPServerManager): void {\r\n    this.mcpServerManager = manager;\r\n    this.streamManager.setMCPServerManager(manager);\r\n  }\r\n\r\n  setTaskService(taskService: TaskService): void {\r\n    this.taskService = taskService;\r\n  }\r\n\r\n  /**\r\n   * Set extra tools to include in every tool call.\r\n   * Used by CLI to inject tools like set_exit_code without modifying core tool definitions.\r\n   */\r\n  setExtraTools(tools: Record<string, Tool>): void {\r\n    this.extraTools = tools;\r\n  }\r\n\r\n  /**\r\n   * Forward all stream events from StreamManager to AIService consumers\r\n   */\r\n  private setupStreamEventForwarding(): void {\r\n    // Simple one-to-one event forwarding from StreamManager â†’ AIService consumers\r\n    for (const event of [\r\n      \"stream-start\",\r\n      \"stream-delta\",\r\n      \"error\",\r\n      \"tool-call-start\",\r\n      \"tool-call-delta\",\r\n      \"tool-call-end\",\r\n      \"reasoning-delta\",\r\n      \"reasoning-end\",\r\n      \"usage-delta\",\r\n    ] as const) {\r\n      this.streamManager.on(event, (data) => this.emit(event, data));\r\n    }\r\n\r\n    // stream-end needs extra logic: capture provider response for debug modal\r\n    this.streamManager.on(\"stream-end\", (data: StreamEndEvent) => {\r\n      // Best-effort capture of the provider response for the \"Last LLM request\" debug modal.\r\n      // Must never break live streaming.\r\n      try {\r\n        const snapshot = this.lastLlmRequestByWorkspace.get(data.workspaceId);\r\n        if (snapshot) {\r\n          // If messageId is missing (legacy fixtures), attach anyway.\r\n          const shouldAttach = snapshot.messageId === data.messageId || snapshot.messageId == null;\r\n          if (shouldAttach) {\r\n            const updated: DebugLlmRequestSnapshot = {\r\n              ...snapshot,\r\n              response: {\r\n                capturedAt: Date.now(),\r\n                metadata: data.metadata,\r\n                parts: data.parts,\r\n              },\r\n            };\r\n\r\n            this.lastLlmRequestByWorkspace.set(data.workspaceId, safeClone(updated));\r\n          }\r\n        }\r\n      } catch (error) {\r\n        const errMsg = error instanceof Error ? error.message : String(error);\r\n        log.warn(\"Failed to capture debug LLM response snapshot\", { error: errMsg });\r\n      }\r\n\r\n      this.emit(\"stream-end\", data);\r\n    });\r\n\r\n    // Handle stream-abort: dispose of partial based on abandonPartial flag\r\n    this.streamManager.on(\"stream-abort\", (data: StreamAbortEvent) => {\r\n      void (async () => {\r\n        if (data.abandonPartial) {\r\n          // Caller requested discarding partial - delete without committing\r\n          await this.partialService.deletePartial(data.workspaceId);\r\n        } else {\r\n          // Commit interrupted message to history with partial:true metadata\r\n          // This ensures /clear and /truncate can clean up interrupted messages\r\n          const partial = await this.partialService.readPartial(data.workspaceId);\r\n          if (partial) {\r\n            await this.partialService.commitToHistory(data.workspaceId);\r\n            await this.partialService.deletePartial(data.workspaceId);\r\n          }\r\n        }\r\n\r\n        // Forward abort event to consumers\r\n        this.emit(\"stream-abort\", data);\r\n      })();\r\n    });\r\n  }\r\n\r\n  private async ensureSessionsDir(): Promise<void> {\r\n    try {\r\n      await fs.mkdir(this.config.sessionsDir, { recursive: true });\r\n    } catch (error) {\r\n      log.error(\"Failed to create sessions directory:\", error);\r\n    }\r\n  }\r\n\r\n  isMockModeEnabled(): boolean {\r\n    return this.mockModeEnabled;\r\n  }\r\n\r\n  releaseMockStreamStartGate(workspaceId: string): void {\r\n    this.mockAiStreamPlayer?.releaseStreamStartGate(workspaceId);\r\n  }\r\n\r\n  enableMockMode(): void {\r\n    this.mockModeEnabled = true;\r\n\r\n    this.mockAiStreamPlayer ??= new MockAiStreamPlayer({\r\n      aiService: this,\r\n      historyService: this.historyService,\r\n    });\r\n  }\r\n\r\n  async getWorkspaceMetadata(workspaceId: string): Promise<Result<WorkspaceMetadata>> {\r\n    try {\r\n      // Read from config.json (single source of truth)\r\n      // getAllWorkspaceMetadata() handles migration from legacy metadata.json files\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const metadata = allMetadata.find((m) => m.id === workspaceId);\r\n\r\n      if (!metadata) {\r\n        return Err(\r\n          `Workspace metadata not found for ${workspaceId}. Workspace may not be properly initialized.`\r\n        );\r\n      }\r\n\r\n      return Ok(metadata);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to read workspace metadata: ${message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an AI SDK model from a model string (e.g., \"anthropic:claude-opus-4-1\").\r\n   * Delegates to ProviderModelFactory.\r\n   */\r\n  async createModel(\r\n    modelString: string,\r\n    muxProviderOptions?: MuxProviderOptions\r\n  ): Promise<Result<LanguageModel, SendMessageError>> {\r\n    return this.providerModelFactory.createModel(modelString, muxProviderOptions);\r\n  }\r\n\r\n  /** Stream a message conversation to the AI model. */\r\n  async streamMessage(opts: StreamMessageOptions): Promise<Result<void, SendMessageError>> {\r\n    const {\r\n      messages,\r\n      workspaceId,\r\n      modelString,\r\n      thinkingLevel,\r\n      toolPolicy,\r\n      abortSignal,\r\n      additionalSystemInstructions,\r\n      maxOutputTokens,\r\n      muxProviderOptions,\r\n      agentId,\r\n      recordFileState,\r\n      changedFileAttachments,\r\n      postCompactionAttachments,\r\n      experiments,\r\n      system1Model,\r\n      system1ThinkingLevel,\r\n      disableWorkspaceAgents,\r\n      hasQueuedMessage,\r\n      openaiTruncationModeOverride,\r\n    } = opts;\r\n    // Support interrupts during startup (before StreamManager emits stream-start).\r\n    // We register an AbortController up-front and let stopStream() abort it.\r\n    const pendingAbortController = new AbortController();\r\n    const startTime = Date.now();\r\n    const syntheticMessageId = `starting-${startTime}-${Math.random().toString(36).substring(2, 11)}`;\r\n\r\n    // Link external abort signal (if provided).\r\n    const unlinkAbortSignal = linkAbortSignal(abortSignal, pendingAbortController);\r\n\r\n    this.pendingStreamStarts.set(workspaceId, {\r\n      abortController: pendingAbortController,\r\n      startTime,\r\n      syntheticMessageId,\r\n    });\r\n\r\n    const combinedAbortSignal = pendingAbortController.signal;\r\n\r\n    try {\r\n      if (this.mockModeEnabled && this.mockAiStreamPlayer) {\r\n        await this.initStateManager.waitForInit(workspaceId, combinedAbortSignal);\r\n        if (combinedAbortSignal.aborted) {\r\n          return Ok(undefined);\r\n        }\r\n        return await this.mockAiStreamPlayer.play(messages, workspaceId, {\r\n          model: modelString,\r\n          abortSignal: combinedAbortSignal,\r\n        });\r\n      }\r\n\r\n      // DEBUG: Log streamMessage call\r\n      const lastMessage = messages[messages.length - 1];\r\n      log.debug(\r\n        `[STREAM MESSAGE] workspaceId=${workspaceId} messageCount=${messages.length} lastRole=${lastMessage?.role}`\r\n      );\r\n\r\n      // Before starting a new stream, commit any existing partial to history\r\n      // This is idempotent - won't double-commit if already in chat.jsonl\r\n      await this.partialService.commitToHistory(workspaceId);\r\n\r\n      // Helper: clean up an assistant placeholder that was appended to history but never\r\n      // streamed (due to abort during setup). Used in two abort-check sites below.\r\n      const deleteAbortedPlaceholder = async (messageId: string): Promise<void> => {\r\n        const deleteResult = await this.historyService.deleteMessage(workspaceId, messageId);\r\n        if (!deleteResult.success) {\r\n          log.error(\r\n            `Failed to delete aborted assistant placeholder (${messageId}): ${deleteResult.error}`\r\n          );\r\n        }\r\n      };\r\n\r\n      // Mode (plan|exec|compact) is derived from the selected agent definition.\r\n      const effectiveMuxProviderOptions: MuxProviderOptions = muxProviderOptions ?? {};\r\n      const effectiveThinkingLevel: ThinkingLevel = thinkingLevel ?? THINKING_LEVEL_OFF;\r\n\r\n      // Resolve model string (xAI variant mapping + gateway routing) and create the model.\r\n      const modelResult = await this.providerModelFactory.resolveAndCreateModel(\r\n        modelString,\r\n        effectiveThinkingLevel,\r\n        effectiveMuxProviderOptions\r\n      );\r\n      if (!modelResult.success) {\r\n        return Err(modelResult.error);\r\n      }\r\n      const {\r\n        effectiveModelString,\r\n        canonicalModelString,\r\n        canonicalProviderName,\r\n        routedThroughGateway,\r\n      } = modelResult.data;\r\n\r\n      // Dump original messages for debugging\r\n      log.debug_obj(`${workspaceId}/1_original_messages.json`, messages);\r\n\r\n      // toolNamesForSentinel is set after agent resolution below, used in message pipeline.\r\n      let toolNamesForSentinel: string[] = [];\r\n\r\n      // Filter out assistant messages with only reasoning (no text/tools)\r\n      // EXCEPTION: When extended thinking is enabled, preserve reasoning-only messages\r\n      // to comply with Extended Thinking API requirements\r\n      const preserveReasoningOnly =\r\n        canonicalProviderName === \"anthropic\" && effectiveThinkingLevel !== \"off\";\r\n      const filteredMessages = filterEmptyAssistantMessages(messages, preserveReasoningOnly);\r\n      log.debug(`Filtered ${messages.length - filteredMessages.length} empty assistant messages`);\r\n      log.debug_obj(`${workspaceId}/1a_filtered_messages.json`, filteredMessages);\r\n\r\n      // WS2 request slicing: only send the latest compaction epoch to providers.\r\n      // This is request-only; persisted history remains append-only for replay/debugging.\r\n      const providerRequestMessages = sliceMessagesFromLatestCompactionBoundary(filteredMessages);\r\n      if (providerRequestMessages !== filteredMessages) {\r\n        log.debug(\"Sliced provider history from latest compaction boundary\", {\r\n          workspaceId,\r\n          originalCount: filteredMessages.length,\r\n          slicedCount: providerRequestMessages.length,\r\n        });\r\n      }\r\n      log.debug_obj(`${workspaceId}/1b_provider_request_messages.json`, providerRequestMessages);\r\n\r\n      // OpenAI-specific: Keep reasoning parts in history\r\n      // OpenAI manages conversation state via previousResponseId\r\n      if (canonicalProviderName === \"openai\") {\r\n        log.debug(\"Keeping reasoning parts for OpenAI (managed via previousResponseId)\");\r\n      }\r\n      // Add [CONTINUE] sentinel to partial messages (for model context)\r\n      const messagesWithSentinel = addInterruptedSentinel(providerRequestMessages);\r\n\r\n      // Get workspace metadata to retrieve workspace path\r\n      const metadataResult = await this.getWorkspaceMetadata(workspaceId);\r\n      if (!metadataResult.success) {\r\n        return Err({ type: \"unknown\", raw: metadataResult.error });\r\n      }\r\n\r\n      const metadata = metadataResult.data;\r\n\r\n      if (this.policyService?.isEnforced()) {\r\n        if (!this.policyService.isRuntimeAllowed(metadata.runtimeConfig)) {\r\n          return Err({\r\n            type: \"policy_denied\",\r\n            message: \"Workspace runtime is not allowed by policy\",\r\n          });\r\n        }\r\n      }\r\n      const workspaceLog = log.withFields({ workspaceId, workspaceName: metadata.name });\r\n\r\n      if (!this.config.findWorkspace(workspaceId)) {\r\n        return Err({ type: \"unknown\", raw: `Workspace ${workspaceId} not found in config` });\r\n      }\r\n      const runtime = createRuntime(metadata.runtimeConfig, {\r\n        projectPath: metadata.projectPath,\r\n        workspaceName: metadata.name,\r\n      });\r\n      // In-place workspaces (CLI/benchmarks) have projectPath === name\r\n      // Use path directly instead of reconstructing via getWorkspacePath\r\n      const isInPlace = metadata.projectPath === metadata.name;\r\n      const workspacePath = isInPlace\r\n        ? metadata.projectPath\r\n        : runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n\r\n      // Wait for init to complete before any runtime I/O operations\r\n      // (SSH/devcontainer may not be ready until init finishes pulling the container)\r\n      await this.initStateManager.waitForInit(workspaceId, combinedAbortSignal);\r\n      if (combinedAbortSignal.aborted) {\r\n        return Ok(undefined);\r\n      }\r\n\r\n      // Verify runtime is actually reachable after init completes.\r\n      // For Docker workspaces, this checks the container exists and starts it if stopped.\r\n      // For Coder workspaces, this may start a stopped workspace and wait for it.\r\n      // If init failed during container creation, ensureReady() will return an error.\r\n      const readyResult = await runtime.ensureReady({\r\n        signal: combinedAbortSignal,\r\n        statusSink: (status) => {\r\n          // Emit runtime-status events for frontend UX (StreamingBarrier)\r\n          this.emit(\"runtime-status\", {\r\n            type: \"runtime-status\",\r\n            workspaceId,\r\n            phase: status.phase,\r\n            runtimeType: status.runtimeType,\r\n            detail: status.detail,\r\n          });\r\n        },\r\n      });\r\n      if (!readyResult.ready) {\r\n        // Generate message ID for the error event (frontend needs this for synthetic message)\r\n        const errorMessageId = createAssistantMessageId();\r\n        const runtimeType = metadata.runtimeConfig?.type ?? \"local\";\r\n        const runtimeLabel = runtimeType === \"docker\" ? \"Container\" : \"Runtime\";\r\n        const errorMessage = readyResult.error || `${runtimeLabel} unavailable.`;\r\n\r\n        // Use the errorType from ensureReady result (runtime_not_ready vs runtime_start_failed)\r\n        const errorType = readyResult.errorType;\r\n\r\n        // Emit error event so frontend receives it via stream subscription.\r\n        // This mirrors the context_exceeded pattern - the fire-and-forget sendMessage\r\n        // call in useCreationWorkspace.ts won't see the returned Err, but will receive\r\n        // this event through the workspace chat subscription.\r\n        this.emit(\r\n          \"error\",\r\n          createErrorEvent(workspaceId, {\r\n            messageId: errorMessageId,\r\n            error: errorMessage,\r\n            errorType,\r\n          })\r\n        );\r\n\r\n        return Err({\r\n          type: errorType,\r\n          message: errorMessage,\r\n        });\r\n      }\r\n\r\n      // Resolve agent definition, compute effective mode & tool policy.\r\n      const cfg = this.config.loadConfigOrDefault();\r\n      const agentResult = await resolveAgentForStream({\r\n        workspaceId,\r\n        metadata,\r\n        runtime,\r\n        workspacePath,\r\n        requestedAgentId: agentId,\r\n        disableWorkspaceAgents: disableWorkspaceAgents ?? false,\r\n        modelString,\r\n        callerToolPolicy: toolPolicy,\r\n        cfg,\r\n        emitError: (event) => this.emit(\"error\", event),\r\n        initStateManager: this.initStateManager,\r\n      });\r\n      if (!agentResult.success) {\r\n        return agentResult;\r\n      }\r\n      const {\r\n        effectiveAgentId,\r\n        agentDefinition,\r\n        agentDiscoveryPath,\r\n        isSubagentWorkspace,\r\n        agentIsPlanLike,\r\n        effectiveMode,\r\n        taskSettings,\r\n        taskDepth,\r\n        shouldDisableTaskToolsForDepth,\r\n        effectiveToolPolicy,\r\n      } = agentResult.data;\r\n      toolNamesForSentinel = agentResult.data.toolNamesForSentinel;\r\n\r\n      // Fetch workspace MCP overrides (for filtering servers and tools)\r\n      // NOTE: Stored in <workspace>/.mux/mcp.local.jsonc (not ~/.mux/config.json).\r\n      let mcpOverrides: WorkspaceMCPOverrides | undefined;\r\n      try {\r\n        mcpOverrides =\r\n          await this.workspaceMcpOverridesService.getOverridesForWorkspace(workspaceId);\r\n      } catch (error) {\r\n        log.warn(\"[MCP] Failed to load workspace MCP overrides; continuing without overrides\", {\r\n          workspaceId,\r\n          error,\r\n        });\r\n        mcpOverrides = undefined;\r\n      }\r\n\r\n      // Fetch MCP server config for system prompt (before building message)\r\n      // Pass overrides to filter out disabled servers\r\n      const mcpServers =\r\n        this.mcpServerManager && workspaceId !== MUX_HELP_CHAT_WORKSPACE_ID\r\n          ? await this.mcpServerManager.listServers(metadata.projectPath, mcpOverrides)\r\n          : undefined;\r\n\r\n      // Build plan-aware instructions and determine planâ†’exec transition content.\r\n      // IMPORTANT: Derive this from the same boundary-sliced message payload that is sent to\r\n      // the model so plan hints/handoffs cannot be suppressed by pre-boundary history.\r\n      const { effectiveAdditionalInstructions, planFilePath, planContentForTransition } =\r\n        await buildPlanInstructions({\r\n          runtime,\r\n          metadata,\r\n          workspaceId,\r\n          workspacePath,\r\n          effectiveMode,\r\n          effectiveAgentId,\r\n          agentIsPlanLike,\r\n          agentDiscoveryPath,\r\n          additionalSystemInstructions,\r\n          shouldDisableTaskToolsForDepth,\r\n          taskDepth,\r\n          taskSettings,\r\n          requestPayloadMessages: providerRequestMessages,\r\n        });\r\n\r\n      // Run the full message preparation pipeline (inject context, transform, validate).\r\n      // This is a purely functional pipeline with no service dependencies.\r\n      const finalMessages = await prepareMessagesForProvider({\r\n        messagesWithSentinel,\r\n        effectiveAgentId,\r\n        toolNamesForSentinel,\r\n        planContentForTransition,\r\n        planFilePath,\r\n        changedFileAttachments,\r\n        postCompactionAttachments,\r\n        runtime,\r\n        workspacePath,\r\n        abortSignal: combinedAbortSignal,\r\n        providerForMessages: canonicalProviderName,\r\n        effectiveThinkingLevel,\r\n        modelString,\r\n        workspaceId,\r\n      });\r\n\r\n      // Build agent system prompt, system message, and discover agents/skills.\r\n      const {\r\n        agentSystemPrompt,\r\n        systemMessage,\r\n        systemMessageTokens,\r\n        agentDefinitions,\r\n        availableSkills,\r\n      } = await buildStreamSystemContext({\r\n        runtime,\r\n        metadata,\r\n        workspacePath,\r\n        workspaceId,\r\n        agentDefinition,\r\n        agentDiscoveryPath,\r\n        isSubagentWorkspace,\r\n        effectiveAdditionalInstructions,\r\n        modelString,\r\n        cfg,\r\n        mcpServers,\r\n      });\r\n\r\n      // Load project secrets (system workspace never gets secrets injected)\r\n      const projectSecrets =\r\n        workspaceId === MUX_HELP_CHAT_WORKSPACE_ID\r\n          ? []\r\n          : this.config.getEffectiveSecrets(metadata.projectPath);\r\n\r\n      // Generate stream token and create temp directory for tools\r\n      const streamToken = this.streamManager.generateStreamToken();\r\n\r\n      let mcpTools: Record<string, Tool> | undefined;\r\n      let mcpStats: MCPWorkspaceStats | undefined;\r\n      let mcpSetupDurationMs = 0;\r\n\r\n      if (this.mcpServerManager && workspaceId !== MUX_HELP_CHAT_WORKSPACE_ID) {\r\n        const start = Date.now();\r\n        try {\r\n          const result = await this.mcpServerManager.getToolsForWorkspace({\r\n            workspaceId,\r\n            projectPath: metadata.projectPath,\r\n            runtime,\r\n            workspacePath,\r\n            overrides: mcpOverrides,\r\n            projectSecrets: secretsToRecord(projectSecrets),\r\n          });\r\n\r\n          mcpTools = result.tools;\r\n          mcpStats = result.stats;\r\n        } catch (error) {\r\n          workspaceLog.error(\"Failed to start MCP servers\", { error });\r\n        } finally {\r\n          mcpSetupDurationMs = Date.now() - start;\r\n        }\r\n      }\r\n\r\n      const runtimeTempDir = await this.streamManager.createTempDirForStream(streamToken, runtime);\r\n\r\n      // Extract tool-specific instructions from AGENTS.md files and agent definition\r\n      const toolInstructions = await readToolInstructions(\r\n        metadata,\r\n        runtime,\r\n        workspacePath,\r\n        modelString,\r\n        agentSystemPrompt\r\n      );\r\n\r\n      // Calculate cumulative session costs for MUX_COSTS_USD env var\r\n      let sessionCostsUsd: number | undefined;\r\n      if (this.sessionUsageService) {\r\n        const sessionUsage = await this.sessionUsageService.getSessionUsage(workspaceId);\r\n        if (sessionUsage) {\r\n          const allUsage = sumUsageHistory(Object.values(sessionUsage.byModel));\r\n          sessionCostsUsd = getTotalCost(allUsage);\r\n        }\r\n      }\r\n\r\n      // Get model-specific tools with workspace path (correct for local or remote)\r\n      const allTools = await getToolsForModel(\r\n        modelString,\r\n        {\r\n          cwd: workspacePath,\r\n          runtime,\r\n          secrets: secretsToRecord(projectSecrets),\r\n          muxEnv: getMuxEnv(\r\n            metadata.projectPath,\r\n            getRuntimeType(metadata.runtimeConfig),\r\n            metadata.name,\r\n            {\r\n              modelString,\r\n              thinkingLevel: thinkingLevel ?? \"off\",\r\n              costsUsd: sessionCostsUsd,\r\n            }\r\n          ),\r\n          runtimeTempDir,\r\n          backgroundProcessManager: this.backgroundProcessManager,\r\n          // Plan agent configuration for plan file access.\r\n          // - read: plan file is readable in all agents (useful context)\r\n          // - write: enforced by file_edit_* tools (plan file is read-only outside plan agent)\r\n          planFileOnly: agentIsPlanLike,\r\n          emitChatEvent: (event) => {\r\n            // Defensive: tools should only emit events for the workspace they belong to.\r\n            if (\"workspaceId\" in event && event.workspaceId !== workspaceId) {\r\n              return;\r\n            }\r\n            this.emit(event.type, event as never);\r\n          },\r\n          workspaceSessionDir: this.config.getSessionDir(workspaceId),\r\n          planFilePath,\r\n          workspaceId,\r\n          // Only child workspaces (tasks) can report to a parent.\r\n          enableAgentReport: Boolean(metadata.parentWorkspaceId),\r\n          // External edit detection callback\r\n          recordFileState,\r\n          taskService: this.taskService,\r\n          // PTC experiments for inheritance to subagents\r\n          experiments,\r\n          // Dynamic context for tool descriptions (moved from system prompt for better model attention)\r\n          availableSubagents: agentDefinitions,\r\n          availableSkills,\r\n        },\r\n        workspaceId,\r\n        this.initStateManager,\r\n        toolInstructions,\r\n        mcpTools\r\n      );\r\n\r\n      // Create assistant message ID early so the PTC callback closure captures it.\r\n      // The placeholder is appended to history below (after abort check).\r\n      const assistantMessageId = createAssistantMessageId();\r\n\r\n      // Apply tool policy and PTC experiments (lazy-loads PTC dependencies only when needed).\r\n      const tools = await applyToolPolicyAndExperiments({\r\n        allTools,\r\n        extraTools: this.extraTools,\r\n        effectiveToolPolicy,\r\n        experiments,\r\n        // Forward nested PTC tool events to the stream (tool-call-start/end only,\r\n        // not console events which appear in final result only).\r\n        emitNestedToolEvent: (event: PTCEventWithParent) => {\r\n          if (event.type === \"tool-call-start\" || event.type === \"tool-call-end\") {\r\n            this.streamManager.emitNestedToolEvent(workspaceId, assistantMessageId, event);\r\n          }\r\n        },\r\n      });\r\n\r\n      captureMcpToolTelemetry({\r\n        telemetryService: this.telemetryService,\r\n        mcpStats,\r\n        mcpTools,\r\n        tools,\r\n        mcpSetupDurationMs,\r\n        workspaceId,\r\n        modelString,\r\n        effectiveAgentId,\r\n        metadata,\r\n        effectiveToolPolicy,\r\n      });\r\n\r\n      if (combinedAbortSignal.aborted) {\r\n        return Ok(undefined);\r\n      }\r\n\r\n      const assistantMessage = createMuxMessage(assistantMessageId, \"assistant\", \"\", {\r\n        timestamp: Date.now(),\r\n        model: canonicalModelString,\r\n        routedThroughGateway,\r\n        systemMessageTokens,\r\n        agentId: effectiveAgentId,\r\n      });\r\n\r\n      // Append to history to get historySequence assigned\r\n      const appendResult = await this.historyService.appendToHistory(workspaceId, assistantMessage);\r\n      if (!appendResult.success) {\r\n        return Err({ type: \"unknown\", raw: appendResult.error });\r\n      }\r\n\r\n      // Get the assigned historySequence\r\n      const historySequence = assistantMessage.metadata?.historySequence ?? 0;\r\n\r\n      // Handle simulated stream scenarios (OpenAI SDK testing features).\r\n      // These emit synthetic stream events without calling an AI provider.\r\n      const forceContextLimitError =\r\n        modelString.startsWith(\"openai:\") &&\r\n        effectiveMuxProviderOptions.openai?.forceContextLimitError === true;\r\n      const simulateToolPolicyNoopFlag =\r\n        modelString.startsWith(\"openai:\") &&\r\n        effectiveMuxProviderOptions.openai?.simulateToolPolicyNoop === true;\r\n\r\n      if (forceContextLimitError || simulateToolPolicyNoopFlag) {\r\n        const simulationCtx: SimulationContext = {\r\n          workspaceId,\r\n          assistantMessageId,\r\n          canonicalModelString,\r\n          routedThroughGateway,\r\n          historySequence,\r\n          systemMessageTokens,\r\n          effectiveAgentId,\r\n          effectiveMode,\r\n          effectiveThinkingLevel,\r\n          emit: (event, data) => this.emit(event, data),\r\n        };\r\n\r\n        if (forceContextLimitError) {\r\n          await simulateContextLimitError(simulationCtx, this.partialService);\r\n        } else {\r\n          await simulateToolPolicyNoop(\r\n            simulationCtx,\r\n            effectiveToolPolicy,\r\n            this.historyService,\r\n            this.partialService\r\n          );\r\n        }\r\n        return Ok(undefined);\r\n      }\r\n\r\n      // Build provider options based on thinking level and request-sliced message history.\r\n      const truncationMode = openaiTruncationModeOverride;\r\n      // Use the same boundary-sliced payload history that we send to the provider.\r\n      // This prevents previousResponseId lookup from reaching pre-compaction epochs.\r\n      // Also pass callback to filter out lost responseIds (OpenAI invalidated them).\r\n      // Pass workspaceId to derive stable promptCacheKey for OpenAI caching.\r\n      const providerOptions = buildProviderOptions(\r\n        modelString,\r\n        effectiveThinkingLevel,\r\n        providerRequestMessages,\r\n        (id) => this.streamManager.isResponseIdLost(id),\r\n        effectiveMuxProviderOptions,\r\n        workspaceId,\r\n        truncationMode\r\n      );\r\n\r\n      // Debug dump: Log the complete LLM request when MUX_DEBUG_LLM_REQUEST is set\r\n      if (process.env.MUX_DEBUG_LLM_REQUEST === \"1\") {\r\n        log.info(\r\n          `[MUX_DEBUG_LLM_REQUEST] Full LLM request:\\n${JSON.stringify(\r\n            {\r\n              workspaceId,\r\n              model: modelString,\r\n              systemMessage,\r\n              messages: finalMessages,\r\n              tools: Object.fromEntries(\r\n                Object.entries(tools).map(([n, t]) => [\r\n                  n,\r\n                  { description: t.description, inputSchema: t.inputSchema },\r\n                ])\r\n              ),\r\n              providerOptions,\r\n              thinkingLevel: effectiveThinkingLevel,\r\n              maxOutputTokens,\r\n              mode: effectiveMode,\r\n              agentId: effectiveAgentId,\r\n              toolPolicy: effectiveToolPolicy,\r\n            },\r\n            null,\r\n            2\r\n          )}`\r\n        );\r\n      }\r\n\r\n      if (combinedAbortSignal.aborted) {\r\n        await deleteAbortedPlaceholder(assistantMessageId);\r\n        return Ok(undefined);\r\n      }\r\n\r\n      // Capture request payload for the debug modal, then delegate to StreamManager.\r\n      const snapshot: DebugLlmRequestSnapshot = {\r\n        capturedAt: Date.now(),\r\n        workspaceId,\r\n        messageId: assistantMessageId,\r\n        model: modelString,\r\n        providerName: canonicalProviderName,\r\n        thinkingLevel: effectiveThinkingLevel,\r\n        mode: effectiveMode,\r\n        agentId: effectiveAgentId,\r\n        maxOutputTokens,\r\n        systemMessage,\r\n        messages: finalMessages,\r\n      };\r\n\r\n      try {\r\n        this.lastLlmRequestByWorkspace.set(workspaceId, safeClone(snapshot));\r\n      } catch (error) {\r\n        const errMsg = error instanceof Error ? error.message : String(error);\r\n        workspaceLog.warn(\"Failed to capture debug LLM request snapshot\", { error: errMsg });\r\n      }\r\n      const toolsForStream =\r\n        experiments?.system1 === true\r\n          ? wrapToolsWithSystem1({\r\n              tools,\r\n              system1Model,\r\n              system1ThinkingLevel,\r\n              modelString,\r\n              effectiveModelString,\r\n              primaryModel: modelResult.data.model,\r\n              muxProviderOptions: effectiveMuxProviderOptions,\r\n              workspaceId,\r\n              effectiveMode,\r\n              planFilePath,\r\n              taskSettings,\r\n              runtimeTempDir,\r\n              runtime,\r\n              agentDiscoveryPath,\r\n              resolveGatewayModelString: (ms, dm, eg) =>\r\n                this.providerModelFactory.resolveGatewayModelString(ms, dm, eg),\r\n              createModel: (ms, o) => this.createModel(ms, o),\r\n              emitBashOutput: (ev) => this.emit(\"bash-output\", ev),\r\n            })\r\n          : tools;\r\n\r\n      const streamResult = await this.streamManager.startStream(\r\n        workspaceId,\r\n        finalMessages,\r\n        modelResult.data.model,\r\n        modelString,\r\n        historySequence,\r\n        systemMessage,\r\n        runtime,\r\n        assistantMessageId, // Shared messageId ensures nested tool events match stream events\r\n        combinedAbortSignal,\r\n        toolsForStream,\r\n        {\r\n          systemMessageTokens,\r\n          timestamp: Date.now(),\r\n          agentId: effectiveAgentId,\r\n          mode: effectiveMode,\r\n          routedThroughGateway,\r\n          ...(modelCostsIncluded(modelResult.data.model) ? { costsIncluded: true } : {}),\r\n        },\r\n        providerOptions,\r\n        maxOutputTokens,\r\n        effectiveToolPolicy,\r\n        streamToken, // Pass the pre-generated stream token\r\n        hasQueuedMessage,\r\n        metadata.name,\r\n        effectiveThinkingLevel\r\n      );\r\n\r\n      if (!streamResult.success) {\r\n        // StreamManager already returns SendMessageError\r\n        return Err(streamResult.error);\r\n      }\r\n\r\n      // If we were interrupted during StreamManager startup before the stream was registered,\r\n      // make sure we don't leave an empty assistant placeholder behind.\r\n      if (combinedAbortSignal.aborted && !this.streamManager.isStreaming(workspaceId)) {\r\n        await deleteAbortedPlaceholder(assistantMessageId);\r\n      }\r\n\r\n      // StreamManager now handles history updates directly on stream-end\r\n      // No need for event listener here\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      log.error(\"Stream message error:\", error);\r\n      // Return as unknown error type\r\n      return Err({ type: \"unknown\", raw: `Failed to stream message: ${errorMessage}` });\r\n    } finally {\r\n      unlinkAbortSignal();\r\n      const pending = this.pendingStreamStarts.get(workspaceId);\r\n      if (pending?.abortController === pendingAbortController) {\r\n        this.pendingStreamStarts.delete(workspaceId);\r\n      }\r\n    }\r\n  }\r\n\r\n  async stopStream(\r\n    workspaceId: string,\r\n    options?: { soft?: boolean; abandonPartial?: boolean; abortReason?: StreamAbortReason }\r\n  ): Promise<Result<void>> {\r\n    const pending = this.pendingStreamStarts.get(workspaceId);\r\n    const isActuallyStreaming =\r\n      this.mockModeEnabled && this.mockAiStreamPlayer\r\n        ? this.mockAiStreamPlayer.isStreaming(workspaceId)\r\n        : this.streamManager.isStreaming(workspaceId);\r\n\r\n    if (pending) {\r\n      pending.abortController.abort();\r\n\r\n      // If we're still in pre-stream startup (no StreamManager stream yet), emit a synthetic\r\n      // stream-abort so the renderer can exit the \"starting...\" UI immediately.\r\n      const abortReason = options?.abortReason ?? \"startup\";\r\n      if (!isActuallyStreaming) {\r\n        this.emit(\"stream-abort\", {\r\n          type: \"stream-abort\",\r\n          workspaceId,\r\n          abortReason,\r\n          messageId: pending.syntheticMessageId,\r\n          metadata: { duration: Date.now() - pending.startTime },\r\n          abandonPartial: options?.abandonPartial,\r\n        } satisfies StreamAbortEvent);\r\n      }\r\n    }\r\n\r\n    if (this.mockModeEnabled && this.mockAiStreamPlayer) {\r\n      this.mockAiStreamPlayer.stop(workspaceId);\r\n      return Ok(undefined);\r\n    }\r\n    return this.streamManager.stopStream(workspaceId, options);\r\n  }\r\n\r\n  /**\r\n   * Check if a workspace is currently streaming\r\n   */\r\n  isStreaming(workspaceId: string): boolean {\r\n    if (this.mockModeEnabled && this.mockAiStreamPlayer) {\r\n      return this.mockAiStreamPlayer.isStreaming(workspaceId);\r\n    }\r\n    return this.streamManager.isStreaming(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Get the current stream state for a workspace\r\n   */\r\n  getStreamState(workspaceId: string): string {\r\n    if (this.mockModeEnabled && this.mockAiStreamPlayer) {\r\n      return this.mockAiStreamPlayer.isStreaming(workspaceId) ? \"streaming\" : \"idle\";\r\n    }\r\n    return this.streamManager.getStreamState(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Get the current stream info for a workspace if actively streaming\r\n   * Used to re-establish streaming context on frontend reconnection\r\n   */\r\n  getStreamInfo(workspaceId: string): ReturnType<typeof this.streamManager.getStreamInfo> {\r\n    if (this.mockModeEnabled && this.mockAiStreamPlayer) {\r\n      return undefined;\r\n    }\r\n    return this.streamManager.getStreamInfo(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Replay stream events\r\n   * Emits the same events that would be emitted during live streaming\r\n   */\r\n  async replayStream(workspaceId: string): Promise<void> {\r\n    if (this.mockModeEnabled && this.mockAiStreamPlayer) {\r\n      await this.mockAiStreamPlayer.replayStream(workspaceId);\r\n      return;\r\n    }\r\n    await this.streamManager.replayStream(workspaceId);\r\n  }\r\n\r\n  debugGetLastMockPrompt(workspaceId: string): Result<MuxMessage[] | null> {\r\n    if (typeof workspaceId !== \"string\" || workspaceId.trim().length === 0) {\r\n      return Err(\"debugGetLastMockPrompt: workspaceId is required\");\r\n    }\r\n\r\n    if (!this.mockModeEnabled || !this.mockAiStreamPlayer) {\r\n      return Ok(null);\r\n    }\r\n\r\n    return Ok(this.mockAiStreamPlayer.debugGetLastPrompt(workspaceId));\r\n  }\r\n  debugGetLastMockModel(workspaceId: string): Result<string | null> {\r\n    if (typeof workspaceId !== \"string\" || workspaceId.trim().length === 0) {\r\n      return Err(\"debugGetLastMockModel: workspaceId is required\");\r\n    }\r\n\r\n    if (!this.mockModeEnabled || !this.mockAiStreamPlayer) {\r\n      return Ok(null);\r\n    }\r\n\r\n    return Ok(this.mockAiStreamPlayer.debugGetLastModel(workspaceId));\r\n  }\r\n\r\n  debugGetLastLlmRequest(workspaceId: string): Result<DebugLlmRequestSnapshot | null> {\r\n    if (typeof workspaceId !== \"string\" || workspaceId.trim().length === 0) {\r\n      return Err(\"debugGetLastLlmRequest: workspaceId is required\");\r\n    }\r\n\r\n    return Ok(this.lastLlmRequestByWorkspace.get(workspaceId) ?? null);\r\n  }\r\n\r\n  /**\r\n   * DEBUG ONLY: Trigger an artificial stream error for testing.\r\n   * This is used by integration tests to simulate network errors mid-stream.\r\n   * @returns true if an active stream was found and error was triggered\r\n   */\r\n  debugTriggerStreamError(\r\n    workspaceId: string,\r\n    errorMessage = \"Test-triggered stream error\"\r\n  ): Promise<boolean> {\r\n    return this.streamManager.debugTriggerStreamError(workspaceId, errorMessage);\r\n  }\r\n\r\n  /**\r\n   * Wait for workspace initialization to complete (if running).\r\n   * Public wrapper for agent discovery and other callers.\r\n   */\r\n  async waitForInit(workspaceId: string, abortSignal?: AbortSignal): Promise<void> {\r\n    return this.initStateManager.waitForInit(workspaceId, abortSignal);\r\n  }\r\n\r\n  async deleteWorkspace(workspaceId: string): Promise<Result<void>> {\r\n    try {\r\n      const workspaceDir = this.config.getSessionDir(workspaceId);\r\n      await fs.rm(workspaceDir, { recursive: true, force: true });\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(`Failed to delete workspace: ${message}`);\r\n    }\r\n  }\r\n}\r\n"]}