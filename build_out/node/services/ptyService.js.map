{"version":3,"file":"ptyService.js","sourceRoot":"","sources":["../../../src/node/services/ptyService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * PTY Service - Manages terminal PTY sessions\n *\n * Handles local, SSH, SSH2, and Docker terminal sessions (node-pty + ssh2).\n * Uses callbacks for output/exit events to avoid circular dependencies.\n */\n\nimport { randomUUID } from \"crypto\";\n\nimport { log } from \"@/node/services/log\";\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport type {\n  TerminalSession,\n  TerminalCreateParams,\n  TerminalResizeParams,\n} from \"@/common/types/terminal\";\nimport type { PtyHandle } from \"@/node/runtime/transports\";\nimport { spawnPtyProcess } from \"@/node/runtime/ptySpawn\";\nimport { SSHRuntime } from \"@/node/runtime/SSHRuntime\";\nimport { LocalBaseRuntime } from \"@/node/runtime/LocalBaseRuntime\";\nimport { DockerRuntime } from \"@/node/runtime/DockerRuntime\";\nimport { DevcontainerRuntime } from \"@/node/runtime/DevcontainerRuntime\";\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\nimport { access } from \"fs/promises\";\nimport { constants } from \"fs\";\nimport { resolveLocalPtyShell } from \"@/node/utils/main/resolveLocalPtyShell\";\n\nfunction shellQuotePath(value: string): string {\n  return `\"${value.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"')}\"`;\n}\n\ninterface SessionData {\n  pty: PtyHandle;\n  workspaceId: string;\n  workspacePath: string;\n  runtime: Runtime;\n  runtimeLabel: string;\n  onData: (data: string) => void;\n  onExit: (exitCode: number) => void;\n}\n\n/**\n * Create a data handler that buffers incomplete escape sequences\n */\nfunction createBufferedDataHandler(onData: (data: string) => void): (data: string) => void {\n  let buffer = \"\";\n  return (data: string) => {\n    buffer += data;\n    let sendUpTo = buffer.length;\n\n    // Hold back incomplete escape sequences\n    if (buffer.endsWith(\"\\x1b\")) {\n      sendUpTo = buffer.length - 1;\n    } else if (buffer.endsWith(\"\\x1b[\")) {\n      sendUpTo = buffer.length - 2;\n    } else {\n      // eslint-disable-next-line no-control-regex, @typescript-eslint/prefer-regexp-exec\n      const match = buffer.match(/\\x1b\\[[0-9;]*$/);\n      if (match) {\n        sendUpTo = buffer.length - match[0].length;\n      }\n    }\n\n    if (sendUpTo > 0) {\n      onData(buffer.substring(0, sendUpTo));\n      buffer = buffer.substring(sendUpTo);\n    }\n  };\n}\n\n/**\n * PTYService - Manages terminal PTY sessions for workspaces\n *\n * Handles local, SSH, SSH2, and Docker terminal sessions (node-pty + ssh2).\n * Each workspace can have one or more terminal sessions.\n */\nexport class PTYService {\n  private sessions = new Map<string, SessionData>();\n\n  /**\n   * Create a new terminal session for a workspace\n   */\n  async createSession(\n    params: TerminalCreateParams,\n    runtime: Runtime,\n    workspacePath: string,\n    onData: (data: string) => void,\n    onExit: (exitCode: number) => void,\n    runtimeConfig?: RuntimeConfig\n  ): Promise<TerminalSession> {\n    // Include a random suffix to avoid collisions when creating multiple sessions quickly.\n    // Collisions can cause two PTYs to appear \"merged\" under one sessionId.\n    const sessionId = `${params.workspaceId}-${Date.now()}-${randomUUID().slice(0, 8)}`;\n    let ptyProcess: PtyHandle | null = null;\n    let runtimeLabel: string;\n\n    if (runtime instanceof SSHRuntime) {\n      ptyProcess = await runtime.createPtySession({\n        workspacePath,\n        cols: params.cols,\n        rows: params.rows,\n      });\n      runtimeLabel = \"SSH\";\n      log.info(`[PTY] SSH terminal for ${sessionId}: ssh ${runtime.getConfig().host}`);\n    } else if (runtime instanceof DevcontainerRuntime) {\n      // Must check before LocalBaseRuntime since DevcontainerRuntime extends it\n      const devcontainerArgs = [\"exec\", \"--workspace-folder\", workspacePath];\n\n      // Include config path for non-default devcontainer.json locations\n      if (runtimeConfig?.type === \"devcontainer\" && runtimeConfig.configPath) {\n        devcontainerArgs.push(\"--config\", runtimeConfig.configPath);\n      }\n\n      devcontainerArgs.push(\"--\", \"/bin/sh\");\n      runtimeLabel = \"Devcontainer\";\n      log.info(\n        `[PTY] Devcontainer terminal for ${sessionId}: devcontainer ${devcontainerArgs.join(\" \")}`\n      );\n\n      ptyProcess = spawnPtyProcess({\n        runtimeLabel,\n        command: \"devcontainer\",\n        args: devcontainerArgs,\n        cwd: workspacePath,\n        cols: params.cols,\n        rows: params.rows,\n        preferElectronBuild: false,\n      });\n    } else if (runtime instanceof LocalBaseRuntime) {\n      try {\n        await access(workspacePath, constants.F_OK);\n      } catch {\n        throw new Error(`Workspace path does not exist: ${workspacePath}`);\n      }\n      const shell = resolveLocalPtyShell();\n      runtimeLabel = \"Local\";\n\n      if (!shell.command.trim()) {\n        throw new Error(\"Cannot spawn Local terminal: empty shell command\");\n      }\n\n      const printableArgs = shell.args.length > 0 ? ` ${shell.args.join(\" \")}` : \"\";\n      log.info(\n        `Spawning PTY: ${shell.command}${printableArgs}, cwd: ${workspacePath}, size: ${params.cols}x${params.rows}`\n      );\n      log.debug(`process.env.SHELL: ${process.env.SHELL ?? \"undefined\"}`);\n      log.debug(`process.env.PATH: ${process.env.PATH ?? process.env.Path ?? \"undefined\"}`);\n\n      ptyProcess = spawnPtyProcess({\n        runtimeLabel,\n        command: shell.command,\n        args: shell.args,\n        cwd: workspacePath,\n        cols: params.cols,\n        rows: params.rows,\n        preferElectronBuild: true,\n        logLocalEnv: true,\n      });\n    } else if (runtime instanceof DockerRuntime) {\n      const containerName = runtime.getContainerName();\n      if (!containerName) {\n        throw new Error(\"Docker container not initialized\");\n      }\n      const dockerArgs = [\n        \"exec\",\n        \"-it\",\n        containerName,\n        \"/bin/sh\",\n        \"-c\",\n        `cd ${shellQuotePath(workspacePath)} && exec /bin/sh`,\n      ];\n      runtimeLabel = \"Docker\";\n      log.info(`[PTY] Docker terminal for ${sessionId}: docker ${dockerArgs.join(\" \")}`);\n\n      ptyProcess = spawnPtyProcess({\n        runtimeLabel,\n        command: \"docker\",\n        args: dockerArgs,\n        cwd: process.cwd(),\n        cols: params.cols,\n        rows: params.rows,\n        preferElectronBuild: false,\n      });\n    } else {\n      throw new Error(`Unsupported runtime type: ${runtime.constructor.name}`);\n    }\n\n    log.info(\n      `Creating terminal session ${sessionId} for workspace ${params.workspaceId} (${runtimeLabel})`\n    );\n    log.info(`[PTY] Terminal size: ${params.cols}x${params.rows}`);\n\n    if (!ptyProcess) {\n      throw new Error(`Failed to initialize ${runtimeLabel} terminal session`);\n    }\n\n    // Wire up handlers\n    ptyProcess.onData(createBufferedDataHandler(onData));\n    ptyProcess.onExit(({ exitCode }) => {\n      log.info(`${runtimeLabel} terminal session ${sessionId} exited with code ${exitCode}`);\n      this.sessions.delete(sessionId);\n      onExit(exitCode);\n    });\n\n    this.sessions.set(sessionId, {\n      pty: ptyProcess,\n      workspaceId: params.workspaceId,\n      workspacePath,\n      runtime,\n      runtimeLabel,\n      onData,\n      onExit,\n    });\n\n    return {\n      sessionId,\n      workspaceId: params.workspaceId,\n      cols: params.cols,\n      rows: params.rows,\n    };\n  }\n\n  /**\n   * Send input to a terminal session\n   */\n  sendInput(sessionId: string, data: string): void {\n    const session = this.sessions.get(sessionId);\n    if (!session?.pty) {\n      log.info(`Cannot send input to session ${sessionId}: not found or no PTY`);\n      return;\n    }\n\n    // Works for both local and SSH now\n    session.pty.write(data);\n  }\n\n  /**\n   * Resize a terminal session\n   */\n  resize(params: TerminalResizeParams): void {\n    const session = this.sessions.get(params.sessionId);\n    if (!session?.pty) {\n      log.info(`Cannot resize terminal session ${params.sessionId}: not found or no PTY`);\n      return;\n    }\n\n    // Now works for both local AND SSH! ðŸŽ‰\n    session.pty.resize(params.cols, params.rows);\n    log.debug(\n      `Resized terminal ${params.sessionId} (${session.runtimeLabel}) to ${params.cols}x${params.rows}`\n    );\n  }\n\n  /**\n   * Close a terminal session\n   */\n  closeSession(sessionId: string): void {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      log.info(`Cannot close terminal session ${sessionId}: not found`);\n      return;\n    }\n\n    log.info(`Closing terminal session ${sessionId}`);\n\n    if (session.pty) {\n      // Works for both local and SSH\n      session.pty.kill();\n    }\n\n    this.sessions.delete(sessionId);\n  }\n\n  /**\n   * Get all session IDs for a workspace.\n   * Used by frontend to discover existing sessions to reattach to after reload.\n   */\n  getWorkspaceSessionIds(workspaceId: string): string[] {\n    return Array.from(this.sessions.entries())\n      .filter(([, session]) => session.workspaceId === workspaceId)\n      .map(([id]) => id);\n  }\n\n  /**\n   * Close all terminal sessions for a workspace\n   */\n  closeWorkspaceSessions(workspaceId: string): void {\n    const sessionIds = Array.from(this.sessions.entries())\n      .filter(([, session]) => session.workspaceId === workspaceId)\n      .map(([id]) => id);\n\n    log.info(`Closing ${sessionIds.length} terminal session(s) for workspace ${workspaceId}`);\n\n    sessionIds.forEach((id) => this.closeSession(id));\n  }\n\n  /**\n   * Close all terminal sessions.\n   * Called during server shutdown to prevent orphan PTY processes.\n   */\n  closeAllSessions(): void {\n    const sessionIds = Array.from(this.sessions.keys());\n    log.info(`Closing all ${sessionIds.length} terminal session(s)`);\n    sessionIds.forEach((id) => this.closeSession(id));\n  }\n\n  /**\n   * Get all sessions for debugging\n   */\n  getSessions(): Map<string, SessionData> {\n    return this.sessions;\n  }\n}\n"]}