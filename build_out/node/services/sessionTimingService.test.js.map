{"version":3,"file":"sessionTimingService.test.js","sourceRoot":"","sources":["../../../src/node/services/sessionTimingService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach, mock } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\n\r\nimport { Config } from \"@/node/config\";\r\nimport { SessionTimingService } from \"./sessionTimingService\";\r\nimport type { TelemetryService } from \"./telemetryService\";\r\nimport { normalizeGatewayModel } from \"@/common/utils/ai/models\";\r\n\r\nfunction createMockTelemetryService(): Pick<TelemetryService, \"capture\" | \"getFeatureFlag\"> {\r\n  return {\r\n    capture: mock(() => undefined),\r\n    getFeatureFlag: mock(() => Promise.resolve(undefined)),\r\n  };\r\n}\r\n\r\nconst sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\r\n\r\ndescribe(\"SessionTimingService\", () => {\r\n  let tempDir: string;\r\n  let config: Config;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = path.join(os.tmpdir(), `mux-session-timing-test-${Date.now()}-${Math.random()}`);\r\n    await fs.mkdir(tempDir, { recursive: true });\r\n    config = new Config(tempDir);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    try {\r\n      await fs.rm(tempDir, { recursive: true, force: true });\r\n    } catch {\r\n      // ignore\r\n    }\r\n  });\r\n\r\n  it(\"persists aborted stream stats to session-timing.json\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 1_000_000;\r\n\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n    });\r\n\r\n    service.handleStreamDelta({\r\n      type: \"stream-delta\",\r\n      workspaceId,\r\n      messageId,\r\n      delta: \"hi\",\r\n      tokens: 5,\r\n      timestamp: startTime + 1000,\r\n    });\r\n\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"echo hi\" },\r\n      tokens: 3,\r\n      timestamp: startTime + 2000,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 3000,\r\n    });\r\n\r\n    service.handleStreamAbort({\r\n      type: \"stream-abort\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: {\r\n        duration: 5000,\r\n        usage: {\r\n          inputTokens: 1,\r\n          outputTokens: 10,\r\n          totalTokens: 11,\r\n          reasoningTokens: 2,\r\n        },\r\n      },\r\n      abortReason: \"system\",\r\n      abandonPartial: true,\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const snapshot = await service.getSnapshot(workspaceId);\r\n    expect(snapshot.lastRequest?.messageId).toBe(messageId);\r\n    expect(snapshot.lastRequest?.totalDurationMs).toBe(5000);\r\n    expect(snapshot.lastRequest?.toolExecutionMs).toBe(1000);\r\n    expect(snapshot.lastRequest?.ttftMs).toBe(1000);\r\n    expect(snapshot.lastRequest?.streamingMs).toBe(3000);\r\n    expect(snapshot.lastRequest?.invalid).toBe(false);\r\n\r\n    expect(snapshot.session?.responseCount).toBe(1);\r\n  });\r\n\r\n  it(\"ignores empty aborted streams\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 1_000_000;\r\n\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n    });\r\n\r\n    service.handleStreamAbort({\r\n      type: \"stream-abort\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: { duration: 1000 },\r\n      abortReason: \"user\",\r\n      abandonPartial: true,\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const snapshot = await service.getSnapshot(workspaceId);\r\n    expect(snapshot.lastRequest).toBeUndefined();\r\n    expect(snapshot.session?.responseCount).toBe(0);\r\n  });\r\n\r\n  describe(\"rollUpTimingIntoParent\", () => {\r\n    it(\"should roll up child timing into parent without changing parent's lastRequest\", async () => {\r\n      const telemetry = createMockTelemetryService();\r\n      const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n      service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n      const projectPath = \"/tmp/mux-session-timing-rollup-test-project\";\r\n      const model = \"openai:gpt-4o\";\r\n\r\n      const parentWorkspaceId = \"parent-workspace\";\r\n      const childWorkspaceId = \"child-workspace\";\r\n\r\n      await config.addWorkspace(projectPath, {\r\n        id: parentWorkspaceId,\r\n        name: \"parent-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n      });\r\n      await config.addWorkspace(projectPath, {\r\n        id: childWorkspaceId,\r\n        name: \"child-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n        parentWorkspaceId: parentWorkspaceId,\r\n      });\r\n\r\n      // Parent stream.\r\n      const parentMessageId = \"p1\";\r\n      const startTimeParent = 1_000_000;\r\n\r\n      service.handleStreamStart({\r\n        type: \"stream-start\",\r\n        workspaceId: parentWorkspaceId,\r\n        messageId: parentMessageId,\r\n        model,\r\n        historySequence: 1,\r\n        startTime: startTimeParent,\r\n        mode: \"exec\",\r\n      });\r\n\r\n      service.handleStreamDelta({\r\n        type: \"stream-delta\",\r\n        workspaceId: parentWorkspaceId,\r\n        messageId: parentMessageId,\r\n        delta: \"hi\",\r\n        tokens: 5,\r\n        timestamp: startTimeParent + 1000,\r\n      });\r\n\r\n      service.handleToolCallStart({\r\n        type: \"tool-call-start\",\r\n        workspaceId: parentWorkspaceId,\r\n        messageId: parentMessageId,\r\n        toolCallId: \"t1\",\r\n        toolName: \"bash\",\r\n        args: { cmd: \"echo hi\" },\r\n        tokens: 3,\r\n        timestamp: startTimeParent + 2000,\r\n      });\r\n\r\n      service.handleToolCallEnd({\r\n        type: \"tool-call-end\",\r\n        workspaceId: parentWorkspaceId,\r\n        messageId: parentMessageId,\r\n        toolCallId: \"t1\",\r\n        toolName: \"bash\",\r\n        result: { ok: true },\r\n        timestamp: startTimeParent + 3000,\r\n      });\r\n\r\n      service.handleStreamEnd({\r\n        type: \"stream-end\",\r\n        workspaceId: parentWorkspaceId,\r\n        messageId: parentMessageId,\r\n        metadata: {\r\n          model,\r\n          duration: 5000,\r\n          usage: {\r\n            inputTokens: 1,\r\n            outputTokens: 10,\r\n            totalTokens: 11,\r\n            reasoningTokens: 2,\r\n          },\r\n        },\r\n        parts: [],\r\n      });\r\n\r\n      // Child stream.\r\n      const childMessageId = \"c1\";\r\n      const startTimeChild = 2_000_000;\r\n\r\n      service.handleStreamStart({\r\n        type: \"stream-start\",\r\n        workspaceId: childWorkspaceId,\r\n        messageId: childMessageId,\r\n        model,\r\n        historySequence: 1,\r\n        startTime: startTimeChild,\r\n        mode: \"exec\",\r\n      });\r\n\r\n      service.handleStreamDelta({\r\n        type: \"stream-delta\",\r\n        workspaceId: childWorkspaceId,\r\n        messageId: childMessageId,\r\n        delta: \"hi\",\r\n        tokens: 5,\r\n        timestamp: startTimeChild + 200,\r\n      });\r\n\r\n      service.handleStreamEnd({\r\n        type: \"stream-end\",\r\n        workspaceId: childWorkspaceId,\r\n        messageId: childMessageId,\r\n        metadata: {\r\n          model,\r\n          duration: 1500,\r\n          usage: {\r\n            inputTokens: 1,\r\n            outputTokens: 5,\r\n            totalTokens: 6,\r\n          },\r\n        },\r\n        parts: [],\r\n      });\r\n\r\n      await service.waitForIdle(parentWorkspaceId);\r\n      await service.waitForIdle(childWorkspaceId);\r\n\r\n      const before = await service.getSnapshot(parentWorkspaceId);\r\n      expect(before.lastRequest?.messageId).toBe(parentMessageId);\r\n\r\n      const beforeLastRequest = before.lastRequest!;\r\n\r\n      const rollupResult = await service.rollUpTimingIntoParent(\r\n        parentWorkspaceId,\r\n        childWorkspaceId\r\n      );\r\n      expect(rollupResult.didRollUp).toBe(true);\r\n\r\n      const after = await service.getSnapshot(parentWorkspaceId);\r\n\r\n      // lastRequest is preserved\r\n      expect(after.lastRequest).toEqual(beforeLastRequest);\r\n\r\n      expect(after.session?.responseCount).toBe(2);\r\n      expect(after.session?.totalDurationMs).toBe(6500);\r\n      expect(after.session?.totalToolExecutionMs).toBe(1000);\r\n      expect(after.session?.totalStreamingMs).toBe(4300);\r\n      expect(after.session?.totalTtftMs).toBe(1200);\r\n      expect(after.session?.ttftCount).toBe(2);\r\n      expect(after.session?.totalOutputTokens).toBe(15);\r\n      expect(after.session?.totalReasoningTokens).toBe(2);\r\n\r\n      const normalizedModel = normalizeGatewayModel(model);\r\n      const key = `${normalizedModel}:exec`;\r\n      expect(after.session?.byModel[key]?.responseCount).toBe(2);\r\n    });\r\n\r\n    it(\"should be idempotent for the same child workspace\", async () => {\r\n      const telemetry = createMockTelemetryService();\r\n      const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n      service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n      const projectPath = \"/tmp/mux-session-timing-rollup-test-project\";\r\n      const model = \"openai:gpt-4o\";\r\n\r\n      const parentWorkspaceId = \"parent-workspace\";\r\n      const childWorkspaceId = \"child-workspace\";\r\n\r\n      await config.addWorkspace(projectPath, {\r\n        id: parentWorkspaceId,\r\n        name: \"parent-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n      });\r\n\r\n      // Child stream.\r\n      const childMessageId = \"c1\";\r\n      const startTimeChild = 2_000_000;\r\n\r\n      service.handleStreamStart({\r\n        type: \"stream-start\",\r\n        workspaceId: childWorkspaceId,\r\n        messageId: childMessageId,\r\n        model,\r\n        historySequence: 1,\r\n        startTime: startTimeChild,\r\n        mode: \"exec\",\r\n      });\r\n\r\n      service.handleStreamDelta({\r\n        type: \"stream-delta\",\r\n        workspaceId: childWorkspaceId,\r\n        messageId: childMessageId,\r\n        delta: \"hi\",\r\n        tokens: 5,\r\n        timestamp: startTimeChild + 200,\r\n      });\r\n\r\n      service.handleStreamEnd({\r\n        type: \"stream-end\",\r\n        workspaceId: childWorkspaceId,\r\n        messageId: childMessageId,\r\n        metadata: {\r\n          model,\r\n          duration: 1500,\r\n          usage: {\r\n            inputTokens: 1,\r\n            outputTokens: 5,\r\n            totalTokens: 6,\r\n          },\r\n        },\r\n        parts: [],\r\n      });\r\n\r\n      await service.waitForIdle(childWorkspaceId);\r\n\r\n      const first = await service.rollUpTimingIntoParent(parentWorkspaceId, childWorkspaceId);\r\n      expect(first.didRollUp).toBe(true);\r\n\r\n      const second = await service.rollUpTimingIntoParent(parentWorkspaceId, childWorkspaceId);\r\n      expect(second.didRollUp).toBe(false);\r\n\r\n      const result = await service.getSnapshot(parentWorkspaceId);\r\n      expect(result.session?.responseCount).toBe(1);\r\n\r\n      const timingFilePath = path.join(\r\n        config.getSessionDir(parentWorkspaceId),\r\n        \"session-timing.json\"\r\n      );\r\n      const raw = await fs.readFile(timingFilePath, \"utf-8\");\r\n      const parsed = JSON.parse(raw) as { rolledUpFrom?: Record<string, true> };\r\n      expect(parsed.rolledUpFrom?.[childWorkspaceId]).toBe(true);\r\n    });\r\n  });\r\n  it(\"persists completed stream stats to session-timing.json\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 1_000_000;\r\n\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n    });\r\n\r\n    service.handleStreamDelta({\r\n      type: \"stream-delta\",\r\n      workspaceId,\r\n      messageId,\r\n      delta: \"hi\",\r\n      tokens: 5,\r\n      timestamp: startTime + 1000,\r\n    });\r\n\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"echo hi\" },\r\n      tokens: 3,\r\n      timestamp: startTime + 2000,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 3000,\r\n    });\r\n\r\n    service.handleStreamEnd({\r\n      type: \"stream-end\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: {\r\n        model,\r\n        duration: 5000,\r\n        usage: {\r\n          inputTokens: 1,\r\n          outputTokens: 10,\r\n          totalTokens: 11,\r\n          reasoningTokens: 2,\r\n        },\r\n      },\r\n      parts: [],\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const filePath = path.join(config.getSessionDir(workspaceId), \"session-timing.json\");\r\n    const raw = await fs.readFile(filePath, \"utf-8\");\r\n    const parsed = JSON.parse(raw) as unknown;\r\n    expect(typeof parsed).toBe(\"object\");\r\n    expect(parsed).not.toBeNull();\r\n\r\n    const file = await service.getSnapshot(workspaceId);\r\n    expect(file.lastRequest?.messageId).toBe(messageId);\r\n    expect(file.lastRequest?.totalDurationMs).toBe(5000);\r\n    expect(file.lastRequest?.toolExecutionMs).toBe(1000);\r\n    expect(file.lastRequest?.ttftMs).toBe(1000);\r\n    expect(file.lastRequest?.streamingMs).toBe(3000);\r\n    expect(file.lastRequest?.invalid).toBe(false);\r\n\r\n    expect(file.session?.responseCount).toBe(1);\r\n    expect(file.session?.totalDurationMs).toBe(5000);\r\n    expect(file.session?.totalToolExecutionMs).toBe(1000);\r\n    expect(file.session?.totalStreamingMs).toBe(3000);\r\n    expect(file.session?.totalOutputTokens).toBe(10);\r\n    expect(file.session?.totalReasoningTokens).toBe(2);\r\n\r\n    const normalizedModel = normalizeGatewayModel(model);\r\n    const key = `${normalizedModel}:exec`;\r\n    expect(file.session?.byModel[key]).toBeDefined();\r\n    expect(file.session?.byModel[key]?.responseCount).toBe(1);\r\n  });\r\n\r\n  it(\"uses agentId for the per-model breakdown when available\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 1_000_000;\r\n\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n      agentId: \"explore\",\r\n    });\r\n\r\n    service.handleStreamDelta({\r\n      type: \"stream-delta\",\r\n      workspaceId,\r\n      messageId,\r\n      delta: \"hi\",\r\n      tokens: 5,\r\n      timestamp: startTime + 100,\r\n    });\r\n\r\n    service.handleStreamEnd({\r\n      type: \"stream-end\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: {\r\n        model,\r\n        duration: 500,\r\n        usage: {\r\n          inputTokens: 1,\r\n          outputTokens: 10,\r\n          totalTokens: 11,\r\n        },\r\n      },\r\n      parts: [],\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const snapshot = await service.getSnapshot(workspaceId);\r\n\r\n    const normalizedModel = normalizeGatewayModel(model);\r\n    const key = `${normalizedModel}:explore`;\r\n\r\n    expect(snapshot.session?.byModel[key]).toBeDefined();\r\n    expect(snapshot.session?.byModel[key]?.agentId).toBe(\"explore\");\r\n    expect(snapshot.session?.byModel[key]?.mode).toBe(\"exec\");\r\n\r\n    // Regression: splitting should not label explore traffic as plain exec.\r\n    expect(snapshot.session?.byModel[`${normalizedModel}:exec`]).toBeUndefined();\r\n  });\r\n\r\n  it(\"ignores replayed events so timing stats aren't double-counted\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 4_000_000;\r\n\r\n    // Normal completed stream\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n    });\r\n\r\n    service.handleStreamDelta({\r\n      type: \"stream-delta\",\r\n      workspaceId,\r\n      messageId,\r\n      delta: \"hi\",\r\n      tokens: 5,\r\n      timestamp: startTime + 1000,\r\n    });\r\n\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"echo hi\" },\r\n      tokens: 3,\r\n      timestamp: startTime + 2000,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 3000,\r\n    });\r\n\r\n    service.handleStreamEnd({\r\n      type: \"stream-end\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: {\r\n        model,\r\n        duration: 5000,\r\n        usage: {\r\n          inputTokens: 1,\r\n          outputTokens: 10,\r\n          totalTokens: 11,\r\n        },\r\n      },\r\n      parts: [],\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const timingFilePath = path.join(config.getSessionDir(workspaceId), \"session-timing.json\");\r\n    const beforeRaw = await fs.readFile(timingFilePath, \"utf-8\");\r\n    const beforeSnapshot = await service.getSnapshot(workspaceId);\r\n\r\n    expect(beforeSnapshot.active).toBeUndefined();\r\n    expect(beforeSnapshot.lastRequest?.messageId).toBe(messageId);\r\n\r\n    // Replay the same events (e.g., reconnect)\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      replay: true,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n    });\r\n\r\n    service.handleStreamDelta({\r\n      type: \"stream-delta\",\r\n      workspaceId,\r\n      messageId,\r\n      replay: true,\r\n      delta: \"hi\",\r\n      tokens: 5,\r\n      timestamp: startTime + 1000,\r\n    });\r\n\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      replay: true,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"echo hi\" },\r\n      tokens: 3,\r\n      timestamp: startTime + 2000,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      replay: true,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 3000,\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const afterRaw = await fs.readFile(timingFilePath, \"utf-8\");\r\n    const afterSnapshot = await service.getSnapshot(workspaceId);\r\n\r\n    expect(afterRaw).toBe(beforeRaw);\r\n\r\n    expect(afterSnapshot.active).toBeUndefined();\r\n    expect(afterSnapshot.lastRequest).toEqual(beforeSnapshot.lastRequest);\r\n    expect(afterSnapshot.session).toEqual(beforeSnapshot.session);\r\n  });\r\n\r\n  it(\"does not double-count overlapping tool calls\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 3_000_000;\r\n\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n      mode: \"exec\",\r\n    });\r\n\r\n    // First token arrives quickly.\r\n    service.handleStreamDelta({\r\n      type: \"stream-delta\",\r\n      workspaceId,\r\n      messageId,\r\n      delta: \"hi\",\r\n      tokens: 2,\r\n      timestamp: startTime + 500,\r\n    });\r\n\r\n    // Two tools overlap: [1000, 3000] and [1500, 4000]\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"sleep 2\" },\r\n      tokens: 1,\r\n      timestamp: startTime + 1000,\r\n    });\r\n\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t2\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"sleep 3\" },\r\n      tokens: 1,\r\n      timestamp: startTime + 1500,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 3000,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t2\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 4000,\r\n    });\r\n\r\n    service.handleStreamEnd({\r\n      type: \"stream-end\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: {\r\n        model,\r\n        duration: 5000,\r\n        usage: {\r\n          inputTokens: 1,\r\n          outputTokens: 1,\r\n          totalTokens: 2,\r\n        },\r\n      },\r\n      parts: [],\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    const snapshot = await service.getSnapshot(workspaceId);\r\n    expect(snapshot.lastRequest?.totalDurationMs).toBe(5000);\r\n\r\n    // Tool wall-time should be the union: [1000, 4000] = 3000ms.\r\n    expect(snapshot.lastRequest?.toolExecutionMs).toBe(3000);\r\n    expect(snapshot.lastRequest?.toolExecutionMs).toBeLessThanOrEqual(\r\n      snapshot.lastRequest?.totalDurationMs ?? 0\r\n    );\r\n\r\n    expect(snapshot.lastRequest?.ttftMs).toBe(500);\r\n    expect(snapshot.lastRequest?.streamingMs).toBe(1500);\r\n    expect(snapshot.lastRequest?.invalid).toBe(false);\r\n  });\r\n\r\n  it(\"emits invalid timing telemetry when tool percent would exceed 100%\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 2_000_000;\r\n\r\n    service.handleStreamStart({\r\n      type: \"stream-start\",\r\n      workspaceId,\r\n      messageId,\r\n      model,\r\n      historySequence: 1,\r\n      startTime,\r\n    });\r\n\r\n    // Tool runs 10s, but we lie in metadata.duration=1s.\r\n    service.handleToolCallStart({\r\n      type: \"tool-call-start\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      args: { cmd: \"sleep\" },\r\n      tokens: 1,\r\n      timestamp: startTime + 100,\r\n    });\r\n\r\n    service.handleToolCallEnd({\r\n      type: \"tool-call-end\",\r\n      workspaceId,\r\n      messageId,\r\n      toolCallId: \"t1\",\r\n      toolName: \"bash\",\r\n      result: { ok: true },\r\n      timestamp: startTime + 10_100,\r\n    });\r\n\r\n    service.handleStreamEnd({\r\n      type: \"stream-end\",\r\n      workspaceId,\r\n      messageId,\r\n      metadata: {\r\n        model,\r\n        duration: 1000,\r\n        usage: {\r\n          inputTokens: 1,\r\n          outputTokens: 1,\r\n          totalTokens: 2,\r\n        },\r\n      },\r\n      parts: [],\r\n    });\r\n\r\n    await service.waitForIdle(workspaceId);\r\n\r\n    expect(telemetry.capture).toHaveBeenCalled();\r\n\r\n    // Bun's mock() returns a callable with `.mock.calls`, but our TelemetryService typing\r\n    // does not expose that. Introspect via unknown.\r\n    const calls = (telemetry.capture as unknown as { mock: { calls: Array<[unknown]> } }).mock\r\n      .calls;\r\n\r\n    const invalidCalls = calls.filter((c) => {\r\n      const payload = c[0];\r\n      if (!payload || typeof payload !== \"object\") {\r\n        return false;\r\n      }\r\n\r\n      return (\r\n        \"event\" in payload && (payload as { event?: unknown }).event === \"stream_timing_invalid\"\r\n      );\r\n    });\r\n\r\n    expect(invalidCalls.length).toBeGreaterThan(0);\r\n  });\r\n\r\n  it(\"throttles delta-driven change events per workspace\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 5_000_000;\r\n\r\n    const onChange = mock<(workspaceId: string) => void>(() => undefined);\r\n\r\n    service.onStatsChange(onChange);\r\n    service.addSubscriber(workspaceId);\r\n\r\n    try {\r\n      service.handleStreamStart({\r\n        type: \"stream-start\",\r\n        workspaceId,\r\n        messageId,\r\n        model,\r\n        historySequence: 1,\r\n        startTime,\r\n        mode: \"exec\",\r\n      });\r\n\r\n      expect(onChange).toHaveBeenCalledTimes(1);\r\n\r\n      // First token should be emitted immediately so TTFT updates promptly.\r\n      service.handleStreamDelta({\r\n        type: \"stream-delta\",\r\n        workspaceId,\r\n        messageId,\r\n        delta: \"hi\",\r\n        tokens: 1,\r\n        timestamp: startTime + 100,\r\n      });\r\n\r\n      expect(onChange).toHaveBeenCalledTimes(2);\r\n\r\n      // Burst of deltas should coalesce into a single trailing emit.\r\n      for (let i = 0; i < 25; i++) {\r\n        service.handleStreamDelta({\r\n          type: \"stream-delta\",\r\n          workspaceId,\r\n          messageId,\r\n          delta: \"x\",\r\n          tokens: 1,\r\n          timestamp: startTime + 200 + i,\r\n        });\r\n      }\r\n\r\n      // Still only the immediate start + first token emits.\r\n      expect(onChange).toHaveBeenCalledTimes(2);\r\n\r\n      await sleep(250);\r\n      expect(onChange).toHaveBeenCalledTimes(3);\r\n\r\n      // Without new deltas, we shouldn't keep emitting.\r\n      await sleep(250);\r\n      expect(onChange).toHaveBeenCalledTimes(3);\r\n    } finally {\r\n      service.offStatsChange(onChange);\r\n      service.removeSubscriber(workspaceId);\r\n    }\r\n  });\r\n\r\n  it(\"clears scheduled delta emits when the last subscriber disconnects\", async () => {\r\n    const telemetry = createMockTelemetryService();\r\n    const service = new SessionTimingService(config, telemetry as unknown as TelemetryService);\r\n    service.setStatsTabState({ enabled: true, variant: \"stats\", override: \"default\" });\r\n\r\n    const workspaceId = \"test-workspace\";\r\n    const messageId = \"m1\";\r\n    const model = \"openai:gpt-4o\";\r\n    const startTime = 6_000_000;\r\n\r\n    const onChange = mock<(workspaceId: string) => void>(() => undefined);\r\n\r\n    service.onStatsChange(onChange);\r\n    service.addSubscriber(workspaceId);\r\n\r\n    try {\r\n      service.handleStreamStart({\r\n        type: \"stream-start\",\r\n        workspaceId,\r\n        messageId,\r\n        model,\r\n        historySequence: 1,\r\n        startTime,\r\n        mode: \"exec\",\r\n      });\r\n\r\n      service.handleStreamDelta({\r\n        type: \"stream-delta\",\r\n        workspaceId,\r\n        messageId,\r\n        delta: \"hi\",\r\n        tokens: 1,\r\n        timestamp: startTime + 100,\r\n      });\r\n\r\n      expect(onChange).toHaveBeenCalledTimes(2);\r\n\r\n      // Schedule a throttled emit.\r\n      service.handleStreamDelta({\r\n        type: \"stream-delta\",\r\n        workspaceId,\r\n        messageId,\r\n        delta: \"x\",\r\n        tokens: 1,\r\n        timestamp: startTime + 200,\r\n      });\r\n\r\n      const deltaEmitState = (\r\n        service as unknown as { deltaEmitState: Map<string, { timer?: unknown }> }\r\n      ).deltaEmitState;\r\n      expect(deltaEmitState.get(workspaceId)?.timer).toBeDefined();\r\n\r\n      // Unsubscribe before the throttle window elapses; timer should be cleared.\r\n      service.removeSubscriber(workspaceId);\r\n      expect(deltaEmitState.has(workspaceId)).toBe(false);\r\n\r\n      await sleep(250);\r\n      expect(onChange).toHaveBeenCalledTimes(2);\r\n    } finally {\r\n      service.offStatsChange(onChange);\r\n      service.removeSubscriber(workspaceId);\r\n    }\r\n  });\r\n});\r\n"]}