{"version":3,"file":"log.js","sourceRoot":"","sources":["../../../src/node/services/log.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Unified logging for mux (backend + CLI)\r\n *\r\n * Features:\r\n * - Log levels: error, warn, info, debug (hierarchical)\r\n * - EPIPE protection for piped output\r\n * - Caller file:line prefix for debugging\r\n * - Colored output in TTY\r\n *\r\n * Log level selection (in priority order):\r\n * 1. MUX_LOG_LEVEL env var (error|warn|info|debug)\r\n * 2. MUX_DEBUG=1 → debug level\r\n * 3. CLI mode (no Electron) → error level (quiet by default)\r\n * 4. Desktop mode → info level\r\n *\r\n * Use log.setLevel() to override programmatically (e.g., --verbose flag).\r\n */\r\n\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport chalk from \"chalk\";\r\nimport { parseBoolEnv } from \"@/common/utils/env\";\r\nimport { getMuxHome } from \"@/common/constants/paths\";\r\n\r\n// Lazy-initialized to avoid circular dependency with config.ts\r\nlet _debugObjDir: string | null = null;\r\nfunction getDebugObjDir(): string {\r\n  _debugObjDir ??= path.join(getMuxHome(), \"debug_obj\");\r\n  return _debugObjDir;\r\n}\r\n\r\n/** Logging types */\r\n\r\nexport type LogFields = Record<string, unknown>;\r\n\r\nexport interface Logger {\r\n  info: (...args: unknown[]) => void;\r\n  warn: (...args: unknown[]) => void;\r\n  error: (...args: unknown[]) => void;\r\n  debug: (...args: unknown[]) => void;\r\n  debug_obj: (filename: string, obj: unknown) => void;\r\n  setLevel: (level: LogLevel) => void;\r\n  getLevel: () => LogLevel;\r\n  isDebugMode: () => boolean;\r\n  withFields: (fields: LogFields) => Logger;\r\n}\r\nexport type LogLevel = \"error\" | \"warn\" | \"info\" | \"debug\";\r\n\r\nconst LOG_LEVEL_PRIORITY: Record<LogLevel, number> = {\r\n  error: 0,\r\n  warn: 1,\r\n  info: 2,\r\n  debug: 3,\r\n};\r\n\r\n/**\r\n * Determine the default log level based on environment\r\n */\r\nfunction getDefaultLogLevel(): LogLevel {\r\n  // Explicit env var takes priority\r\n  const envLevel = process.env.MUX_LOG_LEVEL?.toLowerCase();\r\n  if (envLevel && envLevel in LOG_LEVEL_PRIORITY) {\r\n    return envLevel as LogLevel;\r\n  }\r\n\r\n  // MUX_DEBUG=1 enables debug level\r\n  if (parseBoolEnv(process.env.MUX_DEBUG)) {\r\n    return \"debug\";\r\n  }\r\n\r\n  // CLI mode (no Electron) defaults to error (quiet)\r\n  // Desktop mode defaults to info\r\n  const isElectron = \"electron\" in process.versions;\r\n  return isElectron ? \"info\" : \"error\";\r\n}\r\n\r\nlet currentLogLevel: LogLevel = getDefaultLogLevel();\r\n\r\n/**\r\n * Check if a message at the given level should be logged\r\n */\r\nfunction shouldLog(level: LogLevel): boolean {\r\n  return LOG_LEVEL_PRIORITY[level] <= LOG_LEVEL_PRIORITY[currentLogLevel];\r\n}\r\n\r\n/**\r\n * Check if debug mode is enabled (for backwards compatibility)\r\n */\r\nfunction isDebugMode(): boolean {\r\n  return currentLogLevel === \"debug\";\r\n}\r\n\r\n/**\r\n * Check if we're running in a TTY (terminal) that supports colors\r\n */\r\nfunction supportsColor(): boolean {\r\n  return process.stdout.isTTY ?? false;\r\n}\r\n\r\n// Chalk can be unexpectedly hoisted or partially mocked in certain test runners.\r\n// Guard each style helper to avoid runtime TypeErrors (e.g., dim is not a function).\r\nconst chalkDim =\r\n  typeof (chalk as { dim?: (text: string) => string }).dim === \"function\"\r\n    ? (chalk as { dim: (text: string) => string }).dim\r\n    : (text: string) => text;\r\nconst chalkCyan =\r\n  typeof (chalk as { cyan?: (text: string) => string }).cyan === \"function\"\r\n    ? (chalk as { cyan: (text: string) => string }).cyan\r\n    : (text: string) => text;\r\nconst chalkGray =\r\n  typeof (chalk as { gray?: (text: string) => string }).gray === \"function\"\r\n    ? (chalk as { gray: (text: string) => string }).gray\r\n    : (text: string) => text;\r\nconst chalkRed =\r\n  typeof (chalk as { red?: (text: string) => string }).red === \"function\"\r\n    ? (chalk as { red: (text: string) => string }).red\r\n    : (text: string) => text;\r\nconst chalkYellow =\r\n  typeof (chalk as { yellow?: (text: string) => string }).yellow === \"function\"\r\n    ? (chalk as { yellow: (text: string) => string }).yellow\r\n    : (text: string) => text;\r\n\r\n/**\r\n * Get kitchen time timestamp for logs (12-hour format with milliseconds)\r\n * Format: 8:23.456PM (hours:minutes.milliseconds)\r\n */\r\nfunction getTimestamp(): string {\r\n  const now = new Date();\r\n  let hours = now.getHours();\r\n  const minutes = now.getMinutes();\r\n  const milliseconds = now.getMilliseconds();\r\n\r\n  const ampm = hours >= 12 ? \"PM\" : \"AM\";\r\n  hours = hours % 12;\r\n  hours = hours ? hours : 12; // Convert 0 to 12\r\n\r\n  const mm = String(minutes).padStart(2, \"0\");\r\n  const ms = String(milliseconds).padStart(3, \"0\"); // 3 digits: 000-999\r\n\r\n  return `${hours}:${mm}.${ms}${ampm}`;\r\n}\r\n\r\n/**\r\n * Get the caller's file path and line number from the stack trace\r\n * Returns format: \"path/to/file.ts:123\"\r\n */\r\nfunction getCallerLocation(): string {\r\n  const error = new Error();\r\n  const stack = error.stack?.split(\"\\n\");\r\n\r\n  // Stack trace format:\r\n  // 0: \"Error\"\r\n  // 1: \"    at getCallerLocation (log.ts:X:Y)\"\r\n  // 2: \"    at safePipeLog (log.ts:X:Y)\"\r\n  // 3: \"    at log.info (log.ts:X:Y)\"  or  \"at log.error (log.ts:X:Y)\"\r\n  // 4: \"    at <actual caller> (file.ts:X:Y)\" <- We want this one\r\n\r\n  if (stack && stack.length > 4) {\r\n    const callerLine = stack[4];\r\n    // Extract file path and line number from the stack trace\r\n    // Format: \"    at FunctionName (path/to/file.ts:123:45)\"\r\n    const match = /\\((.+):(\\d+):\\d+\\)/.exec(callerLine) ?? /at (.+):(\\d+):\\d+/.exec(callerLine);\r\n\r\n    if (match) {\r\n      const [, filePath, lineNum] = match;\r\n      // Strip the full path to just show relative path from project root\r\n      const relativePath = filePath.replace(/^.*\\/mux\\//, \"\");\r\n      return `${relativePath}:${lineNum}`;\r\n    }\r\n  }\r\n\r\n  return \"unknown:0\";\r\n}\r\n\r\n/**\r\n * Pipe-safe logging function with styled timestamp and caller location\r\n * Format: 8:23.456PM src/main.ts:23 <message>\r\n * @param level - Log level\r\n * @param args - Arguments to log\r\n */\r\nfunction safePipeLog(level: LogLevel, ...args: unknown[]): void {\r\n  // Check if this level should be logged\r\n  if (!shouldLog(level)) {\r\n    return;\r\n  }\r\n\r\n  const timestamp = getTimestamp();\r\n  const location = getCallerLocation();\r\n  const useColor = supportsColor();\r\n\r\n  // Apply colors based on level (if terminal supports it)\r\n  let prefix: string;\r\n  if (useColor) {\r\n    const coloredTimestamp = chalkDim(timestamp);\r\n    const coloredLocation = chalkCyan(location);\r\n\r\n    if (level === \"error\") {\r\n      prefix = `${coloredTimestamp} ${coloredLocation}`;\r\n    } else if (level === \"warn\") {\r\n      prefix = `${coloredTimestamp} ${coloredLocation}`;\r\n    } else if (level === \"debug\") {\r\n      prefix = `${coloredTimestamp} ${chalkGray(location)}`;\r\n    } else {\r\n      // info\r\n      prefix = `${coloredTimestamp} ${coloredLocation}`;\r\n    }\r\n  } else {\r\n    // No colors\r\n    prefix = `${timestamp} ${location}`;\r\n  }\r\n\r\n  try {\r\n    if (level === \"error\") {\r\n      // Color the entire error message red if supported\r\n      if (useColor) {\r\n        console.error(\r\n          prefix,\r\n          ...args.map((arg) => (typeof arg === \"string\" ? chalkRed(arg) : arg))\r\n        );\r\n      } else {\r\n        console.error(prefix, ...args);\r\n      }\r\n    } else if (level === \"warn\") {\r\n      // Color the entire warning message yellow if supported\r\n      if (useColor) {\r\n        console.error(\r\n          prefix,\r\n          ...args.map((arg) => (typeof arg === \"string\" ? chalkYellow(arg) : arg))\r\n        );\r\n      } else {\r\n        console.error(prefix, ...args);\r\n      }\r\n    } else {\r\n      // info and debug go to stdout\r\n      console.log(prefix, ...args);\r\n    }\r\n  } catch (error) {\r\n    // Silently ignore EPIPE and other console errors\r\n    const errorCode =\r\n      error && typeof error === \"object\" && \"code\" in error ? error.code : undefined;\r\n    const errorMessage =\r\n      error && typeof error === \"object\" && \"message\" in error\r\n        ? String(error.message)\r\n        : \"Unknown error\";\r\n\r\n    if (errorCode !== \"EPIPE\") {\r\n      try {\r\n        const stream = level === \"error\" || level === \"warn\" ? process.stderr : process.stdout;\r\n        stream.write(`${timestamp} ${location} Console error: ${errorMessage}\\n`);\r\n      } catch {\r\n        // Even the fallback might fail, just ignore\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Dump an object to a JSON file in the debug_obj directory (only in debug mode)\r\n * @param filename - Name of the file (can include subdirectories like \"workspace_id/file.json\")\r\n * @param obj - Object to serialize and dump\r\n */\r\nfunction debugObject(filename: string, obj: unknown): void {\r\n  if (!isDebugMode()) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Ensure debug_obj directory exists\r\n    const debugObjDir = getDebugObjDir();\r\n    fs.mkdirSync(debugObjDir, { recursive: true });\r\n\r\n    const filePath = path.join(debugObjDir, filename);\r\n    const dirPath = path.dirname(filePath);\r\n\r\n    // Ensure subdirectories exist\r\n    fs.mkdirSync(dirPath, { recursive: true });\r\n\r\n    // Write the object as pretty-printed JSON\r\n    fs.writeFileSync(filePath, JSON.stringify(obj, null, 2), \"utf-8\");\r\n\r\n    // Log that we dumped the object\r\n    safePipeLog(\"debug\", `Dumped object to ${filePath}`);\r\n  } catch (error) {\r\n    // Don't crash if we can't write debug files\r\n    safePipeLog(\"error\", `Failed to dump debug object to ${filename}:`, error);\r\n  }\r\n}\r\n\r\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\r\n  if (!value || typeof value !== \"object\") {\r\n    return false;\r\n  }\r\n  if (Array.isArray(value)) {\r\n    return false;\r\n  }\r\n  if (value instanceof Error) {\r\n    return false;\r\n  }\r\n  const proto = Object.getPrototypeOf(value) as object | null;\r\n  return proto === Object.prototype || proto === null;\r\n}\r\n\r\nfunction normalizeFields(fields?: LogFields): LogFields | undefined {\r\n  return fields && Object.keys(fields).length > 0 ? fields : undefined;\r\n}\r\n\r\nfunction mergeLogFields(base?: LogFields, extra?: LogFields): LogFields | undefined {\r\n  return normalizeFields({ ...(base ?? {}), ...(extra ?? {}) });\r\n}\r\n\r\nconst baseLogger = {\r\n  debug_obj: debugObject,\r\n  setLevel: (level: LogLevel): void => {\r\n    currentLogLevel = level;\r\n  },\r\n  getLevel: (): LogLevel => currentLogLevel,\r\n  isDebugMode,\r\n};\r\nfunction appendFieldsToArgs(args: unknown[], fields?: LogFields): unknown[] {\r\n  if (!fields) {\r\n    return args;\r\n  }\r\n  if (args.length === 0) {\r\n    return [fields];\r\n  }\r\n  const lastArg = args[args.length - 1];\r\n  if (isPlainObject(lastArg)) {\r\n    return [...args.slice(0, -1), { ...fields, ...lastArg }];\r\n  }\r\n  return [...args, fields];\r\n}\r\n\r\nfunction createLogger(boundFields?: LogFields): Logger {\r\n  const normalizedFields = normalizeFields(boundFields);\r\n  const logAtLevel =\r\n    (level: LogLevel) =>\r\n    (...args: unknown[]): void => {\r\n      safePipeLog(level, ...appendFieldsToArgs(args, normalizedFields));\r\n    };\r\n\r\n  return {\r\n    ...baseLogger,\r\n    info: logAtLevel(\"info\"),\r\n    warn: logAtLevel(\"warn\"),\r\n    error: logAtLevel(\"error\"),\r\n    debug: logAtLevel(\"debug\"),\r\n    withFields: (fields: LogFields): Logger =>\r\n      createLogger(mergeLogFields(normalizedFields, fields)),\r\n  };\r\n}\r\n\r\n/**\r\n * Unified logging interface for mux\r\n *\r\n * Log levels (hierarchical - each includes all levels above it):\r\n * - error: Critical failures only\r\n * - warn: Warnings + errors\r\n * - info: Informational + warnings + errors\r\n * - debug: Everything (verbose)\r\n *\r\n * Default levels:\r\n * - CLI mode: error (quiet by default)\r\n * - Desktop mode: info\r\n * - MUX_DEBUG=1: debug\r\n * - MUX_LOG_LEVEL=<level>: explicit override\r\n *\r\n * Use log.withFields({ workspaceId }) to create a sub-logger that\r\n * automatically includes fields in every log entry.\r\n */\r\nexport const log = createLogger();\r\n"]}