{"version":3,"file":"log.js","sourceRoot":"","sources":["../../../src/node/services/log.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Unified logging for mux (backend + CLI)\n *\n * Features:\n * - Log levels: error, warn, info, debug (hierarchical)\n * - EPIPE protection for piped output\n * - Caller file:line prefix for debugging\n * - Colored output in TTY\n *\n * Log level selection (in priority order):\n * 1. MUX_LOG_LEVEL env var (error|warn|info|debug)\n * 2. MUX_DEBUG=1 → debug level\n * 3. CLI mode (no Electron) → error level (quiet by default)\n * 4. Desktop mode → info level\n *\n * Use log.setLevel() to override programmatically (e.g., --verbose flag).\n */\n\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport chalk from \"chalk\";\nimport { parseBoolEnv } from \"@/common/utils/env\";\nimport { getMuxHome } from \"@/common/constants/paths\";\n\n// Lazy-initialized to avoid circular dependency with config.ts\nlet _debugObjDir: string | null = null;\nfunction getDebugObjDir(): string {\n  _debugObjDir ??= path.join(getMuxHome(), \"debug_obj\");\n  return _debugObjDir;\n}\n\n/** Logging types */\n\nexport type LogFields = Record<string, unknown>;\n\nexport interface Logger {\n  info: (...args: unknown[]) => void;\n  warn: (...args: unknown[]) => void;\n  error: (...args: unknown[]) => void;\n  debug: (...args: unknown[]) => void;\n  debug_obj: (filename: string, obj: unknown) => void;\n  setLevel: (level: LogLevel) => void;\n  getLevel: () => LogLevel;\n  isDebugMode: () => boolean;\n  withFields: (fields: LogFields) => Logger;\n}\nexport type LogLevel = \"error\" | \"warn\" | \"info\" | \"debug\";\n\nconst LOG_LEVEL_PRIORITY: Record<LogLevel, number> = {\n  error: 0,\n  warn: 1,\n  info: 2,\n  debug: 3,\n};\n\n/**\n * Determine the default log level based on environment\n */\nfunction getDefaultLogLevel(): LogLevel {\n  // Explicit env var takes priority\n  const envLevel = process.env.MUX_LOG_LEVEL?.toLowerCase();\n  if (envLevel && envLevel in LOG_LEVEL_PRIORITY) {\n    return envLevel as LogLevel;\n  }\n\n  // MUX_DEBUG=1 enables debug level\n  if (parseBoolEnv(process.env.MUX_DEBUG)) {\n    return \"debug\";\n  }\n\n  // CLI mode (no Electron) defaults to error (quiet)\n  // Desktop mode defaults to info\n  const isElectron = \"electron\" in process.versions;\n  return isElectron ? \"info\" : \"error\";\n}\n\nlet currentLogLevel: LogLevel = getDefaultLogLevel();\n\n/**\n * Check if a message at the given level should be logged\n */\nfunction shouldLog(level: LogLevel): boolean {\n  return LOG_LEVEL_PRIORITY[level] <= LOG_LEVEL_PRIORITY[currentLogLevel];\n}\n\n/**\n * Check if debug mode is enabled (for backwards compatibility)\n */\nfunction isDebugMode(): boolean {\n  return currentLogLevel === \"debug\";\n}\n\n/**\n * Check if we're running in a TTY (terminal) that supports colors\n */\nfunction supportsColor(): boolean {\n  return process.stdout.isTTY ?? false;\n}\n\n// Chalk can be unexpectedly hoisted or partially mocked in certain test runners.\n// Guard each style helper to avoid runtime TypeErrors (e.g., dim is not a function).\nconst chalkDim =\n  typeof (chalk as { dim?: (text: string) => string }).dim === \"function\"\n    ? (chalk as { dim: (text: string) => string }).dim\n    : (text: string) => text;\nconst chalkCyan =\n  typeof (chalk as { cyan?: (text: string) => string }).cyan === \"function\"\n    ? (chalk as { cyan: (text: string) => string }).cyan\n    : (text: string) => text;\nconst chalkGray =\n  typeof (chalk as { gray?: (text: string) => string }).gray === \"function\"\n    ? (chalk as { gray: (text: string) => string }).gray\n    : (text: string) => text;\nconst chalkRed =\n  typeof (chalk as { red?: (text: string) => string }).red === \"function\"\n    ? (chalk as { red: (text: string) => string }).red\n    : (text: string) => text;\nconst chalkYellow =\n  typeof (chalk as { yellow?: (text: string) => string }).yellow === \"function\"\n    ? (chalk as { yellow: (text: string) => string }).yellow\n    : (text: string) => text;\n\n/**\n * Get kitchen time timestamp for logs (12-hour format with milliseconds)\n * Format: 8:23.456PM (hours:minutes.milliseconds)\n */\nfunction getTimestamp(): string {\n  const now = new Date();\n  let hours = now.getHours();\n  const minutes = now.getMinutes();\n  const milliseconds = now.getMilliseconds();\n\n  const ampm = hours >= 12 ? \"PM\" : \"AM\";\n  hours = hours % 12;\n  hours = hours ? hours : 12; // Convert 0 to 12\n\n  const mm = String(minutes).padStart(2, \"0\");\n  const ms = String(milliseconds).padStart(3, \"0\"); // 3 digits: 000-999\n\n  return `${hours}:${mm}.${ms}${ampm}`;\n}\n\n/**\n * Get the caller's file path and line number from the stack trace\n * Returns format: \"path/to/file.ts:123\"\n */\nfunction getCallerLocation(): string {\n  const error = new Error();\n  const stack = error.stack?.split(\"\\n\");\n\n  // Stack trace format:\n  // 0: \"Error\"\n  // 1: \"    at getCallerLocation (log.ts:X:Y)\"\n  // 2: \"    at safePipeLog (log.ts:X:Y)\"\n  // 3: \"    at log.info (log.ts:X:Y)\"  or  \"at log.error (log.ts:X:Y)\"\n  // 4: \"    at <actual caller> (file.ts:X:Y)\" <- We want this one\n\n  if (stack && stack.length > 4) {\n    const callerLine = stack[4];\n    // Extract file path and line number from the stack trace\n    // Format: \"    at FunctionName (path/to/file.ts:123:45)\"\n    const match = /\\((.+):(\\d+):\\d+\\)/.exec(callerLine) ?? /at (.+):(\\d+):\\d+/.exec(callerLine);\n\n    if (match) {\n      const [, filePath, lineNum] = match;\n      // Strip the full path to just show relative path from project root\n      const relativePath = filePath.replace(/^.*\\/mux\\//, \"\");\n      return `${relativePath}:${lineNum}`;\n    }\n  }\n\n  return \"unknown:0\";\n}\n\n/**\n * Pipe-safe logging function with styled timestamp and caller location\n * Format: 8:23.456PM src/main.ts:23 <message>\n * @param level - Log level\n * @param args - Arguments to log\n */\nfunction safePipeLog(level: LogLevel, ...args: unknown[]): void {\n  // Check if this level should be logged\n  if (!shouldLog(level)) {\n    return;\n  }\n\n  const timestamp = getTimestamp();\n  const location = getCallerLocation();\n  const useColor = supportsColor();\n\n  // Apply colors based on level (if terminal supports it)\n  let prefix: string;\n  if (useColor) {\n    const coloredTimestamp = chalkDim(timestamp);\n    const coloredLocation = chalkCyan(location);\n\n    if (level === \"error\") {\n      prefix = `${coloredTimestamp} ${coloredLocation}`;\n    } else if (level === \"warn\") {\n      prefix = `${coloredTimestamp} ${coloredLocation}`;\n    } else if (level === \"debug\") {\n      prefix = `${coloredTimestamp} ${chalkGray(location)}`;\n    } else {\n      // info\n      prefix = `${coloredTimestamp} ${coloredLocation}`;\n    }\n  } else {\n    // No colors\n    prefix = `${timestamp} ${location}`;\n  }\n\n  try {\n    if (level === \"error\") {\n      // Color the entire error message red if supported\n      if (useColor) {\n        console.error(\n          prefix,\n          ...args.map((arg) => (typeof arg === \"string\" ? chalkRed(arg) : arg))\n        );\n      } else {\n        console.error(prefix, ...args);\n      }\n    } else if (level === \"warn\") {\n      // Color the entire warning message yellow if supported\n      if (useColor) {\n        console.error(\n          prefix,\n          ...args.map((arg) => (typeof arg === \"string\" ? chalkYellow(arg) : arg))\n        );\n      } else {\n        console.error(prefix, ...args);\n      }\n    } else {\n      // info and debug go to stdout\n      console.log(prefix, ...args);\n    }\n  } catch (error) {\n    // Silently ignore EPIPE and other console errors\n    const errorCode =\n      error && typeof error === \"object\" && \"code\" in error ? error.code : undefined;\n    const errorMessage =\n      error && typeof error === \"object\" && \"message\" in error\n        ? String(error.message)\n        : \"Unknown error\";\n\n    if (errorCode !== \"EPIPE\") {\n      try {\n        const stream = level === \"error\" || level === \"warn\" ? process.stderr : process.stdout;\n        stream.write(`${timestamp} ${location} Console error: ${errorMessage}\\n`);\n      } catch {\n        // Even the fallback might fail, just ignore\n      }\n    }\n  }\n}\n\n/**\n * Dump an object to a JSON file in the debug_obj directory (only in debug mode)\n * @param filename - Name of the file (can include subdirectories like \"workspace_id/file.json\")\n * @param obj - Object to serialize and dump\n */\nfunction debugObject(filename: string, obj: unknown): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  try {\n    // Ensure debug_obj directory exists\n    const debugObjDir = getDebugObjDir();\n    fs.mkdirSync(debugObjDir, { recursive: true });\n\n    const filePath = path.join(debugObjDir, filename);\n    const dirPath = path.dirname(filePath);\n\n    // Ensure subdirectories exist\n    fs.mkdirSync(dirPath, { recursive: true });\n\n    // Write the object as pretty-printed JSON\n    fs.writeFileSync(filePath, JSON.stringify(obj, null, 2), \"utf-8\");\n\n    // Log that we dumped the object\n    safePipeLog(\"debug\", `Dumped object to ${filePath}`);\n  } catch (error) {\n    // Don't crash if we can't write debug files\n    safePipeLog(\"error\", `Failed to dump debug object to ${filename}:`, error);\n  }\n}\n\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\n  if (!value || typeof value !== \"object\") {\n    return false;\n  }\n  if (Array.isArray(value)) {\n    return false;\n  }\n  if (value instanceof Error) {\n    return false;\n  }\n  const proto = Object.getPrototypeOf(value) as object | null;\n  return proto === Object.prototype || proto === null;\n}\n\nfunction normalizeFields(fields?: LogFields): LogFields | undefined {\n  return fields && Object.keys(fields).length > 0 ? fields : undefined;\n}\n\nfunction mergeLogFields(base?: LogFields, extra?: LogFields): LogFields | undefined {\n  return normalizeFields({ ...(base ?? {}), ...(extra ?? {}) });\n}\n\nconst baseLogger = {\n  debug_obj: debugObject,\n  setLevel: (level: LogLevel): void => {\n    currentLogLevel = level;\n  },\n  getLevel: (): LogLevel => currentLogLevel,\n  isDebugMode,\n};\nfunction appendFieldsToArgs(args: unknown[], fields?: LogFields): unknown[] {\n  if (!fields) {\n    return args;\n  }\n  if (args.length === 0) {\n    return [fields];\n  }\n  const lastArg = args[args.length - 1];\n  if (isPlainObject(lastArg)) {\n    return [...args.slice(0, -1), { ...fields, ...lastArg }];\n  }\n  return [...args, fields];\n}\n\nfunction createLogger(boundFields?: LogFields): Logger {\n  const normalizedFields = normalizeFields(boundFields);\n  const logAtLevel =\n    (level: LogLevel) =>\n    (...args: unknown[]): void => {\n      safePipeLog(level, ...appendFieldsToArgs(args, normalizedFields));\n    };\n\n  return {\n    ...baseLogger,\n    info: logAtLevel(\"info\"),\n    warn: logAtLevel(\"warn\"),\n    error: logAtLevel(\"error\"),\n    debug: logAtLevel(\"debug\"),\n    withFields: (fields: LogFields): Logger =>\n      createLogger(mergeLogFields(normalizedFields, fields)),\n  };\n}\n\n/**\n * Unified logging interface for mux\n *\n * Log levels (hierarchical - each includes all levels above it):\n * - error: Critical failures only\n * - warn: Warnings + errors\n * - info: Informational + warnings + errors\n * - debug: Everything (verbose)\n *\n * Default levels:\n * - CLI mode: error (quiet by default)\n * - Desktop mode: info\n * - MUX_DEBUG=1: debug\n * - MUX_LOG_LEVEL=<level>: explicit override\n *\n * Use log.withFields({ workspaceId }) to create a sub-logger that\n * automatically includes fields in every log entry.\n */\nexport const log = createLogger();\n"]}