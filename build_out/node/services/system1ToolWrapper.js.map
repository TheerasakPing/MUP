{"version":3,"file":"system1ToolWrapper.js","sourceRoot":"","sources":["../../../src/node/services/system1ToolWrapper.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * System1 bash output compaction: wraps bash/bash_output/task_await tools so\r\n * large outputs are automatically filtered by a lightweight \"System 1\" LLM\r\n * before being returned to the main conversation.\r\n *\r\n * Extracted from the ~660-line IIFE that lived inside AIService.streamMessage().\r\n */\r\nimport * as path from \"path\";\r\nimport type { LanguageModel, Tool } from \"ai\";\r\nimport {\r\n  applySystem1KeepRangesToOutput,\r\n  formatNumberedLinesForSystem1,\r\n  formatSystem1BashFilterNotice,\r\n  getHeuristicKeepRangesForBashOutput,\r\n  splitBashOutputLines,\r\n} from \"@/node/services/system1/bashOutputFiltering\";\r\nimport { decideBashOutputCompaction } from \"@/node/services/system1/bashCompactionPolicy\";\r\nimport { truncateBashOutput } from \"@/common/utils/truncateBashOutput\";\r\nimport { runSystem1KeepRangesForBashOutput } from \"@/node/services/system1/system1AgentRunner\";\r\nimport {\r\n  formatBashOutputReport,\r\n  tryParseBashOutputReport,\r\n} from \"@/node/services/tools/bashTaskReport\";\r\nimport type { BashOutputEvent } from \"@/common/types/stream\";\r\nimport type { TaskSettings } from \"@/common/types/tasks\";\r\nimport { DEFAULT_TASK_SETTINGS, SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS } from \"@/common/types/tasks\";\r\nimport { normalizeGatewayModel } from \"@/common/utils/ai/models\";\r\nimport { buildProviderOptions } from \"@/common/utils/ai/providerOptions\";\r\nimport { enforceThinkingPolicy } from \"@/common/utils/thinking/policy\";\r\nimport type { ThinkingLevel } from \"@/common/types/thinking\";\r\nimport type { MuxProviderOptions } from \"@/common/types/providerOptions\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport { cloneToolPreservingDescriptors } from \"@/common/utils/tools/cloneToolPreservingDescriptors\";\r\nimport { log } from \"./log\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Public interface\r\n// ---------------------------------------------------------------------------\r\n\r\nexport interface System1WrapOptions {\r\n  tools: Record<string, Tool>;\r\n  /** Raw system1Model string from caller (may be empty). */\r\n  system1Model: string | undefined;\r\n  system1ThinkingLevel: ThinkingLevel | undefined;\r\n  /** The primary model string (used as fallback when system1Model is empty). */\r\n  modelString: string;\r\n  /** Resolved primary model string after gateway resolution. */\r\n  effectiveModelString: string;\r\n  /** Already-created primary model instance. */\r\n  primaryModel: LanguageModel;\r\n  muxProviderOptions: MuxProviderOptions;\r\n  workspaceId: string;\r\n  effectiveMode: string;\r\n  planFilePath: string;\r\n  taskSettings: TaskSettings;\r\n  runtimeTempDir: string;\r\n  runtime: Runtime;\r\n  agentDiscoveryPath: string;\r\n  /** Callbacks to break the dependency on AIService / StreamManager. */\r\n  resolveGatewayModelString: (\r\n    modelString: string,\r\n    defaultModel?: string,\r\n    explicitGateway?: boolean\r\n  ) => string;\r\n  createModel: (\r\n    modelString: string,\r\n    opts?: MuxProviderOptions\r\n  ) => Promise<Result<LanguageModel, SendMessageError>>;\r\n  emitBashOutput: (event: BashOutputEvent) => void;\r\n}\r\n\r\n/**\r\n * Wrap bash / bash_output / task_await tools with System1 output compaction.\r\n * Returns the wrapped tool map (or the originals unchanged if bash is missing).\r\n */\r\nexport function wrapToolsWithSystem1(opts: System1WrapOptions): Record<string, Tool> {\r\n  const { tools } = opts;\r\n  const baseBashTool = tools.bash;\r\n  if (!baseBashTool) return tools;\r\n\r\n  const bashExecuteFn = getExecuteFn(baseBashTool);\r\n  if (!bashExecuteFn) return tools;\r\n\r\n  const bashOutputExecuteFn = getExecuteFn(tools.bash_output);\r\n  const taskAwaitExecuteFn = getExecuteFn(tools.task_await);\r\n\r\n  // Resolve System1 model configuration\r\n  const system1Ctx = buildSystem1ModelContext(opts);\r\n\r\n  // Lazy-create and cache the System1 model for the duration of this stream.\r\n  let cachedSystem1Model: { modelString: string; model: LanguageModel } | undefined;\r\n  let cachedSystem1ModelFailed = false;\r\n\r\n  const getSystem1Model = async (): Promise<\r\n    { modelString: string; model: LanguageModel } | undefined\r\n  > => {\r\n    if (!system1Ctx.modelString) {\r\n      return { modelString: opts.effectiveModelString, model: opts.primaryModel };\r\n    }\r\n    if (cachedSystem1Model) return cachedSystem1Model;\r\n    if (cachedSystem1ModelFailed) return undefined;\r\n\r\n    const resolvedModelString = opts.resolveGatewayModelString(\r\n      system1Ctx.modelString,\r\n      undefined,\r\n      system1Ctx.explicitGateway\r\n    );\r\n    const created = await opts.createModel(resolvedModelString, opts.muxProviderOptions);\r\n    if (!created.success) {\r\n      cachedSystem1ModelFailed = true;\r\n      log.debug(\"[system1] Failed to create System 1 model\", {\r\n        workspaceId: opts.workspaceId,\r\n        system1Model: system1Ctx.modelString,\r\n        error: created.error,\r\n      });\r\n      return undefined;\r\n    }\r\n\r\n    cachedSystem1Model = { modelString: resolvedModelString, model: created.data };\r\n    return cachedSystem1Model;\r\n  };\r\n\r\n  // Core filtering function shared by all three wrapped tools.\r\n  const maybeFilter = (params: FilterParams) =>\r\n    maybeFilterBashOutput({\r\n      ...params,\r\n      opts,\r\n      system1Ctx,\r\n      getSystem1Model,\r\n    });\r\n\r\n  // Build wrapped tool map\r\n  const wrappedTools: Record<string, Tool> = {\r\n    ...tools,\r\n    bash: wrapBashTool(baseBashTool, bashExecuteFn, maybeFilter, opts.workspaceId),\r\n  };\r\n\r\n  if (tools.bash_output && bashOutputExecuteFn) {\r\n    wrappedTools.bash_output = wrapBashOutputTool(\r\n      tools.bash_output,\r\n      bashOutputExecuteFn,\r\n      maybeFilter,\r\n      opts.workspaceId\r\n    );\r\n  }\r\n\r\n  if (tools.task_await && taskAwaitExecuteFn) {\r\n    wrappedTools.task_await = wrapTaskAwaitTool(\r\n      tools.task_await,\r\n      taskAwaitExecuteFn,\r\n      maybeFilter,\r\n      opts.workspaceId\r\n    );\r\n  }\r\n\r\n  return wrappedTools;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Tool helpers (moved from module-level in aiService.ts)\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Concatenate an extra note onto a tool result's existing note. */\r\nfunction appendToolNote(existing: string | undefined, extra: string): string {\r\n  return existing ? `${existing}\\n\\n${extra}` : extra;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Internal helpers\r\n// ---------------------------------------------------------------------------\r\n\r\ntype ExecuteFn = (this: unknown, args: unknown, options: unknown) => Promise<unknown>;\r\n\r\nfunction getExecuteFn(tool: Tool | undefined): ExecuteFn | undefined {\r\n  if (!tool) return undefined;\r\n  const record = tool as unknown as Record<string, unknown>;\r\n  const execute = record.execute;\r\n  return typeof execute === \"function\" ? (execute as ExecuteFn) : undefined;\r\n}\r\n\r\ninterface System1ModelContext {\r\n  modelString: string;\r\n  explicitGateway: boolean;\r\n  thinkingLevel: ThinkingLevel;\r\n}\r\n\r\nfunction buildSystem1ModelContext(opts: System1WrapOptions): System1ModelContext {\r\n  const raw = typeof opts.system1Model === \"string\" ? opts.system1Model.trim() : \"\";\r\n  const modelString = raw ? normalizeGatewayModel(raw) : \"\";\r\n  const explicitGateway = raw.startsWith(\"mux-gateway:\");\r\n  const effectiveModelForThinking = modelString || opts.modelString;\r\n  const thinkingLevel = enforceThinkingPolicy(\r\n    effectiveModelForThinking,\r\n    opts.system1ThinkingLevel ?? \"off\"\r\n  );\r\n  return { modelString, explicitGateway, thinkingLevel };\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Core filtering logic\r\n// ---------------------------------------------------------------------------\r\n\r\ninterface FilterParams {\r\n  toolName: string;\r\n  output: string;\r\n  script: string;\r\n  displayName?: string;\r\n  toolCallId?: string;\r\n  abortSignal?: AbortSignal;\r\n}\r\n\r\ninterface FilterDeps {\r\n  opts: System1WrapOptions;\r\n  system1Ctx: System1ModelContext;\r\n  getSystem1Model: () => Promise<{ modelString: string; model: LanguageModel } | undefined>;\r\n}\r\n\r\nasync function maybeFilterBashOutput(\r\n  params: FilterParams & FilterDeps\r\n): Promise<{ filteredOutput: string; notice: string } | undefined> {\r\n  const { opts, system1Ctx, getSystem1Model, ...filterParams } = params;\r\n\r\n  if (typeof filterParams.output !== \"string\" || filterParams.output.length === 0) {\r\n    return undefined;\r\n  }\r\n\r\n  // Hard truncation safety net â€” bounds output even when System1 is skipped.\r\n  const hardTruncation = truncateBashOutput(filterParams.output);\r\n  const returnHardTruncationIfNeeded = ():\r\n    | { filteredOutput: string; notice: string }\r\n    | undefined => {\r\n    if (!hardTruncation.truncated) return undefined;\r\n    return {\r\n      filteredOutput: hardTruncation.output,\r\n      notice: `Output exceeded hard limits (${hardTruncation.originalLines} lines, ${hardTruncation.originalBytes} bytes). Showing last ${hardTruncation.output.split(\"\\n\").length} lines.`,\r\n    };\r\n  };\r\n\r\n  let system1TimedOut = false;\r\n\r\n  try {\r\n    const taskSettings = opts.taskSettings;\r\n    const minLines =\r\n      taskSettings.bashOutputCompactionMinLines ??\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinLines.default;\r\n    const minTotalBytes =\r\n      taskSettings.bashOutputCompactionMinTotalBytes ??\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMinTotalBytes.default;\r\n    const userMaxKeptLines =\r\n      taskSettings.bashOutputCompactionMaxKeptLines ??\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionMaxKeptLines.default;\r\n    const heuristicFallbackEnabled =\r\n      taskSettings.bashOutputCompactionHeuristicFallback ??\r\n      DEFAULT_TASK_SETTINGS.bashOutputCompactionHeuristicFallback ??\r\n      true;\r\n    const timeoutMs =\r\n      taskSettings.bashOutputCompactionTimeoutMs ??\r\n      SYSTEM1_BASH_OUTPUT_COMPACTION_LIMITS.bashOutputCompactionTimeoutMs.default;\r\n\r\n    const lines = splitBashOutputLines(filterParams.output);\r\n    const bytes = Buffer.byteLength(filterParams.output, \"utf-8\");\r\n\r\n    const decision = decideBashOutputCompaction({\r\n      toolName: filterParams.toolName,\r\n      script: filterParams.script,\r\n      displayName: filterParams.displayName,\r\n      planFilePath: opts.effectiveMode === \"plan\" ? opts.planFilePath : undefined,\r\n      totalLines: lines.length,\r\n      totalBytes: bytes,\r\n      minLines,\r\n      minTotalBytes,\r\n      maxKeptLines: userMaxKeptLines,\r\n    });\r\n\r\n    const { triggeredByLines, triggeredByBytes } = decision;\r\n\r\n    if (!triggeredByLines && !triggeredByBytes) {\r\n      return returnHardTruncationIfNeeded();\r\n    }\r\n\r\n    if (!decision.shouldCompact) {\r\n      log.debug(\"[system1] Skipping bash output compaction\", {\r\n        workspaceId: opts.workspaceId,\r\n        toolName: filterParams.toolName,\r\n        skipReason: decision.skipReason,\r\n        intent: decision.intent,\r\n        alreadyTargeted: decision.alreadyTargeted,\r\n        displayName: filterParams.displayName,\r\n        totalLines: lines.length,\r\n        totalBytes: bytes,\r\n        triggeredByLines,\r\n        triggeredByBytes,\r\n        minLines,\r\n        minTotalBytes,\r\n        userMaxKeptLines,\r\n        heuristicFallbackEnabled,\r\n        timeoutMs,\r\n      });\r\n      return returnHardTruncationIfNeeded();\r\n    }\r\n\r\n    const maxKeptLines = decision.effectiveMaxKeptLines;\r\n\r\n    log.debug(\"[system1] Bash output compaction triggered\", {\r\n      workspaceId: opts.workspaceId,\r\n      toolName: filterParams.toolName,\r\n      intent: decision.intent,\r\n      alreadyTargeted: decision.alreadyTargeted,\r\n      displayName: filterParams.displayName,\r\n      totalLines: lines.length,\r\n      totalBytes: bytes,\r\n      triggeredByLines,\r\n      triggeredByBytes,\r\n      minLines,\r\n      minTotalBytes,\r\n      userMaxKeptLines,\r\n      maxKeptLines,\r\n      heuristicFallbackEnabled,\r\n      timeoutMs,\r\n    });\r\n\r\n    // Save full output to temp file for agent reference\r\n    let fullOutputPath: string | undefined;\r\n    try {\r\n      const fileId = Math.random().toString(16).substring(2, 10);\r\n      fullOutputPath = path.posix.join(opts.runtimeTempDir, `bash-full-${fileId}.txt`);\r\n      const writer = opts.runtime.writeFile(fullOutputPath, filterParams.abortSignal);\r\n      const writerInstance = writer.getWriter();\r\n      await writerInstance.write(new TextEncoder().encode(filterParams.output));\r\n      await writerInstance.close();\r\n    } catch (error) {\r\n      log.debug(\"[system1] Failed to save full bash output to temp file\", {\r\n        workspaceId: opts.workspaceId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      fullOutputPath = undefined;\r\n    }\r\n\r\n    const system1 = await getSystem1Model();\r\n    if (!system1) return undefined;\r\n\r\n    const system1ProviderOptions = buildProviderOptions(\r\n      system1.modelString,\r\n      system1Ctx.thinkingLevel,\r\n      undefined,\r\n      undefined,\r\n      opts.muxProviderOptions,\r\n      opts.workspaceId\r\n    ) as unknown as Record<string, unknown>;\r\n\r\n    const numberedOutput = formatNumberedLinesForSystem1(lines);\r\n    const startTimeMs = Date.now();\r\n\r\n    if (typeof filterParams.toolCallId === \"string\" && filterParams.toolCallId.length > 0) {\r\n      opts.emitBashOutput({\r\n        type: \"bash-output\",\r\n        workspaceId: opts.workspaceId,\r\n        toolCallId: filterParams.toolCallId,\r\n        phase: \"filtering\",\r\n        text: \"\",\r\n        isError: false,\r\n        timestamp: Date.now(),\r\n      } satisfies BashOutputEvent);\r\n    }\r\n\r\n    let filterMethod: \"system1\" | \"heuristic\" = \"system1\";\r\n    let keepRangesCount = 0;\r\n    let finishReason: string | undefined;\r\n    let lastErrorName: string | undefined;\r\n    let lastErrorMessage: string | undefined;\r\n    let applied: ReturnType<typeof applySystem1KeepRangesToOutput> = undefined;\r\n\r\n    try {\r\n      const keepRangesResult = await runSystem1KeepRangesForBashOutput({\r\n        runtime: opts.runtime,\r\n        agentDiscoveryPath: opts.agentDiscoveryPath,\r\n        runtimeTempDir: opts.runtimeTempDir,\r\n        model: system1.model,\r\n        modelString: system1.modelString,\r\n        providerOptions: system1ProviderOptions,\r\n        displayName: filterParams.displayName,\r\n        script: filterParams.script,\r\n        numberedOutput,\r\n        maxKeptLines,\r\n        timeoutMs,\r\n        abortSignal: filterParams.abortSignal,\r\n        onTimeout: () => {\r\n          system1TimedOut = true;\r\n        },\r\n      });\r\n\r\n      if (keepRangesResult) {\r\n        finishReason = keepRangesResult.finishReason;\r\n        keepRangesCount = keepRangesResult.keepRanges.length;\r\n        applied = applySystem1KeepRangesToOutput({\r\n          rawOutput: filterParams.output,\r\n          keepRanges: keepRangesResult.keepRanges,\r\n          maxKeptLines,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      lastErrorName = error instanceof Error ? error.name : undefined;\r\n      lastErrorMessage = error instanceof Error ? error.message : String(error);\r\n    }\r\n\r\n    if (!applied || applied.keptLines === 0) {\r\n      const elapsedMs = Date.now() - startTimeMs;\r\n      const upstreamAborted = filterParams.abortSignal?.aborted ?? false;\r\n\r\n      log.debug(\"[system1] Failed to generate keep_ranges\", {\r\n        workspaceId: opts.workspaceId,\r\n        toolName: filterParams.toolName,\r\n        system1Model: system1.modelString,\r\n        elapsedMs,\r\n        timedOut: system1TimedOut,\r\n        upstreamAborted,\r\n        keepRangesCount,\r\n        errorName: lastErrorName,\r\n        error: lastErrorMessage,\r\n      });\r\n\r\n      if (!heuristicFallbackEnabled || upstreamAborted) return undefined;\r\n\r\n      const heuristicKeepRanges = getHeuristicKeepRangesForBashOutput({ lines, maxKeptLines });\r\n      keepRangesCount = heuristicKeepRanges.length;\r\n      applied = applySystem1KeepRangesToOutput({\r\n        rawOutput: filterParams.output,\r\n        keepRanges: heuristicKeepRanges,\r\n        maxKeptLines,\r\n      });\r\n      filterMethod = \"heuristic\";\r\n    }\r\n\r\n    if (!applied || applied.keptLines === 0) {\r\n      log.debug(\"[system1] keep_ranges produced empty filtered output\", {\r\n        workspaceId: opts.workspaceId,\r\n        toolName: filterParams.toolName,\r\n        filterMethod,\r\n        keepRangesCount,\r\n        maxKeptLines,\r\n        totalLines: lines.length,\r\n      });\r\n      return undefined;\r\n    }\r\n\r\n    const elapsedMs = Date.now() - startTimeMs;\r\n    const trigger = [triggeredByLines ? \"lines\" : null, triggeredByBytes ? \"bytes\" : null]\r\n      .filter(Boolean)\r\n      .join(\"+\");\r\n\r\n    const notice = formatSystem1BashFilterNotice({\r\n      keptLines: applied.keptLines,\r\n      totalLines: applied.totalLines,\r\n      trigger,\r\n      fullOutputPath,\r\n    });\r\n\r\n    log.debug(\"[system1] Filtered bash tool output\", {\r\n      workspaceId: opts.workspaceId,\r\n      toolName: filterParams.toolName,\r\n      intent: decision.intent,\r\n      alreadyTargeted: decision.alreadyTargeted,\r\n      displayName: filterParams.displayName,\r\n      userMaxKeptLines,\r\n      maxKeptLines,\r\n      system1Model: system1.modelString,\r\n      filterMethod,\r\n      keepRangesCount,\r\n      finishReason,\r\n      elapsedMs,\r\n      keptLines: applied.keptLines,\r\n      totalLines: applied.totalLines,\r\n      totalBytes: bytes,\r\n      triggeredByLines,\r\n      triggeredByBytes,\r\n      timeoutMs,\r\n    });\r\n\r\n    return { filteredOutput: applied.filteredOutput, notice };\r\n  } catch (error) {\r\n    const errorMessage = error instanceof Error ? error.message : String(error);\r\n    const errorName = error instanceof Error ? error.name : undefined;\r\n    const upstreamAborted = filterParams.abortSignal?.aborted ?? false;\r\n    const isAbortError = errorName === \"AbortError\";\r\n\r\n    log.debug(\"[system1] Failed to filter bash tool output\", {\r\n      workspaceId: opts.workspaceId,\r\n      toolName: filterParams.toolName,\r\n      error: errorMessage,\r\n      errorName,\r\n      timedOut: system1TimedOut,\r\n      upstreamAborted,\r\n      isAbortError,\r\n    });\r\n    return returnHardTruncationIfNeeded();\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Tool wrappers\r\n// ---------------------------------------------------------------------------\r\n\r\ntype MaybeFilterFn = (\r\n  params: FilterParams\r\n) => Promise<{ filteredOutput: string; notice: string } | undefined>;\r\n\r\n/**\r\n * Merge filtered output into a tool result, appending notice to the note field.\r\n * Returns undefined if the result wasn't filtered (caller should return original).\r\n */\r\nfunction applyFilteredResult(\r\n  result: unknown,\r\n  filtered: { filteredOutput: string; notice: string } | undefined,\r\n  outputField: \"output\" | \"reportMarkdown\" = \"output\"\r\n): Record<string, unknown> | undefined {\r\n  if (!filtered) return undefined;\r\n  const existingNote = (result as { note?: unknown } | undefined)?.note;\r\n  return {\r\n    ...(result as Record<string, unknown>),\r\n    [outputField]: filtered.filteredOutput,\r\n    note: appendToolNote(\r\n      typeof existingNote === \"string\" ? existingNote : undefined,\r\n      filtered.notice\r\n    ),\r\n  };\r\n}\r\n\r\nfunction wrapBashTool(\r\n  baseTool: Tool,\r\n  executeFn: ExecuteFn,\r\n  maybeFilter: MaybeFilterFn,\r\n  workspaceId: string\r\n): Tool {\r\n  const wrapped = cloneToolPreservingDescriptors(baseTool);\r\n  const record = wrapped as unknown as Record<string, unknown>;\r\n\r\n  record.execute = async (args: unknown, options: unknown) => {\r\n    const result: unknown = await executeFn.call(baseTool, args, options);\r\n\r\n    try {\r\n      const runInBackground =\r\n        Boolean((args as { run_in_background?: unknown } | undefined)?.run_in_background) ||\r\n        (result && typeof result === \"object\" && \"backgroundProcessId\" in result);\r\n      if (runInBackground) return result;\r\n\r\n      const output = (result as { output?: unknown } | undefined)?.output;\r\n      if (typeof output !== \"string\" || output.length === 0) return result;\r\n\r\n      const displayName =\r\n        typeof (args as { display_name?: unknown } | undefined)?.display_name === \"string\"\r\n          ? String((args as { display_name?: unknown }).display_name).trim() || undefined\r\n          : undefined;\r\n      const script =\r\n        typeof (args as { script?: unknown } | undefined)?.script === \"string\"\r\n          ? String((args as { script?: unknown }).script)\r\n          : \"\";\r\n      const toolCallId =\r\n        typeof (options as { toolCallId?: unknown } | undefined)?.toolCallId === \"string\"\r\n          ? (options as { toolCallId?: string }).toolCallId\r\n          : undefined;\r\n\r\n      const filtered = await maybeFilter({\r\n        toolName: \"bash\",\r\n        output,\r\n        script,\r\n        displayName,\r\n        toolCallId,\r\n        abortSignal: (options as { abortSignal?: AbortSignal } | undefined)?.abortSignal,\r\n      });\r\n      return applyFilteredResult(result, filtered) ?? result;\r\n    } catch (error) {\r\n      log.debug(\"[system1] Failed to filter bash tool output\", {\r\n        workspaceId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      return result;\r\n    }\r\n  };\r\n\r\n  return wrapped;\r\n}\r\n\r\nfunction wrapBashOutputTool(\r\n  baseTool: Tool,\r\n  executeFn: ExecuteFn,\r\n  maybeFilter: MaybeFilterFn,\r\n  workspaceId: string\r\n): Tool {\r\n  const wrapped = cloneToolPreservingDescriptors(baseTool);\r\n  const record = wrapped as unknown as Record<string, unknown>;\r\n\r\n  record.execute = async (args: unknown, options: unknown) => {\r\n    const result: unknown = await executeFn.call(baseTool, args, options);\r\n\r\n    try {\r\n      const output = (result as { output?: unknown } | undefined)?.output;\r\n      if (typeof output !== \"string\" || output.length === 0) return result;\r\n\r\n      const filtered = await maybeFilter({\r\n        toolName: \"bash_output\",\r\n        output,\r\n        script: \"\",\r\n        abortSignal: (options as { abortSignal?: AbortSignal } | undefined)?.abortSignal,\r\n      });\r\n      return applyFilteredResult(result, filtered) ?? result;\r\n    } catch (error) {\r\n      log.debug(\"[system1] Failed to filter bash_output tool output\", {\r\n        workspaceId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      return result;\r\n    }\r\n  };\r\n\r\n  return wrapped;\r\n}\r\n\r\nfunction wrapTaskAwaitTool(\r\n  baseTool: Tool,\r\n  executeFn: ExecuteFn,\r\n  maybeFilter: MaybeFilterFn,\r\n  workspaceId: string\r\n): Tool {\r\n  const wrapped = cloneToolPreservingDescriptors(baseTool);\r\n  const record = wrapped as unknown as Record<string, unknown>;\r\n\r\n  record.execute = async (args: unknown, options: unknown) => {\r\n    const result: unknown = await executeFn.call(baseTool, args, options);\r\n\r\n    try {\r\n      const resultsValue = (result as { results?: unknown } | undefined)?.results;\r\n      if (!Array.isArray(resultsValue) || resultsValue.length === 0) return result;\r\n\r\n      const abortSignal = (options as { abortSignal?: AbortSignal } | undefined)?.abortSignal;\r\n\r\n      const filteredResults = await Promise.all(\r\n        resultsValue.map(async (entry: unknown) => {\r\n          if (!entry || typeof entry !== \"object\") return entry;\r\n\r\n          const taskId = (entry as { taskId?: unknown }).taskId;\r\n          if (typeof taskId !== \"string\" || !taskId.startsWith(\"bash:\")) return entry;\r\n\r\n          const status = (entry as { status?: unknown }).status;\r\n\r\n          if (status === \"running\") {\r\n            const output = (entry as { output?: unknown }).output;\r\n            if (typeof output !== \"string\" || output.length === 0) return entry;\r\n\r\n            const filtered = await maybeFilter({\r\n              toolName: \"task_await\",\r\n              output,\r\n              script: \"\",\r\n              abortSignal,\r\n            });\r\n            return applyFilteredResult(entry, filtered) ?? entry;\r\n          }\r\n\r\n          if (status === \"completed\") {\r\n            const reportMarkdown = (entry as { reportMarkdown?: unknown }).reportMarkdown;\r\n            if (typeof reportMarkdown !== \"string\" || reportMarkdown.length === 0) return entry;\r\n\r\n            const parsed = tryParseBashOutputReport(reportMarkdown);\r\n            if (!parsed || parsed.output.length === 0) return entry;\r\n\r\n            const filtered = await maybeFilter({\r\n              toolName: \"task_await\",\r\n              output: parsed.output,\r\n              script: \"\",\r\n              abortSignal,\r\n            });\r\n            if (!filtered) return entry;\r\n\r\n            const existingNote = (entry as { note?: unknown }).note;\r\n            return {\r\n              ...(entry as Record<string, unknown>),\r\n              reportMarkdown: formatBashOutputReport({\r\n                processId: parsed.processId,\r\n                status: parsed.status,\r\n                exitCode: parsed.exitCode,\r\n                output: filtered.filteredOutput,\r\n              }),\r\n              note: appendToolNote(\r\n                typeof existingNote === \"string\" ? existingNote : undefined,\r\n                filtered.notice\r\n              ),\r\n            };\r\n          }\r\n\r\n          return entry;\r\n        })\r\n      );\r\n\r\n      return { ...(result as Record<string, unknown>), results: filteredResults };\r\n    } catch (error) {\r\n      log.debug(\"[system1] Failed to filter task_await tool output\", {\r\n        workspaceId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      return result;\r\n    }\r\n  };\r\n\r\n  return wrapped;\r\n}\r\n"]}