{"version":3,"file":"gitPatchArtifactService.js","sourceRoot":"","sources":["../../../src/node/services/gitPatchArtifactService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"node:path\";\r\nimport assert from \"node:assert/strict\";\r\nimport * as fsPromises from \"fs/promises\";\r\n\r\nimport type { Config } from \"@/node/config\";\r\nimport {\r\n  coerceNonEmptyString,\r\n  tryReadGitHeadCommitSha,\r\n  findWorkspaceEntry,\r\n} from \"@/node/services/taskUtils\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { readAgentDefinition } from \"@/node/services/agentDefinitions/agentDefinitionsService\";\r\nimport { resolveAgentInheritanceChain } from \"@/node/services/agentDefinitions/resolveAgentInheritanceChain\";\r\nimport { isExecLikeEditingCapableInResolvedChain } from \"@/common/utils/agentTools\";\r\nimport { createRuntimeForWorkspace } from \"@/node/runtime/runtimeHelpers\";\r\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\r\nimport { AgentIdSchema } from \"@/common/orpc/schemas\";\r\nimport {\r\n  getSubagentGitPatchMboxPath,\r\n  upsertSubagentGitPatchArtifact,\r\n} from \"@/node/services/subagentGitPatchArtifacts\";\r\nimport { shellQuote } from \"@/common/utils/shell\";\r\nimport { streamToString } from \"@/node/runtime/streamUtils\";\r\n\r\n/** Callback invoked after patch generation completes (success or failure). */\r\nexport type OnPatchGenerationComplete = (childWorkspaceId: string) => Promise<void>;\r\n\r\nasync function writeReadableStreamToLocalFile(\r\n  stream: ReadableStream<Uint8Array>,\r\n  filePath: string\r\n): Promise<void> {\r\n  assert(filePath.length > 0, \"writeReadableStreamToLocalFile: filePath must be non-empty\");\r\n\r\n  await fsPromises.mkdir(path.dirname(filePath), { recursive: true });\r\n\r\n  const fileHandle = await fsPromises.open(filePath, \"w\");\r\n  try {\r\n    const reader = stream.getReader();\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n        if (value) {\r\n          await fileHandle.write(value);\r\n        }\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  } finally {\r\n    await fileHandle.close();\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// GitPatchArtifactService\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Handles git-format-patch artifact generation for subagent tasks.\r\n *\r\n * Extracted from TaskService to keep patch-specific logic self-contained.\r\n */\r\nexport class GitPatchArtifactService {\r\n  private readonly pendingJobsByTaskId = new Map<string, Promise<void>>();\r\n\r\n  constructor(private readonly config: Config) {}\r\n\r\n  /**\r\n   * If the child workspace is an exec-like agent, write a pending patch artifact\r\n   * marker and kick off background `git format-patch` generation.\r\n   *\r\n   * @param onComplete - called after generation finishes (success *or* failure),\r\n   *   typically used to trigger reported-leaf-task cleanup.\r\n   */\r\n  async maybeStartGeneration(\r\n    parentWorkspaceId: string,\r\n    childWorkspaceId: string,\r\n    onComplete: OnPatchGenerationComplete\r\n  ): Promise<void> {\r\n    assert(\r\n      parentWorkspaceId.length > 0,\r\n      \"maybeStartGeneration: parentWorkspaceId must be non-empty\"\r\n    );\r\n    assert(childWorkspaceId.length > 0, \"maybeStartGeneration: childWorkspaceId must be non-empty\");\r\n\r\n    const parentSessionDir = this.config.getSessionDir(parentWorkspaceId);\r\n\r\n    // Write a pending marker before we attempt cleanup, so the reported task workspace isn't deleted\r\n    // while we're still reading commits from it.\r\n    const nowMs = Date.now();\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const childEntry = findWorkspaceEntry(cfg, childWorkspaceId);\r\n\r\n    // Only exec-like subagents are expected to make commits that should be handed back to the parent.\r\n    // NOTE: Custom agents can inherit from exec (base: exec). Those should also generate patches,\r\n    // but read-only subagents (e.g. explore) should not.\r\n    const childAgentIdRaw = coerceNonEmptyString(\r\n      childEntry?.workspace.agentId ?? childEntry?.workspace.agentType\r\n    );\r\n    const childAgentId = childAgentIdRaw?.toLowerCase();\r\n    if (!childAgentId) {\r\n      return;\r\n    }\r\n\r\n    let shouldGeneratePatch = childAgentId === \"exec\";\r\n\r\n    if (!shouldGeneratePatch) {\r\n      const parsedChildAgentId = AgentIdSchema.safeParse(childAgentId);\r\n      if (parsedChildAgentId.success) {\r\n        const agentId = parsedChildAgentId.data;\r\n\r\n        // Prefer resolving agent inheritance from the parent workspace: project agents may be untracked\r\n        // (and therefore absent from child worktrees), but they are always present in the parent that\r\n        // spawned the task.\r\n        const agentDiscoveryEntry = findWorkspaceEntry(cfg, parentWorkspaceId) ?? childEntry;\r\n        const agentDiscoveryWs = agentDiscoveryEntry?.workspace;\r\n\r\n        const agentWorkspacePath = coerceNonEmptyString(agentDiscoveryWs?.path);\r\n        const runtimeConfig = agentDiscoveryWs?.runtimeConfig;\r\n\r\n        if (agentDiscoveryEntry && agentWorkspacePath && runtimeConfig) {\r\n          const fallbackName =\r\n            agentWorkspacePath.split(\"/\").pop() ?? agentWorkspacePath.split(\"\\\\\").pop() ?? \"\";\r\n          const workspaceName =\r\n            coerceNonEmptyString(agentDiscoveryWs?.name) ?? coerceNonEmptyString(fallbackName);\r\n\r\n          if (workspaceName) {\r\n            const runtime = createRuntimeForWorkspace({\r\n              runtimeConfig,\r\n              projectPath: agentDiscoveryEntry.projectPath,\r\n              name: workspaceName,\r\n            });\r\n\r\n            try {\r\n              const agentDefinition = await readAgentDefinition(\r\n                runtime,\r\n                agentWorkspacePath,\r\n                agentId\r\n              );\r\n              const chain = await resolveAgentInheritanceChain({\r\n                runtime,\r\n                workspacePath: agentWorkspacePath,\r\n                agentId,\r\n                agentDefinition,\r\n                workspaceId: childWorkspaceId,\r\n              });\r\n\r\n              shouldGeneratePatch = isExecLikeEditingCapableInResolvedChain(chain);\r\n            } catch {\r\n              // ignore - treat as non-exec-like\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!shouldGeneratePatch) {\r\n      return;\r\n    }\r\n\r\n    const baseCommitSha =\r\n      coerceNonEmptyString(childEntry?.workspace.taskBaseCommitSha) ?? undefined;\r\n\r\n    const artifact = await upsertSubagentGitPatchArtifact({\r\n      workspaceId: parentWorkspaceId,\r\n      workspaceSessionDir: parentSessionDir,\r\n      childTaskId: childWorkspaceId,\r\n      updater: (existing) => {\r\n        if (existing && existing.status !== \"pending\") {\r\n          return existing;\r\n        }\r\n\r\n        return {\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"pending\",\r\n          baseCommitSha: baseCommitSha ?? existing?.baseCommitSha,\r\n        };\r\n      },\r\n    });\r\n\r\n    if (artifact.status !== \"pending\") {\r\n      return;\r\n    }\r\n\r\n    if (this.pendingJobsByTaskId.has(childWorkspaceId)) {\r\n      return;\r\n    }\r\n\r\n    let job: Promise<void>;\r\n    try {\r\n      job = this.generate(parentWorkspaceId, childWorkspaceId, onComplete)\r\n        .catch(async (error: unknown) => {\r\n          log.error(\"Subagent git patch generation failed\", {\r\n            parentWorkspaceId,\r\n            childWorkspaceId,\r\n            error,\r\n          });\r\n\r\n          // Best-effort: if generation failed before it could update the artifact status,\r\n          // mark it failed so the parent isn't blocked forever by a pending marker.\r\n          try {\r\n            await upsertSubagentGitPatchArtifact({\r\n              workspaceId: parentWorkspaceId,\r\n              workspaceSessionDir: parentSessionDir,\r\n              childTaskId: childWorkspaceId,\r\n              updater: (existing) => {\r\n                if (existing && existing.status !== \"pending\") {\r\n                  return existing;\r\n                }\r\n\r\n                const failedAtMs = Date.now();\r\n                return {\r\n                  ...(existing ?? {}),\r\n                  childTaskId: childWorkspaceId,\r\n                  parentWorkspaceId,\r\n                  createdAtMs: existing?.createdAtMs ?? failedAtMs,\r\n                  updatedAtMs: failedAtMs,\r\n                  status: \"failed\",\r\n                  error: error instanceof Error ? error.message : String(error),\r\n                };\r\n              },\r\n            });\r\n          } catch (updateError: unknown) {\r\n            log.error(\"Failed to mark subagent git patch artifact as failed\", {\r\n              parentWorkspaceId,\r\n              childWorkspaceId,\r\n              error: updateError,\r\n            });\r\n          }\r\n        })\r\n        .finally(() => {\r\n          this.pendingJobsByTaskId.delete(childWorkspaceId);\r\n        });\r\n    } catch (error: unknown) {\r\n      // If scheduling fails synchronously, don't leave the artifact stuck in `pending`.\r\n      await upsertSubagentGitPatchArtifact({\r\n        workspaceId: parentWorkspaceId,\r\n        workspaceSessionDir: parentSessionDir,\r\n        childTaskId: childWorkspaceId,\r\n        updater: (existing) => {\r\n          if (existing && existing.status !== \"pending\") {\r\n            return existing;\r\n          }\r\n\r\n          const failedAtMs = Date.now();\r\n          return {\r\n            ...(existing ?? {}),\r\n            childTaskId: childWorkspaceId,\r\n            parentWorkspaceId,\r\n            createdAtMs: existing?.createdAtMs ?? failedAtMs,\r\n            updatedAtMs: failedAtMs,\r\n            status: \"failed\",\r\n            error: error instanceof Error ? error.message : String(error),\r\n          };\r\n        },\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.pendingJobsByTaskId.set(childWorkspaceId, job);\r\n  }\r\n\r\n  private async generate(\r\n    parentWorkspaceId: string,\r\n    childWorkspaceId: string,\r\n    onComplete: OnPatchGenerationComplete\r\n  ): Promise<void> {\r\n    assert(parentWorkspaceId.length > 0, \"generate: parentWorkspaceId must be non-empty\");\r\n    assert(childWorkspaceId.length > 0, \"generate: childWorkspaceId must be non-empty\");\r\n\r\n    const parentSessionDir = this.config.getSessionDir(parentWorkspaceId);\r\n\r\n    const updateArtifact = async (\r\n      updater: Parameters<typeof upsertSubagentGitPatchArtifact>[0][\"updater\"]\r\n    ): Promise<void> => {\r\n      await upsertSubagentGitPatchArtifact({\r\n        workspaceId: parentWorkspaceId,\r\n        workspaceSessionDir: parentSessionDir,\r\n        childTaskId: childWorkspaceId,\r\n        updater,\r\n      });\r\n    };\r\n\r\n    const nowMs = Date.now();\r\n\r\n    try {\r\n      const cfg = this.config.loadConfigOrDefault();\r\n      const entry = findWorkspaceEntry(cfg, childWorkspaceId);\r\n\r\n      if (!entry) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          error: \"Task workspace not found in config.\",\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const ws = entry.workspace;\r\n\r\n      const workspacePath = coerceNonEmptyString(ws.path);\r\n      if (!workspacePath) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          error: \"Task workspace path missing.\",\r\n        }));\r\n        return;\r\n      }\r\n\r\n      if (!ws.runtimeConfig) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          error: \"Task runtimeConfig missing.\",\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const fallbackName = workspacePath.split(\"/\").pop() ?? workspacePath.split(\"\\\\\").pop() ?? \"\";\r\n      const workspaceName = coerceNonEmptyString(ws.name) ?? coerceNonEmptyString(fallbackName);\r\n      if (!workspaceName) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          error: \"Task workspace name missing.\",\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const runtime = createRuntimeForWorkspace({\r\n        runtimeConfig: ws.runtimeConfig,\r\n        projectPath: entry.projectPath,\r\n        name: workspaceName,\r\n      });\r\n\r\n      let baseCommitSha = coerceNonEmptyString(ws.taskBaseCommitSha);\r\n      if (!baseCommitSha) {\r\n        const trunkBranch =\r\n          coerceNonEmptyString(ws.taskTrunkBranch) ??\r\n          coerceNonEmptyString(findWorkspaceEntry(cfg, parentWorkspaceId)?.workspace.name);\r\n\r\n        if (!trunkBranch) {\r\n          await updateArtifact((existing) => ({\r\n            ...(existing ?? {}),\r\n            childTaskId: childWorkspaceId,\r\n            parentWorkspaceId,\r\n            createdAtMs: existing?.createdAtMs ?? nowMs,\r\n            updatedAtMs: nowMs,\r\n            status: \"failed\",\r\n            error:\r\n              \"taskBaseCommitSha missing and could not determine trunk branch for merge-base fallback.\",\r\n          }));\r\n          return;\r\n        }\r\n\r\n        const mergeBaseResult = await execBuffered(\r\n          runtime,\r\n          `git merge-base ${shellQuote(trunkBranch)} HEAD`,\r\n          { cwd: workspacePath, timeout: 30 }\r\n        );\r\n        if (mergeBaseResult.exitCode !== 0) {\r\n          await updateArtifact((existing) => ({\r\n            ...(existing ?? {}),\r\n            childTaskId: childWorkspaceId,\r\n            parentWorkspaceId,\r\n            createdAtMs: existing?.createdAtMs ?? nowMs,\r\n            updatedAtMs: nowMs,\r\n            status: \"failed\",\r\n            error: `git merge-base failed: ${mergeBaseResult.stderr.trim() || \"unknown error\"}`,\r\n          }));\r\n          return;\r\n        }\r\n\r\n        baseCommitSha = mergeBaseResult.stdout.trim();\r\n      }\r\n\r\n      const headCommitSha = await tryReadGitHeadCommitSha(runtime, workspacePath);\r\n      if (!headCommitSha) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          error: \"git rev-parse HEAD failed.\",\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const countResult = await execBuffered(\r\n        runtime,\r\n        `git rev-list --count ${baseCommitSha}..${headCommitSha}`,\r\n        { cwd: workspacePath, timeout: 30 }\r\n      );\r\n      if (countResult.exitCode !== 0) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          baseCommitSha,\r\n          headCommitSha,\r\n          error: `git rev-list failed: ${countResult.stderr.trim() || \"unknown error\"}`,\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const commitCount = Number.parseInt(countResult.stdout.trim(), 10);\r\n      if (!Number.isFinite(commitCount) || commitCount < 0) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"failed\",\r\n          baseCommitSha,\r\n          headCommitSha,\r\n          error: `Invalid commit count: ${countResult.stdout.trim()}`,\r\n        }));\r\n        return;\r\n      }\r\n\r\n      if (commitCount === 0) {\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: nowMs,\r\n          status: \"skipped\",\r\n          baseCommitSha,\r\n          headCommitSha,\r\n          commitCount,\r\n          error: undefined,\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const patchPath = getSubagentGitPatchMboxPath(parentSessionDir, childWorkspaceId);\r\n\r\n      const formatPatchStream = await runtime.exec(\r\n        `git format-patch --stdout --binary ${baseCommitSha}..${headCommitSha}`,\r\n        { cwd: workspacePath, timeout: 120 }\r\n      );\r\n      await formatPatchStream.stdin.close();\r\n\r\n      const stderrPromise = streamToString(formatPatchStream.stderr);\r\n      const writePromise = writeReadableStreamToLocalFile(formatPatchStream.stdout, patchPath);\r\n\r\n      const [exitCode, stderr] = await Promise.all([\r\n        formatPatchStream.exitCode,\r\n        stderrPromise,\r\n        writePromise,\r\n      ]);\r\n\r\n      if (exitCode !== 0) {\r\n        // Leave no half-written patches around.\r\n        await fsPromises.rm(patchPath, { force: true });\r\n\r\n        await updateArtifact((existing) => ({\r\n          ...(existing ?? {}),\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          createdAtMs: existing?.createdAtMs ?? nowMs,\r\n          updatedAtMs: Date.now(),\r\n          status: \"failed\",\r\n          baseCommitSha,\r\n          headCommitSha,\r\n          commitCount,\r\n          error: `git format-patch failed (exitCode=${exitCode}): ${stderr.trim() || \"unknown error\"}`,\r\n        }));\r\n        return;\r\n      }\r\n\r\n      await updateArtifact((existing) => ({\r\n        ...(existing ?? {}),\r\n        childTaskId: childWorkspaceId,\r\n        parentWorkspaceId,\r\n        createdAtMs: existing?.createdAtMs ?? nowMs,\r\n        updatedAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha,\r\n        headCommitSha,\r\n        commitCount,\r\n        mboxPath: patchPath,\r\n        error: undefined,\r\n      }));\r\n    } catch (error: unknown) {\r\n      await updateArtifact((existing) => ({\r\n        ...(existing ?? {}),\r\n        childTaskId: childWorkspaceId,\r\n        parentWorkspaceId,\r\n        createdAtMs: existing?.createdAtMs ?? nowMs,\r\n        updatedAtMs: Date.now(),\r\n        status: \"failed\",\r\n        error: error instanceof Error ? error.message : String(error),\r\n      }));\r\n    } finally {\r\n      // Unblock auto-cleanup once the patch generation attempt has finished.\r\n      await onComplete(childWorkspaceId);\r\n    }\r\n  }\r\n}\r\n"]}