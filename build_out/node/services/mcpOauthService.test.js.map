{"version":3,"file":"mcpOauthService.test.js","sourceRoot":"","sources":["../../../src/node/services/mcpOauthService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, beforeEach, afterEach } from \"bun:test\";\nimport { createServer } from \"http\";\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\nimport { Config } from \"@/node/config\";\nimport { MCPConfigService } from \"./mcpConfigService\";\nimport { McpOauthService, parseBearerWwwAuthenticate } from \"./mcpOauthService\";\n\nfunction getStoreFilePath(muxHome: string): string {\n  return path.join(muxHome, \"mcp-oauth.json\");\n}\n\ndescribe(\"McpOauthService store\", () => {\n  let muxHome: string;\n  let projectPath: string;\n  let config: Config;\n  let mcpConfigService: MCPConfigService;\n  let service: McpOauthService;\n\n  const serverName = \"test-server\";\n  const serverUrl = \"https://example.com\";\n\n  beforeEach(async () => {\n    muxHome = await fs.mkdtemp(path.join(os.tmpdir(), \"mcp-oauth-home-\"));\n    projectPath = await fs.mkdtemp(path.join(os.tmpdir(), \"mcp-oauth-project-\"));\n\n    config = new Config(muxHome);\n    mcpConfigService = new MCPConfigService(config);\n    service = new McpOauthService(config, mcpConfigService);\n\n    const addResult = await mcpConfigService.addServer(serverName, {\n      transport: \"http\",\n      url: serverUrl,\n    });\n    expect(addResult).toEqual({ success: true, data: undefined });\n  });\n\n  afterEach(async () => {\n    await service.dispose();\n    await fs.rm(muxHome, { recursive: true, force: true });\n    await fs.rm(projectPath, { recursive: true, force: true });\n  });\n\n  async function readStoreFile(): Promise<unknown> {\n    const raw = await fs.readFile(getStoreFilePath(muxHome), \"utf-8\");\n    return JSON.parse(raw) as unknown;\n  }\n\n  test(\"reading corrupt JSON store self-heals to empty\", async () => {\n    await fs.writeFile(getStoreFilePath(muxHome), \"{ definitely not valid json\", \"utf-8\");\n\n    const status = await service.getAuthStatus({ serverUrl });\n    expect(status).toEqual({\n      serverUrl: \"https://example.com/\",\n      isLoggedIn: false,\n      hasRefreshToken: false,\n      scope: undefined,\n      updatedAtMs: undefined,\n    });\n\n    // The invalid store file should be overwritten with a minimal empty store.\n    expect(await readStoreFile()).toEqual({ version: 2, entries: {} });\n  });\n\n  test(\"migrates v1 store to v2 (dedupes by updatedAtMs)\", async () => {\n    const otherProjectPath = await fs.mkdtemp(path.join(os.tmpdir(), \"mcp-oauth-project2-\"));\n\n    try {\n      const v1Store = {\n        version: 1,\n        entries: {\n          [projectPath]: {\n            // Older duplicate for the same server URL.\n            [serverName]: {\n              serverUrl,\n              updatedAtMs: 1_000,\n              clientInformation: {\n                client_id: \"client-id-old\",\n              },\n              tokens: {\n                access_token: \"access-token-old\",\n                token_type: \"Bearer\",\n                refresh_token: \"refresh-token-old\",\n              },\n            },\n            // Newer duplicate for the same server URL.\n            duplicate: {\n              serverUrl,\n              updatedAtMs: 2_000,\n              clientInformation: {\n                client_id: \"client-id-new\",\n              },\n              tokens: {\n                access_token: \"access-token-new\",\n                token_type: \"Bearer\",\n                refresh_token: \"refresh-token-new\",\n              },\n            },\n          },\n          [otherProjectPath]: {\n            other: {\n              serverUrl: \"https://other.example.com/mcp/\",\n              updatedAtMs: 1_500,\n              clientInformation: {\n                client_id: \"client-id-other\",\n              },\n              tokens: {\n                access_token: \"access-token-other\",\n                token_type: \"Bearer\",\n              },\n            },\n          },\n        },\n      };\n\n      await fs.writeFile(getStoreFilePath(muxHome), JSON.stringify(v1Store), \"utf-8\");\n\n      // Trigger store load + migration.\n      await service.getAuthStatus({ serverUrl });\n\n      expect(await readStoreFile()).toEqual({\n        version: 2,\n        entries: {\n          \"https://example.com/\": {\n            serverUrl: \"https://example.com/\",\n            updatedAtMs: 2_000,\n            clientInformation: {\n              client_id: \"client-id-new\",\n            },\n            tokens: {\n              access_token: \"access-token-new\",\n              token_type: \"Bearer\",\n              refresh_token: \"refresh-token-new\",\n            },\n          },\n          \"https://other.example.com/mcp\": {\n            serverUrl: \"https://other.example.com/mcp\",\n            updatedAtMs: 1_500,\n            clientInformation: {\n              client_id: \"client-id-other\",\n            },\n            tokens: {\n              access_token: \"access-token-other\",\n              token_type: \"Bearer\",\n            },\n          },\n        },\n      });\n    } finally {\n      await fs.rm(otherProjectPath, { recursive: true, force: true });\n    }\n  });\n\n  test(\"set/get/clear works via hasAuthTokens + logout\", async () => {\n    const populatedStore = {\n      version: 2,\n      entries: {\n        \"https://example.com/\": {\n          serverUrl,\n          updatedAtMs: Date.now(),\n          clientInformation: {\n            client_id: \"client-id\",\n          },\n          tokens: {\n            access_token: \"access-token\",\n            token_type: \"Bearer\",\n            refresh_token: \"refresh-token\",\n            scope: \"mcp.read\",\n          },\n        },\n      },\n    };\n    await fs.writeFile(getStoreFilePath(muxHome), JSON.stringify(populatedStore), \"utf-8\");\n\n    expect(\n      await service.hasAuthTokens({\n        serverUrl,\n      })\n    ).toBe(true);\n\n    const status = await service.getAuthStatus({ serverUrl });\n    expect(typeof status.updatedAtMs).toBe(\"number\");\n    expect(status).toEqual({\n      serverUrl: \"https://example.com/\",\n      isLoggedIn: true,\n      hasRefreshToken: true,\n      scope: \"mcp.read\",\n      updatedAtMs: status.updatedAtMs,\n    });\n\n    const logoutResult = await service.logout({ serverUrl });\n    expect(logoutResult).toEqual({ success: true, data: undefined });\n\n    expect(\n      await service.hasAuthTokens({\n        serverUrl,\n      })\n    ).toBe(false);\n\n    expect(await readStoreFile()).toEqual({ version: 2, entries: {} });\n  });\n});\n\ndescribe(\"parseBearerWwwAuthenticate\", () => {\n  test(\"extracts scope and resource_metadata\", () => {\n    const header =\n      'Bearer realm=\"example\", scope=\"mcp.read mcp.write\", resource_metadata=\"https://example.com/.well-known/oauth-protected-resource\"';\n\n    const challenge = parseBearerWwwAuthenticate(header);\n    expect(challenge).not.toBeNull();\n    expect(challenge?.scope).toBe(\"mcp.read mcp.write\");\n    expect(challenge?.resourceMetadataUrl?.toString()).toBe(\n      \"https://example.com/.well-known/oauth-protected-resource\"\n    );\n  });\n\n  test(\"extracts unquoted scope and resource_metadata\", () => {\n    const header =\n      \"Bearer scope=mcp.read resource_metadata=http://example.com/.well-known/oauth-protected-resource\";\n\n    const challenge = parseBearerWwwAuthenticate(header);\n    expect(challenge).not.toBeNull();\n    expect(challenge?.scope).toBe(\"mcp.read\");\n    expect(challenge?.resourceMetadataUrl?.toString()).toBe(\n      \"http://example.com/.well-known/oauth-protected-resource\"\n    );\n  });\n\n  test(\"returns null for non-bearer challenges\", () => {\n    expect(parseBearerWwwAuthenticate('Basic realm=\"example\"')).toBeNull();\n  });\n\n  test(\"ignores invalid resource_metadata URLs\", () => {\n    const header = 'Bearer scope=\"mcp.read\" resource_metadata=\"not a url\"';\n\n    const challenge = parseBearerWwwAuthenticate(header);\n    expect(challenge).not.toBeNull();\n    expect(challenge?.scope).toBe(\"mcp.read\");\n    expect(challenge?.resourceMetadataUrl).toBeUndefined();\n  });\n});\n\ndescribe(\"McpOauthService.startDesktopFlow\", () => {\n  let muxHome: string;\n  let projectPath: string;\n  let config: Config;\n  let mcpConfigService: MCPConfigService;\n  let service: McpOauthService;\n\n  beforeEach(async () => {\n    muxHome = await fs.mkdtemp(path.join(os.tmpdir(), \"mcp-oauth-flow-home-\"));\n    projectPath = await fs.mkdtemp(path.join(os.tmpdir(), \"mcp-oauth-flow-project-\"));\n\n    config = new Config(muxHome);\n    mcpConfigService = new MCPConfigService(config);\n    service = new McpOauthService(config, mcpConfigService);\n  });\n\n  afterEach(async () => {\n    await service.dispose();\n    await fs.rm(muxHome, { recursive: true, force: true });\n    await fs.rm(projectPath, { recursive: true, force: true });\n  });\n\n  test(\"generates an authorizeUrl with PKCE S256 + RFC 8707 resource\", async () => {\n    let baseUrl = \"\";\n    let resourceMetadataUrl = \"\";\n\n    const server = createServer((req, res) => {\n      void (async () => {\n        const pathname = (req.url ?? \"/\").split(\"?\")[0];\n\n        if (pathname === \"/.well-known/oauth-protected-resource\") {\n          res.writeHead(200, { \"content-type\": \"application/json\" });\n          res.end(\n            JSON.stringify({\n              resource: baseUrl,\n              authorization_servers: [baseUrl],\n            })\n          );\n          return;\n        }\n\n        if (pathname === \"/.well-known/oauth-authorization-server\") {\n          res.writeHead(200, { \"content-type\": \"application/json\" });\n          res.end(\n            JSON.stringify({\n              issuer: baseUrl,\n              authorization_endpoint: `${baseUrl}authorize`,\n              token_endpoint: `${baseUrl}token`,\n              registration_endpoint: `${baseUrl}register`,\n              response_types_supported: [\"code\"],\n              code_challenge_methods_supported: [\"S256\"],\n            })\n          );\n          return;\n        }\n\n        if (pathname === \"/register\") {\n          let raw = \"\";\n          for await (const chunk of req) {\n            raw += Buffer.from(chunk as Uint8Array).toString(\"utf-8\");\n          }\n\n          const clientMetadata = JSON.parse(raw) as Record<string, unknown>;\n\n          res.writeHead(200, { \"content-type\": \"application/json\" });\n          res.end(\n            JSON.stringify({\n              ...clientMetadata,\n              client_id: \"test-client-id\",\n            })\n          );\n          return;\n        }\n\n        // Default: act like an MCP server requiring OAuth.\n        res.statusCode = 401;\n        res.setHeader(\n          \"WWW-Authenticate\",\n          `Bearer scope=\"mcp.read\" resource_metadata=\"${resourceMetadataUrl}\"`\n        );\n        res.end(\"Unauthorized\");\n      })();\n    });\n\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\n\n    try {\n      const address = server.address();\n      if (!address || typeof address === \"string\") {\n        throw new Error(\"Failed to bind OAuth test server\");\n      }\n\n      baseUrl = `http://127.0.0.1:${address.port}/`;\n      resourceMetadataUrl = `${baseUrl}.well-known/oauth-protected-resource`;\n\n      const serverName = \"oauth-server\";\n\n      const addResult = await mcpConfigService.addServer(serverName, {\n        transport: \"http\",\n        url: baseUrl,\n      });\n      expect(addResult).toEqual({ success: true, data: undefined });\n\n      const startResult = await service.startDesktopFlow({ projectPath, serverName });\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) {\n        throw new Error(startResult.error);\n      }\n\n      const authorizeUrl = new URL(startResult.data.authorizeUrl);\n      expect(authorizeUrl.searchParams.get(\"code_challenge_method\")).toBe(\"S256\");\n      expect(authorizeUrl.searchParams.get(\"resource\")).toBe(baseUrl);\n\n      // Clean up the loopback listener (no callback will occur during this test).\n      await service.cancelDesktopFlow(startResult.data.flowId);\n    } finally {\n      await new Promise<void>((resolve) => server.close(() => resolve()));\n    }\n  });\n\n  test(\"preserves trailing slashes for OAuth discovery under a base path\", async () => {\n    let baseUrl = \"\";\n    let resourceMetadataUrl = \"\";\n    let authorizationServerBaseUrl = \"\";\n    const seenPaths: string[] = [];\n\n    const server = createServer((req, res) => {\n      void (async () => {\n        const pathname = (req.url ?? \"/\").split(\"?\")[0];\n        seenPaths.push(pathname);\n\n        if (pathname === \"/.well-known/oauth-authorization-server\") {\n          res.writeHead(200, { \"content-type\": \"application/json\" });\n          res.end(\n            JSON.stringify({\n              issuer: authorizationServerBaseUrl,\n              authorization_endpoint: `${authorizationServerBaseUrl}authorize`,\n              token_endpoint: `${authorizationServerBaseUrl}token`,\n              registration_endpoint: `${authorizationServerBaseUrl}register`,\n              response_types_supported: [\"code\"],\n              code_challenge_methods_supported: [\"S256\"],\n            })\n          );\n          return;\n        }\n\n        if (pathname === \"/register\") {\n          let raw = \"\";\n          for await (const chunk of req) {\n            raw += Buffer.from(chunk as Uint8Array).toString(\"utf-8\");\n          }\n\n          const clientMetadata = JSON.parse(raw) as Record<string, unknown>;\n\n          res.writeHead(200, { \"content-type\": \"application/json\" });\n          res.end(\n            JSON.stringify({\n              ...clientMetadata,\n              client_id: \"test-client-id\",\n            })\n          );\n          return;\n        }\n\n        if (pathname === \"/mcp/.well-known/oauth-protected-resource\") {\n          res.writeHead(200, { \"content-type\": \"application/json\" });\n          res.end(\n            JSON.stringify({\n              resource: baseUrl,\n              authorization_servers: [authorizationServerBaseUrl],\n            })\n          );\n          return;\n        }\n\n        if (pathname === \"/mcp/\") {\n          // Default: act like an MCP server requiring OAuth.\n          res.statusCode = 401;\n          res.setHeader(\n            \"WWW-Authenticate\",\n            `Bearer scope=\"mcp.read\" resource_metadata=\"${resourceMetadataUrl}\"`\n          );\n          res.end(\"Unauthorized\");\n          return;\n        }\n\n        // Anything outside of the configured /mcp/ base path should not be used.\n        res.statusCode = 404;\n        res.end(\"Not found\");\n      })();\n    });\n\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\n\n    try {\n      const address = server.address();\n      if (!address || typeof address === \"string\") {\n        throw new Error(\"Failed to bind OAuth test server\");\n      }\n\n      authorizationServerBaseUrl = `http://127.0.0.1:${address.port}/`;\n      baseUrl = `${authorizationServerBaseUrl}mcp/`;\n      resourceMetadataUrl = `${baseUrl}.well-known/oauth-protected-resource`;\n\n      const serverName = \"oauth-server-trailing-slash\";\n\n      const addResult = await mcpConfigService.addServer(serverName, {\n        transport: \"http\",\n        url: baseUrl,\n      });\n      expect(addResult).toEqual({ success: true, data: undefined });\n\n      const startResult = await service.startDesktopFlow({ projectPath, serverName });\n      expect(startResult.success).toBe(true);\n      if (!startResult.success) {\n        throw new Error(startResult.error);\n      }\n\n      const authorizeUrl = new URL(startResult.data.authorizeUrl);\n      expect(authorizeUrl.searchParams.get(\"resource\")).toBe(baseUrl);\n\n      // Ensure we hit the configured /mcp/ path (trailing slash required) and its resource_metadata.\n      expect(seenPaths).toContain(\"/mcp/\");\n      expect(seenPaths).toContain(\"/mcp/.well-known/oauth-protected-resource\");\n\n      // Stored credentials should continue to use a normalized URL for keying.\n      const storeRaw = await fs.readFile(getStoreFilePath(muxHome), \"utf-8\");\n      const serverUrlKey = baseUrl.slice(0, -1);\n      expect(JSON.parse(storeRaw)).toMatchObject({\n        version: 2,\n        entries: {\n          [serverUrlKey]: {\n            serverUrl: serverUrlKey,\n          },\n        },\n      });\n\n      // Clean up the loopback listener (no callback will occur during this test).\n      await service.cancelDesktopFlow(startResult.data.flowId);\n    } finally {\n      await new Promise<void>((resolve) => server.close(() => resolve()));\n    }\n  });\n});\n"]}