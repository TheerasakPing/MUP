{"version":3,"file":"subagentGitPatchArtifacts.js","sourceRoot":"","sources":["../../../src/node/services/subagentGitPatchArtifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fsPromises from \"fs/promises\";\r\nimport * as path from \"node:path\";\r\n\r\nimport writeFileAtomic from \"write-file-atomic\";\r\n\r\nimport type { SubagentGitPatchArtifact } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\r\n\r\nexport interface SubagentGitPatchArtifactsFile {\r\n  version: 1;\r\n  artifactsByChildTaskId: Record<string, SubagentGitPatchArtifact>;\r\n}\r\n\r\nconst SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION = 1 as const;\r\n\r\nconst SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_NAME = \"subagent-patches.json\";\r\nconst SUBAGENT_GIT_PATCH_DIR_NAME = \"subagent-patches\";\r\nconst SUBAGENT_GIT_PATCH_MBOX_FILE_NAME = \"series.mbox\";\r\n\r\nexport function getSubagentGitPatchArtifactsFilePath(workspaceSessionDir: string): string {\r\n  return path.join(workspaceSessionDir, SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_NAME);\r\n}\r\n\r\nexport function getSubagentGitPatchMboxPath(\r\n  workspaceSessionDir: string,\r\n  childTaskId: string\r\n): string {\r\n  return path.join(\r\n    workspaceSessionDir,\r\n    SUBAGENT_GIT_PATCH_DIR_NAME,\r\n    childTaskId,\r\n    SUBAGENT_GIT_PATCH_MBOX_FILE_NAME\r\n  );\r\n}\r\n\r\nexport async function readSubagentGitPatchArtifactsFile(\r\n  workspaceSessionDir: string\r\n): Promise<SubagentGitPatchArtifactsFile> {\r\n  try {\r\n    const filePath = getSubagentGitPatchArtifactsFilePath(workspaceSessionDir);\r\n    const raw = await fsPromises.readFile(filePath, \"utf-8\");\r\n    const parsed = JSON.parse(raw) as unknown;\r\n\r\n    if (!parsed || typeof parsed !== \"object\") {\r\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\r\n    }\r\n\r\n    const obj = parsed as {\r\n      version?: unknown;\r\n      artifactsByChildTaskId?: unknown;\r\n    };\r\n\r\n    const version = obj.version;\r\n    const artifactsByChildTaskId = obj.artifactsByChildTaskId;\r\n\r\n    if (version !== SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION) {\r\n      // Unknown version; treat as empty.\r\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\r\n    }\r\n\r\n    if (!artifactsByChildTaskId || typeof artifactsByChildTaskId !== \"object\") {\r\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\r\n    }\r\n\r\n    return {\r\n      version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION,\r\n      artifactsByChildTaskId: artifactsByChildTaskId as Record<string, SubagentGitPatchArtifact>,\r\n    };\r\n  } catch (error) {\r\n    if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\r\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\r\n    }\r\n\r\n    log.error(\"Failed to read subagent git patch artifacts file\", { error });\r\n    return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\r\n  }\r\n}\r\n\r\nexport async function readSubagentGitPatchArtifact(\r\n  workspaceSessionDir: string,\r\n  childTaskId: string\r\n): Promise<SubagentGitPatchArtifact | null> {\r\n  const file = await readSubagentGitPatchArtifactsFile(workspaceSessionDir);\r\n  return file.artifactsByChildTaskId[childTaskId] ?? null;\r\n}\r\n\r\nexport async function updateSubagentGitPatchArtifactsFile(params: {\r\n  workspaceId: string;\r\n  workspaceSessionDir: string;\r\n  update: (file: SubagentGitPatchArtifactsFile) => void;\r\n}): Promise<SubagentGitPatchArtifactsFile> {\r\n  return workspaceFileLocks.withLock(params.workspaceId, async () => {\r\n    const file = await readSubagentGitPatchArtifactsFile(params.workspaceSessionDir);\r\n    params.update(file);\r\n    try {\r\n      await fsPromises.mkdir(params.workspaceSessionDir, { recursive: true });\r\n      const filePath = getSubagentGitPatchArtifactsFilePath(params.workspaceSessionDir);\r\n      await writeFileAtomic(filePath, JSON.stringify(file, null, 2));\r\n    } catch (error) {\r\n      log.error(\"Failed to write subagent git patch artifacts file\", { error });\r\n    }\r\n    return file;\r\n  });\r\n}\r\n\r\nexport async function upsertSubagentGitPatchArtifact(params: {\r\n  workspaceId: string;\r\n  workspaceSessionDir: string;\r\n  childTaskId: string;\r\n  updater: (existing: SubagentGitPatchArtifact | null) => SubagentGitPatchArtifact;\r\n}): Promise<SubagentGitPatchArtifact> {\r\n  let updated: SubagentGitPatchArtifact | null = null;\r\n\r\n  await updateSubagentGitPatchArtifactsFile({\r\n    workspaceId: params.workspaceId,\r\n    workspaceSessionDir: params.workspaceSessionDir,\r\n    update: (file) => {\r\n      const existing = file.artifactsByChildTaskId[params.childTaskId] ?? null;\r\n      updated = params.updater(existing);\r\n      file.artifactsByChildTaskId[params.childTaskId] = updated;\r\n    },\r\n  });\r\n\r\n  if (!updated) {\r\n    throw new Error(\"upsertSubagentGitPatchArtifact: updater returned no artifact\");\r\n  }\r\n\r\n  return updated;\r\n}\r\n\r\nexport async function markSubagentGitPatchArtifactApplied(params: {\r\n  workspaceId: string;\r\n  workspaceSessionDir: string;\r\n  childTaskId: string;\r\n  appliedAtMs: number;\r\n}): Promise<SubagentGitPatchArtifact | null> {\r\n  let updated: SubagentGitPatchArtifact | null = null;\r\n\r\n  await updateSubagentGitPatchArtifactsFile({\r\n    workspaceId: params.workspaceId,\r\n    workspaceSessionDir: params.workspaceSessionDir,\r\n    update: (file) => {\r\n      const existing = file.artifactsByChildTaskId[params.childTaskId] ?? null;\r\n      if (!existing) {\r\n        updated = null;\r\n        return;\r\n      }\r\n\r\n      updated = {\r\n        ...existing,\r\n        appliedAtMs: params.appliedAtMs,\r\n        updatedAtMs: params.appliedAtMs,\r\n      };\r\n      file.artifactsByChildTaskId[params.childTaskId] = updated;\r\n    },\r\n  });\r\n\r\n  return updated;\r\n}\r\n"]}