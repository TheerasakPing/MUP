{"version":3,"file":"subagentGitPatchArtifacts.js","sourceRoot":"","sources":["../../../src/node/services/subagentGitPatchArtifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fsPromises from \"fs/promises\";\nimport * as path from \"node:path\";\n\nimport writeFileAtomic from \"write-file-atomic\";\n\nimport type { SubagentGitPatchArtifact } from \"@/common/utils/tools/toolDefinitions\";\nimport { log } from \"@/node/services/log\";\nimport { workspaceFileLocks } from \"@/node/utils/concurrency/workspaceFileLocks\";\n\nexport interface SubagentGitPatchArtifactsFile {\n  version: 1;\n  artifactsByChildTaskId: Record<string, SubagentGitPatchArtifact>;\n}\n\nconst SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION = 1 as const;\n\nconst SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_NAME = \"subagent-patches.json\";\nconst SUBAGENT_GIT_PATCH_DIR_NAME = \"subagent-patches\";\nconst SUBAGENT_GIT_PATCH_MBOX_FILE_NAME = \"series.mbox\";\n\nexport function getSubagentGitPatchArtifactsFilePath(workspaceSessionDir: string): string {\n  return path.join(workspaceSessionDir, SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_NAME);\n}\n\nexport function getSubagentGitPatchMboxPath(\n  workspaceSessionDir: string,\n  childTaskId: string\n): string {\n  return path.join(\n    workspaceSessionDir,\n    SUBAGENT_GIT_PATCH_DIR_NAME,\n    childTaskId,\n    SUBAGENT_GIT_PATCH_MBOX_FILE_NAME\n  );\n}\n\nexport async function readSubagentGitPatchArtifactsFile(\n  workspaceSessionDir: string\n): Promise<SubagentGitPatchArtifactsFile> {\n  try {\n    const filePath = getSubagentGitPatchArtifactsFilePath(workspaceSessionDir);\n    const raw = await fsPromises.readFile(filePath, \"utf-8\");\n    const parsed = JSON.parse(raw) as unknown;\n\n    if (!parsed || typeof parsed !== \"object\") {\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    const obj = parsed as {\n      version?: unknown;\n      artifactsByChildTaskId?: unknown;\n    };\n\n    const version = obj.version;\n    const artifactsByChildTaskId = obj.artifactsByChildTaskId;\n\n    if (version !== SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION) {\n      // Unknown version; treat as empty.\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    if (!artifactsByChildTaskId || typeof artifactsByChildTaskId !== \"object\") {\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    return {\n      version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION,\n      artifactsByChildTaskId: artifactsByChildTaskId as Record<string, SubagentGitPatchArtifact>,\n    };\n  } catch (error) {\n    if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n      return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n    }\n\n    log.error(\"Failed to read subagent git patch artifacts file\", { error });\n    return { version: SUBAGENT_GIT_PATCH_ARTIFACTS_FILE_VERSION, artifactsByChildTaskId: {} };\n  }\n}\n\nexport async function readSubagentGitPatchArtifact(\n  workspaceSessionDir: string,\n  childTaskId: string\n): Promise<SubagentGitPatchArtifact | null> {\n  const file = await readSubagentGitPatchArtifactsFile(workspaceSessionDir);\n  return file.artifactsByChildTaskId[childTaskId] ?? null;\n}\n\nexport async function updateSubagentGitPatchArtifactsFile(params: {\n  workspaceId: string;\n  workspaceSessionDir: string;\n  update: (file: SubagentGitPatchArtifactsFile) => void;\n}): Promise<SubagentGitPatchArtifactsFile> {\n  return workspaceFileLocks.withLock(params.workspaceId, async () => {\n    const file = await readSubagentGitPatchArtifactsFile(params.workspaceSessionDir);\n    params.update(file);\n    try {\n      await fsPromises.mkdir(params.workspaceSessionDir, { recursive: true });\n      const filePath = getSubagentGitPatchArtifactsFilePath(params.workspaceSessionDir);\n      await writeFileAtomic(filePath, JSON.stringify(file, null, 2));\n    } catch (error) {\n      log.error(\"Failed to write subagent git patch artifacts file\", { error });\n    }\n    return file;\n  });\n}\n\nexport async function upsertSubagentGitPatchArtifact(params: {\n  workspaceId: string;\n  workspaceSessionDir: string;\n  childTaskId: string;\n  updater: (existing: SubagentGitPatchArtifact | null) => SubagentGitPatchArtifact;\n}): Promise<SubagentGitPatchArtifact> {\n  let updated: SubagentGitPatchArtifact | null = null;\n\n  await updateSubagentGitPatchArtifactsFile({\n    workspaceId: params.workspaceId,\n    workspaceSessionDir: params.workspaceSessionDir,\n    update: (file) => {\n      const existing = file.artifactsByChildTaskId[params.childTaskId] ?? null;\n      updated = params.updater(existing);\n      file.artifactsByChildTaskId[params.childTaskId] = updated;\n    },\n  });\n\n  if (!updated) {\n    throw new Error(\"upsertSubagentGitPatchArtifact: updater returned no artifact\");\n  }\n\n  return updated;\n}\n\nexport async function markSubagentGitPatchArtifactApplied(params: {\n  workspaceId: string;\n  workspaceSessionDir: string;\n  childTaskId: string;\n  appliedAtMs: number;\n}): Promise<SubagentGitPatchArtifact | null> {\n  let updated: SubagentGitPatchArtifact | null = null;\n\n  await updateSubagentGitPatchArtifactsFile({\n    workspaceId: params.workspaceId,\n    workspaceSessionDir: params.workspaceSessionDir,\n    update: (file) => {\n      const existing = file.artifactsByChildTaskId[params.childTaskId] ?? null;\n      if (!existing) {\n        updated = null;\n        return;\n      }\n\n      updated = {\n        ...existing,\n        appliedAtMs: params.appliedAtMs,\n        updatedAtMs: params.appliedAtMs,\n      };\n      file.artifactsByChildTaskId[params.childTaskId] = updated;\n    },\n  });\n\n  return updated;\n}\n"]}