{"version":3,"file":"file_edit_replace_shared.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_replace_shared.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Shared implementation for file edit replace tools\r\n *\r\n * These helpers are used by both string-based and line-based replace tools,\r\n * providing the core logic while keeping the tool definitions simple for AI providers.\r\n */\r\n\r\nimport {\r\n  EDIT_FAILED_NOTE_PREFIX,\r\n  NOTE_READ_FILE_FIRST_RETRY,\r\n  NOTE_READ_FILE_RETRY,\r\n  NOTE_READ_FILE_AGAIN_RETRY,\r\n  type FileEditReplaceStringToolArgs,\r\n  type FileEditReplaceLinesToolArgs,\r\n} from \"@/common/types/tools\";\r\n\r\nimport { convertNewlines, detectFileEol, normalizeNewlinesToLF } from \"./eol\";\r\n\r\ninterface OperationMetadata {\r\n  edits_applied: number;\r\n  lines_replaced?: number;\r\n  line_delta?: number;\r\n}\r\n\r\nexport interface OperationResult {\r\n  success: true;\r\n  newContent: string;\r\n  metadata: OperationMetadata;\r\n}\r\n\r\nexport interface OperationError {\r\n  success: false;\r\n  error: string;\r\n  note?: string; // Agent-only message (not displayed in UI)\r\n}\r\n\r\nexport type OperationOutcome = OperationResult | OperationError;\r\n\r\n// Re-export schema-derived types for backward compatibility.\r\n// Local code previously imported StringReplaceArgs / LineReplaceArgs from this module.\r\nexport type StringReplaceArgs = FileEditReplaceStringToolArgs;\r\nexport type LineReplaceArgs = FileEditReplaceLinesToolArgs;\r\n\r\n/**\r\n * Handle string-based replacement\r\n */\r\nexport function handleStringReplace(\r\n  args: StringReplaceArgs,\r\n  originalContent: string\r\n): OperationOutcome {\r\n  const replaceCount = args.replace_count ?? 1;\r\n\r\n  const fileEol = detectFileEol(originalContent);\r\n  const oldStringExact = args.old_string;\r\n  const oldStringCoerced = convertNewlines(args.old_string, fileEol);\r\n  const newStringCoerced = convertNewlines(args.new_string, fileEol);\r\n\r\n  // Prefer an exact match, but retry with normalized newline styles so Windows\r\n  // CRLF files can be edited using model-generated LF strings.\r\n  let oldStringToMatch = oldStringExact;\r\n  if (\r\n    !originalContent.includes(oldStringToMatch) &&\r\n    oldStringCoerced !== oldStringExact &&\r\n    originalContent.includes(oldStringCoerced)\r\n  ) {\r\n    oldStringToMatch = oldStringCoerced;\r\n  }\r\n\r\n  if (!originalContent.includes(oldStringToMatch)) {\r\n    return {\r\n      success: false,\r\n      error: \"old_string not found in file. The text to replace must exist in the file.\",\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} The old_string does not exist in the file. ${NOTE_READ_FILE_FIRST_RETRY}`,\r\n    };\r\n  }\r\n\r\n  const parts = originalContent.split(oldStringToMatch);\r\n  const occurrences = parts.length - 1;\r\n\r\n  if (replaceCount === 1 && occurrences > 1) {\r\n    return {\r\n      success: false,\r\n      error: `old_string appears ${occurrences} times in the file. Either expand the context to make it unique or set replace_count to ${occurrences} or -1.`,\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} The old_string matched ${occurrences} locations. Add more surrounding context to make it unique, or set replace_count=${occurrences} to replace all occurrences.`,\r\n    };\r\n  }\r\n\r\n  if (replaceCount > occurrences && replaceCount !== -1) {\r\n    return {\r\n      success: false,\r\n      error: `replace_count is ${replaceCount} but old_string only appears ${occurrences} time(s) in the file.`,\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} The replace_count=${replaceCount} is too high. Retry with replace_count=${occurrences} or -1.`,\r\n    };\r\n  }\r\n\r\n  let newContent: string;\r\n  let editsApplied: number;\r\n\r\n  if (replaceCount === -1) {\r\n    newContent = parts.join(newStringCoerced);\r\n    editsApplied = occurrences;\r\n  } else {\r\n    let replacedCount = 0;\r\n    let currentContent = originalContent;\r\n\r\n    for (let i = 0; i < replaceCount; i++) {\r\n      const index = currentContent.indexOf(oldStringToMatch);\r\n      if (index === -1) {\r\n        break;\r\n      }\r\n\r\n      currentContent =\r\n        currentContent.substring(0, index) +\r\n        newStringCoerced +\r\n        currentContent.substring(index + oldStringToMatch.length);\r\n      replacedCount++;\r\n    }\r\n\r\n    newContent = currentContent;\r\n    editsApplied = replacedCount;\r\n  }\r\n\r\n  return {\r\n    success: true,\r\n    newContent,\r\n    metadata: {\r\n      edits_applied: editsApplied,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Handle line-range replacement\r\n */\r\nexport function handleLineReplace(\r\n  args: LineReplaceArgs,\r\n  originalContent: string\r\n): OperationOutcome {\r\n  const startIndex = args.start_line - 1;\r\n  const endIndex = args.end_line - 1;\r\n\r\n  if (args.start_line <= 0) {\r\n    return {\r\n      success: false,\r\n      error: `start_line must be >= 1 (received ${args.start_line}).`,\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} Line numbers must be >= 1.`,\r\n    };\r\n  }\r\n\r\n  if (args.end_line < args.start_line) {\r\n    return {\r\n      success: false,\r\n      error: `end_line must be >= start_line (received start ${args.start_line}, end ${args.end_line}).`,\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} The end_line must be >= start_line.`,\r\n    };\r\n  }\r\n\r\n  const fileEol = detectFileEol(originalContent);\r\n  const lines = normalizeNewlinesToLF(originalContent).split(\"\\n\");\r\n\r\n  if (startIndex >= lines.length) {\r\n    return {\r\n      success: false,\r\n      error: `start_line ${args.start_line} exceeds current file length (${lines.length}).`,\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} The file has ${lines.length} lines. ${NOTE_READ_FILE_RETRY}`,\r\n    };\r\n  }\r\n\r\n  const clampedEndIndex = Math.min(endIndex, lines.length - 1);\r\n  const currentRange = lines.slice(startIndex, clampedEndIndex + 1);\r\n\r\n  if (args.expected_lines && !arraysEqual(currentRange, args.expected_lines)) {\r\n    return {\r\n      success: false,\r\n      error: `expected_lines validation failed. Current lines [${currentRange.join(\"\\n\")}] differ from expected [${args.expected_lines.join(\"\\n\")}].`,\r\n      note: `${EDIT_FAILED_NOTE_PREFIX} The file content changed since you last read it. ${NOTE_READ_FILE_AGAIN_RETRY}`,\r\n    };\r\n  }\r\n\r\n  const before = lines.slice(0, startIndex);\r\n  const after = lines.slice(clampedEndIndex + 1);\r\n  const updatedLines = [...before, ...args.new_lines, ...after];\r\n  const linesReplaced = currentRange.length;\r\n  const totalDelta = args.new_lines.length - currentRange.length;\r\n\r\n  return {\r\n    success: true,\r\n    newContent: updatedLines.join(fileEol),\r\n    metadata: {\r\n      edits_applied: 1,\r\n      lines_replaced: linesReplaced,\r\n      line_delta: totalDelta,\r\n    },\r\n  };\r\n}\r\n\r\nfunction arraysEqual(a: string[], b: string[]): boolean {\r\n  if (a.length !== b.length) return false;\r\n  return a.every((value, index) => value === b[index]);\r\n}\r\n"]}