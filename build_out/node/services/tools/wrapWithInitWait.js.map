{"version":3,"file":"wrapWithInitWait.js","sourceRoot":"","sources":["../../../../src/node/services/tools/wrapWithInitWait.ts"],"names":[],"mappings":";;;AAGA;;;;;;;;;;;;;GAaG;AACH,0BACE,IAAgC,EAChC,WAAmB,EACnB,gBAAkC,EACN;IAC5B,yEAAyE;IACzE,OAAO;QACL,GAAG,IAAI;QACP,OAAO,EAAE,KAAK,EAAE,IAAiB,EAAE,OAAO,EAAE,EAAE,CAAC;YAC7C,MAAM,WAAW,GACf,OAAO,IAAI,OAAO,OAAO,KAAK,QAAQ,IAAI,aAAa,IAAI,OAAO;gBAChE,CAAC,CAAE,OAAyC,CAAC,WAAW;gBACxD,CAAC,CAAC,SAAS,CAAC;YAEhB,sEAAsE;YACtE,+DAA+D;YAC/D,8FAA8F;YAC9F,MAAM,gBAAgB,CAAC,WAAW,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;YAE7D,6CAA6C;YAC7C,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;gBAClB,MAAM,IAAI,KAAK,CAAC,wCAAwC,CAAC,CAAC;YAC5D,CAAC;YACD,OAAO,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;QAAA,CACpC;KAC4B,CAAC;AAAA,CACjC","sourcesContent":["import type { Tool } from \"ai\";\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\n\n/**\n * Wraps a tool to wait for workspace initialization before execution.\n *\n * This wrapper handles the cross-cutting concern of init state waiting,\n * keeping individual tools simple and focused on their core functionality.\n *\n * Only runtime-dependent tools (bash, file_read, file_edit_*) need this wrapper.\n * Non-runtime tools (propose_plan, todo, web_search) execute immediately.\n *\n * @param tool The tool to wrap (returned from a tool factory)\n * @param workspaceId Workspace ID for init state tracking\n * @param initStateManager Init state manager for waiting\n * @returns Wrapped tool that waits for init before executing\n */\nexport function wrapWithInitWait<TParameters, TResult>(\n  tool: Tool<TParameters, TResult>,\n  workspaceId: string,\n  initStateManager: InitStateManager\n): Tool<TParameters, TResult> {\n  // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n  return {\n    ...tool,\n    execute: async (args: TParameters, options) => {\n      const abortSignal =\n        options && typeof options === \"object\" && \"abortSignal\" in options\n          ? (options as { abortSignal?: AbortSignal }).abortSignal\n          : undefined;\n\n      // Wait for workspace initialization to complete (no-op if not needed)\n      // This never throws - tools proceed regardless of init outcome\n      // Forward abort signals so tool cancellation stays responsive during long provisioning waits.\n      await initStateManager.waitForInit(workspaceId, abortSignal);\n\n      // Execute the actual tool with all arguments\n      if (!tool.execute) {\n        throw new Error(\"Tool does not have an execute function\");\n      }\n      return tool.execute(args, options);\n    },\n  } as Tool<TParameters, TResult>;\n}\n"]}