{"version":3,"file":"file_edit_operation.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_operation.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, jest } from \"@jest/globals\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport { executeFileEditOperation } from \"./file_edit_operation\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\r\n\r\nimport { getTestDeps, TestTempDir } from \"./testHelpers\";\r\n\r\ndescribe(\"executeFileEditOperation\", () => {\r\n  test(\"should use runtime.normalizePath for path resolution, not Node's path.resolve\", async () => {\r\n    // This test verifies that executeFileEditOperation uses runtime.normalizePath()\r\n    // instead of path.resolve() for resolving file paths.\r\n    //\r\n    // Why this matters: path.resolve() uses LOCAL filesystem semantics (Node.js path module),\r\n    // which normalizes paths differently than the remote filesystem expects.\r\n    // For example, path.resolve() on Windows uses backslashes, and path normalization\r\n    // can behave differently across platforms.\r\n\r\n    const normalizePathCalls: Array<{ targetPath: string; basePath: string }> = [];\r\n\r\n    const mockRuntime = {\r\n      stat: jest\r\n        .fn<() => Promise<{ size: number; modifiedTime: Date; isDirectory: boolean }>>()\r\n        .mockResolvedValue({\r\n          size: 100,\r\n          modifiedTime: new Date(),\r\n          isDirectory: false,\r\n        }),\r\n      readFile: jest.fn<() => Promise<Uint8Array>>().mockResolvedValue(new Uint8Array()),\r\n      writeFile: jest.fn<() => Promise<void>>().mockResolvedValue(undefined),\r\n      normalizePath: jest.fn<(targetPath: string, basePath: string) => string>(\r\n        (targetPath: string, basePath: string) => {\r\n          normalizePathCalls.push({ targetPath, basePath });\r\n          // Mock SSH-style path normalization\r\n          if (targetPath.startsWith(\"/\")) return targetPath;\r\n          return `${basePath}/${targetPath}`;\r\n        }\r\n      ),\r\n    } as unknown as Runtime;\r\n\r\n    const testFilePath = \"relative/path/to/file.txt\";\r\n    const testCwd = \"/remote/workspace/dir\";\r\n\r\n    await executeFileEditOperation({\r\n      config: {\r\n        cwd: testCwd,\r\n        runtime: mockRuntime,\r\n        runtimeTempDir: \"/tmp\",\r\n        ...getTestDeps(),\r\n      },\r\n      filePath: testFilePath,\r\n      operation: () => ({ success: true, newContent: \"test\", metadata: {} }),\r\n    });\r\n\r\n    // Verify that runtime.normalizePath() was called for path resolution\r\n    const normalizeCallForFilePath = normalizePathCalls.find(\r\n      (call) => call.targetPath === testFilePath\r\n    );\r\n\r\n    expect(normalizeCallForFilePath).toBeDefined();\r\n\r\n    if (normalizeCallForFilePath) {\r\n      expect(normalizeCallForFilePath.basePath).toBe(testCwd);\r\n    }\r\n  });\r\n});\r\n\r\ndescribe(\"executeFileEditOperation plan mode enforcement\", () => {\r\n  test(\"should block editing non-plan files when in plan mode\", async () => {\r\n    // This test verifies that when in plan mode with a planFilePath set,\r\n    // attempting to edit any other file is blocked BEFORE trying to read/write\r\n    const OTHER_FILE_PATH = \"/home/user/project/src/main.ts\";\r\n    const PLAN_FILE_PATH = \"/home/user/.mux/sessions/workspace-123/plan.md\";\r\n    const TEST_CWD = \"/home/user/project\";\r\n\r\n    const readFileMock = jest.fn();\r\n    const mockRuntime = {\r\n      stat: jest\r\n        .fn<() => Promise<{ size: number; modifiedTime: Date; isDirectory: boolean }>>()\r\n        .mockResolvedValue({\r\n          size: 100,\r\n          modifiedTime: new Date(),\r\n          isDirectory: false,\r\n        }),\r\n      readFile: readFileMock,\r\n      writeFile: jest.fn(),\r\n      normalizePath: jest.fn<(targetPath: string, _basePath: string) => string>(\r\n        (targetPath: string, _basePath: string) => {\r\n          // For absolute paths, return as-is\r\n          if (targetPath.startsWith(\"/\")) return targetPath;\r\n          // For relative paths, join with base\r\n          return `${_basePath}/${targetPath}`;\r\n        }\r\n      ),\r\n      resolvePath: jest.fn<(targetPath: string) => Promise<string>>((targetPath: string) => {\r\n        // For absolute paths, return as-is\r\n        if (targetPath.startsWith(\"/\")) return Promise.resolve(targetPath);\r\n        // Return path as-is (mock doesn't need full resolution)\r\n        return Promise.resolve(targetPath);\r\n      }),\r\n    } as unknown as Runtime;\r\n\r\n    const result = await executeFileEditOperation({\r\n      config: {\r\n        cwd: TEST_CWD,\r\n        runtime: mockRuntime,\r\n        runtimeTempDir: \"/tmp\",\r\n        planFileOnly: true,\r\n        planFilePath: PLAN_FILE_PATH,\r\n      },\r\n      filePath: OTHER_FILE_PATH,\r\n      operation: () => ({ success: true, newContent: \"console.log('test')\", metadata: {} }),\r\n    });\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"In the plan agent, only the plan file can be edited\");\r\n      expect(result.error).toContain(OTHER_FILE_PATH);\r\n    }\r\n\r\n    // Verify readFile was never called - we should fail before reaching file IO\r\n    expect(readFileMock).not.toHaveBeenCalled();\r\n  });\r\n\r\n  test(\"should allow editing the plan file when in plan mode (integration)\", async () => {\r\n    using tempDir = new TestTempDir(\"plan-mode-test\");\r\n\r\n    // Create the plan file in the temp directory\r\n    const planPath = path.join(tempDir.path, \"plan.md\");\r\n    await fs.writeFile(planPath, \"# Original Plan\\n\");\r\n\r\n    // CWD is separate from plan file location (simulates real setup)\r\n    const workspaceCwd = path.join(tempDir.path, \"workspace\");\r\n    await fs.mkdir(workspaceCwd);\r\n\r\n    const result = await executeFileEditOperation({\r\n      config: {\r\n        cwd: workspaceCwd,\r\n        runtime: new LocalRuntime(workspaceCwd),\r\n        runtimeTempDir: tempDir.path,\r\n        planFileOnly: true,\r\n        planFilePath: planPath,\r\n      },\r\n      filePath: planPath,\r\n      operation: () => ({ success: true, newContent: \"# Updated Plan\\n\", metadata: {} }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(await fs.readFile(planPath, \"utf-8\")).toBe(\"# Updated Plan\\n\");\r\n  });\r\n\r\n  test(\"should allow editing any file when in exec mode (integration)\", async () => {\r\n    using tempDir = new TestTempDir(\"exec-mode-test\");\r\n\r\n    const testFile = path.join(tempDir.path, \"main.ts\");\r\n    await fs.writeFile(testFile, \"const x = 1;\\n\");\r\n\r\n    const result = await executeFileEditOperation({\r\n      config: {\r\n        cwd: tempDir.path,\r\n        runtime: new LocalRuntime(tempDir.path),\r\n        runtimeTempDir: tempDir.path,\r\n        // No planFilePath in exec mode\r\n      },\r\n      filePath: testFile,\r\n      operation: () => ({ success: true, newContent: \"const x = 2;\\n\", metadata: {} }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(await fs.readFile(testFile, \"utf-8\")).toBe(\"const x = 2;\\n\");\r\n  });\r\n\r\n  test(\"should allow editing any file when mode is not set (integration)\", async () => {\r\n    using tempDir = new TestTempDir(\"no-mode-test\");\r\n\r\n    const testFile = path.join(tempDir.path, \"main.ts\");\r\n    await fs.writeFile(testFile, \"const x = 1;\\n\");\r\n\r\n    const result = await executeFileEditOperation({\r\n      config: {\r\n        cwd: tempDir.path,\r\n        runtime: new LocalRuntime(tempDir.path),\r\n        runtimeTempDir: tempDir.path,\r\n        // mode is undefined\r\n      },\r\n      filePath: testFile,\r\n      operation: () => ({ success: true, newContent: \"const x = 2;\\n\", metadata: {} }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(await fs.readFile(testFile, \"utf-8\")).toBe(\"const x = 2;\\n\");\r\n  });\r\n\r\n  test(\"should block editing the plan file outside plan mode (integration)\", async () => {\r\n    using tempDir = new TestTempDir(\"exec-plan-readonly-test\");\r\n\r\n    const planPath = path.join(tempDir.path, \"plan.md\");\r\n    await fs.writeFile(planPath, \"# Plan\\n\");\r\n\r\n    const workspaceCwd = path.join(tempDir.path, \"workspace\");\r\n    await fs.mkdir(workspaceCwd);\r\n\r\n    const result = await executeFileEditOperation({\r\n      config: {\r\n        cwd: workspaceCwd,\r\n        runtime: new LocalRuntime(workspaceCwd),\r\n        runtimeTempDir: tempDir.path,\r\n        planFilePath: planPath,\r\n      },\r\n      filePath: planPath,\r\n      operation: () => ({ success: true, newContent: \"# Updated\\n\", metadata: {} }),\r\n    });\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"read-only outside the plan agent\");\r\n    }\r\n\r\n    // Verify file was not modified\r\n    expect(await fs.readFile(planPath, \"utf-8\")).toBe(\"# Plan\\n\");\r\n  });\r\n\r\n  test(\"should require exact plan file path string in plan mode\", async () => {\r\n    // If an alternate path resolves to the plan file, we still require using the exact\r\n    // planFilePath string provided in the plan-mode instructions.\r\n    const resolvePathCalls: string[] = [];\r\n\r\n    const mockRuntime = {\r\n      stat: jest.fn(),\r\n      readFile: jest.fn(),\r\n      writeFile: jest.fn(),\r\n      normalizePath: jest.fn<(targetPath: string, basePath: string) => string>(\r\n        (targetPath: string, basePath: string) => {\r\n          // Simulate: \"../.mux/sessions/ws/plan.md\" resolves to \"/home/user/.mux/sessions/ws/plan.md\"\r\n          if (targetPath === \"../.mux/sessions/ws/plan.md\") {\r\n            return \"/home/user/.mux/sessions/ws/plan.md\";\r\n          }\r\n          if (targetPath === \"/home/user/.mux/sessions/ws/plan.md\") {\r\n            return \"/home/user/.mux/sessions/ws/plan.md\";\r\n          }\r\n          if (targetPath.startsWith(\"/\")) return targetPath;\r\n          return `${basePath}/${targetPath}`;\r\n        }\r\n      ),\r\n      resolvePath: jest.fn<(targetPath: string) => Promise<string>>((targetPath: string) => {\r\n        resolvePathCalls.push(targetPath);\r\n        // Both paths resolve to the same absolute path\r\n        if (targetPath === \"../.mux/sessions/ws/plan.md\") {\r\n          return Promise.resolve(\"/home/user/.mux/sessions/ws/plan.md\");\r\n        }\r\n        if (targetPath === \"/home/user/.mux/sessions/ws/plan.md\") {\r\n          return Promise.resolve(\"/home/user/.mux/sessions/ws/plan.md\");\r\n        }\r\n        if (targetPath.startsWith(\"/\")) return Promise.resolve(targetPath);\r\n        return Promise.resolve(targetPath);\r\n      }),\r\n    } as unknown as Runtime;\r\n\r\n    const result = await executeFileEditOperation({\r\n      config: {\r\n        cwd: \"/home/user/project\",\r\n        runtime: mockRuntime,\r\n        runtimeTempDir: \"/tmp\",\r\n        planFileOnly: true,\r\n        planFilePath: \"/home/user/.mux/sessions/ws/plan.md\",\r\n      },\r\n      filePath: \"../.mux/sessions/ws/plan.md\", // Alternate path to plan file\r\n      operation: () => ({ success: true, newContent: \"# Plan\", metadata: {} }),\r\n    });\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"exact plan file path\");\r\n      expect(result.error).toContain(\"/home/user/.mux/sessions/ws/plan.md\");\r\n      expect(result.error).toContain(\"../.mux/sessions/ws/plan.md\");\r\n      expect(result.error).toContain(\"resolves to the plan file\");\r\n    }\r\n\r\n    // We still resolve both paths to determine whether the attempted path is the plan file.\r\n    expect(resolvePathCalls).toContain(\"../.mux/sessions/ws/plan.md\");\r\n    expect(resolvePathCalls).toContain(\"/home/user/.mux/sessions/ws/plan.md\");\r\n  });\r\n});\r\n"]}