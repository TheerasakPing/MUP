{"version":3,"file":"agent_skill_read_file.js","sourceRoot":"","sources":["../../../../src/node/services/tools/agent_skill_read_file.ts"],"names":[],"mappings":"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","sourcesContent":["import { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { getBuiltInSkillByName } from \"@/node/services/agentSkills/builtInSkillDefinitions\";\r\n\r\nimport { tool } from \"ai\";\r\n\r\nimport type { AgentSkillReadFileToolResult } from \"@/common/types/tools\";\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { SkillNameSchema } from \"@/common/orpc/schemas\";\r\nimport {\r\n  readAgentSkill,\r\n  resolveAgentSkillFilePath,\r\n} from \"@/node/services/agentSkills/agentSkillsService\";\r\nimport { MAX_FILE_SIZE, validateFileSize } from \"@/node/services/tools/fileCommon\";\r\nimport { readBuiltInSkillFile } from \"@/node/services/agentSkills/builtInSkillDefinitions\";\r\nimport { RuntimeError } from \"@/node/runtime/Runtime\";\r\nimport { readFileString } from \"@/node/utils/runtime/helpers\";\r\n\r\nfunction readContentWithFileReadLimits(input: {\r\n  fullContent: string;\r\n  fileSize: number;\r\n  modifiedTime: string;\r\n  offset?: number | null;\r\n  limit?: number | null;\r\n}): AgentSkillReadFileToolResult {\r\n  if (input.fileSize > MAX_FILE_SIZE) {\r\n    const sizeMB = (input.fileSize / (1024 * 1024)).toFixed(2);\r\n    const maxMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(2);\r\n    return {\r\n      success: false,\r\n      error: `File is too large (${sizeMB}MB). Maximum supported size is ${maxMB}MB.`,\r\n    };\r\n  }\r\n\r\n  const lines = input.fullContent === \"\" ? [] : input.fullContent.split(\"\\n\");\r\n\r\n  if (input.offset != null && input.offset > lines.length) {\r\n    return {\r\n      success: false,\r\n      error: `Offset ${input.offset} is beyond file length`,\r\n    };\r\n  }\r\n\r\n  const startLineNumber = input.offset ?? 1;\r\n  const startIdx = startLineNumber - 1;\r\n  const endIdx = input.limit != null ? startIdx + input.limit : lines.length;\r\n\r\n  const numberedLines: string[] = [];\r\n  let totalBytesAccumulated = 0;\r\n  const MAX_LINE_BYTES = 1024;\r\n  const MAX_LINES = 1000;\r\n  const MAX_TOTAL_BYTES = 16 * 1024; // 16KB\r\n\r\n  for (let i = startIdx; i < Math.min(endIdx, lines.length); i++) {\r\n    const line = lines[i];\r\n    const lineNumber = i + 1;\r\n\r\n    let processedLine = line;\r\n    const lineBytes = Buffer.byteLength(line, \"utf-8\");\r\n    if (lineBytes > MAX_LINE_BYTES) {\r\n      processedLine = Buffer.from(line, \"utf-8\").subarray(0, MAX_LINE_BYTES).toString(\"utf-8\");\r\n      processedLine += \"... [truncated]\";\r\n    }\r\n\r\n    const numberedLine = `${lineNumber}\\t${processedLine}`;\r\n    const numberedLineBytes = Buffer.byteLength(numberedLine, \"utf-8\");\r\n\r\n    if (totalBytesAccumulated + numberedLineBytes > MAX_TOTAL_BYTES) {\r\n      return {\r\n        success: false,\r\n        error: `Output would exceed ${MAX_TOTAL_BYTES} bytes. Please read less at a time using offset and limit parameters.`,\r\n      };\r\n    }\r\n\r\n    numberedLines.push(numberedLine);\r\n    totalBytesAccumulated += numberedLineBytes + 1;\r\n\r\n    if (numberedLines.length > MAX_LINES) {\r\n      return {\r\n        success: false,\r\n        error: `Output would exceed ${MAX_LINES} lines. Please read less at a time using offset and limit parameters.`,\r\n      };\r\n    }\r\n  }\r\n\r\n  return {\r\n    success: true,\r\n    file_size: input.fileSize,\r\n    modifiedTime: input.modifiedTime,\r\n    lines_read: numberedLines.length,\r\n    content: numberedLines.join(\"\\n\"),\r\n  };\r\n}\r\nfunction formatError(error: unknown): string {\r\n  return error instanceof Error ? error.message : String(error);\r\n}\r\n\r\n/**\r\n * Agent Skill read_file tool factory.\r\n * Reads a file within a skill directory with the same output limits as file_read.\r\n */\r\nexport const createAgentSkillReadFileTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.agent_skill_read_file.description,\r\n    inputSchema: TOOL_DEFINITIONS.agent_skill_read_file.schema,\r\n    execute: async ({ name, filePath, offset, limit }): Promise<AgentSkillReadFileToolResult> => {\r\n      const workspacePath = config.cwd;\r\n      if (!workspacePath) {\r\n        return {\r\n          success: false,\r\n          error: \"Tool misconfigured: cwd is required.\",\r\n        };\r\n      }\r\n\r\n      // Defensive: validate again even though inputSchema should guarantee shape.\r\n      const parsedName = SkillNameSchema.safeParse(name);\r\n      if (!parsedName.success) {\r\n        return {\r\n          success: false,\r\n          error: parsedName.error.message,\r\n        };\r\n      }\r\n\r\n      try {\r\n        if (offset != null && offset < 1) {\r\n          return {\r\n            success: false,\r\n            error: `Offset must be positive (got ${offset})`,\r\n          };\r\n        }\r\n\r\n        // Chat with Mux intentionally has no generic filesystem access. Restrict skill file reads\r\n        // to built-in skills (bundled in the app) so users can access help like `mux-docs` without\r\n        // granting access to project/global skills on disk.\r\n        if (config.workspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n          const builtInSkill = getBuiltInSkillByName(parsedName.data);\r\n          if (!builtInSkill) {\r\n            return {\r\n              success: false,\r\n              error: `Only built-in skills are available in Chat with Mux (requested: ${parsedName.data}).`,\r\n            };\r\n          }\r\n\r\n          const builtIn = readBuiltInSkillFile(parsedName.data, filePath);\r\n          return readContentWithFileReadLimits({\r\n            fullContent: builtIn.content,\r\n            fileSize: Buffer.byteLength(builtIn.content, \"utf-8\"),\r\n            modifiedTime: new Date(0).toISOString(),\r\n            offset,\r\n            limit,\r\n          });\r\n        }\r\n\r\n        const resolvedSkill = await readAgentSkill(config.runtime, workspacePath, parsedName.data);\r\n\r\n        // Built-in skills are embedded in the app bundle (no filesystem access).\r\n        if (resolvedSkill.package.scope === \"built-in\") {\r\n          const builtIn = readBuiltInSkillFile(parsedName.data, filePath);\r\n          return readContentWithFileReadLimits({\r\n            fullContent: builtIn.content,\r\n            fileSize: Buffer.byteLength(builtIn.content, \"utf-8\"),\r\n            modifiedTime: new Date(0).toISOString(),\r\n            offset,\r\n            limit,\r\n          });\r\n        }\r\n\r\n        const targetPath = resolveAgentSkillFilePath(\r\n          config.runtime,\r\n          resolvedSkill.skillDir,\r\n          filePath\r\n        );\r\n\r\n        let stat;\r\n        try {\r\n          stat = await config.runtime.stat(targetPath);\r\n        } catch (err) {\r\n          if (err instanceof RuntimeError) {\r\n            return {\r\n              success: false,\r\n              error: err.message,\r\n            };\r\n          }\r\n          throw err;\r\n        }\r\n\r\n        if (stat.isDirectory) {\r\n          return {\r\n            success: false,\r\n            error: `Path is a directory, not a file: ${filePath}`,\r\n          };\r\n        }\r\n\r\n        const sizeValidation = validateFileSize(stat);\r\n        if (sizeValidation) {\r\n          return {\r\n            success: false,\r\n            error: sizeValidation.error,\r\n          };\r\n        }\r\n\r\n        let fullContent: string;\r\n        try {\r\n          fullContent = await readFileString(config.runtime, targetPath);\r\n        } catch (err) {\r\n          if (err instanceof RuntimeError) {\r\n            return {\r\n              success: false,\r\n              error: err.message,\r\n            };\r\n          }\r\n          throw err;\r\n        }\r\n\r\n        return readContentWithFileReadLimits({\r\n          fullContent,\r\n          fileSize: stat.size,\r\n          modifiedTime: stat.modifiedTime.toISOString(),\r\n          offset,\r\n          limit,\r\n        });\r\n      } catch (error) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to read file: ${formatError(error)}`,\r\n        };\r\n      }\r\n    },\r\n  });\r\n};\r\n"]}