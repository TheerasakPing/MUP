{"version":3,"file":"task_terminate.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task_terminate.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAsD;AAGtD,qDAA2D;AAC3D,+CAAkE;AAElE,kDAA6D;AAE7D,MAAM,mBAAmB,GAAyB;IAChD,UAAU,EAAE,cAAc;IAC1B,QAAQ,EAAE,EAAE;CACb,CAAC;AAEF,IAAA,mBAAQ,EAAC,qBAAqB,EAAE,GAAG,EAAE,CAAC;IACpC,IAAA,aAAE,EAAC,gDAAgD,EAAE,KAAK,IAAI,EAAE,CAAC;;;YAC/D,MAAM,OAAO,kCAAG,IAAI,yBAAW,CAAC,+BAA+B,CAAC,QAAA,CAAC;YACjE,MAAM,UAAU,GAAG,IAAA,kCAAoB,EAAC,OAAO,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,gBAAgB,EAAE,CAAC,CAAC;YAEzF,MAAM,WAAW,GAAG;gBAClB,4BAA4B,EAAE,IAAA,eAAI,EAChC,GAA6D,EAAE,CAC7D,OAAO,CAAC,OAAO,CAAC,IAAA,YAAG,EAAC,gBAAgB,CAAC,CAAC,CACzC;aACwB,CAAC;YAE5B,MAAM,IAAI,GAAG,IAAA,wCAAuB,EAAC,EAAE,GAAG,UAAU,EAAE,WAAW,EAAE,CAAC,CAAC;YAErE,MAAM,MAAM,GAAY,MAAM,OAAO,CAAC,OAAO,CAC3C,IAAI,CAAC,OAAQ,CAAC,EAAE,QAAQ,EAAE,CAAC,cAAc,CAAC,EAAE,EAAE,mBAAmB,CAAC,CACnE,CAAC;YAEF,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC;gBACrB,OAAO,EAAE,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,MAAM,EAAE,cAAc,EAAE,CAAC;aAC3D,CAAC,CAAC;;;;;;;;;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,oEAAoE,EAAE,KAAK,IAAI,EAAE,CAAC;;;YACnF,MAAM,OAAO,kCAAG,IAAI,yBAAW,CAAC,mCAAmC,CAAC,QAAA,CAAC;YACrE,MAAM,UAAU,GAAG,IAAA,kCAAoB,EAAC,OAAO,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,gBAAgB,EAAE,CAAC,CAAC;YAEzF,MAAM,WAAW,GAAG;gBAClB,4BAA4B,EAAE,IAAA,eAAI,EAChC,GAA6D,EAAE,CAC7D,OAAO,CAAC,OAAO,CAAC,IAAA,YAAG,EAAC,4CAA4C,CAAC,CAAC,CACrE;aACwB,CAAC;YAE5B,MAAM,IAAI,GAAG,IAAA,wCAAuB,EAAC,EAAE,GAAG,UAAU,EAAE,WAAW,EAAE,CAAC,CAAC;YAErE,MAAM,MAAM,GAAY,MAAM,OAAO,CAAC,OAAO,CAC3C,IAAI,CAAC,OAAQ,CAAC,EAAE,QAAQ,EAAE,CAAC,YAAY,CAAC,EAAE,EAAE,mBAAmB,CAAC,CACjE,CAAC;YAEF,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC;gBACrB,OAAO,EAAE,CAAC,EAAE,MAAM,EAAE,eAAe,EAAE,MAAM,EAAE,YAAY,EAAE,CAAC;aAC7D,CAAC,CAAC;;;;;;;;;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,sDAAsD,EAAE,KAAK,IAAI,EAAE,CAAC;;;YACrE,MAAM,OAAO,kCAAG,IAAI,yBAAW,CAAC,wBAAwB,CAAC,QAAA,CAAC;YAC1D,MAAM,UAAU,GAAG,IAAA,kCAAoB,EAAC,OAAO,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,gBAAgB,EAAE,CAAC,CAAC;YAEzF,MAAM,WAAW,GAAG;gBAClB,4BAA4B,EAAE,IAAA,eAAI,EAChC,GAA6D,EAAE,CAC7D,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,EAAE,iBAAiB,EAAE,CAAC,YAAY,EAAE,aAAa,CAAC,EAAE,CAAC,CAAC,CAC5E;aACwB,CAAC;YAE5B,MAAM,IAAI,GAAG,IAAA,wCAAuB,EAAC,EAAE,GAAG,UAAU,EAAE,WAAW,EAAE,CAAC,CAAC;YAErE,MAAM,MAAM,GAAY,MAAM,OAAO,CAAC,OAAO,CAC3C,IAAI,CAAC,OAAQ,CAAC,EAAE,QAAQ,EAAE,CAAC,aAAa,CAAC,EAAE,EAAE,mBAAmB,CAAC,CAClE,CAAC;YAEF,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC;gBACrB,OAAO,EAAE;oBACP;wBACE,MAAM,EAAE,YAAY;wBACpB,MAAM,EAAE,aAAa;wBACrB,iBAAiB,EAAE,CAAC,YAAY,EAAE,aAAa,CAAC;qBACjD;iBACF;aACF,CAAC,CAAC;;;;;;;;;IAAA,CACJ,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, it, expect, mock } from \"bun:test\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\n\r\nimport { createTaskTerminateTool } from \"./task_terminate\";\r\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\r\nimport type { TaskService } from \"@/node/services/taskService\";\r\nimport { Err, Ok, type Result } from \"@/common/types/result\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\ndescribe(\"task_terminate tool\", () => {\r\n  it(\"returns not_found when the task does not exist\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-terminate-not-found\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"root-workspace\" });\r\n\r\n    const taskService = {\r\n      terminateDescendantAgentTask: mock(\r\n        (): Promise<Result<{ terminatedTaskIds: string[] }, string>> =>\r\n          Promise.resolve(Err(\"Task not found\"))\r\n      ),\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskTerminateTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"missing-task\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [{ status: \"not_found\", taskId: \"missing-task\" }],\r\n    });\r\n  });\r\n\r\n  it(\"returns invalid_scope when the task is outside the workspace scope\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-terminate-invalid-scope\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"root-workspace\" });\r\n\r\n    const taskService = {\r\n      terminateDescendantAgentTask: mock(\r\n        (): Promise<Result<{ terminatedTaskIds: string[] }, string>> =>\r\n          Promise.resolve(Err(\"Task is not a descendant of this workspace\"))\r\n      ),\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskTerminateTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"other-task\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [{ status: \"invalid_scope\", taskId: \"other-task\" }],\r\n    });\r\n  });\r\n\r\n  it(\"returns terminated with terminatedTaskIds on success\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-terminate-ok\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"root-workspace\" });\r\n\r\n    const taskService = {\r\n      terminateDescendantAgentTask: mock(\r\n        (): Promise<Result<{ terminatedTaskIds: string[] }, string>> =>\r\n          Promise.resolve(Ok({ terminatedTaskIds: [\"child-task\", \"parent-task\"] }))\r\n      ),\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskTerminateTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"parent-task\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [\r\n        {\r\n          status: \"terminated\",\r\n          taskId: \"parent-task\",\r\n          terminatedTaskIds: [\"child-task\", \"parent-task\"],\r\n        },\r\n      ],\r\n    });\r\n  });\r\n});\r\n"]}