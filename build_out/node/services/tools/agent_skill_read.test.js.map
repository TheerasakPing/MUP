{"version":3,"file":"agent_skill_read.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/agent_skill_read.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\r\nimport * as path from \"node:path\";\r\n\r\nimport { describe, it, expect } from \"bun:test\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\n\r\nimport { AgentSkillReadToolResultSchema } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { createAgentSkillReadTool } from \"./agent_skill_read\";\r\nimport { createTestToolConfig, TestTempDir } from \"./testHelpers\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\nasync function writeProjectSkill(workspacePath: string, name: string): Promise<void> {\r\n  const skillDir = path.join(workspacePath, \".mux\", \"skills\", name);\r\n  await fs.mkdir(skillDir, { recursive: true });\r\n  await fs.writeFile(\r\n    path.join(skillDir, \"SKILL.md\"),\r\n    `---\\nname: ${name}\\ndescription: test\\n---\\nBody\\n`,\r\n    \"utf-8\"\r\n  );\r\n}\r\n\r\ndescribe(\"agent_skill_read (Chat with Mux sandbox)\", () => {\r\n  it(\"allows reading built-in skills\", async () => {\r\n    using tempDir = new TestTempDir(\"test-agent-skill-read-mux-chat\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, {\r\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\r\n    });\r\n\r\n    const tool = createAgentSkillReadTool(baseConfig);\r\n\r\n    const raw: unknown = await Promise.resolve(\r\n      tool.execute!({ name: \"mux-docs\" }, mockToolCallOptions)\r\n    );\r\n\r\n    const parsed = AgentSkillReadToolResultSchema.safeParse(raw);\r\n    expect(parsed.success).toBe(true);\r\n    if (!parsed.success) {\r\n      throw new Error(parsed.error.message);\r\n    }\r\n\r\n    const result = parsed.data;\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.skill.scope).toBe(\"built-in\");\r\n      expect(result.skill.frontmatter.name).toBe(\"mux-docs\");\r\n    }\r\n  });\r\n\r\n  it(\"rejects project/global skills on disk\", async () => {\r\n    using tempDir = new TestTempDir(\"test-agent-skill-read-mux-chat-reject\");\r\n    await writeProjectSkill(tempDir.path, \"foo\");\r\n\r\n    const baseConfig = createTestToolConfig(tempDir.path, {\r\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\r\n    });\r\n    const tool = createAgentSkillReadTool(baseConfig);\r\n\r\n    const raw: unknown = await Promise.resolve(tool.execute!({ name: \"foo\" }, mockToolCallOptions));\r\n\r\n    const parsed = AgentSkillReadToolResultSchema.safeParse(raw);\r\n    expect(parsed.success).toBe(true);\r\n    if (!parsed.success) {\r\n      throw new Error(parsed.error.message);\r\n    }\r\n\r\n    const result = parsed.data;\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toMatch(/only built-in skills/i);\r\n    }\r\n  });\r\n});\r\n"]}