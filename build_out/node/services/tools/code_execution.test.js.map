{"version":3,"file":"code_execution.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/code_execution.test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Tests for code_execution tool\n */\n\nimport { describe, it, expect, mock } from \"bun:test\";\nimport { createCodeExecutionTool, clearTypeCaches } from \"./code_execution\";\nimport { QuickJSRuntimeFactory } from \"@/node/services/ptc/quickjsRuntime\";\nimport { ToolBridge } from \"@/node/services/ptc/toolBridge\";\nimport type { Tool, ToolExecutionOptions } from \"ai\";\nimport type { PTCEvent, PTCExecutionResult } from \"@/node/services/ptc/types\";\nimport { z } from \"zod\";\n\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\n/**\n * Realistic mock result shapes matching actual tool result schemas.\n */\nconst mockResults = {\n  file_read: {\n    success: true as const,\n    content: \"mock file content\",\n    file_size: 100,\n    modifiedTime: \"2025-01-01T00:00:00Z\",\n    lines_read: 5,\n  },\n  bash: {\n    success: true as const,\n    output: \"mock output\",\n    exitCode: 0,\n    wall_duration_ms: 10,\n  },\n};\n\n// Create a mock tool for testing - accepts sync functions\nfunction createMockTool(\n  name: string,\n  schema: z.ZodType,\n  executeFn?: (args: unknown) => unknown\n): Tool {\n  const defaultResult = mockResults[name as keyof typeof mockResults];\n  const tool: Tool = {\n    description: `Mock ${name} tool`,\n    inputSchema: schema,\n    execute: executeFn\n      ? (args) => Promise.resolve(executeFn(args))\n      : () => Promise.resolve(defaultResult ?? { success: true }),\n  };\n  return tool;\n}\n\ndescribe(\"createCodeExecutionTool\", () => {\n  const runtimeFactory = new QuickJSRuntimeFactory();\n\n  describe(\"tool creation\", () => {\n    it(\"creates tool with description containing available tools\", async () => {\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n        bash: createMockTool(\"bash\", z.object({ script: z.string() }), () => ({ output: \"ok\" })),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const desc = (tool as { description?: string }).description ?? \"\";\n      // Description now contains TypeScript definitions instead of prose\n      expect(desc).toContain(\"function file_read\");\n      expect(desc).toContain(\"function bash\");\n    });\n\n    it(\"excludes UI-specific tools from description\", async () => {\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n        todo_write: createMockTool(\"todo_write\", z.object({ todos: z.array(z.string()) }), () => ({\n          success: true,\n        })),\n        status_set: createMockTool(\"status_set\", z.object({ message: z.string() }), () => ({\n          success: true,\n        })),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const desc = (tool as { description?: string }).description ?? \"\";\n      // Description now contains TypeScript definitions\n      expect(desc).toContain(\"function file_read\");\n      expect(desc).not.toContain(\"function todo_write\");\n      expect(desc).not.toContain(\"function status_set\");\n    });\n\n    it(\"excludes provider-native tools without execute function\", async () => {\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n        web_search: {\n          description: \"Provider-native search\",\n          inputSchema: z.object({ query: z.string() }),\n          // No execute function - provider handles this\n        } satisfies Tool,\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const desc = (tool as { description?: string }).description ?? \"\";\n      // Description now contains TypeScript definitions\n      expect(desc).toContain(\"function file_read\");\n      expect(desc).not.toContain(\"function web_search\");\n    });\n  });\n\n  describe(\"static analysis\", () => {\n    it(\"rejects code with syntax errors\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: \"const x = {\" }, // Unclosed brace\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n    });\n\n    it(\"includes line numbers for syntax errors with invalid tokens\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      // Invalid token @ on line 2 - parser detects it on the exact line\n      const result = (await tool.execute!(\n        { code: \"const x = 1;\\nconst y = @;\\nconst z = 3;\" },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n      expect(result.error).toContain(\"(line 2)\");\n    });\n\n    it(\"rejects code using unavailable globals\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: \"const env = process.env\" },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n      expect(result.error).toContain(\"process\");\n    });\n\n    it(\"includes line numbers for unavailable globals\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: \"const x = 1;\\nconst y = 2;\\nconst env = process.env\" }, // process on line 3\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"(line 3)\");\n    });\n\n    it(\"rejects code using require()\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: 'const fs = require(\"fs\")' },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n      expect(result.error).toContain(\"require\");\n    });\n\n    it(\"does not reject 'require(' inside string literals\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        {\n          code: 'return \"this is a string containing require(fs) but should be allowed\"',\n        },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.result).toContain(\"require(\");\n    });\n\n    it(\"does not reject 'import(' inside string literals\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: 'return `this is a template string containing import(\"fs\")`' },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.result).toContain(\"import(\");\n    });\n\n    it(\"rejects code using dynamic import()\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: 'return import(\"fs\")' },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n      expect(result.error).toContain(\"Dynamic import() is not available\");\n    });\n\n    it(\"includes line and column numbers for type errors\", async () => {\n      const mockTools: Record<string, Tool> = {\n        bash: createMockTool(\"bash\", z.object({ script: z.string() })),\n      };\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        { code: \"const x = 1;\\nconst result = mux.bash({ scriptz: 'ls' });\" }, // typo on line 2\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n      expect(result.error).toContain(\"scriptz\");\n      expect(result.error).toContain(\"(line 2, col\");\n    });\n\n    it(\"includes line and column for calling non-existent tools\", async () => {\n      const mockTools: Record<string, Tool> = {\n        bash: createMockTool(\"bash\", z.object({ script: z.string() })),\n      };\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        { code: \"const x = 1;\\nconst y = 2;\\nmux.nonexistent({ arg: 1 });\" }, // line 3\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Code analysis failed\");\n      expect(result.error).toContain(\"(line 3, col\");\n    });\n  });\n\n  describe(\"code execution\", () => {\n    it(\"executes simple code and returns result\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: \"return 1 + 2\" },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.result).toBe(3);\n    });\n\n    it(\"captures console.log output\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: 'console.log(\"hello\", 123); return \"done\"' },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.result).toBe(\"done\");\n      expect(result.consoleOutput).toHaveLength(1);\n      expect(result.consoleOutput[0].level).toBe(\"log\");\n      expect(result.consoleOutput[0].args).toEqual([\"hello\", 123]);\n    });\n\n    it(\"records tool execution time\", async () => {\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}));\n\n      const result = (await tool.execute!(\n        { code: \"return 42\" },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.duration_ms).toBeGreaterThanOrEqual(0);\n    });\n  });\n\n  describe(\"tool bridge integration\", () => {\n    it(\"calls bridged tools and returns results\", async () => {\n      const mockExecute = mock((args: unknown) => {\n        const { filePath } = args as { filePath: string };\n        return {\n          success: true as const,\n          content: `Content of ${filePath}`,\n          file_size: 100,\n          modifiedTime: \"2025-01-01T00:00:00Z\",\n          lines_read: 1,\n        };\n      });\n\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), mockExecute),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        { code: 'return mux.file_read({ filePath: \"test.txt\" })' },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.result).toMatchObject({\n        content: \"Content of test.txt\",\n        success: true,\n      });\n      expect(mockExecute).toHaveBeenCalledTimes(1);\n    });\n\n    it(\"records tool calls in result\", async () => {\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() })),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        { code: 'mux.file_read({ filePath: \"a.txt\" }); return \"done\"' },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n      expect(result.toolCalls).toHaveLength(1);\n      expect(result.toolCalls[0].toolName).toBe(\"file_read\");\n      expect(result.toolCalls[0].args).toEqual({ filePath: \"a.txt\" });\n      expect(result.toolCalls[0].result).toMatchObject({\n        content: \"mock file content\",\n        success: true,\n      });\n      expect(result.toolCalls[0].duration_ms).toBeGreaterThanOrEqual(0);\n    });\n\n    it(\"validates tool arguments against schema\", async () => {\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() })),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        { code: \"return mux.file_read({ wrongField: 123 })\" },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      // Now caught by TypeScript type validation at compile time, not runtime\n      expect(result.success).toBe(false);\n      // Error message contains TypeScript diagnostic (e.g., \"filePath\" required)\n      expect(result.error).toContain(\"Code analysis failed\");\n    });\n\n    it(\"handles tool execution errors gracefully\", async () => {\n      const mockTools: Record<string, Tool> = {\n        failing_tool: createMockTool(\"failing_tool\", z.object({}), () => {\n          throw new Error(\"Tool failed!\");\n        }),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        { code: \"return mux.failing_tool({})\" },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Tool failed!\");\n      // Should still record the failed tool call\n      expect(result.toolCalls).toHaveLength(1);\n      expect(result.toolCalls[0].error).toContain(\"Tool failed!\");\n    });\n\n    it(\"returns partial results when execution fails mid-way\", async () => {\n      let callCount = 0;\n      const mockTools: Record<string, Tool> = {\n        counter: createMockTool(\"counter\", z.object({}), () => {\n          callCount++;\n          if (callCount === 2) {\n            throw new Error(\"Second call failed\");\n          }\n          return { count: callCount };\n        }),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const result = (await tool.execute!(\n        {\n          code: `\n            mux.counter({});\n            mux.counter({}); // This one fails\n            mux.counter({}); // Never reached\n            return \"done\";\n          `,\n        },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.toolCalls).toHaveLength(2);\n      expect(result.toolCalls[0].result).toEqual({ count: 1 });\n      expect(result.toolCalls[1].error).toContain(\"Second call failed\");\n    });\n  });\n\n  describe(\"event streaming\", () => {\n    it(\"emits events for tool calls\", async () => {\n      const events: PTCEvent[] = [];\n      const onEvent = (event: PTCEvent) => events.push(event);\n\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n      };\n\n      const tool = await createCodeExecutionTool(\n        runtimeFactory,\n        new ToolBridge(mockTools),\n        onEvent\n      );\n\n      await tool.execute!(\n        { code: 'return mux.file_read({ filePath: \"test.txt\" })' },\n        mockToolCallOptions\n      );\n\n      const toolCallEvents = events.filter(\n        (e) => e.type === \"tool-call-start\" || e.type === \"tool-call-end\"\n      );\n      expect(toolCallEvents).toHaveLength(2);\n      expect(toolCallEvents[0].type).toBe(\"tool-call-start\");\n      expect(toolCallEvents[1].type).toBe(\"tool-call-end\");\n    });\n\n    it(\"emits events for console output\", async () => {\n      const events: PTCEvent[] = [];\n      const onEvent = (event: PTCEvent) => events.push(event);\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge({}), onEvent);\n\n      await tool.execute!(\n        { code: 'console.log(\"test\"); console.warn(\"warning\"); return 1' },\n        mockToolCallOptions\n      );\n\n      const consoleEvents = events.filter((e) => e.type === \"console\");\n      expect(consoleEvents).toHaveLength(2);\n      expect(consoleEvents[0].level).toBe(\"log\");\n      expect(consoleEvents[1].level).toBe(\"warn\");\n    });\n  });\n\n  describe(\"abort handling\", () => {\n    it(\"aborts execution when signal is triggered\", async () => {\n      const mockTools: Record<string, Tool> = {\n        slow_tool: createMockTool(\"slow_tool\", z.object({}), async () => {\n          // Simulate slow operation\n          await new Promise((resolve) => setTimeout(resolve, 100));\n          return { done: true };\n        }),\n      };\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n      const abortController = new AbortController();\n\n      // Abort immediately\n      abortController.abort();\n\n      const result = (await tool.execute!(\n        { code: \"return mux.slow_tool({})\" },\n        { toolCallId: \"test-1\", messages: [], abortSignal: abortController.signal }\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"abort\");\n    });\n  });\n\n  describe(\"type caching\", () => {\n    it(\"returns consistent types for same tool set\", async () => {\n      clearTypeCaches();\n\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n      };\n\n      const tool1 = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n      const tool2 = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      const desc1 = (tool1 as { description?: string }).description ?? \"\";\n      const desc2 = (tool2 as { description?: string }).description ?? \"\";\n\n      expect(desc1).toBe(desc2);\n      expect(desc1).toContain(\"function file_read\");\n    });\n\n    it(\"regenerates types when tool set changes\", async () => {\n      clearTypeCaches();\n\n      const tools1: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n      };\n      const tools2: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n        bash: createMockTool(\"bash\", z.object({ script: z.string() }), () => ({\n          output: \"ok\",\n        })),\n      };\n\n      const tool1 = await createCodeExecutionTool(runtimeFactory, new ToolBridge(tools1));\n      const tool2 = await createCodeExecutionTool(runtimeFactory, new ToolBridge(tools2));\n\n      const desc1 = (tool1 as { description?: string }).description ?? \"\";\n      const desc2 = (tool2 as { description?: string }).description ?? \"\";\n\n      expect(desc1).not.toBe(desc2);\n      expect(desc1).not.toContain(\"function bash\");\n      expect(desc2).toContain(\"function bash\");\n    });\n\n    it(\"clearTypeCaches forces regeneration\", async () => {\n      const mockTools: Record<string, Tool> = {\n        file_read: createMockTool(\"file_read\", z.object({ filePath: z.string() }), () => ({\n          content: \"test\",\n        })),\n      };\n\n      // First call to populate cache\n      await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n\n      // Clear and verify new generation works\n      clearTypeCaches();\n\n      const tool = await createCodeExecutionTool(runtimeFactory, new ToolBridge(mockTools));\n      const desc = (tool as { description?: string }).description ?? \"\";\n      expect(desc).toContain(\"function file_read\");\n    });\n  });\n});\n"]}