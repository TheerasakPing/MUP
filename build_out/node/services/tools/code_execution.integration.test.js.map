{"version":3,"file":"code_execution.integration.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/code_execution.integration.test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Integration tests for code_execution tool with real tools\n *\n * These tests prove the full end-to-end flow: code_execution -> QuickJS sandbox -> real tools -> real filesystem.\n * Unlike unit tests, these use real LocalRuntime and actual file operations.\n *\n * Run with: bun test src/node/services/tools/code_execution.integration.test.ts\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport * as os from \"os\";\nimport { createCodeExecutionTool } from \"./code_execution\";\nimport { createFileReadTool } from \"./file_read\";\nimport { createBashTool } from \"./bash\";\nimport { QuickJSRuntimeFactory } from \"@/node/services/ptc/quickjsRuntime\";\nimport { ToolBridge } from \"@/node/services/ptc/toolBridge\";\nimport type { Tool, ToolExecutionOptions } from \"ai\";\nimport type { PTCEvent, PTCExecutionResult, PTCToolCallEndEvent } from \"@/node/services/ptc/types\";\nimport { createTestToolConfig, TestTempDir, getTestDeps } from \"./testHelpers\";\nimport { z } from \"zod\";\n\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"integration-test-call\",\n  messages: [],\n};\n\ndescribe(\"code_execution integration tests\", () => {\n  const runtimeFactory = new QuickJSRuntimeFactory();\n  let testDir: string;\n  let toolConfig: ReturnType<typeof createTestToolConfig>;\n\n  beforeEach(async () => {\n    // Create a temp directory for each test\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"ptc-integration-\"));\n    toolConfig = createTestToolConfig(testDir);\n  });\n\n  afterEach(async () => {\n    await fs.rm(testDir, { recursive: true, force: true });\n  });\n\n  describe(\"file_read through sandbox\", () => {\n    it(\n      \"reads a real file via mux.file_read()\",\n      async () => {\n        // Create a real file\n        const testContent = \"hello from integration test\\nline two\\nline three\";\n        await fs.writeFile(path.join(testDir, \"test.txt\"), testContent);\n\n        // Create real file_read tool\n        const fileReadTool = createFileReadTool(toolConfig);\n        const tools: Record<string, Tool> = { file_read: fileReadTool };\n\n        // Track events\n        const events: PTCEvent[] = [];\n        const codeExecutionTool = await createCodeExecutionTool(\n          runtimeFactory,\n          new ToolBridge(tools),\n          (e) => events.push(e)\n        );\n\n        // Execute code that reads the file\n        const code = `\n        const result = mux.file_read({ file_path: \"test.txt\" });\n        return result;\n      `;\n\n        const result = (await codeExecutionTool.execute!(\n          { code },\n          mockToolCallOptions\n        )) as PTCExecutionResult;\n\n        // Verify the result contains the file content\n        expect(result).toBeDefined();\n        expect(result.success).toBe(true);\n\n        // The result should be the file_read response\n        const fileReadResult = result.result as {\n          success: boolean;\n          content?: string;\n          lines_read?: number;\n        };\n        expect(fileReadResult.success).toBe(true);\n        expect(fileReadResult.content).toContain(\"hello from integration test\");\n        expect(fileReadResult.lines_read).toBe(3);\n\n        // Verify tool call event was emitted\n        const toolCallEndEvents = events.filter(\n          (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\n        );\n        expect(toolCallEndEvents.length).toBe(1);\n        expect(toolCallEndEvents[0].toolName).toBe(\"file_read\");\n        expect(toolCallEndEvents[0].error).toBeUndefined();\n      },\n      { timeout: 20_000 }\n    );\n\n    it(\n      \"handles file not found gracefully\",\n      async () => {\n        const fileReadTool = createFileReadTool(toolConfig);\n        const tools: Record<string, Tool> = { file_read: fileReadTool };\n\n        const codeExecutionTool = await createCodeExecutionTool(\n          runtimeFactory,\n          new ToolBridge(tools)\n        );\n\n        const code = `\n        const result = mux.file_read({ file_path: \"nonexistent.txt\" });\n        return result;\n      `;\n\n        const result = (await codeExecutionTool.execute!(\n          { code },\n          mockToolCallOptions\n        )) as PTCExecutionResult;\n\n        expect(result.success).toBe(true);\n\n        // file_read returns success: false for missing files, not an exception\n        const fileReadResult = result.result as { success: boolean; error?: string };\n        expect(fileReadResult.success).toBe(false);\n        // Error contains ENOENT or stat failure message\n        expect(fileReadResult.error).toMatch(/ENOENT|stat/i);\n      },\n      { timeout: 20_000 }\n    );\n  });\n\n  describe(\"bash through sandbox\", () => {\n    it(\"executes a real bash command via mux.bash()\", async () => {\n      // Create real bash tool\n      const tempDir = new TestTempDir(\"ptc-bash-integration\");\n      const bashConfig = {\n        ...toolConfig,\n        ...getTestDeps(),\n        runtimeTempDir: tempDir.path,\n      };\n      const bashTool = createBashTool(bashConfig);\n      const tools: Record<string, Tool> = { bash: bashTool };\n\n      const events: PTCEvent[] = [];\n      const codeExecutionTool = await createCodeExecutionTool(\n        runtimeFactory,\n        new ToolBridge(tools),\n        (e) => events.push(e)\n      );\n\n      // Execute a simple echo command\n      const code = `\n        const result = mux.bash({\n          script: \"echo 'hello from sandbox'\",\n          timeout_secs: 5,\n          run_in_background: false,\n          display_name: \"test echo\"\n        });\n        return result;\n      `;\n\n      const result = (await codeExecutionTool.execute!(\n        { code },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n\n      const bashResult = result.result as { success: boolean; output?: string };\n      expect(bashResult.success).toBe(true);\n      expect(bashResult.output).toContain(\"hello from sandbox\");\n\n      // Verify event\n      const toolCallEndEvents = events.filter(\n        (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\n      );\n      expect(toolCallEndEvents.length).toBe(1);\n      expect(toolCallEndEvents[0].toolName).toBe(\"bash\");\n\n      tempDir[Symbol.dispose]();\n    });\n\n    it(\"creates a file via bash and reads it via file_read\", async () => {\n      // This test proves multiple tools can work together in a single sandbox execution\n      const tempDir = new TestTempDir(\"ptc-multi-tool-integration\");\n      const bashConfig = {\n        ...toolConfig,\n        ...getTestDeps(),\n        runtimeTempDir: tempDir.path,\n      };\n\n      const bashTool = createBashTool(bashConfig);\n      const fileReadTool = createFileReadTool(toolConfig);\n      const tools: Record<string, Tool> = {\n        bash: bashTool,\n        file_read: fileReadTool,\n      };\n\n      const events: PTCEvent[] = [];\n      const codeExecutionTool = await createCodeExecutionTool(\n        runtimeFactory,\n        new ToolBridge(tools),\n        (e) => events.push(e)\n      );\n\n      // Code that creates a file with bash, then reads it with file_read\n      const code = `\n        // Create a file using bash\n        const bashResult = mux.bash({\n          script: \"echo 'created by sandbox' > sandbox_created.txt\",\n          timeout_secs: 5,\n          run_in_background: false,\n          display_name: \"create file\"\n        });\n        \n        if (!bashResult.success) {\n          return { error: \"bash failed\", bashResult };\n        }\n        \n        // Read the file we just created\n        const readResult = mux.file_read({ file_path: \"sandbox_created.txt\" });\n        \n        return {\n          bashResult,\n          readResult,\n          fileWasCreated: readResult.success && readResult.content.includes(\"created by sandbox\")\n        };\n      `;\n\n      const result = (await codeExecutionTool.execute!(\n        { code },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n\n      const combinedResult = result.result as {\n        bashResult: { success: boolean };\n        readResult: { success: boolean; content?: string };\n        fileWasCreated: boolean;\n      };\n      expect(combinedResult.bashResult.success).toBe(true);\n      expect(combinedResult.readResult.success).toBe(true);\n      expect(combinedResult.fileWasCreated).toBe(true);\n\n      // Verify both tool calls were recorded\n      const toolCallEndEvents = events.filter(\n        (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\n      );\n      expect(toolCallEndEvents.length).toBe(2);\n      expect(toolCallEndEvents.map((e) => e.toolName).sort()).toEqual([\"bash\", \"file_read\"]);\n\n      // Verify file actually exists on disk\n      const fileExists = await fs\n        .access(path.join(testDir, \"sandbox_created.txt\"))\n        .then(() => true)\n        .catch(() => false);\n      expect(fileExists).toBe(true);\n\n      tempDir[Symbol.dispose]();\n    });\n  });\n\n  describe(\"error handling\", () => {\n    it(\"returns validation error for invalid tool arguments\", async () => {\n      const fileReadTool = createFileReadTool(toolConfig);\n      const tools: Record<string, Tool> = { file_read: fileReadTool };\n\n      const codeExecutionTool = await createCodeExecutionTool(\n        runtimeFactory,\n        new ToolBridge(tools)\n      );\n\n      // Call file_read without required file_path argument\n      const code = `\n        const result = mux.file_read({});\n        return result;\n      `;\n\n      const result = (await codeExecutionTool.execute!(\n        { code },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      // Tool bridge validation throws, which causes sandbox execution to fail\n      // The error is propagated to the PTCExecutionResult\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"file_path\");\n    });\n\n    it(\"handles tool execution exceptions gracefully\", async () => {\n      // Create a tool that throws\n      const throwingTool: Tool = {\n        description: \"A tool that throws\",\n        inputSchema: z.object({}),\n        execute: () => {\n          throw new Error(\"Intentional test error\");\n        },\n      };\n\n      const tools: Record<string, Tool> = { throwing_tool: throwingTool };\n\n      const events: PTCEvent[] = [];\n      const codeExecutionTool = await createCodeExecutionTool(\n        runtimeFactory,\n        new ToolBridge(tools),\n        (e) => events.push(e)\n      );\n\n      const code = `\n        const result = mux.throwing_tool({});\n        return result;\n      `;\n\n      const result = (await codeExecutionTool.execute!(\n        { code },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      // Tool exception causes sandbox execution to fail\n      // The error is propagated to the PTCExecutionResult\n      expect(result.success).toBe(false);\n      expect(result.error).toContain(\"Intentional test error\");\n\n      // Event should record failure\n      const toolCallEndEvents = events.filter(\n        (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\n      );\n      expect(toolCallEndEvents.length).toBe(1);\n      expect(toolCallEndEvents[0].error).toContain(\"Intentional test error\");\n    });\n  });\n\n  describe(\"console logging\", () => {\n    it(\"captures console.log from sandbox code\", async () => {\n      const fileReadTool = createFileReadTool(toolConfig);\n      const tools: Record<string, Tool> = { file_read: fileReadTool };\n\n      const events: PTCEvent[] = [];\n      const codeExecutionTool = await createCodeExecutionTool(\n        runtimeFactory,\n        new ToolBridge(tools),\n        (e) => events.push(e)\n      );\n\n      const code = `\n        console.log(\"debug message from sandbox\");\n        console.warn(\"warning message\");\n        console.error(\"error message\");\n        return \"done\";\n      `;\n\n      const result = (await codeExecutionTool.execute!(\n        { code },\n        mockToolCallOptions\n      )) as PTCExecutionResult;\n\n      expect(result.success).toBe(true);\n\n      // Verify console events\n      const consoleEvents = events.filter((e) => e.type === \"console\");\n      expect(consoleEvents.length).toBe(3);\n      expect(consoleEvents.map((e) => (e as { level: string }).level)).toEqual([\n        \"log\",\n        \"warn\",\n        \"error\",\n      ]);\n    });\n  });\n});\n"]}