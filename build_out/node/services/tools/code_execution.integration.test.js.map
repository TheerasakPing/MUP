{"version":3,"file":"code_execution.integration.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/code_execution.integration.test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Integration tests for code_execution tool with real tools\r\n *\r\n * These tests prove the full end-to-end flow: code_execution -> QuickJS sandbox -> real tools -> real filesystem.\r\n * Unlike unit tests, these use real LocalRuntime and actual file operations.\r\n *\r\n * Run with: bun test src/node/services/tools/code_execution.integration.test.ts\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { createCodeExecutionTool } from \"./code_execution\";\r\nimport { createFileReadTool } from \"./file_read\";\r\nimport { createBashTool } from \"./bash\";\r\nimport { QuickJSRuntimeFactory } from \"@/node/services/ptc/quickjsRuntime\";\r\nimport { ToolBridge } from \"@/node/services/ptc/toolBridge\";\r\nimport type { Tool, ToolExecutionOptions } from \"ai\";\r\nimport type { PTCEvent, PTCExecutionResult, PTCToolCallEndEvent } from \"@/node/services/ptc/types\";\r\nimport { createTestToolConfig, TestTempDir, getTestDeps } from \"./testHelpers\";\r\nimport { z } from \"zod\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"integration-test-call\",\r\n  messages: [],\r\n};\r\n\r\ndescribe(\"code_execution integration tests\", () => {\r\n  const runtimeFactory = new QuickJSRuntimeFactory();\r\n  let testDir: string;\r\n  let toolConfig: ReturnType<typeof createTestToolConfig>;\r\n\r\n  beforeEach(async () => {\r\n    // Create a temp directory for each test\r\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"ptc-integration-\"));\r\n    toolConfig = createTestToolConfig(testDir);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(testDir, { recursive: true, force: true });\r\n  });\r\n\r\n  describe(\"file_read through sandbox\", () => {\r\n    it(\r\n      \"reads a real file via mux.file_read()\",\r\n      async () => {\r\n        // Create a real file\r\n        const testContent = \"hello from integration test\\nline two\\nline three\";\r\n        await fs.writeFile(path.join(testDir, \"test.txt\"), testContent);\r\n\r\n        // Create real file_read tool\r\n        const fileReadTool = createFileReadTool(toolConfig);\r\n        const tools: Record<string, Tool> = { file_read: fileReadTool };\r\n\r\n        // Track events\r\n        const events: PTCEvent[] = [];\r\n        const codeExecutionTool = await createCodeExecutionTool(\r\n          runtimeFactory,\r\n          new ToolBridge(tools),\r\n          (e) => events.push(e)\r\n        );\r\n\r\n        // Execute code that reads the file\r\n        const code = `\r\n        const result = mux.file_read({ file_path: \"test.txt\" });\r\n        return result;\r\n      `;\r\n\r\n        const result = (await codeExecutionTool.execute!(\r\n          { code },\r\n          mockToolCallOptions\r\n        )) as PTCExecutionResult;\r\n\r\n        // Verify the result contains the file content\r\n        expect(result).toBeDefined();\r\n        expect(result.success).toBe(true);\r\n\r\n        // The result should be the file_read response\r\n        const fileReadResult = result.result as {\r\n          success: boolean;\r\n          content?: string;\r\n          lines_read?: number;\r\n        };\r\n        expect(fileReadResult.success).toBe(true);\r\n        expect(fileReadResult.content).toContain(\"hello from integration test\");\r\n        expect(fileReadResult.lines_read).toBe(3);\r\n\r\n        // Verify tool call event was emitted\r\n        const toolCallEndEvents = events.filter(\r\n          (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\r\n        );\r\n        expect(toolCallEndEvents.length).toBe(1);\r\n        expect(toolCallEndEvents[0].toolName).toBe(\"file_read\");\r\n        expect(toolCallEndEvents[0].error).toBeUndefined();\r\n      },\r\n      { timeout: 20_000 }\r\n    );\r\n\r\n    it(\r\n      \"handles file not found gracefully\",\r\n      async () => {\r\n        const fileReadTool = createFileReadTool(toolConfig);\r\n        const tools: Record<string, Tool> = { file_read: fileReadTool };\r\n\r\n        const codeExecutionTool = await createCodeExecutionTool(\r\n          runtimeFactory,\r\n          new ToolBridge(tools)\r\n        );\r\n\r\n        const code = `\r\n        const result = mux.file_read({ file_path: \"nonexistent.txt\" });\r\n        return result;\r\n      `;\r\n\r\n        const result = (await codeExecutionTool.execute!(\r\n          { code },\r\n          mockToolCallOptions\r\n        )) as PTCExecutionResult;\r\n\r\n        expect(result.success).toBe(true);\r\n\r\n        // file_read returns success: false for missing files, not an exception\r\n        const fileReadResult = result.result as { success: boolean; error?: string };\r\n        expect(fileReadResult.success).toBe(false);\r\n        // Error contains ENOENT or stat failure message\r\n        expect(fileReadResult.error).toMatch(/ENOENT|stat/i);\r\n      },\r\n      { timeout: 20_000 }\r\n    );\r\n  });\r\n\r\n  describe(\"bash through sandbox\", () => {\r\n    it(\"executes a real bash command via mux.bash()\", async () => {\r\n      // Create real bash tool\r\n      const tempDir = new TestTempDir(\"ptc-bash-integration\");\r\n      const bashConfig = {\r\n        ...toolConfig,\r\n        ...getTestDeps(),\r\n        runtimeTempDir: tempDir.path,\r\n      };\r\n      const bashTool = createBashTool(bashConfig);\r\n      const tools: Record<string, Tool> = { bash: bashTool };\r\n\r\n      const events: PTCEvent[] = [];\r\n      const codeExecutionTool = await createCodeExecutionTool(\r\n        runtimeFactory,\r\n        new ToolBridge(tools),\r\n        (e) => events.push(e)\r\n      );\r\n\r\n      // Execute a simple echo command\r\n      const code = `\r\n        const result = mux.bash({\r\n          script: \"echo 'hello from sandbox'\",\r\n          timeout_secs: 5,\r\n          run_in_background: false,\r\n          display_name: \"test echo\"\r\n        });\r\n        return result;\r\n      `;\r\n\r\n      const result = (await codeExecutionTool.execute!(\r\n        { code },\r\n        mockToolCallOptions\r\n      )) as PTCExecutionResult;\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      const bashResult = result.result as { success: boolean; output?: string };\r\n      expect(bashResult.success).toBe(true);\r\n      expect(bashResult.output).toContain(\"hello from sandbox\");\r\n\r\n      // Verify event\r\n      const toolCallEndEvents = events.filter(\r\n        (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\r\n      );\r\n      expect(toolCallEndEvents.length).toBe(1);\r\n      expect(toolCallEndEvents[0].toolName).toBe(\"bash\");\r\n\r\n      tempDir[Symbol.dispose]();\r\n    });\r\n\r\n    it(\"creates a file via bash and reads it via file_read\", async () => {\r\n      // This test proves multiple tools can work together in a single sandbox execution\r\n      const tempDir = new TestTempDir(\"ptc-multi-tool-integration\");\r\n      const bashConfig = {\r\n        ...toolConfig,\r\n        ...getTestDeps(),\r\n        runtimeTempDir: tempDir.path,\r\n      };\r\n\r\n      const bashTool = createBashTool(bashConfig);\r\n      const fileReadTool = createFileReadTool(toolConfig);\r\n      const tools: Record<string, Tool> = {\r\n        bash: bashTool,\r\n        file_read: fileReadTool,\r\n      };\r\n\r\n      const events: PTCEvent[] = [];\r\n      const codeExecutionTool = await createCodeExecutionTool(\r\n        runtimeFactory,\r\n        new ToolBridge(tools),\r\n        (e) => events.push(e)\r\n      );\r\n\r\n      // Code that creates a file with bash, then reads it with file_read\r\n      const code = `\r\n        // Create a file using bash\r\n        const bashResult = mux.bash({\r\n          script: \"echo 'created by sandbox' > sandbox_created.txt\",\r\n          timeout_secs: 5,\r\n          run_in_background: false,\r\n          display_name: \"create file\"\r\n        });\r\n        \r\n        if (!bashResult.success) {\r\n          return { error: \"bash failed\", bashResult };\r\n        }\r\n        \r\n        // Read the file we just created\r\n        const readResult = mux.file_read({ file_path: \"sandbox_created.txt\" });\r\n        \r\n        return {\r\n          bashResult,\r\n          readResult,\r\n          fileWasCreated: readResult.success && readResult.content.includes(\"created by sandbox\")\r\n        };\r\n      `;\r\n\r\n      const result = (await codeExecutionTool.execute!(\r\n        { code },\r\n        mockToolCallOptions\r\n      )) as PTCExecutionResult;\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      const combinedResult = result.result as {\r\n        bashResult: { success: boolean };\r\n        readResult: { success: boolean; content?: string };\r\n        fileWasCreated: boolean;\r\n      };\r\n      expect(combinedResult.bashResult.success).toBe(true);\r\n      expect(combinedResult.readResult.success).toBe(true);\r\n      expect(combinedResult.fileWasCreated).toBe(true);\r\n\r\n      // Verify both tool calls were recorded\r\n      const toolCallEndEvents = events.filter(\r\n        (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\r\n      );\r\n      expect(toolCallEndEvents.length).toBe(2);\r\n      expect(toolCallEndEvents.map((e) => e.toolName).sort()).toEqual([\"bash\", \"file_read\"]);\r\n\r\n      // Verify file actually exists on disk\r\n      const fileExists = await fs\r\n        .access(path.join(testDir, \"sandbox_created.txt\"))\r\n        .then(() => true)\r\n        .catch(() => false);\r\n      expect(fileExists).toBe(true);\r\n\r\n      tempDir[Symbol.dispose]();\r\n    });\r\n  });\r\n\r\n  describe(\"error handling\", () => {\r\n    it(\"returns validation error for invalid tool arguments\", async () => {\r\n      const fileReadTool = createFileReadTool(toolConfig);\r\n      const tools: Record<string, Tool> = { file_read: fileReadTool };\r\n\r\n      const codeExecutionTool = await createCodeExecutionTool(\r\n        runtimeFactory,\r\n        new ToolBridge(tools)\r\n      );\r\n\r\n      // Call file_read without required file_path argument\r\n      const code = `\r\n        const result = mux.file_read({});\r\n        return result;\r\n      `;\r\n\r\n      const result = (await codeExecutionTool.execute!(\r\n        { code },\r\n        mockToolCallOptions\r\n      )) as PTCExecutionResult;\r\n\r\n      // Tool bridge validation throws, which causes sandbox execution to fail\r\n      // The error is propagated to the PTCExecutionResult\r\n      expect(result.success).toBe(false);\r\n      expect(result.error).toContain(\"file_path\");\r\n    });\r\n\r\n    it(\"handles tool execution exceptions gracefully\", async () => {\r\n      // Create a tool that throws\r\n      const throwingTool: Tool = {\r\n        description: \"A tool that throws\",\r\n        inputSchema: z.object({}),\r\n        execute: () => {\r\n          throw new Error(\"Intentional test error\");\r\n        },\r\n      };\r\n\r\n      const tools: Record<string, Tool> = { throwing_tool: throwingTool };\r\n\r\n      const events: PTCEvent[] = [];\r\n      const codeExecutionTool = await createCodeExecutionTool(\r\n        runtimeFactory,\r\n        new ToolBridge(tools),\r\n        (e) => events.push(e)\r\n      );\r\n\r\n      const code = `\r\n        const result = mux.throwing_tool({});\r\n        return result;\r\n      `;\r\n\r\n      const result = (await codeExecutionTool.execute!(\r\n        { code },\r\n        mockToolCallOptions\r\n      )) as PTCExecutionResult;\r\n\r\n      // Tool exception causes sandbox execution to fail\r\n      // The error is propagated to the PTCExecutionResult\r\n      expect(result.success).toBe(false);\r\n      expect(result.error).toContain(\"Intentional test error\");\r\n\r\n      // Event should record failure\r\n      const toolCallEndEvents = events.filter(\r\n        (e): e is PTCToolCallEndEvent => e.type === \"tool-call-end\"\r\n      );\r\n      expect(toolCallEndEvents.length).toBe(1);\r\n      expect(toolCallEndEvents[0].error).toContain(\"Intentional test error\");\r\n    });\r\n  });\r\n\r\n  describe(\"console logging\", () => {\r\n    it(\"captures console.log from sandbox code\", async () => {\r\n      const fileReadTool = createFileReadTool(toolConfig);\r\n      const tools: Record<string, Tool> = { file_read: fileReadTool };\r\n\r\n      const events: PTCEvent[] = [];\r\n      const codeExecutionTool = await createCodeExecutionTool(\r\n        runtimeFactory,\r\n        new ToolBridge(tools),\r\n        (e) => events.push(e)\r\n      );\r\n\r\n      const code = `\r\n        console.log(\"debug message from sandbox\");\r\n        console.warn(\"warning message\");\r\n        console.error(\"error message\");\r\n        return \"done\";\r\n      `;\r\n\r\n      const result = (await codeExecutionTool.execute!(\r\n        { code },\r\n        mockToolCallOptions\r\n      )) as PTCExecutionResult;\r\n\r\n      expect(result.success).toBe(true);\r\n\r\n      // Verify console events\r\n      const consoleEvents = events.filter((e) => e.type === \"console\");\r\n      expect(consoleEvents.length).toBe(3);\r\n      expect(consoleEvents.map((e) => (e as { level: string }).level)).toEqual([\r\n        \"log\",\r\n        \"warn\",\r\n        \"error\",\r\n      ]);\r\n    });\r\n  });\r\n});\r\n"]}