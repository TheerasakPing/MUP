{"version":3,"file":"mux_global_agents_write.js","sourceRoot":"","sources":["../../../../src/node/services/tools/mux_global_agents_write.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport { tool } from \"ai\";\r\n\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { FILE_EDIT_DIFF_OMITTED_MESSAGE } from \"@/common/types/tools\";\r\nimport { generateDiff } from \"./fileCommon\";\r\n\r\nfunction getMuxHomeFromWorkspaceSessionDir(config: ToolConfiguration): string {\r\n  if (!config.workspaceSessionDir) {\r\n    throw new Error(\"mux_global_agents_write requires workspaceSessionDir\");\r\n  }\r\n\r\n  // workspaceSessionDir = <muxHome>/sessions/<workspaceId>\r\n  const sessionsDir = path.dirname(config.workspaceSessionDir);\r\n  return path.dirname(sessionsDir);\r\n}\r\n\r\nexport interface MuxGlobalAgentsWriteToolArgs {\r\n  newContent: string;\r\n  confirm: boolean;\r\n}\r\n\r\nexport interface MuxGlobalAgentsWriteToolResult {\r\n  success: true;\r\n  diff: string;\r\n  ui_only?: {\r\n    file_edit?: {\r\n      diff: string;\r\n    };\r\n  };\r\n}\r\n\r\nexport interface MuxGlobalAgentsWriteToolError {\r\n  success: false;\r\n  error: string;\r\n}\r\n\r\nexport type MuxGlobalAgentsWriteToolOutput =\r\n  | MuxGlobalAgentsWriteToolResult\r\n  | MuxGlobalAgentsWriteToolError;\r\n\r\nexport const createMuxGlobalAgentsWriteTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.mux_global_agents_write.description,\r\n    inputSchema: TOOL_DEFINITIONS.mux_global_agents_write.schema,\r\n    execute: async (\r\n      args: MuxGlobalAgentsWriteToolArgs,\r\n      { abortSignal: _abortSignal }\r\n    ): Promise<MuxGlobalAgentsWriteToolOutput> => {\r\n      try {\r\n        if (config.workspaceId !== MUX_HELP_CHAT_WORKSPACE_ID) {\r\n          return {\r\n            success: false,\r\n            error:\r\n              \"mux_global_agents_write is only available in the Chat with Mux system workspace\",\r\n          };\r\n        }\r\n\r\n        if (!args.confirm) {\r\n          return {\r\n            success: false,\r\n            error: \"Refusing to write global AGENTS.md without confirm: true\",\r\n          };\r\n        }\r\n\r\n        const muxHome = getMuxHomeFromWorkspaceSessionDir(config);\r\n        await fsPromises.mkdir(muxHome, { recursive: true });\r\n\r\n        // Canonicalize muxHome before constructing the file path.\r\n        const muxHomeReal = await fsPromises.realpath(muxHome);\r\n        const agentsPath = path.join(muxHomeReal, \"AGENTS.md\");\r\n\r\n        let originalContent = \"\";\r\n        try {\r\n          const stat = await fsPromises.lstat(agentsPath);\r\n          if (stat.isSymbolicLink()) {\r\n            return {\r\n              success: false,\r\n              error: \"Refusing to write a symlinked AGENTS.md target\",\r\n            };\r\n          }\r\n          originalContent = await fsPromises.readFile(agentsPath, \"utf-8\");\r\n\r\n          // If the file exists, ensure its resolved path matches the resolved muxHome target.\r\n          const agentsPathReal = await fsPromises.realpath(agentsPath);\r\n          if (agentsPathReal !== agentsPath) {\r\n            return {\r\n              success: false,\r\n              error: \"Refusing to write global AGENTS.md (path resolution mismatch)\",\r\n            };\r\n          }\r\n        } catch (error) {\r\n          if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\r\n            throw error;\r\n          }\r\n          // File missing is OK (will create).\r\n        }\r\n\r\n        await fsPromises.writeFile(agentsPath, args.newContent, \"utf-8\");\r\n\r\n        const diff = generateDiff(agentsPath, originalContent, args.newContent);\r\n\r\n        return {\r\n          success: true,\r\n          diff: FILE_EDIT_DIFF_OMITTED_MESSAGE,\r\n          ui_only: {\r\n            file_edit: {\r\n              diff,\r\n            },\r\n          },\r\n        };\r\n      } catch (error) {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        return {\r\n          success: false,\r\n          error: `Failed to write global AGENTS.md: ${message}`,\r\n        };\r\n      }\r\n    },\r\n  });\r\n};\r\n"]}