{"version":3,"file":"mux_global_agents_write.js","sourceRoot":"","sources":["../../../../src/node/services/tools/mux_global_agents_write.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\";\nimport * as fsPromises from \"fs/promises\";\nimport { tool } from \"ai\";\n\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\nimport { FILE_EDIT_DIFF_OMITTED_MESSAGE } from \"@/common/types/tools\";\nimport { generateDiff } from \"./fileCommon\";\n\nfunction getMuxHomeFromWorkspaceSessionDir(config: ToolConfiguration): string {\n  if (!config.workspaceSessionDir) {\n    throw new Error(\"mux_global_agents_write requires workspaceSessionDir\");\n  }\n\n  // workspaceSessionDir = <muxHome>/sessions/<workspaceId>\n  const sessionsDir = path.dirname(config.workspaceSessionDir);\n  return path.dirname(sessionsDir);\n}\n\nexport interface MuxGlobalAgentsWriteToolArgs {\n  newContent: string;\n  confirm: boolean;\n}\n\nexport interface MuxGlobalAgentsWriteToolResult {\n  success: true;\n  diff: string;\n  ui_only?: {\n    file_edit?: {\n      diff: string;\n    };\n  };\n}\n\nexport interface MuxGlobalAgentsWriteToolError {\n  success: false;\n  error: string;\n}\n\nexport type MuxGlobalAgentsWriteToolOutput =\n  | MuxGlobalAgentsWriteToolResult\n  | MuxGlobalAgentsWriteToolError;\n\nexport const createMuxGlobalAgentsWriteTool: ToolFactory = (config: ToolConfiguration) => {\n  return tool({\n    description: TOOL_DEFINITIONS.mux_global_agents_write.description,\n    inputSchema: TOOL_DEFINITIONS.mux_global_agents_write.schema,\n    execute: async (\n      args: MuxGlobalAgentsWriteToolArgs,\n      { abortSignal: _abortSignal }\n    ): Promise<MuxGlobalAgentsWriteToolOutput> => {\n      try {\n        if (config.workspaceId !== MUX_HELP_CHAT_WORKSPACE_ID) {\n          return {\n            success: false,\n            error:\n              \"mux_global_agents_write is only available in the Chat with Mux system workspace\",\n          };\n        }\n\n        if (!args.confirm) {\n          return {\n            success: false,\n            error: \"Refusing to write global AGENTS.md without confirm: true\",\n          };\n        }\n\n        const muxHome = getMuxHomeFromWorkspaceSessionDir(config);\n        await fsPromises.mkdir(muxHome, { recursive: true });\n\n        // Canonicalize muxHome before constructing the file path.\n        const muxHomeReal = await fsPromises.realpath(muxHome);\n        const agentsPath = path.join(muxHomeReal, \"AGENTS.md\");\n\n        let originalContent = \"\";\n        try {\n          const stat = await fsPromises.lstat(agentsPath);\n          if (stat.isSymbolicLink()) {\n            return {\n              success: false,\n              error: \"Refusing to write a symlinked AGENTS.md target\",\n            };\n          }\n          originalContent = await fsPromises.readFile(agentsPath, \"utf-8\");\n\n          // If the file exists, ensure its resolved path matches the resolved muxHome target.\n          const agentsPathReal = await fsPromises.realpath(agentsPath);\n          if (agentsPathReal !== agentsPath) {\n            return {\n              success: false,\n              error: \"Refusing to write global AGENTS.md (path resolution mismatch)\",\n            };\n          }\n        } catch (error) {\n          if (!(error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\")) {\n            throw error;\n          }\n          // File missing is OK (will create).\n        }\n\n        await fsPromises.writeFile(agentsPath, args.newContent, \"utf-8\");\n\n        const diff = generateDiff(agentsPath, originalContent, args.newContent);\n\n        return {\n          success: true,\n          diff: FILE_EDIT_DIFF_OMITTED_MESSAGE,\n          ui_only: {\n            file_edit: {\n              diff,\n            },\n          },\n        };\n      } catch (error) {\n        const message = error instanceof Error ? error.message : String(error);\n        return {\n          success: false,\n          error: `Failed to write global AGENTS.md: ${message}`,\n        };\n      }\n    },\n  });\n};\n"]}