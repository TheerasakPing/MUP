{"version":3,"file":"task.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, mock } from \"bun:test\";\nimport type { ToolExecutionOptions } from \"ai\";\nimport type { TaskCreatedEvent } from \"@/common/types/stream\";\n\nimport { createTaskTool } from \"./task\";\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\nimport { Ok, Err } from \"@/common/types/result\";\nimport type { TaskService } from \"@/node/services/taskService\";\n\n// Mock ToolCallOptions for testing\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\nfunction expectQueuedOrRunningTaskToolResult(\n  result: unknown,\n  expected: { status: \"queued\" | \"running\"; taskId: string }\n): void {\n  expect(result).toBeTruthy();\n  expect(typeof result).toBe(\"object\");\n  expect(result).not.toBeNull();\n\n  const obj = result as Record<string, unknown>;\n  expect(obj.status).toBe(expected.status);\n  expect(obj.taskId).toBe(expected.taskId);\n\n  const note = obj.note;\n  expect(typeof note).toBe(\"string\");\n  if (typeof note === \"string\") {\n    expect(note).toContain(\"task_await\");\n  }\n}\n\ndescribe(\"task tool\", () => {\n  it(\"should return immediately when run_in_background is true\", async () => {\n    using tempDir = new TestTempDir(\"test-task-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\n\n    const create = mock(() =>\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"queued\" as const })\n    );\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ignored\" }));\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\n\n    const tool = createTaskTool({\n      ...baseConfig,\n      muxEnv: { MUX_MODEL_STRING: \"openai:gpt-4o-mini\", MUX_THINKING_LEVEL: \"high\" },\n      taskService,\n    });\n\n    const result: unknown = await Promise.resolve(\n      tool.execute!(\n        { subagent_type: \"explore\", prompt: \"do it\", title: \"Child task\", run_in_background: true },\n        mockToolCallOptions\n      )\n    );\n\n    expect(create).toHaveBeenCalled();\n    expect(waitForAgentReport).not.toHaveBeenCalled();\n    expectQueuedOrRunningTaskToolResult(result, { status: \"queued\", taskId: \"child-task\" });\n  });\n\n  it(\"should allow sub-agent workspaces to spawn nested tasks\", async () => {\n    using tempDir = new TestTempDir(\"test-task-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"child-workspace\" });\n\n    const create = mock(() =>\n      Ok({ taskId: \"grandchild-task\", kind: \"agent\" as const, status: \"queued\" as const })\n    );\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ignored\" }));\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\n\n    const tool = createTaskTool({\n      ...baseConfig,\n      enableAgentReport: true,\n      taskService,\n    });\n\n    const result: unknown = await Promise.resolve(\n      tool.execute!(\n        {\n          subagent_type: \"explore\",\n          prompt: \"do it\",\n          title: \"Grandchild task\",\n          run_in_background: true,\n        },\n        mockToolCallOptions\n      )\n    );\n\n    expect(create).toHaveBeenCalledWith(\n      expect.objectContaining({\n        parentWorkspaceId: \"child-workspace\",\n        kind: \"agent\",\n        agentId: \"explore\",\n        agentType: \"explore\",\n      })\n    );\n    expectQueuedOrRunningTaskToolResult(result, { status: \"queued\", taskId: \"grandchild-task\" });\n  });\n\n  it(\"should block and return report when run_in_background is false\", async () => {\n    using tempDir = new TestTempDir(\"test-task-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\n\n    const events: TaskCreatedEvent[] = [];\n    let didEmitTaskCreated = false;\n\n    const create = mock(() =>\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"running\" as const })\n    );\n    const waitForAgentReport = mock(() => {\n      // The main thing we care about: emit the UI-only taskId before we block waiting for the report.\n      expect(didEmitTaskCreated).toBe(true);\n      return Promise.resolve({\n        reportMarkdown: \"Hello from child\",\n        title: \"Result\",\n      });\n    });\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\n\n    const tool = createTaskTool({\n      ...baseConfig,\n      emitChatEvent: (event) => {\n        if (event.type === \"task-created\") {\n          didEmitTaskCreated = true;\n          events.push(event);\n        }\n      },\n      taskService,\n    });\n\n    const result: unknown = await Promise.resolve(\n      tool.execute!(\n        {\n          subagent_type: \"explore\",\n          prompt: \"do it\",\n          title: \"Child task\",\n          run_in_background: false,\n        },\n        mockToolCallOptions\n      )\n    );\n\n    expect(create).toHaveBeenCalled();\n    expect(waitForAgentReport).toHaveBeenCalledWith(\"child-task\", expect.any(Object));\n\n    expect(events).toHaveLength(1);\n    const taskCreated = events[0];\n    if (!taskCreated) {\n      throw new Error(\"Expected a task-created event\");\n    }\n\n    expect(taskCreated.type).toBe(\"task-created\");\n\n    const parentWorkspaceId = baseConfig.workspaceId;\n    if (!parentWorkspaceId) {\n      throw new Error(\"Expected baseConfig.workspaceId to be set\");\n    }\n    expect(taskCreated.workspaceId).toBe(parentWorkspaceId);\n    expect(taskCreated.toolCallId).toBe(mockToolCallOptions.toolCallId);\n    expect(taskCreated.taskId).toBe(\"child-task\");\n    expect(typeof taskCreated.timestamp).toBe(\"number\");\n    expect(result).toEqual({\n      status: \"completed\",\n      taskId: \"child-task\",\n      reportMarkdown: \"Hello from child\",\n      title: \"Result\",\n      agentId: \"explore\",\n      agentType: \"explore\",\n    });\n  });\n\n  it(\"should return taskId (with note) if foreground wait times out\", async () => {\n    using tempDir = new TestTempDir(\"test-task-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\n\n    const create = mock(() =>\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"queued\" as const })\n    );\n    const waitForAgentReport = mock(() =>\n      Promise.reject(new Error(\"Timed out waiting for agent_report\"))\n    );\n    const getAgentTaskStatus = mock(() => \"running\" as const);\n    const taskService = {\n      create,\n      waitForAgentReport,\n      getAgentTaskStatus,\n    } as unknown as TaskService;\n\n    const tool = createTaskTool({\n      ...baseConfig,\n      taskService,\n    });\n\n    const result: unknown = await Promise.resolve(\n      tool.execute!(\n        {\n          subagent_type: \"explore\",\n          prompt: \"do it\",\n          title: \"Child task\",\n          run_in_background: false,\n        },\n        mockToolCallOptions\n      )\n    );\n\n    expect(create).toHaveBeenCalled();\n    expect(waitForAgentReport).toHaveBeenCalledWith(\"child-task\", expect.any(Object));\n    expect(getAgentTaskStatus).toHaveBeenCalledWith(\"child-task\");\n    expectQueuedOrRunningTaskToolResult(result, { status: \"running\", taskId: \"child-task\" });\n  });\n\n  it(\"should throw when TaskService.create fails (e.g., depth limit)\", async () => {\n    using tempDir = new TestTempDir(\"test-task-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\n\n    const create = mock(() => Err(\"maxTaskNestingDepth exceeded\"));\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ignored\" }));\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\n\n    const tool = createTaskTool({\n      ...baseConfig,\n      taskService,\n    });\n\n    let caught: unknown = null;\n    try {\n      await Promise.resolve(\n        tool.execute!(\n          { subagent_type: \"explore\", prompt: \"do it\", title: \"Child task\" },\n          mockToolCallOptions\n        )\n      );\n    } catch (error: unknown) {\n      caught = error;\n    }\n\n    expect(caught).toBeInstanceOf(Error);\n    if (caught instanceof Error) {\n      expect(caught.message).toMatch(/maxTaskNestingDepth/i);\n    }\n  });\n\n  it('should reject spawning \"exec\" tasks while in plan agent', async () => {\n    using tempDir = new TestTempDir(\"test-task-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\n\n    const create = mock(() =>\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"running\" as const })\n    );\n    const waitForAgentReport = mock(() =>\n      Promise.resolve({\n        reportMarkdown: \"Hello from child\",\n        title: \"Result\",\n      })\n    );\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\n\n    const tool = createTaskTool({\n      ...baseConfig,\n      planFileOnly: true,\n      taskService,\n    });\n\n    let caught: unknown = null;\n    try {\n      await Promise.resolve(\n        tool.execute!(\n          { subagent_type: \"exec\", prompt: \"do it\", title: \"Child task\" },\n          mockToolCallOptions\n        )\n      );\n    } catch (error: unknown) {\n      caught = error;\n    }\n\n    expect(caught).toBeInstanceOf(Error);\n    if (caught instanceof Error) {\n      expect(caught.message).toMatch(/plan agent/i);\n    }\n    expect(create).not.toHaveBeenCalled();\n    expect(waitForAgentReport).not.toHaveBeenCalled();\n  });\n});\n"]}