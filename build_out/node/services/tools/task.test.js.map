{"version":3,"file":"task.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, mock } from \"bun:test\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\nimport type { TaskCreatedEvent } from \"@/common/types/stream\";\r\n\r\nimport { createTaskTool } from \"./task\";\r\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport type { TaskService } from \"@/node/services/taskService\";\r\n\r\n// Mock ToolCallOptions for testing\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\nfunction expectQueuedOrRunningTaskToolResult(\r\n  result: unknown,\r\n  expected: { status: \"queued\" | \"running\"; taskId: string }\r\n): void {\r\n  expect(result).toBeTruthy();\r\n  expect(typeof result).toBe(\"object\");\r\n  expect(result).not.toBeNull();\r\n\r\n  const obj = result as Record<string, unknown>;\r\n  expect(obj.status).toBe(expected.status);\r\n  expect(obj.taskId).toBe(expected.taskId);\r\n\r\n  const note = obj.note;\r\n  expect(typeof note).toBe(\"string\");\r\n  if (typeof note === \"string\") {\r\n    expect(note).toContain(\"task_await\");\r\n  }\r\n}\r\n\r\ndescribe(\"task tool\", () => {\r\n  it(\"should return immediately when run_in_background is true\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const create = mock(() =>\r\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"queued\" as const })\r\n    );\r\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ignored\" }));\r\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\r\n\r\n    const tool = createTaskTool({\r\n      ...baseConfig,\r\n      muxEnv: { MUX_MODEL_STRING: \"openai:gpt-4o-mini\", MUX_THINKING_LEVEL: \"high\" },\r\n      taskService,\r\n    });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!(\r\n        { subagent_type: \"explore\", prompt: \"do it\", title: \"Child task\", run_in_background: true },\r\n        mockToolCallOptions\r\n      )\r\n    );\r\n\r\n    expect(create).toHaveBeenCalled();\r\n    expect(waitForAgentReport).not.toHaveBeenCalled();\r\n    expectQueuedOrRunningTaskToolResult(result, { status: \"queued\", taskId: \"child-task\" });\r\n  });\r\n\r\n  it(\"should allow sub-agent workspaces to spawn nested tasks\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"child-workspace\" });\r\n\r\n    const create = mock(() =>\r\n      Ok({ taskId: \"grandchild-task\", kind: \"agent\" as const, status: \"queued\" as const })\r\n    );\r\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ignored\" }));\r\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\r\n\r\n    const tool = createTaskTool({\r\n      ...baseConfig,\r\n      enableAgentReport: true,\r\n      taskService,\r\n    });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!(\r\n        {\r\n          subagent_type: \"explore\",\r\n          prompt: \"do it\",\r\n          title: \"Grandchild task\",\r\n          run_in_background: true,\r\n        },\r\n        mockToolCallOptions\r\n      )\r\n    );\r\n\r\n    expect(create).toHaveBeenCalledWith(\r\n      expect.objectContaining({\r\n        parentWorkspaceId: \"child-workspace\",\r\n        kind: \"agent\",\r\n        agentId: \"explore\",\r\n        agentType: \"explore\",\r\n      })\r\n    );\r\n    expectQueuedOrRunningTaskToolResult(result, { status: \"queued\", taskId: \"grandchild-task\" });\r\n  });\r\n\r\n  it(\"should block and return report when run_in_background is false\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const events: TaskCreatedEvent[] = [];\r\n    let didEmitTaskCreated = false;\r\n\r\n    const create = mock(() =>\r\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"running\" as const })\r\n    );\r\n    const waitForAgentReport = mock(() => {\r\n      // The main thing we care about: emit the UI-only taskId before we block waiting for the report.\r\n      expect(didEmitTaskCreated).toBe(true);\r\n      return Promise.resolve({\r\n        reportMarkdown: \"Hello from child\",\r\n        title: \"Result\",\r\n      });\r\n    });\r\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\r\n\r\n    const tool = createTaskTool({\r\n      ...baseConfig,\r\n      emitChatEvent: (event) => {\r\n        if (event.type === \"task-created\") {\r\n          didEmitTaskCreated = true;\r\n          events.push(event);\r\n        }\r\n      },\r\n      taskService,\r\n    });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!(\r\n        {\r\n          subagent_type: \"explore\",\r\n          prompt: \"do it\",\r\n          title: \"Child task\",\r\n          run_in_background: false,\r\n        },\r\n        mockToolCallOptions\r\n      )\r\n    );\r\n\r\n    expect(create).toHaveBeenCalled();\r\n    expect(waitForAgentReport).toHaveBeenCalledWith(\"child-task\", expect.any(Object));\r\n\r\n    expect(events).toHaveLength(1);\r\n    const taskCreated = events[0];\r\n    if (!taskCreated) {\r\n      throw new Error(\"Expected a task-created event\");\r\n    }\r\n\r\n    expect(taskCreated.type).toBe(\"task-created\");\r\n\r\n    const parentWorkspaceId = baseConfig.workspaceId;\r\n    if (!parentWorkspaceId) {\r\n      throw new Error(\"Expected baseConfig.workspaceId to be set\");\r\n    }\r\n    expect(taskCreated.workspaceId).toBe(parentWorkspaceId);\r\n    expect(taskCreated.toolCallId).toBe(mockToolCallOptions.toolCallId);\r\n    expect(taskCreated.taskId).toBe(\"child-task\");\r\n    expect(typeof taskCreated.timestamp).toBe(\"number\");\r\n    expect(result).toEqual({\r\n      status: \"completed\",\r\n      taskId: \"child-task\",\r\n      reportMarkdown: \"Hello from child\",\r\n      title: \"Result\",\r\n      agentId: \"explore\",\r\n      agentType: \"explore\",\r\n    });\r\n  });\r\n\r\n  it(\"should return taskId (with note) if foreground wait times out\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const create = mock(() =>\r\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"queued\" as const })\r\n    );\r\n    const waitForAgentReport = mock(() =>\r\n      Promise.reject(new Error(\"Timed out waiting for agent_report\"))\r\n    );\r\n    const getAgentTaskStatus = mock(() => \"running\" as const);\r\n    const taskService = {\r\n      create,\r\n      waitForAgentReport,\r\n      getAgentTaskStatus,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskTool({\r\n      ...baseConfig,\r\n      taskService,\r\n    });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!(\r\n        {\r\n          subagent_type: \"explore\",\r\n          prompt: \"do it\",\r\n          title: \"Child task\",\r\n          run_in_background: false,\r\n        },\r\n        mockToolCallOptions\r\n      )\r\n    );\r\n\r\n    expect(create).toHaveBeenCalled();\r\n    expect(waitForAgentReport).toHaveBeenCalledWith(\"child-task\", expect.any(Object));\r\n    expect(getAgentTaskStatus).toHaveBeenCalledWith(\"child-task\");\r\n    expectQueuedOrRunningTaskToolResult(result, { status: \"running\", taskId: \"child-task\" });\r\n  });\r\n\r\n  it(\"should throw when TaskService.create fails (e.g., depth limit)\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const create = mock(() => Err(\"maxTaskNestingDepth exceeded\"));\r\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ignored\" }));\r\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\r\n\r\n    const tool = createTaskTool({\r\n      ...baseConfig,\r\n      taskService,\r\n    });\r\n\r\n    let caught: unknown = null;\r\n    try {\r\n      await Promise.resolve(\r\n        tool.execute!(\r\n          { subagent_type: \"explore\", prompt: \"do it\", title: \"Child task\" },\r\n          mockToolCallOptions\r\n        )\r\n      );\r\n    } catch (error: unknown) {\r\n      caught = error;\r\n    }\r\n\r\n    expect(caught).toBeInstanceOf(Error);\r\n    if (caught instanceof Error) {\r\n      expect(caught.message).toMatch(/maxTaskNestingDepth/i);\r\n    }\r\n  });\r\n\r\n  it('should reject spawning \"exec\" tasks while in plan agent', async () => {\r\n    using tempDir = new TestTempDir(\"test-task-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const create = mock(() =>\r\n      Ok({ taskId: \"child-task\", kind: \"agent\" as const, status: \"running\" as const })\r\n    );\r\n    const waitForAgentReport = mock(() =>\r\n      Promise.resolve({\r\n        reportMarkdown: \"Hello from child\",\r\n        title: \"Result\",\r\n      })\r\n    );\r\n    const taskService = { create, waitForAgentReport } as unknown as TaskService;\r\n\r\n    const tool = createTaskTool({\r\n      ...baseConfig,\r\n      planFileOnly: true,\r\n      taskService,\r\n    });\r\n\r\n    let caught: unknown = null;\r\n    try {\r\n      await Promise.resolve(\r\n        tool.execute!(\r\n          { subagent_type: \"exec\", prompt: \"do it\", title: \"Child task\" },\r\n          mockToolCallOptions\r\n        )\r\n      );\r\n    } catch (error: unknown) {\r\n      caught = error;\r\n    }\r\n\r\n    expect(caught).toBeInstanceOf(Error);\r\n    if (caught instanceof Error) {\r\n      expect(caught.message).toMatch(/plan agent/i);\r\n    }\r\n    expect(create).not.toHaveBeenCalled();\r\n    expect(waitForAgentReport).not.toHaveBeenCalled();\r\n  });\r\n});\r\n"]}