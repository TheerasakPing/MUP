{"version":3,"file":"agent_skill_read_file.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/agent_skill_read_file.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\n\nimport { describe, it, expect } from \"bun:test\";\nimport type { ToolExecutionOptions } from \"ai\";\n\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\nimport { AgentSkillReadFileToolResultSchema } from \"@/common/utils/tools/toolDefinitions\";\nimport { createAgentSkillReadFileTool } from \"./agent_skill_read_file\";\nimport { createTestToolConfig, TestTempDir } from \"./testHelpers\";\n\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\nasync function writeProjectSkill(workspacePath: string, name: string): Promise<void> {\n  const skillDir = path.join(workspacePath, \".mux\", \"skills\", name);\n  await fs.mkdir(skillDir, { recursive: true });\n  await fs.writeFile(\n    path.join(skillDir, \"SKILL.md\"),\n    `---\\nname: ${name}\\ndescription: test\\n---\\nBody\\n`,\n    \"utf-8\"\n  );\n}\n\ndescribe(\"agent_skill_read_file (Chat with Mux sandbox)\", () => {\n  it(\"allows reading built-in skill files\", async () => {\n    using tempDir = new TestTempDir(\"test-agent-skill-read-file-mux-chat\");\n    const baseConfig = createTestToolConfig(tempDir.path, {\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\n    });\n\n    const tool = createAgentSkillReadFileTool(baseConfig);\n\n    const raw: unknown = await Promise.resolve(\n      tool.execute!(\n        { name: \"mux-docs\", filePath: \"SKILL.md\", offset: 1, limit: 25 },\n        mockToolCallOptions\n      )\n    );\n\n    const parsed = AgentSkillReadFileToolResultSchema.safeParse(raw);\n    expect(parsed.success).toBe(true);\n    if (!parsed.success) {\n      throw new Error(parsed.error.message);\n    }\n\n    const result = parsed.data;\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.content).toMatch(/name:\\s*mux-docs/i);\n    }\n  });\n\n  it(\"rejects project/global skill file reads on disk\", async () => {\n    using tempDir = new TestTempDir(\"test-agent-skill-read-file-mux-chat-reject\");\n    await writeProjectSkill(tempDir.path, \"foo\");\n\n    const baseConfig = createTestToolConfig(tempDir.path, {\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\n    });\n    const tool = createAgentSkillReadFileTool(baseConfig);\n\n    const raw: unknown = await Promise.resolve(\n      tool.execute!({ name: \"foo\", filePath: \"SKILL.md\", offset: 1, limit: 5 }, mockToolCallOptions)\n    );\n\n    const parsed = AgentSkillReadFileToolResultSchema.safeParse(raw);\n    expect(parsed.success).toBe(true);\n    if (!parsed.success) {\n      throw new Error(parsed.error.message);\n    }\n\n    const result = parsed.data;\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toMatch(/only built-in skills/i);\n    }\n  });\n});\n"]}