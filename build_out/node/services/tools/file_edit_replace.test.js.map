{"version":3,"file":"file_edit_replace.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_replace.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport * as os from \"os\";\nimport { createFileEditReplaceStringTool } from \"./file_edit_replace_string\";\nimport { createFileEditReplaceLinesTool } from \"./file_edit_replace_lines\";\nimport type {\n  FileEditReplaceStringToolArgs,\n  FileEditReplaceStringToolResult,\n  FileEditReplaceLinesToolArgs,\n  FileEditReplaceLinesToolResult,\n} from \"@/common/types/tools\";\nimport type { ToolExecutionOptions } from \"ai\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\nimport { getTestDeps } from \"./testHelpers\";\n\n// Mock ToolCallOptions for testing\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\n// Test helpers\nconst setupFile = async (filePath: string, content: string): Promise<void> => {\n  await fs.writeFile(filePath, content);\n};\n\nconst readFile = async (filePath: string): Promise<string> => {\n  return await fs.readFile(filePath, \"utf-8\");\n};\n\nconst executeStringReplace = async (\n  tool: ReturnType<typeof createFileEditReplaceStringTool>,\n  args: FileEditReplaceStringToolArgs\n): Promise<FileEditReplaceStringToolResult> => {\n  return (await tool.execute!(args, mockToolCallOptions)) as FileEditReplaceStringToolResult;\n};\n\nconst executeLinesReplace = async (\n  tool: ReturnType<typeof createFileEditReplaceLinesTool>,\n  args: FileEditReplaceLinesToolArgs\n): Promise<FileEditReplaceLinesToolResult> => {\n  return (await tool.execute!(args, mockToolCallOptions)) as FileEditReplaceLinesToolResult;\n};\n\ndescribe(\"file_edit_replace_string tool\", () => {\n  let testDir: string;\n  let testFilePath: string;\n\n  beforeEach(async () => {\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"fileEditReplace-test-\"));\n    testFilePath = path.join(testDir, \"test.txt\");\n  });\n\n  afterEach(async () => {\n    await fs.rm(testDir, { recursive: true, force: true });\n  });\n\n  it(\"should apply a single edit successfully\", async () => {\n    await setupFile(testFilePath, \"Hello world\\nThis is a test\\nGoodbye world\");\n    const tool = createFileEditReplaceStringTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\n      runtimeTempDir: \"/tmp\",\n    });\n\n    const payload: FileEditReplaceStringToolArgs = {\n      file_path: \"test.txt\", // Use relative path\n      old_string: \"Hello world\",\n      new_string: \"Hello universe\",\n    };\n\n    const result = await executeStringReplace(tool, payload);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.edits_applied).toBe(1);\n    }\n\n    expect(await readFile(testFilePath)).toBe(\"Hello universe\\nThis is a test\\nGoodbye world\");\n  });\n\n  it(\"matches LF args against a CRLF file and preserves CRLF\", async () => {\n    await setupFile(testFilePath, \"Hello world\\r\\nThis is a test\\r\\nGoodbye world\\r\\n\");\n    const tool = createFileEditReplaceStringTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\n      runtimeTempDir: \"/tmp\",\n    });\n\n    const payload: FileEditReplaceStringToolArgs = {\n      file_path: \"test.txt\",\n      old_string: \"Hello world\\nThis is a test\\n\",\n      new_string: \"Hello universe\\nThis is a CRLF test\\n\",\n    };\n\n    const result = await executeStringReplace(tool, payload);\n\n    expect(result.success).toBe(true);\n    expect(await readFile(testFilePath)).toBe(\n      \"Hello universe\\r\\nThis is a CRLF test\\r\\nGoodbye world\\r\\n\"\n    );\n  });\n\n  it(\"does not modify the file when old_string is missing\", async () => {\n    const original = \"Hello world\\n\";\n    await setupFile(testFilePath, original);\n    const tool = createFileEditReplaceStringTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\n      runtimeTempDir: \"/tmp\",\n    });\n\n    const payload: FileEditReplaceStringToolArgs = {\n      file_path: \"test.txt\",\n      old_string: \"Goodbye world\\n\",\n      new_string: \"replaced\\n\",\n    };\n\n    const result = await executeStringReplace(tool, payload);\n\n    expect(result.success).toBe(false);\n    expect(await readFile(testFilePath)).toBe(original);\n  });\n\n  it(\"does not modify the file when old_string is ambiguous\", async () => {\n    const original = \"repeat\\nrepeat\\n\";\n    await setupFile(testFilePath, original);\n    const tool = createFileEditReplaceStringTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\n      runtimeTempDir: \"/tmp\",\n    });\n\n    const payload: FileEditReplaceStringToolArgs = {\n      file_path: \"test.txt\",\n      old_string: \"repeat\",\n      new_string: \"REPLACED\",\n    };\n\n    const result = await executeStringReplace(tool, payload);\n\n    expect(result.success).toBe(false);\n    expect(await readFile(testFilePath)).toBe(original);\n  });\n});\n\ndescribe(\"file_edit_replace_lines tool\", () => {\n  let testDir: string;\n  let testFilePath: string;\n\n  beforeEach(async () => {\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"fileEditReplace-test-\"));\n    testFilePath = path.join(testDir, \"test.txt\");\n  });\n\n  afterEach(async () => {\n    await fs.rm(testDir, { recursive: true, force: true });\n  });\n\n  it(\"should replace a line range successfully\", async () => {\n    await setupFile(testFilePath, \"line1\\nline2\\nline3\\nline4\");\n    const tool = createFileEditReplaceLinesTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\n      runtimeTempDir: \"/tmp\",\n    });\n\n    const payload: FileEditReplaceLinesToolArgs = {\n      file_path: \"test.txt\", // Use relative path\n      start_line: 2,\n      end_line: 3,\n      new_lines: [\"LINE2\", \"LINE3\"],\n    };\n\n    const result = await executeLinesReplace(tool, payload);\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.lines_replaced).toBe(2);\n      expect(result.line_delta).toBe(0);\n    }\n\n    expect(await readFile(testFilePath)).toBe(\"line1\\nLINE2\\nLINE3\\nline4\");\n  });\n\n  it(\"preserves CRLF when replacing lines in a CRLF file\", async () => {\n    await setupFile(testFilePath, \"line1\\r\\nline2\\r\\nline3\\r\\nline4\");\n    const tool = createFileEditReplaceLinesTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\n      runtimeTempDir: \"/tmp\",\n    });\n\n    const payload: FileEditReplaceLinesToolArgs = {\n      file_path: \"test.txt\",\n      start_line: 2,\n      end_line: 3,\n      new_lines: [\"LINE2\", \"LINE3\"],\n    };\n\n    const result = await executeLinesReplace(tool, payload);\n\n    expect(result.success).toBe(true);\n    expect(await readFile(testFilePath)).toBe(\"line1\\r\\nLINE2\\r\\nLINE3\\r\\nline4\");\n  });\n});\n"]}