{"version":3,"file":"file_edit_replace.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_replace.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { createFileEditReplaceStringTool } from \"./file_edit_replace_string\";\r\nimport { createFileEditReplaceLinesTool } from \"./file_edit_replace_lines\";\r\nimport type {\r\n  FileEditReplaceStringToolArgs,\r\n  FileEditReplaceStringToolResult,\r\n  FileEditReplaceLinesToolArgs,\r\n  FileEditReplaceLinesToolResult,\r\n} from \"@/common/types/tools\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport { getTestDeps } from \"./testHelpers\";\r\n\r\n// Mock ToolCallOptions for testing\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\n// Test helpers\r\nconst setupFile = async (filePath: string, content: string): Promise<void> => {\r\n  await fs.writeFile(filePath, content);\r\n};\r\n\r\nconst readFile = async (filePath: string): Promise<string> => {\r\n  return await fs.readFile(filePath, \"utf-8\");\r\n};\r\n\r\nconst executeStringReplace = async (\r\n  tool: ReturnType<typeof createFileEditReplaceStringTool>,\r\n  args: FileEditReplaceStringToolArgs\r\n): Promise<FileEditReplaceStringToolResult> => {\r\n  return (await tool.execute!(args, mockToolCallOptions)) as FileEditReplaceStringToolResult;\r\n};\r\n\r\nconst executeLinesReplace = async (\r\n  tool: ReturnType<typeof createFileEditReplaceLinesTool>,\r\n  args: FileEditReplaceLinesToolArgs\r\n): Promise<FileEditReplaceLinesToolResult> => {\r\n  return (await tool.execute!(args, mockToolCallOptions)) as FileEditReplaceLinesToolResult;\r\n};\r\n\r\ndescribe(\"file_edit_replace_string tool\", () => {\r\n  let testDir: string;\r\n  let testFilePath: string;\r\n\r\n  beforeEach(async () => {\r\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"fileEditReplace-test-\"));\r\n    testFilePath = path.join(testDir, \"test.txt\");\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(testDir, { recursive: true, force: true });\r\n  });\r\n\r\n  it(\"should apply a single edit successfully\", async () => {\r\n    await setupFile(testFilePath, \"Hello world\\nThis is a test\\nGoodbye world\");\r\n    const tool = createFileEditReplaceStringTool({\r\n      ...getTestDeps(),\r\n      cwd: testDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n    });\r\n\r\n    const payload: FileEditReplaceStringToolArgs = {\r\n      file_path: \"test.txt\", // Use relative path\r\n      old_string: \"Hello world\",\r\n      new_string: \"Hello universe\",\r\n    };\r\n\r\n    const result = await executeStringReplace(tool, payload);\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.edits_applied).toBe(1);\r\n    }\r\n\r\n    expect(await readFile(testFilePath)).toBe(\"Hello universe\\nThis is a test\\nGoodbye world\");\r\n  });\r\n\r\n  it(\"matches LF args against a CRLF file and preserves CRLF\", async () => {\r\n    await setupFile(testFilePath, \"Hello world\\r\\nThis is a test\\r\\nGoodbye world\\r\\n\");\r\n    const tool = createFileEditReplaceStringTool({\r\n      ...getTestDeps(),\r\n      cwd: testDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n    });\r\n\r\n    const payload: FileEditReplaceStringToolArgs = {\r\n      file_path: \"test.txt\",\r\n      old_string: \"Hello world\\nThis is a test\\n\",\r\n      new_string: \"Hello universe\\nThis is a CRLF test\\n\",\r\n    };\r\n\r\n    const result = await executeStringReplace(tool, payload);\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(await readFile(testFilePath)).toBe(\r\n      \"Hello universe\\r\\nThis is a CRLF test\\r\\nGoodbye world\\r\\n\"\r\n    );\r\n  });\r\n\r\n  it(\"does not modify the file when old_string is missing\", async () => {\r\n    const original = \"Hello world\\n\";\r\n    await setupFile(testFilePath, original);\r\n    const tool = createFileEditReplaceStringTool({\r\n      ...getTestDeps(),\r\n      cwd: testDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n    });\r\n\r\n    const payload: FileEditReplaceStringToolArgs = {\r\n      file_path: \"test.txt\",\r\n      old_string: \"Goodbye world\\n\",\r\n      new_string: \"replaced\\n\",\r\n    };\r\n\r\n    const result = await executeStringReplace(tool, payload);\r\n\r\n    expect(result.success).toBe(false);\r\n    expect(await readFile(testFilePath)).toBe(original);\r\n  });\r\n\r\n  it(\"does not modify the file when old_string is ambiguous\", async () => {\r\n    const original = \"repeat\\nrepeat\\n\";\r\n    await setupFile(testFilePath, original);\r\n    const tool = createFileEditReplaceStringTool({\r\n      ...getTestDeps(),\r\n      cwd: testDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n    });\r\n\r\n    const payload: FileEditReplaceStringToolArgs = {\r\n      file_path: \"test.txt\",\r\n      old_string: \"repeat\",\r\n      new_string: \"REPLACED\",\r\n    };\r\n\r\n    const result = await executeStringReplace(tool, payload);\r\n\r\n    expect(result.success).toBe(false);\r\n    expect(await readFile(testFilePath)).toBe(original);\r\n  });\r\n});\r\n\r\ndescribe(\"file_edit_replace_lines tool\", () => {\r\n  let testDir: string;\r\n  let testFilePath: string;\r\n\r\n  beforeEach(async () => {\r\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"fileEditReplace-test-\"));\r\n    testFilePath = path.join(testDir, \"test.txt\");\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(testDir, { recursive: true, force: true });\r\n  });\r\n\r\n  it(\"should replace a line range successfully\", async () => {\r\n    await setupFile(testFilePath, \"line1\\nline2\\nline3\\nline4\");\r\n    const tool = createFileEditReplaceLinesTool({\r\n      ...getTestDeps(),\r\n      cwd: testDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n    });\r\n\r\n    const payload: FileEditReplaceLinesToolArgs = {\r\n      file_path: \"test.txt\", // Use relative path\r\n      start_line: 2,\r\n      end_line: 3,\r\n      new_lines: [\"LINE2\", \"LINE3\"],\r\n    };\r\n\r\n    const result = await executeLinesReplace(tool, payload);\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.lines_replaced).toBe(2);\r\n      expect(result.line_delta).toBe(0);\r\n    }\r\n\r\n    expect(await readFile(testFilePath)).toBe(\"line1\\nLINE2\\nLINE3\\nline4\");\r\n  });\r\n\r\n  it(\"preserves CRLF when replacing lines in a CRLF file\", async () => {\r\n    await setupFile(testFilePath, \"line1\\r\\nline2\\r\\nline3\\r\\nline4\");\r\n    const tool = createFileEditReplaceLinesTool({\r\n      ...getTestDeps(),\r\n      cwd: testDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n    });\r\n\r\n    const payload: FileEditReplaceLinesToolArgs = {\r\n      file_path: \"test.txt\",\r\n      start_line: 2,\r\n      end_line: 3,\r\n      new_lines: [\"LINE2\", \"LINE3\"],\r\n    };\r\n\r\n    const result = await executeLinesReplace(tool, payload);\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(await readFile(testFilePath)).toBe(\"line1\\r\\nLINE2\\r\\nLINE3\\r\\nline4\");\r\n  });\r\n});\r\n"]}