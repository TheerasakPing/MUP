{"version":3,"file":"mux_global_agents.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/mux_global_agents.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\n\r\nimport {\r\n  MUX_HELP_CHAT_WORKSPACE_ID,\r\n  MUX_HELP_CHAT_WORKSPACE_NAME,\r\n  MUX_HELP_CHAT_WORKSPACE_TITLE,\r\n} from \"@/common/constants/muxChat\";\r\nimport { FILE_EDIT_DIFF_OMITTED_MESSAGE } from \"@/common/types/tools\";\r\n\r\nimport { createMuxGlobalAgentsReadTool } from \"./mux_global_agents_read\";\r\nimport { createMuxGlobalAgentsWriteTool } from \"./mux_global_agents_write\";\r\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\ndescribe(\"mux_global_agents_* tools\", () => {\r\n  it(\"reads ~/.mux/AGENTS.md (returns empty string if missing)\", async () => {\r\n    using muxHome = new TestTempDir(\"mux-global-agents\");\r\n\r\n    const workspaceSessionDir = path.join(muxHome.path, \"sessions\", MUX_HELP_CHAT_WORKSPACE_ID);\r\n    await fs.mkdir(workspaceSessionDir, { recursive: true });\r\n\r\n    const config = createTestToolConfig(muxHome.path, {\r\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\r\n      sessionsDir: workspaceSessionDir,\r\n    });\r\n\r\n    const tool = createMuxGlobalAgentsReadTool(config);\r\n\r\n    // Missing file -> empty\r\n    const missing = (await tool.execute!({}, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      content?: string;\r\n    };\r\n    expect(missing.success).toBe(true);\r\n    if (missing.success) {\r\n      expect(missing.content).toBe(\"\");\r\n    }\r\n\r\n    // Present file -> contents\r\n    const agentsPath = path.join(muxHome.path, \"AGENTS.md\");\r\n    await fs.writeFile(\r\n      agentsPath,\r\n      `# ${MUX_HELP_CHAT_WORKSPACE_TITLE}\\n${MUX_HELP_CHAT_WORKSPACE_NAME}\\n`,\r\n      \"utf-8\"\r\n    );\r\n\r\n    const result = (await tool.execute!({}, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      content?: string;\r\n    };\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.content).toContain(MUX_HELP_CHAT_WORKSPACE_TITLE);\r\n      expect(result.content).toContain(MUX_HELP_CHAT_WORKSPACE_NAME);\r\n    }\r\n  });\r\n\r\n  it(\"refuses to write without explicit confirmation\", async () => {\r\n    using muxHome = new TestTempDir(\"mux-global-agents\");\r\n\r\n    const workspaceSessionDir = path.join(muxHome.path, \"sessions\", MUX_HELP_CHAT_WORKSPACE_ID);\r\n    await fs.mkdir(workspaceSessionDir, { recursive: true });\r\n\r\n    const config = createTestToolConfig(muxHome.path, {\r\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\r\n      sessionsDir: workspaceSessionDir,\r\n    });\r\n\r\n    const tool = createMuxGlobalAgentsWriteTool(config);\r\n\r\n    const agentsPath = path.join(muxHome.path, \"AGENTS.md\");\r\n\r\n    const result = (await tool.execute!(\r\n      { newContent: \"test\", confirm: false },\r\n      mockToolCallOptions\r\n    )) as { success: boolean; error?: string };\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"confirm\");\r\n    }\r\n\r\n    let readError: unknown;\r\n    try {\r\n      await fs.readFile(agentsPath, \"utf-8\");\r\n    } catch (error) {\r\n      readError = error;\r\n    }\r\n\r\n    expect(readError).toMatchObject({ code: \"ENOENT\" });\r\n  });\r\n\r\n  it(\"writes ~/.mux/AGENTS.md and returns a diff\", async () => {\r\n    using muxHome = new TestTempDir(\"mux-global-agents\");\r\n\r\n    const workspaceSessionDir = path.join(muxHome.path, \"sessions\", MUX_HELP_CHAT_WORKSPACE_ID);\r\n    await fs.mkdir(workspaceSessionDir, { recursive: true });\r\n\r\n    const config = createTestToolConfig(muxHome.path, {\r\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\r\n      sessionsDir: workspaceSessionDir,\r\n    });\r\n\r\n    const tool = createMuxGlobalAgentsWriteTool(config);\r\n\r\n    const newContent = \"# Global agents\\n\\nHello\\n\";\r\n\r\n    const result = (await tool.execute!({ newContent, confirm: true }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      diff?: string;\r\n      ui_only?: { file_edit?: { diff?: string } };\r\n    };\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.diff).toBe(FILE_EDIT_DIFF_OMITTED_MESSAGE);\r\n      expect(result.ui_only?.file_edit?.diff).toContain(\"AGENTS.md\");\r\n    }\r\n\r\n    const written = await fs.readFile(path.join(muxHome.path, \"AGENTS.md\"), \"utf-8\");\r\n    expect(written).toBe(newContent);\r\n  });\r\n\r\n  it(\"rejects symlink targets\", async () => {\r\n    using muxHome = new TestTempDir(\"mux-global-agents\");\r\n\r\n    const workspaceSessionDir = path.join(muxHome.path, \"sessions\", MUX_HELP_CHAT_WORKSPACE_ID);\r\n    await fs.mkdir(workspaceSessionDir, { recursive: true });\r\n\r\n    const config = createTestToolConfig(muxHome.path, {\r\n      workspaceId: MUX_HELP_CHAT_WORKSPACE_ID,\r\n      sessionsDir: workspaceSessionDir,\r\n    });\r\n\r\n    const readTool = createMuxGlobalAgentsReadTool(config);\r\n    const writeTool = createMuxGlobalAgentsWriteTool(config);\r\n\r\n    const agentsPath = path.join(muxHome.path, \"AGENTS.md\");\r\n    const targetPath = path.join(muxHome.path, \"target.txt\");\r\n    await fs.writeFile(targetPath, \"secret\", \"utf-8\");\r\n    await fs.symlink(targetPath, agentsPath);\r\n\r\n    const readResult = (await readTool.execute!({}, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n    };\r\n    expect(readResult.success).toBe(false);\r\n    if (!readResult.success) {\r\n      expect(readResult.error).toContain(\"symlink\");\r\n    }\r\n\r\n    const writeResult = (await writeTool.execute!(\r\n      { newContent: \"nope\", confirm: true },\r\n      mockToolCallOptions\r\n    )) as { success: boolean; error?: string };\r\n    expect(writeResult.success).toBe(false);\r\n    if (!writeResult.success) {\r\n      expect(writeResult.error).toContain(\"symlink\");\r\n    }\r\n  });\r\n});\r\n"]}