{"version":3,"file":"notify.js","sourceRoot":"","sources":["../../../../src/node/services/tools/notify.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;GAUG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,2BAA0B;AAE1B,0EAAwE;AAGxE,kEAAkE;AAClE,MAAM,4BAA4B,GAAG,GAAG,CAAC;AAEzC,wCAAwC;AACxC,MAAM,6BAA6B,GAAG,EAAE,CAAC;AAEzC;;GAEG;AACH,SAAS,YAAY,CAAC,IAAY,EAAE,SAAiB,EAAU;IAC7D,IAAI,IAAI,CAAC,MAAM,IAAI,SAAS,EAAE,CAAC;QAC7B,OAAO,IAAI,CAAC;IACd,CAAC;IACD,OAAO,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,SAAS,GAAG,CAAC,CAAC,GAAG,KAAG,CAAC;AAAA,CAC3C;AAED;;GAEG;AACH,SAAS,qBAAqB,GAAY;IACxC,OAAO,OAAO,OAAO,CAAC,QAAQ,CAAC,QAAQ,KAAK,QAAQ,CAAC;AAAA,CACtD;AAED;;;;GAIG;AACH,KAAK,UAAU,wBAAwB,CACrC,KAAa,EACb,IAAa,EACb,WAAoB,EAC2B;IAC/C,IAAI,CAAC,qBAAqB,EAAE,EAAE,CAAC;QAC7B,OAAO;YACL,OAAO,EAAE,KAAK;YACd,KAAK,EAAE,8DAA8D;SACtE,CAAC;IACJ,CAAC;IAED,IAAI,CAAC;QACH,mHAAmH;QACnH,MAAM,EAAE,YAAY,EAAE,aAAa,EAAE,GAAG,wDAAa,UAAU,GAAC,CAAC;QAEjE,IAAI,CAAC,YAAY,CAAC,WAAW,EAAE,EAAE,CAAC;YAChC,OAAO;gBACL,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,qDAAqD;aAC7D,CAAC;QACJ,CAAC;QAED,MAAM,YAAY,GAAG,IAAI,YAAY,CAAC;YACpC,KAAK,EAAE,YAAY,CAAC,KAAK,EAAE,6BAA6B,CAAC;YACzD,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,IAAI,EAAE,4BAA4B,CAAC,CAAC,CAAC,CAAC,SAAS;YACzE,MAAM,EAAE,KAAK;SACd,CAAC,CAAC;QAEH,kEAAkE;QAClE,YAAY,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC;YAC7B,MAAM,OAAO,GAAG,aAAa,CAAC,aAAa,EAAE,CAAC;YAC9C,MAAM,UAAU,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;YAC9B,IAAI,UAAU,EAAE,CAAC;gBACf,mCAAmC;gBACnC,IAAI,UAAU,CAAC,WAAW,EAAE,EAAE,CAAC;oBAC7B,UAAU,CAAC,OAAO,EAAE,CAAC;gBACvB,CAAC;gBACD,UAAU,CAAC,KAAK,EAAE,CAAC;gBAEnB,wDAAwD;gBACxD,IAAI,WAAW,EAAE,CAAC;oBAChB,UAAU,CAAC,WAAW,CAAC,IAAI,CAAC,0BAA0B,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC;gBAC3E,CAAC;YACH,CAAC;QAAA,CACF,CAAC,CAAC;QAEH,YAAY,CAAC,IAAI,EAAE,CAAC;QAEpB,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;IAC3B,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QACvE,OAAO;YACL,OAAO,EAAE,KAAK;YACd,KAAK,EAAE,gCAAgC,OAAO,EAAE;SACjD,CAAC;IACJ,CAAC;AAAA,CACF;AAED;;;GAGG;AACI,MAAM,gBAAgB,GAAgB,CAAC,MAAM,EAAE,EAAE,CAAC;IACvD,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,MAAM,CAAC,WAAW;QAChD,WAAW,EAAE,kCAAgB,CAAC,MAAM,CAAC,MAAM;QAC3C,OAAO,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,EAA6B,EAAE,CAAC;YAChE,iBAAiB;YACjB,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC,IAAI,EAAE,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBACxC,OAAO;oBACL,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,oDAAoD;iBAC5D,CAAC;YACJ,CAAC;YAED,MAAM,YAAY,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;YAClC,MAAM,cAAc,GAAG,OAAO,EAAE,IAAI,EAAE,CAAC;YAEvC,MAAM,cAAc,GAAG,YAAY,CAAC,YAAY,EAAE,6BAA6B,CAAC,CAAC;YACjF,MAAM,gBAAgB,GAAG,cAAc;gBACrC,CAAC,CAAC,YAAY,CAAC,cAAc,EAAE,4BAA4B,CAAC;gBAC5D,CAAC,CAAC,SAAS,CAAC;YAEd,MAAM,MAAM,GAAG,MAAM,wBAAwB,CAC3C,cAAc,EACd,gBAAgB,EAChB,MAAM,CAAC,WAAW,CACnB,CAAC;YAEF,iDAAiD;YACjD,IAAI,MAAM,CAAC,OAAO,EAAE,CAAC;gBACnB,OAAO;oBACL,OAAO,EAAE,IAAI;oBACb,KAAK,EAAE,cAAc;oBACrB,OAAO,EAAE,gBAAgB;oBACzB,OAAO,EAAE;wBACP,MAAM,EAAE;4BACN,WAAW,EAAE,UAAU;4BACvB,WAAW,EAAE,MAAM,CAAC,WAAW;yBAChC;qBACF;iBACF,CAAC;YACJ,CAAC;YAED,wEAAwE;YACxE,qFAAqF;YACrF,OAAO;gBACL,OAAO,EAAE,IAAI;gBACb,KAAK,EAAE,cAAc;gBACrB,OAAO,EAAE,gBAAgB;gBACzB,OAAO,EAAE;oBACP,MAAM,EAAE;wBACN,WAAW,EAAE,SAAS;wBACtB,WAAW,EAAE,MAAM,CAAC,WAAW;qBAChC;iBACF;aACF,CAAC;QAAA,CACH;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AAzDW,QAAA,gBAAgB,GAAhB,gBAAgB,CAyD3B","sourcesContent":["/**\r\n * Notification tool - sends system notifications to the user\r\n *\r\n * This tool allows AI agents to notify users of important events using the\r\n * operating system's native notification system (macOS Notification Center,\r\n * Windows Toast notifications, Linux notification daemon).\r\n *\r\n * Uses Electron's cross-platform Notification API when available, with graceful\r\n * fallback for non-Electron environments. Clicking a notification navigates\r\n * the user to the workspace that sent it.\r\n */\r\n\r\nimport { tool } from \"ai\";\r\nimport type { ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport type { NotifyToolResult } from \"@/common/types/tools\";\r\n\r\n/** Maximum notification body length (macOS limit is 256 bytes) */\r\nconst MAX_NOTIFICATION_BODY_LENGTH = 200;\r\n\r\n/** Maximum notification title length */\r\nconst MAX_NOTIFICATION_TITLE_LENGTH = 64;\r\n\r\n/**\r\n * Truncates text to a maximum length, adding ellipsis if truncated\r\n */\r\nfunction truncateText(text: string, maxLength: number): string {\r\n  if (text.length <= maxLength) {\r\n    return text;\r\n  }\r\n  return text.slice(0, maxLength - 1) + \"â€¦\";\r\n}\r\n\r\n/**\r\n * Check if we're running in Electron environment\r\n */\r\nfunction isElectronEnvironment(): boolean {\r\n  return typeof process.versions.electron === \"string\";\r\n}\r\n\r\n/**\r\n * Send a system notification using Electron's Notification API.\r\n * When clicked, focuses the app and navigates to the specified workspace.\r\n * Returns true if notification was shown, false otherwise.\r\n */\r\nasync function sendElectronNotification(\r\n  title: string,\r\n  body?: string,\r\n  workspaceId?: string\r\n): Promise<{ success: boolean; error?: string }> {\r\n  if (!isElectronEnvironment()) {\r\n    return {\r\n      success: false,\r\n      error: \"System notifications not supported (not running in Electron)\",\r\n    };\r\n  }\r\n\r\n  try {\r\n    // eslint-disable-next-line no-restricted-syntax -- Electron is unavailable in `mux server`; avoid top-level import\r\n    const { Notification, BrowserWindow } = await import(\"electron\");\r\n\r\n    if (!Notification.isSupported()) {\r\n      return {\r\n        success: false,\r\n        error: \"System notifications not supported on this platform\",\r\n      };\r\n    }\r\n\r\n    const notification = new Notification({\r\n      title: truncateText(title, MAX_NOTIFICATION_TITLE_LENGTH),\r\n      body: body ? truncateText(body, MAX_NOTIFICATION_BODY_LENGTH) : undefined,\r\n      silent: false,\r\n    });\r\n\r\n    // Handle notification click - focus app and navigate to workspace\r\n    notification.on(\"click\", () => {\r\n      const windows = BrowserWindow.getAllWindows();\r\n      const mainWindow = windows[0];\r\n      if (mainWindow) {\r\n        // Restore if minimized, then focus\r\n        if (mainWindow.isMinimized()) {\r\n          mainWindow.restore();\r\n        }\r\n        mainWindow.focus();\r\n\r\n        // Send IPC message to renderer to navigate to workspace\r\n        if (workspaceId) {\r\n          mainWindow.webContents.send(\"mux:notification-clicked\", { workspaceId });\r\n        }\r\n      }\r\n    });\r\n\r\n    notification.show();\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    return {\r\n      success: false,\r\n      error: `Failed to send notification: ${message}`,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Notify tool factory for AI assistant\r\n * Creates a tool that sends system notifications to the user\r\n */\r\nexport const createNotifyTool: ToolFactory = (config) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.notify.description,\r\n    inputSchema: TOOL_DEFINITIONS.notify.schema,\r\n    execute: async ({ title, message }): Promise<NotifyToolResult> => {\r\n      // Validate title\r\n      if (!title || title.trim().length === 0) {\r\n        return {\r\n          success: false,\r\n          error: \"Notification title is required and cannot be empty\",\r\n        };\r\n      }\r\n\r\n      const trimmedTitle = title.trim();\r\n      const trimmedMessage = message?.trim();\r\n\r\n      const truncatedTitle = truncateText(trimmedTitle, MAX_NOTIFICATION_TITLE_LENGTH);\r\n      const truncatedMessage = trimmedMessage\r\n        ? truncateText(trimmedMessage, MAX_NOTIFICATION_BODY_LENGTH)\r\n        : undefined;\r\n\r\n      const result = await sendElectronNotification(\r\n        truncatedTitle,\r\n        truncatedMessage,\r\n        config.workspaceId\r\n      );\r\n\r\n      // If Electron notification succeeded, we're done\r\n      if (result.success) {\r\n        return {\r\n          success: true,\r\n          title: truncatedTitle,\r\n          message: truncatedMessage,\r\n          ui_only: {\r\n            notify: {\r\n              notifiedVia: \"electron\",\r\n              workspaceId: config.workspaceId,\r\n            },\r\n          },\r\n        };\r\n      }\r\n\r\n      // Electron unavailable - signal frontend to handle browser notification\r\n      // This is not an error; the notification will be delivered via Web Notifications API\r\n      return {\r\n        success: true,\r\n        title: truncatedTitle,\r\n        message: truncatedMessage,\r\n        ui_only: {\r\n          notify: {\r\n            notifiedVia: \"browser\",\r\n            workspaceId: config.workspaceId,\r\n          },\r\n        },\r\n      };\r\n    },\r\n  });\r\n};\r\n"]}