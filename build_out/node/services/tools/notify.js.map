{"version":3,"file":"notify.js","sourceRoot":"","sources":["../../../../src/node/services/tools/notify.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Notification tool - sends system notifications to the user\n *\n * This tool allows AI agents to notify users of important events using the\n * operating system's native notification system (macOS Notification Center,\n * Windows Toast notifications, Linux notification daemon).\n *\n * Uses Electron's cross-platform Notification API when available, with graceful\n * fallback for non-Electron environments. Clicking a notification navigates\n * the user to the workspace that sent it.\n */\n\nimport { tool } from \"ai\";\nimport type { ToolFactory } from \"@/common/utils/tools/tools\";\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\nimport type { NotifyToolResult } from \"@/common/types/tools\";\n\n/** Maximum notification body length (macOS limit is 256 bytes) */\nconst MAX_NOTIFICATION_BODY_LENGTH = 200;\n\n/** Maximum notification title length */\nconst MAX_NOTIFICATION_TITLE_LENGTH = 64;\n\n/**\n * Truncates text to a maximum length, adding ellipsis if truncated\n */\nfunction truncateText(text: string, maxLength: number): string {\n  if (text.length <= maxLength) {\n    return text;\n  }\n  return text.slice(0, maxLength - 1) + \"â€¦\";\n}\n\n/**\n * Check if we're running in Electron environment\n */\nfunction isElectronEnvironment(): boolean {\n  return typeof process.versions.electron === \"string\";\n}\n\n/**\n * Send a system notification using Electron's Notification API.\n * When clicked, focuses the app and navigates to the specified workspace.\n * Returns true if notification was shown, false otherwise.\n */\nasync function sendElectronNotification(\n  title: string,\n  body?: string,\n  workspaceId?: string\n): Promise<{ success: boolean; error?: string }> {\n  if (!isElectronEnvironment()) {\n    return {\n      success: false,\n      error: \"System notifications not supported (not running in Electron)\",\n    };\n  }\n\n  try {\n    // eslint-disable-next-line no-restricted-syntax -- Electron is unavailable in `mux server`; avoid top-level import\n    const { Notification, BrowserWindow } = await import(\"electron\");\n\n    if (!Notification.isSupported()) {\n      return {\n        success: false,\n        error: \"System notifications not supported on this platform\",\n      };\n    }\n\n    const notification = new Notification({\n      title: truncateText(title, MAX_NOTIFICATION_TITLE_LENGTH),\n      body: body ? truncateText(body, MAX_NOTIFICATION_BODY_LENGTH) : undefined,\n      silent: false,\n    });\n\n    // Handle notification click - focus app and navigate to workspace\n    notification.on(\"click\", () => {\n      const windows = BrowserWindow.getAllWindows();\n      const mainWindow = windows[0];\n      if (mainWindow) {\n        // Restore if minimized, then focus\n        if (mainWindow.isMinimized()) {\n          mainWindow.restore();\n        }\n        mainWindow.focus();\n\n        // Send IPC message to renderer to navigate to workspace\n        if (workspaceId) {\n          mainWindow.webContents.send(\"mux:notification-clicked\", { workspaceId });\n        }\n      }\n    });\n\n    notification.show();\n\n    return { success: true };\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    return {\n      success: false,\n      error: `Failed to send notification: ${message}`,\n    };\n  }\n}\n\n/**\n * Notify tool factory for AI assistant\n * Creates a tool that sends system notifications to the user\n */\nexport const createNotifyTool: ToolFactory = (config) => {\n  return tool({\n    description: TOOL_DEFINITIONS.notify.description,\n    inputSchema: TOOL_DEFINITIONS.notify.schema,\n    execute: async ({ title, message }): Promise<NotifyToolResult> => {\n      // Validate title\n      if (!title || title.trim().length === 0) {\n        return {\n          success: false,\n          error: \"Notification title is required and cannot be empty\",\n        };\n      }\n\n      const trimmedTitle = title.trim();\n      const trimmedMessage = message?.trim();\n\n      const truncatedTitle = truncateText(trimmedTitle, MAX_NOTIFICATION_TITLE_LENGTH);\n      const truncatedMessage = trimmedMessage\n        ? truncateText(trimmedMessage, MAX_NOTIFICATION_BODY_LENGTH)\n        : undefined;\n\n      const result = await sendElectronNotification(\n        truncatedTitle,\n        truncatedMessage,\n        config.workspaceId\n      );\n\n      // If Electron notification succeeded, we're done\n      if (result.success) {\n        return {\n          success: true,\n          title: truncatedTitle,\n          message: truncatedMessage,\n          ui_only: {\n            notify: {\n              notifiedVia: \"electron\",\n              workspaceId: config.workspaceId,\n            },\n          },\n        };\n      }\n\n      // Electron unavailable - signal frontend to handle browser notification\n      // This is not an error; the notification will be delivered via Web Notifications API\n      return {\n        success: true,\n        title: truncatedTitle,\n        message: truncatedMessage,\n        ui_only: {\n          notify: {\n            notifiedVia: \"browser\",\n            workspaceId: config.workspaceId,\n          },\n        },\n      };\n    },\n  });\n};\n"]}