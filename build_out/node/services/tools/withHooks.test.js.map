{"version":3,"file":"withHooks.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/withHooks.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, beforeEach, afterEach } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport * as os from \"os\";\nimport { tool } from \"ai\";\nimport { z } from \"zod\";\nimport { withHooks } from \"./withHooks\";\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\n\ndescribe(\"withHooks\", () => {\n  let tempDir: string;\n  let runtime: LocalRuntime;\n\n  beforeEach(async () => {\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-withHooks-test-\"));\n    runtime = new LocalRuntime(tempDir);\n  });\n\n  afterEach(async () => {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  });\n\n  function createTestTool(executeFn: (args: { input: string }) => Promise<{ output: string }>) {\n    return tool({\n      description: \"Test tool\",\n      inputSchema: z.object({ input: z.string() }),\n      execute: (args) => executeFn(args),\n    });\n  }\n\n  test(\"executes tool directly when no hook exists\", async () => {\n    const baseTool = createTestTool((args) =>\n      Promise.resolve({ output: `processed: ${args.input}` })\n    );\n\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = await wrappedTool.execute!({ input: \"hello\" }, {} as never);\n    expect(result).toEqual({ output: \"processed: hello\" });\n  });\n\n  test(\"executes tool through hook when hook exists\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const hookPath = path.join(hookDir, \"tool_hook\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      hookPath,\n      `#!/bin/bash\necho \"$MUX_EXEC\"\nread RESULT\n`\n    );\n    await fs.chmod(hookPath, 0o755);\n\n    const baseTool = createTestTool((args) =>\n      Promise.resolve({ output: `processed: ${args.input}` })\n    );\n\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = await wrappedTool.execute!({ input: \"world\" }, {} as never);\n    expect(result).toEqual({ output: \"processed: world\" });\n  });\n\n  test(\"returns error when hook blocks execution\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const hookPath = path.join(hookDir, \"tool_hook\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      hookPath,\n      `#!/bin/bash\necho \"Blocked: dangerous operation\" >&2\nexit 1\n`\n    );\n    await fs.chmod(hookPath, 0o755);\n\n    let toolCalled = false;\n    const baseTool = createTestTool(() => {\n      toolCalled = true;\n      return Promise.resolve({ output: \"should not run\" });\n    });\n\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\n      error?: string;\n    };\n    expect(toolCalled).toBe(false);\n    expect(result.error).toContain(\"Blocked: dangerous operation\");\n  });\n\n  test(\"appends hook_output when hook fails after execution\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const hookPath = path.join(hookDir, \"tool_hook\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      hookPath,\n      `#!/bin/bash\necho \"$MUX_EXEC\"\nread RESULT\necho \"Lint failed: syntax error\" >&2\nexit 1\n`\n    );\n    await fs.chmod(hookPath, 0o755);\n\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"edit complete\" }));\n\n    const wrappedTool = withHooks(\"file_edit\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\n      output: string;\n      hook_output?: string;\n    };\n    expect(result.output).toBe(\"edit complete\");\n    expect(result.hook_output).toContain(\"Lint failed: syntax error\");\n  });\n\n  test(\"appends hook_output and hook_path when hook succeeds with output\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const hookPath = path.join(hookDir, \"tool_hook\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      hookPath,\n      `#!/bin/bash\necho \"$MUX_EXEC\"\nread RESULT\necho \"Formatted: test.ts\" >&2\nexit 0\n`\n    );\n    await fs.chmod(hookPath, 0o755);\n\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"edit complete\" }));\n\n    const wrappedTool = withHooks(\"file_edit\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\n      output: string;\n      hook_output?: string;\n      hook_path?: string;\n    };\n    expect(result.output).toBe(\"edit complete\");\n    expect(result.hook_output).toContain(\"Formatted: test.ts\");\n    expect(result.hook_path).toBe(hookPath);\n  });\n\n  test(\"passes env to hook\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const hookPath = path.join(hookDir, \"tool_hook\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      hookPath,\n      `#!/bin/bash\n# Exit with error if SECRET is not set correctly\nif [ \"$MY_API_KEY\" != \"secret123\" ]; then\n  echo \"SECRET not found\" >&2\n  exit 1\nfi\necho \"$MUX_EXEC\"\nread RESULT\n`\n    );\n    await fs.chmod(hookPath, 0o755);\n\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"ok\" }));\n\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n      env: { MY_API_KEY: \"secret123\" },\n    });\n\n    const result = await wrappedTool.execute!({ input: \"test\" }, {} as never);\n    expect(result).toEqual({ output: \"ok\" });\n  });\n\n  test(\"uses tool_pre hook to block execution\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const hookPath = path.join(hookDir, \"tool_pre\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      hookPath,\n      `#!/bin/bash\necho \"Force push blocked\" >&2\nexit 1\n`\n    );\n    await fs.chmod(hookPath, 0o755);\n\n    let toolExecuted = false;\n    const baseTool = createTestTool(() => {\n      toolExecuted = true;\n      return Promise.resolve({ output: \"should not happen\" });\n    });\n\n    const wrappedTool = withHooks(\"bash\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as unknown as {\n      error: string;\n    };\n    expect(toolExecuted).toBe(false);\n    expect(result.error).toContain(\"Force push blocked\");\n  });\n\n  test(\"uses tool_post hook to add output after execution\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    const postHookPath = path.join(hookDir, \"tool_post\");\n    await fs.mkdir(hookDir, { recursive: true });\n    await fs.writeFile(\n      postHookPath,\n      `#!/bin/bash\necho \"Linting passed\" >&2\nexit 0\n`\n    );\n    await fs.chmod(postHookPath, 0o755);\n\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"edit done\" }));\n\n    const wrappedTool = withHooks(\"file_edit\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\n      output: string;\n      hook_output?: string;\n    };\n    expect(result.output).toBe(\"edit done\");\n    expect(result.hook_output).toContain(\"Linting passed\");\n  });\n\n  test(\"tool_pre takes priority over tool_hook\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    await fs.mkdir(hookDir, { recursive: true });\n\n    // Create both tool_pre and tool_hook\n    await fs.writeFile(path.join(hookDir, \"tool_pre\"), \"#!/bin/bash\\nexit 0\");\n    await fs.chmod(path.join(hookDir, \"tool_pre\"), 0o755);\n\n    // Legacy hook that would block if used\n    await fs.writeFile(path.join(hookDir, \"tool_hook\"), \"#!/bin/bash\\nexit 1\");\n    await fs.chmod(path.join(hookDir, \"tool_hook\"), 0o755);\n\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"success\" }));\n\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    // Should succeed because tool_pre (exit 0) takes priority over tool_hook (exit 1)\n    const result = await wrappedTool.execute!({ input: \"test\" }, {} as never);\n    expect(result).toEqual({ output: \"success\" });\n  });\n\n  test(\"tool_pre + tool_post work together\", async () => {\n    const hookDir = path.join(tempDir, \".mux\");\n    await fs.mkdir(hookDir, { recursive: true });\n\n    await fs.writeFile(path.join(hookDir, \"tool_pre\"), '#!/bin/bash\\necho \"pre ran\" >&2\\nexit 0');\n    await fs.chmod(path.join(hookDir, \"tool_pre\"), 0o755);\n\n    await fs.writeFile(\n      path.join(hookDir, \"tool_post\"),\n      '#!/bin/bash\\necho \"post ran: $MUX_TOOL_RESULT\"'\n    );\n    await fs.chmod(path.join(hookDir, \"tool_post\"), 0o755);\n\n    const baseTool = createTestTool(() =>\n      Promise.resolve({ output: \"done\", value: 42 } as { output: string; value?: number })\n    );\n\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\n      runtime,\n      cwd: tempDir,\n      runtimeTempDir: tempDir,\n      workspaceId: \"test-ws\",\n    });\n\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as unknown as {\n      value: number;\n      hook_output?: string;\n    };\n    expect(result.value).toBe(42);\n    expect(result.hook_output).toContain(\"post ran:\");\n    expect(result.hook_output).toContain('\"value\":42');\n  });\n});\n"]}