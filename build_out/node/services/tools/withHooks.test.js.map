{"version":3,"file":"withHooks.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/withHooks.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { tool } from \"ai\";\r\nimport { z } from \"zod\";\r\nimport { withHooks } from \"./withHooks\";\r\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\r\n\r\ndescribe(\"withHooks\", () => {\r\n  let tempDir: string;\r\n  let runtime: LocalRuntime;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-withHooks-test-\"));\r\n    runtime = new LocalRuntime(tempDir);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fs.rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  function createTestTool(executeFn: (args: { input: string }) => Promise<{ output: string }>) {\r\n    return tool({\r\n      description: \"Test tool\",\r\n      inputSchema: z.object({ input: z.string() }),\r\n      execute: (args) => executeFn(args),\r\n    });\r\n  }\r\n\r\n  test(\"executes tool directly when no hook exists\", async () => {\r\n    const baseTool = createTestTool((args) =>\r\n      Promise.resolve({ output: `processed: ${args.input}` })\r\n    );\r\n\r\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = await wrappedTool.execute!({ input: \"hello\" }, {} as never);\r\n    expect(result).toEqual({ output: \"processed: hello\" });\r\n  });\r\n\r\n  test(\"executes tool through hook when hook exists\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const hookPath = path.join(hookDir, \"tool_hook\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      hookPath,\r\n      `#!/bin/bash\r\necho \"$MUX_EXEC\"\r\nread RESULT\r\n`\r\n    );\r\n    await fs.chmod(hookPath, 0o755);\r\n\r\n    const baseTool = createTestTool((args) =>\r\n      Promise.resolve({ output: `processed: ${args.input}` })\r\n    );\r\n\r\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = await wrappedTool.execute!({ input: \"world\" }, {} as never);\r\n    expect(result).toEqual({ output: \"processed: world\" });\r\n  });\r\n\r\n  test(\"returns error when hook blocks execution\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const hookPath = path.join(hookDir, \"tool_hook\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      hookPath,\r\n      `#!/bin/bash\r\necho \"Blocked: dangerous operation\" >&2\r\nexit 1\r\n`\r\n    );\r\n    await fs.chmod(hookPath, 0o755);\r\n\r\n    let toolCalled = false;\r\n    const baseTool = createTestTool(() => {\r\n      toolCalled = true;\r\n      return Promise.resolve({ output: \"should not run\" });\r\n    });\r\n\r\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\r\n      error?: string;\r\n    };\r\n    expect(toolCalled).toBe(false);\r\n    expect(result.error).toContain(\"Blocked: dangerous operation\");\r\n  });\r\n\r\n  test(\"appends hook_output when hook fails after execution\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const hookPath = path.join(hookDir, \"tool_hook\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      hookPath,\r\n      `#!/bin/bash\r\necho \"$MUX_EXEC\"\r\nread RESULT\r\necho \"Lint failed: syntax error\" >&2\r\nexit 1\r\n`\r\n    );\r\n    await fs.chmod(hookPath, 0o755);\r\n\r\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"edit complete\" }));\r\n\r\n    const wrappedTool = withHooks(\"file_edit\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\r\n      output: string;\r\n      hook_output?: string;\r\n    };\r\n    expect(result.output).toBe(\"edit complete\");\r\n    expect(result.hook_output).toContain(\"Lint failed: syntax error\");\r\n  });\r\n\r\n  test(\"appends hook_output and hook_path when hook succeeds with output\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const hookPath = path.join(hookDir, \"tool_hook\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      hookPath,\r\n      `#!/bin/bash\r\necho \"$MUX_EXEC\"\r\nread RESULT\r\necho \"Formatted: test.ts\" >&2\r\nexit 0\r\n`\r\n    );\r\n    await fs.chmod(hookPath, 0o755);\r\n\r\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"edit complete\" }));\r\n\r\n    const wrappedTool = withHooks(\"file_edit\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\r\n      output: string;\r\n      hook_output?: string;\r\n      hook_path?: string;\r\n    };\r\n    expect(result.output).toBe(\"edit complete\");\r\n    expect(result.hook_output).toContain(\"Formatted: test.ts\");\r\n    expect(result.hook_path).toBe(hookPath);\r\n  });\r\n\r\n  test(\"passes env to hook\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const hookPath = path.join(hookDir, \"tool_hook\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      hookPath,\r\n      `#!/bin/bash\r\n# Exit with error if SECRET is not set correctly\r\nif [ \"$MY_API_KEY\" != \"secret123\" ]; then\r\n  echo \"SECRET not found\" >&2\r\n  exit 1\r\nfi\r\necho \"$MUX_EXEC\"\r\nread RESULT\r\n`\r\n    );\r\n    await fs.chmod(hookPath, 0o755);\r\n\r\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"ok\" }));\r\n\r\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n      env: { MY_API_KEY: \"secret123\" },\r\n    });\r\n\r\n    const result = await wrappedTool.execute!({ input: \"test\" }, {} as never);\r\n    expect(result).toEqual({ output: \"ok\" });\r\n  });\r\n\r\n  test(\"uses tool_pre hook to block execution\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const hookPath = path.join(hookDir, \"tool_pre\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      hookPath,\r\n      `#!/bin/bash\r\necho \"Force push blocked\" >&2\r\nexit 1\r\n`\r\n    );\r\n    await fs.chmod(hookPath, 0o755);\r\n\r\n    let toolExecuted = false;\r\n    const baseTool = createTestTool(() => {\r\n      toolExecuted = true;\r\n      return Promise.resolve({ output: \"should not happen\" });\r\n    });\r\n\r\n    const wrappedTool = withHooks(\"bash\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as unknown as {\r\n      error: string;\r\n    };\r\n    expect(toolExecuted).toBe(false);\r\n    expect(result.error).toContain(\"Force push blocked\");\r\n  });\r\n\r\n  test(\"uses tool_post hook to add output after execution\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    const postHookPath = path.join(hookDir, \"tool_post\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n    await fs.writeFile(\r\n      postHookPath,\r\n      `#!/bin/bash\r\necho \"Linting passed\" >&2\r\nexit 0\r\n`\r\n    );\r\n    await fs.chmod(postHookPath, 0o755);\r\n\r\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"edit done\" }));\r\n\r\n    const wrappedTool = withHooks(\"file_edit\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as {\r\n      output: string;\r\n      hook_output?: string;\r\n    };\r\n    expect(result.output).toBe(\"edit done\");\r\n    expect(result.hook_output).toContain(\"Linting passed\");\r\n  });\r\n\r\n  test(\"tool_pre takes priority over tool_hook\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n\r\n    // Create both tool_pre and tool_hook\r\n    await fs.writeFile(path.join(hookDir, \"tool_pre\"), \"#!/bin/bash\\nexit 0\");\r\n    await fs.chmod(path.join(hookDir, \"tool_pre\"), 0o755);\r\n\r\n    // Legacy hook that would block if used\r\n    await fs.writeFile(path.join(hookDir, \"tool_hook\"), \"#!/bin/bash\\nexit 1\");\r\n    await fs.chmod(path.join(hookDir, \"tool_hook\"), 0o755);\r\n\r\n    const baseTool = createTestTool(() => Promise.resolve({ output: \"success\" }));\r\n\r\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    // Should succeed because tool_pre (exit 0) takes priority over tool_hook (exit 1)\r\n    const result = await wrappedTool.execute!({ input: \"test\" }, {} as never);\r\n    expect(result).toEqual({ output: \"success\" });\r\n  });\r\n\r\n  test(\"tool_pre + tool_post work together\", async () => {\r\n    const hookDir = path.join(tempDir, \".mux\");\r\n    await fs.mkdir(hookDir, { recursive: true });\r\n\r\n    await fs.writeFile(path.join(hookDir, \"tool_pre\"), '#!/bin/bash\\necho \"pre ran\" >&2\\nexit 0');\r\n    await fs.chmod(path.join(hookDir, \"tool_pre\"), 0o755);\r\n\r\n    await fs.writeFile(\r\n      path.join(hookDir, \"tool_post\"),\r\n      '#!/bin/bash\\necho \"post ran: $MUX_TOOL_RESULT\"'\r\n    );\r\n    await fs.chmod(path.join(hookDir, \"tool_post\"), 0o755);\r\n\r\n    const baseTool = createTestTool(() =>\r\n      Promise.resolve({ output: \"done\", value: 42 } as { output: string; value?: number })\r\n    );\r\n\r\n    const wrappedTool = withHooks(\"test_tool\", baseTool, {\r\n      runtime,\r\n      cwd: tempDir,\r\n      runtimeTempDir: tempDir,\r\n      workspaceId: \"test-ws\",\r\n    });\r\n\r\n    const result = (await wrappedTool.execute!({ input: \"test\" }, {} as never)) as unknown as {\r\n      value: number;\r\n      hook_output?: string;\r\n    };\r\n    expect(result.value).toBe(42);\r\n    expect(result.hook_output).toContain(\"post ran:\");\r\n    expect(result.hook_output).toContain('\"value\":42');\r\n  });\r\n});\r\n"]}