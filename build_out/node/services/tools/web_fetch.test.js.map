{"version":3,"file":"web_fetch.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/web_fetch.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport { createWebFetchTool } from \"./web_fetch\";\r\nimport type { WebFetchToolArgs, WebFetchToolResult } from \"@/common/types/tools\";\r\nimport { WEB_FETCH_MAX_OUTPUT_BYTES } from \"@/common/constants/toolLimits\";\r\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\r\nimport { isMuxMdUrl, parseMuxMdUrl, uploadToMuxMd, deleteFromMuxMd } from \"@/common/lib/muxMd\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\n\r\nimport type { ToolExecutionOptions } from \"ai\";\r\n\r\n// ToolCallOptions stub for testing\r\n\r\nconst itIntegration = process.env.TEST_INTEGRATION === \"1\" ? it : it.skip;\r\nconst toolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\n// Helper to create web_fetch tool with real LocalRuntime\r\nfunction createTestWebFetchTool() {\r\n  const tempDir = new TestTempDir(\"test-web-fetch\");\r\n  const config = createTestToolConfig(tempDir.path);\r\n  const tool = createWebFetchTool(config);\r\n\r\n  return {\r\n    tool,\r\n    tempDir,\r\n    [Symbol.dispose]() {\r\n      tempDir[Symbol.dispose]();\r\n    },\r\n  };\r\n}\r\n\r\ndescribe(\"mux.md URL helpers\", () => {\r\n  describe(\"isMuxMdUrl\", () => {\r\n    it(\"should detect valid mux.md URLs\", () => {\r\n      expect(isMuxMdUrl(\"https://mux.md/abc123#key456\")).toBe(true);\r\n      expect(isMuxMdUrl(\"https://mux.md/RQJe3#Fbbhosspt9q9Ig\")).toBe(true);\r\n    });\r\n\r\n    it(\"should reject mux.md URLs without hash\", () => {\r\n      expect(isMuxMdUrl(\"https://mux.md/abc123\")).toBe(false);\r\n    });\r\n\r\n    it(\"should reject mux.md URLs with empty hash\", () => {\r\n      expect(isMuxMdUrl(\"https://mux.md/abc123#\")).toBe(false);\r\n    });\r\n\r\n    it(\"should reject non-mux.md URLs\", () => {\r\n      expect(isMuxMdUrl(\"https://example.com/page#hash\")).toBe(false);\r\n      expect(isMuxMdUrl(\"https://other.md/abc#key\")).toBe(false);\r\n    });\r\n\r\n    it(\"should handle invalid URLs gracefully\", () => {\r\n      expect(isMuxMdUrl(\"not-a-url\")).toBe(false);\r\n      expect(isMuxMdUrl(\"\")).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"parseMuxMdUrl\", () => {\r\n    it(\"should extract id and key from valid mux.md URL\", () => {\r\n      const result = parseMuxMdUrl(\"https://mux.md/abc123#key456\");\r\n      expect(result).toEqual({ id: \"abc123\", key: \"key456\" });\r\n    });\r\n\r\n    it(\"should handle base64url characters in key\", () => {\r\n      const result = parseMuxMdUrl(\"https://mux.md/RQJe3#Fbbhosspt9q9Ig\");\r\n      expect(result).toEqual({ id: \"RQJe3\", key: \"Fbbhosspt9q9Ig\" });\r\n    });\r\n\r\n    it(\"should return null for URLs without hash\", () => {\r\n      expect(parseMuxMdUrl(\"https://mux.md/abc123\")).toBeNull();\r\n    });\r\n\r\n    it(\"should return null for URLs with empty id\", () => {\r\n      expect(parseMuxMdUrl(\"https://mux.md/#key\")).toBeNull();\r\n    });\r\n\r\n    it(\"should return null for invalid URLs\", () => {\r\n      expect(parseMuxMdUrl(\"not-a-url\")).toBeNull();\r\n    });\r\n  });\r\n});\r\n\r\ndescribe(\"web_fetch tool\", () => {\r\n  // Integration test: fetch a real public URL\r\n  itIntegration(\"should fetch and convert a real web page to markdown\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // example.com is a stable, simple HTML page maintained by IANA\r\n      url: \"https://example.com\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.title).toContain(\"Example Domain\");\r\n      expect(result.url).toBe(\"https://example.com\");\r\n      // example.com mentions documentation examples\r\n      expect(result.content).toContain(\"documentation\");\r\n      expect(result.length).toBeGreaterThan(0);\r\n    }\r\n  });\r\n\r\n  // Integration test: fetch plain text endpoint (not HTML)\r\n  itIntegration(\"should fetch plain text content without HTML processing\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // Cloudflare's trace endpoint returns plain text diagnostics\r\n      url: \"https://cloudflare.com/cdn-cgi/trace\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      // Should contain typical trace fields\r\n      expect(result.content).toContain(\"fl=\");\r\n      expect(result.content).toContain(\"h=\");\r\n      expect(result.content).toContain(\"ip=\");\r\n      // Title should be the URL for plain text\r\n      expect(result.title).toBe(\"https://cloudflare.com/cdn-cgi/trace\");\r\n      expect(result.length).toBeGreaterThan(0);\r\n    }\r\n  });\r\n\r\n  itIntegration(\"should handle DNS failure gracefully\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // .invalid TLD is reserved and guaranteed to never resolve\r\n      url: \"https://this-domain-does-not-exist.invalid/page\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Failed to fetch URL\");\r\n    }\r\n  });\r\n\r\n  it(\"should handle connection refused gracefully\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // localhost on a random high port should refuse connection\r\n      url: \"http://127.0.0.1:59999/page\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Failed to fetch URL\");\r\n    }\r\n  });\r\n\r\n  // Test with a local file served via file:// - tests HTML parsing without network\r\n  it(\"should handle local HTML content via file:// URL\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    // Create a test HTML file\r\n    const htmlContent = `\r\n<!DOCTYPE html>\r\n<html>\r\n<head><title>Local Test Page</title></head>\r\n<body>\r\n  <article>\r\n    <h1>Test Heading</h1>\r\n    <p>This is test content with <strong>bold</strong> and <em>italic</em> text.</p>\r\n  </article>\r\n</body>\r\n</html>`;\r\n    const htmlPath = path.join(testEnv.tempDir.path, \"test.html\");\r\n    await fs.writeFile(htmlPath, htmlContent);\r\n\r\n    const args: WebFetchToolArgs = {\r\n      url: `file://${htmlPath}`,\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.title).toBe(\"Local Test Page\");\r\n      expect(result.content).toContain(\"Test Heading\");\r\n      expect(result.content).toContain(\"**bold**\");\r\n      expect(result.content).toContain(\"_italic_\");\r\n    }\r\n  });\r\n\r\n  it(\"should not treat non-mux.md URLs with fragments as mux.md shares\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    const htmlContent = `\r\n<!DOCTYPE html>\r\n<html>\r\n<head><title>Fragment Page</title></head>\r\n<body>\r\n  <article>\r\n    <h1>Hello</h1>\r\n    <p>This is a fragment test.</p>\r\n  </article>\r\n</body>\r\n</html>`;\r\n    const htmlPath = path.join(testEnv.tempDir.path, \"fragment.html\");\r\n    await fs.writeFile(htmlPath, htmlContent);\r\n\r\n    const args: WebFetchToolArgs = {\r\n      url: `file://${htmlPath}#section1`,\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.title).toBe(\"Fragment Page\");\r\n      expect(result.content).toContain(\"This is a fragment test.\");\r\n    }\r\n  });\r\n\r\n  it(\"should truncate oversized output from local file\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    // Create HTML that will produce content larger than WEB_FETCH_MAX_OUTPUT_BYTES\r\n    const largeContent = \"x\".repeat(WEB_FETCH_MAX_OUTPUT_BYTES + 1000);\r\n    const htmlContent = `\r\n<!DOCTYPE html>\r\n<html>\r\n<head><title>Large Page</title></head>\r\n<body><article><p>${largeContent}</p></article></body>\r\n</html>`;\r\n    const htmlPath = path.join(testEnv.tempDir.path, \"large.html\");\r\n    await fs.writeFile(htmlPath, htmlContent);\r\n\r\n    const args: WebFetchToolArgs = {\r\n      url: `file://${htmlPath}`,\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.content.length).toBeLessThanOrEqual(\r\n        WEB_FETCH_MAX_OUTPUT_BYTES + 100 // Allow for truncation message\r\n      );\r\n      expect(result.content).toContain(\"[Content truncated]\");\r\n    }\r\n  });\r\n\r\n  it(\"should handle non-article HTML gracefully\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    // Minimal HTML that Readability may not parse as an article\r\n    const htmlContent = \"<html><body><p>Just some text</p></body></html>\";\r\n    const htmlPath = path.join(testEnv.tempDir.path, \"minimal.html\");\r\n    await fs.writeFile(htmlPath, htmlContent);\r\n\r\n    const args: WebFetchToolArgs = {\r\n      url: `file://${htmlPath}`,\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    // Readability may or may not parse this - the important thing is we don't crash\r\n    expect(typeof result.success).toBe(\"boolean\");\r\n  });\r\n\r\n  it(\"should handle empty file\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    const htmlPath = path.join(testEnv.tempDir.path, \"empty.html\");\r\n    await fs.writeFile(htmlPath, \"\");\r\n\r\n    const args: WebFetchToolArgs = {\r\n      url: `file://${htmlPath}`,\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Empty response\");\r\n    }\r\n  });\r\n\r\n  it(\"should handle missing file\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    const args: WebFetchToolArgs = {\r\n      url: `file://${testEnv.tempDir.path}/nonexistent.html`,\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Failed to fetch URL\");\r\n    }\r\n  });\r\n\r\n  // Test HTTP error handling with body parsing\r\n  itIntegration(\"should include HTTP status code in error for non-2xx responses\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // httpbin.dev reliably returns the requested status code\r\n      url: \"https://httpbin.dev/status/404\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"HTTP 404\");\r\n    }\r\n  });\r\n\r\n  itIntegration(\"should detect Cloudflare challenge pages\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // platform.openai.com is known to serve Cloudflare challenges\r\n      url: \"https://platform.openai.com\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Cloudflare\");\r\n      expect(result.error).toContain(\"JavaScript\");\r\n    }\r\n  });\r\n\r\n  // mux.md integration tests\r\n  itIntegration(\"should handle expired/missing mux.md share links\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // Non-existent share ID should return 404\r\n      url: \"https://mux.md/nonexistent123#somekey456\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"expired or not found\");\r\n    }\r\n  });\r\n\r\n  it(\"should return error for mux.md URLs without valid key format\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n    const args: WebFetchToolArgs = {\r\n      // URL without hash (invalid mux.md format) - should fall through to normal fetch\r\n      // which will fail to extract content from mux.md's HTML viewer\r\n      url: \"https://mux.md/someid\",\r\n    };\r\n\r\n    const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n    // Without the key fragment, it's treated as a normal URL fetch\r\n    // The mux.md viewer page won't have extractable content\r\n    expect(result.success).toBe(false);\r\n  });\r\n\r\n  itIntegration(\"should decrypt and return mux.md content correctly\", async () => {\r\n    using testEnv = createTestWebFetchTool();\r\n\r\n    // Upload test content to mux.md\r\n    const testContent = \"# Test Heading\\n\\nThis is **test content** for web_fetch decryption.\";\r\n    const uploadResult = await uploadToMuxMd(\r\n      testContent,\r\n      { name: \"test.md\", type: \"text/markdown\", size: testContent.length },\r\n      { expiresAt: new Date(Date.now() + 60000) }\r\n    );\r\n\r\n    try {\r\n      // Fetch via web_fetch tool\r\n      const args: WebFetchToolArgs = { url: uploadResult.url };\r\n      const result = (await testEnv.tool.execute!(args, toolCallOptions)) as WebFetchToolResult;\r\n\r\n      expect(result.success).toBe(true);\r\n      if (result.success) {\r\n        expect(result.content).toBe(testContent);\r\n        expect(result.title).toBe(\"test.md\");\r\n        expect(result.url).toBe(uploadResult.url);\r\n        expect(result.length).toBe(testContent.length);\r\n      }\r\n    } finally {\r\n      // Clean up\r\n      await deleteFromMuxMd(uploadResult.id, uploadResult.mutateKey);\r\n    }\r\n  });\r\n});\r\n"]}