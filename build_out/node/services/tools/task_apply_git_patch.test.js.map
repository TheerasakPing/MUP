{"version":3,"file":"task_apply_git_patch.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task_apply_git_patch.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport { execSync } from \"node:child_process\";\r\n\r\nimport type { ToolExecutionOptions } from \"ai\";\r\n\r\nimport { createTaskApplyGitPatchTool } from \"@/node/services/tools/task_apply_git_patch\";\r\nimport {\r\n  getSubagentGitPatchMboxPath,\r\n  readSubagentGitPatchArtifact,\r\n  upsertSubagentGitPatchArtifact,\r\n} from \"@/node/services/subagentGitPatchArtifacts\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport { getTestDeps } from \"@/node/services/tools/testHelpers\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\nfunction initGitRepo(repoPath: string): void {\r\n  execSync(\"git init -b main\", { cwd: repoPath, stdio: \"ignore\" });\r\n  execSync('git config user.email \"test@example.com\"', { cwd: repoPath, stdio: \"ignore\" });\r\n  execSync('git config user.name \"test\"', { cwd: repoPath, stdio: \"ignore\" });\r\n  execSync(\"git config commit.gpgsign false\", { cwd: repoPath, stdio: \"ignore\" });\r\n}\r\n\r\nasync function commitFile(\r\n  repoPath: string,\r\n  fileName: string,\r\n  content: string,\r\n  message: string\r\n): Promise<void> {\r\n  await fsPromises.writeFile(path.join(repoPath, fileName), content, \"utf-8\");\r\n  execSync(`git add -- ${fileName}`, { cwd: repoPath, stdio: \"ignore\" });\r\n  execSync(`git commit -m ${JSON.stringify(message)}`, { cwd: repoPath, stdio: \"ignore\" });\r\n}\r\n\r\ndescribe(\"task_apply_git_patch tool\", () => {\r\n  let rootDir: string;\r\n  let childRepo: string;\r\n  let targetRepo: string;\r\n  let sessionDir: string;\r\n\r\n  beforeEach(async () => {\r\n    rootDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-task-apply-git-patch-\"));\r\n    childRepo = path.join(rootDir, \"child\");\r\n    targetRepo = path.join(rootDir, \"target\");\r\n    sessionDir = path.join(rootDir, \"session\");\r\n\r\n    await fsPromises.mkdir(childRepo, { recursive: true });\r\n    await fsPromises.mkdir(targetRepo, { recursive: true });\r\n    await fsPromises.mkdir(sessionDir, { recursive: true });\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await fsPromises.rm(rootDir, { recursive: true, force: true });\r\n  });\r\n\r\n  it(\"applies a ready patch artifact via git am and marks it applied\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    // Both repos start from the same base content so the patch applies cleanly.\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\\nworld\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n      }),\r\n    });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(execSync(\"git log -1 --pretty=%s\", { cwd: targetRepo, encoding: \"utf-8\" }).trim()).toBe(\r\n      \"child change\"\r\n    );\r\n\r\n    const artifact = await readSubagentGitPatchArtifact(sessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs ?? 0).toBeGreaterThan(0);\r\n  }, 20_000);\r\n\r\n  it(\"replays patch artifacts from an ancestor session dir without mutating metadata\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    // Both repos start from the same base content so the patch applies cleanly.\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\\nworld\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    const childTaskId = \"child-task-1\";\r\n\r\n    const ancestorWorkspaceId = \"ancestor-workspace\";\r\n    const currentWorkspaceId = \"current-workspace\";\r\n\r\n    const muxSessionsDir = path.join(rootDir, \"sessions\");\r\n    const ancestorSessionDir = path.join(muxSessionsDir, ancestorWorkspaceId);\r\n    const currentSessionDir = path.join(muxSessionsDir, currentWorkspaceId);\r\n\r\n    await fsPromises.mkdir(ancestorSessionDir, { recursive: true });\r\n    await fsPromises.mkdir(currentSessionDir, { recursive: true });\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(ancestorSessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    const appliedAtMs = Date.now();\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId: ancestorWorkspaceId,\r\n      workspaceSessionDir: ancestorSessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: ancestorWorkspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n        appliedAtMs,\r\n      }),\r\n    });\r\n\r\n    // Minimal config.json to allow parentWorkspaceId traversal for ancestor lookup.\r\n    await fsPromises.writeFile(\r\n      path.join(rootDir, \"config.json\"),\r\n      JSON.stringify(\r\n        {\r\n          projects: [\r\n            [\r\n              \"/tmp/test-project\",\r\n              {\r\n                workspaces: [\r\n                  { path: \"/tmp/ancestor\", id: ancestorWorkspaceId, name: \"ancestor\" },\r\n                  {\r\n                    path: \"/tmp/current\",\r\n                    id: currentWorkspaceId,\r\n                    name: \"current\",\r\n                    parentWorkspaceId: ancestorWorkspaceId,\r\n                  },\r\n                ],\r\n              },\r\n            ],\r\n          ],\r\n        },\r\n        null,\r\n        2\r\n      ),\r\n      \"utf-8\"\r\n    );\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      workspaceId: currentWorkspaceId,\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: currentSessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(execSync(\"git log -1 --pretty=%s\", { cwd: targetRepo, encoding: \"utf-8\" }).trim()).toBe(\r\n      \"child change\"\r\n    );\r\n\r\n    // The replay path must never mutate the ancestor patch metadata.\r\n    const artifact = await readSubagentGitPatchArtifact(ancestorSessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs).toBe(appliedAtMs);\r\n\r\n    const replayArtifact = await readSubagentGitPatchArtifact(currentSessionDir, childTaskId);\r\n    expect(replayArtifact).toBeNull();\r\n  }, 20_000);\r\n\r\n  it(\"supports dry_run without changing the repo or marking applied\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\\nworld\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n      }),\r\n    });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!(\r\n      { task_id: childTaskId, dry_run: true },\r\n      mockToolCallOptions\r\n    )) as { success: boolean; error?: string };\r\n\r\n    expect(result.success).toBe(true);\r\n\r\n    // HEAD should remain on the base commit.\r\n    expect(execSync(\"git log -1 --pretty=%s\", { cwd: targetRepo, encoding: \"utf-8\" }).trim()).toBe(\r\n      \"base\"\r\n    );\r\n\r\n    const artifact = await readSubagentGitPatchArtifact(sessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs).toBeUndefined();\r\n  }, 20_000);\r\n\r\n  it(\"returns a clear error when the patch does not apply cleanly\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello world\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    // Create a conflicting change in the target repo.\r\n    await commitFile(targetRepo, \"README.md\", \"hello there\", \"target change\");\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n      }),\r\n    });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      dryRun?: boolean;\r\n      conflictPaths?: string[];\r\n      failedPatchSubject?: string;\r\n      error?: string;\r\n      note?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(false);\r\n    expect(result.dryRun).toBe(false);\r\n    expect(result.failedPatchSubject).toBe(\"child change\");\r\n    expect(result.conflictPaths ?? []).toContain(\"README.md\");\r\n    expect(result.error).toBeTruthy();\r\n    expect(result.note).toContain(\"git am --continue\");\r\n\r\n    const artifact = await readSubagentGitPatchArtifact(sessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs).toBeUndefined();\r\n  }, 20_000);\r\n\r\n  it(\"returns structured conflict diagnostics on dry_run failure\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello world\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    // Create a conflicting change in the target repo.\r\n    await commitFile(targetRepo, \"README.md\", \"hello there\", \"target change\");\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n      }),\r\n    });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!(\r\n      { task_id: childTaskId, dry_run: true },\r\n      mockToolCallOptions\r\n    )) as {\r\n      success: boolean;\r\n      dryRun?: boolean;\r\n      conflictPaths?: string[];\r\n      failedPatchSubject?: string;\r\n      error?: string;\r\n      note?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(false);\r\n    expect(result.dryRun).toBe(true);\r\n    expect(result.failedPatchSubject).toBe(\"child change\");\r\n    expect(result.conflictPaths ?? []).toContain(\"README.md\");\r\n    expect(result.error).toBeTruthy();\r\n    expect(result.note).toContain(\"Dry run failed\");\r\n\r\n    // Dry run should not affect the original worktree.\r\n    expect(execSync(\"git log -1 --pretty=%s\", { cwd: targetRepo, encoding: \"utf-8\" }).trim()).toBe(\r\n      \"target change\"\r\n    );\r\n\r\n    const artifact = await readSubagentGitPatchArtifact(sessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs).toBeUndefined();\r\n  }, 20_000);\r\n\r\n  it(\"allows applying with force=true even when the working tree isn't clean\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\\nworld\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n      }),\r\n    });\r\n\r\n    // Make the target repo \"dirty\" (untracked file). This should block without force=true.\r\n    await fsPromises.writeFile(path.join(targetRepo, \"UNTRACKED.md\"), \"untracked\", \"utf-8\");\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const dirtyResult = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n      note?: string;\r\n    };\r\n\r\n    expect(dirtyResult.success).toBe(false);\r\n    expect(dirtyResult.error).toBe(\"Working tree is not clean.\");\r\n    expect(dirtyResult.note).toContain(\"force=true\");\r\n\r\n    const forceResult = (await tool.execute!(\r\n      { task_id: childTaskId, force: true },\r\n      mockToolCallOptions\r\n    )) as { success: boolean; error?: string };\r\n\r\n    expect(forceResult.success).toBe(true);\r\n\r\n    expect(execSync(\"git log -1 --pretty=%s\", { cwd: targetRepo, encoding: \"utf-8\" }).trim()).toBe(\r\n      \"child change\"\r\n    );\r\n\r\n    const artifact = await readSubagentGitPatchArtifact(sessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs ?? 0).toBeGreaterThan(0);\r\n  }, 20_000);\r\n\r\n  it(\"blocks applying when there are staged changes unless force=true\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    // Both repos start from the same base content so the patch applies cleanly.\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\\nworld\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: patchPath,\r\n      }),\r\n    });\r\n\r\n    // Stage a change in the target repo. This should block without force=true.\r\n    await fsPromises.writeFile(path.join(targetRepo, \"STAGED.md\"), \"staged\", \"utf-8\");\r\n    execSync(\"git add -- STAGED.md\", { cwd: targetRepo, stdio: \"ignore\" });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n      note?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(false);\r\n    expect(result.error).toBe(\"Working tree is not clean.\");\r\n    expect(result.note).toContain(\"force=true\");\r\n\r\n    // The patch should not have been applied or marked applied.\r\n    expect(execSync(\"git log -1 --pretty=%s\", { cwd: targetRepo, encoding: \"utf-8\" }).trim()).toBe(\r\n      \"base\"\r\n    );\r\n\r\n    const artifact = await readSubagentGitPatchArtifact(sessionDir, childTaskId);\r\n    expect(artifact?.appliedAtMs).toBeUndefined();\r\n  }, 20_000);\r\n\r\n  it(\"ignores an unsafe mboxPath in artifact metadata\", async () => {\r\n    initGitRepo(childRepo);\r\n    initGitRepo(targetRepo);\r\n\r\n    // Both repos start from the same base content so the patch applies cleanly.\r\n    await commitFile(childRepo, \"README.md\", \"hello\", \"base\");\r\n    await commitFile(targetRepo, \"README.md\", \"hello\", \"base\");\r\n\r\n    const baseSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    await commitFile(childRepo, \"README.md\", \"hello\\nworld\", \"child change\");\r\n    const headSha = execSync(\"git rev-parse HEAD\", { cwd: childRepo, encoding: \"utf-8\" }).trim();\r\n\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const patchPath = getSubagentGitPatchMboxPath(sessionDir, childTaskId);\r\n    const patch = execSync(`git format-patch --stdout --binary ${baseSha}..${headSha}`, {\r\n      cwd: childRepo,\r\n      encoding: \"buffer\",\r\n    });\r\n\r\n    await fsPromises.mkdir(path.dirname(patchPath), { recursive: true });\r\n    await fsPromises.writeFile(patchPath, patch);\r\n\r\n    // Simulate corrupted metadata pointing outside the session dir.\r\n    const unsafePath = path.join(rootDir, \"outside-session.mbox\");\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        baseCommitSha: baseSha,\r\n        headCommitSha: headSha,\r\n        commitCount: 1,\r\n        mboxPath: unsafePath,\r\n      }),\r\n    });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: targetRepo,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n      note?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(result.note).toContain(\"Ignoring unsafe mboxPath\");\r\n  }, 20_000);\r\n\r\n  it(\"returns clear errors for non-ready patch artifact statuses\", async () => {\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: rootDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"pending\",\r\n      }),\r\n    });\r\n\r\n    const pendingResult = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n    };\r\n\r\n    expect(pendingResult.success).toBe(false);\r\n    expect(pendingResult.error).toContain(\"pending\");\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"failed\",\r\n        error: \"boom\",\r\n      }),\r\n    });\r\n\r\n    const failedResult = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n    };\r\n\r\n    expect(failedResult.success).toBe(false);\r\n    expect(failedResult.error).toContain(\"boom\");\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"skipped\",\r\n      }),\r\n    });\r\n\r\n    const skippedResult = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n    };\r\n\r\n    expect(skippedResult.success).toBe(false);\r\n    expect(skippedResult.error).toContain(\"skipped\");\r\n  });\r\n\r\n  it(\"refuses to apply an already-applied patch unless force=true\", async () => {\r\n    const childTaskId = \"child-task-1\";\r\n    const workspaceId = getTestDeps().workspaceId;\r\n\r\n    await upsertSubagentGitPatchArtifact({\r\n      workspaceId,\r\n      workspaceSessionDir: sessionDir,\r\n      childTaskId,\r\n      updater: () => ({\r\n        childTaskId,\r\n        parentWorkspaceId: workspaceId,\r\n        createdAtMs: Date.now(),\r\n        status: \"ready\",\r\n        appliedAtMs: Date.now(),\r\n      }),\r\n    });\r\n\r\n    const tool = createTaskApplyGitPatchTool({\r\n      ...getTestDeps(),\r\n      cwd: rootDir,\r\n      runtime: createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" }),\r\n      runtimeTempDir: \"/tmp\",\r\n      workspaceSessionDir: sessionDir,\r\n    });\r\n\r\n    const result = (await tool.execute!({ task_id: childTaskId }, mockToolCallOptions)) as {\r\n      success: boolean;\r\n      error?: string;\r\n      note?: string;\r\n    };\r\n\r\n    expect(result.success).toBe(false);\r\n    expect(result.error).toContain(\"Patch already applied\");\r\n    expect(result.note).toContain(\"force=true\");\r\n  });\r\n});\r\n"]}