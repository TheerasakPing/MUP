{"version":3,"file":"ask_user_question.js","sourceRoot":"","sources":["../../../../src/node/services/tools/ask_user_question.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"node:assert/strict\";\n\nimport { tool } from \"ai\";\n\nimport type { AskUserQuestionToolResult } from \"@/common/types/tools\";\nimport { buildAskUserQuestionSummary } from \"@/common/utils/tools/askUserQuestionSummary\";\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\nimport { askUserQuestionManager } from \"@/node/services/askUserQuestionManager\";\n\nexport const createAskUserQuestionTool: ToolFactory = (config: ToolConfiguration) => {\n  return tool({\n    description: TOOL_DEFINITIONS.ask_user_question.description,\n    inputSchema: TOOL_DEFINITIONS.ask_user_question.schema,\n    execute: async (args, { abortSignal, toolCallId }): Promise<AskUserQuestionToolResult> => {\n      // Claude Code allows passing pre-filled answers directly. If provided, we can short-circuit\n      // and return immediately without prompting.\n      if (args.answers && Object.keys(args.answers).length > 0) {\n        return {\n          summary: buildAskUserQuestionSummary(args.answers),\n          ui_only: {\n            ask_user_question: {\n              questions: args.questions,\n              answers: args.answers,\n            },\n          },\n        };\n      }\n\n      assert(config.workspaceId, \"ask_user_question requires a workspaceId\");\n      assert(toolCallId, \"ask_user_question requires toolCallId\");\n\n      const pendingPromise = askUserQuestionManager.registerPending(\n        config.workspaceId,\n        toolCallId,\n        args.questions\n      );\n\n      if (!abortSignal) {\n        const answers = await pendingPromise;\n        return {\n          summary: buildAskUserQuestionSummary(answers),\n          ui_only: {\n            ask_user_question: {\n              questions: args.questions,\n              answers,\n            },\n          },\n        };\n      }\n\n      if (abortSignal.aborted) {\n        // Ensure we don't leak a pending prompt entry.\n        try {\n          askUserQuestionManager.cancel(config.workspaceId, toolCallId, \"Interrupted\");\n        } catch {\n          // ignore\n        }\n        throw new Error(\"Interrupted\");\n      }\n\n      const abortPromise = new Promise<Record<string, string>>((_, reject) => {\n        abortSignal.addEventListener(\n          \"abort\",\n          () => {\n            try {\n              askUserQuestionManager.cancel(config.workspaceId!, toolCallId, \"Interrupted\");\n            } catch {\n              // ignore\n            }\n            reject(new Error(\"Interrupted\"));\n          },\n          { once: true }\n        );\n      });\n\n      const answers = await Promise.race([pendingPromise, abortPromise]);\n      assert(answers && typeof answers === \"object\", \"Expected answers to be an object\");\n\n      return {\n        summary: buildAskUserQuestionSummary(answers),\n        ui_only: {\n          ask_user_question: {\n            questions: args.questions,\n            answers,\n          },\n        },\n      };\n    },\n  });\n};\n"]}