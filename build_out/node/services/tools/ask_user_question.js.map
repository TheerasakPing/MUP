{"version":3,"file":"ask_user_question.js","sourceRoot":"","sources":["../../../../src/node/services/tools/ask_user_question.ts"],"names":[],"mappings":";;;;;;AAAA,gEAAwC;AAExC,2BAA0B;AAG1B,wFAA0F;AAE1F,0EAAwE;AACxE,mFAAgF;AAEzE,MAAM,yBAAyB,GAAgB,CAAC,MAAyB,EAAE,EAAE,CAAC;IACnF,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,iBAAiB,CAAC,WAAW;QAC3D,WAAW,EAAE,kCAAgB,CAAC,iBAAiB,CAAC,MAAM;QACtD,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,EAAE,WAAW,EAAE,UAAU,EAAE,EAAsC,EAAE,CAAC;YACxF,4FAA4F;YAC5F,4CAA4C;YAC5C,IAAI,IAAI,CAAC,OAAO,IAAI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACzD,OAAO;oBACL,OAAO,EAAE,IAAA,oDAA2B,EAAC,IAAI,CAAC,OAAO,CAAC;oBAClD,OAAO,EAAE;wBACP,iBAAiB,EAAE;4BACjB,SAAS,EAAE,IAAI,CAAC,SAAS;4BACzB,OAAO,EAAE,IAAI,CAAC,OAAO;yBACtB;qBACF;iBACF,CAAC;YACJ,CAAC;YAED,IAAA,gBAAM,EAAC,MAAM,CAAC,WAAW,EAAE,0CAA0C,CAAC,CAAC;YACvE,IAAA,gBAAM,EAAC,UAAU,EAAE,uCAAuC,CAAC,CAAC;YAE5D,MAAM,cAAc,GAAG,+CAAsB,CAAC,eAAe,CAC3D,MAAM,CAAC,WAAW,EAClB,UAAU,EACV,IAAI,CAAC,SAAS,CACf,CAAC;YAEF,IAAI,CAAC,WAAW,EAAE,CAAC;gBACjB,MAAM,OAAO,GAAG,MAAM,cAAc,CAAC;gBACrC,OAAO;oBACL,OAAO,EAAE,IAAA,oDAA2B,EAAC,OAAO,CAAC;oBAC7C,OAAO,EAAE;wBACP,iBAAiB,EAAE;4BACjB,SAAS,EAAE,IAAI,CAAC,SAAS;4BACzB,OAAO;yBACR;qBACF;iBACF,CAAC;YACJ,CAAC;YAED,IAAI,WAAW,CAAC,OAAO,EAAE,CAAC;gBACxB,+CAA+C;gBAC/C,IAAI,CAAC;oBACH,+CAAsB,CAAC,MAAM,CAAC,MAAM,CAAC,WAAW,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC;gBAC/E,CAAC;gBAAC,MAAM,CAAC;oBACP,SAAS;gBACX,CAAC;gBACD,MAAM,IAAI,KAAK,CAAC,aAAa,CAAC,CAAC;YACjC,CAAC;YAED,MAAM,YAAY,GAAG,IAAI,OAAO,CAAyB,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,CAAC;gBACtE,WAAW,CAAC,gBAAgB,CAC1B,OAAO,EACP,GAAG,EAAE,CAAC;oBACJ,IAAI,CAAC;wBACH,+CAAsB,CAAC,MAAM,CAAC,MAAM,CAAC,WAAY,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC;oBAChF,CAAC;oBAAC,MAAM,CAAC;wBACP,SAAS;oBACX,CAAC;oBACD,MAAM,CAAC,IAAI,KAAK,CAAC,aAAa,CAAC,CAAC,CAAC;gBAAA,CAClC,EACD,EAAE,IAAI,EAAE,IAAI,EAAE,CACf,CAAC;YAAA,CACH,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,IAAI,CAAC,CAAC,cAAc,EAAE,YAAY,CAAC,CAAC,CAAC;YACnE,IAAA,gBAAM,EAAC,OAAO,IAAI,OAAO,OAAO,KAAK,QAAQ,EAAE,kCAAkC,CAAC,CAAC;YAEnF,OAAO;gBACL,OAAO,EAAE,IAAA,oDAA2B,EAAC,OAAO,CAAC;gBAC7C,OAAO,EAAE;oBACP,iBAAiB,EAAE;wBACjB,SAAS,EAAE,IAAI,CAAC,SAAS;wBACzB,OAAO;qBACR;iBACF;aACF,CAAC;QAAA,CACH;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AAhFW,QAAA,yBAAyB,GAAzB,yBAAyB,CAgFpC","sourcesContent":["import assert from \"node:assert/strict\";\r\n\r\nimport { tool } from \"ai\";\r\n\r\nimport type { AskUserQuestionToolResult } from \"@/common/types/tools\";\r\nimport { buildAskUserQuestionSummary } from \"@/common/utils/tools/askUserQuestionSummary\";\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { askUserQuestionManager } from \"@/node/services/askUserQuestionManager\";\r\n\r\nexport const createAskUserQuestionTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.ask_user_question.description,\r\n    inputSchema: TOOL_DEFINITIONS.ask_user_question.schema,\r\n    execute: async (args, { abortSignal, toolCallId }): Promise<AskUserQuestionToolResult> => {\r\n      // Claude Code allows passing pre-filled answers directly. If provided, we can short-circuit\r\n      // and return immediately without prompting.\r\n      if (args.answers && Object.keys(args.answers).length > 0) {\r\n        return {\r\n          summary: buildAskUserQuestionSummary(args.answers),\r\n          ui_only: {\r\n            ask_user_question: {\r\n              questions: args.questions,\r\n              answers: args.answers,\r\n            },\r\n          },\r\n        };\r\n      }\r\n\r\n      assert(config.workspaceId, \"ask_user_question requires a workspaceId\");\r\n      assert(toolCallId, \"ask_user_question requires toolCallId\");\r\n\r\n      const pendingPromise = askUserQuestionManager.registerPending(\r\n        config.workspaceId,\r\n        toolCallId,\r\n        args.questions\r\n      );\r\n\r\n      if (!abortSignal) {\r\n        const answers = await pendingPromise;\r\n        return {\r\n          summary: buildAskUserQuestionSummary(answers),\r\n          ui_only: {\r\n            ask_user_question: {\r\n              questions: args.questions,\r\n              answers,\r\n            },\r\n          },\r\n        };\r\n      }\r\n\r\n      if (abortSignal.aborted) {\r\n        // Ensure we don't leak a pending prompt entry.\r\n        try {\r\n          askUserQuestionManager.cancel(config.workspaceId, toolCallId, \"Interrupted\");\r\n        } catch {\r\n          // ignore\r\n        }\r\n        throw new Error(\"Interrupted\");\r\n      }\r\n\r\n      const abortPromise = new Promise<Record<string, string>>((_, reject) => {\r\n        abortSignal.addEventListener(\r\n          \"abort\",\r\n          () => {\r\n            try {\r\n              askUserQuestionManager.cancel(config.workspaceId!, toolCallId, \"Interrupted\");\r\n            } catch {\r\n              // ignore\r\n            }\r\n            reject(new Error(\"Interrupted\"));\r\n          },\r\n          { once: true }\r\n        );\r\n      });\r\n\r\n      const answers = await Promise.race([pendingPromise, abortPromise]);\r\n      assert(answers && typeof answers === \"object\", \"Expected answers to be an object\");\r\n\r\n      return {\r\n        summary: buildAskUserQuestionSummary(answers),\r\n        ui_only: {\r\n          ask_user_question: {\r\n            questions: args.questions,\r\n            answers,\r\n          },\r\n        },\r\n      };\r\n    },\r\n  });\r\n};\r\n"]}