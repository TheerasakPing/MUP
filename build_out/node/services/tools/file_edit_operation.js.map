{"version":3,"file":"file_edit_operation.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_operation.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  FILE_EDIT_DIFF_OMITTED_MESSAGE,\n  type FileEditDiffSuccessBase,\n  type FileEditErrorResult,\n} from \"@/common/types/tools\";\nimport type { ToolConfiguration } from \"@/common/utils/tools/tools\";\nimport {\n  generateDiff,\n  validateFileSize,\n  validateAndCorrectPath,\n  validatePlanModeAccess,\n} from \"./fileCommon\";\nimport { RuntimeError } from \"@/node/runtime/Runtime\";\nimport { readFileString, writeFileString } from \"@/node/utils/runtime/helpers\";\n\ntype FileEditOperationResult<TMetadata> =\n  | {\n      success: true;\n      newContent: string;\n      metadata: TMetadata;\n    }\n  | {\n      success: false;\n      error: string;\n      note?: string; // Agent-only message (not displayed in UI)\n    };\n\ninterface ExecuteFileEditOperationOptions<TMetadata> {\n  config: ToolConfiguration;\n  filePath: string;\n  operation: (\n    originalContent: string\n  ) => FileEditOperationResult<TMetadata> | Promise<FileEditOperationResult<TMetadata>>;\n  abortSignal?: AbortSignal;\n}\n\n/**\n * Shared execution pipeline for file edit tools.\n * Handles validation, file IO, diff generation, and common error handling.\n */\nexport async function executeFileEditOperation<TMetadata>({\n  config,\n  filePath,\n  operation,\n  abortSignal,\n}: ExecuteFileEditOperationOptions<TMetadata>): Promise<\n  FileEditErrorResult | (FileEditDiffSuccessBase & TMetadata)\n> {\n  try {\n    // Validate and auto-correct redundant path prefix\n    const { correctedPath: validatedPath, warning: pathWarning } = validateAndCorrectPath(\n      filePath,\n      config.cwd,\n      config.runtime\n    );\n    filePath = validatedPath;\n\n    // Use runtime's normalizePath method to resolve paths correctly for both local and SSH runtimes\n    // This ensures path resolution uses runtime-specific semantics instead of Node.js path module\n    const resolvedPath = config.runtime.normalizePath(filePath, config.cwd);\n\n    // Validate plan mode access restrictions\n    const planModeError = await validatePlanModeAccess(filePath, config);\n    if (planModeError) {\n      return planModeError;\n    }\n\n    // Check if file exists and get stats using runtime\n    let fileStat;\n    try {\n      fileStat = await config.runtime.stat(resolvedPath, abortSignal);\n    } catch (err) {\n      if (err instanceof RuntimeError) {\n        return {\n          success: false,\n          error: err.message,\n        };\n      }\n      throw err;\n    }\n\n    if (fileStat.isDirectory) {\n      return {\n        success: false,\n        error: `Path is a directory, not a file: ${resolvedPath}`,\n      };\n    }\n\n    const sizeValidation = validateFileSize(fileStat);\n    if (sizeValidation) {\n      return {\n        success: false,\n        error: sizeValidation.error,\n      };\n    }\n\n    // Read file content using runtime helper\n    let originalContent: string;\n    try {\n      originalContent = await readFileString(config.runtime, resolvedPath, abortSignal);\n    } catch (err) {\n      if (err instanceof RuntimeError) {\n        return {\n          success: false,\n          error: err.message,\n        };\n      }\n      throw err;\n    }\n\n    const operationResult = await Promise.resolve(operation(originalContent));\n    if (!operationResult.success) {\n      return {\n        success: false,\n        error: operationResult.error,\n        note: operationResult.note, // Pass through agent-only message\n      };\n    }\n\n    // Write file using runtime helper\n    try {\n      await writeFileString(config.runtime, resolvedPath, operationResult.newContent, abortSignal);\n    } catch (err) {\n      if (err instanceof RuntimeError) {\n        return {\n          success: false,\n          error: err.message,\n        };\n      }\n      throw err;\n    }\n\n    // Record file state for post-compaction attachment tracking\n    if (config.recordFileState) {\n      try {\n        const newStat = await config.runtime.stat(resolvedPath, abortSignal);\n        config.recordFileState(resolvedPath, {\n          content: operationResult.newContent,\n          timestamp: newStat.modifiedTime.getTime(),\n        });\n      } catch {\n        // File stat failed, skip recording (shouldn't happen since we just wrote it)\n      }\n    }\n\n    const diff = generateDiff(resolvedPath, originalContent, operationResult.newContent);\n\n    return {\n      success: true,\n      diff: FILE_EDIT_DIFF_OMITTED_MESSAGE,\n      ui_only: {\n        file_edit: {\n          diff,\n        },\n      },\n      ...operationResult.metadata,\n      ...(pathWarning && { warning: pathWarning }),\n    };\n  } catch (error) {\n    if (error && typeof error === \"object\" && \"code\" in error) {\n      const nodeError = error as { code?: string };\n      if (nodeError.code === \"ENOENT\") {\n        return {\n          success: false,\n          error: `File not found: ${filePath}`,\n        };\n      }\n\n      if (nodeError.code === \"EACCES\") {\n        return {\n          success: false,\n          error: `Permission denied: ${filePath}`,\n        };\n      }\n    }\n\n    const message = error instanceof Error ? error.message : String(error);\n    return {\n      success: false,\n      error: `Failed to edit file: ${message}`,\n    };\n  }\n}\n"]}