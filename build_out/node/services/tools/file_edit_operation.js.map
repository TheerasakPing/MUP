{"version":3,"file":"file_edit_operation.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_operation.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  FILE_EDIT_DIFF_OMITTED_MESSAGE,\r\n  type FileEditDiffSuccessBase,\r\n  type FileEditErrorResult,\r\n} from \"@/common/types/tools\";\r\nimport type { ToolConfiguration } from \"@/common/utils/tools/tools\";\r\nimport {\r\n  generateDiff,\r\n  validateFileSize,\r\n  validateAndCorrectPath,\r\n  validatePlanModeAccess,\r\n} from \"./fileCommon\";\r\nimport { RuntimeError } from \"@/node/runtime/Runtime\";\r\nimport { readFileString, writeFileString } from \"@/node/utils/runtime/helpers\";\r\n\r\ntype FileEditOperationResult<TMetadata> =\r\n  | {\r\n      success: true;\r\n      newContent: string;\r\n      metadata: TMetadata;\r\n    }\r\n  | {\r\n      success: false;\r\n      error: string;\r\n      note?: string; // Agent-only message (not displayed in UI)\r\n    };\r\n\r\ninterface ExecuteFileEditOperationOptions<TMetadata> {\r\n  config: ToolConfiguration;\r\n  filePath: string;\r\n  operation: (\r\n    originalContent: string\r\n  ) => FileEditOperationResult<TMetadata> | Promise<FileEditOperationResult<TMetadata>>;\r\n  abortSignal?: AbortSignal;\r\n}\r\n\r\n/**\r\n * Shared execution pipeline for file edit tools.\r\n * Handles validation, file IO, diff generation, and common error handling.\r\n */\r\nexport async function executeFileEditOperation<TMetadata>({\r\n  config,\r\n  filePath,\r\n  operation,\r\n  abortSignal,\r\n}: ExecuteFileEditOperationOptions<TMetadata>): Promise<\r\n  FileEditErrorResult | (FileEditDiffSuccessBase & TMetadata)\r\n> {\r\n  try {\r\n    // Validate and auto-correct redundant path prefix\r\n    const { correctedPath: validatedPath, warning: pathWarning } = validateAndCorrectPath(\r\n      filePath,\r\n      config.cwd,\r\n      config.runtime\r\n    );\r\n    filePath = validatedPath;\r\n\r\n    // Use runtime's normalizePath method to resolve paths correctly for both local and SSH runtimes\r\n    // This ensures path resolution uses runtime-specific semantics instead of Node.js path module\r\n    const resolvedPath = config.runtime.normalizePath(filePath, config.cwd);\r\n\r\n    // Validate plan mode access restrictions\r\n    const planModeError = await validatePlanModeAccess(filePath, config);\r\n    if (planModeError) {\r\n      return planModeError;\r\n    }\r\n\r\n    // Check if file exists and get stats using runtime\r\n    let fileStat;\r\n    try {\r\n      fileStat = await config.runtime.stat(resolvedPath, abortSignal);\r\n    } catch (err) {\r\n      if (err instanceof RuntimeError) {\r\n        return {\r\n          success: false,\r\n          error: err.message,\r\n        };\r\n      }\r\n      throw err;\r\n    }\r\n\r\n    if (fileStat.isDirectory) {\r\n      return {\r\n        success: false,\r\n        error: `Path is a directory, not a file: ${resolvedPath}`,\r\n      };\r\n    }\r\n\r\n    const sizeValidation = validateFileSize(fileStat);\r\n    if (sizeValidation) {\r\n      return {\r\n        success: false,\r\n        error: sizeValidation.error,\r\n      };\r\n    }\r\n\r\n    // Read file content using runtime helper\r\n    let originalContent: string;\r\n    try {\r\n      originalContent = await readFileString(config.runtime, resolvedPath, abortSignal);\r\n    } catch (err) {\r\n      if (err instanceof RuntimeError) {\r\n        return {\r\n          success: false,\r\n          error: err.message,\r\n        };\r\n      }\r\n      throw err;\r\n    }\r\n\r\n    const operationResult = await Promise.resolve(operation(originalContent));\r\n    if (!operationResult.success) {\r\n      return {\r\n        success: false,\r\n        error: operationResult.error,\r\n        note: operationResult.note, // Pass through agent-only message\r\n      };\r\n    }\r\n\r\n    // Write file using runtime helper\r\n    try {\r\n      await writeFileString(config.runtime, resolvedPath, operationResult.newContent, abortSignal);\r\n    } catch (err) {\r\n      if (err instanceof RuntimeError) {\r\n        return {\r\n          success: false,\r\n          error: err.message,\r\n        };\r\n      }\r\n      throw err;\r\n    }\r\n\r\n    // Record file state for post-compaction attachment tracking\r\n    if (config.recordFileState) {\r\n      try {\r\n        const newStat = await config.runtime.stat(resolvedPath, abortSignal);\r\n        config.recordFileState(resolvedPath, {\r\n          content: operationResult.newContent,\r\n          timestamp: newStat.modifiedTime.getTime(),\r\n        });\r\n      } catch {\r\n        // File stat failed, skip recording (shouldn't happen since we just wrote it)\r\n      }\r\n    }\r\n\r\n    const diff = generateDiff(resolvedPath, originalContent, operationResult.newContent);\r\n\r\n    return {\r\n      success: true,\r\n      diff: FILE_EDIT_DIFF_OMITTED_MESSAGE,\r\n      ui_only: {\r\n        file_edit: {\r\n          diff,\r\n        },\r\n      },\r\n      ...operationResult.metadata,\r\n      ...(pathWarning && { warning: pathWarning }),\r\n    };\r\n  } catch (error) {\r\n    if (error && typeof error === \"object\" && \"code\" in error) {\r\n      const nodeError = error as { code?: string };\r\n      if (nodeError.code === \"ENOENT\") {\r\n        return {\r\n          success: false,\r\n          error: `File not found: ${filePath}`,\r\n        };\r\n      }\r\n\r\n      if (nodeError.code === \"EACCES\") {\r\n        return {\r\n          success: false,\r\n          error: `Permission denied: ${filePath}`,\r\n        };\r\n      }\r\n    }\r\n\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    return {\r\n      success: false,\r\n      error: `Failed to edit file: ${message}`,\r\n    };\r\n  }\r\n}\r\n"]}