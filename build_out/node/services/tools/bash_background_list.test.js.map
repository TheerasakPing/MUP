{"version":3,"file":"bash_background_list.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/bash_background_list.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, afterEach } from \"bun:test\";\nimport { createBashBackgroundListTool } from \"./bash_background_list\";\nimport { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\nimport type { Runtime } from \"@/node/runtime/Runtime\";\nimport type { BashBackgroundListResult } from \"@/common/types/tools\";\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\nimport type { ToolExecutionOptions } from \"ai\";\nimport * as fs from \"fs/promises\";\n\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\n// Create test runtime\nfunction createTestRuntime(): Runtime {\n  return new LocalRuntime(process.cwd());\n}\n\n// Workspace IDs used in tests - need cleanup after each test\nconst TEST_WORKSPACES = [\"test-workspace\", \"workspace-a\", \"workspace-b\"];\n\ndescribe(\"bash_background_list tool\", () => {\n  afterEach(async () => {\n    // Clean up output directories from /tmp/mux-bashes/ to prevent test pollution\n    for (const ws of TEST_WORKSPACES) {\n      await fs.rm(`/tmp/mux-bashes/${ws}`, { recursive: true, force: true }).catch(() => undefined);\n    }\n  });\n\n  it(\"should return error when manager not available\", async () => {\n    const tempDir = new TestTempDir(\"test-bash-bg-list\");\n    const config = createTestToolConfig(process.cwd());\n    config.runtimeTempDir = tempDir.path;\n\n    const tool = createBashBackgroundListTool(config);\n    const result = (await tool.execute!({}, mockToolCallOptions)) as BashBackgroundListResult;\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"Background process manager not available\");\n    }\n\n    tempDir[Symbol.dispose]();\n  });\n\n  it(\"should return error when workspaceId not available\", async () => {\n    const tempDir = new TestTempDir(\"test-bash-bg-list\");\n    const manager = new BackgroundProcessManager(tempDir.path);\n    const config = createTestToolConfig(process.cwd());\n    config.runtimeTempDir = tempDir.path;\n    config.backgroundProcessManager = manager;\n    delete config.workspaceId; // Explicitly remove workspaceId\n\n    const tool = createBashBackgroundListTool(config);\n    const result = (await tool.execute!({}, mockToolCallOptions)) as BashBackgroundListResult;\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"Workspace ID not available\");\n    }\n\n    tempDir[Symbol.dispose]();\n  });\n\n  it(\"should return empty list when no processes\", async () => {\n    const tempDir = new TestTempDir(\"test-bash-bg-list\");\n    const manager = new BackgroundProcessManager(tempDir.path);\n    const config = createTestToolConfig(process.cwd());\n    config.runtimeTempDir = tempDir.path;\n    config.backgroundProcessManager = manager;\n\n    const tool = createBashBackgroundListTool(config);\n    const result = (await tool.execute!({}, mockToolCallOptions)) as BashBackgroundListResult;\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.processes).toEqual([]);\n    }\n\n    tempDir[Symbol.dispose]();\n  });\n\n  it(\"should list spawned processes with correct fields\", async () => {\n    const tempDir = new TestTempDir(\"test-bash-bg-list\");\n    const manager = new BackgroundProcessManager(tempDir.path);\n    const runtime = createTestRuntime();\n    const config = createTestToolConfig(process.cwd(), { sessionsDir: tempDir.path });\n    config.runtimeTempDir = tempDir.path;\n    config.backgroundProcessManager = manager;\n\n    // Spawn a process\n    const spawnResult = await manager.spawn(runtime, \"test-workspace\", \"sleep 10\", {\n      cwd: process.cwd(),\n      displayName: \"test\",\n    });\n\n    if (!spawnResult.success) {\n      throw new Error(\"Failed to spawn process\");\n    }\n\n    const tool = createBashBackgroundListTool(config);\n    const result = (await tool.execute!({}, mockToolCallOptions)) as BashBackgroundListResult;\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.processes.length).toBe(1);\n      const proc = result.processes[0];\n      expect(proc.process_id).toBe(spawnResult.processId);\n      expect(proc.status).toBe(\"running\");\n      expect(proc.script).toBe(\"sleep 10\");\n      expect(proc.uptime_ms).toBeGreaterThanOrEqual(0);\n      expect(proc.exitCode).toBeUndefined();\n    }\n\n    // Cleanup\n    await manager.cleanup(\"test-workspace\");\n    tempDir[Symbol.dispose]();\n  });\n\n  it(\"should include display_name in listed processes\", async () => {\n    const tempDir = new TestTempDir(\"test-bash-bg-list\");\n    const manager = new BackgroundProcessManager(tempDir.path);\n    const runtime = createTestRuntime();\n    const config = createTestToolConfig(process.cwd(), { sessionsDir: tempDir.path });\n    config.runtimeTempDir = tempDir.path;\n    config.backgroundProcessManager = manager;\n\n    // Spawn a process with display_name\n    const spawnResult = await manager.spawn(runtime, \"test-workspace\", \"sleep 10\", {\n      cwd: process.cwd(),\n      displayName: \"Dev Server\",\n    });\n\n    if (!spawnResult.success) {\n      throw new Error(`Failed to spawn process: ${spawnResult.error}`);\n    }\n\n    const tool = createBashBackgroundListTool(config);\n    const result = (await tool.execute!({}, mockToolCallOptions)) as BashBackgroundListResult;\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.processes.length).toBe(1);\n      expect(result.processes[0].display_name).toBe(\"Dev Server\");\n    }\n\n    // Cleanup\n    await manager.cleanup(\"test-workspace\");\n    tempDir[Symbol.dispose]();\n  });\n\n  it(\"should only list processes for the current workspace\", async () => {\n    const tempDir = new TestTempDir(\"test-bash-bg-list\");\n    const manager = new BackgroundProcessManager(tempDir.path);\n    const runtime = createTestRuntime();\n\n    const config = createTestToolConfig(process.cwd(), {\n      workspaceId: \"workspace-a\",\n      sessionsDir: tempDir.path,\n    });\n    config.runtimeTempDir = tempDir.path;\n    config.backgroundProcessManager = manager;\n\n    // Spawn processes in different workspaces\n    const spawnA = await manager.spawn(runtime, \"workspace-a\", \"sleep 10\", {\n      cwd: process.cwd(),\n      displayName: \"test-a\",\n    });\n    const spawnB = await manager.spawn(runtime, \"workspace-b\", \"sleep 10\", {\n      cwd: process.cwd(),\n      displayName: \"test-b\",\n    });\n\n    if (!spawnA.success || !spawnB.success) {\n      throw new Error(\"Failed to spawn processes\");\n    }\n\n    const tool = createBashBackgroundListTool(config);\n    const result = (await tool.execute!({}, mockToolCallOptions)) as BashBackgroundListResult;\n\n    expect(result.success).toBe(true);\n    if (result.success) {\n      expect(result.processes.length).toBe(1);\n      expect(result.processes[0].process_id).toBe(spawnA.processId);\n    }\n\n    // Cleanup\n    await manager.cleanup(\"workspace-a\");\n    await manager.cleanup(\"workspace-b\");\n    tempDir[Symbol.dispose]();\n  });\n});\n"]}