{"version":3,"file":"task_await.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task_await.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs\";\r\n\r\nimport { describe, it, expect, mock } from \"bun:test\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\n\r\nimport { createTaskAwaitTool } from \"./task_await\";\r\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\r\nimport { getSubagentGitPatchArtifactsFilePath } from \"@/node/services/subagentGitPatchArtifacts\";\r\nimport type { TaskService } from \"@/node/services/taskService\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\ndescribe(\"task_await tool\", () => {\r\n  it(\"includes gitFormatPatch artifacts written during waitForAgentReport\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-artifacts\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const workspaceSessionDir = baseConfig.workspaceSessionDir;\r\n    if (!workspaceSessionDir) {\r\n      throw new Error(\"Expected workspaceSessionDir to be set in test tool config\");\r\n    }\r\n    const artifactsPath = getSubagentGitPatchArtifactsFilePath(workspaceSessionDir);\r\n\r\n    const gitFormatPatch = {\r\n      childTaskId: \"t1\",\r\n      parentWorkspaceId: \"parent-workspace\",\r\n      createdAtMs: 123,\r\n      status: \"pending\",\r\n    } as const;\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds: mock(() => []),\r\n      isDescendantAgentTask: mock(() => Promise.resolve(true)),\r\n      waitForAgentReport: mock(async (taskId: string) => {\r\n        await fs.promises.writeFile(\r\n          artifactsPath,\r\n          JSON.stringify(\r\n            {\r\n              version: 1,\r\n              artifactsByChildTaskId: { [taskId]: gitFormatPatch },\r\n            },\r\n            null,\r\n            2\r\n          ),\r\n          \"utf-8\"\r\n        );\r\n\r\n        return { reportMarkdown: \"ok\" };\r\n      }),\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"t1\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [\r\n        {\r\n          status: \"completed\",\r\n          taskId: \"t1\",\r\n          reportMarkdown: \"ok\",\r\n          title: undefined,\r\n          artifacts: { gitFormatPatch },\r\n        },\r\n      ],\r\n    });\r\n  });\r\n  it(\"returns completed results for all awaited tasks\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds: mock(() => [\"t1\", \"t2\"]),\r\n      isDescendantAgentTask: mock(() => Promise.resolve(true)),\r\n      waitForAgentReport: mock((taskId: string) =>\r\n        Promise.resolve({ reportMarkdown: `report:${taskId}`, title: `title:${taskId}` })\r\n      ),\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"t1\", \"t2\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [\r\n        { status: \"completed\", taskId: \"t1\", reportMarkdown: \"report:t1\", title: \"title:t1\" },\r\n        { status: \"completed\", taskId: \"t2\", reportMarkdown: \"report:t2\", title: \"title:t2\" },\r\n      ],\r\n    });\r\n  });\r\n\r\n  it(\"supports filterDescendantAgentTaskIds without losing this binding\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-this-binding\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ok\" }));\r\n    const isDescendantAgentTask = mock(() => Promise.resolve(true));\r\n\r\n    const taskService = {\r\n      filterDescendantAgentTaskIds: function (ancestorWorkspaceId: string, taskIds: string[]) {\r\n        expect(this).toBe(taskService);\r\n        expect(ancestorWorkspaceId).toBe(\"parent-workspace\");\r\n        expect(taskIds).toEqual([\"t1\"]);\r\n        return Promise.resolve(taskIds);\r\n      },\r\n      listActiveDescendantAgentTaskIds: mock(() => []),\r\n      isDescendantAgentTask,\r\n      waitForAgentReport,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"t1\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [{ status: \"completed\", taskId: \"t1\", reportMarkdown: \"ok\", title: undefined }],\r\n    });\r\n    expect(isDescendantAgentTask).toHaveBeenCalledTimes(0);\r\n    expect(waitForAgentReport).toHaveBeenCalledTimes(1);\r\n  });\r\n\r\n  it(\"marks invalid_scope without calling waitForAgentReport\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-invalid-scope\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const isDescendantAgentTask = mock((ancestorId: string, taskId: string) => {\r\n      expect(ancestorId).toBe(\"parent-workspace\");\r\n      return taskId !== \"other\";\r\n    });\r\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ok\" }));\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds: mock(() => []),\r\n      isDescendantAgentTask,\r\n      waitForAgentReport,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"child\", \"other\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [\r\n        { status: \"completed\", taskId: \"child\", reportMarkdown: \"ok\", title: undefined },\r\n        { status: \"invalid_scope\", taskId: \"other\" },\r\n      ],\r\n    });\r\n    expect(waitForAgentReport).toHaveBeenCalledTimes(1);\r\n    expect(waitForAgentReport).toHaveBeenCalledWith(\"child\", expect.any(Object));\r\n  });\r\n\r\n  it(\"defaults to waiting on all active descendant tasks when task_ids is omitted\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-descendants\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const listActiveDescendantAgentTaskIds = mock(() => [\"t1\"]);\r\n    const isDescendantAgentTask = mock(() => Promise.resolve(true));\r\n    const waitForAgentReport = mock(() => Promise.resolve({ reportMarkdown: \"ok\" }));\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds,\r\n      isDescendantAgentTask,\r\n      waitForAgentReport,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(tool.execute!({}, mockToolCallOptions));\r\n\r\n    expect(listActiveDescendantAgentTaskIds).toHaveBeenCalledWith(\"parent-workspace\");\r\n    expect(result).toEqual({\r\n      results: [{ status: \"completed\", taskId: \"t1\", reportMarkdown: \"ok\", title: undefined }],\r\n    });\r\n  });\r\n\r\n  it(\"maps wait errors to running/not_found/error statuses\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-errors\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const waitForAgentReport = mock((taskId: string) => {\r\n      if (taskId === \"timeout\") {\r\n        return Promise.reject(new Error(\"Timed out waiting for agent_report\"));\r\n      }\r\n      if (taskId === \"missing\") {\r\n        return Promise.reject(new Error(\"Task not found\"));\r\n      }\r\n      return Promise.reject(new Error(\"Boom\"));\r\n    });\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds: mock(() => []),\r\n      isDescendantAgentTask: mock(() => Promise.resolve(true)),\r\n      getAgentTaskStatus: mock((taskId: string) => (taskId === \"timeout\" ? \"running\" : null)),\r\n      waitForAgentReport,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ task_ids: [\"timeout\", \"missing\", \"boom\"] }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [\r\n        { status: \"running\", taskId: \"timeout\" },\r\n        { status: \"not_found\", taskId: \"missing\" },\r\n        { status: \"error\", taskId: \"boom\", error: \"Boom\" },\r\n      ],\r\n    });\r\n  });\r\n\r\n  it(\"treats timeout_secs=0 as non-blocking for agent tasks\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-timeout-zero\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const waitForAgentReport = mock(() => {\r\n      throw new Error(\"waitForAgentReport should not be called for timeout_secs=0\");\r\n    });\r\n    const getAgentTaskStatus = mock(() => \"running\" as const);\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds: mock(() => [\"t1\"]),\r\n      isDescendantAgentTask: mock(() => Promise.resolve(true)),\r\n      getAgentTaskStatus,\r\n      waitForAgentReport,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ timeout_secs: 0 }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({ results: [{ status: \"running\", taskId: \"t1\" }] });\r\n    expect(waitForAgentReport).toHaveBeenCalledTimes(0);\r\n    expect(getAgentTaskStatus).toHaveBeenCalledWith(\"t1\");\r\n  });\r\n\r\n  it(\"returns completed result when timeout_secs=0 and a cached report is available\", async () => {\r\n    using tempDir = new TestTempDir(\"test-task-await-tool-timeout-zero-cached\");\r\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"parent-workspace\" });\r\n\r\n    const getAgentTaskStatus = mock(() => null);\r\n    const waitForAgentReport = mock(() =>\r\n      Promise.resolve({ reportMarkdown: \"ok\", title: \"cached-title\" })\r\n    );\r\n\r\n    const taskService = {\r\n      listActiveDescendantAgentTaskIds: mock(() => [\"t1\"]),\r\n      isDescendantAgentTask: mock(() => Promise.resolve(true)),\r\n      getAgentTaskStatus,\r\n      waitForAgentReport,\r\n    } as unknown as TaskService;\r\n\r\n    const tool = createTaskAwaitTool({ ...baseConfig, taskService });\r\n\r\n    const result: unknown = await Promise.resolve(\r\n      tool.execute!({ timeout_secs: 0 }, mockToolCallOptions)\r\n    );\r\n\r\n    expect(result).toEqual({\r\n      results: [\r\n        {\r\n          status: \"completed\",\r\n          taskId: \"t1\",\r\n          reportMarkdown: \"ok\",\r\n          title: \"cached-title\",\r\n        },\r\n      ],\r\n    });\r\n    expect(getAgentTaskStatus).toHaveBeenCalledWith(\"t1\");\r\n    expect(waitForAgentReport).toHaveBeenCalledTimes(1);\r\n  });\r\n});\r\n"]}