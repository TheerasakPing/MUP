{"version":3,"file":"testHelpers.js","sourceRoot":"","sources":["../../../../src/node/services/tools/testHelpers.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAY,EAAE,+BAAW;AACzB,MAAY,IAAI,iCAAa;AAC7B,MAAY,EAAE,+BAAW;AACzB,8DAA2D;AAC3D,uEAAoE;AACpE,0CAAuC;AAEvC,6CAA0C;AAE1C;;;GAGG;AACH;IACkB,IAAI,CAAS;IAE7B,YAAY,MAAM,GAAG,WAAW,EAAE;QAChC,MAAM,EAAE,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE,CAAC;QACtE,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,GAAG,MAAM,IAAI,EAAE,EAAE,CAAC,CAAC;QACtD,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAAA,CAC9C;IAED,CAAC,MAAM,CAAC,OAAO,CAAC,GAAS;QACvB,IAAI,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC;YAC7B,IAAI,CAAC;gBACH,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;YACzD,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,SAAG,CAAC,IAAI,CAAC,mCAAmC,IAAI,CAAC,IAAI,GAAG,EAAE,KAAK,CAAC,CAAC;YACnE,CAAC;QACH,CAAC;IAAA,CACF;CACF;;AAED,mFAAmF;AACnF,IAAI,UAAU,GAAkB,IAAI,CAAC;AACrC,IAAI,oBAAoB,GAA4B,IAAI,CAAC;AAEzD,SAAS,aAAa,GAAW;IAC/B,UAAU,KAAV,UAAU,GAAK,IAAI,eAAM,EAAE,EAAC;IAC5B,OAAO,UAAU,CAAC;AAAA,CACnB;AAED,SAAS,uBAAuB,GAAqB;IACnD,oBAAoB,KAApB,oBAAoB,GAAK,IAAI,mCAAgB,CAAC,aAAa,EAAE,CAAC,EAAC;IAC/D,OAAO,oBAAoB,CAAC;AAAA,CAC7B;AAED;;;;GAIG;AACH,8BACE,OAAe,EACf,OAAwD,EACrC;IACnB,OAAO;QACL,GAAG,EAAE,OAAO;QACZ,mBAAmB,EAAE,OAAO,EAAE,WAAW,IAAI,OAAO;QACpD,OAAO,EAAE,IAAI,2BAAY,CAAC,OAAO,CAAC;QAClC,cAAc,EAAE,OAAO;QACvB,WAAW,EAAE,OAAO,EAAE,WAAW,IAAI,gBAAgB;KACtD,CAAC;AAAA,CACH;AAED;;;GAGG;AACH,uBAA8B;IAC5B,OAAO;QACL,WAAW,EAAE,gBAAyB;QACtC,gBAAgB,EAAE,uBAAuB,EAAE;KAC5C,CAAC;AAAA,CACH","sourcesContent":["import * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\r\nimport { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport { Config } from \"@/node/config\";\r\nimport type { ToolConfiguration } from \"@/common/utils/tools/tools\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\n/**\r\n * Disposable test temp directory that auto-cleans when disposed\r\n * Use with `using` statement for automatic cleanup in tests\r\n */\r\nexport class TestTempDir implements Disposable {\r\n  public readonly path: string;\r\n\r\n  constructor(prefix = \"test-tool\") {\r\n    const id = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n    this.path = path.join(os.tmpdir(), `${prefix}-${id}`);\r\n    fs.mkdirSync(this.path, { recursive: true });\r\n  }\r\n\r\n  [Symbol.dispose](): void {\r\n    if (fs.existsSync(this.path)) {\r\n      try {\r\n        fs.rmSync(this.path, { recursive: true, force: true });\r\n      } catch (error) {\r\n        log.warn(`Failed to cleanup test temp dir ${this.path}:`, error);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instances for test configuration (shared across all test tool configs)\r\nlet testConfig: Config | null = null;\r\nlet testInitStateManager: InitStateManager | null = null;\r\n\r\nfunction getTestConfig(): Config {\r\n  testConfig ??= new Config();\r\n  return testConfig;\r\n}\r\n\r\nfunction getTestInitStateManager(): InitStateManager {\r\n  testInitStateManager ??= new InitStateManager(getTestConfig());\r\n  return testInitStateManager;\r\n}\r\n\r\n/**\r\n * Create basic tool configuration for testing.\r\n * Returns a config object with default values that can be overridden.\r\n * Uses tempDir for both cwd and sessionsDir to isolate tests.\r\n */\r\nexport function createTestToolConfig(\r\n  tempDir: string,\r\n  options?: { workspaceId?: string; sessionsDir?: string }\r\n): ToolConfiguration {\r\n  return {\r\n    cwd: tempDir,\r\n    workspaceSessionDir: options?.sessionsDir ?? tempDir,\r\n    runtime: new LocalRuntime(tempDir),\r\n    runtimeTempDir: tempDir,\r\n    workspaceId: options?.workspaceId ?? \"test-workspace\",\r\n  };\r\n}\r\n\r\n/**\r\n * Get shared test config and initStateManager for inline tool configs in tests.\r\n * Use this when creating tool configs inline in tests.\r\n */\r\nexport function getTestDeps() {\r\n  return {\r\n    workspaceId: \"test-workspace\" as const,\r\n    initStateManager: getTestInitStateManager(),\r\n  };\r\n}\r\n"]}