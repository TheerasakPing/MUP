{"version":3,"file":"status_set.js","sourceRoot":"","sources":["../../../../src/node/services/tools/status_set.ts"],"names":[],"mappings":";;;AAAA,2BAA0B;AAE1B,0EAAwE;AACxE,8DAA0E;AAG1E;;;GAGG;AACH,SAAS,YAAY,CAAC,GAAW,EAAW;IAC1C,IAAI,CAAC,GAAG;QAAE,OAAO,KAAK,CAAC;IAEvB,2FAA2F;IAC3F,+FAA2F;IAC3F,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,UAAU,EAAE,CAAC,CAAC;IACxE,MAAM,QAAQ,GAAG,CAAC,GAAG,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC;IAE7C,uCAAuC;IACvC,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QAC1B,OAAO,KAAK,CAAC;IACf,CAAC;IAED,kDAAkD;IAClD,MAAM,UAAU,GAAG,qDAAqD,CAAC;IACzE,OAAO,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;AAAA,CAC7C;AAED;;GAEG;AACH,SAAS,eAAe,CAAC,OAAe,EAAE,SAAiB,EAAU;IACnE,IAAI,OAAO,CAAC,MAAM,IAAI,SAAS,EAAE,CAAC;QAChC,OAAO,OAAO,CAAC;IACjB,CAAC;IACD,+DAA+D;IAC/D,OAAO,OAAO,CAAC,KAAK,CAAC,CAAC,EAAE,SAAS,GAAG,CAAC,CAAC,GAAG,KAAG,CAAC;AAAA,CAC9C;AAED;;;;;;;;;;GAUG;AACI,MAAM,mBAAmB,GAAgB,GAAG,EAAE,CAAC;IACpD,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,UAAU,CAAC,WAAW;QACpD,WAAW,EAAE,kCAAgB,CAAC,UAAU,CAAC,MAAM;QAC/C,OAAO,EAAE,CAAC,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,EAAE,EAAgC,EAAE,CAAC;YAClE,iBAAiB;YACjB,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,EAAE,CAAC;gBACzB,OAAO,OAAO,CAAC,OAAO,CAAC;oBACrB,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,wCAAwC;iBAChD,CAAC,CAAC;YACL,CAAC;YAED,gCAAgC;YAChC,MAAM,gBAAgB,GAAG,eAAe,CAAC,OAAO,EAAE,sCAAyB,CAAC,CAAC;YAE7E,2CAA2C;YAC3C,oFAAoF;YACpF,OAAO,OAAO,CAAC,OAAO,CAAC;gBACrB,OAAO,EAAE,IAAI;gBACb,KAAK;gBACL,OAAO,EAAE,gBAAgB;gBACzB,GAAG,CAAC,GAAG,IAAI,EAAE,GAAG,EAAE,CAAC;aACpB,CAAC,CAAC;QAAA,CACJ;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AA1BW,QAAA,mBAAmB,GAAnB,mBAAmB,CA0B9B","sourcesContent":["import { tool } from \"ai\";\r\nimport type { ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { STATUS_MESSAGE_MAX_LENGTH } from \"@/common/constants/toolLimits\";\r\nimport type { StatusSetToolResult } from \"@/common/types/tools\";\r\n\r\n/**\r\n * Validates that a string is a single emoji character\r\n * Uses Intl.Segmenter to count grapheme clusters (handles variation selectors, skin tones, etc.)\r\n */\r\nfunction isValidEmoji(str: string): boolean {\r\n  if (!str) return false;\r\n\r\n  // Use Intl.Segmenter to count grapheme clusters (what users perceive as single characters)\r\n  // This properly handles emojis with variation selectors (like ✏️), skin tones, flags, etc.\r\n  const segmenter = new Intl.Segmenter(\"en\", { granularity: \"grapheme\" });\r\n  const segments = [...segmenter.segment(str)];\r\n\r\n  // Must be exactly one grapheme cluster\r\n  if (segments.length !== 1) {\r\n    return false;\r\n  }\r\n\r\n  // Check if it's an emoji using Unicode properties\r\n  const emojiRegex = /^[\\p{Emoji_Presentation}\\p{Extended_Pictographic}]/u;\r\n  return emojiRegex.test(segments[0].segment);\r\n}\r\n\r\n/**\r\n * Truncates a message to a maximum length, adding an ellipsis if truncated\r\n */\r\nfunction truncateMessage(message: string, maxLength: number): string {\r\n  if (message.length <= maxLength) {\r\n    return message;\r\n  }\r\n  // Truncate to maxLength-1 and add ellipsis (total = maxLength)\r\n  return message.slice(0, maxLength - 1) + \"…\";\r\n}\r\n\r\n/**\r\n * Status set tool factory for AI assistant\r\n * Creates a tool that allows the AI to set status indicator showing current activity\r\n *\r\n * The status is displayed IMMEDIATELY when this tool is called, even before other\r\n * tool calls complete. This prevents agents from prematurely declaring success\r\n * (e.g., \"PR checks passed\") when operations are still pending. Agents should only\r\n * set success status after confirming the outcome of long-running operations.\r\n *\r\n * @param config Required configuration (not used for this tool, but required by interface)\r\n */\r\nexport const createStatusSetTool: ToolFactory = () => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.status_set.description,\r\n    inputSchema: TOOL_DEFINITIONS.status_set.schema,\r\n    execute: ({ emoji, message, url }): Promise<StatusSetToolResult> => {\r\n      // Validate emoji\r\n      if (!isValidEmoji(emoji)) {\r\n        return Promise.resolve({\r\n          success: false,\r\n          error: \"emoji must be a single emoji character\",\r\n        });\r\n      }\r\n\r\n      // Truncate message if necessary\r\n      const truncatedMessage = truncateMessage(message, STATUS_MESSAGE_MAX_LENGTH);\r\n\r\n      // Tool execution is a no-op on the backend\r\n      // The status is tracked by StreamingMessageAggregator and displayed in the frontend\r\n      return Promise.resolve({\r\n        success: true,\r\n        emoji,\r\n        message: truncatedMessage,\r\n        ...(url && { url }),\r\n      });\r\n    },\r\n  });\r\n};\r\n"]}