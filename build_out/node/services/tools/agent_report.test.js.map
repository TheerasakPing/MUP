{"version":3,"file":"agent_report.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/agent_report.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAsD;AAGtD,iDAAuD;AACvD,+CAAkE;AAGlE,MAAM,mBAAmB,GAAyB;IAChD,UAAU,EAAE,cAAc;IAC1B,QAAQ,EAAE,EAAE;CACb,CAAC;AAEF,IAAA,mBAAQ,EAAC,mBAAmB,EAAE,GAAG,EAAE,CAAC;IAClC,IAAA,aAAE,EAAC,6CAA6C,EAAE,KAAK,IAAI,EAAE,CAAC;;;YAC5D,MAAM,OAAO,kCAAG,IAAI,yBAAW,CAAC,wBAAwB,CAAC,QAAA,CAAC;YAC1D,MAAM,UAAU,GAAG,IAAA,kCAAoB,EAAC,OAAO,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,gBAAgB,EAAE,CAAC,CAAC;YAEzF,MAAM,WAAW,GAAG;gBAClB,yCAAyC,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,IAAI,CAAC;aAClC,CAAC;YAE5B,MAAM,IAAI,GAAG,IAAA,oCAAqB,EAAC,EAAE,GAAG,UAAU,EAAE,WAAW,EAAE,CAAC,CAAC;YAEnE,IAAI,MAAM,GAAY,IAAI,CAAC;YAC3B,IAAI,CAAC;gBACH,MAAM,OAAO,CAAC,OAAO,CACnB,IAAI,CAAC,OAAQ,CAAC,EAAE,cAAc,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG,EAAE,EAAE,mBAAmB,CAAC,CAC3E,CAAC;YACJ,CAAC;YAAC,OAAO,KAAc,EAAE,CAAC;gBACxB,MAAM,GAAG,KAAK,CAAC;YACjB,CAAC;YAED,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;YACrC,IAAI,MAAM,YAAY,KAAK,EAAE,CAAC;gBAC5B,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,4BAA4B,CAAC,CAAC;YAC/D,CAAC;;;;;;;;;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,yDAAyD,EAAE,KAAK,IAAI,EAAE,CAAC;;;YACxE,MAAM,OAAO,kCAAG,IAAI,yBAAW,CAAC,2BAA2B,CAAC,QAAA,CAAC;YAC7D,MAAM,UAAU,GAAG,IAAA,kCAAoB,EAAC,OAAO,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,gBAAgB,EAAE,CAAC,CAAC;YAEzF,MAAM,WAAW,GAAG;gBAClB,yCAAyC,EAAE,IAAA,eAAI,EAAC,GAAG,EAAE,CAAC,KAAK,CAAC;aACnC,CAAC;YAE5B,MAAM,IAAI,GAAG,IAAA,oCAAqB,EAAC,EAAE,GAAG,UAAU,EAAE,WAAW,EAAE,CAAC,CAAC;YAEnE,MAAM,MAAM,GAAY,MAAM,OAAO,CAAC,OAAO,CAC3C,IAAI,CAAC,OAAQ,CAAC,EAAE,cAAc,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG,EAAE,EAAE,mBAAmB,CAAC,CAC3E,CAAC;YAEF,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;;;;;;;;;IAAA,CAC3C,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, it, expect, mock } from \"bun:test\";\nimport type { ToolExecutionOptions } from \"ai\";\n\nimport { createAgentReportTool } from \"./agent_report\";\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\nimport type { TaskService } from \"@/node/services/taskService\";\n\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\ndescribe(\"agent_report tool\", () => {\n  it(\"throws when the task has active descendants\", async () => {\n    using tempDir = new TestTempDir(\"test-agent-report-tool\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"task-workspace\" });\n\n    const taskService = {\n      hasActiveDescendantAgentTasksForWorkspace: mock(() => true),\n    } as unknown as TaskService;\n\n    const tool = createAgentReportTool({ ...baseConfig, taskService });\n\n    let caught: unknown = null;\n    try {\n      await Promise.resolve(\n        tool.execute!({ reportMarkdown: \"done\", title: \"t\" }, mockToolCallOptions)\n      );\n    } catch (error: unknown) {\n      caught = error;\n    }\n\n    expect(caught).toBeInstanceOf(Error);\n    if (caught instanceof Error) {\n      expect(caught.message).toMatch(/still has running\\/queued/i);\n    }\n  });\n\n  it(\"returns success when the task has no active descendants\", async () => {\n    using tempDir = new TestTempDir(\"test-agent-report-tool-ok\");\n    const baseConfig = createTestToolConfig(tempDir.path, { workspaceId: \"task-workspace\" });\n\n    const taskService = {\n      hasActiveDescendantAgentTasksForWorkspace: mock(() => false),\n    } as unknown as TaskService;\n\n    const tool = createAgentReportTool({ ...baseConfig, taskService });\n\n    const result: unknown = await Promise.resolve(\n      tool.execute!({ reportMarkdown: \"done\", title: \"t\" }, mockToolCallOptions)\n    );\n\n    expect(result).toEqual({ success: true });\n  });\n});\n"]}