{"version":3,"file":"task_terminate.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task_terminate.ts"],"names":[],"mappings":"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","sourcesContent":["import { tool } from \"ai\";\n\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\nimport {\n  TaskTerminateToolResultSchema,\n  TOOL_DEFINITIONS,\n} from \"@/common/utils/tools/toolDefinitions\";\n\nimport { fromBashTaskId } from \"./taskId\";\nimport {\n  dedupeStrings,\n  parseToolResult,\n  requireTaskService,\n  requireWorkspaceId,\n} from \"./toolUtils\";\n\nexport const createTaskTerminateTool: ToolFactory = (config: ToolConfiguration) => {\n  return tool({\n    description: TOOL_DEFINITIONS.task_terminate.description,\n    inputSchema: TOOL_DEFINITIONS.task_terminate.schema,\n    execute: async (args): Promise<unknown> => {\n      const workspaceId = requireWorkspaceId(config, \"task_terminate\");\n      const taskService = requireTaskService(config, \"task_terminate\");\n\n      const uniqueTaskIds = dedupeStrings(args.task_ids);\n\n      const results = await Promise.all(\n        uniqueTaskIds.map(async (taskId) => {\n          const maybeProcessId = fromBashTaskId(taskId);\n          if (taskId.startsWith(\"bash:\") && !maybeProcessId) {\n            return { status: \"error\" as const, taskId, error: \"Invalid bash taskId.\" };\n          }\n\n          if (maybeProcessId) {\n            if (!config.backgroundProcessManager) {\n              return {\n                status: \"error\" as const,\n                taskId,\n                error: \"Background process manager not available\",\n              };\n            }\n\n            const proc = await config.backgroundProcessManager.getProcess(maybeProcessId);\n            if (!proc) {\n              return { status: \"not_found\" as const, taskId };\n            }\n\n            const inScope =\n              proc.workspaceId === workspaceId ||\n              (await taskService.isDescendantAgentTask(workspaceId, proc.workspaceId));\n            if (!inScope) {\n              return { status: \"invalid_scope\" as const, taskId };\n            }\n\n            const terminateResult = await config.backgroundProcessManager.terminate(maybeProcessId);\n            if (!terminateResult.success) {\n              return { status: \"error\" as const, taskId, error: terminateResult.error };\n            }\n\n            return {\n              status: \"terminated\" as const,\n              taskId,\n              terminatedTaskIds: [taskId],\n            };\n          }\n\n          const terminateResult = await taskService.terminateDescendantAgentTask(\n            workspaceId,\n            taskId\n          );\n          if (!terminateResult.success) {\n            const msg = terminateResult.error;\n            if (/not found/i.test(msg)) {\n              return { status: \"not_found\" as const, taskId };\n            }\n            if (/descendant/i.test(msg) || /scope/i.test(msg)) {\n              return { status: \"invalid_scope\" as const, taskId };\n            }\n            return { status: \"error\" as const, taskId, error: msg };\n          }\n\n          return {\n            status: \"terminated\" as const,\n            taskId,\n            terminatedTaskIds: terminateResult.data.terminatedTaskIds,\n          };\n        })\n      );\n\n      return parseToolResult(TaskTerminateToolResultSchema, { results }, \"task_terminate\");\n    },\n  });\n};\n"]}