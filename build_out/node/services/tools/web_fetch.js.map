{"version":3,"file":"web_fetch.js","sourceRoot":"","sources":["../../../../src/node/services/tools/web_fetch.ts"],"names":[],"mappings":"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","sourcesContent":["import { tool } from \"ai\";\r\nimport { JSDOM } from \"jsdom\";\r\nimport { Readability } from \"@mozilla/readability\";\r\nimport TurndownService from \"turndown\";\r\nimport type { WebFetchToolResult } from \"@/common/types/tools\";\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport {\r\n  WEB_FETCH_TIMEOUT_SECS,\r\n  WEB_FETCH_MAX_OUTPUT_BYTES,\r\n  WEB_FETCH_MAX_HTML_BYTES,\r\n} from \"@/common/constants/toolLimits\";\r\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\r\nimport {\r\n  downloadFromMuxMd,\r\n  getMuxMdAllowedHosts,\r\n  isMuxMdUrl,\r\n  parseMuxMdUrl,\r\n} from \"@/common/lib/muxMd\";\r\n\r\nconst USER_AGENT = \"Mux/1.0 (https://github.com/coder/mux; web-fetch tool)\";\r\n\r\n/** Parse curl -i output into headers and body */\r\nfunction parseResponse(output: string): { headers: string; body: string; statusCode: string } {\r\n  // Find the last HTTP status line (after redirects) and its headers\r\n  // curl -i with -L shows all redirect responses, we want the final one\r\n  const httpMatches = [...output.matchAll(/HTTP\\/[\\d.]+ (\\d{3})[^\\r\\n]*/g)];\r\n  const lastStatusMatch = httpMatches.length > 0 ? httpMatches[httpMatches.length - 1] : null;\r\n  const statusCode = lastStatusMatch ? lastStatusMatch[1] : \"\";\r\n\r\n  // Headers end with \\r\\n\\r\\n (or \\n\\n for some servers)\r\n  const headerEndIndex = output.indexOf(\"\\r\\n\\r\\n\");\r\n  const altHeaderEndIndex = output.indexOf(\"\\n\\n\");\r\n  const splitIndex =\r\n    headerEndIndex !== -1\r\n      ? headerEndIndex + 4\r\n      : altHeaderEndIndex !== -1\r\n        ? altHeaderEndIndex + 2\r\n        : 0;\r\n\r\n  const headers = splitIndex > 0 ? output.slice(0, splitIndex).toLowerCase() : \"\";\r\n  const body = splitIndex > 0 ? output.slice(splitIndex) : output;\r\n\r\n  return { headers, body, statusCode };\r\n}\r\n\r\n/** Detect if error response is a Cloudflare challenge page */\r\nfunction isCloudflareChallenge(headers: string, body: string): boolean {\r\n  return (\r\n    headers.includes(\"cf-mitigated\") ||\r\n    (body.includes(\"Just a moment\") && body.includes(\"Enable JavaScript\"))\r\n  );\r\n}\r\n\r\n/** Try to extract readable content from HTML, returns null on failure */\r\nfunction tryExtractContent(\r\n  body: string,\r\n  url: string,\r\n  maxBytes: number\r\n): { title: string; content: string } | null {\r\n  try {\r\n    const dom = new JSDOM(body, { url });\r\n    const reader = new Readability(dom.window.document);\r\n    const article = reader.parse();\r\n    if (!article?.content) return null;\r\n\r\n    const turndown = new TurndownService({\r\n      headingStyle: \"atx\",\r\n      codeBlockStyle: \"fenced\",\r\n    });\r\n    let content = turndown.turndown(article.content);\r\n    if (content.length > maxBytes) {\r\n      content = content.slice(0, maxBytes) + \"\\n\\n[Content truncated]\";\r\n    }\r\n    return { title: article.title ?? \"Untitled\", content };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction isAllowedMuxMdHost(url: string): boolean {\r\n  try {\r\n    return getMuxMdAllowedHosts().includes(new URL(url).host);\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Web fetch tool factory for AI assistant\r\n * Creates a tool that fetches web pages and extracts readable content as markdown\r\n * Uses curl via Runtime to respect workspace network context\r\n * @param config Required configuration including runtime\r\n */\r\nexport const createWebFetchTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.web_fetch.description,\r\n    inputSchema: TOOL_DEFINITIONS.web_fetch.schema,\r\n    execute: async ({ url }, { abortSignal }): Promise<WebFetchToolResult> => {\r\n      try {\r\n        // Handle mux.md share links with client-side decryption.\r\n        // Important: `parseMuxMdUrl` does not validate the host, so we must guard with `isMuxMdUrl`\r\n        // to avoid treating arbitrary URLs (including those with `#fragment`) as share links.\r\n        if (isMuxMdUrl(url)) {\r\n          const muxMdParsed = parseMuxMdUrl(url);\r\n          if (!muxMdParsed) {\r\n            return { success: false, error: \"Invalid mux.md URL format\" };\r\n          }\r\n\r\n          const baseUrl = new URL(url).origin;\r\n\r\n          try {\r\n            const result = await downloadFromMuxMd(muxMdParsed.id, muxMdParsed.key, abortSignal, {\r\n              baseUrl,\r\n            });\r\n            let content = result.content;\r\n            if (content.length > WEB_FETCH_MAX_OUTPUT_BYTES) {\r\n              content = content.slice(0, WEB_FETCH_MAX_OUTPUT_BYTES) + \"\\n\\n[Content truncated]\";\r\n            }\r\n            return {\r\n              success: true,\r\n              title: result.fileInfo?.name ?? \"Shared Message\",\r\n              content,\r\n              url,\r\n              length: content.length,\r\n            };\r\n          } catch (err) {\r\n            return {\r\n              success: false,\r\n              error: err instanceof Error ? err.message : \"Failed to download from mux.md\",\r\n            };\r\n          }\r\n        }\r\n\r\n        if (isAllowedMuxMdHost(url)) {\r\n          return { success: false, error: \"Invalid mux.md URL format\" };\r\n        }\r\n\r\n        // Build curl command with safe defaults\r\n        // Use shell quoting helper to escape values safely\r\n        const shellQuote = (s: string) => `'${s.replace(/'/g, \"'\\\\''\")}'`;\r\n\r\n        const curlCommand = [\r\n          \"curl\",\r\n          \"-sS\", // Silent but show errors\r\n          \"-L\", // Follow redirects\r\n          \"-i\", // Include headers in output\r\n          \"--fail-with-body\", // Return exit code 22 for HTTP 4xx/5xx but still output body\r\n          \"--max-time\",\r\n          String(WEB_FETCH_TIMEOUT_SECS),\r\n          \"--max-filesize\",\r\n          String(WEB_FETCH_MAX_HTML_BYTES),\r\n          \"-A\",\r\n          shellQuote(USER_AGENT),\r\n          \"--compressed\", // Accept gzip/deflate\r\n          \"-H\",\r\n          shellQuote(\r\n            \"Accept: text/markdown, text/x-markdown, text/plain, text/html, application/xhtml+xml\"\r\n          ),\r\n          shellQuote(url),\r\n        ].join(\" \");\r\n\r\n        // Execute via Runtime (respects workspace network context)\r\n        const result = await execBuffered(config.runtime, curlCommand, {\r\n          cwd: config.cwd,\r\n          abortSignal,\r\n          timeout: WEB_FETCH_TIMEOUT_SECS + 5, // Slightly longer than curl's timeout (seconds)\r\n        });\r\n\r\n        if (result.exitCode !== 0) {\r\n          // curl exit codes: https://curl.se/docs/manpage.html\r\n          const exitCodeMessages: Record<number, string> = {\r\n            6: \"Could not resolve host\",\r\n            7: \"Failed to connect\",\r\n            28: \"Operation timed out\",\r\n            35: \"SSL/TLS handshake failed\",\r\n            56: \"Network data receive error\",\r\n            63: \"Maximum file size exceeded\",\r\n          };\r\n\r\n          // For HTTP errors (exit 22), try to parse and include the error body\r\n          if (result.exitCode === 22 && result.stdout) {\r\n            const { headers, body, statusCode } = parseResponse(result.stdout);\r\n            const statusText = statusCode ? `HTTP ${statusCode}` : \"HTTP error\";\r\n\r\n            // Detect Cloudflare challenge pages\r\n            if (isCloudflareChallenge(headers, body)) {\r\n              return {\r\n                success: false,\r\n                error: `${statusText}: Cloudflare security challenge (page requires JavaScript)`,\r\n              };\r\n            }\r\n\r\n            // Try to extract readable content from error page\r\n            const extracted = tryExtractContent(body, url, WEB_FETCH_MAX_OUTPUT_BYTES);\r\n            if (extracted) {\r\n              return {\r\n                success: false,\r\n                error: statusText,\r\n                content: extracted.content,\r\n              };\r\n            }\r\n\r\n            return {\r\n              success: false,\r\n              error: statusText,\r\n            };\r\n          }\r\n\r\n          const reason = exitCodeMessages[result.exitCode] || result.stderr || \"Unknown error\";\r\n          return {\r\n            success: false,\r\n            error: `Failed to fetch URL: ${reason}`,\r\n          };\r\n        }\r\n\r\n        // Parse headers and body from curl -i output\r\n        const { headers, body } = parseResponse(result.stdout);\r\n\r\n        if (!body || body.trim().length === 0) {\r\n          return {\r\n            success: false,\r\n            error: \"Empty response from URL\",\r\n          };\r\n        }\r\n\r\n        // Check content-type to determine processing strategy\r\n        const contentTypeMatch = /content-type:\\s*([^\\r\\n;]+)/.exec(headers);\r\n        const contentType = contentTypeMatch ? contentTypeMatch[1].trim() : \"\";\r\n        const isPlainText =\r\n          contentType.includes(\"text/plain\") ||\r\n          contentType.includes(\"text/markdown\") ||\r\n          contentType.includes(\"text/x-markdown\");\r\n\r\n        // For plain text/markdown, return as-is without HTML processing\r\n        if (isPlainText) {\r\n          let content = body;\r\n          if (content.length > WEB_FETCH_MAX_OUTPUT_BYTES) {\r\n            content = content.slice(0, WEB_FETCH_MAX_OUTPUT_BYTES) + \"\\n\\n[Content truncated]\";\r\n          }\r\n          return {\r\n            success: true,\r\n            title: url,\r\n            content,\r\n            url,\r\n            length: content.length,\r\n          };\r\n        }\r\n\r\n        // Parse HTML with JSDOM (runs locally in Mux, not over SSH)\r\n        const dom = new JSDOM(body, { url });\r\n\r\n        // Extract article with Readability\r\n        const reader = new Readability(dom.window.document);\r\n        const article = reader.parse();\r\n\r\n        if (!article) {\r\n          return {\r\n            success: false,\r\n            error: \"Could not extract readable content from page\",\r\n          };\r\n        }\r\n\r\n        // Convert to markdown\r\n        const turndown = new TurndownService({\r\n          headingStyle: \"atx\",\r\n          codeBlockStyle: \"fenced\",\r\n        });\r\n        let content = turndown.turndown(article.content ?? \"\");\r\n\r\n        // Truncate if needed\r\n        if (content.length > WEB_FETCH_MAX_OUTPUT_BYTES) {\r\n          content = content.slice(0, WEB_FETCH_MAX_OUTPUT_BYTES) + \"\\n\\n[Content truncated]\";\r\n        }\r\n\r\n        return {\r\n          success: true,\r\n          title: article.title ?? \"Untitled\",\r\n          content,\r\n          url,\r\n          byline: article.byline ?? undefined,\r\n          length: content.length,\r\n        };\r\n      } catch (error) {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        return {\r\n          success: false,\r\n          error: `web_fetch error: ${message}`,\r\n        };\r\n      }\r\n    },\r\n  });\r\n};\r\n"]}