{"version":3,"file":"bash.js","sourceRoot":"","sources":["../../../../src/node/services/tools/bash.ts"],"names":[],"mappings":"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","sourcesContent":["import { tool } from \"ai\";\n// NOTE: We avoid readline; consume Web Streams directly to prevent race conditions\nimport * as path from \"path\";\nimport {\n  BASH_DEFAULT_TIMEOUT_SECS,\n  BASH_HARD_MAX_LINES,\n  BASH_MAX_LINE_BYTES,\n  BASH_MAX_TOTAL_BYTES,\n  BASH_MAX_FILE_BYTES,\n  BASH_TRUNCATE_MAX_TOTAL_BYTES,\n  BASH_TRUNCATE_MAX_FILE_BYTES,\n} from \"@/common/constants/toolLimits\";\nimport { NON_INTERACTIVE_ENV_VARS } from \"@/common/constants/env\";\nimport { EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT } from \"@/common/constants/exitCodes\";\n\nimport type { BashOutputEvent } from \"@/common/types/stream\";\nimport type { BashToolResult } from \"@/common/types/tools\";\nimport { resolveBashDisplayName } from \"@/common/utils/tools/bashDisplayName\";\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\nimport { toBashTaskId } from \"./taskId\";\nimport { migrateToBackground } from \"@/node/services/backgroundProcessExecutor\";\nimport { LocalBaseRuntime } from \"@/node/runtime/LocalBaseRuntime\";\nimport { getToolEnvPath } from \"@/node/services/hooks\";\n\nconst CAT_FILE_READ_NOTICE =\n  \"[IMPORTANT]\\n\\nDO NOT use `cat`, `rg`, or `grep` to read files. Use the `file_read` tool instead (supports offset/limit paging). Bash output may be truncated or auto-filtered, which can hide parts of the file.\";\n\nfunction prependToolNote(existing: string | undefined, extra: string): string {\n  if (!existing) {\n    return extra;\n  }\n\n  return `${extra}\\n\\n${existing}`;\n}\n\nfunction isCatToken(token: string): boolean {\n  const normalized = token.trim().startsWith(\"\\\\\") ? token.trim().slice(1) : token.trim();\n  return normalized === \"cat\";\n}\n\nfunction getCatCommandTokenIndex(tokens: string[]): number | null {\n  if (tokens.length === 0) {\n    return null;\n  }\n\n  if (isCatToken(tokens[0])) {\n    return 0;\n  }\n\n  if (tokens[0] === \"command\" && tokens[1] && isCatToken(tokens[1])) {\n    return 1;\n  }\n\n  // Handle common patterns like: sudo cat file, sudo -n cat file, sudo -u user cat file\n  if (tokens[0] === \"sudo\") {\n    for (let i = 1; i < tokens.length && i < 8; i++) {\n      if (isCatToken(tokens[i])) {\n        return i;\n      }\n    }\n  }\n\n  return null;\n}\n\nfunction detectCatFileRead(script: string): boolean {\n  // Fast-path: avoid doing any work if \"cat\" doesn't appear at all.\n  if (!script.includes(\"cat\")) {\n    return false;\n  }\n\n  // Split on common statement separators and pipelines.\n  // Note: this is intentionally not a full shell parser; we aim to catch the common\n  // \"cat <path>\" pattern without false positives like \"echo foo | cat\".\n  const segments = script.split(/\\n|&&|\\|\\||;|\\|/);\n\n  for (const segment of segments) {\n    const tokens = segment.trim().split(/\\s+/).filter(Boolean);\n    const catIndex = getCatCommandTokenIndex(tokens);\n    if (catIndex === null) continue;\n\n    const args = tokens.slice(catIndex + 1);\n    if (args.length === 0) continue; // \"cat\" (stdin passthrough)\n\n    // Ignore heredocs / here-strings (not a file read).\n    if (args.some((t) => t.startsWith(\"<<\") || t.startsWith(\"<<<\"))) {\n      continue;\n    }\n\n    let expectInputFile = false;\n    let skipNextOutputTarget = false;\n\n    for (const token of args) {\n      if (expectInputFile) {\n        expectInputFile = false;\n        if (token !== \"-\" && token.length > 0) {\n          return true;\n        }\n        continue;\n      }\n\n      if (skipNextOutputTarget) {\n        skipNextOutputTarget = false;\n        continue;\n      }\n\n      // Input redirection: cat < file OR cat <file\n      if (token === \"<\" || token === \"0<\") {\n        expectInputFile = true;\n        continue;\n      }\n      const inputMatch = /^(?:0)?<(.+)$/.exec(token);\n      if (inputMatch && !token.startsWith(\"<<\") && !token.startsWith(\"<<<\")) {\n        const inputFile = inputMatch[1];\n        if (inputFile !== \"-\" && inputFile.length > 0) {\n          return true;\n        }\n        continue;\n      }\n\n      // Output redirection: ignore output targets (doesn't indicate reading a file).\n      if (\n        token === \">\" ||\n        token === \">>\" ||\n        token === \"1>\" ||\n        token === \"1>>\" ||\n        token === \"2>\" ||\n        token === \"2>>\" ||\n        token === \"&>\" ||\n        token === \"&>>\"\n      ) {\n        skipNextOutputTarget = true;\n        continue;\n      }\n\n      // Output redirection with attached target (e.g. \">out\", \"2>/dev/null\", \"2>&1\")\n      if (/^(?:\\d+|&)?>>?/.test(token)) {\n        continue;\n      }\n\n      // Flags and stdin\n      if (token === \"-\" || token.startsWith(\"-\")) {\n        continue;\n      }\n\n      // Remaining non-flag tokens look like file operands (e.g. \"cat file\").\n      return true;\n    }\n  }\n\n  return false;\n}\n\ntype SearchCommand = \"rg\" | \"grep\";\n\nfunction stripOuterQuotes(token: string): string {\n  const trimmed = token.trim();\n  if (trimmed.length < 2) {\n    return trimmed;\n  }\n\n  const first = trimmed[0];\n  const last = trimmed[trimmed.length - 1];\n  if ((first === \"'\" && last === \"'\") || (first === '\"' && last === '\"')) {\n    return trimmed.slice(1, -1);\n  }\n\n  return trimmed;\n}\n\nfunction isMatchAllSearchPattern(pattern: string): boolean {\n  // Intentionally narrow: we only want to warn on obvious whole-file dump patterns\n  // (avoid warning on normal search).\n  const normalized = pattern.trim();\n  return normalized === \"\" || normalized === \"^\" || normalized === \".*\";\n}\n\nfunction isRipgrepToken(token: string): boolean {\n  const trimmed = token.trim();\n  const normalized = trimmed.startsWith(\"\\\\\") ? trimmed.slice(1) : trimmed;\n  return normalized === \"rg\";\n}\n\nfunction isGrepToken(token: string): boolean {\n  const trimmed = token.trim();\n  const normalized = trimmed.startsWith(\"\\\\\") ? trimmed.slice(1) : trimmed;\n  return normalized === \"grep\";\n}\n\nfunction getRipgrepCommandTokenIndex(tokens: string[]): number | null {\n  if (tokens.length === 0) {\n    return null;\n  }\n\n  if (isRipgrepToken(tokens[0])) {\n    return 0;\n  }\n\n  if (tokens[0] === \"command\" && tokens[1] && isRipgrepToken(tokens[1])) {\n    return 1;\n  }\n\n  // Handle common patterns like: sudo rg file, sudo -n rg file, sudo -u user rg file\n  if (tokens[0] === \"sudo\") {\n    for (let i = 1; i < tokens.length && i < 8; i++) {\n      if (isRipgrepToken(tokens[i])) {\n        return i;\n      }\n    }\n  }\n\n  return null;\n}\n\nfunction getGrepCommandTokenIndex(tokens: string[]): number | null {\n  if (tokens.length === 0) {\n    return null;\n  }\n\n  if (isGrepToken(tokens[0])) {\n    return 0;\n  }\n\n  if (tokens[0] === \"command\" && tokens[1] && isGrepToken(tokens[1])) {\n    return 1;\n  }\n\n  // Handle common patterns like: sudo grep file, sudo -n grep file, sudo -u user grep file\n  if (tokens[0] === \"sudo\") {\n    for (let i = 1; i < tokens.length && i < 8; i++) {\n      if (isGrepToken(tokens[i])) {\n        return i;\n      }\n    }\n  }\n\n  return null;\n}\n\nfunction parseSearchCommandArgs(\n  command: SearchCommand,\n  args: string[]\n): { pattern: string | null; tokensAfterPattern: string[] } {\n  let pattern: string | null = null;\n  const tokensAfterPattern: string[] = [];\n  let afterDoubleDash = false;\n\n  const rgConsumesNextArg = new Set([\n    \"-g\",\n    \"--glob\",\n    \"--iglob\",\n    \"-t\",\n    \"--type\",\n    \"--type-add\",\n    \"--type-clear\",\n  ]);\n  const grepConsumesNextArg = new Set([\n    \"-f\",\n    \"--file\",\n    \"--include\",\n    \"--exclude\",\n    \"--exclude-dir\",\n    \"-m\",\n    \"--max-count\",\n    \"-A\",\n    \"-B\",\n    \"-C\",\n  ]);\n\n  for (let i = 0; i < args.length; i++) {\n    const token = args[i];\n\n    if (token === \"--\") {\n      afterDoubleDash = true;\n      continue;\n    }\n\n    if (pattern === null) {\n      const isFlag = !afterDoubleDash && token.startsWith(\"-\");\n      if (isFlag) {\n        const patternFlagInline =\n          command === \"rg\" && token.startsWith(\"--regexp=\")\n            ? token.slice(\"--regexp=\".length)\n            : command === \"grep\" && token.startsWith(\"--regexp=\")\n              ? token.slice(\"--regexp=\".length)\n              : null;\n\n        if (patternFlagInline !== null) {\n          pattern = patternFlagInline;\n          continue;\n        }\n\n        const isExplicitPatternFlag =\n          (command === \"rg\" && (token === \"-e\" || token === \"--regexp\")) ||\n          (command === \"grep\" && token === \"-e\");\n\n        if (isExplicitPatternFlag) {\n          const nextToken = args[i + 1];\n          if (nextToken !== undefined) {\n            pattern = nextToken;\n            i++;\n          }\n          continue;\n        }\n\n        // Support the compact form: -ePATTERN\n        if (token.startsWith(\"-e\") && token.length > 2) {\n          pattern = token.slice(2);\n          continue;\n        }\n\n        const consumesNextArg =\n          (command === \"rg\" && rgConsumesNextArg.has(token)) ||\n          (command === \"grep\" && grepConsumesNextArg.has(token));\n        if (consumesNextArg) {\n          i++; // skip the flag value\n          continue;\n        }\n\n        continue; // other flags\n      }\n\n      pattern = token;\n      continue;\n    }\n\n    tokensAfterPattern.push(token);\n  }\n\n  return { pattern, tokensAfterPattern };\n}\n\nfunction hasFileReadTargetToken(tokensAfterPattern: string[]): boolean {\n  let expectInputFile = false;\n  let skipNextOutputTarget = false;\n\n  for (const token of tokensAfterPattern) {\n    if (expectInputFile) {\n      expectInputFile = false;\n      if (token !== \"-\" && token.length > 0) {\n        return true;\n      }\n      continue;\n    }\n\n    if (skipNextOutputTarget) {\n      skipNextOutputTarget = false;\n      continue;\n    }\n\n    // Input redirection: ... < file OR ... <file\n    if (token === \"<\" || token === \"0<\") {\n      expectInputFile = true;\n      continue;\n    }\n    const inputMatch = /^(?:0)?<(.+)$/.exec(token);\n    if (inputMatch && !token.startsWith(\"<<\") && !token.startsWith(\"<<<\")) {\n      const inputFile = inputMatch[1];\n      if (inputFile !== \"-\" && inputFile.length > 0) {\n        return true;\n      }\n      continue;\n    }\n\n    // Output redirection: ignore output targets.\n    if (\n      token === \">\" ||\n      token === \">>\" ||\n      token === \"1>\" ||\n      token === \"1>>\" ||\n      token === \"2>\" ||\n      token === \"2>>\" ||\n      token === \"&>\" ||\n      token === \"&>>\"\n    ) {\n      skipNextOutputTarget = true;\n      continue;\n    }\n\n    // Output redirection with attached target (e.g. \">out\", \"2>/dev/null\", \"2>&1\")\n    if (/^(?:\\d+|&)?>>?/.test(token)) {\n      continue;\n    }\n\n    // Flags and stdin\n    if (token === \"-\" || token === \"--\" || token.startsWith(\"-\")) {\n      continue;\n    }\n\n    // Remaining non-flag tokens look like file/path operands.\n    return true;\n  }\n\n  return false;\n}\n\nfunction detectRipgrepFileDump(script: string): boolean {\n  // Fast-path: avoid doing any work if \"rg\" doesn't appear at all.\n  if (!script.includes(\"rg\")) {\n    return false;\n  }\n\n  const segments = script.split(/\\n|&&|\\|\\||;|\\|/);\n  for (const segment of segments) {\n    const tokens = segment.trim().split(/\\s+/).filter(Boolean);\n    const rgIndex = getRipgrepCommandTokenIndex(tokens);\n    if (rgIndex === null) continue;\n\n    const args = tokens.slice(rgIndex + 1);\n    if (args.length === 0) continue;\n\n    // Ignore heredocs / here-strings (not a file read).\n    if (args.some((t) => t.startsWith(\"<<\") || t.startsWith(\"<<<\"))) {\n      continue;\n    }\n\n    const { pattern, tokensAfterPattern } = parseSearchCommandArgs(\"rg\", args);\n    if (!pattern) continue;\n\n    if (!isMatchAllSearchPattern(stripOuterQuotes(pattern))) {\n      continue;\n    }\n\n    if (hasFileReadTargetToken(tokensAfterPattern)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nfunction detectGrepFileDump(script: string): boolean {\n  // Fast-path: avoid doing any work if \"grep\" doesn't appear at all.\n  if (!script.includes(\"grep\")) {\n    return false;\n  }\n\n  const segments = script.split(/\\n|&&|\\|\\||;|\\|/);\n  for (const segment of segments) {\n    const tokens = segment.trim().split(/\\s+/).filter(Boolean);\n    const grepIndex = getGrepCommandTokenIndex(tokens);\n    if (grepIndex === null) continue;\n\n    const args = tokens.slice(grepIndex + 1);\n    if (args.length === 0) continue;\n\n    // Ignore heredocs / here-strings (not a file read).\n    if (args.some((t) => t.startsWith(\"<<\") || t.startsWith(\"<<<\"))) {\n      continue;\n    }\n\n    const { pattern, tokensAfterPattern } = parseSearchCommandArgs(\"grep\", args);\n    if (!pattern) continue;\n\n    if (!isMatchAllSearchPattern(stripOuterQuotes(pattern))) {\n      continue;\n    }\n\n    if (hasFileReadTargetToken(tokensAfterPattern)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\ntype BashToolForegroundResult = Exclude<BashToolResult, { backgroundProcessId: string }>;\n\nfunction isForegroundBashToolResult(result: BashToolResult): result is BashToolForegroundResult {\n  return !(\"backgroundProcessId\" in result);\n}\n\nfunction addNoticeToBashToolResult(\n  result: BashToolResult,\n  notice: string | undefined\n): BashToolResult {\n  if (!notice || !isForegroundBashToolResult(result)) {\n    return result;\n  }\n\n  return {\n    ...result,\n    note: prependToolNote(result.note, notice),\n  };\n}\n\n/**\n * Validates bash script input for common issues\n * Returns error result if validation fails, null if valid\n */\nfunction validateScript(script: string, config: ToolConfiguration): BashToolResult | null {\n  // Check for empty script\n  if (!script || script.trim().length === 0) {\n    return {\n      success: false,\n      error: \"Script parameter is empty. This likely indicates a malformed tool call.\",\n      exitCode: -1,\n      wall_duration_ms: 0,\n    };\n  }\n\n  // Detect redundant cd to working directory\n  const cdPattern = /^\\s*cd\\s+['\"]?([^'\";&|]+)['\"]?\\s*[;&|]/;\n  const match = cdPattern.exec(script);\n  if (match) {\n    const targetPath = match[1].trim();\n    const normalizedTarget = config.runtime.normalizePath(targetPath, config.cwd);\n    const normalizedCwd = config.runtime.normalizePath(\".\", config.cwd);\n\n    if (normalizedTarget === normalizedCwd) {\n      return {\n        success: false,\n        error: `Redundant cd to working directory detected. The tool already runs in ${config.cwd} - no cd needed. Remove the 'cd ${targetPath}' prefix.`,\n        exitCode: -1,\n        wall_duration_ms: 0,\n      };\n    }\n  }\n\n  return null; // Valid\n}\n\n/**\n * Rewrite cmd.exe-style null-device redirects (e.g. `>nul`, `2>nul`) into `/dev/null`.\n *\n * Why: mux executes commands via bash (Git Bash on Windows). In bash, `nul` is a normal filename,\n * so scripts that try to discard output with `>nul` end up creating a file named `nul` in the\n * workspace root.\n *\n * This is intentionally narrow: only the *redirection target token* `nul`/`NUL` (optionally quoted,\n * optionally with a trailing `:`) is rewritten.\n */\nfunction rewriteWindowsNullRedirects(script: string): { script: string; didRewrite: boolean } {\n  let didRewrite = false;\n\n  let inSingleQuote = false;\n  let inDoubleQuote = false;\n\n  const isEscaped = (index: number): boolean => {\n    // Count consecutive backslashes immediately preceding `index`.\n    let backslashes = 0;\n    for (let i = index - 1; i >= 0 && script[i] === \"\\\\\"; i--) {\n      backslashes++;\n    }\n    return backslashes % 2 === 1;\n  };\n\n  let out = \"\";\n  let i = 0;\n\n  while (i < script.length) {\n    const ch = script[i];\n\n    // Track basic quoting to avoid rewriting inside strings.\n    if (!inDoubleQuote && ch === \"'\" && !isEscaped(i)) {\n      inSingleQuote = !inSingleQuote;\n      out += ch;\n      i++;\n      continue;\n    }\n\n    if (!inSingleQuote && ch === '\"' && !isEscaped(i)) {\n      inDoubleQuote = !inDoubleQuote;\n      out += ch;\n      i++;\n      continue;\n    }\n\n    // Only rewrite when not inside quotes.\n    if (!inSingleQuote && !inDoubleQuote) {\n      // Skip escaped operators like `\\>nul`.\n      if (ch === \">\" && isEscaped(i)) {\n        out += ch;\n        i++;\n        continue;\n      }\n\n      // Parse an output redirection operator at `i`:\n      //   >, >>, 1>, 2>>, &>, etc.\n      const redirectStart = i;\n      let redirectPos = i;\n\n      // Optional fd specifier (digits) or `&`.\n      if (script[redirectPos] === \"&\") {\n        redirectPos++;\n      } else if (/[0-9]/.test(script[redirectPos] ?? \"\")) {\n        const fdStart = redirectPos;\n        while (/[0-9]/.test(script[redirectPos] ?? \"\")) {\n          redirectPos++;\n        }\n\n        // If the digits aren't directly followed by `>`, this isn't a redirection.\n        if (script[redirectPos] !== \">\") {\n          redirectPos = fdStart;\n        }\n      }\n\n      if (script[redirectPos] === \">\" && !isEscaped(redirectPos)) {\n        // Read `>` or `>>`.\n        redirectPos++;\n        if (script[redirectPos] === \">\") {\n          redirectPos++;\n        }\n\n        // Consume whitespace after the operator.\n        let targetStart = redirectPos;\n        while (targetStart < script.length && /\\s/.test(script[targetStart] ?? \"\")) {\n          targetStart++;\n        }\n\n        // Parse target token (quoted or unquoted).\n        if (targetStart < script.length) {\n          const quote = script[targetStart];\n          let token: string | null = null;\n          let tokenEnd = targetStart;\n\n          if (quote === \"'\" || quote === '\"') {\n            const quotedStart = targetStart + 1;\n            tokenEnd = quotedStart;\n\n            while (tokenEnd < script.length) {\n              const c = script[tokenEnd];\n              if (c === quote && !(quote === '\"' && isEscaped(tokenEnd))) {\n                break;\n              }\n              tokenEnd++;\n            }\n\n            if (tokenEnd < script.length && script[tokenEnd] === quote) {\n              token = script.slice(quotedStart, tokenEnd);\n              tokenEnd++; // include closing quote\n            }\n          } else {\n            while (tokenEnd < script.length) {\n              const c = script[tokenEnd];\n              if (/\\s/.test(c) || /[;&|()<>]/.test(c)) {\n                break;\n              }\n              tokenEnd++;\n            }\n\n            token = script.slice(targetStart, tokenEnd);\n          }\n\n          const lower = token?.toLowerCase();\n          if (lower === \"nul\" || lower === \"nul:\") {\n            // Replace the token with /dev/null, preserving operator + whitespace.\n            out += script.slice(redirectStart, targetStart) + \"/dev/null\";\n            didRewrite = true;\n            i = tokenEnd;\n            continue;\n          }\n        }\n      }\n    }\n\n    out += ch;\n    i++;\n  }\n\n  return { script: out, didRewrite };\n}\n\n/**\n * Creates a line handler that enforces truncation limits\n * Processes lines for both stdout and stderr with identical logic\n */\nfunction createLineHandler(\n  lines: string[],\n  totalBytesRef: { current: number },\n  limits: {\n    maxLineBytes: number;\n    maxFileBytes: number;\n    maxTotalBytes: number;\n    maxLines: number;\n  },\n  state: {\n    displayTruncated: boolean;\n    fileTruncated: boolean;\n  },\n  triggerDisplayTruncation: (reason: string) => void,\n  triggerFileTruncation: (reason: string) => void\n): (line: string) => void {\n  return (line: string) => {\n    if (state.fileTruncated) return;\n\n    const lineBytes = Buffer.byteLength(line, \"utf-8\");\n\n    // Check if line exceeds per-line limit (hard stop - likely corrupt data)\n    if (lineBytes > limits.maxLineBytes) {\n      triggerFileTruncation(\n        `Line ${lines.length + 1} exceeded per-line limit: ${lineBytes} bytes > ${limits.maxLineBytes} bytes`\n      );\n      return;\n    }\n\n    // Check file limit BEFORE adding line\n    const bytesAfterLine = totalBytesRef.current + lineBytes + 1; // +1 for newline\n    if (bytesAfterLine > limits.maxFileBytes) {\n      triggerFileTruncation(\n        `Total output would exceed file preservation limit: ${bytesAfterLine} bytes > ${limits.maxFileBytes} bytes (at line ${lines.length + 1})`\n      );\n      return;\n    }\n\n    // Collect line (even if display is truncated, keep for file)\n    lines.push(line);\n    totalBytesRef.current = bytesAfterLine;\n\n    // Check display limits (soft stop - keep collecting for file)\n    if (!state.displayTruncated) {\n      if (totalBytesRef.current > limits.maxTotalBytes) {\n        triggerDisplayTruncation(\n          `Total output exceeded display limit: ${totalBytesRef.current} bytes > ${limits.maxTotalBytes} bytes (at line ${lines.length})`\n        );\n        return;\n      }\n\n      if (lines.length >= limits.maxLines) {\n        triggerDisplayTruncation(\n          `Line count exceeded display limit: ${lines.length} lines >= ${limits.maxLines} lines (${totalBytesRef.current} bytes read)`\n        );\n      }\n    }\n  };\n}\n\n/**\n * Formats the final bash tool result based on exit code and truncation state\n */\nfunction formatResult(\n  exitCode: number,\n  lines: string[],\n  truncated: boolean,\n  overflowReason: string | null,\n  wall_duration_ms: number,\n  overflowPolicy: \"tmpfile\" | \"truncate\",\n  effectiveTimeout: number\n): BashToolResult {\n  const output = lines.join(\"\\n\");\n\n  // Check for special error codes from runtime\n  if (exitCode === EXIT_CODE_ABORTED) {\n    return {\n      success: false,\n      error: \"Command execution was aborted\",\n      exitCode: -1,\n      wall_duration_ms,\n    };\n  }\n\n  if (exitCode === EXIT_CODE_TIMEOUT) {\n    return {\n      success: false,\n      error: `Command exceeded timeout of ${effectiveTimeout} seconds. You can increase the timeout by setting the \\`timeout_secs\\` parameter on the tool call. Do not use the \\`timeout\\` bash command to increase the timeout.`,\n      exitCode: -1,\n      wall_duration_ms,\n    };\n  }\n\n  // Handle truncation\n  if (truncated) {\n    const truncationInfo = {\n      reason: overflowReason ?? \"unknown reason\",\n      totalLines: lines.length,\n    };\n\n    if (overflowPolicy === \"truncate\") {\n      // Return all collected lines with truncation marker\n      if (exitCode === 0) {\n        return {\n          success: true,\n          output,\n          exitCode: 0,\n          wall_duration_ms,\n          truncated: truncationInfo,\n        };\n      } else {\n        return {\n          success: false,\n          output,\n          exitCode,\n          error: `Command exited with code ${exitCode}`,\n          wall_duration_ms,\n          truncated: truncationInfo,\n        };\n      }\n    }\n  }\n\n  // Normal exit\n  if (exitCode === 0) {\n    return {\n      success: true,\n      output,\n      exitCode: 0,\n      wall_duration_ms,\n    };\n  } else {\n    return {\n      success: false,\n      output,\n      exitCode,\n      error: `Command exited with code ${exitCode}`,\n      wall_duration_ms,\n    };\n  }\n}\n\n/**\n * Shell-escape a string for safe use in bash commands (single-quote wrapping).\n */\nfunction shellEscape(str: string): string {\n  return `'${str.replace(/'/g, \"'\\\\''\")}'`;\n}\n\n/**\n * Build script prelude that sources .mux/tool_env if present.\n * Returns empty string if no tool_env path is provided.\n */\nfunction buildToolEnvPrelude(toolEnvPath: string | null): string {\n  if (!toolEnvPath) return \"\";\n  // Source the tool_env file; fail with clear error if sourcing fails\n  return `if ! source ${shellEscape(toolEnvPath)} 2>&1; then\n  echo \"mux: failed to source ${toolEnvPath}\" >&2\n  exit 1\nfi\n`;\n}\n\n/**\n * Bash execution tool factory for AI assistant\n * Creates a bash tool that can execute commands with a configurable timeout\n * @param config Required configuration including working directory\n */\nexport const createBashTool: ToolFactory = (config: ToolConfiguration) => {\n  // Select limits based on overflow policy\n  // truncate = IPC calls (generous limits for UI features, no line limit, no per-line limit)\n  // tmpfile = AI agent calls (conservative limits for LLM context)\n  const overflowPolicy = config.overflow_policy ?? \"tmpfile\";\n  const maxTotalBytes =\n    overflowPolicy === \"truncate\" ? BASH_TRUNCATE_MAX_TOTAL_BYTES : BASH_MAX_TOTAL_BYTES;\n  const maxFileBytes =\n    overflowPolicy === \"truncate\" ? BASH_TRUNCATE_MAX_FILE_BYTES : BASH_MAX_FILE_BYTES;\n  const maxLines = overflowPolicy === \"truncate\" ? Infinity : BASH_HARD_MAX_LINES;\n  const maxLineBytes = overflowPolicy === \"truncate\" ? Infinity : BASH_MAX_LINE_BYTES;\n\n  return tool({\n    description: TOOL_DEFINITIONS.bash.description + \"\\nRuns in \" + config.cwd + \" - no cd needed\",\n    inputSchema: TOOL_DEFINITIONS.bash.schema,\n    execute: async (\n      { script, timeout_secs, run_in_background, display_name },\n      { abortSignal, toolCallId }\n    ): Promise<BashToolResult> => {\n      // Validate script input\n\n      // Treat display_name as untrusted input: it ends up in filesystem paths.\n      const safeDisplayName = resolveBashDisplayName(script, display_name);\n      const validationError = validateScript(script, config);\n      if (validationError) return validationError;\n\n      // Warn when the model appears to be reading files via bash output (cat/rg/grep).\n      // Reading files via bash output is fragile (may be truncated or auto-filtered);\n      // file_read supports paging and avoids silent context loss.\n      const fileReadNotice =\n        detectCatFileRead(script) || detectRipgrepFileDump(script) || detectGrepFileDump(script)\n          ? CAT_FILE_READ_NOTICE\n          : undefined;\n\n      // Look up .mux/tool_env to source before script (for direnv, nvm, venv, etc.)\n      const toolEnvPath = config.runtime ? await getToolEnvPath(config.runtime, config.cwd) : null;\n      const toolEnvPrelude = buildToolEnvPrelude(toolEnvPath);\n\n      // On Windows, models sometimes emit cmd.exe-style `>nul` / `2>nul` redirections.\n      // Since the bash tool runs via bash, `nul` becomes a real file in the workspace.\n      // Only rewrite for local Windows runtimes so non-Windows scripts keep their semantics.\n      const shouldRewriteNullRedirects =\n        process.platform === \"win32\" && config.runtime instanceof LocalBaseRuntime;\n      const nulRedirectRewrite = shouldRewriteNullRedirects\n        ? rewriteWindowsNullRedirects(script)\n        : { script, didRewrite: false };\n      const scriptWithEnv = toolEnvPrelude + nulRedirectRewrite.script;\n\n      const nulRedirectNote = nulRedirectRewrite.didRewrite\n        ? \"Rewrote `>nul`/`2>nul`  `/dev/null` (bash tool runs in bash; use `/dev/null` to discard output).\"\n        : undefined;\n\n      // Handle explicit background execution (run_in_background=true)\n      const withNotice = (result: BashToolResult): BashToolResult =>\n        addNoticeToBashToolResult(\n          addNoticeToBashToolResult(result, nulRedirectNote),\n          fileReadNotice\n        );\n\n      if (run_in_background) {\n        if (!config.workspaceId || !config.backgroundProcessManager || !config.runtime) {\n          return withNotice({\n            success: false,\n            error:\n              \"Background execution is only available for AI tool calls, not direct IPC invocation\",\n            exitCode: -1,\n            wall_duration_ms: 0,\n          });\n        }\n\n        const startTime = performance.now();\n        const spawnResult = await config.backgroundProcessManager.spawn(\n          config.runtime,\n          config.workspaceId,\n          scriptWithEnv,\n          {\n            cwd: config.cwd,\n            // Match foreground bash behavior: muxEnv is present and secrets override it.\n            env: { ...(config.muxEnv ?? {}), ...(config.secrets ?? {}) },\n            displayName: safeDisplayName,\n            isForeground: false, // Explicit background\n            timeoutSecs: timeout_secs, // Auto-terminate after this duration\n          }\n        );\n\n        if (!spawnResult.success) {\n          return withNotice({\n            success: false,\n            error: spawnResult.error,\n            exitCode: -1,\n            wall_duration_ms: Math.round(performance.now() - startTime),\n          });\n        }\n\n        return withNotice({\n          success: true,\n          output: `Background process started with ID: ${spawnResult.processId}`,\n          exitCode: 0,\n          wall_duration_ms: Math.round(performance.now() - startTime),\n          taskId: toBashTaskId(spawnResult.processId),\n          backgroundProcessId: spawnResult.processId,\n        });\n      }\n\n      // Setup execution parameters\n      const effectiveTimeout = timeout_secs ?? BASH_DEFAULT_TIMEOUT_SECS;\n      const startTime = performance.now();\n      const totalBytesRef = { current: 0 }; // Use ref for shared access in line handler\n      let overflowReason: string | null = null;\n      const truncationState = { displayTruncated: false, fileTruncated: false };\n\n      // Track backgrounding state\n      const backgroundedRef: { current: boolean } = { current: false };\n      let foregroundCompleted = false;\n      let backgroundResolve: (() => void) | null = null;\n      const backgroundPromise = new Promise<void>((resolve) => {\n        backgroundResolve = resolve;\n      });\n\n      // Wrap abort signal so we can detach when migrating to background.\n      // When detached, the original stream abort won't kill the process.\n      const wrappedAbortController = new AbortController();\n      let abortDetached = false;\n      if (abortSignal) {\n        abortSignal.addEventListener(\"abort\", () => {\n          if (!abortDetached) {\n            wrappedAbortController.abort();\n          }\n        });\n      }\n\n      // Register foreground process for \"send to background\" feature\n      // Only if manager is available (AI tool calls, not IPC)\n      const fgRegistration =\n        config.backgroundProcessManager && config.workspaceId && toolCallId\n          ? config.backgroundProcessManager.registerForegroundProcess(\n              config.workspaceId,\n              toolCallId,\n              script,\n              safeDisplayName,\n              () => {\n                backgroundedRef.current = true;\n                // Resolve the background promise to unblock the wait\n                if (backgroundResolve) backgroundResolve();\n              }\n            )\n          : null;\n\n      // Execute using runtime interface (works for both local and SSH)\n      const scriptWithClosedStdin = `exec </dev/null\n${scriptWithEnv}`;\n      const execStream = await config.runtime.exec(scriptWithClosedStdin, {\n        cwd: config.cwd,\n        env: { ...config.muxEnv, ...config.secrets, ...NON_INTERACTIVE_ENV_VARS },\n        timeout: effectiveTimeout,\n        abortSignal: wrappedAbortController.signal,\n      });\n\n      let exitCodeResolved = false;\n      const exitCodePromise = execStream.exitCode.then((code) => {\n        exitCodeResolved = true;\n        return code;\n      });\n\n      // Force-close stdin immediately - we don't need to send any input\n      // Use abort() instead of close() for immediate, synchronous closure\n      // close() is async and waits for acknowledgment, which can hang over SSH\n      // abort() immediately marks stream as errored and releases locks\n      execStream.stdin.abort().catch(() => {\n        /* ignore */ return;\n      });\n\n      // Tee streams so we can migrate to background if needed\n      // One branch goes to line handler (UI), other is held for potential migration\n      const [stdoutForUI, stdoutForMigration] = execStream.stdout.tee();\n      const [stderrForUI, stderrForMigration] = execStream.stderr.tee();\n\n      // Collect output concurrently from Web Streams to avoid readline race conditions.\n      const lines: string[] = [];\n      let truncated = false;\n\n      // Helper to trigger display truncation (stop showing to agent, keep collecting)\n      const triggerDisplayTruncation = (reason: string) => {\n        truncationState.displayTruncated = true;\n        truncated = true;\n        overflowReason = reason;\n        // Don't kill process yet - keep collecting up to file limit\n      };\n\n      // Helper to trigger file truncation (stop collecting, close streams)\n      const triggerFileTruncation = (reason: string) => {\n        truncationState.fileTruncated = true;\n        truncationState.displayTruncated = true;\n        truncated = true;\n        overflowReason = reason;\n        // Cancel all stream branches to stop the process and unblock readers\n        stdoutForUI.cancel().catch(() => {\n          /* ignore */ return;\n        });\n        stderrForUI.cancel().catch(() => {\n          /* ignore */ return;\n        });\n        stdoutForMigration.cancel().catch(() => {\n          /* ignore */ return;\n        });\n        stderrForMigration.cancel().catch(() => {\n          /* ignore */ return;\n        });\n      };\n\n      // Create unified line handler for both stdout and stderr\n      const lineHandler = createLineHandler(\n        lines,\n        totalBytesRef,\n        { maxLineBytes, maxFileBytes, maxTotalBytes, maxLines },\n        truncationState,\n        triggerDisplayTruncation,\n        triggerFileTruncation\n      );\n\n      // UI-only incremental output streaming over workspace.onChat (not sent to the model).\n      // We flush chunked text rather than per-line to keep overhead low.\n      let liveOutputStopped = false;\n      let liveStdoutBuffer = \"\";\n      let liveStderrBuffer = \"\";\n      let liveOutputTimer: ReturnType<typeof setInterval> | null = null;\n\n      const LIVE_FLUSH_INTERVAL_MS = 75;\n      const MAX_LIVE_EVENT_CHARS = 32_768;\n\n      const emitBashOutput = (isError: boolean, text: string): void => {\n        if (!config.emitChatEvent || !config.workspaceId || !toolCallId) return;\n        if (liveOutputStopped) return;\n        if (text.length === 0) return;\n\n        config.emitChatEvent({\n          type: \"bash-output\",\n          workspaceId: config.workspaceId,\n          toolCallId,\n          text,\n          isError,\n          timestamp: Date.now(),\n        } satisfies BashOutputEvent);\n      };\n\n      const flushLiveOutput = (): void => {\n        if (liveOutputStopped) return;\n\n        const flush = (isError: boolean, buffer: string): void => {\n          if (buffer.length === 0) return;\n          for (let i = 0; i < buffer.length; i += MAX_LIVE_EVENT_CHARS) {\n            emitBashOutput(isError, buffer.slice(i, i + MAX_LIVE_EVENT_CHARS));\n          }\n        };\n\n        if (liveStdoutBuffer.length > 0) {\n          const buf = liveStdoutBuffer;\n          liveStdoutBuffer = \"\";\n          flush(false, buf);\n        }\n\n        if (liveStderrBuffer.length > 0) {\n          const buf = liveStderrBuffer;\n          liveStderrBuffer = \"\";\n          flush(true, buf);\n        }\n      };\n\n      const stopLiveOutput = (flush: boolean): void => {\n        if (liveOutputStopped) return;\n        if (flush) flushLiveOutput();\n\n        liveOutputStopped = true;\n\n        if (liveOutputTimer) {\n          clearInterval(liveOutputTimer);\n          liveOutputTimer = null;\n        }\n\n        liveStdoutBuffer = \"\";\n        liveStderrBuffer = \"\";\n      };\n\n      if (config.emitChatEvent && config.workspaceId && toolCallId) {\n        liveOutputTimer = setInterval(flushLiveOutput, LIVE_FLUSH_INTERVAL_MS);\n      }\n\n      const appendLiveOutput = (isError: boolean, text: string): void => {\n        if (!config.emitChatEvent || !config.workspaceId || !toolCallId) return;\n        if (liveOutputStopped) return;\n        if (text.length === 0) return;\n\n        if (isError) {\n          liveStderrBuffer += text;\n          if (liveStderrBuffer.length >= MAX_LIVE_EVENT_CHARS) flushLiveOutput();\n        } else {\n          liveStdoutBuffer += text;\n          if (liveStdoutBuffer.length >= MAX_LIVE_EVENT_CHARS) flushLiveOutput();\n        }\n      };\n\n      // Consume a ReadableStream<Uint8Array> and emit lines to lineHandler.\n      // Uses TextDecoder streaming to preserve multibyte boundaries.\n      const consumeStream = async (\n        stream: ReadableStream<Uint8Array>,\n        isError: boolean\n      ): Promise<void> => {\n        const reader = stream.getReader();\n        const decoder = new TextDecoder(\"utf-8\");\n        let carry = \"\";\n\n        // Set up abort handler to cancel reader when abort signal fires\n        // This interrupts reader.read() if it's blocked, preventing hangs\n        const abortHandler = () => {\n          reader.cancel().catch(() => {\n            /* ignore - reader may already be closed */\n          });\n        };\n        abortSignal?.addEventListener(\"abort\", abortHandler);\n\n        try {\n          while (true) {\n            if (truncationState.fileTruncated) {\n              // Stop early if we already hit hard limits\n              await reader.cancel().catch(() => {\n                /* ignore */ return;\n              });\n              break;\n            }\n            const { value, done } = await reader.read();\n            if (done) break;\n            // Decode chunk (streaming keeps partial code points)\n            const text = decoder.decode(value, { stream: true });\n            appendLiveOutput(isError, text);\n            carry += text;\n\n            // Split into lines; support both \\n and \\r\\n\n            let start = 0;\n            while (true) {\n              const idxN = carry.indexOf(\"\\n\", start);\n              const idxR = carry.indexOf(\"\\r\", start);\n              let nextIdx = -1;\n              if (idxN === -1 && idxR === -1) break;\n              nextIdx = idxN === -1 ? idxR : idxR === -1 ? idxN : Math.min(idxN, idxR);\n              const line = carry.slice(0, nextIdx).replace(/\\r$/, \"\");\n              lineHandler(line);\n              carry = carry.slice(nextIdx + 1);\n              start = 0;\n              if (truncationState.fileTruncated) {\n                await reader.cancel().catch(() => {\n                  /* ignore */ return;\n                });\n                break;\n              }\n            }\n\n            // Defensive: if output never emits newlines, carry can grow without bound.\n            // If the incomplete line already violates hard limits, stop early.\n            if (carry.length > 0 && !truncationState.fileTruncated) {\n              const carryBytes = Buffer.byteLength(carry, \"utf-8\");\n              const bytesAfterCarry = totalBytesRef.current + carryBytes + 1; // +1 for newline\n              if (carryBytes > maxLineBytes || bytesAfterCarry > maxFileBytes) {\n                // Delegate to lineHandler to keep truncation reasons consistent.\n                lineHandler(carry);\n                if (truncationState.fileTruncated) {\n                  await reader.cancel().catch(() => {\n                    /* ignore */ return;\n                  });\n                  break;\n                }\n              }\n            }\n            if (truncationState.fileTruncated) break;\n          }\n        } finally {\n          // Clean up abort listener\n          abortSignal?.removeEventListener(\"abort\", abortHandler);\n\n          // Flush decoder for any trailing bytes and emit the last line (if any)\n          try {\n            const tail = decoder.decode();\n            if (tail) {\n              appendLiveOutput(isError, tail);\n              carry += tail;\n            }\n            if (carry.length > 0 && !truncationState.fileTruncated) {\n              lineHandler(carry);\n            }\n          } catch {\n            // ignore decoder errors on flush\n          }\n        }\n      };\n\n      // Start consuming stdout and stderr concurrently (using UI branches)\n      const consumeStdout = consumeStream(stdoutForUI, false);\n      const consumeStderr = consumeStream(stderrForUI, true);\n\n      // Wait for process exit and stream consumption concurrently\n      // Also race with the background promise to detect early return request\n      const foregroundCompletion = Promise.all([\n        exitCodePromise,\n        consumeStdout,\n        consumeStderr,\n      ]).then((value) => {\n        foregroundCompleted = true;\n        return value;\n      });\n\n      // Attach a no-op rejection handler to prevent Node's unhandled rejection warning.\n      void foregroundCompletion.catch(() => undefined);\n\n      // If the user clicks \"Background\" right as the process is exiting, we can end up\n      // racing the background request against stream draining. In that case, prefer the\n      // normal completion path so we don't drop any last-millisecond output (especially\n      // on Windows, where stream/exit events can arrive slightly out of order).\n      const BACKGROUND_EXIT_GRACE_MS = 100;\n\n      let exitCode: number;\n      try {\n        const result = await Promise.race([\n          foregroundCompletion,\n          backgroundPromise.then(() => \"backgrounded\" as const),\n        ]);\n\n        const shouldBackground =\n          result === \"backgrounded\" || (backgroundedRef.current && !foregroundCompleted);\n\n        // If the process already exited, drain the foreground streams for reliable output\n        // instead of backgrounding based on timing.\n        if (shouldBackground) {\n          const didExit =\n            exitCodeResolved ||\n            (await Promise.race([\n              execStream.exitCode.then(() => true).catch(() => true),\n              new Promise<boolean>((resolve) =>\n                setTimeout(() => resolve(false), BACKGROUND_EXIT_GRACE_MS)\n              ),\n            ]));\n\n          if (didExit) {\n            const completed = await foregroundCompletion;\n            exitCode = completed[0];\n          } else {\n            // Detach from abort signal as early as possible - process should continue running\n            // even when the stream ends and fires abort.\n            abortDetached = true;\n\n            // Unregister foreground process\n            fgRegistration?.unregister();\n\n            // Stop UI-only output streaming before migrating to background.\n            stopLiveOutput(true);\n\n            // Stop consuming UI stream branches - further output should be handled by bash_output.\n            stdoutForUI.cancel().catch(() => {\n              /* ignore */ return;\n            });\n            stderrForUI.cancel().catch(() => {\n              /* ignore */ return;\n            });\n\n            // Avoid unhandled promise rejections if the cancelled UI readers cause\n            // the foreground consumption promise to reject after we return.\n            void foregroundCompletion.catch(() => undefined);\n\n            const wall_duration_ms = Math.round(performance.now() - startTime);\n\n            // Migrate to background tracking if manager is available\n            if (config.backgroundProcessManager && config.workspaceId) {\n              const processId =\n                config.backgroundProcessManager.generateUniqueProcessId(safeDisplayName);\n\n              // Create a synthetic ExecStream for the migration streams\n              // The UI streams are still being consumed, migration streams continue to files\n              const migrationStream = {\n                stdout: stdoutForMigration,\n                stderr: stderrForMigration,\n                stdin: execStream.stdin,\n                exitCode: execStream.exitCode,\n                duration: execStream.duration,\n              };\n\n              const migrateResult = await migrateToBackground(\n                migrationStream,\n                {\n                  cwd: config.cwd,\n                  workspaceId: config.workspaceId,\n                  processId,\n                  script,\n                  existingOutput: lines,\n                },\n                config.backgroundProcessManager.getBgOutputDir()\n              );\n\n              if (migrateResult.success) {\n                // Register the migrated process with the manager\n                config.backgroundProcessManager.registerMigratedProcess(\n                  migrateResult.handle,\n                  processId,\n                  config.workspaceId,\n                  script,\n                  migrateResult.outputDir,\n                  safeDisplayName\n                );\n\n                return withNotice({\n                  success: true,\n                  output: `Process sent to background with ID: ${processId}\\n\\nOutput so far (${lines.length} lines):\\n${lines.slice(-20).join(\"\\n\")}${lines.length > 20 ? \"\\n...(showing last 20 lines)\" : \"\"}`,\n                  exitCode: 0,\n                  wall_duration_ms,\n                  taskId: toBashTaskId(processId),\n                  backgroundProcessId: processId,\n                });\n              }\n              // Migration failed, fall through to simple return\n            }\n\n            // Fallback: return without process ID (no manager or migration failed)\n            return withNotice({\n              success: true,\n              output: `Process sent to background. It will continue running.\\n\\nOutput so far (${lines.length} lines):\\n${lines.slice(-20).join(\"\\n\")}${lines.length > 20 ? \"\\n...(showing last 20 lines)\" : \"\"}`,\n              exitCode: 0,\n              wall_duration_ms,\n            });\n          }\n        } else {\n          // Normal completion - extract exit code\n          exitCode = result[0];\n        }\n      } catch (err: unknown) {\n        // Unregister on error\n        fgRegistration?.unregister();\n\n        // Check if this was an abort\n        if (abortSignal?.aborted) {\n          return withNotice({\n            success: false,\n            error: \"Command execution was aborted\",\n            exitCode: -1,\n            wall_duration_ms: Math.round(performance.now() - startTime),\n          });\n        }\n        return withNotice({\n          success: false,\n          error: `Failed to execute command: ${err instanceof Error ? err.message : String(err)}`,\n          exitCode: -1,\n          wall_duration_ms: Math.round(performance.now() - startTime),\n        });\n      } finally {\n        stopLiveOutput(true);\n      }\n\n      // Unregister foreground process on normal completion\n      fgRegistration?.unregister();\n\n      // Check if command was aborted (exitCode will be EXIT_CODE_ABORTED = -997)\n      // This can happen if abort signal fired after Promise.all resolved but before we check\n      if (abortSignal?.aborted) {\n        return withNotice({\n          success: false,\n          error: \"Command execution was aborted\",\n          exitCode: -1,\n          wall_duration_ms: Math.round(performance.now() - startTime),\n        });\n      }\n\n      // Round to integer to preserve tokens\n      const wall_duration_ms = Math.round(performance.now() - startTime);\n\n      // Handle tmpfile overflow policy separately (writes to file)\n      if (truncated && (config.overflow_policy ?? \"tmpfile\") === \"tmpfile\") {\n        // tmpfile policy: Save overflow output to temp file and return a successful response.\n        // We don't show ANY of the actual output to avoid overwhelming context.\n        // Instead, save it to a temp file and encourage the agent to use filtering tools.\n        const truncationInfo = {\n          reason: overflowReason ?? \"unknown reason\",\n          totalLines: lines.length,\n        };\n        try {\n          // Use 8 hex characters for short, memorable temp file IDs\n          const fileId = Math.random().toString(16).substring(2, 10);\n          // Write to runtime temp directory (managed by StreamManager).\n          // Use path.posix.join to preserve forward slashes:\n          // - SSH runtime needs POSIX-style paths\n          // - Windows local runtime uses drive-qualified paths like C:/Users/... (also with /)\n          const overflowPath = path.posix.join(config.runtimeTempDir, `bash-${fileId}.txt`);\n          const fullOutput = lines.join(\"\\n\");\n\n          // Use runtime.writeFile() for SSH support\n          const writer = config.runtime.writeFile(overflowPath, abortSignal);\n          const encoder = new TextEncoder();\n          const writerInstance = writer.getWriter();\n          await writerInstance.write(encoder.encode(fullOutput));\n          await writerInstance.close();\n\n          const noticeBase = `[OUTPUT OVERFLOW - ${overflowReason ?? \"unknown reason\"}]\n\nFull output (${lines.length} lines) saved to ${overflowPath}\n\nUse selective filtering tools (e.g. grep) to extract relevant information and continue your task\n\nFile will be automatically cleaned up when stream ends.`;\n\n          return withNotice({\n            success: true,\n            output: \"\",\n            note: noticeBase,\n            exitCode: 0,\n            wall_duration_ms,\n            truncated: truncationInfo,\n          });\n        } catch (err) {\n          // If temp file creation fails, fall back to original error\n          return withNotice({\n            success: false,\n            error: `Command output overflow: ${overflowReason ?? \"unknown reason\"}. Failed to save overflow to temp file: ${String(err)}`,\n            exitCode: -1,\n            wall_duration_ms,\n          });\n        }\n      }\n\n      // Format result based on exit code and truncation state\n      return withNotice(\n        formatResult(\n          exitCode,\n          lines,\n          truncated,\n          overflowReason,\n          wall_duration_ms,\n          config.overflow_policy ?? \"tmpfile\",\n          effectiveTimeout\n        )\n      );\n    },\n  });\n};\n"]}