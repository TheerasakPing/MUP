{"version":3,"file":"bash.js","sourceRoot":"","sources":["../../../../src/node/services/tools/bash.ts"],"names":[],"mappings":"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","sourcesContent":["import { tool } from \"ai\";\r\n// NOTE: We avoid readline; consume Web Streams directly to prevent race conditions\r\nimport * as path from \"path\";\r\nimport {\r\n  BASH_DEFAULT_TIMEOUT_SECS,\r\n  BASH_HARD_MAX_LINES,\r\n  BASH_MAX_LINE_BYTES,\r\n  BASH_MAX_TOTAL_BYTES,\r\n  BASH_MAX_FILE_BYTES,\r\n  BASH_TRUNCATE_MAX_TOTAL_BYTES,\r\n  BASH_TRUNCATE_MAX_FILE_BYTES,\r\n} from \"@/common/constants/toolLimits\";\r\nimport { NON_INTERACTIVE_ENV_VARS } from \"@/common/constants/env\";\r\nimport { EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT } from \"@/common/constants/exitCodes\";\r\n\r\nimport type { BashOutputEvent } from \"@/common/types/stream\";\r\nimport type { BashToolResult } from \"@/common/types/tools\";\r\nimport { resolveBashDisplayName } from \"@/common/utils/tools/bashDisplayName\";\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { toBashTaskId } from \"./taskId\";\r\nimport { migrateToBackground } from \"@/node/services/backgroundProcessExecutor\";\r\nimport { LocalBaseRuntime } from \"@/node/runtime/LocalBaseRuntime\";\r\nimport { getToolEnvPath } from \"@/node/services/hooks\";\r\n\r\nconst CAT_FILE_READ_NOTICE =\r\n  \"[IMPORTANT]\\n\\nDO NOT use `cat`, `rg`, or `grep` to read files. Use the `file_read` tool instead (supports offset/limit paging). Bash output may be truncated or auto-filtered, which can hide parts of the file.\";\r\n\r\nfunction prependToolNote(existing: string | undefined, extra: string): string {\r\n  if (!existing) {\r\n    return extra;\r\n  }\r\n\r\n  return `${extra}\\n\\n${existing}`;\r\n}\r\n\r\nfunction isCatToken(token: string): boolean {\r\n  const normalized = token.trim().startsWith(\"\\\\\") ? token.trim().slice(1) : token.trim();\r\n  return normalized === \"cat\";\r\n}\r\n\r\nfunction getCatCommandTokenIndex(tokens: string[]): number | null {\r\n  if (tokens.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (isCatToken(tokens[0])) {\r\n    return 0;\r\n  }\r\n\r\n  if (tokens[0] === \"command\" && tokens[1] && isCatToken(tokens[1])) {\r\n    return 1;\r\n  }\r\n\r\n  // Handle common patterns like: sudo cat file, sudo -n cat file, sudo -u user cat file\r\n  if (tokens[0] === \"sudo\") {\r\n    for (let i = 1; i < tokens.length && i < 8; i++) {\r\n      if (isCatToken(tokens[i])) {\r\n        return i;\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction detectCatFileRead(script: string): boolean {\r\n  // Fast-path: avoid doing any work if \"cat\" doesn't appear at all.\r\n  if (!script.includes(\"cat\")) {\r\n    return false;\r\n  }\r\n\r\n  // Split on common statement separators and pipelines.\r\n  // Note: this is intentionally not a full shell parser; we aim to catch the common\r\n  // \"cat <path>\" pattern without false positives like \"echo foo | cat\".\r\n  const segments = script.split(/\\n|&&|\\|\\||;|\\|/);\r\n\r\n  for (const segment of segments) {\r\n    const tokens = segment.trim().split(/\\s+/).filter(Boolean);\r\n    const catIndex = getCatCommandTokenIndex(tokens);\r\n    if (catIndex === null) continue;\r\n\r\n    const args = tokens.slice(catIndex + 1);\r\n    if (args.length === 0) continue; // \"cat\" (stdin passthrough)\r\n\r\n    // Ignore heredocs / here-strings (not a file read).\r\n    if (args.some((t) => t.startsWith(\"<<\") || t.startsWith(\"<<<\"))) {\r\n      continue;\r\n    }\r\n\r\n    let expectInputFile = false;\r\n    let skipNextOutputTarget = false;\r\n\r\n    for (const token of args) {\r\n      if (expectInputFile) {\r\n        expectInputFile = false;\r\n        if (token !== \"-\" && token.length > 0) {\r\n          return true;\r\n        }\r\n        continue;\r\n      }\r\n\r\n      if (skipNextOutputTarget) {\r\n        skipNextOutputTarget = false;\r\n        continue;\r\n      }\r\n\r\n      // Input redirection: cat < file OR cat <file\r\n      if (token === \"<\" || token === \"0<\") {\r\n        expectInputFile = true;\r\n        continue;\r\n      }\r\n      const inputMatch = /^(?:0)?<(.+)$/.exec(token);\r\n      if (inputMatch && !token.startsWith(\"<<\") && !token.startsWith(\"<<<\")) {\r\n        const inputFile = inputMatch[1];\r\n        if (inputFile !== \"-\" && inputFile.length > 0) {\r\n          return true;\r\n        }\r\n        continue;\r\n      }\r\n\r\n      // Output redirection: ignore output targets (doesn't indicate reading a file).\r\n      if (\r\n        token === \">\" ||\r\n        token === \">>\" ||\r\n        token === \"1>\" ||\r\n        token === \"1>>\" ||\r\n        token === \"2>\" ||\r\n        token === \"2>>\" ||\r\n        token === \"&>\" ||\r\n        token === \"&>>\"\r\n      ) {\r\n        skipNextOutputTarget = true;\r\n        continue;\r\n      }\r\n\r\n      // Output redirection with attached target (e.g. \">out\", \"2>/dev/null\", \"2>&1\")\r\n      if (/^(?:\\d+|&)?>>?/.test(token)) {\r\n        continue;\r\n      }\r\n\r\n      // Flags and stdin\r\n      if (token === \"-\" || token.startsWith(\"-\")) {\r\n        continue;\r\n      }\r\n\r\n      // Remaining non-flag tokens look like file operands (e.g. \"cat file\").\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\ntype SearchCommand = \"rg\" | \"grep\";\r\n\r\nfunction stripOuterQuotes(token: string): string {\r\n  const trimmed = token.trim();\r\n  if (trimmed.length < 2) {\r\n    return trimmed;\r\n  }\r\n\r\n  const first = trimmed[0];\r\n  const last = trimmed[trimmed.length - 1];\r\n  if ((first === \"'\" && last === \"'\") || (first === '\"' && last === '\"')) {\r\n    return trimmed.slice(1, -1);\r\n  }\r\n\r\n  return trimmed;\r\n}\r\n\r\nfunction isMatchAllSearchPattern(pattern: string): boolean {\r\n  // Intentionally narrow: we only want to warn on obvious whole-file dump patterns\r\n  // (avoid warning on normal search).\r\n  const normalized = pattern.trim();\r\n  return normalized === \"\" || normalized === \"^\" || normalized === \".*\";\r\n}\r\n\r\nfunction isRipgrepToken(token: string): boolean {\r\n  const trimmed = token.trim();\r\n  const normalized = trimmed.startsWith(\"\\\\\") ? trimmed.slice(1) : trimmed;\r\n  return normalized === \"rg\";\r\n}\r\n\r\nfunction isGrepToken(token: string): boolean {\r\n  const trimmed = token.trim();\r\n  const normalized = trimmed.startsWith(\"\\\\\") ? trimmed.slice(1) : trimmed;\r\n  return normalized === \"grep\";\r\n}\r\n\r\nfunction getRipgrepCommandTokenIndex(tokens: string[]): number | null {\r\n  if (tokens.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (isRipgrepToken(tokens[0])) {\r\n    return 0;\r\n  }\r\n\r\n  if (tokens[0] === \"command\" && tokens[1] && isRipgrepToken(tokens[1])) {\r\n    return 1;\r\n  }\r\n\r\n  // Handle common patterns like: sudo rg file, sudo -n rg file, sudo -u user rg file\r\n  if (tokens[0] === \"sudo\") {\r\n    for (let i = 1; i < tokens.length && i < 8; i++) {\r\n      if (isRipgrepToken(tokens[i])) {\r\n        return i;\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction getGrepCommandTokenIndex(tokens: string[]): number | null {\r\n  if (tokens.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (isGrepToken(tokens[0])) {\r\n    return 0;\r\n  }\r\n\r\n  if (tokens[0] === \"command\" && tokens[1] && isGrepToken(tokens[1])) {\r\n    return 1;\r\n  }\r\n\r\n  // Handle common patterns like: sudo grep file, sudo -n grep file, sudo -u user grep file\r\n  if (tokens[0] === \"sudo\") {\r\n    for (let i = 1; i < tokens.length && i < 8; i++) {\r\n      if (isGrepToken(tokens[i])) {\r\n        return i;\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction parseSearchCommandArgs(\r\n  command: SearchCommand,\r\n  args: string[]\r\n): { pattern: string | null; tokensAfterPattern: string[] } {\r\n  let pattern: string | null = null;\r\n  const tokensAfterPattern: string[] = [];\r\n  let afterDoubleDash = false;\r\n\r\n  const rgConsumesNextArg = new Set([\r\n    \"-g\",\r\n    \"--glob\",\r\n    \"--iglob\",\r\n    \"-t\",\r\n    \"--type\",\r\n    \"--type-add\",\r\n    \"--type-clear\",\r\n  ]);\r\n  const grepConsumesNextArg = new Set([\r\n    \"-f\",\r\n    \"--file\",\r\n    \"--include\",\r\n    \"--exclude\",\r\n    \"--exclude-dir\",\r\n    \"-m\",\r\n    \"--max-count\",\r\n    \"-A\",\r\n    \"-B\",\r\n    \"-C\",\r\n  ]);\r\n\r\n  for (let i = 0; i < args.length; i++) {\r\n    const token = args[i];\r\n\r\n    if (token === \"--\") {\r\n      afterDoubleDash = true;\r\n      continue;\r\n    }\r\n\r\n    if (pattern === null) {\r\n      const isFlag = !afterDoubleDash && token.startsWith(\"-\");\r\n      if (isFlag) {\r\n        const patternFlagInline =\r\n          command === \"rg\" && token.startsWith(\"--regexp=\")\r\n            ? token.slice(\"--regexp=\".length)\r\n            : command === \"grep\" && token.startsWith(\"--regexp=\")\r\n              ? token.slice(\"--regexp=\".length)\r\n              : null;\r\n\r\n        if (patternFlagInline !== null) {\r\n          pattern = patternFlagInline;\r\n          continue;\r\n        }\r\n\r\n        const isExplicitPatternFlag =\r\n          (command === \"rg\" && (token === \"-e\" || token === \"--regexp\")) ||\r\n          (command === \"grep\" && token === \"-e\");\r\n\r\n        if (isExplicitPatternFlag) {\r\n          const nextToken = args[i + 1];\r\n          if (nextToken !== undefined) {\r\n            pattern = nextToken;\r\n            i++;\r\n          }\r\n          continue;\r\n        }\r\n\r\n        // Support the compact form: -ePATTERN\r\n        if (token.startsWith(\"-e\") && token.length > 2) {\r\n          pattern = token.slice(2);\r\n          continue;\r\n        }\r\n\r\n        const consumesNextArg =\r\n          (command === \"rg\" && rgConsumesNextArg.has(token)) ||\r\n          (command === \"grep\" && grepConsumesNextArg.has(token));\r\n        if (consumesNextArg) {\r\n          i++; // skip the flag value\r\n          continue;\r\n        }\r\n\r\n        continue; // other flags\r\n      }\r\n\r\n      pattern = token;\r\n      continue;\r\n    }\r\n\r\n    tokensAfterPattern.push(token);\r\n  }\r\n\r\n  return { pattern, tokensAfterPattern };\r\n}\r\n\r\nfunction hasFileReadTargetToken(tokensAfterPattern: string[]): boolean {\r\n  let expectInputFile = false;\r\n  let skipNextOutputTarget = false;\r\n\r\n  for (const token of tokensAfterPattern) {\r\n    if (expectInputFile) {\r\n      expectInputFile = false;\r\n      if (token !== \"-\" && token.length > 0) {\r\n        return true;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    if (skipNextOutputTarget) {\r\n      skipNextOutputTarget = false;\r\n      continue;\r\n    }\r\n\r\n    // Input redirection: ... < file OR ... <file\r\n    if (token === \"<\" || token === \"0<\") {\r\n      expectInputFile = true;\r\n      continue;\r\n    }\r\n    const inputMatch = /^(?:0)?<(.+)$/.exec(token);\r\n    if (inputMatch && !token.startsWith(\"<<\") && !token.startsWith(\"<<<\")) {\r\n      const inputFile = inputMatch[1];\r\n      if (inputFile !== \"-\" && inputFile.length > 0) {\r\n        return true;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    // Output redirection: ignore output targets.\r\n    if (\r\n      token === \">\" ||\r\n      token === \">>\" ||\r\n      token === \"1>\" ||\r\n      token === \"1>>\" ||\r\n      token === \"2>\" ||\r\n      token === \"2>>\" ||\r\n      token === \"&>\" ||\r\n      token === \"&>>\"\r\n    ) {\r\n      skipNextOutputTarget = true;\r\n      continue;\r\n    }\r\n\r\n    // Output redirection with attached target (e.g. \">out\", \"2>/dev/null\", \"2>&1\")\r\n    if (/^(?:\\d+|&)?>>?/.test(token)) {\r\n      continue;\r\n    }\r\n\r\n    // Flags and stdin\r\n    if (token === \"-\" || token === \"--\" || token.startsWith(\"-\")) {\r\n      continue;\r\n    }\r\n\r\n    // Remaining non-flag tokens look like file/path operands.\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction detectRipgrepFileDump(script: string): boolean {\r\n  // Fast-path: avoid doing any work if \"rg\" doesn't appear at all.\r\n  if (!script.includes(\"rg\")) {\r\n    return false;\r\n  }\r\n\r\n  const segments = script.split(/\\n|&&|\\|\\||;|\\|/);\r\n  for (const segment of segments) {\r\n    const tokens = segment.trim().split(/\\s+/).filter(Boolean);\r\n    const rgIndex = getRipgrepCommandTokenIndex(tokens);\r\n    if (rgIndex === null) continue;\r\n\r\n    const args = tokens.slice(rgIndex + 1);\r\n    if (args.length === 0) continue;\r\n\r\n    // Ignore heredocs / here-strings (not a file read).\r\n    if (args.some((t) => t.startsWith(\"<<\") || t.startsWith(\"<<<\"))) {\r\n      continue;\r\n    }\r\n\r\n    const { pattern, tokensAfterPattern } = parseSearchCommandArgs(\"rg\", args);\r\n    if (!pattern) continue;\r\n\r\n    if (!isMatchAllSearchPattern(stripOuterQuotes(pattern))) {\r\n      continue;\r\n    }\r\n\r\n    if (hasFileReadTargetToken(tokensAfterPattern)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction detectGrepFileDump(script: string): boolean {\r\n  // Fast-path: avoid doing any work if \"grep\" doesn't appear at all.\r\n  if (!script.includes(\"grep\")) {\r\n    return false;\r\n  }\r\n\r\n  const segments = script.split(/\\n|&&|\\|\\||;|\\|/);\r\n  for (const segment of segments) {\r\n    const tokens = segment.trim().split(/\\s+/).filter(Boolean);\r\n    const grepIndex = getGrepCommandTokenIndex(tokens);\r\n    if (grepIndex === null) continue;\r\n\r\n    const args = tokens.slice(grepIndex + 1);\r\n    if (args.length === 0) continue;\r\n\r\n    // Ignore heredocs / here-strings (not a file read).\r\n    if (args.some((t) => t.startsWith(\"<<\") || t.startsWith(\"<<<\"))) {\r\n      continue;\r\n    }\r\n\r\n    const { pattern, tokensAfterPattern } = parseSearchCommandArgs(\"grep\", args);\r\n    if (!pattern) continue;\r\n\r\n    if (!isMatchAllSearchPattern(stripOuterQuotes(pattern))) {\r\n      continue;\r\n    }\r\n\r\n    if (hasFileReadTargetToken(tokensAfterPattern)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\ntype BashToolForegroundResult = Exclude<BashToolResult, { backgroundProcessId: string }>;\r\n\r\nfunction isForegroundBashToolResult(result: BashToolResult): result is BashToolForegroundResult {\r\n  return !(\"backgroundProcessId\" in result);\r\n}\r\n\r\nfunction addNoticeToBashToolResult(\r\n  result: BashToolResult,\r\n  notice: string | undefined\r\n): BashToolResult {\r\n  if (!notice || !isForegroundBashToolResult(result)) {\r\n    return result;\r\n  }\r\n\r\n  return {\r\n    ...result,\r\n    note: prependToolNote(result.note, notice),\r\n  };\r\n}\r\n\r\n/**\r\n * Validates bash script input for common issues\r\n * Returns error result if validation fails, null if valid\r\n */\r\nfunction validateScript(script: string, config: ToolConfiguration): BashToolResult | null {\r\n  // Check for empty script\r\n  if (!script || script.trim().length === 0) {\r\n    return {\r\n      success: false,\r\n      error: \"Script parameter is empty. This likely indicates a malformed tool call.\",\r\n      exitCode: -1,\r\n      wall_duration_ms: 0,\r\n    };\r\n  }\r\n\r\n  // Detect redundant cd to working directory\r\n  const cdPattern = /^\\s*cd\\s+['\"]?([^'\";&|]+)['\"]?\\s*[;&|]/;\r\n  const match = cdPattern.exec(script);\r\n  if (match) {\r\n    const targetPath = match[1].trim();\r\n    const normalizedTarget = config.runtime.normalizePath(targetPath, config.cwd);\r\n    const normalizedCwd = config.runtime.normalizePath(\".\", config.cwd);\r\n\r\n    if (normalizedTarget === normalizedCwd) {\r\n      return {\r\n        success: false,\r\n        error: `Redundant cd to working directory detected. The tool already runs in ${config.cwd} - no cd needed. Remove the 'cd ${targetPath}' prefix.`,\r\n        exitCode: -1,\r\n        wall_duration_ms: 0,\r\n      };\r\n    }\r\n  }\r\n\r\n  return null; // Valid\r\n}\r\n\r\n/**\r\n * Rewrite cmd.exe-style null-device redirects (e.g. `>nul`, `2>nul`) into `/dev/null`.\r\n *\r\n * Why: mux executes commands via bash (Git Bash on Windows). In bash, `nul` is a normal filename,\r\n * so scripts that try to discard output with `>nul` end up creating a file named `nul` in the\r\n * workspace root.\r\n *\r\n * This is intentionally narrow: only the *redirection target token* `nul`/`NUL` (optionally quoted,\r\n * optionally with a trailing `:`) is rewritten.\r\n */\r\nfunction rewriteWindowsNullRedirects(script: string): { script: string; didRewrite: boolean } {\r\n  let didRewrite = false;\r\n\r\n  let inSingleQuote = false;\r\n  let inDoubleQuote = false;\r\n\r\n  const isEscaped = (index: number): boolean => {\r\n    // Count consecutive backslashes immediately preceding `index`.\r\n    let backslashes = 0;\r\n    for (let i = index - 1; i >= 0 && script[i] === \"\\\\\"; i--) {\r\n      backslashes++;\r\n    }\r\n    return backslashes % 2 === 1;\r\n  };\r\n\r\n  let out = \"\";\r\n  let i = 0;\r\n\r\n  while (i < script.length) {\r\n    const ch = script[i];\r\n\r\n    // Track basic quoting to avoid rewriting inside strings.\r\n    if (!inDoubleQuote && ch === \"'\" && !isEscaped(i)) {\r\n      inSingleQuote = !inSingleQuote;\r\n      out += ch;\r\n      i++;\r\n      continue;\r\n    }\r\n\r\n    if (!inSingleQuote && ch === '\"' && !isEscaped(i)) {\r\n      inDoubleQuote = !inDoubleQuote;\r\n      out += ch;\r\n      i++;\r\n      continue;\r\n    }\r\n\r\n    // Only rewrite when not inside quotes.\r\n    if (!inSingleQuote && !inDoubleQuote) {\r\n      // Skip escaped operators like `\\>nul`.\r\n      if (ch === \">\" && isEscaped(i)) {\r\n        out += ch;\r\n        i++;\r\n        continue;\r\n      }\r\n\r\n      // Parse an output redirection operator at `i`:\r\n      //   >, >>, 1>, 2>>, &>, etc.\r\n      const redirectStart = i;\r\n      let redirectPos = i;\r\n\r\n      // Optional fd specifier (digits) or `&`.\r\n      if (script[redirectPos] === \"&\") {\r\n        redirectPos++;\r\n      } else if (/[0-9]/.test(script[redirectPos] ?? \"\")) {\r\n        const fdStart = redirectPos;\r\n        while (/[0-9]/.test(script[redirectPos] ?? \"\")) {\r\n          redirectPos++;\r\n        }\r\n\r\n        // If the digits aren't directly followed by `>`, this isn't a redirection.\r\n        if (script[redirectPos] !== \">\") {\r\n          redirectPos = fdStart;\r\n        }\r\n      }\r\n\r\n      if (script[redirectPos] === \">\" && !isEscaped(redirectPos)) {\r\n        // Read `>` or `>>`.\r\n        redirectPos++;\r\n        if (script[redirectPos] === \">\") {\r\n          redirectPos++;\r\n        }\r\n\r\n        // Consume whitespace after the operator.\r\n        let targetStart = redirectPos;\r\n        while (targetStart < script.length && /\\s/.test(script[targetStart] ?? \"\")) {\r\n          targetStart++;\r\n        }\r\n\r\n        // Parse target token (quoted or unquoted).\r\n        if (targetStart < script.length) {\r\n          const quote = script[targetStart];\r\n          let token: string | null = null;\r\n          let tokenEnd = targetStart;\r\n\r\n          if (quote === \"'\" || quote === '\"') {\r\n            const quotedStart = targetStart + 1;\r\n            tokenEnd = quotedStart;\r\n\r\n            while (tokenEnd < script.length) {\r\n              const c = script[tokenEnd];\r\n              if (c === quote && !(quote === '\"' && isEscaped(tokenEnd))) {\r\n                break;\r\n              }\r\n              tokenEnd++;\r\n            }\r\n\r\n            if (tokenEnd < script.length && script[tokenEnd] === quote) {\r\n              token = script.slice(quotedStart, tokenEnd);\r\n              tokenEnd++; // include closing quote\r\n            }\r\n          } else {\r\n            while (tokenEnd < script.length) {\r\n              const c = script[tokenEnd];\r\n              if (/\\s/.test(c) || /[;&|()<>]/.test(c)) {\r\n                break;\r\n              }\r\n              tokenEnd++;\r\n            }\r\n\r\n            token = script.slice(targetStart, tokenEnd);\r\n          }\r\n\r\n          const lower = token?.toLowerCase();\r\n          if (lower === \"nul\" || lower === \"nul:\") {\r\n            // Replace the token with /dev/null, preserving operator + whitespace.\r\n            out += script.slice(redirectStart, targetStart) + \"/dev/null\";\r\n            didRewrite = true;\r\n            i = tokenEnd;\r\n            continue;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    out += ch;\r\n    i++;\r\n  }\r\n\r\n  return { script: out, didRewrite };\r\n}\r\n\r\n/**\r\n * Creates a line handler that enforces truncation limits\r\n * Processes lines for both stdout and stderr with identical logic\r\n */\r\nfunction createLineHandler(\r\n  lines: string[],\r\n  totalBytesRef: { current: number },\r\n  limits: {\r\n    maxLineBytes: number;\r\n    maxFileBytes: number;\r\n    maxTotalBytes: number;\r\n    maxLines: number;\r\n  },\r\n  state: {\r\n    displayTruncated: boolean;\r\n    fileTruncated: boolean;\r\n  },\r\n  triggerDisplayTruncation: (reason: string) => void,\r\n  triggerFileTruncation: (reason: string) => void\r\n): (line: string) => void {\r\n  return (line: string) => {\r\n    if (state.fileTruncated) return;\r\n\r\n    const lineBytes = Buffer.byteLength(line, \"utf-8\");\r\n\r\n    // Check if line exceeds per-line limit (hard stop - likely corrupt data)\r\n    if (lineBytes > limits.maxLineBytes) {\r\n      triggerFileTruncation(\r\n        `Line ${lines.length + 1} exceeded per-line limit: ${lineBytes} bytes > ${limits.maxLineBytes} bytes`\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Check file limit BEFORE adding line\r\n    const bytesAfterLine = totalBytesRef.current + lineBytes + 1; // +1 for newline\r\n    if (bytesAfterLine > limits.maxFileBytes) {\r\n      triggerFileTruncation(\r\n        `Total output would exceed file preservation limit: ${bytesAfterLine} bytes > ${limits.maxFileBytes} bytes (at line ${lines.length + 1})`\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Collect line (even if display is truncated, keep for file)\r\n    lines.push(line);\r\n    totalBytesRef.current = bytesAfterLine;\r\n\r\n    // Check display limits (soft stop - keep collecting for file)\r\n    if (!state.displayTruncated) {\r\n      if (totalBytesRef.current > limits.maxTotalBytes) {\r\n        triggerDisplayTruncation(\r\n          `Total output exceeded display limit: ${totalBytesRef.current} bytes > ${limits.maxTotalBytes} bytes (at line ${lines.length})`\r\n        );\r\n        return;\r\n      }\r\n\r\n      if (lines.length >= limits.maxLines) {\r\n        triggerDisplayTruncation(\r\n          `Line count exceeded display limit: ${lines.length} lines >= ${limits.maxLines} lines (${totalBytesRef.current} bytes read)`\r\n        );\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Formats the final bash tool result based on exit code and truncation state\r\n */\r\nfunction formatResult(\r\n  exitCode: number,\r\n  lines: string[],\r\n  truncated: boolean,\r\n  overflowReason: string | null,\r\n  wall_duration_ms: number,\r\n  overflowPolicy: \"tmpfile\" | \"truncate\",\r\n  effectiveTimeout: number\r\n): BashToolResult {\r\n  const output = lines.join(\"\\n\");\r\n\r\n  // Check for special error codes from runtime\r\n  if (exitCode === EXIT_CODE_ABORTED) {\r\n    return {\r\n      success: false,\r\n      error: \"Command execution was aborted\",\r\n      exitCode: -1,\r\n      wall_duration_ms,\r\n    };\r\n  }\r\n\r\n  if (exitCode === EXIT_CODE_TIMEOUT) {\r\n    return {\r\n      success: false,\r\n      error: `Command exceeded timeout of ${effectiveTimeout} seconds. You can increase the timeout by setting the \\`timeout_secs\\` parameter on the tool call. Do not use the \\`timeout\\` bash command to increase the timeout.`,\r\n      exitCode: -1,\r\n      wall_duration_ms,\r\n    };\r\n  }\r\n\r\n  // Handle truncation\r\n  if (truncated) {\r\n    const truncationInfo = {\r\n      reason: overflowReason ?? \"unknown reason\",\r\n      totalLines: lines.length,\r\n    };\r\n\r\n    if (overflowPolicy === \"truncate\") {\r\n      // Return all collected lines with truncation marker\r\n      if (exitCode === 0) {\r\n        return {\r\n          success: true,\r\n          output,\r\n          exitCode: 0,\r\n          wall_duration_ms,\r\n          truncated: truncationInfo,\r\n        };\r\n      } else {\r\n        return {\r\n          success: false,\r\n          output,\r\n          exitCode,\r\n          error: `Command exited with code ${exitCode}`,\r\n          wall_duration_ms,\r\n          truncated: truncationInfo,\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  // Normal exit\r\n  if (exitCode === 0) {\r\n    return {\r\n      success: true,\r\n      output,\r\n      exitCode: 0,\r\n      wall_duration_ms,\r\n    };\r\n  } else {\r\n    return {\r\n      success: false,\r\n      output,\r\n      exitCode,\r\n      error: `Command exited with code ${exitCode}`,\r\n      wall_duration_ms,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Shell-escape a string for safe use in bash commands (single-quote wrapping).\r\n */\r\nfunction shellEscape(str: string): string {\r\n  return `'${str.replace(/'/g, \"'\\\\''\")}'`;\r\n}\r\n\r\n/**\r\n * Build script prelude that sources .mux/tool_env if present.\r\n * Returns empty string if no tool_env path is provided.\r\n */\r\nfunction buildToolEnvPrelude(toolEnvPath: string | null): string {\r\n  if (!toolEnvPath) return \"\";\r\n  // Source the tool_env file; fail with clear error if sourcing fails\r\n  return `if ! source ${shellEscape(toolEnvPath)} 2>&1; then\r\n  echo \"mux: failed to source ${toolEnvPath}\" >&2\r\n  exit 1\r\nfi\r\n`;\r\n}\r\n\r\n/**\r\n * Bash execution tool factory for AI assistant\r\n * Creates a bash tool that can execute commands with a configurable timeout\r\n * @param config Required configuration including working directory\r\n */\r\nexport const createBashTool: ToolFactory = (config: ToolConfiguration) => {\r\n  // Select limits based on overflow policy\r\n  // truncate = IPC calls (generous limits for UI features, no line limit, no per-line limit)\r\n  // tmpfile = AI agent calls (conservative limits for LLM context)\r\n  const overflowPolicy = config.overflow_policy ?? \"tmpfile\";\r\n  const maxTotalBytes =\r\n    overflowPolicy === \"truncate\" ? BASH_TRUNCATE_MAX_TOTAL_BYTES : BASH_MAX_TOTAL_BYTES;\r\n  const maxFileBytes =\r\n    overflowPolicy === \"truncate\" ? BASH_TRUNCATE_MAX_FILE_BYTES : BASH_MAX_FILE_BYTES;\r\n  const maxLines = overflowPolicy === \"truncate\" ? Infinity : BASH_HARD_MAX_LINES;\r\n  const maxLineBytes = overflowPolicy === \"truncate\" ? Infinity : BASH_MAX_LINE_BYTES;\r\n\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.bash.description + \"\\nRuns in \" + config.cwd + \" - no cd needed\",\r\n    inputSchema: TOOL_DEFINITIONS.bash.schema,\r\n    execute: async (\r\n      { script, timeout_secs, run_in_background, display_name },\r\n      { abortSignal, toolCallId }\r\n    ): Promise<BashToolResult> => {\r\n      // Validate script input\r\n\r\n      // Treat display_name as untrusted input: it ends up in filesystem paths.\r\n      const safeDisplayName = resolveBashDisplayName(script, display_name);\r\n      const validationError = validateScript(script, config);\r\n      if (validationError) return validationError;\r\n\r\n      // Warn when the model appears to be reading files via bash output (cat/rg/grep).\r\n      // Reading files via bash output is fragile (may be truncated or auto-filtered);\r\n      // file_read supports paging and avoids silent context loss.\r\n      const fileReadNotice =\r\n        detectCatFileRead(script) || detectRipgrepFileDump(script) || detectGrepFileDump(script)\r\n          ? CAT_FILE_READ_NOTICE\r\n          : undefined;\r\n\r\n      // Look up .mux/tool_env to source before script (for direnv, nvm, venv, etc.)\r\n      const toolEnvPath = config.runtime ? await getToolEnvPath(config.runtime, config.cwd) : null;\r\n      const toolEnvPrelude = buildToolEnvPrelude(toolEnvPath);\r\n\r\n      // On Windows, models sometimes emit cmd.exe-style `>nul` / `2>nul` redirections.\r\n      // Since the bash tool runs via bash, `nul` becomes a real file in the workspace.\r\n      // Only rewrite for local Windows runtimes so non-Windows scripts keep their semantics.\r\n      const shouldRewriteNullRedirects =\r\n        process.platform === \"win32\" && config.runtime instanceof LocalBaseRuntime;\r\n      const nulRedirectRewrite = shouldRewriteNullRedirects\r\n        ? rewriteWindowsNullRedirects(script)\r\n        : { script, didRewrite: false };\r\n      const scriptWithEnv = toolEnvPrelude + nulRedirectRewrite.script;\r\n\r\n      const nulRedirectNote = nulRedirectRewrite.didRewrite\r\n        ? \"Rewrote `>nul`/`2>nul`  `/dev/null` (bash tool runs in bash; use `/dev/null` to discard output).\"\r\n        : undefined;\r\n\r\n      // Handle explicit background execution (run_in_background=true)\r\n      const withNotice = (result: BashToolResult): BashToolResult =>\r\n        addNoticeToBashToolResult(\r\n          addNoticeToBashToolResult(result, nulRedirectNote),\r\n          fileReadNotice\r\n        );\r\n\r\n      if (run_in_background) {\r\n        if (!config.workspaceId || !config.backgroundProcessManager || !config.runtime) {\r\n          return withNotice({\r\n            success: false,\r\n            error:\r\n              \"Background execution is only available for AI tool calls, not direct IPC invocation\",\r\n            exitCode: -1,\r\n            wall_duration_ms: 0,\r\n          });\r\n        }\r\n\r\n        const startTime = performance.now();\r\n        const spawnResult = await config.backgroundProcessManager.spawn(\r\n          config.runtime,\r\n          config.workspaceId,\r\n          scriptWithEnv,\r\n          {\r\n            cwd: config.cwd,\r\n            // Match foreground bash behavior: muxEnv is present and secrets override it.\r\n            env: { ...(config.muxEnv ?? {}), ...(config.secrets ?? {}) },\r\n            displayName: safeDisplayName,\r\n            isForeground: false, // Explicit background\r\n            timeoutSecs: timeout_secs, // Auto-terminate after this duration\r\n          }\r\n        );\r\n\r\n        if (!spawnResult.success) {\r\n          return withNotice({\r\n            success: false,\r\n            error: spawnResult.error,\r\n            exitCode: -1,\r\n            wall_duration_ms: Math.round(performance.now() - startTime),\r\n          });\r\n        }\r\n\r\n        return withNotice({\r\n          success: true,\r\n          output: `Background process started with ID: ${spawnResult.processId}`,\r\n          exitCode: 0,\r\n          wall_duration_ms: Math.round(performance.now() - startTime),\r\n          taskId: toBashTaskId(spawnResult.processId),\r\n          backgroundProcessId: spawnResult.processId,\r\n        });\r\n      }\r\n\r\n      // Setup execution parameters\r\n      const effectiveTimeout = timeout_secs ?? BASH_DEFAULT_TIMEOUT_SECS;\r\n      const startTime = performance.now();\r\n      const totalBytesRef = { current: 0 }; // Use ref for shared access in line handler\r\n      let overflowReason: string | null = null;\r\n      const truncationState = { displayTruncated: false, fileTruncated: false };\r\n\r\n      // Track backgrounding state\r\n      const backgroundedRef: { current: boolean } = { current: false };\r\n      let foregroundCompleted = false;\r\n      let backgroundResolve: (() => void) | null = null;\r\n      const backgroundPromise = new Promise<void>((resolve) => {\r\n        backgroundResolve = resolve;\r\n      });\r\n\r\n      // Wrap abort signal so we can detach when migrating to background.\r\n      // When detached, the original stream abort won't kill the process.\r\n      const wrappedAbortController = new AbortController();\r\n      let abortDetached = false;\r\n      if (abortSignal) {\r\n        abortSignal.addEventListener(\"abort\", () => {\r\n          if (!abortDetached) {\r\n            wrappedAbortController.abort();\r\n          }\r\n        });\r\n      }\r\n\r\n      // Register foreground process for \"send to background\" feature\r\n      // Only if manager is available (AI tool calls, not IPC)\r\n      const fgRegistration =\r\n        config.backgroundProcessManager && config.workspaceId && toolCallId\r\n          ? config.backgroundProcessManager.registerForegroundProcess(\r\n              config.workspaceId,\r\n              toolCallId,\r\n              script,\r\n              safeDisplayName,\r\n              () => {\r\n                backgroundedRef.current = true;\r\n                // Resolve the background promise to unblock the wait\r\n                if (backgroundResolve) backgroundResolve();\r\n              }\r\n            )\r\n          : null;\r\n\r\n      // Execute using runtime interface (works for both local and SSH)\r\n      const scriptWithClosedStdin = `exec </dev/null\r\n${scriptWithEnv}`;\r\n      const execStream = await config.runtime.exec(scriptWithClosedStdin, {\r\n        cwd: config.cwd,\r\n        env: { ...config.muxEnv, ...config.secrets, ...NON_INTERACTIVE_ENV_VARS },\r\n        timeout: effectiveTimeout,\r\n        abortSignal: wrappedAbortController.signal,\r\n      });\r\n\r\n      let exitCodeResolved = false;\r\n      const exitCodePromise = execStream.exitCode.then((code) => {\r\n        exitCodeResolved = true;\r\n        return code;\r\n      });\r\n\r\n      // Force-close stdin immediately - we don't need to send any input\r\n      // Use abort() instead of close() for immediate, synchronous closure\r\n      // close() is async and waits for acknowledgment, which can hang over SSH\r\n      // abort() immediately marks stream as errored and releases locks\r\n      execStream.stdin.abort().catch(() => {\r\n        /* ignore */ return;\r\n      });\r\n\r\n      // Tee streams so we can migrate to background if needed\r\n      // One branch goes to line handler (UI), other is held for potential migration\r\n      const [stdoutForUI, stdoutForMigration] = execStream.stdout.tee();\r\n      const [stderrForUI, stderrForMigration] = execStream.stderr.tee();\r\n\r\n      // Collect output concurrently from Web Streams to avoid readline race conditions.\r\n      const lines: string[] = [];\r\n      let truncated = false;\r\n\r\n      // Helper to trigger display truncation (stop showing to agent, keep collecting)\r\n      const triggerDisplayTruncation = (reason: string) => {\r\n        truncationState.displayTruncated = true;\r\n        truncated = true;\r\n        overflowReason = reason;\r\n        // Don't kill process yet - keep collecting up to file limit\r\n      };\r\n\r\n      // Helper to trigger file truncation (stop collecting, close streams)\r\n      const triggerFileTruncation = (reason: string) => {\r\n        truncationState.fileTruncated = true;\r\n        truncationState.displayTruncated = true;\r\n        truncated = true;\r\n        overflowReason = reason;\r\n        // Cancel all stream branches to stop the process and unblock readers\r\n        stdoutForUI.cancel().catch(() => {\r\n          /* ignore */ return;\r\n        });\r\n        stderrForUI.cancel().catch(() => {\r\n          /* ignore */ return;\r\n        });\r\n        stdoutForMigration.cancel().catch(() => {\r\n          /* ignore */ return;\r\n        });\r\n        stderrForMigration.cancel().catch(() => {\r\n          /* ignore */ return;\r\n        });\r\n      };\r\n\r\n      // Create unified line handler for both stdout and stderr\r\n      const lineHandler = createLineHandler(\r\n        lines,\r\n        totalBytesRef,\r\n        { maxLineBytes, maxFileBytes, maxTotalBytes, maxLines },\r\n        truncationState,\r\n        triggerDisplayTruncation,\r\n        triggerFileTruncation\r\n      );\r\n\r\n      // UI-only incremental output streaming over workspace.onChat (not sent to the model).\r\n      // We flush chunked text rather than per-line to keep overhead low.\r\n      let liveOutputStopped = false;\r\n      let liveStdoutBuffer = \"\";\r\n      let liveStderrBuffer = \"\";\r\n      let liveOutputTimer: ReturnType<typeof setInterval> | null = null;\r\n\r\n      const LIVE_FLUSH_INTERVAL_MS = 75;\r\n      const MAX_LIVE_EVENT_CHARS = 32_768;\r\n\r\n      const emitBashOutput = (isError: boolean, text: string): void => {\r\n        if (!config.emitChatEvent || !config.workspaceId || !toolCallId) return;\r\n        if (liveOutputStopped) return;\r\n        if (text.length === 0) return;\r\n\r\n        config.emitChatEvent({\r\n          type: \"bash-output\",\r\n          workspaceId: config.workspaceId,\r\n          toolCallId,\r\n          text,\r\n          isError,\r\n          timestamp: Date.now(),\r\n        } satisfies BashOutputEvent);\r\n      };\r\n\r\n      const flushLiveOutput = (): void => {\r\n        if (liveOutputStopped) return;\r\n\r\n        const flush = (isError: boolean, buffer: string): void => {\r\n          if (buffer.length === 0) return;\r\n          for (let i = 0; i < buffer.length; i += MAX_LIVE_EVENT_CHARS) {\r\n            emitBashOutput(isError, buffer.slice(i, i + MAX_LIVE_EVENT_CHARS));\r\n          }\r\n        };\r\n\r\n        if (liveStdoutBuffer.length > 0) {\r\n          const buf = liveStdoutBuffer;\r\n          liveStdoutBuffer = \"\";\r\n          flush(false, buf);\r\n        }\r\n\r\n        if (liveStderrBuffer.length > 0) {\r\n          const buf = liveStderrBuffer;\r\n          liveStderrBuffer = \"\";\r\n          flush(true, buf);\r\n        }\r\n      };\r\n\r\n      const stopLiveOutput = (flush: boolean): void => {\r\n        if (liveOutputStopped) return;\r\n        if (flush) flushLiveOutput();\r\n\r\n        liveOutputStopped = true;\r\n\r\n        if (liveOutputTimer) {\r\n          clearInterval(liveOutputTimer);\r\n          liveOutputTimer = null;\r\n        }\r\n\r\n        liveStdoutBuffer = \"\";\r\n        liveStderrBuffer = \"\";\r\n      };\r\n\r\n      if (config.emitChatEvent && config.workspaceId && toolCallId) {\r\n        liveOutputTimer = setInterval(flushLiveOutput, LIVE_FLUSH_INTERVAL_MS);\r\n      }\r\n\r\n      const appendLiveOutput = (isError: boolean, text: string): void => {\r\n        if (!config.emitChatEvent || !config.workspaceId || !toolCallId) return;\r\n        if (liveOutputStopped) return;\r\n        if (text.length === 0) return;\r\n\r\n        if (isError) {\r\n          liveStderrBuffer += text;\r\n          if (liveStderrBuffer.length >= MAX_LIVE_EVENT_CHARS) flushLiveOutput();\r\n        } else {\r\n          liveStdoutBuffer += text;\r\n          if (liveStdoutBuffer.length >= MAX_LIVE_EVENT_CHARS) flushLiveOutput();\r\n        }\r\n      };\r\n\r\n      // Consume a ReadableStream<Uint8Array> and emit lines to lineHandler.\r\n      // Uses TextDecoder streaming to preserve multibyte boundaries.\r\n      const consumeStream = async (\r\n        stream: ReadableStream<Uint8Array>,\r\n        isError: boolean\r\n      ): Promise<void> => {\r\n        const reader = stream.getReader();\r\n        const decoder = new TextDecoder(\"utf-8\");\r\n        let carry = \"\";\r\n\r\n        // Set up abort handler to cancel reader when abort signal fires\r\n        // This interrupts reader.read() if it's blocked, preventing hangs\r\n        const abortHandler = () => {\r\n          reader.cancel().catch(() => {\r\n            /* ignore - reader may already be closed */\r\n          });\r\n        };\r\n        abortSignal?.addEventListener(\"abort\", abortHandler);\r\n\r\n        try {\r\n          while (true) {\r\n            if (truncationState.fileTruncated) {\r\n              // Stop early if we already hit hard limits\r\n              await reader.cancel().catch(() => {\r\n                /* ignore */ return;\r\n              });\r\n              break;\r\n            }\r\n            const { value, done } = await reader.read();\r\n            if (done) break;\r\n            // Decode chunk (streaming keeps partial code points)\r\n            const text = decoder.decode(value, { stream: true });\r\n            appendLiveOutput(isError, text);\r\n            carry += text;\r\n\r\n            // Split into lines; support both \\n and \\r\\n\r\n            let start = 0;\r\n            while (true) {\r\n              const idxN = carry.indexOf(\"\\n\", start);\r\n              const idxR = carry.indexOf(\"\\r\", start);\r\n              let nextIdx = -1;\r\n              if (idxN === -1 && idxR === -1) break;\r\n              nextIdx = idxN === -1 ? idxR : idxR === -1 ? idxN : Math.min(idxN, idxR);\r\n              const line = carry.slice(0, nextIdx).replace(/\\r$/, \"\");\r\n              lineHandler(line);\r\n              carry = carry.slice(nextIdx + 1);\r\n              start = 0;\r\n              if (truncationState.fileTruncated) {\r\n                await reader.cancel().catch(() => {\r\n                  /* ignore */ return;\r\n                });\r\n                break;\r\n              }\r\n            }\r\n\r\n            // Defensive: if output never emits newlines, carry can grow without bound.\r\n            // If the incomplete line already violates hard limits, stop early.\r\n            if (carry.length > 0 && !truncationState.fileTruncated) {\r\n              const carryBytes = Buffer.byteLength(carry, \"utf-8\");\r\n              const bytesAfterCarry = totalBytesRef.current + carryBytes + 1; // +1 for newline\r\n              if (carryBytes > maxLineBytes || bytesAfterCarry > maxFileBytes) {\r\n                // Delegate to lineHandler to keep truncation reasons consistent.\r\n                lineHandler(carry);\r\n                if (truncationState.fileTruncated) {\r\n                  await reader.cancel().catch(() => {\r\n                    /* ignore */ return;\r\n                  });\r\n                  break;\r\n                }\r\n              }\r\n            }\r\n            if (truncationState.fileTruncated) break;\r\n          }\r\n        } finally {\r\n          // Clean up abort listener\r\n          abortSignal?.removeEventListener(\"abort\", abortHandler);\r\n\r\n          // Flush decoder for any trailing bytes and emit the last line (if any)\r\n          try {\r\n            const tail = decoder.decode();\r\n            if (tail) {\r\n              appendLiveOutput(isError, tail);\r\n              carry += tail;\r\n            }\r\n            if (carry.length > 0 && !truncationState.fileTruncated) {\r\n              lineHandler(carry);\r\n            }\r\n          } catch {\r\n            // ignore decoder errors on flush\r\n          }\r\n        }\r\n      };\r\n\r\n      // Start consuming stdout and stderr concurrently (using UI branches)\r\n      const consumeStdout = consumeStream(stdoutForUI, false);\r\n      const consumeStderr = consumeStream(stderrForUI, true);\r\n\r\n      // Wait for process exit and stream consumption concurrently\r\n      // Also race with the background promise to detect early return request\r\n      const foregroundCompletion = Promise.all([\r\n        exitCodePromise,\r\n        consumeStdout,\r\n        consumeStderr,\r\n      ]).then((value) => {\r\n        foregroundCompleted = true;\r\n        return value;\r\n      });\r\n\r\n      // Attach a no-op rejection handler to prevent Node's unhandled rejection warning.\r\n      void foregroundCompletion.catch(() => undefined);\r\n\r\n      // If the user clicks \"Background\" right as the process is exiting, we can end up\r\n      // racing the background request against stream draining. In that case, prefer the\r\n      // normal completion path so we don't drop any last-millisecond output (especially\r\n      // on Windows, where stream/exit events can arrive slightly out of order).\r\n      const BACKGROUND_EXIT_GRACE_MS = 100;\r\n\r\n      let exitCode: number;\r\n      try {\r\n        const result = await Promise.race([\r\n          foregroundCompletion,\r\n          backgroundPromise.then(() => \"backgrounded\" as const),\r\n        ]);\r\n\r\n        const shouldBackground =\r\n          result === \"backgrounded\" || (backgroundedRef.current && !foregroundCompleted);\r\n\r\n        // If the process already exited, drain the foreground streams for reliable output\r\n        // instead of backgrounding based on timing.\r\n        if (shouldBackground) {\r\n          const didExit =\r\n            exitCodeResolved ||\r\n            (await Promise.race([\r\n              execStream.exitCode.then(() => true).catch(() => true),\r\n              new Promise<boolean>((resolve) =>\r\n                setTimeout(() => resolve(false), BACKGROUND_EXIT_GRACE_MS)\r\n              ),\r\n            ]));\r\n\r\n          if (didExit) {\r\n            const completed = await foregroundCompletion;\r\n            exitCode = completed[0];\r\n          } else {\r\n            // Detach from abort signal as early as possible - process should continue running\r\n            // even when the stream ends and fires abort.\r\n            abortDetached = true;\r\n\r\n            // Unregister foreground process\r\n            fgRegistration?.unregister();\r\n\r\n            // Stop UI-only output streaming before migrating to background.\r\n            stopLiveOutput(true);\r\n\r\n            // Stop consuming UI stream branches - further output should be handled by bash_output.\r\n            stdoutForUI.cancel().catch(() => {\r\n              /* ignore */ return;\r\n            });\r\n            stderrForUI.cancel().catch(() => {\r\n              /* ignore */ return;\r\n            });\r\n\r\n            // Avoid unhandled promise rejections if the cancelled UI readers cause\r\n            // the foreground consumption promise to reject after we return.\r\n            void foregroundCompletion.catch(() => undefined);\r\n\r\n            const wall_duration_ms = Math.round(performance.now() - startTime);\r\n\r\n            // Migrate to background tracking if manager is available\r\n            if (config.backgroundProcessManager && config.workspaceId) {\r\n              const processId =\r\n                config.backgroundProcessManager.generateUniqueProcessId(safeDisplayName);\r\n\r\n              // Create a synthetic ExecStream for the migration streams\r\n              // The UI streams are still being consumed, migration streams continue to files\r\n              const migrationStream = {\r\n                stdout: stdoutForMigration,\r\n                stderr: stderrForMigration,\r\n                stdin: execStream.stdin,\r\n                exitCode: execStream.exitCode,\r\n                duration: execStream.duration,\r\n              };\r\n\r\n              const migrateResult = await migrateToBackground(\r\n                migrationStream,\r\n                {\r\n                  cwd: config.cwd,\r\n                  workspaceId: config.workspaceId,\r\n                  processId,\r\n                  script,\r\n                  existingOutput: lines,\r\n                },\r\n                config.backgroundProcessManager.getBgOutputDir()\r\n              );\r\n\r\n              if (migrateResult.success) {\r\n                // Register the migrated process with the manager\r\n                config.backgroundProcessManager.registerMigratedProcess(\r\n                  migrateResult.handle,\r\n                  processId,\r\n                  config.workspaceId,\r\n                  script,\r\n                  migrateResult.outputDir,\r\n                  safeDisplayName\r\n                );\r\n\r\n                return withNotice({\r\n                  success: true,\r\n                  output: `Process sent to background with ID: ${processId}\\n\\nOutput so far (${lines.length} lines):\\n${lines.slice(-20).join(\"\\n\")}${lines.length > 20 ? \"\\n...(showing last 20 lines)\" : \"\"}`,\r\n                  exitCode: 0,\r\n                  wall_duration_ms,\r\n                  taskId: toBashTaskId(processId),\r\n                  backgroundProcessId: processId,\r\n                });\r\n              }\r\n              // Migration failed, fall through to simple return\r\n            }\r\n\r\n            // Fallback: return without process ID (no manager or migration failed)\r\n            return withNotice({\r\n              success: true,\r\n              output: `Process sent to background. It will continue running.\\n\\nOutput so far (${lines.length} lines):\\n${lines.slice(-20).join(\"\\n\")}${lines.length > 20 ? \"\\n...(showing last 20 lines)\" : \"\"}`,\r\n              exitCode: 0,\r\n              wall_duration_ms,\r\n            });\r\n          }\r\n        } else {\r\n          // Normal completion - extract exit code\r\n          exitCode = result[0];\r\n        }\r\n      } catch (err: unknown) {\r\n        // Unregister on error\r\n        fgRegistration?.unregister();\r\n\r\n        // Check if this was an abort\r\n        if (abortSignal?.aborted) {\r\n          return withNotice({\r\n            success: false,\r\n            error: \"Command execution was aborted\",\r\n            exitCode: -1,\r\n            wall_duration_ms: Math.round(performance.now() - startTime),\r\n          });\r\n        }\r\n        return withNotice({\r\n          success: false,\r\n          error: `Failed to execute command: ${err instanceof Error ? err.message : String(err)}`,\r\n          exitCode: -1,\r\n          wall_duration_ms: Math.round(performance.now() - startTime),\r\n        });\r\n      } finally {\r\n        stopLiveOutput(true);\r\n      }\r\n\r\n      // Unregister foreground process on normal completion\r\n      fgRegistration?.unregister();\r\n\r\n      // Check if command was aborted (exitCode will be EXIT_CODE_ABORTED = -997)\r\n      // This can happen if abort signal fired after Promise.all resolved but before we check\r\n      if (abortSignal?.aborted) {\r\n        return withNotice({\r\n          success: false,\r\n          error: \"Command execution was aborted\",\r\n          exitCode: -1,\r\n          wall_duration_ms: Math.round(performance.now() - startTime),\r\n        });\r\n      }\r\n\r\n      // Round to integer to preserve tokens\r\n      const wall_duration_ms = Math.round(performance.now() - startTime);\r\n\r\n      // Handle tmpfile overflow policy separately (writes to file)\r\n      if (truncated && (config.overflow_policy ?? \"tmpfile\") === \"tmpfile\") {\r\n        // tmpfile policy: Save overflow output to temp file and return a successful response.\r\n        // We don't show ANY of the actual output to avoid overwhelming context.\r\n        // Instead, save it to a temp file and encourage the agent to use filtering tools.\r\n        const truncationInfo = {\r\n          reason: overflowReason ?? \"unknown reason\",\r\n          totalLines: lines.length,\r\n        };\r\n        try {\r\n          // Use 8 hex characters for short, memorable temp file IDs\r\n          const fileId = Math.random().toString(16).substring(2, 10);\r\n          // Write to runtime temp directory (managed by StreamManager).\r\n          // Use path.posix.join to preserve forward slashes:\r\n          // - SSH runtime needs POSIX-style paths\r\n          // - Windows local runtime uses drive-qualified paths like C:/Users/... (also with /)\r\n          const overflowPath = path.posix.join(config.runtimeTempDir, `bash-${fileId}.txt`);\r\n          const fullOutput = lines.join(\"\\n\");\r\n\r\n          // Use runtime.writeFile() for SSH support\r\n          const writer = config.runtime.writeFile(overflowPath, abortSignal);\r\n          const encoder = new TextEncoder();\r\n          const writerInstance = writer.getWriter();\r\n          await writerInstance.write(encoder.encode(fullOutput));\r\n          await writerInstance.close();\r\n\r\n          const noticeBase = `[OUTPUT OVERFLOW - ${overflowReason ?? \"unknown reason\"}]\r\n\r\nFull output (${lines.length} lines) saved to ${overflowPath}\r\n\r\nUse selective filtering tools (e.g. grep) to extract relevant information and continue your task\r\n\r\nFile will be automatically cleaned up when stream ends.`;\r\n\r\n          return withNotice({\r\n            success: true,\r\n            output: \"\",\r\n            note: noticeBase,\r\n            exitCode: 0,\r\n            wall_duration_ms,\r\n            truncated: truncationInfo,\r\n          });\r\n        } catch (err) {\r\n          // If temp file creation fails, fall back to original error\r\n          return withNotice({\r\n            success: false,\r\n            error: `Command output overflow: ${overflowReason ?? \"unknown reason\"}. Failed to save overflow to temp file: ${String(err)}`,\r\n            exitCode: -1,\r\n            wall_duration_ms,\r\n          });\r\n        }\r\n      }\r\n\r\n      // Format result based on exit code and truncation state\r\n      return withNotice(\r\n        formatResult(\r\n          exitCode,\r\n          lines,\r\n          truncated,\r\n          overflowReason,\r\n          wall_duration_ms,\r\n          config.overflow_policy ?? \"tmpfile\",\r\n          effectiveTimeout\r\n        )\r\n      );\r\n    },\r\n  });\r\n};\r\n"]}