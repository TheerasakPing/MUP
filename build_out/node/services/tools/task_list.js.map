{"version":3,"file":"task_list.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task_list.ts"],"names":[],"mappings":";;;AAAA,2BAA0B;AAG1B,0EAAkG;AAElG,qCAAwC;AACxC,2CAAsF;AAEtF,MAAM,gBAAgB,GAAG,CAAC,QAAQ,EAAE,SAAS,EAAE,iBAAiB,CAAU,CAAC;AAEpE,MAAM,kBAAkB,GAAgB,CAAC,MAAyB,EAAE,EAAE,CAAC;IAC5E,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,SAAS,CAAC,WAAW;QACnD,WAAW,EAAE,kCAAgB,CAAC,SAAS,CAAC,MAAM;QAC9C,OAAO,EAAE,KAAK,EAAE,IAAI,EAAoB,EAAE,CAAC;YACzC,MAAM,WAAW,GAAG,IAAA,8BAAkB,EAAC,MAAM,EAAE,WAAW,CAAC,CAAC;YAC5D,MAAM,WAAW,GAAG,IAAA,8BAAkB,EAAC,MAAM,EAAE,WAAW,CAAC,CAAC;YAE5D,MAAM,QAAQ,GACZ,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,GAAG,gBAAgB,CAAC,CAAC;YAEpF,MAAM,UAAU,GAAG,WAAW,CAAC,wBAAwB,CAAC,WAAW,EAAE,EAAE,QAAQ,EAAE,CAAC,CAAC;YACnF,MAAM,KAAK,GAAG,CAAC,GAAG,UAAU,CAAC,CAAC;YAE9B,IAAI,MAAM,CAAC,wBAAwB,EAAE,CAAC;gBACpC,MAAM,kBAAkB,GAAG,IAAI,GAAG,EAAkB,CAAC;gBACrD,kBAAkB,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC,CAAC,CAAC;gBACvC,KAAK,MAAM,CAAC,IAAI,UAAU,EAAE,CAAC;oBAC3B,kBAAkB,CAAC,GAAG,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC;gBAC5C,CAAC;gBAED,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,wBAAwB,CAAC,IAAI,EAAE,CAAC;gBAC/D,KAAK,MAAM,IAAI,IAAI,SAAS,EAAE,CAAC;oBAC7B,MAAM,OAAO,GACX,IAAI,CAAC,WAAW,KAAK,WAAW;wBAChC,CAAC,MAAM,WAAW,CAAC,qBAAqB,CAAC,WAAW,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;oBAC3E,IAAI,CAAC,OAAO;wBAAE,SAAS;oBAEvB,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,KAAK,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,UAAU,CAAC;oBAClE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;wBAAE,SAAS;oBAEzC,MAAM,WAAW,GAAG,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;oBAClE,KAAK,CAAC,IAAI,CAAC;wBACT,MAAM,EAAE,IAAA,qBAAY,EAAC,IAAI,CAAC,EAAE,CAAC;wBAC7B,MAAM;wBACN,iBAAiB,EAAE,IAAI,CAAC,WAAW;wBACnC,KAAK,EAAE,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,EAAE;wBAClC,SAAS,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,WAAW,EAAE;wBACjD,KAAK,EAAE,WAAW,GAAG,CAAC;qBACvB,CAAC,CAAC;gBACL,CAAC;YACH,CAAC;YAED,OAAO,IAAA,2BAAe,EAAC,0CAAwB,EAAE,EAAE,KAAK,EAAE,EAAE,WAAW,CAAC,CAAC;QAAA,CAC1E;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AA9CW,QAAA,kBAAkB,GAAlB,kBAAkB,CA8C7B","sourcesContent":["import { tool } from \"ai\";\r\n\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TaskListToolResultSchema, TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\n\r\nimport { toBashTaskId } from \"./taskId\";\r\nimport { parseToolResult, requireTaskService, requireWorkspaceId } from \"./toolUtils\";\r\n\r\nconst DEFAULT_STATUSES = [\"queued\", \"running\", \"awaiting_report\"] as const;\r\n\r\nexport const createTaskListTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.task_list.description,\r\n    inputSchema: TOOL_DEFINITIONS.task_list.schema,\r\n    execute: async (args): Promise<unknown> => {\r\n      const workspaceId = requireWorkspaceId(config, \"task_list\");\r\n      const taskService = requireTaskService(config, \"task_list\");\r\n\r\n      const statuses =\r\n        args.statuses && args.statuses.length > 0 ? args.statuses : [...DEFAULT_STATUSES];\r\n\r\n      const agentTasks = taskService.listDescendantAgentTasks(workspaceId, { statuses });\r\n      const tasks = [...agentTasks];\r\n\r\n      if (config.backgroundProcessManager) {\r\n        const depthByWorkspaceId = new Map<string, number>();\r\n        depthByWorkspaceId.set(workspaceId, 0);\r\n        for (const t of agentTasks) {\r\n          depthByWorkspaceId.set(t.taskId, t.depth);\r\n        }\r\n\r\n        const processes = await config.backgroundProcessManager.list();\r\n        for (const proc of processes) {\r\n          const inScope =\r\n            proc.workspaceId === workspaceId ||\r\n            (await taskService.isDescendantAgentTask(workspaceId, proc.workspaceId));\r\n          if (!inScope) continue;\r\n\r\n          const status = proc.status === \"running\" ? \"running\" : \"reported\";\r\n          if (!statuses.includes(status)) continue;\r\n\r\n          const parentDepth = depthByWorkspaceId.get(proc.workspaceId) ?? 0;\r\n          tasks.push({\r\n            taskId: toBashTaskId(proc.id),\r\n            status,\r\n            parentWorkspaceId: proc.workspaceId,\r\n            title: proc.displayName ?? proc.id,\r\n            createdAt: new Date(proc.startTime).toISOString(),\r\n            depth: parentDepth + 1,\r\n          });\r\n        }\r\n      }\r\n\r\n      return parseToolResult(TaskListToolResultSchema, { tasks }, \"task_list\");\r\n    },\r\n  });\r\n};\r\n"]}