{"version":3,"file":"propose_plan.js","sourceRoot":"","sources":["../../../../src/node/services/tools/propose_plan.ts"],"names":[],"mappings":";;;AAAA,2BAA0B;AAC1B,6BAAwB;AAExB,0EAAwE;AACxE,0DAA8D;AAC9D,oDAAsD;AAEtD,+DAA+D;AAC/D,qFAAqF;AACrF,MAAM,iBAAiB,GAAG,OAAC,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;AAEvC;;;;;;;;;GASG;AACI,MAAM,qBAAqB,GAAgB,CAAC,MAAM,EAAE,EAAE,CAAC;IAC5D,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,YAAY,CAAC,WAAW;QACtD,WAAW,EAAE,iBAAiB;QAC9B,OAAO,EAAE,KAAK,IAAI,EAAE,CAAC;YACnB,MAAM,QAAQ,GAAG,MAAM,CAAC,YAAY,CAAC;YAErC,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACd,OAAO;oBACL,OAAO,EAAE,KAAc;oBACvB,KAAK,EAAE,0DAA0D;iBAClE,CAAC;YACJ,CAAC;YAED,wEAAwE;YACxE,IAAI,WAAmB,CAAC;YACxB,IAAI,CAAC;gBACH,WAAW,GAAG,MAAM,IAAA,wBAAc,EAAC,MAAM,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;YAC/D,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBACb,IAAI,GAAG,YAAY,sBAAY,EAAE,CAAC;oBAChC,OAAO;wBACL,OAAO,EAAE,KAAc;wBACvB,KAAK,EAAE,yBAAyB,QAAQ,oEAAoE;qBAC7G,CAAC;gBACJ,CAAC;gBACD,MAAM,GAAG,CAAC;YACZ,CAAC;YAED,IAAI,WAAW,KAAK,EAAE,EAAE,CAAC;gBACvB,OAAO;oBACL,OAAO,EAAE,KAAc;oBACvB,KAAK,EAAE,gBAAgB,QAAQ,wEAAwE;iBACxG,CAAC;YACJ,CAAC;YAED,gDAAgD;YAChD,IAAI,MAAM,CAAC,eAAe,EAAE,CAAC;gBAC3B,IAAI,CAAC;oBACH,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;oBACrD,MAAM,CAAC,eAAe,CAAC,QAAQ,EAAE;wBAC/B,OAAO,EAAE,WAAW;wBACpB,SAAS,EAAE,QAAQ,CAAC,YAAY,CAAC,OAAO,EAAE;qBAC3C,CAAC,CAAC;gBACL,CAAC;gBAAC,MAAM,CAAC;oBACP,4EAA4E;gBAC9E,CAAC;YACH,CAAC;YAED,OAAO;gBACL,OAAO,EAAE,IAAa;gBACtB,QAAQ;gBACR,OAAO,EAAE,2CAA2C;aACrD,CAAC;QAAA,CACH;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AAvDW,QAAA,qBAAqB,GAArB,qBAAqB,CAuDhC","sourcesContent":["import { tool } from \"ai\";\r\nimport { z } from \"zod\";\r\nimport type { ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { readFileString } from \"@/node/utils/runtime/helpers\";\r\nimport { RuntimeError } from \"@/node/runtime/Runtime\";\r\n\r\n// Schema for propose_plan - empty object (no input parameters)\r\n// Defined locally to avoid type inference issues with `as const` in TOOL_DEFINITIONS\r\nconst proposePlanSchema = z.object({});\r\n\r\n/**\r\n * Propose plan tool factory for AI assistant.\r\n * The tool validates the plan file exists and is non-empty.\r\n * If the plan file doesn't exist, it returns an error instructing\r\n * the agent to write the plan first.\r\n *\r\n * Note: Plan content is NOT included in the tool result to save context.\r\n * The plan is already visible via file_edit_* diffs in history, and will be\r\n * included in the mode transition message when switching to exec mode.\r\n */\r\nexport const createProposePlanTool: ToolFactory = (config) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.propose_plan.description,\r\n    inputSchema: proposePlanSchema,\r\n    execute: async () => {\r\n      const planPath = config.planFilePath;\r\n\r\n      if (!planPath) {\r\n        return {\r\n          success: false as const,\r\n          error: \"No plan file path configured. Are you in the plan agent?\",\r\n        };\r\n      }\r\n\r\n      // Read plan file using workspace runtime (works for both local and SSH)\r\n      let planContent: string;\r\n      try {\r\n        planContent = await readFileString(config.runtime, planPath);\r\n      } catch (err) {\r\n        if (err instanceof RuntimeError) {\r\n          return {\r\n            success: false as const,\r\n            error: `No plan file found at ${planPath}. Please write your plan to this file before calling propose_plan.`,\r\n          };\r\n        }\r\n        throw err;\r\n      }\r\n\r\n      if (planContent === \"\") {\r\n        return {\r\n          success: false as const,\r\n          error: `Plan file at ${planPath} is empty. Please write your plan content before calling propose_plan.`,\r\n        };\r\n      }\r\n\r\n      // Record file state for external edit detection\r\n      if (config.recordFileState) {\r\n        try {\r\n          const fileStat = await config.runtime.stat(planPath);\r\n          config.recordFileState(planPath, {\r\n            content: planContent,\r\n            timestamp: fileStat.modifiedTime.getTime(),\r\n          });\r\n        } catch {\r\n          // File stat failed, skip recording (shouldn't happen since we just read it)\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: true as const,\r\n        planPath,\r\n        message: \"Plan proposed. Waiting for user approval.\",\r\n      };\r\n    },\r\n  });\r\n};\r\n"]}