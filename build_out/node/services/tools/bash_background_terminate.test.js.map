{"version":3,"file":"bash_background_terminate.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/bash_background_terminate.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, afterEach } from \"bun:test\";\r\nimport { createBashBackgroundTerminateTool } from \"./bash_background_terminate\";\r\nimport { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport type {\r\n  BashBackgroundTerminateArgs,\r\n  BashBackgroundTerminateResult,\r\n} from \"@/common/types/tools\";\r\nimport { TestTempDir, createTestToolConfig } from \"./testHelpers\";\r\nimport type { ToolExecutionOptions } from \"ai\";\r\nimport * as fs from \"fs/promises\";\r\n\r\nconst mockToolCallOptions: ToolExecutionOptions = {\r\n  toolCallId: \"test-call-id\",\r\n  messages: [],\r\n};\r\n\r\n// Create test runtime\r\nfunction createTestRuntime(): Runtime {\r\n  return new LocalRuntime(process.cwd());\r\n}\r\n\r\n// Workspace IDs used in tests - need cleanup after each test\r\nconst TEST_WORKSPACES = [\"test-workspace\", \"workspace-a\", \"workspace-b\"];\r\n\r\ndescribe(\"bash_background_terminate tool\", () => {\r\n  afterEach(async () => {\r\n    // Clean up output directories from /tmp/mux-bashes/ to prevent test pollution\r\n    for (const ws of TEST_WORKSPACES) {\r\n      await fs.rm(`/tmp/mux-bashes/${ws}`, { recursive: true, force: true }).catch(() => undefined);\r\n    }\r\n  });\r\n  it(\"should return error when manager not available\", async () => {\r\n    const tempDir = new TestTempDir(\"test-bash-bg-term\");\r\n    const config = createTestToolConfig(process.cwd());\r\n    config.runtimeTempDir = tempDir.path;\r\n\r\n    const tool = createBashBackgroundTerminateTool(config);\r\n    const args: BashBackgroundTerminateArgs = {\r\n      process_id: \"bg-test\",\r\n    };\r\n\r\n    const result = (await tool.execute!(\r\n      args,\r\n      mockToolCallOptions\r\n    )) as BashBackgroundTerminateResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Background process manager not available\");\r\n    }\r\n\r\n    tempDir[Symbol.dispose]();\r\n  });\r\n\r\n  it(\"should return error for non-existent process\", async () => {\r\n    const tempDir = new TestTempDir(\"test-bash-bg-term\");\r\n    const manager = new BackgroundProcessManager(tempDir.path);\r\n    const config = createTestToolConfig(process.cwd());\r\n    config.runtimeTempDir = tempDir.path;\r\n    config.backgroundProcessManager = manager;\r\n\r\n    const tool = createBashBackgroundTerminateTool(config);\r\n    const args: BashBackgroundTerminateArgs = {\r\n      process_id: \"bg-nonexistent\",\r\n    };\r\n\r\n    const result = (await tool.execute!(\r\n      args,\r\n      mockToolCallOptions\r\n    )) as BashBackgroundTerminateResult;\r\n\r\n    expect(result.success).toBe(false);\r\n  });\r\n\r\n  it(\"should terminate a running process\", async () => {\r\n    const tempDir = new TestTempDir(\"test-bash-bg-term\");\r\n    const manager = new BackgroundProcessManager(tempDir.path);\r\n    const runtime = createTestRuntime();\r\n    const config = createTestToolConfig(process.cwd(), { sessionsDir: tempDir.path });\r\n    config.runtimeTempDir = tempDir.path;\r\n    config.backgroundProcessManager = manager;\r\n\r\n    // Spawn a long-running process\r\n    const spawnResult = await manager.spawn(runtime, \"test-workspace\", \"sleep 10\", {\r\n      cwd: process.cwd(),\r\n      displayName: \"test\",\r\n    });\r\n\r\n    if (!spawnResult.success) {\r\n      throw new Error(\"Failed to spawn process\");\r\n    }\r\n\r\n    const tool = createBashBackgroundTerminateTool(config);\r\n    const args: BashBackgroundTerminateArgs = {\r\n      process_id: spawnResult.processId,\r\n    };\r\n\r\n    const result = (await tool.execute!(\r\n      args,\r\n      mockToolCallOptions\r\n    )) as BashBackgroundTerminateResult;\r\n\r\n    expect(result.success).toBe(true);\r\n    if (result.success) {\r\n      expect(result.message).toContain(spawnResult.processId);\r\n    }\r\n\r\n    // Verify process is no longer running\r\n    const bgProcess = await manager.getProcess(spawnResult.processId);\r\n    expect(bgProcess?.status).not.toBe(\"running\");\r\n\r\n    await manager.cleanup(\"test-workspace\");\r\n    tempDir[Symbol.dispose]();\r\n  });\r\n\r\n  it(\"should be idempotent (double-terminate succeeds)\", async () => {\r\n    const tempDir = new TestTempDir(\"test-bash-bg-term\");\r\n    const manager = new BackgroundProcessManager(tempDir.path);\r\n    const runtime = createTestRuntime();\r\n    const config = createTestToolConfig(process.cwd(), { sessionsDir: tempDir.path });\r\n    config.runtimeTempDir = tempDir.path;\r\n    config.backgroundProcessManager = manager;\r\n\r\n    // Spawn a process\r\n    const spawnResult = await manager.spawn(runtime, \"test-workspace\", \"sleep 10\", {\r\n      cwd: process.cwd(),\r\n      displayName: \"test\",\r\n    });\r\n\r\n    if (!spawnResult.success) {\r\n      throw new Error(\"Failed to spawn process\");\r\n    }\r\n\r\n    const tool = createBashBackgroundTerminateTool(config);\r\n    const args: BashBackgroundTerminateArgs = {\r\n      process_id: spawnResult.processId,\r\n    };\r\n\r\n    // First termination\r\n    const result1 = (await tool.execute!(\r\n      args,\r\n      mockToolCallOptions\r\n    )) as BashBackgroundTerminateResult;\r\n    expect(result1.success).toBe(true);\r\n\r\n    // Second termination\r\n    const result2 = (await tool.execute!(\r\n      args,\r\n      mockToolCallOptions\r\n    )) as BashBackgroundTerminateResult;\r\n    expect(result2.success).toBe(true);\r\n\r\n    await manager.cleanup(\"test-workspace\");\r\n    tempDir[Symbol.dispose]();\r\n  });\r\n\r\n  it(\"should not terminate processes from other workspaces\", async () => {\r\n    const tempDir = new TestTempDir(\"test-bash-bg-term\");\r\n    const manager = new BackgroundProcessManager(tempDir.path);\r\n    const runtime = createTestRuntime();\r\n\r\n    // Config is for workspace-a\r\n    const config = createTestToolConfig(process.cwd(), {\r\n      workspaceId: \"workspace-a\",\r\n      sessionsDir: tempDir.path,\r\n    });\r\n    config.runtimeTempDir = tempDir.path;\r\n    config.backgroundProcessManager = manager;\r\n\r\n    // Spawn process in workspace-b\r\n    const spawnResult = await manager.spawn(runtime, \"workspace-b\", \"sleep 10\", {\r\n      cwd: process.cwd(),\r\n      displayName: \"test\",\r\n    });\r\n\r\n    if (!spawnResult.success) {\r\n      throw new Error(\"Failed to spawn process\");\r\n    }\r\n\r\n    // Try to terminate from workspace-a (should fail)\r\n    const tool = createBashBackgroundTerminateTool(config);\r\n    const args: BashBackgroundTerminateArgs = {\r\n      process_id: spawnResult.processId,\r\n    };\r\n\r\n    const result = (await tool.execute!(\r\n      args,\r\n      mockToolCallOptions\r\n    )) as BashBackgroundTerminateResult;\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toContain(\"Process not found\");\r\n    }\r\n\r\n    // Process should still be running\r\n    const proc = await manager.getProcess(spawnResult.processId);\r\n    expect(proc?.status).toBe(\"running\");\r\n\r\n    // Cleanup\r\n    await manager.cleanup(\"workspace-b\");\r\n    tempDir[Symbol.dispose]();\r\n  });\r\n});\r\n"]}