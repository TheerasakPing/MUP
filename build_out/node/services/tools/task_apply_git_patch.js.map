{"version":3,"file":"task_apply_git_patch.js","sourceRoot":"","sources":["../../../../src/node/services/tools/task_apply_git_patch.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"node:assert/strict\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport * as path from \"node:path\";\r\n\r\nimport { tool } from \"ai\";\r\n\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport {\r\n  TaskApplyGitPatchToolResultSchema,\r\n  TOOL_DEFINITIONS,\r\n} from \"@/common/utils/tools/toolDefinitions\";\r\nimport { shellQuote } from \"@/common/utils/shell\";\r\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\r\nimport {\r\n  getSubagentGitPatchMboxPath,\r\n  markSubagentGitPatchArtifactApplied,\r\n  readSubagentGitPatchArtifact,\r\n} from \"@/node/services/subagentGitPatchArtifacts\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { Config } from \"@/node/config\";\r\n\r\nimport { parseToolResult, requireWorkspaceId } from \"./toolUtils\";\r\n\r\nasync function copyLocalFileToRuntime(params: {\r\n  runtime: ToolConfiguration[\"runtime\"];\r\n  localPath: string;\r\n  remotePath: string;\r\n  abortSignal?: AbortSignal;\r\n}): Promise<void> {\r\n  const writable = params.runtime.writeFile(params.remotePath, params.abortSignal);\r\n  const writer = writable.getWriter();\r\n\r\n  const fileHandle = await fsPromises.open(params.localPath, \"r\");\r\n  try {\r\n    const buffer = Buffer.alloc(64 * 1024);\r\n    while (true) {\r\n      const { bytesRead } = await fileHandle.read(buffer, 0, buffer.length, null);\r\n      if (bytesRead <= 0) break;\r\n      await writer.write(buffer.subarray(0, bytesRead));\r\n    }\r\n\r\n    await writer.close();\r\n  } catch (error) {\r\n    writer.releaseLock();\r\n    throw error;\r\n  } finally {\r\n    await fileHandle.close();\r\n  }\r\n}\r\n\r\nexport const createTaskApplyGitPatchTool: ToolFactory = (config: ToolConfiguration) => {\r\n  function mergeNotes(...notes: Array<string | undefined>): string | undefined {\r\n    const parts = notes\r\n      .map((note) => (typeof note === \"string\" ? note.trim() : \"\"))\r\n      .filter((note) => note.length > 0);\r\n\r\n    return parts.length > 0 ? parts.join(\"\\n\") : undefined;\r\n  }\r\n\r\n  function isPathInsideDir(dirPath: string, filePath: string): boolean {\r\n    const resolvedDir = path.resolve(dirPath);\r\n    const resolvedFile = path.resolve(filePath);\r\n    const relative = path.relative(resolvedDir, resolvedFile);\r\n\r\n    return relative === \"\" || (!relative.startsWith(\"..\") && !path.isAbsolute(relative));\r\n  }\r\n\r\n  async function tryRevParseHead(params: { cwd: string }): Promise<string | undefined> {\r\n    try {\r\n      const headResult = await execBuffered(config.runtime, \"git rev-parse HEAD\", {\r\n        cwd: params.cwd,\r\n        timeout: 10,\r\n      });\r\n      if (headResult.exitCode !== 0) {\r\n        return undefined;\r\n      }\r\n      const sha = headResult.stdout.trim();\r\n      return sha.length > 0 ? sha : undefined;\r\n    } catch {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  async function getAppliedCommits(params: {\r\n    cwd: string;\r\n    beforeHeadSha: string | undefined;\r\n    commitCountHint: number | undefined;\r\n    includeSha: boolean;\r\n  }): Promise<Array<{ sha?: string; subject: string }>> {\r\n    const format = \"%H%x00%s\";\r\n\r\n    async function tryGitLog(args: {\r\n      cmd: string;\r\n      includeSha: boolean;\r\n    }): Promise<Array<{ sha?: string; subject: string }> | undefined> {\r\n      try {\r\n        const result = await execBuffered(config.runtime, args.cmd, {\r\n          cwd: params.cwd,\r\n          timeout: 30,\r\n        });\r\n        if (result.exitCode !== 0) {\r\n          log.debug(\"task_apply_git_patch: git log failed\", {\r\n            cwd: params.cwd,\r\n            exitCode: result.exitCode,\r\n            stderr: result.stderr.trim(),\r\n            stdout: result.stdout.trim(),\r\n          });\r\n          return undefined;\r\n        }\r\n\r\n        const lines = result.stdout\r\n          .split(\"\\n\")\r\n          .map((line) => line.replace(/\\r$/, \"\"))\r\n          .filter((line) => line.length > 0);\r\n\r\n        const commits: Array<{ sha?: string; subject: string }> = [];\r\n        for (const line of lines) {\r\n          const nulIndex = line.indexOf(\"\\u0000\");\r\n          if (nulIndex === -1) {\r\n            // Defensive: unexpected formatting; treat as a subject-only line.\r\n            commits.push({ subject: line });\r\n            continue;\r\n          }\r\n\r\n          const sha = line.slice(0, nulIndex);\r\n          const subject = line.slice(nulIndex + 1);\r\n          if (subject.length === 0) continue;\r\n\r\n          if (args.includeSha && sha.length > 0) {\r\n            commits.push({ sha, subject });\r\n          } else {\r\n            commits.push({ subject });\r\n          }\r\n        }\r\n\r\n        return commits;\r\n      } catch (error) {\r\n        log.debug(\"task_apply_git_patch: git log threw\", { cwd: params.cwd, error });\r\n        return undefined;\r\n      }\r\n    }\r\n\r\n    // Best option: log the exact range of new commits.\r\n    if (params.beforeHeadSha) {\r\n      const rangeCmd = `git log --reverse --format=${format} ${params.beforeHeadSha}..HEAD`;\r\n      const commits = await tryGitLog({ cmd: rangeCmd, includeSha: params.includeSha });\r\n      if (commits) return commits;\r\n    }\r\n\r\n    // Fallback: best-effort last-N commits.\r\n    if (typeof params.commitCountHint === \"number\" && params.commitCountHint > 0) {\r\n      const countCmd = `git log -n ${params.commitCountHint} --reverse --format=${format} HEAD`;\r\n      const commits = await tryGitLog({ cmd: countCmd, includeSha: params.includeSha });\r\n      if (commits) return commits;\r\n    }\r\n\r\n    return [];\r\n  }\r\n\r\n  const MAX_PARENT_WORKSPACE_DEPTH = 32;\r\n\r\n  function inferMuxRootFromWorkspaceSessionDir(workspaceSessionDir: string): string | undefined {\r\n    assert(\r\n      workspaceSessionDir.length > 0,\r\n      \"inferMuxRootFromWorkspaceSessionDir: workspaceSessionDir must be non-empty\"\r\n    );\r\n\r\n    const sessionsDir = path.dirname(workspaceSessionDir);\r\n    if (path.basename(sessionsDir) !== \"sessions\") {\r\n      return undefined;\r\n    }\r\n\r\n    return path.dirname(sessionsDir);\r\n  }\r\n\r\n  function parseFailedPatchSubjectFromGitAmOutput(output: string): string | undefined {\r\n    const normalized = output.replace(/\\r/g, \"\");\r\n\r\n    const patchFailedMatch = /^Patch failed at \\d+ (.+)$/m.exec(normalized);\r\n    if (patchFailedMatch) {\r\n      const subject = patchFailedMatch[1].trim();\r\n      return subject.length > 0 ? subject : undefined;\r\n    }\r\n\r\n    const applyingMatches = Array.from(normalized.matchAll(/^Applying: (.+)$/gm));\r\n    const subject = applyingMatches.at(-1)?.[1]?.trim();\r\n    return subject && subject.length > 0 ? subject : undefined;\r\n  }\r\n\r\n  async function tryGetConflictPaths(params: { cwd: string }): Promise<string[]> {\r\n    assert(params.cwd.length > 0, \"tryGetConflictPaths: cwd must be non-empty\");\r\n\r\n    try {\r\n      const diffResult = await execBuffered(\r\n        config.runtime,\r\n        \"git diff --name-only --diff-filter=U\",\r\n        {\r\n          cwd: params.cwd,\r\n          timeout: 30,\r\n        }\r\n      );\r\n\r\n      if (diffResult.exitCode !== 0) {\r\n        log.debug(\"task_apply_git_patch: git diff --name-only --diff-filter=U failed\", {\r\n          cwd: params.cwd,\r\n          exitCode: diffResult.exitCode,\r\n          stderr: diffResult.stderr.trim(),\r\n          stdout: diffResult.stdout.trim(),\r\n        });\r\n        return [];\r\n      }\r\n\r\n      const paths = diffResult.stdout\r\n        .split(\"\\n\")\r\n        .map((line) => line.replace(/\\r$/, \"\").trim())\r\n        .filter((line) => line.length > 0);\r\n\r\n      return Array.from(new Set(paths));\r\n    } catch (error) {\r\n      log.debug(\"task_apply_git_patch: git diff --name-only --diff-filter=U threw\", {\r\n        cwd: params.cwd,\r\n        error,\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async function findGitPatchArtifactInWorkspaceOrAncestors(params: {\r\n    workspaceId: string;\r\n    workspaceSessionDir: string;\r\n    childTaskId: string;\r\n  }): Promise<{\r\n    artifact: NonNullable<Awaited<ReturnType<typeof readSubagentGitPatchArtifact>>>;\r\n    artifactWorkspaceId: string;\r\n    artifactSessionDir: string;\r\n    note?: string;\r\n  } | null> {\r\n    assert(\r\n      params.workspaceId.length > 0,\r\n      \"findGitPatchArtifactInWorkspaceOrAncestors: workspaceId must be non-empty\"\r\n    );\r\n    assert(\r\n      params.workspaceSessionDir.length > 0,\r\n      \"findGitPatchArtifactInWorkspaceOrAncestors: workspaceSessionDir must be non-empty\"\r\n    );\r\n    assert(\r\n      params.childTaskId.length > 0,\r\n      \"findGitPatchArtifactInWorkspaceOrAncestors: childTaskId must be non-empty\"\r\n    );\r\n\r\n    const direct = await readSubagentGitPatchArtifact(\r\n      params.workspaceSessionDir,\r\n      params.childTaskId\r\n    );\r\n    if (direct) {\r\n      return {\r\n        artifact: direct,\r\n        artifactWorkspaceId: params.workspaceId,\r\n        artifactSessionDir: params.workspaceSessionDir,\r\n      };\r\n    }\r\n\r\n    const muxRootDir = inferMuxRootFromWorkspaceSessionDir(params.workspaceSessionDir);\r\n    if (!muxRootDir) {\r\n      log.debug(\r\n        \"task_apply_git_patch: workspaceSessionDir not under sessions/; skipping ancestor lookup\",\r\n        {\r\n          workspaceId: params.workspaceId,\r\n          workspaceSessionDir: params.workspaceSessionDir,\r\n          childTaskId: params.childTaskId,\r\n        }\r\n      );\r\n      return null;\r\n    }\r\n\r\n    const configService = new Config(muxRootDir);\r\n\r\n    let cfg: ReturnType<Config[\"loadConfigOrDefault\"]>;\r\n    try {\r\n      cfg = configService.loadConfigOrDefault();\r\n    } catch (error) {\r\n      log.debug(\"task_apply_git_patch: failed to load mux config for ancestor lookup\", {\r\n        workspaceId: params.workspaceId,\r\n        muxRootDir,\r\n        error,\r\n      });\r\n      return null;\r\n    }\r\n\r\n    const parentById = new Map<string, string | undefined>();\r\n    for (const project of cfg.projects.values()) {\r\n      for (const workspace of project.workspaces) {\r\n        if (!workspace.id) continue;\r\n        parentById.set(workspace.id, workspace.parentWorkspaceId);\r\n      }\r\n    }\r\n\r\n    const visited = new Set<string>();\r\n    visited.add(params.workspaceId);\r\n\r\n    let current = params.workspaceId;\r\n    for (let i = 0; i < MAX_PARENT_WORKSPACE_DEPTH; i++) {\r\n      const parent = parentById.get(current);\r\n      if (!parent) {\r\n        return null;\r\n      }\r\n\r\n      if (visited.has(parent)) {\r\n        log.warn(\"task_apply_git_patch: possible parentWorkspaceId cycle during ancestor lookup\", {\r\n          workspaceId: params.workspaceId,\r\n          childTaskId: params.childTaskId,\r\n          current,\r\n          parent,\r\n        });\r\n        return null;\r\n      }\r\n\r\n      visited.add(parent);\r\n\r\n      const parentSessionDir = configService.getSessionDir(parent);\r\n      const artifact = await readSubagentGitPatchArtifact(parentSessionDir, params.childTaskId);\r\n      if (artifact) {\r\n        return {\r\n          artifact,\r\n          artifactWorkspaceId: parent,\r\n          artifactSessionDir: parentSessionDir,\r\n          note: `Patch artifact loaded from ancestor workspace ${parent}.`,\r\n        };\r\n      }\r\n\r\n      current = parent;\r\n    }\r\n\r\n    log.warn(\"task_apply_git_patch: exceeded parentWorkspaceId depth during ancestor lookup\", {\r\n      workspaceId: params.workspaceId,\r\n      childTaskId: params.childTaskId,\r\n    });\r\n\r\n    return null;\r\n  }\r\n\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.task_apply_git_patch.description,\r\n    inputSchema: TOOL_DEFINITIONS.task_apply_git_patch.schema,\r\n    execute: async (args, { abortSignal }): Promise<unknown> => {\r\n      const workspaceId = requireWorkspaceId(config, \"task_apply_git_patch\");\r\n      assert(config.cwd, \"task_apply_git_patch requires cwd\");\r\n      assert(config.runtimeTempDir, \"task_apply_git_patch requires runtimeTempDir\");\r\n      const workspaceSessionDir = config.workspaceSessionDir;\r\n      assert(workspaceSessionDir, \"task_apply_git_patch requires workspaceSessionDir\");\r\n\r\n      const taskId = args.task_id;\r\n      const dryRun = args.dry_run === true;\r\n      const threeWay = args.three_way !== false;\r\n      const force = args.force === true;\r\n\r\n      const artifactLookup = await findGitPatchArtifactInWorkspaceOrAncestors({\r\n        workspaceId,\r\n        workspaceSessionDir,\r\n        childTaskId: taskId,\r\n      });\r\n\r\n      if (!artifactLookup) {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            dryRun,\r\n            error: \"No git patch artifact found for this taskId.\",\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      const artifact = artifactLookup.artifact;\r\n      const artifactWorkspaceId = artifactLookup.artifactWorkspaceId;\r\n      const artifactSessionDir = artifactLookup.artifactSessionDir;\r\n      const isReplay = artifactWorkspaceId !== workspaceId;\r\n      const artifactLookupNote = artifactLookup.note;\r\n\r\n      if (artifact.parentWorkspaceId !== artifactWorkspaceId) {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            dryRun,\r\n            error: \"This patch artifact belongs to a different parent workspace.\",\r\n            note: mergeNotes(\r\n              artifactLookupNote,\r\n              `Expected parent workspace ${artifactWorkspaceId} but artifact metadata says ${artifact.parentWorkspaceId}.`\r\n            ),\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      if (artifact.status === \"pending\") {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            error: \"Patch artifact is still pending generation.\",\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      if (artifact.status === \"failed\") {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            error: artifact.error ?? \"Patch artifact generation failed.\",\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      if (artifact.status === \"skipped\") {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            error: \"This task produced no commits (patch generation was skipped).\",\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      if (!isReplay && artifact.appliedAtMs && !force && !dryRun) {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            error: `Patch already applied at ${new Date(artifact.appliedAtMs).toISOString()}.`,\r\n            note: \"Re-run with force=true to apply again.\",\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      const expectedPatchPath = getSubagentGitPatchMboxPath(artifactSessionDir, taskId);\r\n\r\n      // Defensive: `task_id` is user-controlled input; reject path traversal.\r\n      if (!isPathInsideDir(artifactSessionDir, expectedPatchPath)) {\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            error: \"Invalid task_id.\",\r\n            note: \"task_id must not contain path traversal segments.\",\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      const safeMboxPath =\r\n        typeof artifact.mboxPath === \"string\" && artifact.mboxPath.length > 0\r\n          ? isPathInsideDir(artifactSessionDir, artifact.mboxPath)\r\n            ? artifact.mboxPath\r\n            : undefined\r\n          : undefined;\r\n\r\n      let patchPathNote = mergeNotes(\r\n        artifactLookupNote,\r\n        artifact.mboxPath && !safeMboxPath\r\n          ? \"Ignoring unsafe mboxPath in patch artifact metadata; using canonical patch location.\"\r\n          : undefined\r\n      );\r\n\r\n      const patchCandidates = [safeMboxPath, expectedPatchPath].filter(\r\n        (candidate): candidate is string => typeof candidate === \"string\"\r\n      );\r\n\r\n      let patchPath: string | null = null;\r\n      for (const candidate of patchCandidates) {\r\n        try {\r\n          const stat = await fsPromises.stat(candidate);\r\n          if (stat.isFile()) {\r\n            patchPath = candidate;\r\n            break;\r\n          }\r\n        } catch {\r\n          // try next candidate\r\n        }\r\n      }\r\n\r\n      if (!patchPath) {\r\n        const checkedPaths = Array.from(new Set(patchCandidates))\r\n          .map((candidate) =>\r\n            isPathInsideDir(artifactSessionDir, candidate)\r\n              ? path.relative(artifactSessionDir, candidate) || path.basename(candidate)\r\n              : candidate\r\n          )\r\n          .join(\", \");\r\n\r\n        log.debug(\"task_apply_git_patch: patch file missing\", {\r\n          taskId,\r\n          workspaceId,\r\n          cwd: config.cwd,\r\n          checkedPaths,\r\n        });\r\n\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            error: \"Patch file is missing on disk.\",\r\n            note: mergeNotes(\r\n              patchPathNote,\r\n              checkedPaths.length > 0 ? `Checked patch locations: ${checkedPaths}` : undefined\r\n            ),\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      if (safeMboxPath && patchPath === expectedPatchPath && safeMboxPath !== expectedPatchPath) {\r\n        patchPathNote = mergeNotes(\r\n          patchPathNote,\r\n          \"Patch file not found at metadata mboxPath; using canonical patch location.\"\r\n        );\r\n      }\r\n\r\n      if (!force) {\r\n        const statusResult = await execBuffered(config.runtime, \"git status --porcelain\", {\r\n          cwd: config.cwd,\r\n          timeout: 10,\r\n        });\r\n        if (statusResult.exitCode !== 0) {\r\n          return parseToolResult(\r\n            TaskApplyGitPatchToolResultSchema,\r\n            {\r\n              success: false as const,\r\n              taskId,\r\n              error: statusResult.stderr.trim() || \"git status failed\",\r\n              note: patchPathNote,\r\n            },\r\n            \"task_apply_git_patch\"\r\n          );\r\n        }\r\n\r\n        if (statusResult.stdout.trim().length > 0) {\r\n          return parseToolResult(\r\n            TaskApplyGitPatchToolResultSchema,\r\n            {\r\n              success: false as const,\r\n              taskId,\r\n              error: \"Working tree is not clean.\",\r\n              note: mergeNotes(\r\n                patchPathNote,\r\n                \"Commit/stash your changes (or pass force=true) before applying patches.\"\r\n              ),\r\n            },\r\n            \"task_apply_git_patch\"\r\n          );\r\n        }\r\n      }\r\n\r\n      // Use path.posix.join to preserve forward slashes:\r\n      // - SSH runtime needs POSIX-style paths\r\n      // - Windows local runtime uses drive-qualified paths like C:/Users/... (also with /)\r\n      const remotePatchPath = path.posix.join(\r\n        config.runtimeTempDir,\r\n        `mux-task-${taskId}-series.mbox`\r\n      );\r\n\r\n      await copyLocalFileToRuntime({\r\n        runtime: config.runtime,\r\n        localPath: patchPath,\r\n        remotePath: remotePatchPath,\r\n        abortSignal,\r\n      });\r\n\r\n      const flags: string[] = [];\r\n      if (threeWay) flags.push(\"--3way\");\r\n\r\n      if (dryRun) {\r\n        // `git am` doesn't support a native --dry-run. Instead, apply inside a temporary worktree\r\n        // and discard it. This avoids mutating the current worktree while still exercising `git am`.\r\n        const dryRunId = `${Date.now().toString(16)}-${Math.random().toString(16).slice(2, 8)}`;\r\n        const dryRunWorktreePath = path.posix.join(\r\n          config.runtimeTempDir,\r\n          `mux-git-am-dry-run-${taskId}-${dryRunId}`\r\n        );\r\n\r\n        const addResult = await execBuffered(\r\n          config.runtime,\r\n          `git worktree add --detach ${shellQuote(dryRunWorktreePath)} HEAD`,\r\n          { cwd: config.cwd, timeout: 60 }\r\n        );\r\n        if (addResult.exitCode !== 0) {\r\n          return parseToolResult(\r\n            TaskApplyGitPatchToolResultSchema,\r\n            {\r\n              success: false as const,\r\n              taskId,\r\n              error:\r\n                addResult.stderr.trim() || addResult.stdout.trim() || \"git worktree add failed\",\r\n            },\r\n            \"task_apply_git_patch\"\r\n          );\r\n        }\r\n\r\n        try {\r\n          const beforeHeadSha = await tryRevParseHead({ cwd: dryRunWorktreePath });\r\n\r\n          const amCmd = `git am ${flags.join(\" \")} ${shellQuote(remotePatchPath)}`.trim();\r\n          const amResult = await execBuffered(config.runtime, amCmd, {\r\n            cwd: dryRunWorktreePath,\r\n            timeout: 300,\r\n          });\r\n\r\n          if (amResult.exitCode !== 0) {\r\n            const stderr = amResult.stderr.trim();\r\n            const stdout = amResult.stdout.trim();\r\n            const errorOutput = [stderr, stdout]\r\n              .filter((s) => s.length > 0)\r\n              .join(\"\\n\")\r\n              .trim();\r\n\r\n            const conflictPaths = await tryGetConflictPaths({ cwd: dryRunWorktreePath });\r\n            const failedPatchSubject = parseFailedPatchSubjectFromGitAmOutput(errorOutput);\r\n\r\n            return parseToolResult(\r\n              TaskApplyGitPatchToolResultSchema,\r\n              {\r\n                success: false as const,\r\n                taskId,\r\n                dryRun: true,\r\n                conflictPaths,\r\n                failedPatchSubject,\r\n                error:\r\n                  errorOutput.length > 0\r\n                    ? errorOutput\r\n                    : `git am failed (exitCode=${amResult.exitCode})`,\r\n                note: mergeNotes(\r\n                  patchPathNote,\r\n                  \"Dry run failed; the patch does not apply cleanly. Applying for real will likely require conflict resolution.\"\r\n                ),\r\n              },\r\n              \"task_apply_git_patch\"\r\n            );\r\n          }\r\n\r\n          const appliedCommits = await getAppliedCommits({\r\n            cwd: dryRunWorktreePath,\r\n            beforeHeadSha,\r\n            commitCountHint: artifact.commitCount,\r\n            includeSha: false,\r\n          });\r\n\r\n          return parseToolResult(\r\n            TaskApplyGitPatchToolResultSchema,\r\n            {\r\n              success: true as const,\r\n              taskId,\r\n              appliedCommits,\r\n              dryRun: true,\r\n              note: mergeNotes(patchPathNote, \"Dry run succeeded; no commits were applied.\"),\r\n            },\r\n            \"task_apply_git_patch\"\r\n          );\r\n        } finally {\r\n          // Best-effort: clean up the temp worktree. This should never fail the tool call.\r\n          try {\r\n            const abortResult = await execBuffered(config.runtime, \"git am --abort\", {\r\n              cwd: dryRunWorktreePath,\r\n              timeout: 30,\r\n            });\r\n            if (abortResult.exitCode !== 0) {\r\n              log.debug(\"task_apply_git_patch: dry-run git am --abort failed\", {\r\n                taskId,\r\n                workspaceId,\r\n                cwd: config.cwd,\r\n                dryRunWorktreePath,\r\n                exitCode: abortResult.exitCode,\r\n                stderr: abortResult.stderr.trim(),\r\n                stdout: abortResult.stdout.trim(),\r\n              });\r\n            }\r\n          } catch (error: unknown) {\r\n            log.debug(\"task_apply_git_patch: dry-run git am --abort threw\", {\r\n              taskId,\r\n              workspaceId,\r\n              cwd: config.cwd,\r\n              dryRunWorktreePath,\r\n              error,\r\n            });\r\n          }\r\n\r\n          try {\r\n            const removeResult = await execBuffered(\r\n              config.runtime,\r\n              `git worktree remove --force ${shellQuote(dryRunWorktreePath)}`,\r\n              { cwd: config.cwd, timeout: 60 }\r\n            );\r\n            if (removeResult.exitCode !== 0) {\r\n              log.debug(\"task_apply_git_patch: dry-run git worktree remove failed\", {\r\n                taskId,\r\n                workspaceId,\r\n                cwd: config.cwd,\r\n                dryRunWorktreePath,\r\n                exitCode: removeResult.exitCode,\r\n                stderr: removeResult.stderr.trim(),\r\n                stdout: removeResult.stdout.trim(),\r\n              });\r\n            }\r\n          } catch (error: unknown) {\r\n            log.debug(\"task_apply_git_patch: dry-run git worktree remove threw\", {\r\n              taskId,\r\n              workspaceId,\r\n              cwd: config.cwd,\r\n              dryRunWorktreePath,\r\n              error,\r\n            });\r\n          }\r\n\r\n          try {\r\n            const pruneResult = await execBuffered(config.runtime, \"git worktree prune\", {\r\n              cwd: config.cwd,\r\n              timeout: 60,\r\n            });\r\n            if (pruneResult.exitCode !== 0) {\r\n              log.debug(\"task_apply_git_patch: dry-run git worktree prune failed\", {\r\n                taskId,\r\n                workspaceId,\r\n                cwd: config.cwd,\r\n                exitCode: pruneResult.exitCode,\r\n                stderr: pruneResult.stderr.trim(),\r\n                stdout: pruneResult.stdout.trim(),\r\n              });\r\n            }\r\n          } catch (error: unknown) {\r\n            log.debug(\"task_apply_git_patch: dry-run git worktree prune threw\", {\r\n              taskId,\r\n              workspaceId,\r\n              cwd: config.cwd,\r\n              error,\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      const beforeHeadSha = await tryRevParseHead({ cwd: config.cwd });\r\n\r\n      const amCmd = `git am ${flags.join(\" \")} ${shellQuote(remotePatchPath)}`.trim();\r\n      const amResult = await execBuffered(config.runtime, amCmd, { cwd: config.cwd, timeout: 300 });\r\n\r\n      if (amResult.exitCode !== 0) {\r\n        const stderr = amResult.stderr.trim();\r\n        const stdout = amResult.stdout.trim();\r\n        const errorOutput = [stderr, stdout]\r\n          .filter((s) => s.length > 0)\r\n          .join(\"\\n\")\r\n          .trim();\r\n\r\n        const conflictPaths = await tryGetConflictPaths({ cwd: config.cwd });\r\n        const failedPatchSubject = parseFailedPatchSubjectFromGitAmOutput(errorOutput);\r\n\r\n        return parseToolResult(\r\n          TaskApplyGitPatchToolResultSchema,\r\n          {\r\n            success: false as const,\r\n            taskId,\r\n            dryRun: false,\r\n            conflictPaths,\r\n            failedPatchSubject,\r\n            error:\r\n              errorOutput.length > 0\r\n                ? errorOutput\r\n                : `git am failed (exitCode=${amResult.exitCode})`,\r\n            note: mergeNotes(\r\n              patchPathNote,\r\n              \"If git am stopped due to conflicts, resolve them then run `git am --continue` or `git am --abort`.\"\r\n            ),\r\n          },\r\n          \"task_apply_git_patch\"\r\n        );\r\n      }\r\n\r\n      const headCommitSha = await tryRevParseHead({ cwd: config.cwd });\r\n\r\n      const appliedCommits = await getAppliedCommits({\r\n        cwd: config.cwd,\r\n        beforeHeadSha,\r\n        commitCountHint: artifact.commitCount,\r\n        includeSha: true,\r\n      });\r\n\r\n      if (!dryRun && !isReplay) {\r\n        await markSubagentGitPatchArtifactApplied({\r\n          workspaceId: artifactWorkspaceId,\r\n          workspaceSessionDir: artifactSessionDir,\r\n          childTaskId: taskId,\r\n          appliedAtMs: Date.now(),\r\n        });\r\n      }\r\n\r\n      return parseToolResult(\r\n        TaskApplyGitPatchToolResultSchema,\r\n        {\r\n          success: true as const,\r\n          taskId,\r\n          appliedCommits,\r\n          headCommitSha,\r\n          note: mergeNotes(patchPathNote),\r\n        },\r\n        \"task_apply_git_patch\"\r\n      );\r\n    },\r\n  });\r\n};\r\n"]}