{"version":3,"file":"file_edit_insert.test.js","sourceRoot":"","sources":["../../../../src/node/services/tools/file_edit_insert.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport * as os from \"os\";\nimport { createFileEditInsertTool } from \"./file_edit_insert\";\nimport type { FileEditInsertToolArgs, FileEditInsertToolResult } from \"@/common/types/tools\";\nimport type { ToolExecutionOptions } from \"ai\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\nimport { getTestDeps } from \"./testHelpers\";\n\nconst mockToolCallOptions: ToolExecutionOptions = {\n  toolCallId: \"test-call-id\",\n  messages: [],\n};\n\nfunction createTestTool(cwd: string) {\n  return createFileEditInsertTool({\n    ...getTestDeps(),\n    cwd,\n    runtime: createRuntime({ type: \"local\", srcBaseDir: cwd }),\n    runtimeTempDir: cwd,\n  });\n}\n\ndescribe(\"file_edit_insert tool\", () => {\n  let testDir: string;\n  let testFilePath: string;\n\n  beforeEach(async () => {\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"file-edit-insert-\"));\n    testFilePath = path.join(testDir, \"test.txt\");\n    await fs.writeFile(testFilePath, \"Line 1\\nLine 3\");\n  });\n\n  afterEach(async () => {\n    await fs.rm(testDir, { recursive: true, force: true });\n  });\n\n  it(\"inserts content using insert_after guard\", async () => {\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"Line 2\\n\",\n      insert_after: \"Line 1\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(true);\n    const updated = await fs.readFile(testFilePath, \"utf-8\");\n    expect(updated).toBe(\"Line 1\\nLine 2\\nLine 3\");\n  });\n\n  it(\"inserts content using insert_after guard when file uses CRLF\", async () => {\n    await fs.writeFile(testFilePath, \"Line 1\\r\\nLine 3\\r\\n\");\n\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"Line 2\\n\",\n      insert_after: \"Line 1\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(true);\n    const updated = await fs.readFile(testFilePath, \"utf-8\");\n    expect(updated).toBe(\"Line 1\\r\\nLine 2\\r\\nLine 3\\r\\n\");\n  });\n\n  it(\"inserts content using insert_before guard\", async () => {\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"Header\\n\",\n      insert_before: \"Line 1\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n    expect(result.success).toBe(true);\n    expect(await fs.readFile(testFilePath, \"utf-8\")).toBe(\"Header\\nLine 1\\nLine 3\");\n  });\n\n  it(\"fails when guard matches multiple times\", async () => {\n    await fs.writeFile(testFilePath, \"repeat\\nrepeat\\nrepeat\\n\");\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"middle\\n\",\n      insert_after: \"repeat\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"multiple times\");\n    }\n  });\n\n  it(\"fails when guard is not found and does not modify the file\", async () => {\n    const original = await fs.readFile(testFilePath, \"utf-8\");\n\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"Line 2\\n\",\n      insert_after: \"does not exist\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(false);\n    expect(await fs.readFile(testFilePath, \"utf-8\")).toBe(original);\n  });\n\n  it(\"fails when both insert_before and insert_after are provided\", async () => {\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"oops\",\n      insert_after: \"Line 1\",\n      insert_before: \"Line 3\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"only one of insert_before or insert_after\");\n    }\n  });\n\n  it(\"creates a new file without requiring create flag or guards\", async () => {\n    const newFile = path.join(testDir, \"new.txt\");\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, newFile),\n      content: \"Hello world!\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n    expect(result.success).toBe(true);\n    expect(await fs.readFile(newFile, \"utf-8\")).toBe(\"Hello world!\\n\");\n  });\n\n  it(\"fails when no guards are provided\", async () => {\n    const tool = createTestTool(testDir);\n    const args: FileEditInsertToolArgs = {\n      file_path: path.relative(testDir, testFilePath),\n      content: \"noop\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"Provide either insert_before or insert_after guard\");\n    }\n  });\n});\n\ndescribe(\"file_edit_insert plan mode enforcement\", () => {\n  let testDir: string;\n\n  beforeEach(async () => {\n    testDir = await fs.mkdtemp(path.join(os.tmpdir(), \"plan-mode-insert-\"));\n  });\n\n  afterEach(async () => {\n    await fs.rm(testDir, { recursive: true, force: true });\n  });\n\n  it(\"blocks creating non-plan files when in plan mode\", async () => {\n    const planFilePath = path.join(testDir, \"sessions\", \"workspace\", \"plan.md\");\n    const otherFilePath = path.join(testDir, \"workspace\", \"main.ts\");\n    const workspaceCwd = path.join(testDir, \"workspace\");\n\n    // Create workspace directory\n    await fs.mkdir(workspaceCwd, { recursive: true });\n\n    const tool = createFileEditInsertTool({\n      ...getTestDeps(),\n      cwd: workspaceCwd,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: workspaceCwd }),\n      runtimeTempDir: testDir,\n      planFileOnly: true,\n      planFilePath: planFilePath,\n    });\n\n    const args: FileEditInsertToolArgs = {\n      file_path: otherFilePath,\n      content: \"console.log('test');\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"In the plan agent, only the plan file can be edited\");\n    }\n  });\n\n  it(\"allows creating plan file when in plan mode\", async () => {\n    const planFilePath = path.join(testDir, \"plan.md\");\n    const workspaceCwd = path.join(testDir, \"workspace\");\n\n    // Create workspace directory\n    await fs.mkdir(workspaceCwd, { recursive: true });\n\n    const tool = createFileEditInsertTool({\n      ...getTestDeps(),\n      cwd: workspaceCwd,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: workspaceCwd }),\n      runtimeTempDir: testDir,\n      planFileOnly: true,\n      planFilePath: planFilePath,\n    });\n\n    const args: FileEditInsertToolArgs = {\n      file_path: planFilePath,\n      content: \"# My Plan\\n\\n- Step 1\\n- Step 2\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(true);\n    expect(await fs.readFile(planFilePath, \"utf-8\")).toBe(\"# My Plan\\n\\n- Step 1\\n- Step 2\\n\");\n  });\n\n  it(\"allows editing any file in exec mode\", async () => {\n    const testFilePath = path.join(testDir, \"main.ts\");\n    await fs.writeFile(testFilePath, \"const x = 1;\");\n\n    const tool = createFileEditInsertTool({\n      ...getTestDeps(),\n      cwd: testDir,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: testDir }),\n      runtimeTempDir: testDir,\n    });\n\n    const args: FileEditInsertToolArgs = {\n      file_path: testFilePath,\n      content: \"// header\\n\",\n      insert_before: \"const x = 1;\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(true);\n    expect(await fs.readFile(testFilePath, \"utf-8\")).toBe(\"// header\\nconst x = 1;\");\n  });\n\n  it(\"blocks creating .mux/plan.md (wrong path) when real plan file is elsewhere\", async () => {\n    // This test simulates the bug where an agent tries to create \".mux/plan.md\"\n    // in the workspace instead of using the actual plan file at ~/.mux/plans/project/workspace.md\n    const workspaceCwd = path.join(testDir, \"workspace\");\n    const wrongPlanPath = path.join(workspaceCwd, \".mux\", \"plan.md\");\n    const realPlanPath = path.join(testDir, \"plans\", \"project\", \"workspace.md\");\n\n    // Create workspace directory (simulate a real project workspace)\n    await fs.mkdir(workspaceCwd, { recursive: true });\n    // Create the plans directory structure\n    await fs.mkdir(path.dirname(realPlanPath), { recursive: true });\n\n    const tool = createFileEditInsertTool({\n      ...getTestDeps(),\n      cwd: workspaceCwd,\n      runtime: createRuntime({ type: \"local\", srcBaseDir: workspaceCwd }),\n      runtimeTempDir: testDir,\n      planFileOnly: true,\n      planFilePath: realPlanPath, // The REAL plan file path\n    });\n\n    // Agent mistakenly tries to create \".mux/plan.md\" in workspace\n    const args: FileEditInsertToolArgs = {\n      file_path: \".mux/plan.md\", // Wrong path - relative to cwd\n      content: \"# My Plan\\n\\n- Step 1\\n\",\n    };\n\n    const result = (await tool.execute!(args, mockToolCallOptions)) as FileEditInsertToolResult;\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toContain(\"In the plan agent, only the plan file can be edited\");\n      expect(result.error).toContain(\"exact plan file path\");\n      expect(result.error).toContain(realPlanPath);\n      expect(result.error).toContain(\".mux/plan.md\");\n    }\n\n    // Ensure the wrong file was NOT created\n    const wrongFileExists = await fs\n      .stat(wrongPlanPath)\n      .then(() => true)\n      .catch(() => false);\n    expect(wrongFileExists).toBe(false);\n  });\n});\n"]}