{"version":3,"file":"mux_global_agents_read.js","sourceRoot":"","sources":["../../../../src/node/services/tools/mux_global_agents_read.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAY,IAAI,iCAAa;AAC7B,MAAY,UAAU,wCAAoB;AAC1C,2BAA0B;AAG1B,0EAAwE;AACxE,wDAAwE;AAExE,SAAS,iCAAiC,CAAC,MAAyB,EAAU;IAC5E,IAAI,CAAC,MAAM,CAAC,mBAAmB,EAAE,CAAC;QAChC,MAAM,IAAI,KAAK,CAAC,qDAAqD,CAAC,CAAC;IACzE,CAAC;IAED,yDAAyD;IACzD,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;IAC7D,OAAO,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;AAAA,CAClC;AAgBM,MAAM,6BAA6B,GAAgB,CAAC,MAAyB,EAAE,EAAE,CAAC;IACvF,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,sBAAsB,CAAC,WAAW;QAChE,WAAW,EAAE,kCAAgB,CAAC,sBAAsB,CAAC,MAAM;QAC3D,OAAO,EAAE,KAAK,EACZ,KAAK,EACL,EAAE,WAAW,EAAE,YAAY,EAAE,EACW,EAAE,CAAC;YAC3C,IAAI,CAAC;gBACH,IAAI,MAAM,CAAC,WAAW,KAAK,oCAA0B,EAAE,CAAC;oBACtD,OAAO;wBACL,OAAO,EAAE,KAAK;wBACd,KAAK,EAAE,gFAAgF;qBACxF,CAAC;gBACJ,CAAC;gBAED,MAAM,OAAO,GAAG,iCAAiC,CAAC,MAAM,CAAC,CAAC;gBAC1D,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;gBAEnD,IAAI,CAAC;oBACH,MAAM,IAAI,GAAG,MAAM,UAAU,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;oBAChD,IAAI,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC;wBAC1B,OAAO;4BACL,OAAO,EAAE,KAAK;4BACd,KAAK,EAAE,+CAA+C;yBACvD,CAAC;oBACJ,CAAC;oBAED,MAAM,OAAO,GAAG,MAAM,UAAU,CAAC,QAAQ,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;oBAC/D,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC;gBACpC,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,MAAM,IAAI,KAAK,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;wBACrF,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC;oBACxC,CAAC;oBAED,MAAM,KAAK,CAAC;gBACd,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBACvE,OAAO;oBACL,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,oCAAoC,OAAO,EAAE;iBACrD,CAAC;YACJ,CAAC;QAAA,CACF;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AA9CW,QAAA,6BAA6B,GAA7B,6BAA6B,CA8CxC","sourcesContent":["import * as path from \"path\";\nimport * as fsPromises from \"fs/promises\";\nimport { tool } from \"ai\";\n\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\n\nfunction getMuxHomeFromWorkspaceSessionDir(config: ToolConfiguration): string {\n  if (!config.workspaceSessionDir) {\n    throw new Error(\"mux_global_agents_read requires workspaceSessionDir\");\n  }\n\n  // workspaceSessionDir = <muxHome>/sessions/<workspaceId>\n  const sessionsDir = path.dirname(config.workspaceSessionDir);\n  return path.dirname(sessionsDir);\n}\n\nexport interface MuxGlobalAgentsReadToolResult {\n  success: true;\n  content: string;\n}\n\nexport interface MuxGlobalAgentsReadToolError {\n  success: false;\n  error: string;\n}\n\nexport type MuxGlobalAgentsReadToolOutput =\n  | MuxGlobalAgentsReadToolResult\n  | MuxGlobalAgentsReadToolError;\n\nexport const createMuxGlobalAgentsReadTool: ToolFactory = (config: ToolConfiguration) => {\n  return tool({\n    description: TOOL_DEFINITIONS.mux_global_agents_read.description,\n    inputSchema: TOOL_DEFINITIONS.mux_global_agents_read.schema,\n    execute: async (\n      _args,\n      { abortSignal: _abortSignal }\n    ): Promise<MuxGlobalAgentsReadToolOutput> => {\n      try {\n        if (config.workspaceId !== MUX_HELP_CHAT_WORKSPACE_ID) {\n          return {\n            success: false,\n            error: \"mux_global_agents_read is only available in the Chat with Mux system workspace\",\n          };\n        }\n\n        const muxHome = getMuxHomeFromWorkspaceSessionDir(config);\n        const agentsPath = path.join(muxHome, \"AGENTS.md\");\n\n        try {\n          const stat = await fsPromises.lstat(agentsPath);\n          if (stat.isSymbolicLink()) {\n            return {\n              success: false,\n              error: \"Refusing to read a symlinked AGENTS.md target\",\n            };\n          }\n\n          const content = await fsPromises.readFile(agentsPath, \"utf-8\");\n          return { success: true, content };\n        } catch (error) {\n          if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n            return { success: true, content: \"\" };\n          }\n\n          throw error;\n        }\n      } catch (error) {\n        const message = error instanceof Error ? error.message : String(error);\n        return {\n          success: false,\n          error: `Failed to read global AGENTS.md: ${message}`,\n        };\n      }\n    },\n  });\n};\n"]}