{"version":3,"file":"mux_global_agents_read.js","sourceRoot":"","sources":["../../../../src/node/services/tools/mux_global_agents_read.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAY,IAAI,iCAAa;AAC7B,MAAY,UAAU,wCAAoB;AAC1C,2BAA0B;AAG1B,0EAAwE;AACxE,wDAAwE;AAExE,SAAS,iCAAiC,CAAC,MAAyB,EAAU;IAC5E,IAAI,CAAC,MAAM,CAAC,mBAAmB,EAAE,CAAC;QAChC,MAAM,IAAI,KAAK,CAAC,qDAAqD,CAAC,CAAC;IACzE,CAAC;IAED,yDAAyD;IACzD,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;IAC7D,OAAO,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;AAAA,CAClC;AAgBM,MAAM,6BAA6B,GAAgB,CAAC,MAAyB,EAAE,EAAE,CAAC;IACvF,OAAO,IAAA,SAAI,EAAC;QACV,WAAW,EAAE,kCAAgB,CAAC,sBAAsB,CAAC,WAAW;QAChE,WAAW,EAAE,kCAAgB,CAAC,sBAAsB,CAAC,MAAM;QAC3D,OAAO,EAAE,KAAK,EACZ,KAAK,EACL,EAAE,WAAW,EAAE,YAAY,EAAE,EACW,EAAE,CAAC;YAC3C,IAAI,CAAC;gBACH,IAAI,MAAM,CAAC,WAAW,KAAK,oCAA0B,EAAE,CAAC;oBACtD,OAAO;wBACL,OAAO,EAAE,KAAK;wBACd,KAAK,EAAE,gFAAgF;qBACxF,CAAC;gBACJ,CAAC;gBAED,MAAM,OAAO,GAAG,iCAAiC,CAAC,MAAM,CAAC,CAAC;gBAC1D,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;gBAEnD,IAAI,CAAC;oBACH,MAAM,IAAI,GAAG,MAAM,UAAU,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;oBAChD,IAAI,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC;wBAC1B,OAAO;4BACL,OAAO,EAAE,KAAK;4BACd,KAAK,EAAE,+CAA+C;yBACvD,CAAC;oBACJ,CAAC;oBAED,MAAM,OAAO,GAAG,MAAM,UAAU,CAAC,QAAQ,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;oBAC/D,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC;gBACpC,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,MAAM,IAAI,KAAK,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;wBACrF,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC;oBACxC,CAAC;oBAED,MAAM,KAAK,CAAC;gBACd,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBACvE,OAAO;oBACL,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,oCAAoC,OAAO,EAAE;iBACrD,CAAC;YACJ,CAAC;QAAA,CACF;KACF,CAAC,CAAC;AAAA,CACJ,CAAC;AA9CW,QAAA,6BAA6B,GAA7B,6BAA6B,CA8CxC","sourcesContent":["import * as path from \"path\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport { tool } from \"ai\";\r\n\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\n\r\nfunction getMuxHomeFromWorkspaceSessionDir(config: ToolConfiguration): string {\r\n  if (!config.workspaceSessionDir) {\r\n    throw new Error(\"mux_global_agents_read requires workspaceSessionDir\");\r\n  }\r\n\r\n  // workspaceSessionDir = <muxHome>/sessions/<workspaceId>\r\n  const sessionsDir = path.dirname(config.workspaceSessionDir);\r\n  return path.dirname(sessionsDir);\r\n}\r\n\r\nexport interface MuxGlobalAgentsReadToolResult {\r\n  success: true;\r\n  content: string;\r\n}\r\n\r\nexport interface MuxGlobalAgentsReadToolError {\r\n  success: false;\r\n  error: string;\r\n}\r\n\r\nexport type MuxGlobalAgentsReadToolOutput =\r\n  | MuxGlobalAgentsReadToolResult\r\n  | MuxGlobalAgentsReadToolError;\r\n\r\nexport const createMuxGlobalAgentsReadTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: TOOL_DEFINITIONS.mux_global_agents_read.description,\r\n    inputSchema: TOOL_DEFINITIONS.mux_global_agents_read.schema,\r\n    execute: async (\r\n      _args,\r\n      { abortSignal: _abortSignal }\r\n    ): Promise<MuxGlobalAgentsReadToolOutput> => {\r\n      try {\r\n        if (config.workspaceId !== MUX_HELP_CHAT_WORKSPACE_ID) {\r\n          return {\r\n            success: false,\r\n            error: \"mux_global_agents_read is only available in the Chat with Mux system workspace\",\r\n          };\r\n        }\r\n\r\n        const muxHome = getMuxHomeFromWorkspaceSessionDir(config);\r\n        const agentsPath = path.join(muxHome, \"AGENTS.md\");\r\n\r\n        try {\r\n          const stat = await fsPromises.lstat(agentsPath);\r\n          if (stat.isSymbolicLink()) {\r\n            return {\r\n              success: false,\r\n              error: \"Refusing to read a symlinked AGENTS.md target\",\r\n            };\r\n          }\r\n\r\n          const content = await fsPromises.readFile(agentsPath, \"utf-8\");\r\n          return { success: true, content };\r\n        } catch (error) {\r\n          if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\r\n            return { success: true, content: \"\" };\r\n          }\r\n\r\n          throw error;\r\n        }\r\n      } catch (error) {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        return {\r\n          success: false,\r\n          error: `Failed to read global AGENTS.md: ${message}`,\r\n        };\r\n      }\r\n    },\r\n  });\r\n};\r\n"]}