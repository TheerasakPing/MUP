{"version":3,"file":"agent_skill_read.js","sourceRoot":"","sources":["../../../../src/node/services/tools/agent_skill_read.ts"],"names":[],"mappings":"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","sourcesContent":["import { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { getBuiltInSkillByName } from \"@/node/services/agentSkills/builtInSkillDefinitions\";\r\n\r\nimport { tool } from \"ai\";\r\n\r\nimport type { AgentSkillReadToolResult } from \"@/common/types/tools\";\r\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\r\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\r\nimport { SkillNameSchema } from \"@/common/orpc/schemas\";\r\nimport { readAgentSkill } from \"@/node/services/agentSkills/agentSkillsService\";\r\n\r\nfunction formatError(error: unknown): string {\r\n  return error instanceof Error ? error.message : String(error);\r\n}\r\n\r\n/**\r\n * Build dynamic agent_skill_read tool description with available skills.\r\n * Injects the list of available skills directly into the tool description\r\n * so the model sees them adjacent to the tool call schema.\r\n */\r\nfunction buildSkillReadDescription(config: ToolConfiguration): string {\r\n  const baseDescription = TOOL_DEFINITIONS.agent_skill_read.description;\r\n  // Filter out unadvertised skills from the tool description.\r\n  // Unadvertised skills can still be invoked via /skill-name or agent_skill_read.\r\n  const skills = (config.availableSkills ?? []).filter((s) => s.advertise !== false);\r\n\r\n  if (skills.length === 0) {\r\n    return baseDescription;\r\n  }\r\n\r\n  const MAX_SKILLS = 50;\r\n  const shown = skills.slice(0, MAX_SKILLS);\r\n  const omitted = skills.length - shown.length;\r\n\r\n  const skillLines = shown.map(\r\n    (skill) => `- ${skill.name}: ${skill.description} (scope: ${skill.scope})`\r\n  );\r\n  if (omitted > 0) {\r\n    skillLines.push(`(+${omitted} more not shown)`);\r\n  }\r\n\r\n  const usageHint = `\\nTo read referenced files inside a skill directory:\\n- agent_skill_read_file({ name: \"<skill-name>\", filePath: \"references/whatever.txt\" })`;\r\n\r\n  return `${baseDescription}\\n\\nAvailable skills:\\n${skillLines.join(\"\\n\")}${usageHint}`;\r\n}\r\n\r\n/**\r\n * Agent Skill read tool factory.\r\n * Reads and validates a skill's SKILL.md from project-local or global skills roots.\r\n */\r\nexport const createAgentSkillReadTool: ToolFactory = (config: ToolConfiguration) => {\r\n  return tool({\r\n    description: buildSkillReadDescription(config),\r\n    inputSchema: TOOL_DEFINITIONS.agent_skill_read.schema,\r\n    execute: async ({ name }): Promise<AgentSkillReadToolResult> => {\r\n      const workspacePath = config.cwd;\r\n      if (!workspacePath) {\r\n        return {\r\n          success: false,\r\n          error: \"Tool misconfigured: cwd is required.\",\r\n        };\r\n      }\r\n\r\n      // Defensive: validate again even though inputSchema should guarantee shape.\r\n      const parsedName = SkillNameSchema.safeParse(name);\r\n      if (!parsedName.success) {\r\n        return {\r\n          success: false,\r\n          error: parsedName.error.message,\r\n        };\r\n      }\r\n\r\n      try {\r\n        // Chat with Mux intentionally has no generic filesystem access. Restrict skill reads to\r\n        // built-in skills (bundled in the app) so users can access help like `mux-docs` without\r\n        // granting access to project/global skills on disk.\r\n        if (config.workspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\r\n          const builtIn = getBuiltInSkillByName(parsedName.data);\r\n          if (!builtIn) {\r\n            return {\r\n              success: false,\r\n              error: `Only built-in skills are available in Chat with Mux (requested: ${parsedName.data}).`,\r\n            };\r\n          }\r\n\r\n          return {\r\n            success: true,\r\n            skill: builtIn,\r\n          };\r\n        }\r\n\r\n        const resolved = await readAgentSkill(config.runtime, workspacePath, parsedName.data);\r\n        return {\r\n          success: true,\r\n          skill: resolved.package,\r\n        };\r\n      } catch (error) {\r\n        return {\r\n          success: false,\r\n          error: formatError(error),\r\n        };\r\n      }\r\n    },\r\n  });\r\n};\r\n"]}