{"version":3,"file":"agent_skill_read.js","sourceRoot":"","sources":["../../../../src/node/services/tools/agent_skill_read.ts"],"names":[],"mappings":"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","sourcesContent":["import { MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\nimport { getBuiltInSkillByName } from \"@/node/services/agentSkills/builtInSkillDefinitions\";\n\nimport { tool } from \"ai\";\n\nimport type { AgentSkillReadToolResult } from \"@/common/types/tools\";\nimport type { ToolConfiguration, ToolFactory } from \"@/common/utils/tools/tools\";\nimport { TOOL_DEFINITIONS } from \"@/common/utils/tools/toolDefinitions\";\nimport { SkillNameSchema } from \"@/common/orpc/schemas\";\nimport { readAgentSkill } from \"@/node/services/agentSkills/agentSkillsService\";\n\nfunction formatError(error: unknown): string {\n  return error instanceof Error ? error.message : String(error);\n}\n\n/**\n * Build dynamic agent_skill_read tool description with available skills.\n * Injects the list of available skills directly into the tool description\n * so the model sees them adjacent to the tool call schema.\n */\nfunction buildSkillReadDescription(config: ToolConfiguration): string {\n  const baseDescription = TOOL_DEFINITIONS.agent_skill_read.description;\n  // Filter out unadvertised skills from the tool description.\n  // Unadvertised skills can still be invoked via /skill-name or agent_skill_read.\n  const skills = (config.availableSkills ?? []).filter((s) => s.advertise !== false);\n\n  if (skills.length === 0) {\n    return baseDescription;\n  }\n\n  const MAX_SKILLS = 50;\n  const shown = skills.slice(0, MAX_SKILLS);\n  const omitted = skills.length - shown.length;\n\n  const skillLines = shown.map(\n    (skill) => `- ${skill.name}: ${skill.description} (scope: ${skill.scope})`\n  );\n  if (omitted > 0) {\n    skillLines.push(`(+${omitted} more not shown)`);\n  }\n\n  const usageHint = `\\nTo read referenced files inside a skill directory:\\n- agent_skill_read_file({ name: \"<skill-name>\", filePath: \"references/whatever.txt\" })`;\n\n  return `${baseDescription}\\n\\nAvailable skills:\\n${skillLines.join(\"\\n\")}${usageHint}`;\n}\n\n/**\n * Agent Skill read tool factory.\n * Reads and validates a skill's SKILL.md from project-local or global skills roots.\n */\nexport const createAgentSkillReadTool: ToolFactory = (config: ToolConfiguration) => {\n  return tool({\n    description: buildSkillReadDescription(config),\n    inputSchema: TOOL_DEFINITIONS.agent_skill_read.schema,\n    execute: async ({ name }): Promise<AgentSkillReadToolResult> => {\n      const workspacePath = config.cwd;\n      if (!workspacePath) {\n        return {\n          success: false,\n          error: \"Tool misconfigured: cwd is required.\",\n        };\n      }\n\n      // Defensive: validate again even though inputSchema should guarantee shape.\n      const parsedName = SkillNameSchema.safeParse(name);\n      if (!parsedName.success) {\n        return {\n          success: false,\n          error: parsedName.error.message,\n        };\n      }\n\n      try {\n        // Chat with Mux intentionally has no generic filesystem access. Restrict skill reads to\n        // built-in skills (bundled in the app) so users can access help like `mux-docs` without\n        // granting access to project/global skills on disk.\n        if (config.workspaceId === MUX_HELP_CHAT_WORKSPACE_ID) {\n          const builtIn = getBuiltInSkillByName(parsedName.data);\n          if (!builtIn) {\n            return {\n              success: false,\n              error: `Only built-in skills are available in Chat with Mux (requested: ${parsedName.data}).`,\n            };\n          }\n\n          return {\n            success: true,\n            skill: builtIn,\n          };\n        }\n\n        const resolved = await readAgentSkill(config.runtime, workspacePath, parsedName.data);\n        return {\n          success: true,\n          skill: resolved.package,\n        };\n      } catch (error) {\n        return {\n          success: false,\n          error: formatError(error),\n        };\n      }\n    },\n  });\n};\n"]}