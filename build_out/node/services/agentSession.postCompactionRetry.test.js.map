{"version":3,"file":"agentSession.postCompactionRetry.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.postCompactionRetry.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, mock, afterEach, spyOn } from \"bun:test\";\nimport { EventEmitter } from \"events\";\nimport * as fsPromises from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\nimport { AgentSession } from \"./agentSession\";\nimport type { Config } from \"@/node/config\";\nimport type { PartialService } from \"./partialService\";\nimport type { AIService } from \"./aiService\";\nimport type { InitStateManager } from \"./initStateManager\";\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\n\nimport type { MuxMessage } from \"@/common/types/message\";\nimport type { SendMessageOptions } from \"@/common/orpc/types\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport type { CostTrackingService } from \"./costTrackingService\";\n\nfunction createPersistedPostCompactionState(options: {\n  filePath: string;\n  diffs: Array<{ path: string; diff: string; truncated: boolean }>;\n}): Promise<void> {\n  const payload = {\n    version: 1 as const,\n    createdAt: Date.now(),\n    diffs: options.diffs,\n  };\n\n  return fsPromises.writeFile(options.filePath, JSON.stringify(payload));\n}\n\ndescribe(\"AgentSession post-compaction context retry\", () => {\n  let historyCleanup: (() => Promise<void>) | undefined;\n  afterEach(async () => {\n    await historyCleanup?.();\n  });\n\n  test(\"retries once without post-compaction injection on context_exceeded\", async () => {\n    const workspaceId = \"ws\";\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\n    const postCompactionPath = path.join(sessionDir, \"post-compaction.json\");\n\n    await createPersistedPostCompactionState({\n      filePath: postCompactionPath,\n      diffs: [\n        {\n          path: \"/tmp/foo.ts\",\n          diff: \"@@ -1 +1 @@\\n-foo\\n+bar\\n\",\n          truncated: false,\n        },\n      ],\n    });\n\n    const history: MuxMessage[] = [\n      {\n        id: \"compaction-summary\",\n        role: \"assistant\",\n        parts: [{ type: \"text\", text: \"Summary\" }],\n        metadata: { timestamp: 1000, compacted: \"user\" },\n      },\n      {\n        id: \"user-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"Continue\" }],\n        metadata: { timestamp: 1100 },\n      },\n    ];\n\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n    for (const msg of history) {\n      await historyService.appendToHistory(workspaceId, msg);\n    }\n    spyOn(historyService, \"deleteMessage\");\n\n    const partialService: PartialService = {\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as PartialService;\n\n    const aiEmitter = new EventEmitter();\n\n    let resolveSecondCall: (() => void) | undefined;\n    const secondCall = new Promise<void>((resolve) => {\n      resolveSecondCall = resolve;\n    });\n\n    let callCount = 0;\n    const streamMessage = mock((..._args: unknown[]) => {\n      callCount += 1;\n\n      if (callCount === 1) {\n        // Simulate a provider context limit error before any deltas.\n        aiEmitter.emit(\"error\", {\n          workspaceId,\n          messageId: \"assistant-ctx-exceeded\",\n          error: \"Context length exceeded\",\n          errorType: \"context_exceeded\",\n        });\n\n        return Promise.resolve({ success: true as const, data: undefined });\n      }\n\n      resolveSecondCall?.();\n      return Promise.resolve({ success: true as const, data: undefined });\n    });\n\n    const aiService: AIService = {\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.on(String(eventName), listener);\n        return this;\n      },\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.off(String(eventName), listener);\n        return this;\n      },\n      streamMessage,\n      getWorkspaceMetadata: mock(() => Promise.resolve({ success: false as const, error: \"nope\" })),\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as AIService;\n\n    const initStateManager: InitStateManager = {\n      on() {\n        return this;\n      },\n      off() {\n        return this;\n      },\n    } as unknown as InitStateManager;\n\n    const backgroundProcessManager: BackgroundProcessManager = {\n      setMessageQueued: mock(() => undefined),\n      cleanup: mock(() => Promise.resolve()),\n    } as unknown as BackgroundProcessManager;\n\n    const config: Config = {\n      srcDir: \"/tmp\",\n      getSessionDir: mock(() => sessionDir),\n    } as unknown as Config;\n\n    const session = new AgentSession({\n      workspaceId,\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService: {} as unknown as CostTrackingService,\n      backgroundProcessManager,\n    });\n\n    const options: SendMessageOptions = {\n      model: \"openai:gpt-4o\",\n      agentId: \"exec\",\n    } as unknown as SendMessageOptions;\n\n    // Call streamWithHistory directly (private) to avoid needing a full user send pipeline.\n    await (\n      session as unknown as {\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\n      }\n    ).streamWithHistory(options.model, options);\n\n    // Wait for the retry call to happen.\n    await Promise.race([\n      secondCall,\n      new Promise((_, reject) => setTimeout(() => reject(new Error(\"retry timeout\")), 1000)),\n    ]);\n\n    expect(streamMessage).toHaveBeenCalledTimes(2);\n\n    // With the options bag, arg[0] is the StreamMessageOptions object.\n    const firstOpts = (streamMessage as ReturnType<typeof mock>).mock.calls[0][0] as Record<\n      string,\n      unknown\n    >;\n    expect(Array.isArray(firstOpts.postCompactionAttachments)).toBe(true);\n\n    const secondOpts = (streamMessage as ReturnType<typeof mock>).mock.calls[1][0] as Record<\n      string,\n      unknown\n    >;\n    expect(secondOpts.postCompactionAttachments).toBeNull();\n\n    expect((historyService.deleteMessage as ReturnType<typeof mock>).mock.calls[0][1]).toBe(\n      \"assistant-ctx-exceeded\"\n    );\n\n    // Pending post-compaction state should be discarded.\n    let exists = true;\n    try {\n      await fsPromises.stat(postCompactionPath);\n    } catch {\n      exists = false;\n    }\n    expect(exists).toBe(false);\n\n    session.dispose();\n  });\n});\n\ndescribe(\"AgentSession execSubagentHardRestart\", () => {\n  let historyCleanup: (() => Promise<void>) | undefined;\n  afterEach(async () => {\n    await historyCleanup?.();\n  });\n\n  test(\"hard-restarts exec-like subagent history on context_exceeded and retries once\", async () => {\n    const workspaceId = \"ws-hard\";\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\n\n    const history: MuxMessage[] = [\n      {\n        id: \"snapshot-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"<snapshot>\" }],\n        metadata: {\n          timestamp: 1000,\n          synthetic: true,\n          fileAtMentionSnapshot: [\"@foo\"],\n        },\n      },\n      {\n        id: \"user-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"Do the thing\" }],\n        metadata: {\n          timestamp: 1100,\n        },\n      },\n    ];\n\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n    for (const msg of history) {\n      await historyService.appendToHistory(workspaceId, msg);\n    }\n    spyOn(historyService, \"clearHistory\");\n    spyOn(historyService, \"appendToHistory\");\n\n    const partialService: PartialService = {\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as PartialService;\n\n    const aiEmitter = new EventEmitter();\n\n    let resolveSecondCall: (() => void) | undefined;\n    const secondCall = new Promise<void>((resolve) => {\n      resolveSecondCall = resolve;\n    });\n\n    let callCount = 0;\n    const streamMessage = mock((..._args: unknown[]) => {\n      callCount += 1;\n\n      if (callCount === 1) {\n        aiEmitter.emit(\"error\", {\n          workspaceId,\n          messageId: \"assistant-ctx-exceeded-1\",\n          error: \"Context length exceeded\",\n          errorType: \"context_exceeded\",\n        });\n        return Promise.resolve({ success: true as const, data: undefined });\n      }\n\n      if (callCount === 2) {\n        // Second context_exceeded should NOT trigger an additional hard restart.\n        aiEmitter.emit(\"error\", {\n          workspaceId,\n          messageId: \"assistant-ctx-exceeded-2\",\n          error: \"Context length exceeded\",\n          errorType: \"context_exceeded\",\n        });\n        resolveSecondCall?.();\n        return Promise.resolve({ success: true as const, data: undefined });\n      }\n\n      throw new Error(\"unexpected third streamMessage call\");\n    });\n\n    const parentWorkspaceId = \"parent\";\n\n    const childWorkspaceMetadata = {\n      id: workspaceId,\n      name: \"child\",\n      projectName: \"proj\",\n      projectPath: \"/tmp/proj\",\n      namedWorkspacePath: \"/tmp/proj/child\",\n      runtimeConfig: { type: \"local\" },\n      parentWorkspaceId,\n      agentId: \"exec\",\n    };\n\n    const parentWorkspaceMetadata = {\n      ...childWorkspaceMetadata,\n      id: parentWorkspaceId,\n      name: \"parent\",\n      parentWorkspaceId: undefined,\n    };\n\n    const getWorkspaceMetadata = mock((id: string) => {\n      if (id === workspaceId) {\n        return Promise.resolve({\n          success: true as const,\n          data: childWorkspaceMetadata as never,\n        });\n      }\n\n      if (id === parentWorkspaceId) {\n        return Promise.resolve({\n          success: true as const,\n          data: parentWorkspaceMetadata as never,\n        });\n      }\n\n      return Promise.resolve({ success: false as const, error: \"unknown\" });\n    });\n\n    const aiService: AIService = {\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.on(String(eventName), listener);\n        return this;\n      },\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.off(String(eventName), listener);\n        return this;\n      },\n      streamMessage,\n      getWorkspaceMetadata,\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as AIService;\n\n    const initStateManager: InitStateManager = {\n      on() {\n        return this;\n      },\n      off() {\n        return this;\n      },\n    } as unknown as InitStateManager;\n\n    const backgroundProcessManager: BackgroundProcessManager = {\n      setMessageQueued: mock(() => undefined),\n      cleanup: mock(() => Promise.resolve()),\n    } as unknown as BackgroundProcessManager;\n\n    const config: Config = {\n      srcDir: \"/tmp\",\n      getSessionDir: mock(() => sessionDir),\n    } as unknown as Config;\n\n    const session = new AgentSession({\n      workspaceId,\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService: {} as unknown as CostTrackingService,\n      backgroundProcessManager,\n    });\n\n    const options: SendMessageOptions = {\n      model: \"openai:gpt-4o\",\n      agentId: \"exec\",\n      experiments: {\n        execSubagentHardRestart: true,\n      },\n    } as unknown as SendMessageOptions;\n\n    await (\n      session as unknown as {\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\n      }\n    ).streamWithHistory(options.model, options);\n\n    await Promise.race([\n      secondCall,\n      new Promise((_, reject) => setTimeout(() => reject(new Error(\"retry timeout\")), 1000)),\n    ]);\n\n    expect(streamMessage).toHaveBeenCalledTimes(2);\n    expect((historyService.clearHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(1);\n\n    // Continuation notice + seed prompt (and snapshots) should be appended after clear.\n    expect((historyService.appendToHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(3);\n\n    const appendedNotice = (historyService.appendToHistory as ReturnType<typeof mock>).mock\n      .calls[0][1] as MuxMessage | undefined;\n    expect(appendedNotice?.metadata?.synthetic).toBe(true);\n    expect(appendedNotice?.metadata?.uiVisible).toBe(true);\n    const noticeText = appendedNotice?.parts.find((p) => p.type === \"text\") as\n      | { type: \"text\"; text: string }\n      | undefined;\n    expect(noticeText?.text).toContain(\"restarted\");\n\n    expect(\n      ((historyService.appendToHistory as ReturnType<typeof mock>).mock.calls[1][1] as MuxMessage)\n        .id\n    ).toBe(\"snapshot-1\");\n    expect(\n      ((historyService.appendToHistory as ReturnType<typeof mock>).mock.calls[2][1] as MuxMessage)\n        .id\n    ).toBe(\"user-1\");\n\n    // Retry should include the continuation notice in additionalSystemInstructions.\n    const retryOpts = (streamMessage as ReturnType<typeof mock>).mock.calls[1][0] as Record<\n      string,\n      unknown\n    >;\n    expect(String(retryOpts.additionalSystemInstructions)).toContain(\"restarted\");\n\n    session.dispose();\n  });\n\n  test(\"resolves exec-like predicate from parent workspace when child agents are missing\", async () => {\n    const workspaceId = \"ws-hard-custom-agent\";\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\n\n    const history: MuxMessage[] = [\n      {\n        id: \"user-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"Do the thing\" }],\n        metadata: {\n          timestamp: 1100,\n        },\n      },\n    ];\n\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n    for (const msg of history) {\n      await historyService.appendToHistory(workspaceId, msg);\n    }\n    spyOn(historyService, \"clearHistory\");\n    spyOn(historyService, \"appendToHistory\");\n\n    const partialService: PartialService = {\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as PartialService;\n\n    const aiEmitter = new EventEmitter();\n\n    let resolveSecondCall: (() => void) | undefined;\n    const secondCall = new Promise<void>((resolve) => {\n      resolveSecondCall = resolve;\n    });\n\n    let callCount = 0;\n    const streamMessage = mock((..._args: unknown[]) => {\n      callCount += 1;\n\n      if (callCount === 1) {\n        // Simulate a provider context limit error before any deltas.\n        aiEmitter.emit(\"error\", {\n          workspaceId,\n          messageId: \"assistant-ctx-exceeded-1\",\n          error: \"Context length exceeded\",\n          errorType: \"context_exceeded\",\n        });\n\n        return Promise.resolve({ success: true as const, data: undefined });\n      }\n\n      resolveSecondCall?.();\n      return Promise.resolve({ success: true as const, data: undefined });\n    });\n\n    const customAgentId = \"custom_hard_restart_agent\";\n\n    const srcBaseDir = await fsPromises.mkdtemp(\n      path.join(os.tmpdir(), \"mux-agentSession-worktrees-\")\n    );\n    const projectPath = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-proj-\"));\n\n    // Create a custom agent definition ONLY in the parent workspace path.\n    // This simulates untracked .mux/agents that are present in the parent worktree but absent\n    // from the child task worktree.\n    const parentWorkspaceName = \"parent\";\n    const parentAgentsDir = path.join(\n      srcBaseDir,\n      path.basename(projectPath),\n      parentWorkspaceName,\n      \".mux\",\n      \"agents\"\n    );\n    await fsPromises.mkdir(parentAgentsDir, { recursive: true });\n    await fsPromises.writeFile(\n      path.join(parentAgentsDir, `${customAgentId}.md`),\n      [\n        \"---\",\n        \"name: Custom Hard Restart Agent\",\n        \"description: Test agent inheriting exec\",\n        \"base: exec\",\n        \"---\",\n        \"\",\n        \"Body\",\n        \"\",\n      ].join(\"\\n\")\n    );\n\n    const parentWorkspaceId = \"parent-custom\";\n\n    const childWorkspaceMetadata = {\n      id: workspaceId,\n      name: \"child\",\n      projectName: \"proj\",\n      projectPath,\n      runtimeConfig: { type: \"worktree\", srcBaseDir },\n      parentWorkspaceId,\n      agentId: customAgentId,\n    };\n\n    const parentWorkspaceMetadata = {\n      ...childWorkspaceMetadata,\n      id: parentWorkspaceId,\n      name: parentWorkspaceName,\n      parentWorkspaceId: undefined,\n      agentId: \"exec\",\n    };\n\n    const getWorkspaceMetadata = mock((id: string) => {\n      if (id === workspaceId) {\n        return Promise.resolve({\n          success: true as const,\n          data: childWorkspaceMetadata as never,\n        });\n      }\n\n      if (id === parentWorkspaceId) {\n        return Promise.resolve({\n          success: true as const,\n          data: parentWorkspaceMetadata as never,\n        });\n      }\n\n      return Promise.resolve({ success: false as const, error: \"unknown\" });\n    });\n\n    const aiService: AIService = {\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.on(String(eventName), listener);\n        return this;\n      },\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.off(String(eventName), listener);\n        return this;\n      },\n      streamMessage,\n      getWorkspaceMetadata,\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as AIService;\n\n    const initStateManager: InitStateManager = {\n      on() {\n        return this;\n      },\n      off() {\n        return this;\n      },\n    } as unknown as InitStateManager;\n\n    const backgroundProcessManager: BackgroundProcessManager = {\n      setMessageQueued: mock(() => undefined),\n      cleanup: mock(() => Promise.resolve()),\n    } as unknown as BackgroundProcessManager;\n\n    const config: Config = {\n      srcDir: \"/tmp\",\n      getSessionDir: mock(() => sessionDir),\n    } as unknown as Config;\n\n    const session = new AgentSession({\n      workspaceId,\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService: {} as unknown as CostTrackingService,\n      backgroundProcessManager,\n    });\n\n    const options: SendMessageOptions = {\n      model: \"openai:gpt-4o\",\n      agentId: customAgentId,\n      experiments: {\n        execSubagentHardRestart: true,\n      },\n    } as unknown as SendMessageOptions;\n\n    await (\n      session as unknown as {\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\n      }\n    ).streamWithHistory(options.model, options);\n\n    await Promise.race([\n      secondCall,\n      new Promise((_, reject) => setTimeout(() => reject(new Error(\"retry timeout\")), 1000)),\n    ]);\n\n    expect(streamMessage).toHaveBeenCalledTimes(2);\n    expect((historyService.clearHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(1);\n\n    session.dispose();\n  });\n\n  test(\"does not hard-restart when workspace is not a subagent\", async () => {\n    const workspaceId = \"ws-hard-no-parent\";\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\n\n    const history: MuxMessage[] = [\n      {\n        id: \"user-1\",\n        role: \"user\",\n        parts: [{ type: \"text\", text: \"Do the thing\" }],\n        metadata: { timestamp: 1100 },\n      },\n    ];\n\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n    for (const msg of history) {\n      await historyService.appendToHistory(workspaceId, msg);\n    }\n    spyOn(historyService, \"clearHistory\");\n\n    const partialService: PartialService = {\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as PartialService;\n\n    const aiEmitter = new EventEmitter();\n\n    const streamMessage = mock((..._args: unknown[]) => {\n      aiEmitter.emit(\"error\", {\n        workspaceId,\n        messageId: \"assistant-ctx-exceeded\",\n        error: \"Context length exceeded\",\n        errorType: \"context_exceeded\",\n      });\n      return Promise.resolve({ success: true as const, data: undefined });\n    });\n\n    const workspaceMetadata = {\n      id: workspaceId,\n      name: \"child\",\n      projectName: \"proj\",\n      projectPath: \"/tmp/proj\",\n      namedWorkspacePath: \"/tmp/proj/child\",\n      runtimeConfig: { type: \"local\" },\n      agentId: \"exec\",\n    };\n\n    const aiService: AIService = {\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.on(String(eventName), listener);\n        return this;\n      },\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\n        aiEmitter.off(String(eventName), listener);\n        return this;\n      },\n      streamMessage,\n      getWorkspaceMetadata: mock(() =>\n        Promise.resolve({ success: true as const, data: workspaceMetadata as never })\n      ),\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\n    } as unknown as AIService;\n\n    const initStateManager: InitStateManager = {\n      on() {\n        return this;\n      },\n      off() {\n        return this;\n      },\n    } as unknown as InitStateManager;\n\n    const backgroundProcessManager: BackgroundProcessManager = {\n      setMessageQueued: mock(() => undefined),\n      cleanup: mock(() => Promise.resolve()),\n    } as unknown as BackgroundProcessManager;\n\n    const config: Config = {\n      srcDir: \"/tmp\",\n      getSessionDir: mock(() => sessionDir),\n    } as unknown as Config;\n\n    const session = new AgentSession({\n      workspaceId,\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService: {} as unknown as CostTrackingService,\n      backgroundProcessManager,\n    });\n\n    const options: SendMessageOptions = {\n      model: \"openai:gpt-4o\",\n      agentId: \"exec\",\n      experiments: {\n        execSubagentHardRestart: true,\n      },\n    } as unknown as SendMessageOptions;\n\n    await (\n      session as unknown as {\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\n      }\n    ).streamWithHistory(options.model, options);\n\n    await new Promise((resolve) => setTimeout(resolve, 25));\n\n    expect(streamMessage).toHaveBeenCalledTimes(1);\n    expect((historyService.clearHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(0);\n\n    session.dispose();\n  });\n});\n"]}