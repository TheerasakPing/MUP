{"version":3,"file":"agentSession.postCompactionRetry.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.postCompactionRetry.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, mock, afterEach, spyOn } from \"bun:test\";\r\nimport { EventEmitter } from \"events\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\n\r\nimport { AgentSession } from \"./agentSession\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport type { AIService } from \"./aiService\";\r\nimport type { InitStateManager } from \"./initStateManager\";\r\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\r\n\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport type { SendMessageOptions } from \"@/common/orpc/types\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { CostTrackingService } from \"./costTrackingService\";\r\n\r\nfunction createPersistedPostCompactionState(options: {\r\n  filePath: string;\r\n  diffs: Array<{ path: string; diff: string; truncated: boolean }>;\r\n}): Promise<void> {\r\n  const payload = {\r\n    version: 1 as const,\r\n    createdAt: Date.now(),\r\n    diffs: options.diffs,\r\n  };\r\n\r\n  return fsPromises.writeFile(options.filePath, JSON.stringify(payload));\r\n}\r\n\r\ndescribe(\"AgentSession post-compaction context retry\", () => {\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  test(\"retries once without post-compaction injection on context_exceeded\", async () => {\r\n    const workspaceId = \"ws\";\r\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\r\n    const postCompactionPath = path.join(sessionDir, \"post-compaction.json\");\r\n\r\n    await createPersistedPostCompactionState({\r\n      filePath: postCompactionPath,\r\n      diffs: [\r\n        {\r\n          path: \"/tmp/foo.ts\",\r\n          diff: \"@@ -1 +1 @@\\n-foo\\n+bar\\n\",\r\n          truncated: false,\r\n        },\r\n      ],\r\n    });\r\n\r\n    const history: MuxMessage[] = [\r\n      {\r\n        id: \"compaction-summary\",\r\n        role: \"assistant\",\r\n        parts: [{ type: \"text\", text: \"Summary\" }],\r\n        metadata: { timestamp: 1000, compacted: \"user\" },\r\n      },\r\n      {\r\n        id: \"user-1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"Continue\" }],\r\n        metadata: { timestamp: 1100 },\r\n      },\r\n    ];\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n    for (const msg of history) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n    spyOn(historyService, \"deleteMessage\");\r\n\r\n    const partialService: PartialService = {\r\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    let resolveSecondCall: (() => void) | undefined;\r\n    const secondCall = new Promise<void>((resolve) => {\r\n      resolveSecondCall = resolve;\r\n    });\r\n\r\n    let callCount = 0;\r\n    const streamMessage = mock((..._args: unknown[]) => {\r\n      callCount += 1;\r\n\r\n      if (callCount === 1) {\r\n        // Simulate a provider context limit error before any deltas.\r\n        aiEmitter.emit(\"error\", {\r\n          workspaceId,\r\n          messageId: \"assistant-ctx-exceeded\",\r\n          error: \"Context length exceeded\",\r\n          errorType: \"context_exceeded\",\r\n        });\r\n\r\n        return Promise.resolve({ success: true as const, data: undefined });\r\n      }\r\n\r\n      resolveSecondCall?.();\r\n      return Promise.resolve({ success: true as const, data: undefined });\r\n    });\r\n\r\n    const aiService: AIService = {\r\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.on(String(eventName), listener);\r\n        return this;\r\n      },\r\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.off(String(eventName), listener);\r\n        return this;\r\n      },\r\n      streamMessage,\r\n      getWorkspaceMetadata: mock(() => Promise.resolve({ success: false as const, error: \"nope\" })),\r\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as AIService;\r\n\r\n    const initStateManager: InitStateManager = {\r\n      on() {\r\n        return this;\r\n      },\r\n      off() {\r\n        return this;\r\n      },\r\n    } as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager: BackgroundProcessManager = {\r\n      setMessageQueued: mock(() => undefined),\r\n      cleanup: mock(() => Promise.resolve()),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const config: Config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: mock(() => sessionDir),\r\n    } as unknown as Config;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const options: SendMessageOptions = {\r\n      model: \"openai:gpt-4o\",\r\n      agentId: \"exec\",\r\n    } as unknown as SendMessageOptions;\r\n\r\n    // Call streamWithHistory directly (private) to avoid needing a full user send pipeline.\r\n    await (\r\n      session as unknown as {\r\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\r\n      }\r\n    ).streamWithHistory(options.model, options);\r\n\r\n    // Wait for the retry call to happen.\r\n    await Promise.race([\r\n      secondCall,\r\n      new Promise((_, reject) => setTimeout(() => reject(new Error(\"retry timeout\")), 1000)),\r\n    ]);\r\n\r\n    expect(streamMessage).toHaveBeenCalledTimes(2);\r\n\r\n    // With the options bag, arg[0] is the StreamMessageOptions object.\r\n    const firstOpts = (streamMessage as ReturnType<typeof mock>).mock.calls[0][0] as Record<\r\n      string,\r\n      unknown\r\n    >;\r\n    expect(Array.isArray(firstOpts.postCompactionAttachments)).toBe(true);\r\n\r\n    const secondOpts = (streamMessage as ReturnType<typeof mock>).mock.calls[1][0] as Record<\r\n      string,\r\n      unknown\r\n    >;\r\n    expect(secondOpts.postCompactionAttachments).toBeNull();\r\n\r\n    expect((historyService.deleteMessage as ReturnType<typeof mock>).mock.calls[0][1]).toBe(\r\n      \"assistant-ctx-exceeded\"\r\n    );\r\n\r\n    // Pending post-compaction state should be discarded.\r\n    let exists = true;\r\n    try {\r\n      await fsPromises.stat(postCompactionPath);\r\n    } catch {\r\n      exists = false;\r\n    }\r\n    expect(exists).toBe(false);\r\n\r\n    session.dispose();\r\n  });\r\n});\r\n\r\ndescribe(\"AgentSession execSubagentHardRestart\", () => {\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  test(\"hard-restarts exec-like subagent history on context_exceeded and retries once\", async () => {\r\n    const workspaceId = \"ws-hard\";\r\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\r\n\r\n    const history: MuxMessage[] = [\r\n      {\r\n        id: \"snapshot-1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"<snapshot>\" }],\r\n        metadata: {\r\n          timestamp: 1000,\r\n          synthetic: true,\r\n          fileAtMentionSnapshot: [\"@foo\"],\r\n        },\r\n      },\r\n      {\r\n        id: \"user-1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"Do the thing\" }],\r\n        metadata: {\r\n          timestamp: 1100,\r\n        },\r\n      },\r\n    ];\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n    for (const msg of history) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n    spyOn(historyService, \"clearHistory\");\r\n    spyOn(historyService, \"appendToHistory\");\r\n\r\n    const partialService: PartialService = {\r\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    let resolveSecondCall: (() => void) | undefined;\r\n    const secondCall = new Promise<void>((resolve) => {\r\n      resolveSecondCall = resolve;\r\n    });\r\n\r\n    let callCount = 0;\r\n    const streamMessage = mock((..._args: unknown[]) => {\r\n      callCount += 1;\r\n\r\n      if (callCount === 1) {\r\n        aiEmitter.emit(\"error\", {\r\n          workspaceId,\r\n          messageId: \"assistant-ctx-exceeded-1\",\r\n          error: \"Context length exceeded\",\r\n          errorType: \"context_exceeded\",\r\n        });\r\n        return Promise.resolve({ success: true as const, data: undefined });\r\n      }\r\n\r\n      if (callCount === 2) {\r\n        // Second context_exceeded should NOT trigger an additional hard restart.\r\n        aiEmitter.emit(\"error\", {\r\n          workspaceId,\r\n          messageId: \"assistant-ctx-exceeded-2\",\r\n          error: \"Context length exceeded\",\r\n          errorType: \"context_exceeded\",\r\n        });\r\n        resolveSecondCall?.();\r\n        return Promise.resolve({ success: true as const, data: undefined });\r\n      }\r\n\r\n      throw new Error(\"unexpected third streamMessage call\");\r\n    });\r\n\r\n    const parentWorkspaceId = \"parent\";\r\n\r\n    const childWorkspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"child\",\r\n      projectName: \"proj\",\r\n      projectPath: \"/tmp/proj\",\r\n      namedWorkspacePath: \"/tmp/proj/child\",\r\n      runtimeConfig: { type: \"local\" },\r\n      parentWorkspaceId,\r\n      agentId: \"exec\",\r\n    };\r\n\r\n    const parentWorkspaceMetadata = {\r\n      ...childWorkspaceMetadata,\r\n      id: parentWorkspaceId,\r\n      name: \"parent\",\r\n      parentWorkspaceId: undefined,\r\n    };\r\n\r\n    const getWorkspaceMetadata = mock((id: string) => {\r\n      if (id === workspaceId) {\r\n        return Promise.resolve({\r\n          success: true as const,\r\n          data: childWorkspaceMetadata as never,\r\n        });\r\n      }\r\n\r\n      if (id === parentWorkspaceId) {\r\n        return Promise.resolve({\r\n          success: true as const,\r\n          data: parentWorkspaceMetadata as never,\r\n        });\r\n      }\r\n\r\n      return Promise.resolve({ success: false as const, error: \"unknown\" });\r\n    });\r\n\r\n    const aiService: AIService = {\r\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.on(String(eventName), listener);\r\n        return this;\r\n      },\r\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.off(String(eventName), listener);\r\n        return this;\r\n      },\r\n      streamMessage,\r\n      getWorkspaceMetadata,\r\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as AIService;\r\n\r\n    const initStateManager: InitStateManager = {\r\n      on() {\r\n        return this;\r\n      },\r\n      off() {\r\n        return this;\r\n      },\r\n    } as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager: BackgroundProcessManager = {\r\n      setMessageQueued: mock(() => undefined),\r\n      cleanup: mock(() => Promise.resolve()),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const config: Config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: mock(() => sessionDir),\r\n    } as unknown as Config;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const options: SendMessageOptions = {\r\n      model: \"openai:gpt-4o\",\r\n      agentId: \"exec\",\r\n      experiments: {\r\n        execSubagentHardRestart: true,\r\n      },\r\n    } as unknown as SendMessageOptions;\r\n\r\n    await (\r\n      session as unknown as {\r\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\r\n      }\r\n    ).streamWithHistory(options.model, options);\r\n\r\n    await Promise.race([\r\n      secondCall,\r\n      new Promise((_, reject) => setTimeout(() => reject(new Error(\"retry timeout\")), 1000)),\r\n    ]);\r\n\r\n    expect(streamMessage).toHaveBeenCalledTimes(2);\r\n    expect((historyService.clearHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(1);\r\n\r\n    // Continuation notice + seed prompt (and snapshots) should be appended after clear.\r\n    expect((historyService.appendToHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(3);\r\n\r\n    const appendedNotice = (historyService.appendToHistory as ReturnType<typeof mock>).mock\r\n      .calls[0][1] as MuxMessage | undefined;\r\n    expect(appendedNotice?.metadata?.synthetic).toBe(true);\r\n    expect(appendedNotice?.metadata?.uiVisible).toBe(true);\r\n    const noticeText = appendedNotice?.parts.find((p) => p.type === \"text\") as\r\n      | { type: \"text\"; text: string }\r\n      | undefined;\r\n    expect(noticeText?.text).toContain(\"restarted\");\r\n\r\n    expect(\r\n      ((historyService.appendToHistory as ReturnType<typeof mock>).mock.calls[1][1] as MuxMessage)\r\n        .id\r\n    ).toBe(\"snapshot-1\");\r\n    expect(\r\n      ((historyService.appendToHistory as ReturnType<typeof mock>).mock.calls[2][1] as MuxMessage)\r\n        .id\r\n    ).toBe(\"user-1\");\r\n\r\n    // Retry should include the continuation notice in additionalSystemInstructions.\r\n    const retryOpts = (streamMessage as ReturnType<typeof mock>).mock.calls[1][0] as Record<\r\n      string,\r\n      unknown\r\n    >;\r\n    expect(String(retryOpts.additionalSystemInstructions)).toContain(\"restarted\");\r\n\r\n    session.dispose();\r\n  });\r\n\r\n  test(\"resolves exec-like predicate from parent workspace when child agents are missing\", async () => {\r\n    const workspaceId = \"ws-hard-custom-agent\";\r\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\r\n\r\n    const history: MuxMessage[] = [\r\n      {\r\n        id: \"user-1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"Do the thing\" }],\r\n        metadata: {\r\n          timestamp: 1100,\r\n        },\r\n      },\r\n    ];\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n    for (const msg of history) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n    spyOn(historyService, \"clearHistory\");\r\n    spyOn(historyService, \"appendToHistory\");\r\n\r\n    const partialService: PartialService = {\r\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    let resolveSecondCall: (() => void) | undefined;\r\n    const secondCall = new Promise<void>((resolve) => {\r\n      resolveSecondCall = resolve;\r\n    });\r\n\r\n    let callCount = 0;\r\n    const streamMessage = mock((..._args: unknown[]) => {\r\n      callCount += 1;\r\n\r\n      if (callCount === 1) {\r\n        // Simulate a provider context limit error before any deltas.\r\n        aiEmitter.emit(\"error\", {\r\n          workspaceId,\r\n          messageId: \"assistant-ctx-exceeded-1\",\r\n          error: \"Context length exceeded\",\r\n          errorType: \"context_exceeded\",\r\n        });\r\n\r\n        return Promise.resolve({ success: true as const, data: undefined });\r\n      }\r\n\r\n      resolveSecondCall?.();\r\n      return Promise.resolve({ success: true as const, data: undefined });\r\n    });\r\n\r\n    const customAgentId = \"custom_hard_restart_agent\";\r\n\r\n    const srcBaseDir = await fsPromises.mkdtemp(\r\n      path.join(os.tmpdir(), \"mux-agentSession-worktrees-\")\r\n    );\r\n    const projectPath = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-proj-\"));\r\n\r\n    // Create a custom agent definition ONLY in the parent workspace path.\r\n    // This simulates untracked .mux/agents that are present in the parent worktree but absent\r\n    // from the child task worktree.\r\n    const parentWorkspaceName = \"parent\";\r\n    const parentAgentsDir = path.join(\r\n      srcBaseDir,\r\n      path.basename(projectPath),\r\n      parentWorkspaceName,\r\n      \".mux\",\r\n      \"agents\"\r\n    );\r\n    await fsPromises.mkdir(parentAgentsDir, { recursive: true });\r\n    await fsPromises.writeFile(\r\n      path.join(parentAgentsDir, `${customAgentId}.md`),\r\n      [\r\n        \"---\",\r\n        \"name: Custom Hard Restart Agent\",\r\n        \"description: Test agent inheriting exec\",\r\n        \"base: exec\",\r\n        \"---\",\r\n        \"\",\r\n        \"Body\",\r\n        \"\",\r\n      ].join(\"\\n\")\r\n    );\r\n\r\n    const parentWorkspaceId = \"parent-custom\";\r\n\r\n    const childWorkspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"child\",\r\n      projectName: \"proj\",\r\n      projectPath,\r\n      runtimeConfig: { type: \"worktree\", srcBaseDir },\r\n      parentWorkspaceId,\r\n      agentId: customAgentId,\r\n    };\r\n\r\n    const parentWorkspaceMetadata = {\r\n      ...childWorkspaceMetadata,\r\n      id: parentWorkspaceId,\r\n      name: parentWorkspaceName,\r\n      parentWorkspaceId: undefined,\r\n      agentId: \"exec\",\r\n    };\r\n\r\n    const getWorkspaceMetadata = mock((id: string) => {\r\n      if (id === workspaceId) {\r\n        return Promise.resolve({\r\n          success: true as const,\r\n          data: childWorkspaceMetadata as never,\r\n        });\r\n      }\r\n\r\n      if (id === parentWorkspaceId) {\r\n        return Promise.resolve({\r\n          success: true as const,\r\n          data: parentWorkspaceMetadata as never,\r\n        });\r\n      }\r\n\r\n      return Promise.resolve({ success: false as const, error: \"unknown\" });\r\n    });\r\n\r\n    const aiService: AIService = {\r\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.on(String(eventName), listener);\r\n        return this;\r\n      },\r\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.off(String(eventName), listener);\r\n        return this;\r\n      },\r\n      streamMessage,\r\n      getWorkspaceMetadata,\r\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as AIService;\r\n\r\n    const initStateManager: InitStateManager = {\r\n      on() {\r\n        return this;\r\n      },\r\n      off() {\r\n        return this;\r\n      },\r\n    } as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager: BackgroundProcessManager = {\r\n      setMessageQueued: mock(() => undefined),\r\n      cleanup: mock(() => Promise.resolve()),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const config: Config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: mock(() => sessionDir),\r\n    } as unknown as Config;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const options: SendMessageOptions = {\r\n      model: \"openai:gpt-4o\",\r\n      agentId: customAgentId,\r\n      experiments: {\r\n        execSubagentHardRestart: true,\r\n      },\r\n    } as unknown as SendMessageOptions;\r\n\r\n    await (\r\n      session as unknown as {\r\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\r\n      }\r\n    ).streamWithHistory(options.model, options);\r\n\r\n    await Promise.race([\r\n      secondCall,\r\n      new Promise((_, reject) => setTimeout(() => reject(new Error(\"retry timeout\")), 1000)),\r\n    ]);\r\n\r\n    expect(streamMessage).toHaveBeenCalledTimes(2);\r\n    expect((historyService.clearHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(1);\r\n\r\n    session.dispose();\r\n  });\r\n\r\n  test(\"does not hard-restart when workspace is not a subagent\", async () => {\r\n    const workspaceId = \"ws-hard-no-parent\";\r\n    const sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-agentSession-\"));\r\n\r\n    const history: MuxMessage[] = [\r\n      {\r\n        id: \"user-1\",\r\n        role: \"user\",\r\n        parts: [{ type: \"text\", text: \"Do the thing\" }],\r\n        metadata: { timestamp: 1100 },\r\n      },\r\n    ];\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n    for (const msg of history) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n    spyOn(historyService, \"clearHistory\");\r\n\r\n    const partialService: PartialService = {\r\n      commitToHistory: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n      deletePartial: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    const streamMessage = mock((..._args: unknown[]) => {\r\n      aiEmitter.emit(\"error\", {\r\n        workspaceId,\r\n        messageId: \"assistant-ctx-exceeded\",\r\n        error: \"Context length exceeded\",\r\n        errorType: \"context_exceeded\",\r\n      });\r\n      return Promise.resolve({ success: true as const, data: undefined });\r\n    });\r\n\r\n    const workspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"child\",\r\n      projectName: \"proj\",\r\n      projectPath: \"/tmp/proj\",\r\n      namedWorkspacePath: \"/tmp/proj/child\",\r\n      runtimeConfig: { type: \"local\" },\r\n      agentId: \"exec\",\r\n    };\r\n\r\n    const aiService: AIService = {\r\n      on(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.on(String(eventName), listener);\r\n        return this;\r\n      },\r\n      off(eventName: string | symbol, listener: (...args: unknown[]) => void) {\r\n        aiEmitter.off(String(eventName), listener);\r\n        return this;\r\n      },\r\n      streamMessage,\r\n      getWorkspaceMetadata: mock(() =>\r\n        Promise.resolve({ success: true as const, data: workspaceMetadata as never })\r\n      ),\r\n      stopStream: mock(() => Promise.resolve({ success: true as const, data: undefined })),\r\n    } as unknown as AIService;\r\n\r\n    const initStateManager: InitStateManager = {\r\n      on() {\r\n        return this;\r\n      },\r\n      off() {\r\n        return this;\r\n      },\r\n    } as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager: BackgroundProcessManager = {\r\n      setMessageQueued: mock(() => undefined),\r\n      cleanup: mock(() => Promise.resolve()),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const config: Config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: mock(() => sessionDir),\r\n    } as unknown as Config;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const options: SendMessageOptions = {\r\n      model: \"openai:gpt-4o\",\r\n      agentId: \"exec\",\r\n      experiments: {\r\n        execSubagentHardRestart: true,\r\n      },\r\n    } as unknown as SendMessageOptions;\r\n\r\n    await (\r\n      session as unknown as {\r\n        streamWithHistory: (m: string, o: SendMessageOptions) => Promise<unknown>;\r\n      }\r\n    ).streamWithHistory(options.model, options);\r\n\r\n    await new Promise((resolve) => setTimeout(resolve, 25));\r\n\r\n    expect(streamMessage).toHaveBeenCalledTimes(1);\r\n    expect((historyService.clearHistory as ReturnType<typeof mock>).mock.calls).toHaveLength(0);\r\n\r\n    session.dispose();\r\n  });\r\n});\r\n"]}