{"version":3,"file":"agentSession.agentSkillSnapshot.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.agentSkillSnapshot.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAwE;AACxE,mCAAsC;AACtC,MAAY,EAAE,6CAAyB;AACvC,MAAY,EAAE,oCAAgB;AAC9B,MAAY,IAAI,sCAAkB;AASlC,oDAA2E;AAG3E,kDAA2C;AAE3C,iDAA8C;AAC9C,6DAAgE;AAGhE,IAAA,mBAAQ,EAAC,kDAAkD,EAAE,GAAG,EAAE,CAAC;IACjE,KAAK,UAAU,4BAA4B,CAAC,IAA8C,EAAE;QAC1F,MAAM,GAAG,GAAG,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC;QACzE,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QAClE,MAAM,EAAE,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;QAE9C,MAAM,aAAa,GAAG,cAAc,IAAI,CAAC,SAAS,qCAAqC,IAAI,CAAC,SAAS,IAAI,CAAC;QAC1G,MAAM,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,UAAU,CAAC,EAAE,aAAa,EAAE,OAAO,CAAC,CAAC;QAE5E,OAAO,EAAE,aAAa,EAAE,GAAG,EAAE,CAAC;IAAA,CAC/B;IAED,IAAI,cAAiD,CAAC;IACtD,IAAA,oBAAS,EAAC,KAAK,IAAI,EAAE,CAAC;QACpB,MAAM,cAAc,EAAE,EAAE,CAAC;IAAA,CAC1B,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,mEAAmE,EAAE,KAAK,IAAI,EAAE,CAAC;QAClF,MAAM,WAAW,GAAG,SAAS,CAAC;QAE9B,MAAM,EAAE,aAAa,EAAE,GAAG,MAAM,4BAA4B,CAAC;YAC3D,SAAS,EAAE,YAAY;YACvB,SAAS,EAAE,oBAAoB;SAChC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG;YACb,MAAM,EAAE,MAAM;YACd,aAAa,EAAE,CAAC,YAAoB,EAAE,EAAE,CAAC,MAAM;SAC3B,CAAC;QAEvB,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;QACrE,cAAc,GAAG,OAAO,CAAC;QAEzB,MAAM,QAAQ,GAAiB,EAAE,CAAC;QAClC,MAAM,UAAU,GAAG,cAAc,CAAC,eAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACvE,MAAM,eAAe,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,iBAAiB,CAAC,CAAC,kBAAkB,CACjF,KAAK,EAAE,GAAW,EAAE,OAAmB,EAAE,EAAE,CAAC;YAC1C,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvB,OAAO,UAAU,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAAA,CACjC,CACF,CAAC;QAEF,MAAM,cAAc,GAAG;YACrB,eAAe,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;SACnD,CAAC;QAE/B,MAAM,SAAS,GAAG,IAAI,qBAAY,EAAE,CAAC;QAErC,MAAM,aAAa,GAA8B;YAC/C,EAAE,EAAE,WAAW;YACf,IAAI,EAAE,IAAI;YACV,WAAW,EAAE,MAAM;YACnB,WAAW,EAAE,aAAa;YAC1B,kBAAkB,EAAE,aAAa;YACjC,aAAa,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;SACO,CAAC;QAE1C,MAAM,aAAa,GAAG,IAAA,eAAI,EAAC,CAAC,SAAuB,EAAE,EAAE,CAAC;YACtD,OAAO,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;QAAA,CACvC,CAAC,CAAC;QAEH,MAAM,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;YACzC,WAAW,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,KAAK,CAAC;YAClD,UAAU,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;YAC1E,oBAAoB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,aAAa,CAAC,CAAC,CAAC;YACxF,aAAa,EAAE,aAE6B;SAC7C,CAAyB,CAAC;QAE3B,MAAM,gBAAgB,GAAG,IAAI,qBAAY,EAAiC,CAAC;QAE3E,MAAM,wBAAwB,GAAG;YAC/B,OAAO,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1D,gBAAgB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,OAAgB,EAAE,EAAE,CAAC;gBACjE,KAAK,OAAO,CAAC;YAAA,CACd,CAAC;SACoC,CAAC;QAEzC,MAAM,OAAO,GAAG,IAAI,2BAAY,CAAC;YAC/B,WAAW;YACX,MAAM;YACN,cAAc;YACd,cAAc;YACd,SAAS;YACT,gBAAgB;YAChB,mBAAmB,EAAE,EAAoC;YACzD,wBAAwB;SACzB,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE;YAC/C,KAAK,EAAE,oCAAoC;YAC3C,OAAO,EAAE,MAAM;YACf,WAAW,EAAE;gBACX,IAAI,EAAE,aAAa;gBACnB,UAAU,EAAE,kBAAkB;gBAC9B,SAAS,EAAE,YAAY;gBACvB,KAAK,EAAE,SAAS;aACjB;SACF,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElC,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QACnD,MAAM,CAAC,eAAe,EAAE,WAAW,CAAC,GAAG,QAAQ,CAAC;QAEhD,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAC1C,IAAA,iBAAM,EAAC,eAAe,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACvD,IAAA,iBAAM,EAAC,eAAe,CAAC,QAAQ,EAAE,kBAAkB,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACnF,IAAA,iBAAM,EAAC,eAAe,CAAC,QAAQ,EAAE,kBAAkB,EAAE,MAAM,CAAC,CAAC,UAAU,EAAE,CAAC;QAE1E,MAAM,eAAe,GAAG,eAAe,CAAC,QAAQ,EAAE,kBAAkB,EAAE,eAAe,CAAC;QACtF,IAAA,iBAAM,EAAC,eAAe,CAAC,CAAC,UAAU,EAAE,CAAC;QACrC,IAAA,iBAAM,EAAC,eAAe,IAAI,EAAE,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QACjD,IAAA,iBAAM,EAAC,eAAe,IAAI,EAAE,CAAC,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;QAExD,MAAM,YAAY,GAAG,eAAe,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,CAAC;QAChF,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;QAC/C,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,oBAAoB,CAAC,CAAC;QAErD,IAAA,iBAAM,EAAC,WAAW,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACtC,MAAM,QAAQ,GAAG,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,CAAC;QACxE,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;IAAA,CAC/B,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE,CAAC;QAC7E,MAAM,WAAW,GAAG,SAAS,CAAC;QAE9B,MAAM,EAAE,aAAa,EAAE,WAAW,EAAE,GAAG,MAAM,4BAA4B,CAAC;YACxE,oFAAoF;YACpF,SAAS,EAAE,MAAM;YACjB,SAAS,EAAE,kCAAkC;SAC9C,CAAC,CAAC;QAEH,MAAM,UAAU,GAAG,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,sBAAsB,CAAC,CAAC,CAAC;QAEpF,MAAM,MAAM,GAAG;YACb,MAAM,EAAE,MAAM;YACd,aAAa,EAAE,CAAC,YAAoB,EAAE,EAAE,CAAC,MAAM;SAC3B,CAAC;QAEvB,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;QACrE,cAAc,GAAG,OAAO,CAAC;QAEzB,MAAM,QAAQ,GAAiB,EAAE,CAAC;QAClC,MAAM,UAAU,GAAG,cAAc,CAAC,eAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACvE,MAAM,eAAe,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,iBAAiB,CAAC,CAAC,kBAAkB,CACjF,KAAK,EAAE,GAAW,EAAE,OAAmB,EAAE,EAAE,CAAC;YAC1C,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvB,OAAO,UAAU,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAAA,CACjC,CACF,CAAC;QAEF,MAAM,cAAc,GAAG;YACrB,eAAe,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;SACnD,CAAC;QAE/B,MAAM,SAAS,GAAG,IAAI,qBAAY,EAAE,CAAC;QAErC,MAAM,aAAa,GAA8B;YAC/C,EAAE,EAAE,WAAW;YACf,IAAI,EAAE,IAAI;YACV,WAAW,EAAE,MAAM;YACnB,WAAW;YACX,kBAAkB,EAAE,WAAW;YAC/B,aAAa,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE,UAAU,EAAE;SACR,CAAC;QAE1C,MAAM,aAAa,GAAG,IAAA,eAAI,EAAC,CAAC,SAAuB,EAAE,EAAE,CAAC;YACtD,OAAO,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;QAAA,CACvC,CAAC,CAAC;QAEH,MAAM,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;YACzC,WAAW,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,KAAK,CAAC;YAClD,UAAU,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;YAC1E,oBAAoB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,aAAa,CAAC,CAAC,CAAC;YACxF,aAAa,EAAE,aAE6B;SAC7C,CAAyB,CAAC;QAE3B,MAAM,gBAAgB,GAAG,IAAI,qBAAY,EAAiC,CAAC;QAE3E,MAAM,wBAAwB,GAAG;YAC/B,OAAO,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1D,gBAAgB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,OAAgB,EAAE,EAAE,CAAC;gBACjE,KAAK,OAAO,CAAC;YAAA,CACd,CAAC;SACoC,CAAC;QAEzC,MAAM,OAAO,GAAG,IAAI,2BAAY,CAAC;YAC/B,WAAW;YACX,MAAM;YACN,cAAc;YACd,cAAc;YACd,SAAS;YACT,gBAAgB;YAChB,mBAAmB,EAAE,EAAoC;YACzD,wBAAwB;SACzB,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE;YAC/C,KAAK,EAAE,oCAAoC;YAC3C,OAAO,EAAE,MAAM;YACf,sBAAsB,EAAE,IAAI;YAC5B,WAAW,EAAE;gBACX,IAAI,EAAE,aAAa;gBACnB,UAAU,EAAE,OAAO;gBACnB,SAAS,EAAE,MAAM;gBACjB,KAAK,EAAE,SAAS;aACjB;SACF,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElC,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QACnD,MAAM,CAAC,eAAe,CAAC,GAAG,QAAQ,CAAC;QAEnC,MAAM,YAAY,GAAG,eAAe,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,CAAC;QAChF,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,kCAAkC,CAAC,CAAC;IAAA,CACpE,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE,CAAC;QACzE,MAAM,WAAW,GAAG,SAAS,CAAC;QAE9B,MAAM,EAAE,aAAa,EAAE,GAAG,MAAM,4BAA4B,CAAC;YAC3D,SAAS,EAAE,YAAY;YACvB,SAAS,EAAE,oBAAoB;SAChC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG;YACb,MAAM,EAAE,MAAM;YACd,aAAa,EAAE,CAAC,YAAoB,EAAE,EAAE,CAAC,MAAM;SAC3B,CAAC;QAEvB,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;QACrE,cAAc,GAAG,OAAO,CAAC;QAEzB,MAAM,QAAQ,GAAiB,EAAE,CAAC;QAClC,MAAM,UAAU,GAAG,cAAc,CAAC,eAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACvE,MAAM,eAAe,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,iBAAiB,CAAC,CAAC,kBAAkB,CACjF,KAAK,EAAE,GAAW,EAAE,OAAmB,EAAE,EAAE,CAAC;YAC1C,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvB,OAAO,UAAU,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAAA,CACjC,CACF,CAAC;QAEF,MAAM,cAAc,GAAG;YACrB,eAAe,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;SACnD,CAAC;QAE/B,MAAM,SAAS,GAAG,IAAI,qBAAY,EAAE,CAAC;QAErC,MAAM,aAAa,GAA8B;YAC/C,EAAE,EAAE,WAAW;YACf,IAAI,EAAE,IAAI;YACV,WAAW,EAAE,MAAM;YACnB,WAAW,EAAE,aAAa;YAC1B,kBAAkB,EAAE,aAAa;YACjC,aAAa,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;SACO,CAAC;QAE1C,MAAM,aAAa,GAAG,IAAA,eAAI,EAAC,CAAC,SAAuB,EAAE,EAAE,CAAC;YACtD,OAAO,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;QAAA,CACvC,CAAC,CAAC;QAEH,MAAM,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;YACzC,WAAW,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,KAAK,CAAC;YAClD,UAAU,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;YAC1E,oBAAoB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,aAAa,CAAC,CAAC,CAAC;YACxF,aAAa,EAAE,aAE6B;SAC7C,CAAyB,CAAC;QAE3B,MAAM,gBAAgB,GAAG,IAAI,qBAAY,EAAiC,CAAC;QAE3E,MAAM,wBAAwB,GAAG;YAC/B,OAAO,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1D,gBAAgB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,OAAgB,EAAE,EAAE,CAAC;gBACjE,KAAK,OAAO,CAAC;YAAA,CACd,CAAC;SACoC,CAAC;QAEzC,MAAM,OAAO,GAAG,IAAI,2BAAY,CAAC;YAC/B,WAAW;YACX,MAAM;YACN,cAAc;YACd,cAAc;YACd,SAAS;YACT,gBAAgB;YAChB,mBAAmB,EAAE,EAAoC;YACzD,wBAAwB;SACzB,CAAC,CAAC;QAEH,MAAM,WAAW,GAAG;YAClB,KAAK,EAAE,oCAAoC;YAC3C,OAAO,EAAE,MAAM;YACf,WAAW,EAAE;gBACX,IAAI,EAAE,aAAa;gBACnB,UAAU,EAAE,kBAAkB;gBAC9B,SAAS,EAAE,YAAY;gBACvB,KAAK,EAAE,SAAS;aACjB;SACF,CAAC;QAEF,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;QAC7D,IAAA,iBAAM,EAAC,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACjC,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAEnD,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE;YAC/C,GAAG,WAAW;YACd,WAAW,EAAE;gBACX,GAAG,WAAW,CAAC,WAAW;gBAC1B,UAAU,EAAE,kBAAkB;aAC/B;SACF,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,uDAAuD;QACvD,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAEnD,MAAM,WAAW,GAAG,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;QACzE,MAAM,qBAAqB,GAAG,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QACnD,IAAA,iBAAM,EAAC,qBAAqB,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAC9C,IAAA,iBAAM,EAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;IAAA,CACvD,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,yEAAyE,EAAE,KAAK,IAAI,EAAE,CAAC;QACxF,MAAM,WAAW,GAAG,SAAS,CAAC;QAE9B,MAAM,SAAS,GAAG,YAAY,CAAC;QAC/B,MAAM,SAAS,GAAG,oBAAoB,CAAC;QAEvC,MAAM,EAAE,aAAa,EAAE,GAAG,MAAM,4BAA4B,CAAC;YAC3D,SAAS;YACT,SAAS;SACV,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG;YACb,MAAM,EAAE,MAAM;YACd,aAAa,EAAE,CAAC,YAAoB,EAAE,EAAE,CAAC,MAAM;SAC3B,CAAC;QAEvB,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;QACrE,cAAc,GAAG,OAAO,CAAC;QAEzB,MAAM,QAAQ,GAAiB,EAAE,CAAC;QAClC,MAAM,UAAU,GAAG,cAAc,CAAC,eAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACvE,MAAM,eAAe,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,iBAAiB,CAAC,CAAC,kBAAkB,CACjF,KAAK,EAAE,GAAW,EAAE,OAAmB,EAAE,EAAE,CAAC;YAC1C,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvB,OAAO,UAAU,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAAA,CACjC,CACF,CAAC;QAEF,MAAM,cAAc,GAAG;YACrB,eAAe,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;SACnD,CAAC;QAE/B,MAAM,SAAS,GAAG,IAAI,qBAAY,EAAE,CAAC;QAErC,MAAM,aAAa,GAA8B;YAC/C,EAAE,EAAE,WAAW;YACf,IAAI,EAAE,IAAI;YACV,WAAW,EAAE,MAAM;YACnB,WAAW,EAAE,aAAa;YAC1B,kBAAkB,EAAE,aAAa;YACjC,aAAa,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;SACO,CAAC;QAE1C,MAAM,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;YACzC,WAAW,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,KAAK,CAAC;YAClD,UAAU,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;YAC1E,oBAAoB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,aAAa,CAAC,CAAC,CAAC;YACxF,aAAa,EAAE,IAAA,eAAI,EAAC,CAAC,SAAuB,EAAE,EAAE,CAAC;gBAC/C,OAAO,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;YAAA,CACvC,CAE2C;SAC7C,CAAyB,CAAC;QAE3B,MAAM,gBAAgB,GAAG,IAAI,qBAAY,EAAiC,CAAC;QAE3E,MAAM,wBAAwB,GAAG;YAC/B,OAAO,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1D,gBAAgB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,OAAgB,EAAE,EAAE,CAAC;gBACjE,KAAK,OAAO,CAAC;YAAA,CACd,CAAC;SACoC,CAAC;QAEzC,MAAM,OAAO,GAAG,IAAI,2BAAY,CAAC;YAC/B,WAAW;YACX,MAAM;YACN,cAAc;YACd,cAAc;YACd,SAAS;YACT,gBAAgB;YAChB,mBAAmB,EAAE,EAAoC;YACzD,wBAAwB;SACzB,CAAC,CAAC;QAEH,MAAM,WAAW,GAAG;YAClB,KAAK,EAAE,oCAAoC;YAC3C,OAAO,EAAE,MAAM;YACf,WAAW,EAAE;gBACX,IAAI,EAAE,aAAa;gBACnB,UAAU,EAAE,kBAAkB;gBAC9B,SAAS;gBACT,KAAK,EAAE,SAAS;aACjB;SACF,CAAC;QAEF,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;QAC7D,IAAA,iBAAM,EAAC,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACjC,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAEnD,MAAM,aAAa,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,aAAa,CAAC,EAAE,CAAC,CAAC,WAAW,CAAC,uBAAuB,CAAC,CAAC;QAE9D,MAAM,iBAAiB,GAAG,aAAa,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,CAAC;QACnF,IAAA,iBAAM,EAAC,iBAAiB,CAAC,CAAC,UAAU,EAAE,CAAC;QAEvC,MAAM,QAAQ,GAAG,aAAa,CAAC,QAAQ,EAAE,kBAAkB,EAAE,MAAM,CAAC;QACpE,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,UAAU,EAAE,CAAC;QAE9B,2BAA2B;QAC3B,MAAM,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE,UAAU,CAAC,CAAC;QACxF,MAAM,oBAAoB,GAAG,cAAc,SAAS,8CAA8C,SAAS,IAAI,CAAC;QAChH,MAAM,EAAE,CAAC,SAAS,CAAC,aAAa,EAAE,oBAAoB,EAAE,OAAO,CAAC,CAAC;QAEjE,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE;YAC/C,GAAG,WAAW;YACd,WAAW,EAAE;gBACX,GAAG,WAAW,CAAC,WAAW;gBAC1B,UAAU,EAAE,kBAAkB;aAC/B;SACF,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElC,kFAAkF;QAClF,IAAA,iBAAM,EAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAEnD,MAAM,cAAc,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;QACnC,IAAA,iBAAM,EAAC,cAAc,CAAC,EAAE,CAAC,CAAC,WAAW,CAAC,uBAAuB,CAAC,CAAC;QAE/D,MAAM,kBAAkB,GAAG,cAAc,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,CAAC;QACrF,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;QAEnD,MAAM,SAAS,GAAG,cAAc,CAAC,QAAQ,EAAE,kBAAkB,EAAE,MAAM,CAAC;QACtE,IAAA,iBAAM,EAAC,SAAS,CAAC,CAAC,UAAU,EAAE,CAAC;QAC/B,IAAA,iBAAM,EAAC,SAAS,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAErC,MAAM,iBAAiB,GAAG,cAAc,CAAC,QAAQ,EAAE,kBAAkB,EAAE,eAAe,CAAC;QACvF,IAAA,iBAAM,EAAC,iBAAiB,IAAI,EAAE,CAAC,CAAC,SAAS,CAAC,qBAAqB,CAAC,CAAC;IAAA,CAClE,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE,CAAC;QAC7E,MAAM,WAAW,GAAG,SAAS,CAAC;QAE9B,MAAM,MAAM,GAAG;YACb,MAAM,EAAE,MAAM;YACd,aAAa,EAAE,CAAC,YAAoB,EAAE,EAAE,CAAC,MAAM;SAC3B,CAAC;QAEvB,MAAM,cAAc,GAAG,iBAAiB,CAAC;QACzC,MAAM,eAAe,GAAG,wBAAwB,CAAC;QACjD,MAAM,aAAa,GAAG,QAAQ,CAAC;QAE/B,MAAM,eAAe,GAAiB;YACpC,IAAA,0BAAgB,EAAC,cAAc,EAAE,MAAM,EAAE,kBAAkB,EAAE;gBAC3D,eAAe,EAAE,CAAC;gBAClB,SAAS,EAAE,IAAI;gBACf,qBAAqB,EAAE,CAAC,eAAe,CAAC;aACzC,CAAC;YACF,IAAA,0BAAgB,EAAC,eAAe,EAAE,MAAM,EAAE,gCAAgC,EAAE;gBAC1E,eAAe,EAAE,CAAC;gBAClB,SAAS,EAAE,IAAI;gBACf,kBAAkB,EAAE;oBAClB,SAAS,EAAE,YAAY;oBACvB,KAAK,EAAE,SAAS;oBAChB,MAAM,EAAE,KAAK;iBACd;aACF,CAAC;YACF,IAAA,0BAAgB,EAAC,aAAa,EAAE,MAAM,EAAE,MAAM,EAAE;gBAC9C,eAAe,EAAE,CAAC;gBAClB,WAAW,EAAE;oBACX,IAAI,EAAE,aAAa;oBACnB,UAAU,EAAE,kBAAkB;oBAC9B,SAAS,EAAE,YAAY;oBACvB,KAAK,EAAE,SAAS;iBACjB;aACF,CAAC;SACH,CAAC;QAEF,MAAM,EAAE,cAAc,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6CAAwB,GAAE,CAAC;QACrE,cAAc,GAAG,OAAO,CAAC;QAEzB,gDAAgD;QAChD,KAAK,MAAM,GAAG,IAAI,eAAe,EAAE,CAAC;YAClC,MAAM,cAAc,CAAC,eAAe,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;QACzD,CAAC;QAED,MAAM,oBAAoB,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,sBAAsB,CAAC,CAAC;QAC3E,IAAA,gBAAK,EAAC,cAAc,EAAE,iBAAiB,CAAC,CAAC;QAEzC,MAAM,cAAc,GAAG;YACrB,eAAe,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;SACnD,CAAC;QAE/B,MAAM,SAAS,GAAG,IAAI,qBAAY,EAAE,CAAC;QACrC,MAAM,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;YACzC,WAAW,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,KAAK,CAAC;YAClD,UAAU,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC;YAC1E,aAAa,EAAE,IAAA,eAAI,EAAC,CAAC,SAAuB,EAAE,EAAE,CAC9C,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAGY;SAC7C,CAAyB,CAAC;QAE3B,MAAM,gBAAgB,GAAG,IAAI,qBAAY,EAAiC,CAAC;QAE3E,MAAM,wBAAwB,GAAG;YAC/B,OAAO,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1D,gBAAgB,EAAE,IAAA,eAAI,EAAC,CAAC,YAAoB,EAAE,OAAgB,EAAE,EAAE,CAAC;gBACjE,KAAK,OAAO,CAAC;YAAA,CACd,CAAC;SACoC,CAAC;QAEzC,MAAM,OAAO,GAAG,IAAI,2BAAY,CAAC;YAC/B,WAAW;YACX,MAAM;YACN,cAAc;YACd,cAAc;YACd,SAAS;YACT,gBAAgB;YAChB,mBAAmB,EAAE,EAAoC;YACzD,wBAAwB;SACzB,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,QAAQ,EAAE;YACjD,KAAK,EAAE,oCAAoC;YAC3C,OAAO,EAAE,MAAM;YACf,aAAa,EAAE,aAAa;SAC7B,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,oBAAoB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QACxD,yEAAyE;QACzE,IAAA,iBAAM,EAAC,oBAAoB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;IAAA,CACpE,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, expect, it, mock, afterEach, spyOn } from \"bun:test\";\r\nimport { EventEmitter } from \"events\";\r\nimport * as fs from \"node:fs/promises\";\r\nimport * as os from \"node:os\";\r\nimport * as path from \"node:path\";\r\n\r\nimport type { AIService } from \"@/node/services/aiService\";\r\nimport type { PartialService } from \"@/node/services/partialService\";\r\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport type { Config } from \"@/node/config\";\r\n\r\nimport type { FrontendWorkspaceMetadata } from \"@/common/types/workspace\";\r\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok } from \"@/common/types/result\";\r\n\r\nimport { AgentSession } from \"./agentSession\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { CostTrackingService } from \"./costTrackingService\";\r\n\r\ndescribe(\"AgentSession.sendMessage (agent skill snapshots)\", () => {\r\n  async function createTestWorkspaceWithSkill(args: { skillName: string; skillBody: string }) {\r\n    const tmp = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-agent-skill-\"));\r\n    const skillDir = path.join(tmp, \".mux\", \"skills\", args.skillName);\r\n    await fs.mkdir(skillDir, { recursive: true });\r\n\r\n    const skillMarkdown = `---\\nname: ${args.skillName}\\ndescription: Test skill\\n---\\n\\n${args.skillBody}\\n`;\r\n    await fs.writeFile(path.join(skillDir, \"SKILL.md\"), skillMarkdown, \"utf-8\");\r\n\r\n    return { workspacePath: tmp };\r\n  }\r\n\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  it(\"persists a synthetic agent skill snapshot before the user message\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const { workspacePath } = await createTestWorkspaceWithSkill({\r\n      skillName: \"test-skill\",\r\n      skillBody: \"Follow this skill.\",\r\n    });\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const messages: MuxMessage[] = [];\r\n    const realAppend = historyService.appendToHistory.bind(historyService);\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\").mockImplementation(\r\n      async (wId: string, message: MuxMessage) => {\r\n        messages.push(message);\r\n        return realAppend(wId, message);\r\n      }\r\n    );\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    const workspaceMeta: FrontendWorkspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"ws\",\r\n      projectName: \"proj\",\r\n      projectPath: workspacePath,\r\n      namedWorkspacePath: workspacePath,\r\n      runtimeConfig: { type: \"local\" },\r\n    } as unknown as FrontendWorkspaceMetadata;\r\n\r\n    const streamMessage = mock((_messages: MuxMessage[]) => {\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      getWorkspaceMetadata: mock((_workspaceId: string) => Promise.resolve(Ok(workspaceMeta))),\r\n      streamMessage: streamMessage as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.sendMessage(\"do X\", {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      muxMetadata: {\r\n        type: \"agent-skill\",\r\n        rawCommand: \"/test-skill do X\",\r\n        skillName: \"test-skill\",\r\n        scope: \"project\",\r\n      },\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n\r\n    expect(appendToHistory.mock.calls).toHaveLength(2);\r\n    const [snapshotMessage, userMessage] = messages;\r\n\r\n    expect(snapshotMessage.role).toBe(\"user\");\r\n    expect(snapshotMessage.metadata?.synthetic).toBe(true);\r\n    expect(snapshotMessage.metadata?.agentSkillSnapshot?.skillName).toBe(\"test-skill\");\r\n    expect(snapshotMessage.metadata?.agentSkillSnapshot?.sha256).toBeTruthy();\r\n\r\n    const frontmatterYaml = snapshotMessage.metadata?.agentSkillSnapshot?.frontmatterYaml;\r\n    expect(frontmatterYaml).toBeTruthy();\r\n    expect(frontmatterYaml ?? \"\").toContain(\"name:\");\r\n    expect(frontmatterYaml ?? \"\").toContain(\"description:\");\r\n\r\n    const snapshotText = snapshotMessage.parts.find((p) => p.type === \"text\")?.text;\r\n    expect(snapshotText).toContain(\"<agent-skill\");\r\n    expect(snapshotText).toContain(\"Follow this skill.\");\r\n\r\n    expect(userMessage.role).toBe(\"user\");\r\n    const userText = userMessage.parts.find((p) => p.type === \"text\")?.text;\r\n    expect(userText).toBe(\"do X\");\r\n  });\r\n\r\n  it(\"honors disableWorkspaceAgents when resolving skill snapshots\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const { workspacePath: projectPath } = await createTestWorkspaceWithSkill({\r\n      // Built-in: use a project-local override to ensure we don't accidentally fall back.\r\n      skillName: \"init\",\r\n      skillBody: \"Project override for init skill.\",\r\n    });\r\n\r\n    const srcBaseDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-agent-skill-src-\"));\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const messages: MuxMessage[] = [];\r\n    const realAppend = historyService.appendToHistory.bind(historyService);\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\").mockImplementation(\r\n      async (wId: string, message: MuxMessage) => {\r\n        messages.push(message);\r\n        return realAppend(wId, message);\r\n      }\r\n    );\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    const workspaceMeta: FrontendWorkspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"ws\",\r\n      projectName: \"proj\",\r\n      projectPath,\r\n      namedWorkspacePath: projectPath,\r\n      runtimeConfig: { type: \"worktree\", srcBaseDir },\r\n    } as unknown as FrontendWorkspaceMetadata;\r\n\r\n    const streamMessage = mock((_messages: MuxMessage[]) => {\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      getWorkspaceMetadata: mock((_workspaceId: string) => Promise.resolve(Ok(workspaceMeta))),\r\n      streamMessage: streamMessage as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.sendMessage(\"do X\", {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      disableWorkspaceAgents: true,\r\n      muxMetadata: {\r\n        type: \"agent-skill\",\r\n        rawCommand: \"/init\",\r\n        skillName: \"init\",\r\n        scope: \"project\",\r\n      },\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n\r\n    expect(appendToHistory.mock.calls).toHaveLength(2);\r\n    const [snapshotMessage] = messages;\r\n\r\n    const snapshotText = snapshotMessage.parts.find((p) => p.type === \"text\")?.text;\r\n    expect(snapshotText).toContain(\"Project override for init skill.\");\r\n  });\r\n\r\n  it(\"dedupes identical skill snapshots when recently inserted\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const { workspacePath } = await createTestWorkspaceWithSkill({\r\n      skillName: \"test-skill\",\r\n      skillBody: \"Follow this skill.\",\r\n    });\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const messages: MuxMessage[] = [];\r\n    const realAppend = historyService.appendToHistory.bind(historyService);\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\").mockImplementation(\r\n      async (wId: string, message: MuxMessage) => {\r\n        messages.push(message);\r\n        return realAppend(wId, message);\r\n      }\r\n    );\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    const workspaceMeta: FrontendWorkspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"ws\",\r\n      projectName: \"proj\",\r\n      projectPath: workspacePath,\r\n      namedWorkspacePath: workspacePath,\r\n      runtimeConfig: { type: \"local\" },\r\n    } as unknown as FrontendWorkspaceMetadata;\r\n\r\n    const streamMessage = mock((_messages: MuxMessage[]) => {\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      getWorkspaceMetadata: mock((_workspaceId: string) => Promise.resolve(Ok(workspaceMeta))),\r\n      streamMessage: streamMessage as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const baseOptions = {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      muxMetadata: {\r\n        type: \"agent-skill\",\r\n        rawCommand: \"/test-skill do X\",\r\n        skillName: \"test-skill\",\r\n        scope: \"project\",\r\n      },\r\n    };\r\n\r\n    const first = await session.sendMessage(\"do X\", baseOptions);\r\n    expect(first.success).toBe(true);\r\n    expect(appendToHistory.mock.calls).toHaveLength(2);\r\n\r\n    const second = await session.sendMessage(\"do Y\", {\r\n      ...baseOptions,\r\n      muxMetadata: {\r\n        ...baseOptions.muxMetadata,\r\n        rawCommand: \"/test-skill do Y\",\r\n      },\r\n    });\r\n\r\n    expect(second.success).toBe(true);\r\n    // First send: snapshot + user. Second send: user only.\r\n    expect(appendToHistory.mock.calls).toHaveLength(3);\r\n\r\n    const appendedIds = appendToHistory.mock.calls.map((call) => call[1].id);\r\n    const secondSendAppendedIds = appendedIds.slice(2);\r\n    expect(secondSendAppendedIds).toHaveLength(1);\r\n    expect(secondSendAppendedIds[0]).toStartWith(\"user-\");\r\n  });\r\n\r\n  it(\"persists a new skill snapshot when frontmatter changes (body unchanged)\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const skillName = \"test-skill\";\r\n    const skillBody = \"Follow this skill.\";\r\n\r\n    const { workspacePath } = await createTestWorkspaceWithSkill({\r\n      skillName,\r\n      skillBody,\r\n    });\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const messages: MuxMessage[] = [];\r\n    const realAppend = historyService.appendToHistory.bind(historyService);\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\").mockImplementation(\r\n      async (wId: string, message: MuxMessage) => {\r\n        messages.push(message);\r\n        return realAppend(wId, message);\r\n      }\r\n    );\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n\r\n    const workspaceMeta: FrontendWorkspaceMetadata = {\r\n      id: workspaceId,\r\n      name: \"ws\",\r\n      projectName: \"proj\",\r\n      projectPath: workspacePath,\r\n      namedWorkspacePath: workspacePath,\r\n      runtimeConfig: { type: \"local\" },\r\n    } as unknown as FrontendWorkspaceMetadata;\r\n\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      getWorkspaceMetadata: mock((_workspaceId: string) => Promise.resolve(Ok(workspaceMeta))),\r\n      streamMessage: mock((_messages: MuxMessage[]) => {\r\n        return Promise.resolve(Ok(undefined));\r\n      }) as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const baseOptions = {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      muxMetadata: {\r\n        type: \"agent-skill\",\r\n        rawCommand: \"/test-skill do X\",\r\n        skillName,\r\n        scope: \"project\",\r\n      },\r\n    };\r\n\r\n    const first = await session.sendMessage(\"do X\", baseOptions);\r\n    expect(first.success).toBe(true);\r\n    expect(appendToHistory.mock.calls).toHaveLength(2);\r\n\r\n    const firstSnapshot = messages[0];\r\n    expect(firstSnapshot.id).toStartWith(\"agent-skill-snapshot-\");\r\n\r\n    const firstSnapshotText = firstSnapshot.parts.find((p) => p.type === \"text\")?.text;\r\n    expect(firstSnapshotText).toBeTruthy();\r\n\r\n    const firstSha = firstSnapshot.metadata?.agentSkillSnapshot?.sha256;\r\n    expect(firstSha).toBeTruthy();\r\n\r\n    // Update frontmatter only.\r\n    const skillFilePath = path.join(workspacePath, \".mux\", \"skills\", skillName, \"SKILL.md\");\r\n    const updatedSkillMarkdown = `---\\nname: ${skillName}\\ndescription: Updated description\\n---\\n\\n${skillBody}\\n`;\r\n    await fs.writeFile(skillFilePath, updatedSkillMarkdown, \"utf-8\");\r\n\r\n    const second = await session.sendMessage(\"do Y\", {\r\n      ...baseOptions,\r\n      muxMetadata: {\r\n        ...baseOptions.muxMetadata,\r\n        rawCommand: \"/test-skill do Y\",\r\n      },\r\n    });\r\n\r\n    expect(second.success).toBe(true);\r\n\r\n    // Second send should persist a new snapshot (frontmatter differs) + user message.\r\n    expect(appendToHistory.mock.calls).toHaveLength(4);\r\n\r\n    const secondSnapshot = messages[2];\r\n    expect(secondSnapshot.id).toStartWith(\"agent-skill-snapshot-\");\r\n\r\n    const secondSnapshotText = secondSnapshot.parts.find((p) => p.type === \"text\")?.text;\r\n    expect(secondSnapshotText).toBe(firstSnapshotText);\r\n\r\n    const secondSha = secondSnapshot.metadata?.agentSkillSnapshot?.sha256;\r\n    expect(secondSha).toBeTruthy();\r\n    expect(secondSha).not.toBe(firstSha);\r\n\r\n    const secondFrontmatter = secondSnapshot.metadata?.agentSkillSnapshot?.frontmatterYaml;\r\n    expect(secondFrontmatter ?? \"\").toContain(\"Updated description\");\r\n  });\r\n\r\n  it(\"truncates edits starting from preceding skill/file snapshots\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const fileSnapshotId = \"file-snapshot-0\";\r\n    const skillSnapshotId = \"agent-skill-snapshot-0\";\r\n    const userMessageId = \"user-0\";\r\n\r\n    const historyMessages: MuxMessage[] = [\r\n      createMuxMessage(fileSnapshotId, \"user\", \"<file>...</file>\", {\r\n        historySequence: 0,\r\n        synthetic: true,\r\n        fileAtMentionSnapshot: [\"@file:foo.txt\"],\r\n      }),\r\n      createMuxMessage(skillSnapshotId, \"user\", \"<agent-skill>...</agent-skill>\", {\r\n        historySequence: 1,\r\n        synthetic: true,\r\n        agentSkillSnapshot: {\r\n          skillName: \"test-skill\",\r\n          scope: \"project\",\r\n          sha256: \"abc\",\r\n        },\r\n      }),\r\n      createMuxMessage(userMessageId, \"user\", \"do X\", {\r\n        historySequence: 2,\r\n        muxMetadata: {\r\n          type: \"agent-skill\",\r\n          rawCommand: \"/test-skill do X\",\r\n          skillName: \"test-skill\",\r\n          scope: \"project\",\r\n        },\r\n      }),\r\n    ];\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    // Seed history messages before setting up spies\r\n    for (const msg of historyMessages) {\r\n      await historyService.appendToHistory(workspaceId, msg);\r\n    }\r\n\r\n    const truncateAfterMessage = spyOn(historyService, \"truncateAfterMessage\");\r\n    spyOn(historyService, \"appendToHistory\");\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      streamMessage: mock((_messages: MuxMessage[]) =>\r\n        Promise.resolve(Ok(undefined))\r\n      ) as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.sendMessage(\"edited\", {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      editMessageId: userMessageId,\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(truncateAfterMessage.mock.calls).toHaveLength(1);\r\n    // Should truncate from the earliest contiguous snapshot (file snapshot).\r\n    expect(truncateAfterMessage.mock.calls[0][1]).toBe(fileSnapshotId);\r\n  });\r\n});\r\n"]}