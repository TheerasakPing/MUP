{"version":3,"file":"agentSession.resumeStreamEmptyHistory.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.resumeStreamEmptyHistory.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test, mock, afterEach } from \"bun:test\";\r\n\r\nimport { AgentSession } from \"./agentSession\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport type { AIService } from \"./aiService\";\r\nimport type { InitStateManager } from \"./initStateManager\";\r\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok } from \"@/common/types/result\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { CostTrackingService } from \"./costTrackingService\";\r\n\r\ndescribe(\"AgentSession.resumeStream\", () => {\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  test(\"returns an error when history is empty\", async () => {\r\n    const streamMessage = mock(() => Promise.resolve(Ok(undefined)));\r\n\r\n    const aiService: AIService = {\r\n      on: mock(() => aiService),\r\n      off: mock(() => aiService),\r\n      stopStream: mock(() => Promise.resolve(Ok(undefined))),\r\n      isStreaming: mock(() => false),\r\n      streamMessage,\r\n    } as unknown as AIService;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const partialService: PartialService = {\r\n      commitToHistory: mock((): Promise<Result<void>> => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const initStateManager: InitStateManager = {\r\n      on: mock(() => initStateManager),\r\n      off: mock(() => initStateManager),\r\n    } as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager: BackgroundProcessManager = {\r\n      cleanup: mock(() => Promise.resolve()),\r\n      setMessageQueued: mock(() => undefined),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const config: Config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: mock(() => \"/tmp\"),\r\n    } as unknown as Config;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId: \"ws\",\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.resumeStream({\r\n      model: \"anthropic:claude-sonnet-4-5\",\r\n      agentId: \"exec\",\r\n    });\r\n    expect(result.success).toBe(false);\r\n    if (result.success) return;\r\n    expect(result.error.type).toBe(\"unknown\");\r\n    if (result.error.type !== \"unknown\") {\r\n      throw new Error(`Expected unknown error, got ${result.error.type}`);\r\n    }\r\n    expect(result.error.raw).toContain(\"history is empty\");\r\n    expect(streamMessage).toHaveBeenCalledTimes(0);\r\n  });\r\n});\r\n"]}