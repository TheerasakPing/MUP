{"version":3,"file":"agentResolution.js","sourceRoot":"","sources":["../../../src/node/services/agentResolution.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Agent resolution: resolves the active agent and computes tool policy for a stream.\r\n *\r\n * Extracted from `streamMessage()` to make the agent resolution logic\r\n * explicit and testable. Contains:\r\n * - Agent ID normalization & fallback to exec\r\n * - Agent definition loading with error recovery\r\n * - Disabled-agent enforcement (subagent workspaces error, top-level falls back)\r\n * - Inheritance chain resolution + plan-like detection\r\n * - Task nesting depth enforcement\r\n * - Tool policy composition (agent → caller → system workspace)\r\n * - Sentinel tool name computation for agent transition detection\r\n */\r\n\r\nimport * as os from \"os\";\r\nimport { AgentIdSchema } from \"@/common/orpc/schemas\";\r\nimport { MUX_HELP_CHAT_AGENT_ID, MUX_HELP_CHAT_WORKSPACE_ID } from \"@/common/constants/muxChat\";\r\nimport { DEFAULT_TASK_SETTINGS } from \"@/common/types/tasks\";\r\nimport type { ErrorEvent } from \"@/common/types/stream\";\r\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\r\nimport type { ProjectsConfig } from \"@/common/types/project\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport { applyToolPolicy, type ToolPolicy } from \"@/common/utils/tools/toolPolicy\";\r\nimport { getToolsForModel } from \"@/common/utils/tools/tools\";\r\nimport { isPlanLikeInResolvedChain } from \"@/common/utils/agentTools\";\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport {\r\n  readAgentDefinition,\r\n  resolveAgentFrontmatter,\r\n} from \"@/node/services/agentDefinitions/agentDefinitionsService\";\r\nimport { isAgentEffectivelyDisabled } from \"@/node/services/agentDefinitions/agentEnablement\";\r\nimport { resolveToolPolicyForAgent } from \"@/node/services/agentDefinitions/resolveToolPolicy\";\r\nimport { resolveAgentInheritanceChain } from \"@/node/services/agentDefinitions/resolveAgentInheritanceChain\";\r\nimport type { InitStateManager } from \"./initStateManager\";\r\nimport { createAssistantMessageId } from \"./utils/messageIds\";\r\nimport { createErrorEvent } from \"./utils/sendMessageError\";\r\nimport { getTaskDepthFromConfig } from \"./taskUtils\";\r\nimport { log } from \"./log\";\r\n\r\n/** Options for agent resolution. */\r\nexport interface ResolveAgentOptions {\r\n  workspaceId: string;\r\n  metadata: WorkspaceMetadata;\r\n  runtime: Runtime;\r\n  workspacePath: string;\r\n  /** Requested agent ID from the frontend (may be undefined → defaults to exec). */\r\n  requestedAgentId: string | undefined;\r\n  /** When true, skip workspace-specific agents (for \"unbricking\" broken agent files). */\r\n  disableWorkspaceAgents: boolean;\r\n  modelString: string;\r\n  /** Caller-supplied tool policy (applied AFTER agent policy for further restriction). */\r\n  callerToolPolicy: ToolPolicy | undefined;\r\n  /** Loaded config from Config.loadConfigOrDefault(). */\r\n  cfg: ProjectsConfig;\r\n  /** Emit an error event on the AIService EventEmitter (for disabled-agent subagent errors). */\r\n  emitError: (event: ErrorEvent) => void;\r\n  /** For sentinel tool name computation. */\r\n  initStateManager: InitStateManager;\r\n}\r\n\r\n/** Result of agent resolution — all computed values needed by the stream pipeline. */\r\nexport interface AgentResolutionResult {\r\n  effectiveAgentId: string;\r\n  agentDefinition: Awaited<ReturnType<typeof readAgentDefinition>>;\r\n  /** Path used for agent discovery (workspace path or project path if agents disabled). */\r\n  agentDiscoveryPath: string;\r\n  isSubagentWorkspace: boolean;\r\n  /** Whether the resolved agent inherits plan-like behavior (has propose_plan in tool chain). */\r\n  agentIsPlanLike: boolean;\r\n  effectiveMode: \"plan\" | \"exec\" | \"compact\";\r\n  taskSettings: ProjectsConfig[\"taskSettings\"] & {};\r\n  taskDepth: number;\r\n  shouldDisableTaskToolsForDepth: boolean;\r\n  /** Composed tool policy: agent → caller → system workspace (in application order). */\r\n  effectiveToolPolicy: ToolPolicy | undefined;\r\n  /** Tool names for agent transition sentinel injection in message preparation. */\r\n  toolNamesForSentinel: string[];\r\n}\r\n\r\n/**\r\n * Resolve the active agent and compute tool policy for a stream request.\r\n *\r\n * This is the first major phase of `streamMessage()` after workspace/runtime setup.\r\n * It determines which agent definition to use, whether plan mode is active, and what\r\n * tools are available (via policy). The result feeds into message preparation,\r\n * system prompt construction, and tool assembly.\r\n *\r\n * Returns `Err` only when a disabled agent is requested in a subagent workspace\r\n * (top-level workspaces silently fall back to exec).\r\n */\r\nexport async function resolveAgentForStream(\r\n  opts: ResolveAgentOptions\r\n): Promise<Result<AgentResolutionResult, SendMessageError>> {\r\n  const {\r\n    workspaceId,\r\n    metadata,\r\n    runtime,\r\n    workspacePath,\r\n    requestedAgentId: rawAgentId,\r\n    disableWorkspaceAgents,\r\n    modelString,\r\n    callerToolPolicy,\r\n    cfg,\r\n    emitError,\r\n    initStateManager,\r\n  } = opts;\r\n\r\n  const workspaceLog = log.withFields({ workspaceId, workspaceName: metadata.name });\r\n\r\n  // --- Agent ID resolution ---\r\n  // Precedence:\r\n  // - Child workspaces (tasks) use their persisted agentId/agentType.\r\n  // - Main workspaces use the requested agentId (frontend), falling back to exec.\r\n  const requestedAgentIdRaw =\r\n    workspaceId === MUX_HELP_CHAT_WORKSPACE_ID\r\n      ? MUX_HELP_CHAT_AGENT_ID\r\n      : ((metadata.parentWorkspaceId ? (metadata.agentId ?? metadata.agentType) : undefined) ??\r\n        (typeof rawAgentId === \"string\" ? rawAgentId : undefined) ??\r\n        \"exec\");\r\n  const requestedAgentIdNormalized = requestedAgentIdRaw.trim().toLowerCase();\r\n  const parsedAgentId = AgentIdSchema.safeParse(requestedAgentIdNormalized);\r\n  const requestedAgentId = parsedAgentId.success ? parsedAgentId.data : (\"exec\" as const);\r\n  let effectiveAgentId = requestedAgentId;\r\n\r\n  // When disableWorkspaceAgents is true, skip workspace-specific agents entirely.\r\n  // Use project path so only built-in/global agents are available. This allows \"unbricking\"\r\n  // when iterating on agent files — a broken agent in the worktree won't affect message sending.\r\n  const agentDiscoveryPath = disableWorkspaceAgents ? metadata.projectPath : workspacePath;\r\n\r\n  const isSubagentWorkspace = Boolean(metadata.parentWorkspaceId);\r\n\r\n  // --- Load agent definition (with fallback to exec) ---\r\n  let agentDefinition;\r\n  try {\r\n    agentDefinition = await readAgentDefinition(runtime, agentDiscoveryPath, effectiveAgentId);\r\n  } catch (error) {\r\n    workspaceLog.warn(\"Failed to load agent definition; falling back to exec\", {\r\n      effectiveAgentId,\r\n      agentDiscoveryPath,\r\n      disableWorkspaceAgents,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n    agentDefinition = await readAgentDefinition(runtime, agentDiscoveryPath, \"exec\");\r\n  }\r\n\r\n  // Keep agent ID aligned with the actual definition used (may fall back to exec).\r\n  effectiveAgentId = agentDefinition.id;\r\n\r\n  // --- Disabled-agent enforcement ---\r\n  // Disabled agents should never run as sub-agents, even if a task workspace already exists\r\n  // on disk (e.g., config changed since creation).\r\n  // For top-level workspaces, fall back to exec to keep the workspace usable.\r\n  if (agentDefinition.id !== \"exec\") {\r\n    try {\r\n      const resolvedFrontmatter = await resolveAgentFrontmatter(\r\n        runtime,\r\n        agentDiscoveryPath,\r\n        agentDefinition.id\r\n      );\r\n\r\n      const effectivelyDisabled = isAgentEffectivelyDisabled({\r\n        cfg,\r\n        agentId: agentDefinition.id,\r\n        resolvedFrontmatter,\r\n      });\r\n\r\n      if (effectivelyDisabled) {\r\n        const errorMessage = `Agent '${agentDefinition.id}' is disabled.`;\r\n\r\n        if (isSubagentWorkspace) {\r\n          const errorMessageId = createAssistantMessageId();\r\n          emitError(\r\n            createErrorEvent(workspaceId, {\r\n              messageId: errorMessageId,\r\n              error: errorMessage,\r\n              errorType: \"unknown\",\r\n            })\r\n          );\r\n          return Err({ type: \"unknown\", raw: errorMessage });\r\n        }\r\n\r\n        workspaceLog.warn(\"Selected agent is disabled; falling back to exec\", {\r\n          agentId: agentDefinition.id,\r\n          requestedAgentId,\r\n        });\r\n        agentDefinition = await readAgentDefinition(runtime, agentDiscoveryPath, \"exec\");\r\n        effectiveAgentId = agentDefinition.id;\r\n      }\r\n    } catch (error: unknown) {\r\n      // Best-effort only — do not fail a stream due to disablement resolution.\r\n      workspaceLog.debug(\"Failed to resolve agent enablement; continuing\", {\r\n        agentId: agentDefinition.id,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n\r\n  // --- Inheritance chain & plan-like detection ---\r\n  const agentsForInheritance = await resolveAgentInheritanceChain({\r\n    runtime,\r\n    workspacePath: agentDiscoveryPath,\r\n    agentId: agentDefinition.id,\r\n    agentDefinition,\r\n    workspaceId,\r\n  });\r\n\r\n  const agentIsPlanLike = isPlanLikeInResolvedChain(agentsForInheritance);\r\n  const effectiveMode =\r\n    agentDefinition.id === \"compact\" ? \"compact\" : agentIsPlanLike ? \"plan\" : \"exec\";\r\n\r\n  // --- Task nesting depth enforcement ---\r\n  const taskSettings = cfg.taskSettings ?? DEFAULT_TASK_SETTINGS;\r\n  const taskDepth = getTaskDepthFromConfig(cfg, workspaceId);\r\n  const shouldDisableTaskToolsForDepth = taskDepth >= taskSettings.maxTaskNestingDepth;\r\n\r\n  // --- Tool policy composition ---\r\n  // Agent policy establishes baseline (deny-all + enable whitelist + runtime restrictions).\r\n  // Caller policy then narrows further if needed.\r\n  const agentToolPolicy = resolveToolPolicyForAgent({\r\n    agents: agentsForInheritance,\r\n    isSubagent: isSubagentWorkspace,\r\n    disableTaskToolsForDepth: shouldDisableTaskToolsForDepth,\r\n  });\r\n\r\n  // The Chat with Mux system workspace must remain sandboxed regardless of caller-supplied\r\n  // toolPolicy (defense-in-depth).\r\n  const systemWorkspaceToolPolicy: ToolPolicy | undefined =\r\n    workspaceId === MUX_HELP_CHAT_WORKSPACE_ID\r\n      ? [\r\n          { regex_match: \".*\", action: \"disable\" },\r\n\r\n          // Allow docs lookup via built-in skills (e.g. mux-docs), while keeping\r\n          // filesystem/binary execution locked down.\r\n          { regex_match: \"agent_skill_read\", action: \"enable\" },\r\n          { regex_match: \"agent_skill_read_file\", action: \"enable\" },\r\n\r\n          { regex_match: \"mux_global_agents_read\", action: \"enable\" },\r\n          { regex_match: \"mux_global_agents_write\", action: \"enable\" },\r\n          { regex_match: \"ask_user_question\", action: \"enable\" },\r\n          { regex_match: \"todo_read\", action: \"enable\" },\r\n          { regex_match: \"todo_write\", action: \"enable\" },\r\n          { regex_match: \"status_set\", action: \"enable\" },\r\n          { regex_match: \"notify\", action: \"enable\" },\r\n        ]\r\n      : undefined;\r\n\r\n  const effectiveToolPolicy: ToolPolicy | undefined =\r\n    callerToolPolicy || agentToolPolicy.length > 0 || systemWorkspaceToolPolicy\r\n      ? [...agentToolPolicy, ...(callerToolPolicy ?? []), ...(systemWorkspaceToolPolicy ?? [])]\r\n      : undefined;\r\n\r\n  // --- Sentinel tool names for agent transition detection ---\r\n  // Creates a throwaway runtime to compute the tool name list that the message pipeline\r\n  // uses for mode-transition sentinel injection. This avoids depending on the real\r\n  // tool assembly (which happens later) while still respecting tool policy.\r\n  const earlyRuntime = createRuntime({ type: \"local\", srcBaseDir: process.cwd() });\r\n  const earlyAllTools = await getToolsForModel(\r\n    modelString,\r\n    {\r\n      cwd: process.cwd(),\r\n      runtime: earlyRuntime,\r\n      runtimeTempDir: os.tmpdir(),\r\n      secrets: {},\r\n      planFileOnly: agentIsPlanLike,\r\n    },\r\n    \"\", // Empty workspace ID for early stub config\r\n    initStateManager,\r\n    undefined,\r\n    undefined\r\n  );\r\n  const earlyTools = applyToolPolicy(earlyAllTools, effectiveToolPolicy);\r\n  const toolNamesForSentinel = Object.keys(earlyTools);\r\n\r\n  return Ok({\r\n    effectiveAgentId,\r\n    agentDefinition,\r\n    agentDiscoveryPath,\r\n    isSubagentWorkspace,\r\n    agentIsPlanLike,\r\n    effectiveMode,\r\n    taskSettings,\r\n    taskDepth,\r\n    shouldDisableTaskToolsForDepth,\r\n    effectiveToolPolicy,\r\n    toolNamesForSentinel,\r\n  });\r\n}\r\n"]}