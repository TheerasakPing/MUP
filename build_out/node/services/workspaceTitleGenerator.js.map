{"version":3,"file":"workspaceTitleGenerator.js","sourceRoot":"","sources":["../../../src/node/services/workspaceTitleGenerator.ts"],"names":[],"mappings":"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","sourcesContent":["import { NoObjectGeneratedError, streamText, Output } from \"ai\";\r\nimport { z } from \"zod\";\r\nimport type { AIService } from \"./aiService\";\r\nimport { log } from \"./log\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport crypto from \"crypto\";\r\n\r\n/** Schema for AI-generated workspace identity (area name + descriptive title) */\r\nconst workspaceIdentitySchema = z.object({\r\n  name: z\r\n    .string()\r\n    .regex(/^[a-z0-9-]+$/)\r\n    .min(2)\r\n    .max(20)\r\n    .describe(\r\n      \"Codebase area (1-2 words, max 15 chars): lowercase, hyphens only, e.g. 'sidebar', 'auth', 'config'\"\r\n    ),\r\n  title: z\r\n    .string()\r\n    .min(5)\r\n    .max(60)\r\n    .describe(\"Human-readable title (2-5 words): verb-noun format like 'Fix plan mode'\"),\r\n});\r\n\r\nexport interface WorkspaceIdentity {\r\n  /** Codebase area with 4-char suffix (e.g., \"sidebar-a1b2\", \"auth-k3m9\") */\r\n  name: string;\r\n  /** Human-readable title (e.g., \"Fix plan mode over SSH\") */\r\n  title: string;\r\n}\r\n\r\n// Crockford Base32 alphabet (excludes I, L, O, U to avoid confusion)\r\nconst CROCKFORD_ALPHABET = \"0123456789abcdefghjkmnpqrstvwxyz\";\r\n\r\n/**\r\n * Generate a 4-character random suffix using Crockford Base32.\r\n * Uses 20 bits of randomness (4 chars × 5 bits each).\r\n */\r\nfunction generateNameSuffix(): string {\r\n  const bytes = crypto.randomBytes(3); // 24 bits, we'll use 20\r\n  const value = (bytes[0] << 12) | (bytes[1] << 4) | (bytes[2] >> 4);\r\n  return (\r\n    CROCKFORD_ALPHABET[(value >> 15) & 0x1f] +\r\n    CROCKFORD_ALPHABET[(value >> 10) & 0x1f] +\r\n    CROCKFORD_ALPHABET[(value >> 5) & 0x1f] +\r\n    CROCKFORD_ALPHABET[value & 0x1f]\r\n  );\r\n}\r\n\r\nexport interface GenerateWorkspaceIdentityResult extends WorkspaceIdentity {\r\n  /** The model that successfully generated the identity */\r\n  modelUsed: string;\r\n}\r\n\r\n/**\r\n * Generate workspace identity (name + title) using AI.\r\n * Tries candidates in order, retrying on API errors (invalid keys, quota, etc.).\r\n *\r\n * - name: Codebase area with 4-char suffix (e.g., \"sidebar-a1b2\")\r\n * - title: Human-readable description (e.g., \"Fix plan mode over SSH\")\r\n */\r\nexport async function generateWorkspaceIdentity(\r\n  message: string,\r\n  candidates: string[],\r\n  aiService: AIService\r\n): Promise<Result<GenerateWorkspaceIdentityResult, SendMessageError>> {\r\n  if (candidates.length === 0) {\r\n    return Err({ type: \"unknown\", raw: \"No model candidates provided for name generation\" });\r\n  }\r\n\r\n  // Try up to 3 candidates\r\n  const maxAttempts = Math.min(candidates.length, 3);\r\n\r\n  // Track the last API error to return if all candidates fail\r\n  let lastApiError: string | undefined;\r\n\r\n  for (let i = 0; i < maxAttempts; i++) {\r\n    const modelString = candidates[i];\r\n\r\n    const modelResult = await aiService.createModel(modelString);\r\n    if (!modelResult.success) {\r\n      // No credentials for this model, try next\r\n      log.debug(`Name generation: skipping ${modelString} (${modelResult.error.type})`);\r\n      continue;\r\n    }\r\n\r\n    try {\r\n      // Use streamText instead of generateText: the Codex OAuth endpoint\r\n      // (chatgpt.com/backend-api/codex/responses) requires stream:true in the\r\n      // request body and rejects non-streaming requests with 400.  streamText\r\n      // sets stream:true automatically, while generateText does not.\r\n      const stream = streamText({\r\n        model: modelResult.data,\r\n        output: Output.object({ schema: workspaceIdentitySchema }),\r\n        prompt: `Generate a workspace name and title for this development task:\r\n\r\n\"${message}\"\r\n\r\nRequirements:\r\n- name: The area of the codebase being worked on (1-2 words, max 15 chars, git-safe: lowercase, hyphens only). Random bytes will be appended for uniqueness, so focus on the area not the specific task. Examples: \"sidebar\", \"auth\", \"config\", \"api\"\r\n- title: A 2-5 word description in verb-noun format. Examples: \"Fix plan mode\", \"Add user authentication\", \"Refactor sidebar layout\"`,\r\n      });\r\n\r\n      // Awaiting .output triggers full stream consumption and JSON parsing.\r\n      // If the model returned conversational text instead of JSON, this throws\r\n      // NoObjectGeneratedError — caught below with a text fallback parser.\r\n      const output = await stream.output;\r\n\r\n      const suffix = generateNameSuffix();\r\n      const sanitizedName = sanitizeBranchName(output.name, 20);\r\n      const nameWithSuffix = `${sanitizedName}-${suffix}`;\r\n\r\n      return Ok({\r\n        name: nameWithSuffix,\r\n        title: output.title.trim(),\r\n        modelUsed: modelString,\r\n      });\r\n    } catch (error) {\r\n      // Some models ignore the structured output instruction and return\r\n      // conversational text (e.g. \"**name:** `testing`\\n**title:** `Improve test coverage`\").\r\n      // NoObjectGeneratedError carries the raw .text — try to extract name/title\r\n      // from it before giving up on this candidate.\r\n      if (NoObjectGeneratedError.isInstance(error) && error.text) {\r\n        const textFallback = extractIdentityFromText(error.text);\r\n        if (textFallback) {\r\n          log.info(\r\n            `Name generation: structured output failed for ${modelString}, recovered from text fallback`\r\n          );\r\n          const suffix = generateNameSuffix();\r\n          const sanitizedName = sanitizeBranchName(textFallback.name, 20);\r\n          const nameWithSuffix = `${sanitizedName}-${suffix}`;\r\n          return Ok({\r\n            name: nameWithSuffix,\r\n            title: textFallback.title,\r\n            modelUsed: modelString,\r\n          });\r\n        }\r\n      }\r\n\r\n      // API error (invalid key, quota, network, etc.) - try next candidate\r\n      lastApiError = error instanceof Error ? error.message : String(error);\r\n      log.warn(`Name generation failed with ${modelString}, trying next candidate`, {\r\n        error: lastApiError,\r\n      });\r\n      continue;\r\n    }\r\n  }\r\n\r\n  // Return the last API error if available (more actionable than generic message)\r\n  const errorMessage = lastApiError\r\n    ? `Name generation failed: ${lastApiError}`\r\n    : \"Name generation failed - no working model found\";\r\n  return Err({ type: \"unknown\", raw: errorMessage });\r\n}\r\n\r\n/**\r\n * Fallback: extract name/title from conversational model text when structured\r\n * JSON output parsing fails. Handles common patterns like:\r\n *   **name:** `testing`          or  \"name\": \"testing\"\r\n *   **title:** `Improve tests`   or  \"title\": \"Improve tests\"\r\n *\r\n * Returns null if either field cannot be reliably extracted.\r\n */\r\nexport function extractIdentityFromText(text: string): { name: string; title: string } | null {\r\n  // Try JSON extraction first (model may have embedded JSON in prose)\r\n  const jsonMatch = /\\{[^}]*\"name\"\\s*:\\s*\"([^\"]+)\"[^}]*\"title\"\\s*:\\s*\"([^\"]+)\"[^}]*\\}/.exec(text);\r\n  if (jsonMatch) {\r\n    return validateExtracted(jsonMatch[1], jsonMatch[2]);\r\n  }\r\n  // Also try reverse field order in JSON\r\n  const jsonMatchReverse = /\\{[^}]*\"title\"\\s*:\\s*\"([^\"]+)\"[^}]*\"name\"\\s*:\\s*\"([^\"]+)\"[^}]*\\}/.exec(\r\n    text\r\n  );\r\n  if (jsonMatchReverse) {\r\n    return validateExtracted(jsonMatchReverse[2], jsonMatchReverse[1]);\r\n  }\r\n\r\n  // Try markdown/prose patterns: **name:** `value` or name: \"value\"\r\n  // In bold markdown the colon sits inside the stars: **name:**\r\n  const nameMatch =\r\n    /\\*?\\*?name:\\*?\\*?\\s*`([^`]+)`/i.exec(text) ?? /\\bname:\\s*\"([^\"]+)\"/i.exec(text);\r\n  const titleMatch =\r\n    /\\*?\\*?title:\\*?\\*?\\s*`([^`]+)`/i.exec(text) ?? /\\btitle:\\s*\"([^\"]+)\"/i.exec(text);\r\n\r\n  if (nameMatch && titleMatch) {\r\n    return validateExtracted(nameMatch[1], titleMatch[1]);\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/** Validate extracted values against the same constraints as the schema. */\r\nfunction validateExtracted(\r\n  rawName: string,\r\n  rawTitle: string\r\n): { name: string; title: string } | null {\r\n  const name = rawName\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9]+/g, \"-\")\r\n    .replace(/^-+|-+$/g, \"\")\r\n    .replace(/-+/g, \"-\");\r\n  const title = rawTitle.trim();\r\n\r\n  if (name.length < 2 || name.length > 20) return null;\r\n  if (title.length < 5 || title.length > 60) return null;\r\n\r\n  return { name, title };\r\n}\r\n\r\n/**\r\n * Sanitize a string to be git-safe: lowercase, hyphens only, no leading/trailing hyphens.\r\n */\r\nfunction sanitizeBranchName(name: string, maxLength: number): string {\r\n  return name\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9]+/g, \"-\")\r\n    .replace(/^-+|-+$/g, \"\")\r\n    .replace(/-+/g, \"-\")\r\n    .substring(0, maxLength);\r\n}\r\n"]}