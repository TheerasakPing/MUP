{"version":3,"file":"agentSession.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\nimport { EventEmitter } from \"events\";\nimport * as path from \"path\";\nimport { createHash } from \"crypto\";\nimport { readFile } from \"fs/promises\";\nimport YAML from \"yaml\";\nimport { PlatformPaths } from \"@/common/utils/paths\";\nimport { log } from \"@/node/services/log\";\nimport type { Config } from \"@/node/config\";\nimport type { AIService } from \"@/node/services/aiService\";\nimport type { HistoryService } from \"@/node/services/historyService\";\nimport type { PartialService } from \"@/node/services/partialService\";\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\nimport type { CostTrackingService } from \"@/node/services/costTrackingService\";\n\nimport type { FrontendWorkspaceMetadata } from \"@/common/types/workspace\";\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\nimport { DEFAULT_RUNTIME_CONFIG } from \"@/common/constants/workspace\";\nimport { DEFAULT_MODEL } from \"@/common/constants/knownModels\";\nimport type {\n  WorkspaceChatMessage,\n  SendMessageOptions,\n  FilePart,\n  DeleteMessage,\n} from \"@/common/orpc/types\";\nimport { WORKSPACE_DEFAULTS } from \"@/constants/workspaceDefaults\";\nimport type { SendMessageError } from \"@/common/types/errors\";\nimport { AgentIdSchema, SkillNameSchema } from \"@/common/orpc/schemas\";\nimport {\n  buildStreamErrorEventData,\n  createStreamErrorMessage,\n  createUnknownSendMessageError,\n  type StreamErrorPayload,\n} from \"@/node/services/utils/sendMessageError\";\nimport {\n  createUserMessageId,\n  createFileSnapshotMessageId,\n  createAgentSkillSnapshotMessageId,\n} from \"@/node/services/utils/messageIds\";\nimport {\n  FileChangeTracker,\n  type FileState,\n  type EditedFileAttachment,\n} from \"@/node/services/utils/fileChangeTracker\";\nimport type { Result } from \"@/common/types/result\";\nimport { Ok, Err } from \"@/common/types/result\";\nimport { enforceThinkingPolicy } from \"@/common/utils/thinking/policy\";\nimport {\n  createMuxMessage,\n  isCompactionSummaryMetadata,\n  prepareUserMessageForSend,\n  type CompactionFollowUpRequest,\n  type MuxFrontendMetadata,\n  type MuxFilePart,\n  type MuxMessage,\n  type ReviewNoteDataForDisplay,\n} from \"@/common/types/message\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\nimport { createRuntimeForWorkspace } from \"@/node/runtime/runtimeHelpers\";\nimport { isExecLikeEditingCapableInResolvedChain } from \"@/common/utils/agentTools\";\nimport { readAgentDefinition } from \"@/node/services/agentDefinitions/agentDefinitionsService\";\nimport { resolveAgentInheritanceChain } from \"@/node/services/agentDefinitions/resolveAgentInheritanceChain\";\nimport { MessageQueue } from \"./messageQueue\";\nimport type { StreamEndEvent } from \"@/common/types/stream\";\nimport { CompactionHandler } from \"./compactionHandler\";\nimport type { TelemetryService } from \"./telemetryService\";\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\n\nimport { AttachmentService } from \"./attachmentService\";\nimport type { TodoItem } from \"@/common/types/tools\";\nimport type { PostCompactionAttachment, PostCompactionExclusions } from \"@/common/types/attachment\";\nimport { TURNS_BETWEEN_ATTACHMENTS } from \"@/common/constants/attachments\";\n\nimport { extractEditedFileDiffs } from \"@/common/utils/messages/extractEditedFiles\";\nimport { getModelCapabilities } from \"@/common/utils/ai/modelCapabilities\";\nimport { normalizeGatewayModel, isValidModelFormat } from \"@/common/utils/ai/models\";\nimport { readAgentSkill } from \"@/node/services/agentSkills/agentSkillsService\";\nimport { materializeFileAtMentions } from \"@/node/services/fileAtMentions\";\n\n/**\n * Tracked file state for detecting external edits.\n * Uses timestamp-based polling with diff injection.\n */\n// Re-export types from FileChangeTracker for backward compatibility\nexport type { FileState, EditedFileAttachment } from \"@/node/services/utils/fileChangeTracker\";\n\n// Type guard for compaction request metadata\n// Supports both new `followUpContent` and legacy `continueMessage` for backwards compatibility\ninterface CompactionRequestMetadata {\n  type: \"compaction-request\";\n  parsed: {\n    followUpContent?: CompactionFollowUpRequest;\n    // Legacy field - older persisted requests may use this instead of followUpContent\n    continueMessage?: {\n      text?: string;\n      imageParts?: FilePart[];\n      reviews?: ReviewNoteDataForDisplay[];\n      muxMetadata?: MuxFrontendMetadata;\n      model?: string;\n      agentId?: string;\n      mode?: \"exec\" | \"plan\"; // Legacy: older versions stored mode instead of agentId\n    };\n  };\n}\n\nconst PDF_MEDIA_TYPE = \"application/pdf\";\n\nfunction normalizeMediaType(mediaType: string): string {\n  return mediaType.toLowerCase().trim().split(\";\")[0];\n}\n\nfunction estimateBase64DataUrlBytes(dataUrl: string): number | null {\n  if (!dataUrl.startsWith(\"data:\")) return null;\n\n  const commaIndex = dataUrl.indexOf(\",\");\n  if (commaIndex === -1) return null;\n\n  const header = dataUrl.slice(\"data:\".length, commaIndex);\n  if (!header.includes(\";base64\")) return null;\n\n  const base64 = dataUrl.slice(commaIndex + 1);\n  const padding = base64.endsWith(\"==\") ? 2 : base64.endsWith(\"=\") ? 1 : 0;\n  return Math.floor((base64.length * 3) / 4) - padding;\n}\nfunction isCompactionRequestMetadata(meta: unknown): meta is CompactionRequestMetadata {\n  if (typeof meta !== \"object\" || meta === null) return false;\n  const obj = meta as Record<string, unknown>;\n  if (obj.type !== \"compaction-request\") return false;\n  if (typeof obj.parsed !== \"object\" || obj.parsed === null) return false;\n  return true;\n}\n\nconst MAX_AGENT_SKILL_SNAPSHOT_CHARS = 50_000;\n\nexport interface AgentSessionChatEvent {\n  workspaceId: string;\n  message: WorkspaceChatMessage;\n}\n\nexport interface AgentSessionMetadataEvent {\n  workspaceId: string;\n  metadata: FrontendWorkspaceMetadata | null;\n}\n\ninterface AgentSessionOptions {\n  workspaceId: string;\n  config: Config;\n  historyService: HistoryService;\n  partialService: PartialService;\n  aiService: AIService;\n  initStateManager: InitStateManager;\n  costTrackingService: CostTrackingService;\n  telemetryService?: TelemetryService;\n  backgroundProcessManager: BackgroundProcessManager;\n  /** When true, skip terminating background processes on dispose/compaction (for bench/CI) */\n  keepBackgroundProcesses?: boolean;\n  /** Called when compaction completes (e.g., to clear idle compaction pending state) */\n  onCompactionComplete?: () => void;\n  /** Called when post-compaction context state may have changed (plan/file edits) */\n  onPostCompactionStateChange?: () => void;\n}\n\nexport class AgentSession {\n  private readonly workspaceId: string;\n  private readonly config: Config;\n  private readonly historyService: HistoryService;\n  private readonly partialService: PartialService;\n  private readonly aiService: AIService;\n  private readonly initStateManager: InitStateManager;\n  // @ts-expect-error TS6133  wired for future use, not consumed by methods yet\n  private readonly costTrackingService: CostTrackingService;\n  private readonly backgroundProcessManager: BackgroundProcessManager;\n  private readonly keepBackgroundProcesses: boolean;\n  private readonly onCompactionComplete?: () => void;\n  private readonly onPostCompactionStateChange?: () => void;\n  private readonly emitter = new EventEmitter();\n  private readonly aiListeners: Array<{ event: string; handler: (...args: unknown[]) => void }> =\n    [];\n  private readonly initListeners: Array<{ event: string; handler: (...args: unknown[]) => void }> =\n    [];\n  private disposed = false;\n  private streamStarting = false;\n  private readonly messageQueue = new MessageQueue();\n  private readonly compactionHandler: CompactionHandler;\n\n  /** Tracks file state for detecting external edits. */\n  private readonly fileChangeTracker = new FileChangeTracker();\n\n  /**\n   * Track turns since last post-compaction attachment injection.\n   * Start at max to trigger immediate injection on first turn after compaction.\n   */\n  private turnsSinceLastAttachment = TURNS_BETWEEN_ATTACHMENTS;\n\n  /**\n   * Flag indicating compaction has occurred in this session.\n   * Used to enable the cooldown-based attachment injection.\n   */\n  private compactionOccurred = false;\n\n  /**\n   * When true, clear any persisted post-compaction state after the next successful non-compaction stream.\n   *\n   * This is intentionally delayed until stream-end so a crash mid-stream doesn't lose the diffs.\n   */\n  private ackPendingPostCompactionStateOnStreamEnd = false;\n  /**\n   * Cache the last-known experiment state so we don't spam metadata refresh\n   * when post-compaction context is disabled.\n   */\n  /** Track compaction requests that already retried with truncation. */\n  private readonly compactionRetryAttempts = new Set<string>();\n  /**\n   * Active compaction request metadata for retry decisions (cleared on stream end/abort).\n   */\n\n  /** Tracks the user message id that initiated the currently active stream (for retry guards). */\n  private activeStreamUserMessageId?: string;\n\n  /** Track user message ids that already retried without post-compaction injection. */\n  private readonly postCompactionRetryAttempts = new Set<string>();\n\n  /** Track user message ids that already hard-restarted for exec-like subagents. */\n  private readonly execSubagentHardRestartAttempts = new Set<string>();\n\n  /** True once we see any model/tool output for the current stream (retry guard). */\n  private activeStreamHadAnyDelta = false;\n\n  /** Tracks whether the current stream included post-compaction attachments. */\n  private activeStreamHadPostCompactionInjection = false;\n\n  /** Context needed to retry the current stream (cleared on stream end/abort/error). */\n  private activeStreamContext?: {\n    modelString: string;\n    options?: SendMessageOptions;\n    openaiTruncationModeOverride?: \"auto\" | \"disabled\";\n  };\n\n  private activeCompactionRequest?: {\n    id: string;\n    modelString: string;\n    options?: SendMessageOptions;\n  };\n\n  constructor(options: AgentSessionOptions) {\n    assert(options, \"AgentSession requires options\");\n    const {\n      workspaceId,\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService,\n      telemetryService,\n      backgroundProcessManager,\n      keepBackgroundProcesses,\n      onCompactionComplete,\n      onPostCompactionStateChange,\n    } = options;\n\n    assert(typeof workspaceId === \"string\", \"workspaceId must be a string\");\n    const trimmedWorkspaceId = workspaceId.trim();\n    assert(trimmedWorkspaceId.length > 0, \"workspaceId must not be empty\");\n\n    this.workspaceId = trimmedWorkspaceId;\n    this.config = config;\n    this.historyService = historyService;\n    this.partialService = partialService;\n    this.aiService = aiService;\n    this.initStateManager = initStateManager;\n    this.costTrackingService = costTrackingService;\n    this.backgroundProcessManager = backgroundProcessManager;\n    this.keepBackgroundProcesses = keepBackgroundProcesses ?? false;\n    this.onCompactionComplete = onCompactionComplete;\n    this.onPostCompactionStateChange = onPostCompactionStateChange;\n\n    this.compactionHandler = new CompactionHandler({\n      workspaceId: this.workspaceId,\n      historyService: this.historyService,\n      partialService: this.partialService,\n      sessionDir: this.config.getSessionDir(this.workspaceId),\n      telemetryService,\n      emitter: this.emitter,\n      onCompactionComplete,\n    });\n\n    this.attachAiListeners();\n    this.attachInitListeners();\n  }\n\n  dispose(): void {\n    if (this.disposed) {\n      return;\n    }\n    this.disposed = true;\n\n    // Stop any active stream (fire and forget - disposal shouldn't block)\n    void this.aiService.stopStream(this.workspaceId, { abandonPartial: true });\n    // Terminate background processes for this workspace (skip when flagged for bench/CI)\n    if (!this.keepBackgroundProcesses) {\n      void this.backgroundProcessManager.cleanup(this.workspaceId);\n    }\n\n    for (const { event, handler } of this.aiListeners) {\n      this.aiService.off(event, handler as never);\n    }\n    this.aiListeners.length = 0;\n    for (const { event, handler } of this.initListeners) {\n      this.initStateManager.off(event, handler as never);\n    }\n    this.initListeners.length = 0;\n    this.emitter.removeAllListeners();\n  }\n\n  onChatEvent(listener: (event: AgentSessionChatEvent) => void): () => void {\n    assert(typeof listener === \"function\", \"listener must be a function\");\n    this.emitter.on(\"chat-event\", listener);\n    return () => {\n      this.emitter.off(\"chat-event\", listener);\n    };\n  }\n\n  onMetadataEvent(listener: (event: AgentSessionMetadataEvent) => void): () => void {\n    assert(typeof listener === \"function\", \"listener must be a function\");\n    this.emitter.on(\"metadata-event\", listener);\n    return () => {\n      this.emitter.off(\"metadata-event\", listener);\n    };\n  }\n\n  async subscribeChat(listener: (event: AgentSessionChatEvent) => void): Promise<() => void> {\n    this.assertNotDisposed(\"subscribeChat\");\n    assert(typeof listener === \"function\", \"listener must be a function\");\n\n    const unsubscribe = this.onChatEvent(listener);\n    await this.emitHistoricalEvents(listener);\n\n    // Crash recovery: check if the last message is a compaction summary with\n    // a pending follow-up that was never dispatched. If so, dispatch it now.\n    // This handles the case where the app crashed after compaction completed\n    // but before the follow-up was sent.\n    void this.dispatchPendingFollowUp();\n\n    return unsubscribe;\n  }\n\n  async replayHistory(listener: (event: AgentSessionChatEvent) => void): Promise<void> {\n    this.assertNotDisposed(\"replayHistory\");\n    assert(typeof listener === \"function\", \"listener must be a function\");\n    await this.emitHistoricalEvents(listener);\n  }\n\n  emitMetadata(metadata: FrontendWorkspaceMetadata | null): void {\n    this.assertNotDisposed(\"emitMetadata\");\n    this.emitter.emit(\"metadata-event\", {\n      workspaceId: this.workspaceId,\n      metadata,\n    } satisfies AgentSessionMetadataEvent);\n  }\n\n  private async emitHistoricalEvents(\n    listener: (event: AgentSessionChatEvent) => void\n  ): Promise<void> {\n    // try/catch/finally guarantees caught-up is always sent, even if replay fails.\n    // Without caught-up, the frontend stays in \"Loading workspace...\" forever.\n    try {\n      // Read partial BEFORE iterating history so we can skip the corresponding\n      // placeholder message (which has empty parts). The partial has the real content.\n      const streamInfo = this.aiService.getStreamInfo(this.workspaceId);\n      const partial = await this.partialService.readPartial(this.workspaceId);\n      const partialHistorySequence = partial?.metadata?.historySequence;\n\n      // Load chat history from the penultimate compaction boundary onward\n      // (skip=1) so the user sees the previous epoch plus the current epoch.\n      // This provides context for what was summarized in the latest compaction.\n      // TODO: support paginated history loading so users can view older epochs on demand.\n      const historyResult = await this.historyService.getHistoryFromLatestBoundary(\n        this.workspaceId,\n        1\n      );\n      if (historyResult.success) {\n        for (const message of historyResult.data) {\n          // Skip the placeholder message if we have a partial with the same historySequence.\n          // The placeholder has empty parts; the partial has the actual content.\n          // Without this, both get loaded and the empty placeholder may be shown as \"last message\".\n          if (\n            partialHistorySequence !== undefined &&\n            message.metadata?.historySequence === partialHistorySequence\n          ) {\n            continue;\n          }\n          // Add type: \"message\" for discriminated union (messages from chat.jsonl don't have it)\n          listener({ workspaceId: this.workspaceId, message: { ...message, type: \"message\" } });\n        }\n      }\n\n      if (streamInfo) {\n        await this.aiService.replayStream(this.workspaceId);\n      } else if (partial) {\n        // Add type: \"message\" for discriminated union (partials from disk don't have it)\n        listener({ workspaceId: this.workspaceId, message: { ...partial, type: \"message\" } });\n      }\n\n      // Replay init state BEFORE caught-up (treat as historical data)\n      // This ensures init events are buffered correctly by the frontend,\n      // preserving their natural timing characteristics from the hook execution.\n      await this.initStateManager.replayInit(this.workspaceId);\n    } catch (error) {\n      log.error(\"Failed to replay history for workspace\", {\n        workspaceId: this.workspaceId,\n        error,\n      });\n    } finally {\n      // Send caught-up after ALL historical data (including init events)\n      // This signals frontend that replay is complete and future events are real-time\n      listener({\n        workspaceId: this.workspaceId,\n        message: { type: \"caught-up\" },\n      });\n    }\n  }\n\n  async ensureMetadata(args: {\n    workspacePath: string;\n    projectName?: string;\n    runtimeConfig?: RuntimeConfig;\n  }): Promise<void> {\n    this.assertNotDisposed(\"ensureMetadata\");\n    assert(args, \"ensureMetadata requires arguments\");\n    const { workspacePath, projectName, runtimeConfig } = args;\n\n    assert(typeof workspacePath === \"string\", \"workspacePath must be a string\");\n    const trimmedWorkspacePath = workspacePath.trim();\n    assert(trimmedWorkspacePath.length > 0, \"workspacePath must not be empty\");\n\n    const normalizedWorkspacePath = path.resolve(trimmedWorkspacePath);\n    const existing = await this.aiService.getWorkspaceMetadata(this.workspaceId);\n\n    if (existing.success) {\n      // Metadata already exists, verify workspace path matches\n      const metadata = existing.data;\n      // For in-place workspaces (projectPath === name), use path directly\n      // Otherwise reconstruct using runtime's worktree pattern\n      const isInPlace = metadata.projectPath === metadata.name;\n      const expectedPath = isInPlace\n        ? metadata.projectPath\n        : (() => {\n            const runtime = createRuntime(metadata.runtimeConfig, {\n              projectPath: metadata.projectPath,\n              workspaceName: metadata.name,\n            });\n            return runtime.getWorkspacePath(metadata.projectPath, metadata.name);\n          })();\n      assert(\n        expectedPath === normalizedWorkspacePath,\n        `Existing metadata workspace path mismatch for ${this.workspaceId}: expected ${expectedPath}, got ${normalizedWorkspacePath}`\n      );\n      return;\n    }\n\n    // Detect in-place workspace: if workspacePath is not under srcBaseDir,\n    // it's a direct workspace (e.g., for CLI/benchmarks) rather than a worktree\n    const srcBaseDir = this.config.srcDir;\n    const normalizedSrcBaseDir = path.resolve(srcBaseDir);\n    const isUnderSrcBaseDir = normalizedWorkspacePath.startsWith(normalizedSrcBaseDir + path.sep);\n\n    let derivedProjectPath: string;\n    let workspaceName: string;\n    let derivedProjectName: string;\n\n    if (isUnderSrcBaseDir) {\n      // Standard worktree mode: workspace is under ~/.mux/src/project/branch\n      derivedProjectPath = path.dirname(normalizedWorkspacePath);\n      workspaceName = PlatformPaths.basename(normalizedWorkspacePath);\n      derivedProjectName =\n        projectName && projectName.trim().length > 0\n          ? projectName.trim()\n          : PlatformPaths.basename(derivedProjectPath) || \"unknown\";\n    } else {\n      // In-place mode: workspace is a standalone directory\n      // Store the workspace path directly by setting projectPath === name\n      derivedProjectPath = normalizedWorkspacePath;\n      workspaceName = normalizedWorkspacePath;\n      derivedProjectName =\n        projectName && projectName.trim().length > 0\n          ? projectName.trim()\n          : PlatformPaths.basename(normalizedWorkspacePath) || \"unknown\";\n    }\n\n    const metadata: FrontendWorkspaceMetadata = {\n      id: this.workspaceId,\n      name: workspaceName,\n      projectName: derivedProjectName,\n      projectPath: derivedProjectPath,\n      namedWorkspacePath: normalizedWorkspacePath,\n      runtimeConfig: runtimeConfig ?? DEFAULT_RUNTIME_CONFIG,\n    };\n\n    // Write metadata directly to config.json (single source of truth)\n    await this.config.addWorkspace(derivedProjectPath, metadata);\n    this.emitMetadata(metadata);\n  }\n\n  async sendMessage(\n    message: string,\n    options?: SendMessageOptions & { fileParts?: FilePart[] },\n    internal?: { synthetic?: boolean }\n  ): Promise<Result<void, SendMessageError>> {\n    this.assertNotDisposed(\"sendMessage\");\n\n    assert(typeof message === \"string\", \"sendMessage requires a string message\");\n    const trimmedMessage = message.trim();\n    const fileParts = options?.fileParts;\n    const editMessageId = options?.editMessageId;\n\n    // Edits are implemented as truncate+replace. If the frontend omits fileParts,\n    // preserve the original message's attachments.\n    // Only search the current compaction epoch  edits of pre-boundary messages are\n    // blocked (the frontend only shows post-boundary messages).\n    let preservedEditFileParts: MuxFilePart[] | undefined;\n    if (editMessageId && fileParts === undefined) {\n      const historyResult = await this.historyService.getHistoryFromLatestBoundary(\n        this.workspaceId\n      );\n      if (historyResult.success) {\n        const targetMessage: MuxMessage | undefined = historyResult.data.find(\n          (msg) => msg.id === editMessageId\n        );\n        const fileParts = targetMessage?.parts.filter(\n          (part): part is MuxFilePart => part.type === \"file\"\n        );\n        if (fileParts && fileParts.length > 0) {\n          preservedEditFileParts = fileParts;\n        }\n      }\n    }\n\n    const hasFiles = (fileParts?.length ?? 0) > 0 || (preservedEditFileParts?.length ?? 0) > 0;\n\n    if (trimmedMessage.length === 0 && !hasFiles) {\n      return Err(\n        createUnknownSendMessageError(\n          \"Empty message not allowed. Use interruptStream() to interrupt active streams.\"\n        )\n      );\n    }\n\n    if (editMessageId) {\n      // Interrupt an existing stream or compaction, if active\n      if (this.aiService.isStreaming(this.workspaceId)) {\n        // MUST use abandonPartial=true to prevent handleAbort from performing partial compaction\n        // with mismatched history (since we're about to truncate it)\n        const stopResult = await this.interruptStream({ abandonPartial: true });\n        if (!stopResult.success) {\n          return Err(createUnknownSendMessageError(stopResult.error));\n        }\n      }\n\n      // Find the truncation target: the edited message or any immediately-preceding snapshots.\n      // (snapshots are persisted immediately before their corresponding user message)\n      // Only search the current compaction epoch  truncating past a compaction boundary\n      // would destroy the summary. The frontend only shows post-boundary messages.\n      let truncateTargetId = editMessageId;\n      const historyResult = await this.historyService.getHistoryFromLatestBoundary(\n        this.workspaceId\n      );\n      if (historyResult.success) {\n        const messages = historyResult.data;\n        const editIndex = messages.findIndex((m) => m.id === editMessageId);\n        if (editIndex > 0) {\n          // Walk backwards over contiguous synthetic snapshots so we don't orphan them.\n          for (let i = editIndex - 1; i >= 0; i--) {\n            const msg = messages[i];\n            const isSnapshot =\n              msg.metadata?.synthetic &&\n              (msg.metadata?.fileAtMentionSnapshot ?? msg.metadata?.agentSkillSnapshot);\n            if (!isSnapshot) break;\n            truncateTargetId = msg.id;\n          }\n        }\n      }\n\n      const truncateResult = await this.historyService.truncateAfterMessage(\n        this.workspaceId,\n        truncateTargetId\n      );\n      if (!truncateResult.success) {\n        const isMissingEditTarget =\n          truncateResult.error.includes(\"Message with ID\") &&\n          truncateResult.error.includes(\"not found in history\");\n        if (isMissingEditTarget) {\n          // This can happen if the frontend is briefly out-of-sync with persisted history\n          // (e.g., compaction/truncation completed and removed the message while the UI still\n          // shows it as editable). Treat as a no-op truncation so the user can recover.\n          log.warn(\"editMessageId not found in history; proceeding without truncation\", {\n            workspaceId: this.workspaceId,\n            editMessageId,\n            error: truncateResult.error,\n          });\n        } else {\n          return Err(createUnknownSendMessageError(truncateResult.error));\n        }\n      }\n    }\n\n    const messageId = createUserMessageId();\n    const additionalParts =\n      preservedEditFileParts && preservedEditFileParts.length > 0\n        ? preservedEditFileParts\n        : fileParts && fileParts.length > 0\n          ? fileParts.map((part, index) => {\n              assert(\n                typeof part.url === \"string\",\n                `file part [${index}] must include url string content (got ${typeof part.url}): ${JSON.stringify(part).slice(0, 200)}`\n              );\n              assert(\n                part.url.startsWith(\"data:\"),\n                `file part [${index}] url must be a data URL (got: ${part.url.slice(0, 50)}...)`\n              );\n              assert(\n                typeof part.mediaType === \"string\" && part.mediaType.trim().length > 0,\n                `file part [${index}] must include a mediaType (got ${typeof part.mediaType}): ${JSON.stringify(part).slice(0, 200)}`\n              );\n              if (part.filename !== undefined) {\n                assert(\n                  typeof part.filename === \"string\",\n                  `file part [${index}] filename must be a string if present (got ${typeof part.filename}): ${JSON.stringify(part).slice(0, 200)}`\n                );\n              }\n              return {\n                type: \"file\" as const,\n                url: part.url,\n                mediaType: part.mediaType,\n                filename: part.filename,\n              };\n            })\n          : undefined;\n\n    // toolPolicy is properly typed via Zod schema inference\n    const typedToolPolicy = options?.toolPolicy;\n    // muxMetadata is z.any() in schema - cast to proper type\n    const typedMuxMetadata = options?.muxMetadata as MuxFrontendMetadata | undefined;\n    const isCompactionRequest = isCompactionRequestMetadata(typedMuxMetadata);\n\n    // Validate model BEFORE persisting message to prevent orphaned messages on invalid model\n    if (!options?.model || options.model.trim().length === 0) {\n      return Err(\n        createUnknownSendMessageError(\"No model specified. Please select a model using /model.\")\n      );\n    }\n\n    const rawModelString = options.model.trim();\n    const rawSystem1Model = options.system1Model?.trim();\n\n    options = this.normalizeGatewaySendOptions(options);\n\n    // Preserve explicit mux-gateway prefixes from legacy clients so backend routing can\n    // honor the opt-in even before muxGatewayModels has synchronized.\n    const modelForStream = rawModelString.startsWith(\"mux-gateway:\")\n      ? rawModelString\n      : options.model;\n    const optionsForStream = rawSystem1Model?.startsWith(\"mux-gateway:\")\n      ? { ...options, system1Model: rawSystem1Model }\n      : options;\n\n    // Defense-in-depth: reject PDFs for models we know don't support them.\n    // (Frontend should also block this, but it's easy to bypass via IPC / older clients.)\n    const effectiveFileParts =\n      preservedEditFileParts && preservedEditFileParts.length > 0\n        ? preservedEditFileParts.map((part) => ({\n            url: part.url,\n            mediaType: part.mediaType,\n            filename: part.filename,\n          }))\n        : fileParts;\n\n    if (effectiveFileParts && effectiveFileParts.length > 0) {\n      const pdfParts = effectiveFileParts.filter(\n        (part) => normalizeMediaType(part.mediaType) === PDF_MEDIA_TYPE\n      );\n\n      if (pdfParts.length > 0) {\n        const caps = getModelCapabilities(options.model);\n\n        if (caps && !caps.supportsPdfInput) {\n          return Err(\n            createUnknownSendMessageError(`Model ${options.model} does not support PDF input.`)\n          );\n        }\n\n        if (caps?.maxPdfSizeMb !== undefined) {\n          const maxBytes = caps.maxPdfSizeMb * 1024 * 1024;\n          for (const part of pdfParts) {\n            const bytes = estimateBase64DataUrlBytes(part.url);\n            if (bytes !== null && bytes > maxBytes) {\n              const actualMb = (bytes / (1024 * 1024)).toFixed(1);\n              const label = part.filename ?? \"PDF\";\n              return Err(\n                createUnknownSendMessageError(\n                  `${label} is ${actualMb}MB, but ${options.model} allows up to ${caps.maxPdfSizeMb}MB per PDF.`\n                )\n              );\n            }\n          }\n        }\n      }\n    }\n    // Validate model string format (must be \"provider:model-id\")\n    if (!isValidModelFormat(options.model)) {\n      return Err({\n        type: \"invalid_model_string\",\n        message: `Invalid model string format: \"${options.model}\". Expected \"provider:model-id\"`,\n      });\n    }\n\n    const userMessage = createMuxMessage(\n      messageId,\n      \"user\",\n      message,\n      {\n        timestamp: Date.now(),\n        toolPolicy: typedToolPolicy,\n        muxMetadata: typedMuxMetadata, // Pass through frontend metadata as black-box\n        // Auto-resume and other system-generated messages are synthetic + UI-visible\n        ...(internal?.synthetic && { synthetic: true, uiVisible: true }),\n      },\n      additionalParts\n    );\n\n    // Materialize @file mentions from the user message into a snapshot.\n    // This ensures prompt-cache stability: we read files once and persist the content,\n    // so subsequent turns don't re-read (which would change the prompt prefix if files changed).\n    // File changes after this point are surfaced via <system-file-update> diffs instead.\n    const snapshotResult = await this.materializeFileAtMentionsSnapshot(trimmedMessage);\n    let skillSnapshotResult: { snapshotMessage: MuxMessage } | null = null;\n    try {\n      skillSnapshotResult = await this.materializeAgentSkillSnapshot(\n        typedMuxMetadata,\n        options?.disableWorkspaceAgents\n      );\n    } catch (error) {\n      return Err(\n        createUnknownSendMessageError(error instanceof Error ? error.message : String(error))\n      );\n    }\n\n    // Persist snapshots (if any) BEFORE the user message so they precede it in the prompt.\n    // Order matters: @file snapshot first, then agent-skill snapshot.\n    if (snapshotResult?.snapshotMessage) {\n      const snapshotAppendResult = await this.historyService.appendToHistory(\n        this.workspaceId,\n        snapshotResult.snapshotMessage\n      );\n      if (!snapshotAppendResult.success) {\n        return Err(createUnknownSendMessageError(snapshotAppendResult.error));\n      }\n    }\n\n    if (skillSnapshotResult?.snapshotMessage) {\n      const skillSnapshotAppendResult = await this.historyService.appendToHistory(\n        this.workspaceId,\n        skillSnapshotResult.snapshotMessage\n      );\n      if (!skillSnapshotAppendResult.success) {\n        return Err(createUnknownSendMessageError(skillSnapshotAppendResult.error));\n      }\n    }\n\n    const appendResult = await this.historyService.appendToHistory(this.workspaceId, userMessage);\n    if (!appendResult.success) {\n      // Note: If we get here with snapshots, one or more snapshots may already be persisted but user message\n      // failed. This is a rare edge case (disk full mid-operation). The next edit will clean up\n      // the orphan via the truncation logic that removes preceding snapshots.\n      return Err(createUnknownSendMessageError(appendResult.error));\n    }\n\n    // Workspace may be tearing down while we await filesystem IO.\n    // If so, skip event emission + streaming to avoid races with dispose().\n    if (this.disposed) {\n      return Ok(undefined);\n    }\n\n    // Emit snapshots first (if any), then user message - maintains prompt ordering in UI\n    if (snapshotResult?.snapshotMessage) {\n      this.emitChatEvent({ ...snapshotResult.snapshotMessage, type: \"message\" });\n    }\n\n    if (skillSnapshotResult?.snapshotMessage) {\n      this.emitChatEvent({ ...skillSnapshotResult.snapshotMessage, type: \"message\" });\n    }\n\n    // Add type: \"message\" for discriminated union (createMuxMessage doesn't add it)\n    this.emitChatEvent({ ...userMessage, type: \"message\" });\n\n    this.streamStarting = true;\n\n    try {\n      // If this is a compaction request, terminate background processes first\n      // They won't be included in the summary, so continuing with orphaned processes would be confusing\n      if (isCompactionRequest && !this.keepBackgroundProcesses) {\n        await this.backgroundProcessManager.cleanup(this.workspaceId);\n\n        if (this.disposed) {\n          return Ok(undefined);\n        }\n      }\n\n      // Note: Follow-up content for compaction is now stored on the summary message\n      // and dispatched via dispatchPendingFollowUp() after compaction completes.\n      // This provides crash safety - the follow-up survives app restarts.\n\n      if (this.disposed) {\n        return Ok(undefined);\n      }\n\n      // Must await here so the finally block runs after streaming completes,\n      // not immediately when the Promise is returned. This keeps streamStarting=true\n      // for the entire duration of streaming, allowing follow-up messages to be queued.\n      const result = await this.streamWithHistory(modelForStream, optionsForStream);\n      return result;\n    } finally {\n      this.streamStarting = false;\n    }\n  }\n\n  async resumeStream(options: SendMessageOptions): Promise<Result<void, SendMessageError>> {\n    this.assertNotDisposed(\"resumeStream\");\n\n    assert(options, \"resumeStream requires options\");\n    const { model } = options;\n    assert(typeof model === \"string\" && model.trim().length > 0, \"resumeStream requires a model\");\n\n    const rawModelString = options.model.trim();\n    const rawSystem1Model = options.system1Model?.trim();\n    const normalizedOptions = this.normalizeGatewaySendOptions(options);\n\n    // Preserve explicit mux-gateway prefixes from legacy clients so backend routing can\n    // honor the opt-in even before muxGatewayModels has synchronized.\n    const modelForStream = rawModelString.startsWith(\"mux-gateway:\")\n      ? rawModelString\n      : normalizedOptions.model;\n    const optionsForStream = rawSystem1Model?.startsWith(\"mux-gateway:\")\n      ? { ...normalizedOptions, system1Model: rawSystem1Model }\n      : normalizedOptions;\n\n    // Guard against auto-retry starting a second stream while the initial send is\n    // still waiting for init hooks to complete.\n    if (this.streamStarting || this.aiService.isStreaming(this.workspaceId)) {\n      return Ok(undefined);\n    }\n\n    this.streamStarting = true;\n    try {\n      // Must await here so the finally block runs after streaming completes,\n      // not immediately when the Promise is returned.\n      const result = await this.streamWithHistory(modelForStream, optionsForStream);\n      return result;\n    } finally {\n      this.streamStarting = false;\n    }\n  }\n\n  private normalizeGatewaySendOptions(options: SendMessageOptions): SendMessageOptions {\n    // Keep persisted model IDs canonical; gateway routing is now backend-authoritative (issue #1769).\n    const normalizedModel = normalizeGatewayModel(options.model.trim());\n    const system1Model = options.system1Model?.trim();\n    const normalizedSystem1Model =\n      system1Model && system1Model.length > 0 ? normalizeGatewayModel(system1Model) : undefined;\n\n    return {\n      ...options,\n      model: normalizedModel,\n      system1Model: normalizedSystem1Model,\n    };\n  }\n\n  async interruptStream(options?: {\n    soft?: boolean;\n    abandonPartial?: boolean;\n  }): Promise<Result<void>> {\n    this.assertNotDisposed(\"interruptStream\");\n\n    // For hard interrupts, delete partial BEFORE stopping to prevent abort handler\n    // from committing it. For soft interrupts, defer to stream-abort handler since\n    // the stream continues running and would recreate the partial.\n    if (options?.abandonPartial && !options?.soft) {\n      const deleteResult = await this.partialService.deletePartial(this.workspaceId);\n      if (!deleteResult.success) {\n        return Err(deleteResult.error);\n      }\n    }\n\n    const stopResult = await this.aiService.stopStream(this.workspaceId, {\n      ...options,\n      abortReason: \"user\",\n    });\n    if (!stopResult.success) {\n      return Err(stopResult.error);\n    }\n\n    return Ok(undefined);\n  }\n\n  private async streamWithHistory(\n    modelString: string,\n    options?: SendMessageOptions,\n    openaiTruncationModeOverride?: \"auto\" | \"disabled\",\n    disablePostCompactionAttachments?: boolean\n  ): Promise<Result<void, SendMessageError>> {\n    if (this.disposed) {\n      return Ok(undefined);\n    }\n\n    // Reset per-stream flags (used for retries / crash-safe bookkeeping).\n    this.ackPendingPostCompactionStateOnStreamEnd = false;\n    this.activeStreamHadAnyDelta = false;\n    this.activeStreamHadPostCompactionInjection = false;\n    this.activeStreamContext = {\n      modelString,\n      options,\n      openaiTruncationModeOverride,\n    };\n    this.activeStreamUserMessageId = undefined;\n\n    const commitResult = await this.partialService.commitToHistory(this.workspaceId);\n    if (!commitResult.success) {\n      return Err(createUnknownSendMessageError(commitResult.error));\n    }\n\n    let historyResult = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\n    if (!historyResult.success) {\n      return Err(createUnknownSendMessageError(historyResult.error));\n    }\n\n    if (historyResult.data.length === 0) {\n      return Err(\n        createUnknownSendMessageError(\n          \"Cannot resume stream: workspace history is empty. Send a new message instead.\"\n        )\n      );\n    }\n\n    // Structural invariant: API requests must not end with a non-partial assistant message.\n    // Partial assistants are handled by addInterruptedSentinel at transform time.\n    // Non-partial trailing assistants indicate a missing user message upstream  inject a\n    // [CONTINUE] sentinel so the model has a valid conversation to respond to. This is\n    // defense-in-depth; callers should prefer sendMessage() which persists a real user message.\n    const lastMsg = historyResult.data[historyResult.data.length - 1];\n    if (lastMsg?.role === \"assistant\" && !lastMsg.metadata?.partial) {\n      log.warn(\"streamWithHistory: trailing non-partial assistant detected, injecting [CONTINUE]\", {\n        workspaceId: this.workspaceId,\n        messageId: lastMsg.id,\n      });\n      const sentinelMessage = createMuxMessage(createUserMessageId(), \"user\", \"[CONTINUE]\", {\n        timestamp: Date.now(),\n        synthetic: true,\n      });\n      await this.historyService.appendToHistory(this.workspaceId, sentinelMessage);\n      const refreshed = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\n      if (refreshed.success) {\n        historyResult = refreshed;\n      }\n    }\n\n    // Capture the current user message id so retries are stable across assistant message ids.\n    const lastUserMessage = [...historyResult.data].reverse().find((m) => m.role === \"user\");\n    this.activeStreamUserMessageId = lastUserMessage?.id;\n\n    this.activeCompactionRequest = this.resolveCompactionRequest(\n      historyResult.data,\n      modelString,\n      options\n    );\n\n    // Check for external file edits (timestamp-based polling)\n    const changedFileAttachments = await this.fileChangeTracker.getChangedAttachments();\n\n    // Check if post-compaction attachments should be injected.\n    const postCompactionAttachments =\n      disablePostCompactionAttachments === true\n        ? null\n        : await this.getPostCompactionAttachmentsIfNeeded();\n    this.activeStreamHadPostCompactionInjection =\n      postCompactionAttachments !== null && postCompactionAttachments.length > 0;\n\n    // Enforce thinking policy for the specified model (single source of truth)\n    // This ensures model-specific requirements are met regardless of where the request originates\n    const effectiveThinkingLevel = options?.thinkingLevel\n      ? enforceThinkingPolicy(modelString, options.thinkingLevel)\n      : undefined;\n\n    // Bind recordFileState to this session for the propose_plan tool\n    const recordFileState = this.fileChangeTracker.record.bind(this.fileChangeTracker);\n\n    const streamResult = await this.aiService.streamMessage({\n      messages: historyResult.data,\n      workspaceId: this.workspaceId,\n      modelString,\n      thinkingLevel: effectiveThinkingLevel,\n      toolPolicy: options?.toolPolicy,\n      additionalSystemInstructions: options?.additionalSystemInstructions,\n      maxOutputTokens: options?.maxOutputTokens,\n      muxProviderOptions: options?.providerOptions,\n      agentId: options?.agentId,\n      recordFileState,\n      changedFileAttachments:\n        changedFileAttachments.length > 0 ? changedFileAttachments : undefined,\n      postCompactionAttachments,\n      experiments: options?.experiments,\n      system1Model: options?.system1Model,\n      system1ThinkingLevel: options?.system1ThinkingLevel,\n      disableWorkspaceAgents: options?.disableWorkspaceAgents,\n      hasQueuedMessage: () => !this.messageQueue.isEmpty(),\n      openaiTruncationModeOverride,\n    });\n\n    if (!streamResult.success) {\n      this.activeCompactionRequest = undefined;\n\n      // If stream startup failed before any stream events were emitted (e.g., missing API key),\n      // emit a synthetic stream-error so the UI can surface the failure immediately.\n      if (\n        streamResult.error.type !== \"runtime_not_ready\" &&\n        streamResult.error.type !== \"runtime_start_failed\"\n      ) {\n        const streamError = buildStreamErrorEventData(streamResult.error);\n        await this.handleStreamError(streamError);\n      }\n    }\n\n    return streamResult;\n  }\n\n  private resolveCompactionRequest(\n    history: MuxMessage[],\n    modelString: string,\n    options?: SendMessageOptions\n  ): { id: string; modelString: string; options?: SendMessageOptions } | undefined {\n    for (let index = history.length - 1; index >= 0; index -= 1) {\n      const message = history[index];\n      if (message.role !== \"user\") {\n        continue;\n      }\n      if (!isCompactionRequestMetadata(message.metadata?.muxMetadata)) {\n        return undefined;\n      }\n      return {\n        id: message.id,\n        modelString,\n        options,\n      };\n    }\n    return undefined;\n  }\n\n  private async clearFailedAssistantMessage(messageId: string, reason: string): Promise<void> {\n    const [partialResult, deleteMessageResult] = await Promise.all([\n      this.partialService.deletePartial(this.workspaceId),\n      this.historyService.deleteMessage(this.workspaceId, messageId),\n    ]);\n\n    if (!partialResult.success) {\n      log.warn(\"Failed to clear partial before retry\", {\n        workspaceId: this.workspaceId,\n        reason,\n        error: partialResult.error,\n      });\n    }\n\n    if (\n      !deleteMessageResult.success &&\n      !(\n        typeof deleteMessageResult.error === \"string\" &&\n        deleteMessageResult.error.includes(\"not found in history\")\n      )\n    ) {\n      log.warn(\"Failed to delete failed assistant placeholder\", {\n        workspaceId: this.workspaceId,\n        reason,\n        error: deleteMessageResult.error,\n      });\n    }\n  }\n\n  private async finalizeCompactionRetry(messageId: string): Promise<void> {\n    this.activeCompactionRequest = undefined;\n    this.resetActiveStreamState();\n    this.emitChatEvent({\n      type: \"stream-abort\",\n      workspaceId: this.workspaceId,\n      messageId,\n    });\n    await this.clearFailedAssistantMessage(messageId, \"compaction-retry\");\n  }\n\n  private supports1MContextRetry(modelString: string): boolean {\n    const normalized = normalizeGatewayModel(modelString);\n    const [provider, modelName] = normalized.split(\":\", 2);\n    const lower = modelName?.toLowerCase() ?? \"\";\n    return (\n      provider === \"anthropic\" &&\n      (lower.startsWith(\"claude-sonnet-4-5\") || lower.startsWith(\"claude-opus-4-6\"))\n    );\n  }\n\n  private withAnthropic1MContext(\n    modelString: string,\n    options: SendMessageOptions | undefined\n  ): SendMessageOptions {\n    if (options) {\n      const existingModels = options.providerOptions?.anthropic?.use1MContextModels ?? [];\n      return {\n        ...options,\n        providerOptions: {\n          ...options.providerOptions,\n          anthropic: {\n            ...options.providerOptions?.anthropic,\n            use1MContext: true,\n            use1MContextModels: existingModels.includes(modelString)\n              ? existingModels\n              : [...existingModels, modelString],\n          },\n        },\n      };\n    }\n\n    return {\n      model: modelString,\n      agentId: WORKSPACE_DEFAULTS.agentId,\n      providerOptions: {\n        anthropic: {\n          use1MContext: true,\n          use1MContextModels: [modelString],\n        },\n      },\n    };\n  }\n\n  private isGptClassModel(modelString: string): boolean {\n    const normalized = normalizeGatewayModel(modelString);\n    const [provider, modelName] = normalized.split(\":\", 2);\n    return provider === \"openai\" && modelName?.toLowerCase().startsWith(\"gpt-\");\n  }\n\n  private async maybeRetryCompactionOnContextExceeded(data: {\n    messageId: string;\n    errorType?: string;\n  }): Promise<boolean> {\n    if (data.errorType !== \"context_exceeded\") {\n      return false;\n    }\n\n    const context = this.activeCompactionRequest;\n    if (!context) {\n      return false;\n    }\n\n    const isGptClass = this.isGptClassModel(context.modelString);\n    const is1MCapable = this.supports1MContextRetry(context.modelString);\n\n    if (!isGptClass && !is1MCapable) {\n      return false;\n    }\n\n    if (is1MCapable) {\n      // Skip retry if 1M context is already enabled (via legacy global flag or per-model list)\n      const anthropicOpts = context.options?.providerOptions?.anthropic;\n      const already1M =\n        anthropicOpts?.use1MContext === true ||\n        (anthropicOpts?.use1MContextModels?.includes(context.modelString) ?? false);\n      if (already1M) {\n        return false;\n      }\n    }\n\n    if (this.compactionRetryAttempts.has(context.id)) {\n      return false;\n    }\n\n    this.compactionRetryAttempts.add(context.id);\n\n    const retryLabel = is1MCapable ? \"Anthropic 1M context\" : \"OpenAI truncation\";\n    log.info(`Compaction hit context limit; retrying once with ${retryLabel}`, {\n      workspaceId: this.workspaceId,\n      model: context.modelString,\n      compactionRequestId: context.id,\n    });\n\n    await this.finalizeCompactionRetry(data.messageId);\n\n    const retryOptions = is1MCapable\n      ? this.withAnthropic1MContext(context.modelString, context.options)\n      : context.options;\n    this.streamStarting = true;\n    let retryResult: Result<void, SendMessageError>;\n    try {\n      retryResult = await this.streamWithHistory(\n        context.modelString,\n        retryOptions,\n        isGptClass ? \"auto\" : undefined\n      );\n    } finally {\n      this.streamStarting = false;\n    }\n    if (!retryResult.success) {\n      log.error(\"Compaction retry failed to start\", {\n        workspaceId: this.workspaceId,\n        error: retryResult.error,\n      });\n      return false;\n    }\n\n    return true;\n  }\n\n  private async maybeRetryWithoutPostCompactionOnContextExceeded(data: {\n    messageId: string;\n    errorType?: string;\n  }): Promise<boolean> {\n    if (data.errorType !== \"context_exceeded\") {\n      return false;\n    }\n\n    // Only retry if we actually injected post-compaction context.\n    if (!this.activeStreamHadPostCompactionInjection) {\n      return false;\n    }\n\n    // Guardrail: don't retry if we've already emitted any meaningful output.\n    if (this.activeStreamHadAnyDelta) {\n      return false;\n    }\n\n    const requestId = this.activeStreamUserMessageId;\n    const context = this.activeStreamContext;\n    if (!requestId || !context) {\n      return false;\n    }\n\n    if (this.postCompactionRetryAttempts.has(requestId)) {\n      return false;\n    }\n\n    this.postCompactionRetryAttempts.add(requestId);\n\n    log.info(\"Post-compaction context hit context limit; retrying once without it\", {\n      workspaceId: this.workspaceId,\n      requestId,\n      model: context.modelString,\n    });\n\n    // The post-compaction diffs are likely the culprit; discard them so we don't loop.\n    try {\n      await this.compactionHandler.discardPendingDiffs(\"context_exceeded\");\n      this.onPostCompactionStateChange?.();\n    } catch (error) {\n      log.warn(\"Failed to discard pending post-compaction state\", {\n        workspaceId: this.workspaceId,\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n\n    // Abort the failed assistant placeholder and clean up persisted partial/history state.\n    this.resetActiveStreamState();\n    this.emitChatEvent({\n      type: \"stream-abort\",\n      workspaceId: this.workspaceId,\n      messageId: data.messageId,\n    });\n    await this.clearFailedAssistantMessage(data.messageId, \"post-compaction-retry\");\n\n    // Retry the same request, but without post-compaction injection.\n    this.streamStarting = true;\n    let retryResult: Result<void, SendMessageError>;\n    try {\n      retryResult = await this.streamWithHistory(\n        context.modelString,\n        context.options,\n        context.openaiTruncationModeOverride,\n        true\n      );\n    } finally {\n      this.streamStarting = false;\n    }\n\n    if (!retryResult.success) {\n      log.error(\"Post-compaction retry failed to start\", {\n        workspaceId: this.workspaceId,\n        error: retryResult.error,\n      });\n      return false;\n    }\n\n    return true;\n  }\n\n  private async maybeHardRestartExecSubagentOnContextExceeded(data: {\n    messageId: string;\n    errorType?: string;\n  }): Promise<boolean> {\n    if (data.errorType !== \"context_exceeded\") {\n      return false;\n    }\n\n    // Only enabled via experiment (and only when we still have a valid retry context).\n    const context = this.activeStreamContext;\n    const requestId = this.activeStreamUserMessageId;\n    const experimentEnabled = context?.options?.experiments?.execSubagentHardRestart === true;\n    if (!experimentEnabled || !context || !requestId) {\n      return false;\n    }\n\n    // Guardrail: don't hard-restart after any meaningful output.\n    // This is intended to recover from \"prompt too long\" cases before the model starts streaming.\n    if (this.activeStreamHadAnyDelta) {\n      return false;\n    }\n\n    if (this.execSubagentHardRestartAttempts.has(requestId)) {\n      return false;\n    }\n\n    // Guard for test mocks that may not implement getWorkspaceMetadata.\n    if (typeof this.aiService.getWorkspaceMetadata !== \"function\") {\n      return false;\n    }\n\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\n    if (!metadataResult.success) {\n      return false;\n    }\n\n    const metadata = metadataResult.data;\n    if (!metadata.parentWorkspaceId) {\n      return false;\n    }\n\n    const agentIdRaw = (metadata.agentId ?? metadata.agentType ?? WORKSPACE_DEFAULTS.agentId)\n      .trim()\n      .toLowerCase();\n    const parsedAgentId = AgentIdSchema.safeParse(agentIdRaw);\n    const agentId = parsedAgentId.success ? parsedAgentId.data : (\"exec\" as const);\n\n    // Prefer resolving agent inheritance from the parent workspace: project agents may be untracked\n    // (and therefore absent from child worktrees), but they are always present in the parent that\n    // spawned the task.\n    const metadataCandidates: Array<typeof metadata> = [metadata];\n\n    try {\n      const parentMetadataResult = await this.aiService.getWorkspaceMetadata(\n        metadata.parentWorkspaceId\n      );\n      if (parentMetadataResult.success) {\n        metadataCandidates.unshift(parentMetadataResult.data);\n      }\n    } catch {\n      // ignore - fall back to child metadata\n    }\n\n    let chain: Awaited<ReturnType<typeof resolveAgentInheritanceChain>> | undefined;\n    for (const agentMetadata of metadataCandidates) {\n      try {\n        const runtime = createRuntimeForWorkspace(agentMetadata);\n\n        // In-place workspaces (CLI/benchmarks) have projectPath === name.\n        // Use path directly instead of reconstructing via getWorkspacePath.\n        const isInPlace = agentMetadata.projectPath === agentMetadata.name;\n        const workspacePath = isInPlace\n          ? agentMetadata.projectPath\n          : runtime.getWorkspacePath(agentMetadata.projectPath, agentMetadata.name);\n\n        const agentDiscoveryPath =\n          context.options?.disableWorkspaceAgents === true\n            ? agentMetadata.projectPath\n            : workspacePath;\n\n        const agentDefinition = await readAgentDefinition(runtime, agentDiscoveryPath, agentId);\n        chain = await resolveAgentInheritanceChain({\n          runtime,\n          workspacePath: agentDiscoveryPath,\n          agentId,\n          agentDefinition,\n          workspaceId: this.workspaceId,\n        });\n        break;\n      } catch {\n        // ignore - try next candidate\n      }\n    }\n\n    if (!chain) {\n      // If we fail to resolve tool policy/inheritance, treat as non-exec-like.\n      return false;\n    }\n\n    if (!isExecLikeEditingCapableInResolvedChain(chain)) {\n      return false;\n    }\n\n    this.execSubagentHardRestartAttempts.add(requestId);\n\n    const continuationNotice =\n      \"Context limit reached. Mux restarted this agent's chat history and will replay your original prompt below. \" +\n      \"Continue using only the current workspace state (files, git history, command output); \" +\n      \"re-inspect the repo as needed.\";\n\n    log.info(\"Exec-like subagent hit context limit; hard-restarting history and retrying\", {\n      workspaceId: this.workspaceId,\n      requestId,\n      model: context.modelString,\n      agentId,\n    });\n\n    // Only need the current compaction epoch  if compaction already happened, the\n    // original task prompt is summarized in the boundary and pre-boundary messages\n    // aren't useful for replaying.\n    const historyResult = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\n    if (!historyResult.success) {\n      return false;\n    }\n\n    const messages = historyResult.data;\n\n    const firstPromptIndex = messages.findIndex(\n      (msg) => msg.role === \"user\" && msg.metadata?.synthetic !== true\n    );\n    if (firstPromptIndex === -1) {\n      return false;\n    }\n\n    // Include any synthetic snapshots that were persisted immediately before the task prompt.\n    let seedStartIndex = firstPromptIndex;\n    for (let i = firstPromptIndex - 1; i >= 0; i -= 1) {\n      const msg = messages[i];\n      const isSnapshot =\n        msg.role === \"user\" &&\n        msg.metadata?.synthetic === true &&\n        (msg.metadata?.fileAtMentionSnapshot ?? msg.metadata?.agentSkillSnapshot);\n      if (!isSnapshot) {\n        break;\n      }\n      seedStartIndex = i;\n    }\n\n    const seedMessages = messages.slice(seedStartIndex, firstPromptIndex + 1);\n    if (seedMessages.length === 0) {\n      return false;\n    }\n\n    // Best-effort: discard pending post-compaction state so we don't immediately re-inject it.\n    try {\n      await this.compactionHandler.discardPendingDiffs(\"execSubagentHardRestart\");\n      this.onPostCompactionStateChange?.();\n    } catch (error) {\n      log.warn(\"Failed to discard pending post-compaction state before hard restart\", {\n        workspaceId: this.workspaceId,\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n\n    // Abort the failed assistant placeholder and clean up partial/history state.\n    this.activeCompactionRequest = undefined;\n    this.resetActiveStreamState();\n    if (!this.disposed) {\n      this.clearQueue();\n    }\n\n    this.emitChatEvent({\n      type: \"stream-abort\",\n      workspaceId: this.workspaceId,\n      messageId: data.messageId,\n    });\n\n    const partialDeleteResult = await this.partialService.deletePartial(this.workspaceId);\n    if (!partialDeleteResult.success) {\n      log.warn(\"Failed to delete partial before exec subagent hard restart\", {\n        workspaceId: this.workspaceId,\n        error: partialDeleteResult.error,\n      });\n    }\n\n    const clearResult = await this.historyService.clearHistory(this.workspaceId);\n    if (!clearResult.success) {\n      log.warn(\"Failed to clear history for exec subagent hard restart\", {\n        workspaceId: this.workspaceId,\n        error: clearResult.error,\n      });\n      return false;\n    }\n\n    const deletedSequences = clearResult.data;\n    if (deletedSequences.length > 0) {\n      const deleteMessage: DeleteMessage = {\n        type: \"delete\",\n        historySequences: deletedSequences,\n      };\n      this.emitChatEvent(deleteMessage);\n    }\n\n    const cloneForAppend = (msg: MuxMessage): MuxMessage => {\n      const metadataCopy = msg.metadata ? { ...msg.metadata } : undefined;\n      if (metadataCopy) {\n        metadataCopy.historySequence = undefined;\n        metadataCopy.partial = undefined;\n        metadataCopy.error = undefined;\n        metadataCopy.errorType = undefined;\n      }\n\n      return {\n        ...msg,\n        metadata: metadataCopy,\n        parts: [...msg.parts],\n      };\n    };\n\n    const continuationMessage = createMuxMessage(\n      createUserMessageId(),\n      \"user\",\n      continuationNotice,\n      {\n        timestamp: Date.now(),\n        synthetic: true,\n        uiVisible: true,\n      }\n    );\n\n    const messagesToAppend = [continuationMessage, ...seedMessages.map(cloneForAppend)];\n    for (const message of messagesToAppend) {\n      const appendResult = await this.historyService.appendToHistory(this.workspaceId, message);\n      if (!appendResult.success) {\n        log.error(\"Failed to append message during exec subagent hard restart\", {\n          workspaceId: this.workspaceId,\n          messageId: message.id,\n          error: appendResult.error,\n        });\n        return false;\n      }\n\n      // Add type: \"message\" for discriminated union (MuxMessage doesn't have it)\n      this.emitChatEvent({\n        ...message,\n        type: \"message\" as const,\n      });\n    }\n\n    const existingInstructions = context.options?.additionalSystemInstructions;\n    const mergedAdditionalSystemInstructions = existingInstructions\n      ? `${continuationNotice}\\n\\n${existingInstructions}`\n      : continuationNotice;\n\n    const retryOptions: SendMessageOptions | undefined = context.options\n      ? {\n          ...context.options,\n          additionalSystemInstructions: mergedAdditionalSystemInstructions,\n        }\n      : {\n          model: context.modelString,\n          agentId: WORKSPACE_DEFAULTS.agentId,\n          additionalSystemInstructions: mergedAdditionalSystemInstructions,\n          experiments: {\n            execSubagentHardRestart: true,\n          },\n        };\n\n    this.streamStarting = true;\n    let retryResult: Result<void, SendMessageError>;\n    try {\n      retryResult = await this.streamWithHistory(\n        context.modelString,\n        retryOptions,\n        context.openaiTruncationModeOverride\n      );\n    } finally {\n      this.streamStarting = false;\n    }\n\n    if (!retryResult.success) {\n      log.error(\"Exec subagent hard restart retry failed to start\", {\n        workspaceId: this.workspaceId,\n        error: retryResult.error,\n      });\n      return false;\n    }\n\n    return true;\n  }\n\n  private resetActiveStreamState(): void {\n    this.activeStreamContext = undefined;\n    this.activeStreamUserMessageId = undefined;\n    this.activeStreamHadPostCompactionInjection = false;\n    this.activeStreamHadAnyDelta = false;\n    this.ackPendingPostCompactionStateOnStreamEnd = false;\n  }\n\n  private async handleStreamError(data: StreamErrorPayload): Promise<void> {\n    const hadCompactionRequest = this.activeCompactionRequest !== undefined;\n    if (\n      await this.maybeRetryCompactionOnContextExceeded({\n        messageId: data.messageId,\n        errorType: data.errorType,\n      })\n    ) {\n      return;\n    }\n\n    if (\n      await this.maybeRetryWithoutPostCompactionOnContextExceeded({\n        messageId: data.messageId,\n        errorType: data.errorType,\n      })\n    ) {\n      return;\n    }\n\n    if (\n      await this.maybeHardRestartExecSubagentOnContextExceeded({\n        messageId: data.messageId,\n        errorType: data.errorType,\n      })\n    ) {\n      return;\n    }\n\n    this.activeCompactionRequest = undefined;\n    this.resetActiveStreamState();\n\n    if (hadCompactionRequest && !this.disposed) {\n      this.clearQueue();\n    }\n\n    this.emitChatEvent(createStreamErrorMessage(data));\n  }\n\n  private attachAiListeners(): void {\n    const forward = (\n      event: string,\n      handler: (payload: WorkspaceChatMessage) => Promise<void> | void\n    ) => {\n      const wrapped = (...args: unknown[]) => {\n        const [payload] = args;\n        if (\n          typeof payload === \"object\" &&\n          payload !== null &&\n          \"workspaceId\" in payload &&\n          (payload as { workspaceId: unknown }).workspaceId !== this.workspaceId\n        ) {\n          return;\n        }\n        void handler(payload as WorkspaceChatMessage);\n      };\n      this.aiListeners.push({ event, handler: wrapped });\n      this.aiService.on(event, wrapped as never);\n    };\n\n    forward(\"stream-start\", (payload) => this.emitChatEvent(payload));\n    forward(\"stream-delta\", (payload) => {\n      this.activeStreamHadAnyDelta = true;\n      this.emitChatEvent(payload);\n    });\n    forward(\"tool-call-start\", (payload) => {\n      this.activeStreamHadAnyDelta = true;\n      this.emitChatEvent(payload);\n    });\n    forward(\"bash-output\", (payload) => {\n      this.activeStreamHadAnyDelta = true;\n      this.emitChatEvent(payload);\n    });\n    forward(\"tool-call-delta\", (payload) => {\n      this.activeStreamHadAnyDelta = true;\n      this.emitChatEvent(payload);\n    });\n    forward(\"tool-call-end\", (payload) => {\n      this.activeStreamHadAnyDelta = true;\n      this.emitChatEvent(payload);\n\n      // Post-compaction context state depends on plan writes + tracked file diffs.\n      // Trigger a metadata refresh so the right sidebar updates immediately.\n      if (\n        payload.type === \"tool-call-end\" &&\n        (payload.toolName === \"propose_plan\" || payload.toolName.startsWith(\"file_edit_\"))\n      ) {\n        this.onPostCompactionStateChange?.();\n      }\n    });\n    forward(\"reasoning-delta\", (payload) => {\n      this.activeStreamHadAnyDelta = true;\n      this.emitChatEvent(payload);\n    });\n    forward(\"reasoning-end\", (payload) => this.emitChatEvent(payload));\n    forward(\"usage-delta\", (payload) => this.emitChatEvent(payload));\n    forward(\"stream-abort\", (payload) => {\n      const hadCompactionRequest = this.activeCompactionRequest !== undefined;\n      this.activeCompactionRequest = undefined;\n      this.resetActiveStreamState();\n      if (hadCompactionRequest && !this.disposed) {\n        this.clearQueue();\n      }\n      this.emitChatEvent(payload);\n    });\n    forward(\"runtime-status\", (payload) => this.emitChatEvent(payload));\n\n    forward(\"stream-end\", async (payload) => {\n      this.activeCompactionRequest = undefined;\n      const handled = await this.compactionHandler.handleCompletion(payload as StreamEndEvent);\n\n      if (!handled) {\n        this.emitChatEvent(payload);\n\n        if (this.ackPendingPostCompactionStateOnStreamEnd) {\n          this.ackPendingPostCompactionStateOnStreamEnd = false;\n          try {\n            await this.compactionHandler.ackPendingDiffsConsumed();\n          } catch (error) {\n            log.warn(\"Failed to ack pending post-compaction state\", {\n              workspaceId: this.workspaceId,\n              error: error instanceof Error ? error.message : String(error),\n            });\n          }\n          this.onPostCompactionStateChange?.();\n        }\n      } else {\n        // Compaction completed - notify to trigger metadata refresh\n        // This allows the frontend to get updated postCompaction state\n        this.onCompactionComplete?.();\n\n        // Dispatch any pending follow-up from the compaction summary.\n        // The follow-up is stored on the summary for crash safety - if the app\n        // crashes after compaction but before this dispatch, startup recovery\n        // will detect the pending follow-up and dispatch it.\n        //\n        // IMPORTANT: await to ensure the follow-up message is persisted before\n        // sendQueuedMessages runs. Otherwise a queued message could append first,\n        // causing dispatchPendingFollowUp to skip (since summary would no longer\n        // be the last message).\n        await this.dispatchPendingFollowUp();\n      }\n\n      this.resetActiveStreamState();\n\n      // Stream end: auto-send queued messages (for user messages typed during streaming)\n      this.sendQueuedMessages();\n    });\n\n    const errorHandler = (...args: unknown[]) => {\n      const [raw] = args;\n      if (\n        typeof raw !== \"object\" ||\n        raw === null ||\n        !(\"workspaceId\" in raw) ||\n        (raw as { workspaceId: unknown }).workspaceId !== this.workspaceId\n      ) {\n        return;\n      }\n      const data = raw as StreamErrorPayload & { workspaceId: string };\n      void this.handleStreamError({\n        messageId: data.messageId,\n        error: data.error,\n        errorType: data.errorType,\n      });\n    };\n\n    this.aiListeners.push({ event: \"error\", handler: errorHandler });\n    this.aiService.on(\"error\", errorHandler as never);\n  }\n\n  private attachInitListeners(): void {\n    const forward = (event: string, handler: (payload: WorkspaceChatMessage) => void) => {\n      const wrapped = (...args: unknown[]) => {\n        const [payload] = args;\n        if (\n          typeof payload === \"object\" &&\n          payload !== null &&\n          \"workspaceId\" in payload &&\n          (payload as { workspaceId: unknown }).workspaceId !== this.workspaceId\n        ) {\n          return;\n        }\n        // Strip workspaceId from payload before forwarding (WorkspaceInitEvent doesn't include it)\n        const { workspaceId: _, ...message } = payload as WorkspaceChatMessage & {\n          workspaceId: string;\n        };\n        handler(message as WorkspaceChatMessage);\n      };\n      this.initListeners.push({ event, handler: wrapped });\n      this.initStateManager.on(event, wrapped as never);\n    };\n\n    forward(\"init-start\", (payload) => this.emitChatEvent(payload));\n    forward(\"init-output\", (payload) => this.emitChatEvent(payload));\n    forward(\"init-end\", (payload) => this.emitChatEvent(payload));\n  }\n\n  // Public method to emit chat events (used by init hooks and other workspace events)\n  emitChatEvent(message: WorkspaceChatMessage): void {\n    // NOTE: Workspace teardown does not await in-flight async work (sendMessage(), stopStream(), etc).\n    // Those code paths can still try to emit events after dispose; drop them rather than crashing.\n    if (this.disposed) {\n      return;\n    }\n\n    this.emitter.emit(\"chat-event\", {\n      workspaceId: this.workspaceId,\n      message,\n    } satisfies AgentSessionChatEvent);\n  }\n\n  isStreamStarting(): boolean {\n    return this.streamStarting;\n  }\n\n  queueMessage(message: string, options?: SendMessageOptions & { fileParts?: FilePart[] }): void {\n    this.assertNotDisposed(\"queueMessage\");\n    this.messageQueue.add(message, options);\n    this.emitQueuedMessageChanged();\n    // Signal to bash_output that it should return early to process the queued message\n    this.backgroundProcessManager.setMessageQueued(this.workspaceId, true);\n  }\n\n  clearQueue(): void {\n    this.assertNotDisposed(\"clearQueue\");\n    this.messageQueue.clear();\n    this.emitQueuedMessageChanged();\n    this.backgroundProcessManager.setMessageQueued(this.workspaceId, false);\n  }\n\n  /**\n   * Restore queued messages to input box.\n   * Called by IPC handler on user-initiated interrupt.\n   */\n  restoreQueueToInput(): void {\n    this.assertNotDisposed(\"restoreQueueToInput\");\n    if (!this.messageQueue.isEmpty()) {\n      const displayText = this.messageQueue.getDisplayText();\n      const fileParts = this.messageQueue.getFileParts();\n      const reviews = this.messageQueue.getReviews();\n      this.messageQueue.clear();\n      this.emitQueuedMessageChanged();\n\n      this.emitChatEvent({\n        type: \"restore-to-input\",\n        workspaceId: this.workspaceId,\n        text: displayText,\n        fileParts: fileParts,\n        reviews: reviews,\n      });\n    }\n  }\n\n  private emitQueuedMessageChanged(): void {\n    this.emitChatEvent({\n      type: \"queued-message-changed\",\n      workspaceId: this.workspaceId,\n      queuedMessages: this.messageQueue.getMessages(),\n      displayText: this.messageQueue.getDisplayText(),\n      fileParts: this.messageQueue.getFileParts(),\n      reviews: this.messageQueue.getReviews(),\n      hasCompactionRequest: this.messageQueue.hasCompactionRequest(),\n    });\n  }\n\n  /**\n   * Send queued messages if any exist.\n   * Called when tool execution completes, stream ends, or user clicks send immediately.\n   */\n  sendQueuedMessages(): void {\n    // sendQueuedMessages can race with teardown (e.g. workspace.remove) because we\n    // trigger it off stream/tool events and disposal does not await stopStream().\n    // If the session is already disposed, do nothing.\n    if (this.disposed) {\n      return;\n    }\n\n    // Clear the queued message flag (even if queue is empty, to handle race conditions)\n    this.backgroundProcessManager.setMessageQueued(this.workspaceId, false);\n\n    if (!this.messageQueue.isEmpty()) {\n      const { message, options } = this.messageQueue.produceMessage();\n      this.messageQueue.clear();\n      this.emitQueuedMessageChanged();\n\n      void this.sendMessage(message, options);\n    }\n  }\n\n  /**\n   * Dispatch the pending follow-up from a compaction summary message.\n   * Called after compaction completes - the follow-up is stored on the summary\n   * for crash safety. The user message persisted by sendMessage() serves as\n   * proof of dispatch (no history rewrite needed).\n   */\n  private async dispatchPendingFollowUp(): Promise<void> {\n    if (this.disposed) {\n      return;\n    }\n\n    // Read the last message from history  only need 1 message, avoid full-file read\n    const historyResult = await this.historyService.getLastMessages(this.workspaceId, 1);\n    if (!historyResult.success || historyResult.data.length === 0) {\n      return;\n    }\n\n    const lastMessage = historyResult.data[0];\n    const muxMeta = lastMessage.metadata?.muxMetadata;\n\n    // Check if it's a compaction summary with a pending follow-up\n    if (!isCompactionSummaryMetadata(muxMeta) || !muxMeta.pendingFollowUp) {\n      return;\n    }\n\n    // Handle legacy formats: older persisted requests may have `mode` instead of `agentId`,\n    // and `imageParts` instead of `fileParts`.\n    const followUp = muxMeta.pendingFollowUp as typeof muxMeta.pendingFollowUp & {\n      mode?: \"exec\" | \"plan\";\n      imageParts?: FilePart[];\n    };\n\n    // Derive agentId: new field has it directly, legacy may use `mode` field.\n    // Legacy `mode` was \"exec\" | \"plan\" and maps directly to agentId.\n    const effectiveAgentId = followUp.agentId ?? followUp.mode ?? \"exec\";\n\n    // Normalize attachments: newer metadata uses `fileParts`, older persisted entries used `imageParts`.\n    const effectiveFileParts = followUp.fileParts ?? followUp.imageParts;\n\n    // Model fallback for legacy follow-ups that may lack the model field.\n    // DEFAULT_MODEL is a safe fallback that's always available.\n    const effectiveModel = followUp.model ?? DEFAULT_MODEL;\n\n    log.debug(\"Dispatching pending follow-up from compaction summary\", {\n      workspaceId: this.workspaceId,\n      hasText: Boolean(followUp.text),\n      hasFileParts: Boolean(effectiveFileParts?.length),\n      hasReviews: Boolean(followUp.reviews?.length),\n      model: effectiveModel,\n      agentId: effectiveAgentId,\n    });\n\n    // Process the follow-up content (handles reviews -> text formatting + metadata)\n    const { finalText, metadata } = prepareUserMessageForSend(\n      {\n        text: followUp.text,\n        fileParts: effectiveFileParts,\n        reviews: followUp.reviews,\n      },\n      followUp.muxMetadata\n    );\n\n    // Build options for the follow-up message.\n    // Spread the followUp to include preserved send options (thinkingLevel, providerOptions, etc.)\n    // that were captured from the original user message in prepareCompactionMessage().\n    const options: SendMessageOptions & {\n      fileParts?: FilePart[];\n      muxMetadata?: MuxFrontendMetadata;\n    } = {\n      ...followUp,\n      model: effectiveModel,\n      agentId: effectiveAgentId,\n    };\n\n    if (effectiveFileParts && effectiveFileParts.length > 0) {\n      options.fileParts = effectiveFileParts;\n    }\n\n    if (metadata) {\n      options.muxMetadata = metadata;\n    }\n\n    // Await sendMessage to ensure the follow-up is persisted before returning.\n    // This guarantees ordering: the follow-up message is written to history\n    // before sendQueuedMessages() runs, preventing race conditions.\n    await this.sendMessage(finalText, options);\n  }\n\n  /**\n   * Record file state for change detection.\n   * Called by tools (e.g., propose_plan) after reading/writing files.\n   */\n  recordFileState(filePath: string, state: FileState): void {\n    this.fileChangeTracker.record(filePath, state);\n  }\n\n  /** Get the count of tracked files for UI display. */\n  getTrackedFilesCount(): number {\n    return this.fileChangeTracker.count;\n  }\n\n  /** Get the paths of tracked files for UI display. */\n  getTrackedFilePaths(): string[] {\n    return this.fileChangeTracker.paths;\n  }\n\n  /** Clear all tracked file state (e.g., on /clear). */\n  clearFileState(): void {\n    this.fileChangeTracker.clear();\n  }\n\n  /**\n   * Get post-compaction attachments if they should be injected this turn.\n   *\n   * Logic:\n   * - On first turn after compaction: inject immediately, clear file state cache\n   * - Subsequent turns: inject every TURNS_BETWEEN_ATTACHMENTS turns\n   *\n   * @returns Attachments to inject, or null if none needed\n   */\n  private async getPostCompactionAttachmentsIfNeeded(): Promise<PostCompactionAttachment[] | null> {\n    // Check if compaction just occurred (immediate injection with cached diffs)\n    const pendingDiffs = await this.compactionHandler.peekPendingDiffs();\n    if (pendingDiffs !== null) {\n      this.ackPendingPostCompactionStateOnStreamEnd = true;\n      this.compactionOccurred = true;\n      this.turnsSinceLastAttachment = 0;\n      // Clear file state cache since history context is gone\n      this.fileChangeTracker.clear();\n\n      // Load exclusions and persistent TODO state (local workspace session data)\n      const excludedItems = await this.loadExcludedItems();\n      const todoAttachment = await this.loadTodoListAttachment(excludedItems);\n\n      // Get runtime for reading plan file\n      const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\n      if (!metadataResult.success) {\n        // Can't get metadata, skip plan reference but still include other attachments\n        const attachments: PostCompactionAttachment[] = [];\n\n        if (todoAttachment) {\n          attachments.push(todoAttachment);\n        }\n\n        const editedFilesRef = AttachmentService.generateEditedFilesAttachment(pendingDiffs);\n        if (editedFilesRef) {\n          attachments.push(editedFilesRef);\n        }\n\n        return attachments;\n      }\n      const runtime = createRuntimeForWorkspace(metadataResult.data);\n\n      const attachments = await AttachmentService.generatePostCompactionAttachments(\n        metadataResult.data.name,\n        metadataResult.data.projectName,\n        this.workspaceId,\n        pendingDiffs,\n        runtime,\n        excludedItems\n      );\n\n      if (todoAttachment) {\n        // Insert TODO after plan (if present), otherwise first.\n        const planIndex = attachments.findIndex((att) => att.type === \"plan_file_reference\");\n        const insertIndex = planIndex === -1 ? 0 : planIndex + 1;\n        attachments.splice(insertIndex, 0, todoAttachment);\n      }\n\n      return attachments;\n    }\n\n    // Increment turn counter\n    this.turnsSinceLastAttachment++;\n\n    // Check cooldown for subsequent injections (re-read from current history)\n    if (this.compactionOccurred && this.turnsSinceLastAttachment >= TURNS_BETWEEN_ATTACHMENTS) {\n      this.turnsSinceLastAttachment = 0;\n      return this.generatePostCompactionAttachments();\n    }\n\n    return null;\n  }\n\n  /**\n   * Generate post-compaction attachments by extracting diffs from message history.\n   */\n  private async generatePostCompactionAttachments(): Promise<PostCompactionAttachment[]> {\n    // getHistoryFromLatestBoundary already returns only the active compaction epoch,\n    // so no further boundary slicing is needed.\n    const historyResult = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\n    if (!historyResult.success) {\n      return [];\n    }\n\n    const fileDiffs = extractEditedFileDiffs(historyResult.data);\n\n    // Load exclusions and persistent TODO state (local workspace session data)\n    const excludedItems = await this.loadExcludedItems();\n    const todoAttachment = await this.loadTodoListAttachment(excludedItems);\n\n    // Get runtime for reading plan file\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\n    if (!metadataResult.success) {\n      // Can't get metadata, skip plan reference but still include other attachments\n      const attachments: PostCompactionAttachment[] = [];\n\n      if (todoAttachment) {\n        attachments.push(todoAttachment);\n      }\n\n      const editedFilesRef = AttachmentService.generateEditedFilesAttachment(fileDiffs);\n      if (editedFilesRef) {\n        attachments.push(editedFilesRef);\n      }\n\n      return attachments;\n    }\n    const runtime = createRuntimeForWorkspace(metadataResult.data);\n\n    const attachments = await AttachmentService.generatePostCompactionAttachments(\n      metadataResult.data.name,\n      metadataResult.data.projectName,\n      this.workspaceId,\n      fileDiffs,\n      runtime,\n      excludedItems\n    );\n\n    if (todoAttachment) {\n      // Insert TODO after plan (if present), otherwise first.\n      const planIndex = attachments.findIndex((att) => att.type === \"plan_file_reference\");\n      const insertIndex = planIndex === -1 ? 0 : planIndex + 1;\n      attachments.splice(insertIndex, 0, todoAttachment);\n    }\n\n    return attachments;\n  }\n\n  /**\n   * Materialize @file mentions from a user message into a persisted snapshot message.\n   *\n   * This reads the referenced files once and creates a synthetic message containing\n   * their content. The snapshot is persisted to history so subsequent sends don't\n   * re-read the files (which would bust prompt cache if files changed).\n   *\n   * Also registers file state for change detection via <system-file-update> diffs.\n   *\n   * @returns The snapshot message and list of materialized mentions, or null if no mentions found\n   */\n  private async materializeFileAtMentionsSnapshot(\n    messageText: string\n  ): Promise<{ snapshotMessage: MuxMessage; materializedTokens: string[] } | null> {\n    // Guard for test mocks that may not implement getWorkspaceMetadata\n    if (typeof this.aiService.getWorkspaceMetadata !== \"function\") {\n      return null;\n    }\n\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\n    if (!metadataResult.success) {\n      log.debug(\"Cannot materialize @file mentions: workspace metadata not found\", {\n        workspaceId: this.workspaceId,\n      });\n      return null;\n    }\n\n    const metadata = metadataResult.data;\n    const runtime = createRuntimeForWorkspace(metadata);\n    const workspacePath = runtime.getWorkspacePath(metadata.projectPath, metadata.name);\n\n    const materialized = await materializeFileAtMentions(messageText, {\n      runtime,\n      workspacePath,\n    });\n\n    if (materialized.length === 0) {\n      return null;\n    }\n\n    // Register file state for each successfully read file (for change detection)\n    for (const mention of materialized) {\n      if (\n        mention.content !== undefined &&\n        mention.modifiedTimeMs !== undefined &&\n        mention.resolvedPath\n      ) {\n        this.recordFileState(mention.resolvedPath, {\n          content: mention.content,\n          timestamp: mention.modifiedTimeMs,\n        });\n      }\n    }\n\n    // Create a synthetic snapshot message (not persisted here - caller handles persistence)\n    const tokens = materialized.map((m) => m.token);\n    const blocks = materialized.map((m) => m.block).join(\"\\n\\n\");\n\n    const snapshotId = createFileSnapshotMessageId();\n    const snapshotMessage = createMuxMessage(snapshotId, \"user\", blocks, {\n      timestamp: Date.now(),\n      synthetic: true,\n      fileAtMentionSnapshot: tokens,\n    });\n\n    return { snapshotMessage, materializedTokens: tokens };\n  }\n\n  private async materializeAgentSkillSnapshot(\n    muxMetadata: MuxFrontendMetadata | undefined,\n    disableWorkspaceAgents: boolean | undefined\n  ): Promise<{ snapshotMessage: MuxMessage } | null> {\n    if (!muxMetadata || muxMetadata.type !== \"agent-skill\") {\n      return null;\n    }\n\n    // Guard for test mocks that may not implement getWorkspaceMetadata.\n    if (typeof this.aiService.getWorkspaceMetadata !== \"function\") {\n      return null;\n    }\n\n    const parsedName = SkillNameSchema.safeParse(muxMetadata.skillName);\n    if (!parsedName.success) {\n      throw new Error(`Invalid agent skill name: ${muxMetadata.skillName}`);\n    }\n\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\n    if (!metadataResult.success) {\n      throw new Error(\"Cannot materialize agent skill: workspace metadata not found\");\n    }\n\n    const metadata = metadataResult.data;\n    const runtime = createRuntime(metadata.runtimeConfig, {\n      projectPath: metadata.projectPath,\n      workspaceName: metadata.name,\n    });\n\n    // In-place workspaces (CLI/benchmarks) have projectPath === name.\n    // Use the path directly instead of reconstructing via getWorkspacePath.\n    const isInPlace = metadata.projectPath === metadata.name;\n    const workspacePath = isInPlace\n      ? metadata.projectPath\n      : runtime.getWorkspacePath(metadata.projectPath, metadata.name);\n\n    // When workspace agents are disabled, resolve skills from the project path instead of\n    // the worktree so skill invocation uses the same precedence/discovery root as the UI.\n    const skillDiscoveryPath = disableWorkspaceAgents ? metadata.projectPath : workspacePath;\n\n    const resolved = await readAgentSkill(runtime, skillDiscoveryPath, parsedName.data);\n    const skill = resolved.package;\n\n    const frontmatterYaml = YAML.stringify(skill.frontmatter).trimEnd();\n\n    const body =\n      skill.body.length > MAX_AGENT_SKILL_SNAPSHOT_CHARS\n        ? `${skill.body.slice(0, MAX_AGENT_SKILL_SNAPSHOT_CHARS)}\\n\\n[Skill body truncated to ${MAX_AGENT_SKILL_SNAPSHOT_CHARS} characters]`\n        : skill.body;\n\n    const snapshotText = `<agent-skill name=\"${skill.frontmatter.name}\" scope=\"${skill.scope}\">\\n${body}\\n</agent-skill>`;\n\n    // Include the parsed YAML frontmatter in the hash so frontmatter-only edits (e.g. description)\n    // generate a new snapshot and keep the UI hover preview in sync.\n    const sha256 = createHash(\"sha256\")\n      .update(JSON.stringify({ snapshotText, frontmatterYaml }))\n      .digest(\"hex\");\n\n    // Dedupe: if we recently persisted the same snapshot, avoid inserting again.\n    // Only need last 5 messages  avoid full-file read.\n    const historyResult = await this.historyService.getLastMessages(this.workspaceId, 5);\n    if (historyResult.success) {\n      const recentSnapshot = [...historyResult.data]\n        .reverse()\n        .find((msg) => msg.metadata?.synthetic && msg.metadata?.agentSkillSnapshot);\n      const recentMeta = recentSnapshot?.metadata?.agentSkillSnapshot;\n\n      if (recentMeta?.skillName === skill.frontmatter.name && recentMeta.sha256 === sha256) {\n        return null;\n      }\n    }\n\n    const snapshotId = createAgentSkillSnapshotMessageId();\n    const snapshotMessage = createMuxMessage(snapshotId, \"user\", snapshotText, {\n      timestamp: Date.now(),\n      synthetic: true,\n      agentSkillSnapshot: {\n        skillName: skill.frontmatter.name,\n        scope: skill.scope,\n        sha256,\n        frontmatterYaml,\n      },\n    });\n\n    return { snapshotMessage };\n  }\n\n  /**\n   * Load excluded items from the exclusions file.\n   * Returns empty set if file doesn't exist or can't be read.\n   */\n  private async loadExcludedItems(): Promise<Set<string>> {\n    const exclusionsPath = path.join(\n      this.config.getSessionDir(this.workspaceId),\n      \"exclusions.json\"\n    );\n    try {\n      const data = await readFile(exclusionsPath, \"utf-8\");\n      const exclusions = JSON.parse(data) as PostCompactionExclusions;\n      return new Set(exclusions.excludedItems);\n    } catch {\n      return new Set();\n    }\n  }\n\n  private coerceTodoItems(value: unknown): TodoItem[] {\n    if (!Array.isArray(value)) {\n      return [];\n    }\n\n    const result: TodoItem[] = [];\n    for (const item of value) {\n      if (!item || typeof item !== \"object\") continue;\n\n      const content = (item as { content?: unknown }).content;\n      const status = (item as { status?: unknown }).status;\n\n      if (typeof content !== \"string\") continue;\n      if (status !== \"pending\" && status !== \"in_progress\" && status !== \"completed\") continue;\n\n      result.push({ content, status });\n    }\n\n    return result;\n  }\n\n  private async loadTodoListAttachment(\n    excludedItems: Set<string>\n  ): Promise<PostCompactionAttachment | null> {\n    if (excludedItems.has(\"todo\")) {\n      return null;\n    }\n\n    const todoPath = path.join(this.config.getSessionDir(this.workspaceId), \"todos.json\");\n\n    try {\n      const data = await readFile(todoPath, \"utf-8\");\n      const parsed: unknown = JSON.parse(data);\n      const todos = this.coerceTodoItems(parsed);\n      if (todos.length === 0) {\n        return null;\n      }\n\n      return {\n        type: \"todo_list\",\n        todos,\n      };\n    } catch {\n      // File missing or unreadable\n      return null;\n    }\n  }\n\n  /** Delegate to FileChangeTracker for external file change detection. */\n  async getChangedFileAttachments(): Promise<EditedFileAttachment[]> {\n    return this.fileChangeTracker.getChangedAttachments();\n  }\n\n  /**\n   * Peek at cached file paths from pending compaction.\n   * Returns paths that will be reinjected, or null if no pending compaction.\n   */\n  getPendingTrackedFilePaths(): string[] | null {\n    return this.compactionHandler.peekCachedFilePaths();\n  }\n\n  private assertNotDisposed(operation: string): void {\n    assert(!this.disposed, `AgentSession.${operation} called after dispose`);\n  }\n}\n"]}