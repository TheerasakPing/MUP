{"version":3,"file":"agentSession.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"@/common/utils/assert\";\r\nimport { EventEmitter } from \"events\";\r\nimport * as path from \"path\";\r\nimport { createHash } from \"crypto\";\r\nimport { readFile } from \"fs/promises\";\r\nimport YAML from \"yaml\";\r\nimport { PlatformPaths } from \"@/common/utils/paths\";\r\nimport { log } from \"@/node/services/log\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { AIService } from \"@/node/services/aiService\";\r\nimport type { HistoryService } from \"@/node/services/historyService\";\r\nimport type { PartialService } from \"@/node/services/partialService\";\r\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport type { CostTrackingService } from \"@/node/services/costTrackingService\";\r\n\r\nimport type { FrontendWorkspaceMetadata } from \"@/common/types/workspace\";\r\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\r\nimport { DEFAULT_RUNTIME_CONFIG } from \"@/common/constants/workspace\";\r\nimport { DEFAULT_MODEL } from \"@/common/constants/knownModels\";\r\nimport type {\r\n  WorkspaceChatMessage,\r\n  SendMessageOptions,\r\n  FilePart,\r\n  DeleteMessage,\r\n} from \"@/common/orpc/types\";\r\nimport { WORKSPACE_DEFAULTS } from \"@/constants/workspaceDefaults\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport { AgentIdSchema, SkillNameSchema } from \"@/common/orpc/schemas\";\r\nimport {\r\n  buildStreamErrorEventData,\r\n  createStreamErrorMessage,\r\n  createUnknownSendMessageError,\r\n  type StreamErrorPayload,\r\n} from \"@/node/services/utils/sendMessageError\";\r\nimport {\r\n  createUserMessageId,\r\n  createFileSnapshotMessageId,\r\n  createAgentSkillSnapshotMessageId,\r\n} from \"@/node/services/utils/messageIds\";\r\nimport {\r\n  FileChangeTracker,\r\n  type FileState,\r\n  type EditedFileAttachment,\r\n} from \"@/node/services/utils/fileChangeTracker\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport { enforceThinkingPolicy } from \"@/common/utils/thinking/policy\";\r\nimport {\r\n  createMuxMessage,\r\n  isCompactionSummaryMetadata,\r\n  prepareUserMessageForSend,\r\n  type CompactionFollowUpRequest,\r\n  type MuxFrontendMetadata,\r\n  type MuxFilePart,\r\n  type MuxMessage,\r\n  type ReviewNoteDataForDisplay,\r\n} from \"@/common/types/message\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport { createRuntimeForWorkspace } from \"@/node/runtime/runtimeHelpers\";\r\nimport { isExecLikeEditingCapableInResolvedChain } from \"@/common/utils/agentTools\";\r\nimport { readAgentDefinition } from \"@/node/services/agentDefinitions/agentDefinitionsService\";\r\nimport { resolveAgentInheritanceChain } from \"@/node/services/agentDefinitions/resolveAgentInheritanceChain\";\r\nimport { MessageQueue } from \"./messageQueue\";\r\nimport type { StreamEndEvent } from \"@/common/types/stream\";\r\nimport { CompactionHandler } from \"./compactionHandler\";\r\nimport type { TelemetryService } from \"./telemetryService\";\r\nimport type { BackgroundProcessManager } from \"./backgroundProcessManager\";\r\n\r\nimport { AttachmentService } from \"./attachmentService\";\r\nimport type { TodoItem } from \"@/common/types/tools\";\r\nimport type { PostCompactionAttachment, PostCompactionExclusions } from \"@/common/types/attachment\";\r\nimport { TURNS_BETWEEN_ATTACHMENTS } from \"@/common/constants/attachments\";\r\n\r\nimport { extractEditedFileDiffs } from \"@/common/utils/messages/extractEditedFiles\";\r\nimport { getModelCapabilities } from \"@/common/utils/ai/modelCapabilities\";\r\nimport { normalizeGatewayModel, isValidModelFormat } from \"@/common/utils/ai/models\";\r\nimport { readAgentSkill } from \"@/node/services/agentSkills/agentSkillsService\";\r\nimport { materializeFileAtMentions } from \"@/node/services/fileAtMentions\";\r\n\r\n/**\r\n * Tracked file state for detecting external edits.\r\n * Uses timestamp-based polling with diff injection.\r\n */\r\n// Re-export types from FileChangeTracker for backward compatibility\r\nexport type { FileState, EditedFileAttachment } from \"@/node/services/utils/fileChangeTracker\";\r\n\r\n// Type guard for compaction request metadata\r\n// Supports both new `followUpContent` and legacy `continueMessage` for backwards compatibility\r\ninterface CompactionRequestMetadata {\r\n  type: \"compaction-request\";\r\n  parsed: {\r\n    followUpContent?: CompactionFollowUpRequest;\r\n    // Legacy field - older persisted requests may use this instead of followUpContent\r\n    continueMessage?: {\r\n      text?: string;\r\n      imageParts?: FilePart[];\r\n      reviews?: ReviewNoteDataForDisplay[];\r\n      muxMetadata?: MuxFrontendMetadata;\r\n      model?: string;\r\n      agentId?: string;\r\n      mode?: \"exec\" | \"plan\"; // Legacy: older versions stored mode instead of agentId\r\n    };\r\n  };\r\n}\r\n\r\nconst PDF_MEDIA_TYPE = \"application/pdf\";\r\n\r\nfunction normalizeMediaType(mediaType: string): string {\r\n  return mediaType.toLowerCase().trim().split(\";\")[0];\r\n}\r\n\r\nfunction estimateBase64DataUrlBytes(dataUrl: string): number | null {\r\n  if (!dataUrl.startsWith(\"data:\")) return null;\r\n\r\n  const commaIndex = dataUrl.indexOf(\",\");\r\n  if (commaIndex === -1) return null;\r\n\r\n  const header = dataUrl.slice(\"data:\".length, commaIndex);\r\n  if (!header.includes(\";base64\")) return null;\r\n\r\n  const base64 = dataUrl.slice(commaIndex + 1);\r\n  const padding = base64.endsWith(\"==\") ? 2 : base64.endsWith(\"=\") ? 1 : 0;\r\n  return Math.floor((base64.length * 3) / 4) - padding;\r\n}\r\nfunction isCompactionRequestMetadata(meta: unknown): meta is CompactionRequestMetadata {\r\n  if (typeof meta !== \"object\" || meta === null) return false;\r\n  const obj = meta as Record<string, unknown>;\r\n  if (obj.type !== \"compaction-request\") return false;\r\n  if (typeof obj.parsed !== \"object\" || obj.parsed === null) return false;\r\n  return true;\r\n}\r\n\r\nconst MAX_AGENT_SKILL_SNAPSHOT_CHARS = 50_000;\r\n\r\nexport interface AgentSessionChatEvent {\r\n  workspaceId: string;\r\n  message: WorkspaceChatMessage;\r\n}\r\n\r\nexport interface AgentSessionMetadataEvent {\r\n  workspaceId: string;\r\n  metadata: FrontendWorkspaceMetadata | null;\r\n}\r\n\r\ninterface AgentSessionOptions {\r\n  workspaceId: string;\r\n  config: Config;\r\n  historyService: HistoryService;\r\n  partialService: PartialService;\r\n  aiService: AIService;\r\n  initStateManager: InitStateManager;\r\n  costTrackingService: CostTrackingService;\r\n  telemetryService?: TelemetryService;\r\n  backgroundProcessManager: BackgroundProcessManager;\r\n  /** When true, skip terminating background processes on dispose/compaction (for bench/CI) */\r\n  keepBackgroundProcesses?: boolean;\r\n  /** Called when compaction completes (e.g., to clear idle compaction pending state) */\r\n  onCompactionComplete?: () => void;\r\n  /** Called when post-compaction context state may have changed (plan/file edits) */\r\n  onPostCompactionStateChange?: () => void;\r\n}\r\n\r\nexport class AgentSession {\r\n  private readonly workspaceId: string;\r\n  private readonly config: Config;\r\n  private readonly historyService: HistoryService;\r\n  private readonly partialService: PartialService;\r\n  private readonly aiService: AIService;\r\n  private readonly initStateManager: InitStateManager;\r\n  // @ts-expect-error TS6133  wired for future use, not consumed by methods yet\r\n  private readonly costTrackingService: CostTrackingService;\r\n  private readonly backgroundProcessManager: BackgroundProcessManager;\r\n  private readonly keepBackgroundProcesses: boolean;\r\n  private readonly onCompactionComplete?: () => void;\r\n  private readonly onPostCompactionStateChange?: () => void;\r\n  private readonly emitter = new EventEmitter();\r\n  private readonly aiListeners: Array<{ event: string; handler: (...args: unknown[]) => void }> =\r\n    [];\r\n  private readonly initListeners: Array<{ event: string; handler: (...args: unknown[]) => void }> =\r\n    [];\r\n  private disposed = false;\r\n  private streamStarting = false;\r\n  private readonly messageQueue = new MessageQueue();\r\n  private readonly compactionHandler: CompactionHandler;\r\n\r\n  /** Tracks file state for detecting external edits. */\r\n  private readonly fileChangeTracker = new FileChangeTracker();\r\n\r\n  /**\r\n   * Track turns since last post-compaction attachment injection.\r\n   * Start at max to trigger immediate injection on first turn after compaction.\r\n   */\r\n  private turnsSinceLastAttachment = TURNS_BETWEEN_ATTACHMENTS;\r\n\r\n  /**\r\n   * Flag indicating compaction has occurred in this session.\r\n   * Used to enable the cooldown-based attachment injection.\r\n   */\r\n  private compactionOccurred = false;\r\n\r\n  /**\r\n   * When true, clear any persisted post-compaction state after the next successful non-compaction stream.\r\n   *\r\n   * This is intentionally delayed until stream-end so a crash mid-stream doesn't lose the diffs.\r\n   */\r\n  private ackPendingPostCompactionStateOnStreamEnd = false;\r\n  /**\r\n   * Cache the last-known experiment state so we don't spam metadata refresh\r\n   * when post-compaction context is disabled.\r\n   */\r\n  /** Track compaction requests that already retried with truncation. */\r\n  private readonly compactionRetryAttempts = new Set<string>();\r\n  /**\r\n   * Active compaction request metadata for retry decisions (cleared on stream end/abort).\r\n   */\r\n\r\n  /** Tracks the user message id that initiated the currently active stream (for retry guards). */\r\n  private activeStreamUserMessageId?: string;\r\n\r\n  /** Track user message ids that already retried without post-compaction injection. */\r\n  private readonly postCompactionRetryAttempts = new Set<string>();\r\n\r\n  /** Track user message ids that already hard-restarted for exec-like subagents. */\r\n  private readonly execSubagentHardRestartAttempts = new Set<string>();\r\n\r\n  /** True once we see any model/tool output for the current stream (retry guard). */\r\n  private activeStreamHadAnyDelta = false;\r\n\r\n  /** Tracks whether the current stream included post-compaction attachments. */\r\n  private activeStreamHadPostCompactionInjection = false;\r\n\r\n  /** Context needed to retry the current stream (cleared on stream end/abort/error). */\r\n  private activeStreamContext?: {\r\n    modelString: string;\r\n    options?: SendMessageOptions;\r\n    openaiTruncationModeOverride?: \"auto\" | \"disabled\";\r\n  };\r\n\r\n  private activeCompactionRequest?: {\r\n    id: string;\r\n    modelString: string;\r\n    options?: SendMessageOptions;\r\n  };\r\n\r\n  constructor(options: AgentSessionOptions) {\r\n    assert(options, \"AgentSession requires options\");\r\n    const {\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService,\r\n      telemetryService,\r\n      backgroundProcessManager,\r\n      keepBackgroundProcesses,\r\n      onCompactionComplete,\r\n      onPostCompactionStateChange,\r\n    } = options;\r\n\r\n    assert(typeof workspaceId === \"string\", \"workspaceId must be a string\");\r\n    const trimmedWorkspaceId = workspaceId.trim();\r\n    assert(trimmedWorkspaceId.length > 0, \"workspaceId must not be empty\");\r\n\r\n    this.workspaceId = trimmedWorkspaceId;\r\n    this.config = config;\r\n    this.historyService = historyService;\r\n    this.partialService = partialService;\r\n    this.aiService = aiService;\r\n    this.initStateManager = initStateManager;\r\n    this.costTrackingService = costTrackingService;\r\n    this.backgroundProcessManager = backgroundProcessManager;\r\n    this.keepBackgroundProcesses = keepBackgroundProcesses ?? false;\r\n    this.onCompactionComplete = onCompactionComplete;\r\n    this.onPostCompactionStateChange = onPostCompactionStateChange;\r\n\r\n    this.compactionHandler = new CompactionHandler({\r\n      workspaceId: this.workspaceId,\r\n      historyService: this.historyService,\r\n      partialService: this.partialService,\r\n      sessionDir: this.config.getSessionDir(this.workspaceId),\r\n      telemetryService,\r\n      emitter: this.emitter,\r\n      onCompactionComplete,\r\n    });\r\n\r\n    this.attachAiListeners();\r\n    this.attachInitListeners();\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.disposed) {\r\n      return;\r\n    }\r\n    this.disposed = true;\r\n\r\n    // Stop any active stream (fire and forget - disposal shouldn't block)\r\n    void this.aiService.stopStream(this.workspaceId, { abandonPartial: true });\r\n    // Terminate background processes for this workspace (skip when flagged for bench/CI)\r\n    if (!this.keepBackgroundProcesses) {\r\n      void this.backgroundProcessManager.cleanup(this.workspaceId);\r\n    }\r\n\r\n    for (const { event, handler } of this.aiListeners) {\r\n      this.aiService.off(event, handler as never);\r\n    }\r\n    this.aiListeners.length = 0;\r\n    for (const { event, handler } of this.initListeners) {\r\n      this.initStateManager.off(event, handler as never);\r\n    }\r\n    this.initListeners.length = 0;\r\n    this.emitter.removeAllListeners();\r\n  }\r\n\r\n  onChatEvent(listener: (event: AgentSessionChatEvent) => void): () => void {\r\n    assert(typeof listener === \"function\", \"listener must be a function\");\r\n    this.emitter.on(\"chat-event\", listener);\r\n    return () => {\r\n      this.emitter.off(\"chat-event\", listener);\r\n    };\r\n  }\r\n\r\n  onMetadataEvent(listener: (event: AgentSessionMetadataEvent) => void): () => void {\r\n    assert(typeof listener === \"function\", \"listener must be a function\");\r\n    this.emitter.on(\"metadata-event\", listener);\r\n    return () => {\r\n      this.emitter.off(\"metadata-event\", listener);\r\n    };\r\n  }\r\n\r\n  async subscribeChat(listener: (event: AgentSessionChatEvent) => void): Promise<() => void> {\r\n    this.assertNotDisposed(\"subscribeChat\");\r\n    assert(typeof listener === \"function\", \"listener must be a function\");\r\n\r\n    const unsubscribe = this.onChatEvent(listener);\r\n    await this.emitHistoricalEvents(listener);\r\n\r\n    // Crash recovery: check if the last message is a compaction summary with\r\n    // a pending follow-up that was never dispatched. If so, dispatch it now.\r\n    // This handles the case where the app crashed after compaction completed\r\n    // but before the follow-up was sent.\r\n    void this.dispatchPendingFollowUp();\r\n\r\n    return unsubscribe;\r\n  }\r\n\r\n  async replayHistory(listener: (event: AgentSessionChatEvent) => void): Promise<void> {\r\n    this.assertNotDisposed(\"replayHistory\");\r\n    assert(typeof listener === \"function\", \"listener must be a function\");\r\n    await this.emitHistoricalEvents(listener);\r\n  }\r\n\r\n  emitMetadata(metadata: FrontendWorkspaceMetadata | null): void {\r\n    this.assertNotDisposed(\"emitMetadata\");\r\n    this.emitter.emit(\"metadata-event\", {\r\n      workspaceId: this.workspaceId,\r\n      metadata,\r\n    } satisfies AgentSessionMetadataEvent);\r\n  }\r\n\r\n  private async emitHistoricalEvents(\r\n    listener: (event: AgentSessionChatEvent) => void\r\n  ): Promise<void> {\r\n    // try/catch/finally guarantees caught-up is always sent, even if replay fails.\r\n    // Without caught-up, the frontend stays in \"Loading workspace...\" forever.\r\n    try {\r\n      // Read partial BEFORE iterating history so we can skip the corresponding\r\n      // placeholder message (which has empty parts). The partial has the real content.\r\n      const streamInfo = this.aiService.getStreamInfo(this.workspaceId);\r\n      const partial = await this.partialService.readPartial(this.workspaceId);\r\n      const partialHistorySequence = partial?.metadata?.historySequence;\r\n\r\n      // Load chat history from the penultimate compaction boundary onward\r\n      // (skip=1) so the user sees the previous epoch plus the current epoch.\r\n      // This provides context for what was summarized in the latest compaction.\r\n      // TODO: support paginated history loading so users can view older epochs on demand.\r\n      const historyResult = await this.historyService.getHistoryFromLatestBoundary(\r\n        this.workspaceId,\r\n        1\r\n      );\r\n      if (historyResult.success) {\r\n        for (const message of historyResult.data) {\r\n          // Skip the placeholder message if we have a partial with the same historySequence.\r\n          // The placeholder has empty parts; the partial has the actual content.\r\n          // Without this, both get loaded and the empty placeholder may be shown as \"last message\".\r\n          if (\r\n            partialHistorySequence !== undefined &&\r\n            message.metadata?.historySequence === partialHistorySequence\r\n          ) {\r\n            continue;\r\n          }\r\n          // Add type: \"message\" for discriminated union (messages from chat.jsonl don't have it)\r\n          listener({ workspaceId: this.workspaceId, message: { ...message, type: \"message\" } });\r\n        }\r\n      }\r\n\r\n      if (streamInfo) {\r\n        await this.aiService.replayStream(this.workspaceId);\r\n      } else if (partial) {\r\n        // Add type: \"message\" for discriminated union (partials from disk don't have it)\r\n        listener({ workspaceId: this.workspaceId, message: { ...partial, type: \"message\" } });\r\n      }\r\n\r\n      // Replay init state BEFORE caught-up (treat as historical data)\r\n      // This ensures init events are buffered correctly by the frontend,\r\n      // preserving their natural timing characteristics from the hook execution.\r\n      await this.initStateManager.replayInit(this.workspaceId);\r\n    } catch (error) {\r\n      log.error(\"Failed to replay history for workspace\", {\r\n        workspaceId: this.workspaceId,\r\n        error,\r\n      });\r\n    } finally {\r\n      // Send caught-up after ALL historical data (including init events)\r\n      // This signals frontend that replay is complete and future events are real-time\r\n      listener({\r\n        workspaceId: this.workspaceId,\r\n        message: { type: \"caught-up\" },\r\n      });\r\n    }\r\n  }\r\n\r\n  async ensureMetadata(args: {\r\n    workspacePath: string;\r\n    projectName?: string;\r\n    runtimeConfig?: RuntimeConfig;\r\n  }): Promise<void> {\r\n    this.assertNotDisposed(\"ensureMetadata\");\r\n    assert(args, \"ensureMetadata requires arguments\");\r\n    const { workspacePath, projectName, runtimeConfig } = args;\r\n\r\n    assert(typeof workspacePath === \"string\", \"workspacePath must be a string\");\r\n    const trimmedWorkspacePath = workspacePath.trim();\r\n    assert(trimmedWorkspacePath.length > 0, \"workspacePath must not be empty\");\r\n\r\n    const normalizedWorkspacePath = path.resolve(trimmedWorkspacePath);\r\n    const existing = await this.aiService.getWorkspaceMetadata(this.workspaceId);\r\n\r\n    if (existing.success) {\r\n      // Metadata already exists, verify workspace path matches\r\n      const metadata = existing.data;\r\n      // For in-place workspaces (projectPath === name), use path directly\r\n      // Otherwise reconstruct using runtime's worktree pattern\r\n      const isInPlace = metadata.projectPath === metadata.name;\r\n      const expectedPath = isInPlace\r\n        ? metadata.projectPath\r\n        : (() => {\r\n          const runtime = createRuntime(metadata.runtimeConfig, {\r\n            projectPath: metadata.projectPath,\r\n            workspaceName: metadata.name,\r\n          });\r\n          return runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n        })();\r\n      assert(\r\n        expectedPath === normalizedWorkspacePath,\r\n        `Existing metadata workspace path mismatch for ${this.workspaceId}: expected ${expectedPath}, got ${normalizedWorkspacePath}`\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Detect in-place workspace: if workspacePath is not under srcBaseDir,\r\n    // it's a direct workspace (e.g., for CLI/benchmarks) rather than a worktree\r\n    const srcBaseDir = this.config.srcDir;\r\n    const normalizedSrcBaseDir = path.resolve(srcBaseDir);\r\n    const isUnderSrcBaseDir = normalizedWorkspacePath.startsWith(normalizedSrcBaseDir + path.sep);\r\n\r\n    let derivedProjectPath: string;\r\n    let workspaceName: string;\r\n    let derivedProjectName: string;\r\n\r\n    if (isUnderSrcBaseDir) {\r\n      // Standard worktree mode: workspace is under ~/.mux/src/project/branch\r\n      derivedProjectPath = path.dirname(normalizedWorkspacePath);\r\n      workspaceName = PlatformPaths.basename(normalizedWorkspacePath);\r\n      derivedProjectName =\r\n        projectName && projectName.trim().length > 0\r\n          ? projectName.trim()\r\n          : PlatformPaths.basename(derivedProjectPath) || \"unknown\";\r\n    } else {\r\n      // In-place mode: workspace is a standalone directory\r\n      // Store the workspace path directly by setting projectPath === name\r\n      derivedProjectPath = normalizedWorkspacePath;\r\n      workspaceName = normalizedWorkspacePath;\r\n      derivedProjectName =\r\n        projectName && projectName.trim().length > 0\r\n          ? projectName.trim()\r\n          : PlatformPaths.basename(normalizedWorkspacePath) || \"unknown\";\r\n    }\r\n\r\n    const metadata: FrontendWorkspaceMetadata = {\r\n      id: this.workspaceId,\r\n      name: workspaceName,\r\n      projectName: derivedProjectName,\r\n      projectPath: derivedProjectPath,\r\n      namedWorkspacePath: normalizedWorkspacePath,\r\n      runtimeConfig: runtimeConfig ?? DEFAULT_RUNTIME_CONFIG,\r\n    };\r\n\r\n    // Write metadata directly to config.json (single source of truth)\r\n    await this.config.addWorkspace(derivedProjectPath, metadata);\r\n    this.emitMetadata(metadata);\r\n  }\r\n\r\n  async sendMessage(\r\n    message: string,\r\n    options?: SendMessageOptions & { fileParts?: FilePart[] },\r\n    internal?: { synthetic?: boolean }\r\n  ): Promise<Result<void, SendMessageError>> {\r\n    this.assertNotDisposed(\"sendMessage\");\r\n\r\n    assert(typeof message === \"string\", \"sendMessage requires a string message\");\r\n    const trimmedMessage = message.trim();\r\n    const fileParts = options?.fileParts;\r\n    const editMessageId = options?.editMessageId;\r\n\r\n    // Edits are implemented as truncate+replace. If the frontend omits fileParts,\r\n    // preserve the original message's attachments.\r\n    // Only search the current compaction epoch  edits of pre-boundary messages are\r\n    // blocked (the frontend only shows post-boundary messages).\r\n    let preservedEditFileParts: MuxFilePart[] | undefined;\r\n    if (editMessageId && fileParts === undefined) {\r\n      const historyResult = await this.historyService.getHistoryFromLatestBoundary(\r\n        this.workspaceId\r\n      );\r\n      if (historyResult.success) {\r\n        const targetMessage: MuxMessage | undefined = historyResult.data.find(\r\n          (msg) => msg.id === editMessageId\r\n        );\r\n        const fileParts = targetMessage?.parts.filter(\r\n          (part): part is MuxFilePart => part.type === \"file\"\r\n        );\r\n        if (fileParts && fileParts.length > 0) {\r\n          preservedEditFileParts = fileParts;\r\n        }\r\n      }\r\n    }\r\n\r\n    const hasFiles = (fileParts?.length ?? 0) > 0 || (preservedEditFileParts?.length ?? 0) > 0;\r\n\r\n    if (trimmedMessage.length === 0 && !hasFiles) {\r\n      return Err(\r\n        createUnknownSendMessageError(\r\n          \"Empty message not allowed. Use interruptStream() to interrupt active streams.\"\r\n        )\r\n      );\r\n    }\r\n\r\n    if (editMessageId) {\r\n      // Interrupt an existing stream or compaction, if active\r\n      if (this.aiService.isStreaming(this.workspaceId)) {\r\n        // MUST use abandonPartial=true to prevent handleAbort from performing partial compaction\r\n        // with mismatched history (since we're about to truncate it)\r\n        const stopResult = await this.interruptStream({ abandonPartial: true });\r\n        if (!stopResult.success) {\r\n          return Err(createUnknownSendMessageError(stopResult.error));\r\n        }\r\n      }\r\n\r\n      // Find the truncation target: the edited message or any immediately-preceding snapshots.\r\n      // (snapshots are persisted immediately before their corresponding user message)\r\n      // Only search the current compaction epoch  truncating past a compaction boundary\r\n      // would destroy the summary. The frontend only shows post-boundary messages.\r\n      let truncateTargetId = editMessageId;\r\n      const historyResult = await this.historyService.getHistoryFromLatestBoundary(\r\n        this.workspaceId\r\n      );\r\n      if (historyResult.success) {\r\n        const messages = historyResult.data;\r\n        const editIndex = messages.findIndex((m) => m.id === editMessageId);\r\n        if (editIndex > 0) {\r\n          // Walk backwards over contiguous synthetic snapshots so we don't orphan them.\r\n          for (let i = editIndex - 1; i >= 0; i--) {\r\n            const msg = messages[i];\r\n            const isSnapshot =\r\n              msg.metadata?.synthetic &&\r\n              (msg.metadata?.fileAtMentionSnapshot ?? msg.metadata?.agentSkillSnapshot);\r\n            if (!isSnapshot) break;\r\n            truncateTargetId = msg.id;\r\n          }\r\n        }\r\n      }\r\n\r\n      const truncateResult = await this.historyService.truncateAfterMessage(\r\n        this.workspaceId,\r\n        truncateTargetId\r\n      );\r\n      if (!truncateResult.success) {\r\n        const isMissingEditTarget =\r\n          truncateResult.error.includes(\"Message with ID\") &&\r\n          truncateResult.error.includes(\"not found in history\");\r\n        if (isMissingEditTarget) {\r\n          // This can happen if the frontend is briefly out-of-sync with persisted history\r\n          // (e.g., compaction/truncation completed and removed the message while the UI still\r\n          // shows it as editable). Treat as a no-op truncation so the user can recover.\r\n          log.warn(\"editMessageId not found in history; proceeding without truncation\", {\r\n            workspaceId: this.workspaceId,\r\n            editMessageId,\r\n            error: truncateResult.error,\r\n          });\r\n        } else {\r\n          return Err(createUnknownSendMessageError(truncateResult.error));\r\n        }\r\n      }\r\n    }\r\n\r\n    const messageId = createUserMessageId();\r\n    const additionalParts =\r\n      preservedEditFileParts && preservedEditFileParts.length > 0\r\n        ? preservedEditFileParts\r\n        : fileParts && fileParts.length > 0\r\n          ? fileParts.map((part, index) => {\r\n            assert(\r\n              typeof part.url === \"string\",\r\n              `file part [${index}] must include url string content (got ${typeof part.url}): ${JSON.stringify(part).slice(0, 200)}`\r\n            );\r\n            assert(\r\n              part.url.startsWith(\"data:\"),\r\n              `file part [${index}] url must be a data URL (got: ${part.url.slice(0, 50)}...)`\r\n            );\r\n            assert(\r\n              typeof part.mediaType === \"string\" && part.mediaType.trim().length > 0,\r\n              `file part [${index}] must include a mediaType (got ${typeof part.mediaType}): ${JSON.stringify(part).slice(0, 200)}`\r\n            );\r\n            if (part.filename !== undefined) {\r\n              assert(\r\n                typeof part.filename === \"string\",\r\n                `file part [${index}] filename must be a string if present (got ${typeof part.filename}): ${JSON.stringify(part).slice(0, 200)}`\r\n              );\r\n            }\r\n            return {\r\n              type: \"file\" as const,\r\n              url: part.url,\r\n              mediaType: part.mediaType,\r\n              filename: part.filename,\r\n            };\r\n          })\r\n          : undefined;\r\n\r\n    // toolPolicy is properly typed via Zod schema inference\r\n    const typedToolPolicy = options?.toolPolicy;\r\n    // muxMetadata is z.any() in schema - cast to proper type\r\n    const typedMuxMetadata = options?.muxMetadata as MuxFrontendMetadata | undefined;\r\n    const isCompactionRequest = isCompactionRequestMetadata(typedMuxMetadata);\r\n\r\n    // Validate model BEFORE persisting message to prevent orphaned messages on invalid model\r\n    if (!options?.model || options.model.trim().length === 0) {\r\n      return Err(\r\n        createUnknownSendMessageError(\"No model specified. Please select a model using /model.\")\r\n      );\r\n    }\r\n\r\n    const rawModelString = options.model.trim();\r\n    const rawSystem1Model = options.system1Model?.trim();\r\n\r\n    options = this.normalizeGatewaySendOptions(options);\r\n\r\n    // Preserve explicit mux-gateway prefixes from legacy clients so backend routing can\r\n    // honor the opt-in even before muxGatewayModels has synchronized.\r\n    const modelForStream = rawModelString.startsWith(\"mux-gateway:\")\r\n      ? rawModelString\r\n      : options.model;\r\n    const optionsForStream = rawSystem1Model?.startsWith(\"mux-gateway:\")\r\n      ? { ...options, system1Model: rawSystem1Model }\r\n      : options;\r\n\r\n    // Defense-in-depth: reject PDFs for models we know don't support them.\r\n    // (Frontend should also block this, but it's easy to bypass via IPC / older clients.)\r\n    const effectiveFileParts =\r\n      preservedEditFileParts && preservedEditFileParts.length > 0\r\n        ? preservedEditFileParts.map((part) => ({\r\n          url: part.url,\r\n          mediaType: part.mediaType,\r\n          filename: part.filename,\r\n        }))\r\n        : fileParts;\r\n\r\n    if (effectiveFileParts && effectiveFileParts.length > 0) {\r\n      const pdfParts = effectiveFileParts.filter(\r\n        (part) => normalizeMediaType(part.mediaType) === PDF_MEDIA_TYPE\r\n      );\r\n\r\n      if (pdfParts.length > 0) {\r\n        const caps = getModelCapabilities(options.model);\r\n\r\n        if (caps && !caps.supportsPdfInput) {\r\n          return Err(\r\n            createUnknownSendMessageError(`Model ${options.model} does not support PDF input.`)\r\n          );\r\n        }\r\n\r\n        if (caps?.maxPdfSizeMb !== undefined) {\r\n          const maxBytes = caps.maxPdfSizeMb * 1024 * 1024;\r\n          for (const part of pdfParts) {\r\n            const bytes = estimateBase64DataUrlBytes(part.url);\r\n            if (bytes !== null && bytes > maxBytes) {\r\n              const actualMb = (bytes / (1024 * 1024)).toFixed(1);\r\n              const label = part.filename ?? \"PDF\";\r\n              return Err(\r\n                createUnknownSendMessageError(\r\n                  `${label} is ${actualMb}MB, but ${options.model} allows up to ${caps.maxPdfSizeMb}MB per PDF.`\r\n                )\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // Validate model string format (must be \"provider:model-id\")\r\n    if (!isValidModelFormat(options.model)) {\r\n      return Err({\r\n        type: \"invalid_model_string\",\r\n        message: `Invalid model string format: \"${options.model}\". Expected \"provider:model-id\"`,\r\n      });\r\n    }\r\n\r\n    const userMessage = createMuxMessage(\r\n      messageId,\r\n      \"user\",\r\n      message,\r\n      {\r\n        timestamp: Date.now(),\r\n        toolPolicy: typedToolPolicy,\r\n        muxMetadata: typedMuxMetadata, // Pass through frontend metadata as black-box\r\n        // Auto-resume and other system-generated messages are synthetic + UI-visible\r\n        ...(internal?.synthetic && { synthetic: true, uiVisible: true }),\r\n      },\r\n      additionalParts\r\n    );\r\n\r\n    // Materialize @file mentions from the user message into a snapshot.\r\n    // This ensures prompt-cache stability: we read files once and persist the content,\r\n    // so subsequent turns don't re-read (which would change the prompt prefix if files changed).\r\n    // File changes after this point are surfaced via <system-file-update> diffs instead.\r\n    const snapshotResult = await this.materializeFileAtMentionsSnapshot(trimmedMessage);\r\n    let skillSnapshotResult: { snapshotMessage: MuxMessage } | null = null;\r\n    try {\r\n      skillSnapshotResult = await this.materializeAgentSkillSnapshot(\r\n        typedMuxMetadata,\r\n        options?.disableWorkspaceAgents\r\n      );\r\n    } catch (error) {\r\n      return Err(\r\n        createUnknownSendMessageError(error instanceof Error ? error.message : String(error))\r\n      );\r\n    }\r\n\r\n    // Persist snapshots (if any) BEFORE the user message so they precede it in the prompt.\r\n    // Order matters: @file snapshot first, then agent-skill snapshot.\r\n    if (snapshotResult?.snapshotMessage) {\r\n      const snapshotAppendResult = await this.historyService.appendToHistory(\r\n        this.workspaceId,\r\n        snapshotResult.snapshotMessage\r\n      );\r\n      if (!snapshotAppendResult.success) {\r\n        return Err(createUnknownSendMessageError(snapshotAppendResult.error));\r\n      }\r\n    }\r\n\r\n    if (skillSnapshotResult?.snapshotMessage) {\r\n      const skillSnapshotAppendResult = await this.historyService.appendToHistory(\r\n        this.workspaceId,\r\n        skillSnapshotResult.snapshotMessage\r\n      );\r\n      if (!skillSnapshotAppendResult.success) {\r\n        return Err(createUnknownSendMessageError(skillSnapshotAppendResult.error));\r\n      }\r\n    }\r\n\r\n    const appendResult = await this.historyService.appendToHistory(this.workspaceId, userMessage);\r\n    if (!appendResult.success) {\r\n      // Note: If we get here with snapshots, one or more snapshots may already be persisted but user message\r\n      // failed. This is a rare edge case (disk full mid-operation). The next edit will clean up\r\n      // the orphan via the truncation logic that removes preceding snapshots.\r\n      return Err(createUnknownSendMessageError(appendResult.error));\r\n    }\r\n\r\n    // Workspace may be tearing down while we await filesystem IO.\r\n    // If so, skip event emission + streaming to avoid races with dispose().\r\n    if (this.disposed) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    // Emit snapshots first (if any), then user message - maintains prompt ordering in UI\r\n    if (snapshotResult?.snapshotMessage) {\r\n      this.emitChatEvent({ ...snapshotResult.snapshotMessage, type: \"message\" });\r\n    }\r\n\r\n    if (skillSnapshotResult?.snapshotMessage) {\r\n      this.emitChatEvent({ ...skillSnapshotResult.snapshotMessage, type: \"message\" });\r\n    }\r\n\r\n    // Add type: \"message\" for discriminated union (createMuxMessage doesn't add it)\r\n    this.emitChatEvent({ ...userMessage, type: \"message\" });\r\n\r\n    this.streamStarting = true;\r\n\r\n    try {\r\n      // If this is a compaction request, terminate background processes first\r\n      // They won't be included in the summary, so continuing with orphaned processes would be confusing\r\n      if (isCompactionRequest && !this.keepBackgroundProcesses) {\r\n        await this.backgroundProcessManager.cleanup(this.workspaceId);\r\n\r\n        if (this.disposed) {\r\n          return Ok(undefined);\r\n        }\r\n      }\r\n\r\n      // Note: Follow-up content for compaction is now stored on the summary message\r\n      // and dispatched via dispatchPendingFollowUp() after compaction completes.\r\n      // This provides crash safety - the follow-up survives app restarts.\r\n\r\n      if (this.disposed) {\r\n        return Ok(undefined);\r\n      }\r\n\r\n      // Must await here so the finally block runs after streaming completes,\r\n      // not immediately when the Promise is returned. This keeps streamStarting=true\r\n      // for the entire duration of streaming, allowing follow-up messages to be queued.\r\n      const result = await this.streamWithHistory(modelForStream, optionsForStream);\r\n      return result;\r\n    } finally {\r\n      this.streamStarting = false;\r\n    }\r\n  }\r\n\r\n  async resumeStream(options: SendMessageOptions): Promise<Result<void, SendMessageError>> {\r\n    this.assertNotDisposed(\"resumeStream\");\r\n\r\n    assert(options, \"resumeStream requires options\");\r\n    const { model } = options;\r\n    assert(typeof model === \"string\" && model.trim().length > 0, \"resumeStream requires a model\");\r\n\r\n    const rawModelString = options.model.trim();\r\n    const rawSystem1Model = options.system1Model?.trim();\r\n    const normalizedOptions = this.normalizeGatewaySendOptions(options);\r\n\r\n    // Preserve explicit mux-gateway prefixes from legacy clients so backend routing can\r\n    // honor the opt-in even before muxGatewayModels has synchronized.\r\n    const modelForStream = rawModelString.startsWith(\"mux-gateway:\")\r\n      ? rawModelString\r\n      : normalizedOptions.model;\r\n    const optionsForStream = rawSystem1Model?.startsWith(\"mux-gateway:\")\r\n      ? { ...normalizedOptions, system1Model: rawSystem1Model }\r\n      : normalizedOptions;\r\n\r\n    // Guard against auto-retry starting a second stream while the initial send is\r\n    // still waiting for init hooks to complete.\r\n    if (this.streamStarting || this.aiService.isStreaming(this.workspaceId)) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    this.streamStarting = true;\r\n    try {\r\n      // Must await here so the finally block runs after streaming completes,\r\n      // not immediately when the Promise is returned.\r\n      const result = await this.streamWithHistory(modelForStream, optionsForStream);\r\n      return result;\r\n    } finally {\r\n      this.streamStarting = false;\r\n    }\r\n  }\r\n\r\n  private normalizeGatewaySendOptions(options: SendMessageOptions): SendMessageOptions {\r\n    // Keep persisted model IDs canonical; gateway routing is now backend-authoritative (issue #1769).\r\n    const normalizedModel = normalizeGatewayModel(options.model.trim());\r\n    const system1Model = options.system1Model?.trim();\r\n    const normalizedSystem1Model =\r\n      system1Model && system1Model.length > 0 ? normalizeGatewayModel(system1Model) : undefined;\r\n\r\n    return {\r\n      ...options,\r\n      model: normalizedModel,\r\n      system1Model: normalizedSystem1Model,\r\n    };\r\n  }\r\n\r\n  async interruptStream(options?: {\r\n    soft?: boolean;\r\n    abandonPartial?: boolean;\r\n  }): Promise<Result<void>> {\r\n    this.assertNotDisposed(\"interruptStream\");\r\n\r\n    // For hard interrupts, delete partial BEFORE stopping to prevent abort handler\r\n    // from committing it. For soft interrupts, defer to stream-abort handler since\r\n    // the stream continues running and would recreate the partial.\r\n    if (options?.abandonPartial && !options?.soft) {\r\n      const deleteResult = await this.partialService.deletePartial(this.workspaceId);\r\n      if (!deleteResult.success) {\r\n        return Err(deleteResult.error);\r\n      }\r\n    }\r\n\r\n    const stopResult = await this.aiService.stopStream(this.workspaceId, {\r\n      ...options,\r\n      abortReason: \"user\",\r\n    });\r\n    if (!stopResult.success) {\r\n      return Err(stopResult.error);\r\n    }\r\n\r\n    return Ok(undefined);\r\n  }\r\n\r\n  private async streamWithHistory(\r\n    modelString: string,\r\n    options?: SendMessageOptions,\r\n    openaiTruncationModeOverride?: \"auto\" | \"disabled\",\r\n    disablePostCompactionAttachments?: boolean\r\n  ): Promise<Result<void, SendMessageError>> {\r\n    if (this.disposed) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    // Reset per-stream flags (used for retries / crash-safe bookkeeping).\r\n    this.ackPendingPostCompactionStateOnStreamEnd = false;\r\n    this.activeStreamHadAnyDelta = false;\r\n    this.activeStreamHadPostCompactionInjection = false;\r\n    this.activeStreamContext = {\r\n      modelString,\r\n      options,\r\n      openaiTruncationModeOverride,\r\n    };\r\n    this.activeStreamUserMessageId = undefined;\r\n\r\n    const commitResult = await this.partialService.commitToHistory(this.workspaceId);\r\n    if (!commitResult.success) {\r\n      return Err(createUnknownSendMessageError(commitResult.error));\r\n    }\r\n\r\n    let historyResult = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\r\n    if (!historyResult.success) {\r\n      return Err(createUnknownSendMessageError(historyResult.error));\r\n    }\r\n\r\n    if (historyResult.data.length === 0) {\r\n      return Err(\r\n        createUnknownSendMessageError(\r\n          \"Cannot resume stream: workspace history is empty. Send a new message instead.\"\r\n        )\r\n      );\r\n    }\r\n\r\n    // Structural invariant: API requests must not end with a non-partial assistant message.\r\n    // Partial assistants are handled by addInterruptedSentinel at transform time.\r\n    // Non-partial trailing assistants indicate a missing user message upstream  inject a\r\n    // [CONTINUE] sentinel so the model has a valid conversation to respond to. This is\r\n    // defense-in-depth; callers should prefer sendMessage() which persists a real user message.\r\n    const lastMsg = historyResult.data[historyResult.data.length - 1];\r\n    if (lastMsg?.role === \"assistant\" && !lastMsg.metadata?.partial) {\r\n      log.warn(\"streamWithHistory: trailing non-partial assistant detected, injecting [CONTINUE]\", {\r\n        workspaceId: this.workspaceId,\r\n        messageId: lastMsg.id,\r\n      });\r\n      const sentinelMessage = createMuxMessage(createUserMessageId(), \"user\", \"[CONTINUE]\", {\r\n        timestamp: Date.now(),\r\n        synthetic: true,\r\n      });\r\n      await this.historyService.appendToHistory(this.workspaceId, sentinelMessage);\r\n      const refreshed = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\r\n      if (refreshed.success) {\r\n        historyResult = refreshed;\r\n      }\r\n    }\r\n\r\n    // Capture the current user message id so retries are stable across assistant message ids.\r\n    const lastUserMessage = [...historyResult.data].reverse().find((m) => m.role === \"user\");\r\n    this.activeStreamUserMessageId = lastUserMessage?.id;\r\n\r\n    this.activeCompactionRequest = this.resolveCompactionRequest(\r\n      historyResult.data,\r\n      modelString,\r\n      options\r\n    );\r\n\r\n    // Check for external file edits (timestamp-based polling)\r\n    const changedFileAttachments = await this.fileChangeTracker.getChangedAttachments();\r\n\r\n    // Check if post-compaction attachments should be injected.\r\n    const postCompactionAttachments =\r\n      disablePostCompactionAttachments === true\r\n        ? null\r\n        : await this.getPostCompactionAttachmentsIfNeeded();\r\n    this.activeStreamHadPostCompactionInjection =\r\n      postCompactionAttachments !== null && postCompactionAttachments.length > 0;\r\n\r\n    // Enforce thinking policy for the specified model (single source of truth)\r\n    // This ensures model-specific requirements are met regardless of where the request originates\r\n    const effectiveThinkingLevel = options?.thinkingLevel\r\n      ? enforceThinkingPolicy(modelString, options.thinkingLevel)\r\n      : undefined;\r\n\r\n    // Bind recordFileState to this session for the propose_plan tool\r\n    const recordFileState = this.fileChangeTracker.record.bind(this.fileChangeTracker);\r\n\r\n    const streamResult = await this.aiService.streamMessage({\r\n      messages: historyResult.data,\r\n      workspaceId: this.workspaceId,\r\n      modelString,\r\n      thinkingLevel: effectiveThinkingLevel,\r\n      toolPolicy: options?.toolPolicy,\r\n      additionalSystemInstructions: options?.additionalSystemInstructions,\r\n      maxOutputTokens: options?.maxOutputTokens,\r\n      muxProviderOptions: options?.providerOptions,\r\n      agentId: options?.agentId,\r\n      recordFileState,\r\n      changedFileAttachments:\r\n        changedFileAttachments.length > 0 ? changedFileAttachments : undefined,\r\n      postCompactionAttachments,\r\n      experiments: options?.experiments,\r\n      system1Model: options?.system1Model,\r\n      system1ThinkingLevel: options?.system1ThinkingLevel,\r\n      disableWorkspaceAgents: options?.disableWorkspaceAgents,\r\n      hasQueuedMessage: () => !this.messageQueue.isEmpty(),\r\n      openaiTruncationModeOverride,\r\n    });\r\n\r\n    if (!streamResult.success) {\r\n      this.activeCompactionRequest = undefined;\r\n\r\n      // If stream startup failed before any stream events were emitted (e.g., missing API key),\r\n      // emit a synthetic stream-error so the UI can surface the failure immediately.\r\n      if (\r\n        streamResult.error.type !== \"runtime_not_ready\" &&\r\n        streamResult.error.type !== \"runtime_start_failed\"\r\n      ) {\r\n        const streamError = buildStreamErrorEventData(streamResult.error);\r\n        await this.handleStreamError(streamError);\r\n      }\r\n    }\r\n\r\n    return streamResult;\r\n  }\r\n\r\n  private resolveCompactionRequest(\r\n    history: MuxMessage[],\r\n    modelString: string,\r\n    options?: SendMessageOptions\r\n  ): { id: string; modelString: string; options?: SendMessageOptions } | undefined {\r\n    for (let index = history.length - 1; index >= 0; index -= 1) {\r\n      const message = history[index];\r\n      if (message.role !== \"user\") {\r\n        continue;\r\n      }\r\n      if (!isCompactionRequestMetadata(message.metadata?.muxMetadata)) {\r\n        return undefined;\r\n      }\r\n      return {\r\n        id: message.id,\r\n        modelString,\r\n        options,\r\n      };\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private async clearFailedAssistantMessage(messageId: string, reason: string): Promise<void> {\r\n    const [partialResult, deleteMessageResult] = await Promise.all([\r\n      this.partialService.deletePartial(this.workspaceId),\r\n      this.historyService.deleteMessage(this.workspaceId, messageId),\r\n    ]);\r\n\r\n    if (!partialResult.success) {\r\n      log.warn(\"Failed to clear partial before retry\", {\r\n        workspaceId: this.workspaceId,\r\n        reason,\r\n        error: partialResult.error,\r\n      });\r\n    }\r\n\r\n    if (\r\n      !deleteMessageResult.success &&\r\n      !(\r\n        typeof deleteMessageResult.error === \"string\" &&\r\n        deleteMessageResult.error.includes(\"not found in history\")\r\n      )\r\n    ) {\r\n      log.warn(\"Failed to delete failed assistant placeholder\", {\r\n        workspaceId: this.workspaceId,\r\n        reason,\r\n        error: deleteMessageResult.error,\r\n      });\r\n    }\r\n  }\r\n\r\n  private async finalizeCompactionRetry(messageId: string): Promise<void> {\r\n    this.activeCompactionRequest = undefined;\r\n    this.resetActiveStreamState();\r\n    this.emitChatEvent({\r\n      type: \"stream-abort\",\r\n      workspaceId: this.workspaceId,\r\n      messageId,\r\n    });\r\n    await this.clearFailedAssistantMessage(messageId, \"compaction-retry\");\r\n  }\r\n\r\n  private supports1MContextRetry(modelString: string): boolean {\r\n    const normalized = normalizeGatewayModel(modelString);\r\n    const [provider, modelName] = normalized.split(\":\", 2);\r\n    const lower = modelName?.toLowerCase() ?? \"\";\r\n    return (\r\n      provider === \"anthropic\" &&\r\n      (lower.startsWith(\"claude-sonnet-4-5\") || lower.startsWith(\"claude-opus-4-6\"))\r\n    );\r\n  }\r\n\r\n  private withAnthropic1MContext(\r\n    modelString: string,\r\n    options: SendMessageOptions | undefined\r\n  ): SendMessageOptions {\r\n    if (options) {\r\n      const existingModels = options.providerOptions?.anthropic?.use1MContextModels ?? [];\r\n      return {\r\n        ...options,\r\n        providerOptions: {\r\n          ...options.providerOptions,\r\n          anthropic: {\r\n            ...options.providerOptions?.anthropic,\r\n            use1MContext: true,\r\n            use1MContextModels: existingModels.includes(modelString)\r\n              ? existingModels\r\n              : [...existingModels, modelString],\r\n          },\r\n        },\r\n      };\r\n    }\r\n\r\n    return {\r\n      model: modelString,\r\n      agentId: WORKSPACE_DEFAULTS.agentId,\r\n      providerOptions: {\r\n        anthropic: {\r\n          use1MContext: true,\r\n          use1MContextModels: [modelString],\r\n        },\r\n      },\r\n    };\r\n  }\r\n\r\n  private isGptClassModel(modelString: string): boolean {\r\n    const normalized = normalizeGatewayModel(modelString);\r\n    const [provider, modelName] = normalized.split(\":\", 2);\r\n    return provider === \"openai\" && modelName?.toLowerCase().startsWith(\"gpt-\");\r\n  }\r\n\r\n  private async maybeRetryCompactionOnContextExceeded(data: {\r\n    messageId: string;\r\n    errorType?: string;\r\n  }): Promise<boolean> {\r\n    if (data.errorType !== \"context_exceeded\") {\r\n      return false;\r\n    }\r\n\r\n    const context = this.activeCompactionRequest;\r\n    if (!context) {\r\n      return false;\r\n    }\r\n\r\n    const isGptClass = this.isGptClassModel(context.modelString);\r\n    const is1MCapable = this.supports1MContextRetry(context.modelString);\r\n\r\n    if (!isGptClass && !is1MCapable) {\r\n      return false;\r\n    }\r\n\r\n    if (is1MCapable) {\r\n      // Skip retry if 1M context is already enabled (via legacy global flag or per-model list)\r\n      const anthropicOpts = context.options?.providerOptions?.anthropic;\r\n      const already1M =\r\n        anthropicOpts?.use1MContext === true ||\r\n        (anthropicOpts?.use1MContextModels?.includes(context.modelString) ?? false);\r\n      if (already1M) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    if (this.compactionRetryAttempts.has(context.id)) {\r\n      return false;\r\n    }\r\n\r\n    this.compactionRetryAttempts.add(context.id);\r\n\r\n    const retryLabel = is1MCapable ? \"Anthropic 1M context\" : \"OpenAI truncation\";\r\n    log.info(`Compaction hit context limit; retrying once with ${retryLabel}`, {\r\n      workspaceId: this.workspaceId,\r\n      model: context.modelString,\r\n      compactionRequestId: context.id,\r\n    });\r\n\r\n    await this.finalizeCompactionRetry(data.messageId);\r\n\r\n    const retryOptions = is1MCapable\r\n      ? this.withAnthropic1MContext(context.modelString, context.options)\r\n      : context.options;\r\n    this.streamStarting = true;\r\n    let retryResult: Result<void, SendMessageError>;\r\n    try {\r\n      retryResult = await this.streamWithHistory(\r\n        context.modelString,\r\n        retryOptions,\r\n        isGptClass ? \"auto\" : undefined\r\n      );\r\n    } finally {\r\n      this.streamStarting = false;\r\n    }\r\n    if (!retryResult.success) {\r\n      log.error(\"Compaction retry failed to start\", {\r\n        workspaceId: this.workspaceId,\r\n        error: retryResult.error,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private async maybeRetryWithoutPostCompactionOnContextExceeded(data: {\r\n    messageId: string;\r\n    errorType?: string;\r\n  }): Promise<boolean> {\r\n    if (data.errorType !== \"context_exceeded\") {\r\n      return false;\r\n    }\r\n\r\n    // Only retry if we actually injected post-compaction context.\r\n    if (!this.activeStreamHadPostCompactionInjection) {\r\n      return false;\r\n    }\r\n\r\n    // Guardrail: don't retry if we've already emitted any meaningful output.\r\n    if (this.activeStreamHadAnyDelta) {\r\n      return false;\r\n    }\r\n\r\n    const requestId = this.activeStreamUserMessageId;\r\n    const context = this.activeStreamContext;\r\n    if (!requestId || !context) {\r\n      return false;\r\n    }\r\n\r\n    if (this.postCompactionRetryAttempts.has(requestId)) {\r\n      return false;\r\n    }\r\n\r\n    this.postCompactionRetryAttempts.add(requestId);\r\n\r\n    log.info(\"Post-compaction context hit context limit; retrying once without it\", {\r\n      workspaceId: this.workspaceId,\r\n      requestId,\r\n      model: context.modelString,\r\n    });\r\n\r\n    // The post-compaction diffs are likely the culprit; discard them so we don't loop.\r\n    try {\r\n      await this.compactionHandler.discardPendingDiffs(\"context_exceeded\");\r\n      this.onPostCompactionStateChange?.();\r\n    } catch (error) {\r\n      log.warn(\"Failed to discard pending post-compaction state\", {\r\n        workspaceId: this.workspaceId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n\r\n    // Abort the failed assistant placeholder and clean up persisted partial/history state.\r\n    this.resetActiveStreamState();\r\n    this.emitChatEvent({\r\n      type: \"stream-abort\",\r\n      workspaceId: this.workspaceId,\r\n      messageId: data.messageId,\r\n    });\r\n    await this.clearFailedAssistantMessage(data.messageId, \"post-compaction-retry\");\r\n\r\n    // Retry the same request, but without post-compaction injection.\r\n    this.streamStarting = true;\r\n    let retryResult: Result<void, SendMessageError>;\r\n    try {\r\n      retryResult = await this.streamWithHistory(\r\n        context.modelString,\r\n        context.options,\r\n        context.openaiTruncationModeOverride,\r\n        true\r\n      );\r\n    } finally {\r\n      this.streamStarting = false;\r\n    }\r\n\r\n    if (!retryResult.success) {\r\n      log.error(\"Post-compaction retry failed to start\", {\r\n        workspaceId: this.workspaceId,\r\n        error: retryResult.error,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private async maybeHardRestartExecSubagentOnContextExceeded(data: {\r\n    messageId: string;\r\n    errorType?: string;\r\n  }): Promise<boolean> {\r\n    if (data.errorType !== \"context_exceeded\") {\r\n      return false;\r\n    }\r\n\r\n    // Only enabled via experiment (and only when we still have a valid retry context).\r\n    const context = this.activeStreamContext;\r\n    const requestId = this.activeStreamUserMessageId;\r\n    const experimentEnabled = context?.options?.experiments?.execSubagentHardRestart === true;\r\n    if (!experimentEnabled || !context || !requestId) {\r\n      return false;\r\n    }\r\n\r\n    // Guardrail: don't hard-restart after any meaningful output.\r\n    // This is intended to recover from \"prompt too long\" cases before the model starts streaming.\r\n    if (this.activeStreamHadAnyDelta) {\r\n      return false;\r\n    }\r\n\r\n    if (this.execSubagentHardRestartAttempts.has(requestId)) {\r\n      return false;\r\n    }\r\n\r\n    // Guard for test mocks that may not implement getWorkspaceMetadata.\r\n    if (typeof this.aiService.getWorkspaceMetadata !== \"function\") {\r\n      return false;\r\n    }\r\n\r\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\r\n    if (!metadataResult.success) {\r\n      return false;\r\n    }\r\n\r\n    const metadata = metadataResult.data;\r\n    if (!metadata.parentWorkspaceId) {\r\n      return false;\r\n    }\r\n\r\n    const agentIdRaw = (metadata.agentId ?? metadata.agentType ?? WORKSPACE_DEFAULTS.agentId)\r\n      .trim()\r\n      .toLowerCase();\r\n    const parsedAgentId = AgentIdSchema.safeParse(agentIdRaw);\r\n    const agentId = parsedAgentId.success ? parsedAgentId.data : (\"exec\" as const);\r\n\r\n    // Prefer resolving agent inheritance from the parent workspace: project agents may be untracked\r\n    // (and therefore absent from child worktrees), but they are always present in the parent that\r\n    // spawned the task.\r\n    const metadataCandidates: Array<typeof metadata> = [metadata];\r\n\r\n    try {\r\n      const parentMetadataResult = await this.aiService.getWorkspaceMetadata(\r\n        metadata.parentWorkspaceId\r\n      );\r\n      if (parentMetadataResult.success) {\r\n        metadataCandidates.unshift(parentMetadataResult.data);\r\n      }\r\n    } catch {\r\n      // ignore - fall back to child metadata\r\n    }\r\n\r\n    let chain: Awaited<ReturnType<typeof resolveAgentInheritanceChain>> | undefined;\r\n    for (const agentMetadata of metadataCandidates) {\r\n      try {\r\n        const runtime = createRuntimeForWorkspace(agentMetadata);\r\n\r\n        // In-place workspaces (CLI/benchmarks) have projectPath === name.\r\n        // Use path directly instead of reconstructing via getWorkspacePath.\r\n        const isInPlace = agentMetadata.projectPath === agentMetadata.name;\r\n        const workspacePath = isInPlace\r\n          ? agentMetadata.projectPath\r\n          : runtime.getWorkspacePath(agentMetadata.projectPath, agentMetadata.name);\r\n\r\n        const agentDiscoveryPath =\r\n          context.options?.disableWorkspaceAgents === true\r\n            ? agentMetadata.projectPath\r\n            : workspacePath;\r\n\r\n        const agentDefinition = await readAgentDefinition(runtime, agentDiscoveryPath, agentId);\r\n        chain = await resolveAgentInheritanceChain({\r\n          runtime,\r\n          workspacePath: agentDiscoveryPath,\r\n          agentId,\r\n          agentDefinition,\r\n          workspaceId: this.workspaceId,\r\n        });\r\n        break;\r\n      } catch {\r\n        // ignore - try next candidate\r\n      }\r\n    }\r\n\r\n    if (!chain) {\r\n      // If we fail to resolve tool policy/inheritance, treat as non-exec-like.\r\n      return false;\r\n    }\r\n\r\n    if (!isExecLikeEditingCapableInResolvedChain(chain)) {\r\n      return false;\r\n    }\r\n\r\n    this.execSubagentHardRestartAttempts.add(requestId);\r\n\r\n    const continuationNotice =\r\n      \"Context limit reached. Mux restarted this agent's chat history and will replay your original prompt below. \" +\r\n      \"Continue using only the current workspace state (files, git history, command output); \" +\r\n      \"re-inspect the repo as needed.\";\r\n\r\n    log.info(\"Exec-like subagent hit context limit; hard-restarting history and retrying\", {\r\n      workspaceId: this.workspaceId,\r\n      requestId,\r\n      model: context.modelString,\r\n      agentId,\r\n    });\r\n\r\n    // Only need the current compaction epoch  if compaction already happened, the\r\n    // original task prompt is summarized in the boundary and pre-boundary messages\r\n    // aren't useful for replaying.\r\n    const historyResult = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\r\n    if (!historyResult.success) {\r\n      return false;\r\n    }\r\n\r\n    const messages = historyResult.data;\r\n\r\n    const firstPromptIndex = messages.findIndex(\r\n      (msg) => msg.role === \"user\" && msg.metadata?.synthetic !== true\r\n    );\r\n    if (firstPromptIndex === -1) {\r\n      return false;\r\n    }\r\n\r\n    // Include any synthetic snapshots that were persisted immediately before the task prompt.\r\n    let seedStartIndex = firstPromptIndex;\r\n    for (let i = firstPromptIndex - 1; i >= 0; i -= 1) {\r\n      const msg = messages[i];\r\n      const isSnapshot =\r\n        msg.role === \"user\" &&\r\n        msg.metadata?.synthetic === true &&\r\n        (msg.metadata?.fileAtMentionSnapshot ?? msg.metadata?.agentSkillSnapshot);\r\n      if (!isSnapshot) {\r\n        break;\r\n      }\r\n      seedStartIndex = i;\r\n    }\r\n\r\n    const seedMessages = messages.slice(seedStartIndex, firstPromptIndex + 1);\r\n    if (seedMessages.length === 0) {\r\n      return false;\r\n    }\r\n\r\n    // Best-effort: discard pending post-compaction state so we don't immediately re-inject it.\r\n    try {\r\n      await this.compactionHandler.discardPendingDiffs(\"execSubagentHardRestart\");\r\n      this.onPostCompactionStateChange?.();\r\n    } catch (error) {\r\n      log.warn(\"Failed to discard pending post-compaction state before hard restart\", {\r\n        workspaceId: this.workspaceId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n\r\n    // Abort the failed assistant placeholder and clean up partial/history state.\r\n    this.activeCompactionRequest = undefined;\r\n    this.resetActiveStreamState();\r\n    if (!this.disposed) {\r\n      this.clearQueue();\r\n    }\r\n\r\n    this.emitChatEvent({\r\n      type: \"stream-abort\",\r\n      workspaceId: this.workspaceId,\r\n      messageId: data.messageId,\r\n    });\r\n\r\n    const partialDeleteResult = await this.partialService.deletePartial(this.workspaceId);\r\n    if (!partialDeleteResult.success) {\r\n      log.warn(\"Failed to delete partial before exec subagent hard restart\", {\r\n        workspaceId: this.workspaceId,\r\n        error: partialDeleteResult.error,\r\n      });\r\n    }\r\n\r\n    const clearResult = await this.historyService.clearHistory(this.workspaceId);\r\n    if (!clearResult.success) {\r\n      log.warn(\"Failed to clear history for exec subagent hard restart\", {\r\n        workspaceId: this.workspaceId,\r\n        error: clearResult.error,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    const deletedSequences = clearResult.data;\r\n    if (deletedSequences.length > 0) {\r\n      const deleteMessage: DeleteMessage = {\r\n        type: \"delete\",\r\n        historySequences: deletedSequences,\r\n      };\r\n      this.emitChatEvent(deleteMessage);\r\n    }\r\n\r\n    const cloneForAppend = (msg: MuxMessage): MuxMessage => {\r\n      const metadataCopy = msg.metadata ? { ...msg.metadata } : undefined;\r\n      if (metadataCopy) {\r\n        metadataCopy.historySequence = undefined;\r\n        metadataCopy.partial = undefined;\r\n        metadataCopy.error = undefined;\r\n        metadataCopy.errorType = undefined;\r\n      }\r\n\r\n      return {\r\n        ...msg,\r\n        metadata: metadataCopy,\r\n        parts: [...msg.parts],\r\n      };\r\n    };\r\n\r\n    const continuationMessage = createMuxMessage(\r\n      createUserMessageId(),\r\n      \"user\",\r\n      continuationNotice,\r\n      {\r\n        timestamp: Date.now(),\r\n        synthetic: true,\r\n        uiVisible: true,\r\n      }\r\n    );\r\n\r\n    const messagesToAppend = [continuationMessage, ...seedMessages.map(cloneForAppend)];\r\n    for (const message of messagesToAppend) {\r\n      const appendResult = await this.historyService.appendToHistory(this.workspaceId, message);\r\n      if (!appendResult.success) {\r\n        log.error(\"Failed to append message during exec subagent hard restart\", {\r\n          workspaceId: this.workspaceId,\r\n          messageId: message.id,\r\n          error: appendResult.error,\r\n        });\r\n        return false;\r\n      }\r\n\r\n      // Add type: \"message\" for discriminated union (MuxMessage doesn't have it)\r\n      this.emitChatEvent({\r\n        ...message,\r\n        type: \"message\" as const,\r\n      });\r\n    }\r\n\r\n    const existingInstructions = context.options?.additionalSystemInstructions;\r\n    const mergedAdditionalSystemInstructions = existingInstructions\r\n      ? `${continuationNotice}\\n\\n${existingInstructions}`\r\n      : continuationNotice;\r\n\r\n    const retryOptions: SendMessageOptions | undefined = context.options\r\n      ? {\r\n        ...context.options,\r\n        additionalSystemInstructions: mergedAdditionalSystemInstructions,\r\n      }\r\n      : {\r\n        model: context.modelString,\r\n        agentId: WORKSPACE_DEFAULTS.agentId,\r\n        additionalSystemInstructions: mergedAdditionalSystemInstructions,\r\n        experiments: {\r\n          execSubagentHardRestart: true,\r\n        },\r\n      };\r\n\r\n    this.streamStarting = true;\r\n    let retryResult: Result<void, SendMessageError>;\r\n    try {\r\n      retryResult = await this.streamWithHistory(\r\n        context.modelString,\r\n        retryOptions,\r\n        context.openaiTruncationModeOverride\r\n      );\r\n    } finally {\r\n      this.streamStarting = false;\r\n    }\r\n\r\n    if (!retryResult.success) {\r\n      log.error(\"Exec subagent hard restart retry failed to start\", {\r\n        workspaceId: this.workspaceId,\r\n        error: retryResult.error,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private resetActiveStreamState(): void {\r\n    this.activeStreamContext = undefined;\r\n    this.activeStreamUserMessageId = undefined;\r\n    this.activeStreamHadPostCompactionInjection = false;\r\n    this.activeStreamHadAnyDelta = false;\r\n    this.ackPendingPostCompactionStateOnStreamEnd = false;\r\n  }\r\n\r\n  private async handleStreamError(data: StreamErrorPayload): Promise<void> {\r\n    const hadCompactionRequest = this.activeCompactionRequest !== undefined;\r\n    if (\r\n      await this.maybeRetryCompactionOnContextExceeded({\r\n        messageId: data.messageId,\r\n        errorType: data.errorType,\r\n      })\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      await this.maybeRetryWithoutPostCompactionOnContextExceeded({\r\n        messageId: data.messageId,\r\n        errorType: data.errorType,\r\n      })\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      await this.maybeHardRestartExecSubagentOnContextExceeded({\r\n        messageId: data.messageId,\r\n        errorType: data.errorType,\r\n      })\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    this.activeCompactionRequest = undefined;\r\n    this.resetActiveStreamState();\r\n\r\n    if (hadCompactionRequest && !this.disposed) {\r\n      this.clearQueue();\r\n    }\r\n\r\n    this.emitChatEvent(createStreamErrorMessage(data));\r\n  }\r\n\r\n  private attachAiListeners(): void {\r\n    const forward = (\r\n      event: string,\r\n      handler: (payload: WorkspaceChatMessage) => Promise<void> | void\r\n    ) => {\r\n      const wrapped = (...args: unknown[]) => {\r\n        const [payload] = args;\r\n        if (\r\n          typeof payload === \"object\" &&\r\n          payload !== null &&\r\n          \"workspaceId\" in payload &&\r\n          (payload as { workspaceId: unknown }).workspaceId !== this.workspaceId\r\n        ) {\r\n          return;\r\n        }\r\n        void handler(payload as WorkspaceChatMessage);\r\n      };\r\n      this.aiListeners.push({ event, handler: wrapped });\r\n      this.aiService.on(event, wrapped as never);\r\n    };\r\n\r\n    forward(\"stream-start\", (payload) => this.emitChatEvent(payload));\r\n    forward(\"stream-delta\", (payload) => {\r\n      this.activeStreamHadAnyDelta = true;\r\n      this.emitChatEvent(payload);\r\n    });\r\n    forward(\"tool-call-start\", (payload) => {\r\n      this.activeStreamHadAnyDelta = true;\r\n      this.emitChatEvent(payload);\r\n    });\r\n    forward(\"bash-output\", (payload) => {\r\n      this.activeStreamHadAnyDelta = true;\r\n      this.emitChatEvent(payload);\r\n    });\r\n    forward(\"tool-call-delta\", (payload) => {\r\n      this.activeStreamHadAnyDelta = true;\r\n      this.emitChatEvent(payload);\r\n    });\r\n    forward(\"tool-call-end\", (payload) => {\r\n      this.activeStreamHadAnyDelta = true;\r\n      this.emitChatEvent(payload);\r\n\r\n      // Post-compaction context state depends on plan writes + tracked file diffs.\r\n      // Trigger a metadata refresh so the right sidebar updates immediately.\r\n      if (\r\n        payload.type === \"tool-call-end\" &&\r\n        (payload.toolName === \"propose_plan\" || payload.toolName.startsWith(\"file_edit_\"))\r\n      ) {\r\n        this.onPostCompactionStateChange?.();\r\n      }\r\n    });\r\n    forward(\"reasoning-delta\", (payload) => {\r\n      this.activeStreamHadAnyDelta = true;\r\n      this.emitChatEvent(payload);\r\n    });\r\n    forward(\"reasoning-end\", (payload) => this.emitChatEvent(payload));\r\n    forward(\"usage-delta\", (payload) => this.emitChatEvent(payload));\r\n    forward(\"stream-abort\", (payload) => {\r\n      const hadCompactionRequest = this.activeCompactionRequest !== undefined;\r\n      this.activeCompactionRequest = undefined;\r\n      this.resetActiveStreamState();\r\n      if (hadCompactionRequest && !this.disposed) {\r\n        this.clearQueue();\r\n      }\r\n      this.emitChatEvent(payload);\r\n    });\r\n    forward(\"runtime-status\", (payload) => this.emitChatEvent(payload));\r\n\r\n    forward(\"stream-end\", async (payload) => {\r\n      this.activeCompactionRequest = undefined;\r\n      const handled = await this.compactionHandler.handleCompletion(payload as StreamEndEvent);\r\n\r\n      if (!handled) {\r\n        this.emitChatEvent(payload);\r\n\r\n        if (this.ackPendingPostCompactionStateOnStreamEnd) {\r\n          this.ackPendingPostCompactionStateOnStreamEnd = false;\r\n          try {\r\n            await this.compactionHandler.ackPendingDiffsConsumed();\r\n          } catch (error) {\r\n            log.warn(\"Failed to ack pending post-compaction state\", {\r\n              workspaceId: this.workspaceId,\r\n              error: error instanceof Error ? error.message : String(error),\r\n            });\r\n          }\r\n          this.onPostCompactionStateChange?.();\r\n        }\r\n      } else {\r\n        // Compaction completed - notify to trigger metadata refresh\r\n        // This allows the frontend to get updated postCompaction state\r\n        this.onCompactionComplete?.();\r\n\r\n        // Dispatch any pending follow-up from the compaction summary.\r\n        // The follow-up is stored on the summary for crash safety - if the app\r\n        // crashes after compaction but before this dispatch, startup recovery\r\n        // will detect the pending follow-up and dispatch it.\r\n        //\r\n        // IMPORTANT: await to ensure the follow-up message is persisted before\r\n        // sendQueuedMessages runs. Otherwise a queued message could append first,\r\n        // causing dispatchPendingFollowUp to skip (since summary would no longer\r\n        // be the last message).\r\n        await this.dispatchPendingFollowUp();\r\n      }\r\n\r\n      this.resetActiveStreamState();\r\n\r\n      // Stream end: auto-send queued messages (for user messages typed during streaming)\r\n      this.sendQueuedMessages();\r\n    });\r\n\r\n    const errorHandler = (...args: unknown[]) => {\r\n      const [raw] = args;\r\n      if (\r\n        typeof raw !== \"object\" ||\r\n        raw === null ||\r\n        !(\"workspaceId\" in raw) ||\r\n        (raw as { workspaceId: unknown }).workspaceId !== this.workspaceId\r\n      ) {\r\n        return;\r\n      }\r\n      const data = raw as StreamErrorPayload & { workspaceId: string };\r\n      void this.handleStreamError({\r\n        messageId: data.messageId,\r\n        error: data.error,\r\n        errorType: data.errorType,\r\n      });\r\n    };\r\n\r\n    this.aiListeners.push({ event: \"error\", handler: errorHandler });\r\n    this.aiService.on(\"error\", errorHandler as never);\r\n  }\r\n\r\n  private attachInitListeners(): void {\r\n    const forward = (event: string, handler: (payload: WorkspaceChatMessage) => void) => {\r\n      const wrapped = (...args: unknown[]) => {\r\n        const [payload] = args;\r\n        if (\r\n          typeof payload === \"object\" &&\r\n          payload !== null &&\r\n          \"workspaceId\" in payload &&\r\n          (payload as { workspaceId: unknown }).workspaceId !== this.workspaceId\r\n        ) {\r\n          return;\r\n        }\r\n        // Strip workspaceId from payload before forwarding (WorkspaceInitEvent doesn't include it)\r\n        const { workspaceId: _, ...message } = payload as WorkspaceChatMessage & {\r\n          workspaceId: string;\r\n        };\r\n        handler(message as WorkspaceChatMessage);\r\n      };\r\n      this.initListeners.push({ event, handler: wrapped });\r\n      this.initStateManager.on(event, wrapped as never);\r\n    };\r\n\r\n    forward(\"init-start\", (payload) => this.emitChatEvent(payload));\r\n    forward(\"init-output\", (payload) => this.emitChatEvent(payload));\r\n    forward(\"init-end\", (payload) => this.emitChatEvent(payload));\r\n  }\r\n\r\n  // Public method to emit chat events (used by init hooks and other workspace events)\r\n  emitChatEvent(message: WorkspaceChatMessage): void {\r\n    // NOTE: Workspace teardown does not await in-flight async work (sendMessage(), stopStream(), etc).\r\n    // Those code paths can still try to emit events after dispose; drop them rather than crashing.\r\n    if (this.disposed) {\r\n      return;\r\n    }\r\n\r\n    this.emitter.emit(\"chat-event\", {\r\n      workspaceId: this.workspaceId,\r\n      message,\r\n    } satisfies AgentSessionChatEvent);\r\n  }\r\n\r\n  isStreamStarting(): boolean {\r\n    return this.streamStarting;\r\n  }\r\n\r\n  queueMessage(message: string, options?: SendMessageOptions & { fileParts?: FilePart[] }): void {\r\n    this.assertNotDisposed(\"queueMessage\");\r\n    this.messageQueue.add(message, options);\r\n    this.emitQueuedMessageChanged();\r\n    // Signal to bash_output that it should return early to process the queued message\r\n    this.backgroundProcessManager.setMessageQueued(this.workspaceId, true);\r\n  }\r\n\r\n  clearQueue(): void {\r\n    this.assertNotDisposed(\"clearQueue\");\r\n    this.messageQueue.clear();\r\n    this.emitQueuedMessageChanged();\r\n    this.backgroundProcessManager.setMessageQueued(this.workspaceId, false);\r\n  }\r\n\r\n  /**\r\n   * Restore queued messages to input box.\r\n   * Called by IPC handler on user-initiated interrupt.\r\n   */\r\n  restoreQueueToInput(): void {\r\n    this.assertNotDisposed(\"restoreQueueToInput\");\r\n    if (!this.messageQueue.isEmpty()) {\r\n      const displayText = this.messageQueue.getDisplayText();\r\n      const fileParts = this.messageQueue.getFileParts();\r\n      const reviews = this.messageQueue.getReviews();\r\n      this.messageQueue.clear();\r\n      this.emitQueuedMessageChanged();\r\n\r\n      this.emitChatEvent({\r\n        type: \"restore-to-input\",\r\n        workspaceId: this.workspaceId,\r\n        text: displayText,\r\n        fileParts: fileParts,\r\n        reviews: reviews,\r\n      });\r\n    }\r\n  }\r\n\r\n  private emitQueuedMessageChanged(): void {\r\n    this.emitChatEvent({\r\n      type: \"queued-message-changed\",\r\n      workspaceId: this.workspaceId,\r\n      queuedMessages: this.messageQueue.getMessages(),\r\n      displayText: this.messageQueue.getDisplayText(),\r\n      fileParts: this.messageQueue.getFileParts(),\r\n      reviews: this.messageQueue.getReviews(),\r\n      hasCompactionRequest: this.messageQueue.hasCompactionRequest(),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Send queued messages if any exist.\r\n   * Called when tool execution completes, stream ends, or user clicks send immediately.\r\n   */\r\n  sendQueuedMessages(): void {\r\n    // sendQueuedMessages can race with teardown (e.g. workspace.remove) because we\r\n    // trigger it off stream/tool events and disposal does not await stopStream().\r\n    // If the session is already disposed, do nothing.\r\n    if (this.disposed) {\r\n      return;\r\n    }\r\n\r\n    // Clear the queued message flag (even if queue is empty, to handle race conditions)\r\n    this.backgroundProcessManager.setMessageQueued(this.workspaceId, false);\r\n\r\n    if (!this.messageQueue.isEmpty()) {\r\n      const { message, options } = this.messageQueue.produceMessage();\r\n      this.messageQueue.clear();\r\n      this.emitQueuedMessageChanged();\r\n\r\n      void this.sendMessage(message, options);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Dispatch the pending follow-up from a compaction summary message.\r\n   * Called after compaction completes - the follow-up is stored on the summary\r\n   * for crash safety. The user message persisted by sendMessage() serves as\r\n   * proof of dispatch (no history rewrite needed).\r\n   */\r\n  private async dispatchPendingFollowUp(): Promise<void> {\r\n    if (this.disposed) {\r\n      return;\r\n    }\r\n\r\n    // Read the last message from history  only need 1 message, avoid full-file read\r\n    const historyResult = await this.historyService.getLastMessages(this.workspaceId, 1);\r\n    if (!historyResult.success || historyResult.data.length === 0) {\r\n      return;\r\n    }\r\n\r\n    const lastMessage = historyResult.data[0];\r\n    const muxMeta = lastMessage.metadata?.muxMetadata;\r\n\r\n    // Check if it's a compaction summary with a pending follow-up\r\n    if (!isCompactionSummaryMetadata(muxMeta) || !muxMeta.pendingFollowUp) {\r\n      return;\r\n    }\r\n\r\n    // Handle legacy formats: older persisted requests may have `mode` instead of `agentId`,\r\n    // and `imageParts` instead of `fileParts`.\r\n    const followUp = muxMeta.pendingFollowUp as typeof muxMeta.pendingFollowUp & {\r\n      mode?: \"exec\" | \"plan\";\r\n      imageParts?: FilePart[];\r\n    };\r\n\r\n    // Derive agentId: new field has it directly, legacy may use `mode` field.\r\n    // Legacy `mode` was \"exec\" | \"plan\" and maps directly to agentId.\r\n    const effectiveAgentId = followUp.agentId ?? followUp.mode ?? \"exec\";\r\n\r\n    // Normalize attachments: newer metadata uses `fileParts`, older persisted entries used `imageParts`.\r\n    const effectiveFileParts = followUp.fileParts ?? followUp.imageParts;\r\n\r\n    // Model fallback for legacy follow-ups that may lack the model field.\r\n    // DEFAULT_MODEL is a safe fallback that's always available.\r\n    const effectiveModel = followUp.model ?? DEFAULT_MODEL;\r\n\r\n    log.debug(\"Dispatching pending follow-up from compaction summary\", {\r\n      workspaceId: this.workspaceId,\r\n      hasText: Boolean(followUp.text),\r\n      hasFileParts: Boolean(effectiveFileParts?.length),\r\n      hasReviews: Boolean(followUp.reviews?.length),\r\n      model: effectiveModel,\r\n      agentId: effectiveAgentId,\r\n    });\r\n\r\n    // Process the follow-up content (handles reviews -> text formatting + metadata)\r\n    const { finalText, metadata } = prepareUserMessageForSend(\r\n      {\r\n        text: followUp.text,\r\n        fileParts: effectiveFileParts,\r\n        reviews: followUp.reviews,\r\n      },\r\n      followUp.muxMetadata\r\n    );\r\n\r\n    // Build options for the follow-up message.\r\n    // Spread the followUp to include preserved send options (thinkingLevel, providerOptions, etc.)\r\n    // that were captured from the original user message in prepareCompactionMessage().\r\n    const options: SendMessageOptions & {\r\n      fileParts?: FilePart[];\r\n      muxMetadata?: MuxFrontendMetadata;\r\n    } = {\r\n      ...followUp,\r\n      model: effectiveModel,\r\n      agentId: effectiveAgentId,\r\n    };\r\n\r\n    if (effectiveFileParts && effectiveFileParts.length > 0) {\r\n      options.fileParts = effectiveFileParts;\r\n    }\r\n\r\n    if (metadata) {\r\n      options.muxMetadata = metadata;\r\n    }\r\n\r\n    // Await sendMessage to ensure the follow-up is persisted before returning.\r\n    // This guarantees ordering: the follow-up message is written to history\r\n    // before sendQueuedMessages() runs, preventing race conditions.\r\n    await this.sendMessage(finalText, options);\r\n  }\r\n\r\n  /**\r\n   * Record file state for change detection.\r\n   * Called by tools (e.g., propose_plan) after reading/writing files.\r\n   */\r\n  recordFileState(filePath: string, state: FileState): void {\r\n    this.fileChangeTracker.record(filePath, state);\r\n  }\r\n\r\n  /** Get the count of tracked files for UI display. */\r\n  getTrackedFilesCount(): number {\r\n    return this.fileChangeTracker.count;\r\n  }\r\n\r\n  /** Get the paths of tracked files for UI display. */\r\n  getTrackedFilePaths(): string[] {\r\n    return this.fileChangeTracker.paths;\r\n  }\r\n\r\n  /** Clear all tracked file state (e.g., on /clear). */\r\n  clearFileState(): void {\r\n    this.fileChangeTracker.clear();\r\n  }\r\n\r\n  /**\r\n   * Get post-compaction attachments if they should be injected this turn.\r\n   *\r\n   * Logic:\r\n   * - On first turn after compaction: inject immediately, clear file state cache\r\n   * - Subsequent turns: inject every TURNS_BETWEEN_ATTACHMENTS turns\r\n   *\r\n   * @returns Attachments to inject, or null if none needed\r\n   */\r\n  private async getPostCompactionAttachmentsIfNeeded(): Promise<PostCompactionAttachment[] | null> {\r\n    // Check if compaction just occurred (immediate injection with cached diffs)\r\n    const pendingDiffs = await this.compactionHandler.peekPendingDiffs();\r\n    if (pendingDiffs !== null) {\r\n      this.ackPendingPostCompactionStateOnStreamEnd = true;\r\n      this.compactionOccurred = true;\r\n      this.turnsSinceLastAttachment = 0;\r\n      // Clear file state cache since history context is gone\r\n      this.fileChangeTracker.clear();\r\n\r\n      // Load exclusions and persistent TODO state (local workspace session data)\r\n      const excludedItems = await this.loadExcludedItems();\r\n      const todoAttachment = await this.loadTodoListAttachment(excludedItems);\r\n\r\n      // Get runtime for reading plan file\r\n      const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\r\n      if (!metadataResult.success) {\r\n        // Can't get metadata, skip plan reference but still include other attachments\r\n        const attachments: PostCompactionAttachment[] = [];\r\n\r\n        if (todoAttachment) {\r\n          attachments.push(todoAttachment);\r\n        }\r\n\r\n        const editedFilesRef = AttachmentService.generateEditedFilesAttachment(pendingDiffs);\r\n        if (editedFilesRef) {\r\n          attachments.push(editedFilesRef);\r\n        }\r\n\r\n        return attachments;\r\n      }\r\n      const runtime = createRuntimeForWorkspace(metadataResult.data);\r\n\r\n      const attachments = await AttachmentService.generatePostCompactionAttachments(\r\n        metadataResult.data.name,\r\n        metadataResult.data.projectName,\r\n        this.workspaceId,\r\n        pendingDiffs,\r\n        runtime,\r\n        excludedItems\r\n      );\r\n\r\n      if (todoAttachment) {\r\n        // Insert TODO after plan (if present), otherwise first.\r\n        const planIndex = attachments.findIndex((att) => att.type === \"plan_file_reference\");\r\n        const insertIndex = planIndex === -1 ? 0 : planIndex + 1;\r\n        attachments.splice(insertIndex, 0, todoAttachment);\r\n      }\r\n\r\n      return attachments;\r\n    }\r\n\r\n    // Increment turn counter\r\n    this.turnsSinceLastAttachment++;\r\n\r\n    // Check cooldown for subsequent injections (re-read from current history)\r\n    if (this.compactionOccurred && this.turnsSinceLastAttachment >= TURNS_BETWEEN_ATTACHMENTS) {\r\n      this.turnsSinceLastAttachment = 0;\r\n      return this.generatePostCompactionAttachments();\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Generate post-compaction attachments by extracting diffs from message history.\r\n   */\r\n  private async generatePostCompactionAttachments(): Promise<PostCompactionAttachment[]> {\r\n    // getHistoryFromLatestBoundary already returns only the active compaction epoch,\r\n    // so no further boundary slicing is needed.\r\n    const historyResult = await this.historyService.getHistoryFromLatestBoundary(this.workspaceId);\r\n    if (!historyResult.success) {\r\n      return [];\r\n    }\r\n\r\n    const fileDiffs = extractEditedFileDiffs(historyResult.data);\r\n\r\n    // Load exclusions and persistent TODO state (local workspace session data)\r\n    const excludedItems = await this.loadExcludedItems();\r\n    const todoAttachment = await this.loadTodoListAttachment(excludedItems);\r\n\r\n    // Get runtime for reading plan file\r\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\r\n    if (!metadataResult.success) {\r\n      // Can't get metadata, skip plan reference but still include other attachments\r\n      const attachments: PostCompactionAttachment[] = [];\r\n\r\n      if (todoAttachment) {\r\n        attachments.push(todoAttachment);\r\n      }\r\n\r\n      const editedFilesRef = AttachmentService.generateEditedFilesAttachment(fileDiffs);\r\n      if (editedFilesRef) {\r\n        attachments.push(editedFilesRef);\r\n      }\r\n\r\n      return attachments;\r\n    }\r\n    const runtime = createRuntimeForWorkspace(metadataResult.data);\r\n\r\n    const attachments = await AttachmentService.generatePostCompactionAttachments(\r\n      metadataResult.data.name,\r\n      metadataResult.data.projectName,\r\n      this.workspaceId,\r\n      fileDiffs,\r\n      runtime,\r\n      excludedItems\r\n    );\r\n\r\n    if (todoAttachment) {\r\n      // Insert TODO after plan (if present), otherwise first.\r\n      const planIndex = attachments.findIndex((att) => att.type === \"plan_file_reference\");\r\n      const insertIndex = planIndex === -1 ? 0 : planIndex + 1;\r\n      attachments.splice(insertIndex, 0, todoAttachment);\r\n    }\r\n\r\n    return attachments;\r\n  }\r\n\r\n  /**\r\n   * Materialize @file mentions from a user message into a persisted snapshot message.\r\n   *\r\n   * This reads the referenced files once and creates a synthetic message containing\r\n   * their content. The snapshot is persisted to history so subsequent sends don't\r\n   * re-read the files (which would bust prompt cache if files changed).\r\n   *\r\n   * Also registers file state for change detection via <system-file-update> diffs.\r\n   *\r\n   * @returns The snapshot message and list of materialized mentions, or null if no mentions found\r\n   */\r\n  private async materializeFileAtMentionsSnapshot(\r\n    messageText: string\r\n  ): Promise<{ snapshotMessage: MuxMessage; materializedTokens: string[] } | null> {\r\n    // Guard for test mocks that may not implement getWorkspaceMetadata\r\n    if (typeof this.aiService.getWorkspaceMetadata !== \"function\") {\r\n      return null;\r\n    }\r\n\r\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\r\n    if (!metadataResult.success) {\r\n      log.debug(\"Cannot materialize @file mentions: workspace metadata not found\", {\r\n        workspaceId: this.workspaceId,\r\n      });\r\n      return null;\r\n    }\r\n\r\n    const metadata = metadataResult.data;\r\n    const runtime = createRuntimeForWorkspace(metadata);\r\n    const workspacePath = runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n\r\n    const materialized = await materializeFileAtMentions(messageText, {\r\n      runtime,\r\n      workspacePath,\r\n    });\r\n\r\n    if (materialized.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    // Register file state for each successfully read file (for change detection)\r\n    for (const mention of materialized) {\r\n      if (\r\n        mention.content !== undefined &&\r\n        mention.modifiedTimeMs !== undefined &&\r\n        mention.resolvedPath\r\n      ) {\r\n        this.recordFileState(mention.resolvedPath, {\r\n          content: mention.content,\r\n          timestamp: mention.modifiedTimeMs,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Create a synthetic snapshot message (not persisted here - caller handles persistence)\r\n    const tokens = materialized.map((m) => m.token);\r\n    const blocks = materialized.map((m) => m.block).join(\"\\n\\n\");\r\n\r\n    const snapshotId = createFileSnapshotMessageId();\r\n    const snapshotMessage = createMuxMessage(snapshotId, \"user\", blocks, {\r\n      timestamp: Date.now(),\r\n      synthetic: true,\r\n      fileAtMentionSnapshot: tokens,\r\n    });\r\n\r\n    return { snapshotMessage, materializedTokens: tokens };\r\n  }\r\n\r\n  private async materializeAgentSkillSnapshot(\r\n    muxMetadata: MuxFrontendMetadata | undefined,\r\n    disableWorkspaceAgents: boolean | undefined\r\n  ): Promise<{ snapshotMessage: MuxMessage } | null> {\r\n    if (!muxMetadata || muxMetadata.type !== \"agent-skill\") {\r\n      return null;\r\n    }\r\n\r\n    // Guard for test mocks that may not implement getWorkspaceMetadata.\r\n    if (typeof this.aiService.getWorkspaceMetadata !== \"function\") {\r\n      return null;\r\n    }\r\n\r\n    const parsedName = SkillNameSchema.safeParse(muxMetadata.skillName);\r\n    if (!parsedName.success) {\r\n      throw new Error(`Invalid agent skill name: ${muxMetadata.skillName}`);\r\n    }\r\n\r\n    const metadataResult = await this.aiService.getWorkspaceMetadata(this.workspaceId);\r\n    if (!metadataResult.success) {\r\n      throw new Error(\"Cannot materialize agent skill: workspace metadata not found\");\r\n    }\r\n\r\n    const metadata = metadataResult.data;\r\n    const runtime = createRuntime(metadata.runtimeConfig, {\r\n      projectPath: metadata.projectPath,\r\n      workspaceName: metadata.name,\r\n    });\r\n\r\n    // In-place workspaces (CLI/benchmarks) have projectPath === name.\r\n    // Use the path directly instead of reconstructing via getWorkspacePath.\r\n    const isInPlace = metadata.projectPath === metadata.name;\r\n    const workspacePath = isInPlace\r\n      ? metadata.projectPath\r\n      : runtime.getWorkspacePath(metadata.projectPath, metadata.name);\r\n\r\n    // When workspace agents are disabled, resolve skills from the project path instead of\r\n    // the worktree so skill invocation uses the same precedence/discovery root as the UI.\r\n    const skillDiscoveryPath = disableWorkspaceAgents ? metadata.projectPath : workspacePath;\r\n\r\n    const resolved = await readAgentSkill(runtime, skillDiscoveryPath, parsedName.data);\r\n    const skill = resolved.package;\r\n\r\n    const frontmatterYaml = YAML.stringify(skill.frontmatter).trimEnd();\r\n\r\n    const body =\r\n      skill.body.length > MAX_AGENT_SKILL_SNAPSHOT_CHARS\r\n        ? `${skill.body.slice(0, MAX_AGENT_SKILL_SNAPSHOT_CHARS)}\\n\\n[Skill body truncated to ${MAX_AGENT_SKILL_SNAPSHOT_CHARS} characters]`\r\n        : skill.body;\r\n\r\n    const snapshotText = `<agent-skill name=\"${skill.frontmatter.name}\" scope=\"${skill.scope}\">\\n${body}\\n</agent-skill>`;\r\n\r\n    // Include the parsed YAML frontmatter in the hash so frontmatter-only edits (e.g. description)\r\n    // generate a new snapshot and keep the UI hover preview in sync.\r\n    const sha256 = createHash(\"sha256\")\r\n      .update(JSON.stringify({ snapshotText, frontmatterYaml }))\r\n      .digest(\"hex\");\r\n\r\n    // Dedupe: if we recently persisted the same snapshot, avoid inserting again.\r\n    // Only need last 5 messages  avoid full-file read.\r\n    const historyResult = await this.historyService.getLastMessages(this.workspaceId, 5);\r\n    if (historyResult.success) {\r\n      const recentSnapshot = [...historyResult.data]\r\n        .reverse()\r\n        .find((msg) => msg.metadata?.synthetic && msg.metadata?.agentSkillSnapshot);\r\n      const recentMeta = recentSnapshot?.metadata?.agentSkillSnapshot;\r\n\r\n      if (recentMeta?.skillName === skill.frontmatter.name && recentMeta.sha256 === sha256) {\r\n        return null;\r\n      }\r\n    }\r\n\r\n    const snapshotId = createAgentSkillSnapshotMessageId();\r\n    const snapshotMessage = createMuxMessage(snapshotId, \"user\", snapshotText, {\r\n      timestamp: Date.now(),\r\n      synthetic: true,\r\n      agentSkillSnapshot: {\r\n        skillName: skill.frontmatter.name,\r\n        scope: skill.scope,\r\n        sha256,\r\n        frontmatterYaml,\r\n      },\r\n    });\r\n\r\n    return { snapshotMessage };\r\n  }\r\n\r\n  /**\r\n   * Load excluded items from the exclusions file.\r\n   * Returns empty set if file doesn't exist or can't be read.\r\n   */\r\n  private async loadExcludedItems(): Promise<Set<string>> {\r\n    const exclusionsPath = path.join(\r\n      this.config.getSessionDir(this.workspaceId),\r\n      \"exclusions.json\"\r\n    );\r\n    try {\r\n      const data = await readFile(exclusionsPath, \"utf-8\");\r\n      const exclusions = JSON.parse(data) as PostCompactionExclusions;\r\n      return new Set(exclusions.excludedItems);\r\n    } catch {\r\n      return new Set();\r\n    }\r\n  }\r\n\r\n  private coerceTodoItems(value: unknown): TodoItem[] {\r\n    if (!Array.isArray(value)) {\r\n      return [];\r\n    }\r\n\r\n    const result: TodoItem[] = [];\r\n    for (const item of value) {\r\n      if (!item || typeof item !== \"object\") continue;\r\n\r\n      const content = (item as { content?: unknown }).content;\r\n      const status = (item as { status?: unknown }).status;\r\n\r\n      if (typeof content !== \"string\") continue;\r\n      if (status !== \"pending\" && status !== \"in_progress\" && status !== \"completed\") continue;\r\n\r\n      result.push({ content, status });\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  private async loadTodoListAttachment(\r\n    excludedItems: Set<string>\r\n  ): Promise<PostCompactionAttachment | null> {\r\n    if (excludedItems.has(\"todo\")) {\r\n      return null;\r\n    }\r\n\r\n    const todoPath = path.join(this.config.getSessionDir(this.workspaceId), \"todos.json\");\r\n\r\n    try {\r\n      const data = await readFile(todoPath, \"utf-8\");\r\n      const parsed: unknown = JSON.parse(data);\r\n      const todos = this.coerceTodoItems(parsed);\r\n      if (todos.length === 0) {\r\n        return null;\r\n      }\r\n\r\n      return {\r\n        type: \"todo_list\",\r\n        todos,\r\n      };\r\n    } catch {\r\n      // File missing or unreadable\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /** Delegate to FileChangeTracker for external file change detection. */\r\n  async getChangedFileAttachments(): Promise<EditedFileAttachment[]> {\r\n    return this.fileChangeTracker.getChangedAttachments();\r\n  }\r\n\r\n  /**\r\n   * Peek at cached file paths from pending compaction.\r\n   * Returns paths that will be reinjected, or null if no pending compaction.\r\n   */\r\n  getPendingTrackedFilePaths(): string[] | null {\r\n    return this.compactionHandler.peekCachedFilePaths();\r\n  }\r\n\r\n  private assertNotDisposed(operation: string): void {\r\n    assert(!this.disposed, `AgentSession.${operation} called after dispose`);\r\n  }\r\n}\r\n"]}