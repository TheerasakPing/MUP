{"version":3,"file":"policyService.test.js","sourceRoot":"","sources":["../../../src/node/services/policyService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { afterEach, beforeEach, describe, expect, test } from \"bun:test\";\r\nimport { createServer } from \"node:http\";\r\nimport { mkdtemp, rm, writeFile } from \"node:fs/promises\";\r\nimport { tmpdir } from \"node:os\";\r\nimport * as path from \"node:path\";\r\nimport { Config } from \"@/node/config\";\r\nimport { PolicyService } from \"./policyService\";\r\n\r\nconst PREFIX = \"mux-policy-service-test-\";\r\n\r\ndescribe(\"PolicyService\", () => {\r\n  let tempDir: string;\r\n  let policyPath: string;\r\n  let config: Config;\r\n  let prevPolicyFileEnv: string | undefined;\r\n\r\n  beforeEach(async () => {\r\n    tempDir = await mkdtemp(path.join(tmpdir(), PREFIX));\r\n    policyPath = path.join(tempDir, \"policy.json\");\r\n    config = new Config(tempDir);\r\n    prevPolicyFileEnv = process.env.MUX_POLICY_FILE;\r\n  });\r\n\r\n  afterEach(async () => {\r\n    if (prevPolicyFileEnv === undefined) {\r\n      delete process.env.MUX_POLICY_FILE;\r\n    } else {\r\n      process.env.MUX_POLICY_FILE = prevPolicyFileEnv;\r\n    }\r\n\r\n    await rm(tempDir, { recursive: true, force: true });\r\n  });\r\n\r\n  test(\"disabled when MUX_POLICY_FILE is unset\", async () => {\r\n    delete process.env.MUX_POLICY_FILE;\r\n\r\n    const service = new PolicyService(config);\r\n    await service.initialize();\r\n    expect(service.getStatus()).toEqual({ state: \"disabled\" });\r\n    expect(service.getEffectivePolicy()).toBeNull();\r\n    service.dispose();\r\n  });\r\n\r\n  test(\"blocks startup when policy file fails to parse\", async () => {\r\n    await writeFile(policyPath, '{\"policy_format_version\":\"0.1\",', \"utf-8\");\r\n    process.env.MUX_POLICY_FILE = policyPath;\r\n\r\n    const service = new PolicyService(config);\r\n    await service.initialize();\r\n\r\n    const status = service.getStatus();\r\n    expect(status.state).toBe(\"blocked\");\r\n    if (status.state === \"blocked\") {\r\n      expect(status.reason).toContain(\"Failed to load policy\");\r\n    }\r\n\r\n    service.dispose();\r\n  });\r\n\r\n  test(\"blocks startup when minimum_client_version is higher than client\", async () => {\r\n    await writeFile(\r\n      policyPath,\r\n      JSON.stringify({\r\n        policy_format_version: \"0.1\",\r\n        minimum_client_version: \"9999.0.0\",\r\n      }),\r\n      \"utf-8\"\r\n    );\r\n    process.env.MUX_POLICY_FILE = policyPath;\r\n\r\n    const service = new PolicyService(config);\r\n    await service.initialize();\r\n\r\n    const status = service.getStatus();\r\n    expect(status.state).toBe(\"blocked\");\r\n    if (status.state === \"blocked\") {\r\n      expect(status.reason).toContain(\"minimum_client_version\");\r\n    }\r\n\r\n    service.dispose();\r\n  });\r\n\r\n  test(\"enforces provider_access model_access allowlist when non-empty\", async () => {\r\n    await writeFile(\r\n      policyPath,\r\n      JSON.stringify({\r\n        policy_format_version: \"0.1\",\r\n        provider_access: [{ id: \"openai\", model_access: [\"gpt-4\"] }],\r\n      }),\r\n      \"utf-8\"\r\n    );\r\n    process.env.MUX_POLICY_FILE = policyPath;\r\n\r\n    const service = new PolicyService(config);\r\n    await service.initialize();\r\n\r\n    expect(service.isEnforced()).toBe(true);\r\n    expect(service.isProviderAllowed(\"openai\")).toBe(true);\r\n    expect(service.isProviderAllowed(\"anthropic\")).toBe(false);\r\n    expect(service.isModelAllowed(\"openai\", \"gpt-4\")).toBe(true);\r\n    expect(service.isModelAllowed(\"openai\", \"gpt-3.5\")).toBe(false);\r\n\r\n    service.dispose();\r\n  });\r\n\r\n  test(\"treats empty model_access as allow-all for that provider\", async () => {\r\n    await writeFile(\r\n      policyPath,\r\n      JSON.stringify({\r\n        policy_format_version: \"0.1\",\r\n        provider_access: [{ id: \"openai\", model_access: [] }],\r\n      }),\r\n      \"utf-8\"\r\n    );\r\n    process.env.MUX_POLICY_FILE = policyPath;\r\n\r\n    const service = new PolicyService(config);\r\n    await service.initialize();\r\n\r\n    expect(service.isEnforced()).toBe(true);\r\n    expect(service.isModelAllowed(\"openai\", \"gpt-4\")).toBe(true);\r\n    expect(service.isModelAllowed(\"openai\", \"gpt-3.5\")).toBe(true);\r\n\r\n    service.dispose();\r\n  });\r\n\r\n  test(\"loads policy from a remote URI\", async () => {\r\n    const policy = {\r\n      policy_format_version: \"0.1\",\r\n      provider_access: [{ id: \"openai\", model_access: [\"gpt-4\"] }],\r\n    };\r\n\r\n    const server = createServer((_req, res) => {\r\n      res.writeHead(200, {\r\n        \"content-type\": \"application/json\",\r\n      });\r\n      res.end(JSON.stringify(policy));\r\n    });\r\n\r\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\r\n\r\n    try {\r\n      const address = server.address();\r\n      if (!address || typeof address === \"string\") {\r\n        throw new Error(\"Failed to bind test server\");\r\n      }\r\n\r\n      process.env.MUX_POLICY_FILE = `http://127.0.0.1:${address.port}/policy.json`;\r\n\r\n      const service = new PolicyService(config);\r\n      await service.initialize();\r\n\r\n      expect(service.isEnforced()).toBe(true);\r\n      expect(service.isProviderAllowed(\"openai\")).toBe(true);\r\n      expect(service.isModelAllowed(\"openai\", \"gpt-4\")).toBe(true);\r\n      expect(service.isModelAllowed(\"openai\", \"gpt-3.5\")).toBe(false);\r\n\r\n      service.dispose();\r\n    } finally {\r\n      await new Promise<void>((resolve) => server.close(() => resolve()));\r\n    }\r\n  });\r\n\r\n  test(\"loads policy from Governor when enrolled\", async () => {\r\n    delete process.env.MUX_POLICY_FILE;\r\n\r\n    const token = \"governor-test-token\";\r\n    const policy = {\r\n      policy_format_version: \"0.1\",\r\n      provider_access: [{ id: \"openai\", model_access: [\"gpt-4\"] }],\r\n    };\r\n\r\n    let receivedAuth: string | undefined;\r\n\r\n    const server = createServer((req, res) => {\r\n      receivedAuth = req.headers[\"mux-governor-session-token\"] as string | undefined;\r\n\r\n      if (req.url !== \"/api/v1/policy.json\") {\r\n        res.writeHead(404);\r\n        res.end(\"Not found\");\r\n        return;\r\n      }\r\n\r\n      if (req.headers[\"mux-governor-session-token\"] !== token) {\r\n        res.writeHead(401);\r\n        res.end(\"Unauthorized\");\r\n        return;\r\n      }\r\n\r\n      res.writeHead(200, {\r\n        \"content-type\": \"application/json\",\r\n      });\r\n      res.end(JSON.stringify(policy));\r\n    });\r\n\r\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\r\n\r\n    try {\r\n      const address = server.address();\r\n      if (!address || typeof address === \"string\") {\r\n        throw new Error(\"Failed to bind test server\");\r\n      }\r\n\r\n      const governorOrigin = `http://127.0.0.1:${address.port}`;\r\n      await config.editConfig((existing) => ({\r\n        ...existing,\r\n        muxGovernorUrl: governorOrigin,\r\n        muxGovernorToken: token,\r\n      }));\r\n\r\n      const service = new PolicyService(config);\r\n      await service.initialize();\r\n\r\n      expect(service.getPolicyGetResponse().source).toBe(\"governor\");\r\n      expect(service.isEnforced()).toBe(true);\r\n      expect(service.isProviderAllowed(\"openai\")).toBe(true);\r\n      expect(service.isProviderAllowed(\"anthropic\")).toBe(false);\r\n      expect(receivedAuth).toBe(token);\r\n\r\n      service.dispose();\r\n    } finally {\r\n      await new Promise<void>((resolve) => server.close(() => resolve()));\r\n    }\r\n  });\r\n\r\n  test(\"MUX_POLICY_FILE takes precedence over Governor enrollment\", async () => {\r\n    const token = \"governor-test-token\";\r\n    const policy = {\r\n      policy_format_version: \"0.1\",\r\n      provider_access: [{ id: \"anthropic\", model_access: [\"claude-3\"] }],\r\n    };\r\n\r\n    let requestCount = 0;\r\n\r\n    const server = createServer((req, res) => {\r\n      requestCount += 1;\r\n\r\n      if (req.url !== \"/api/v1/policy.json\") {\r\n        res.writeHead(404);\r\n        res.end(\"Not found\");\r\n        return;\r\n      }\r\n\r\n      res.writeHead(200, {\r\n        \"content-type\": \"application/json\",\r\n      });\r\n      res.end(JSON.stringify(policy));\r\n    });\r\n\r\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\r\n\r\n    try {\r\n      const address = server.address();\r\n      if (!address || typeof address === \"string\") {\r\n        throw new Error(\"Failed to bind test server\");\r\n      }\r\n\r\n      const governorOrigin = `http://127.0.0.1:${address.port}`;\r\n      await config.editConfig((existing) => ({\r\n        ...existing,\r\n        muxGovernorUrl: governorOrigin,\r\n        muxGovernorToken: token,\r\n      }));\r\n\r\n      await writeFile(\r\n        policyPath,\r\n        JSON.stringify({\r\n          policy_format_version: \"0.1\",\r\n          provider_access: [{ id: \"openai\", model_access: [\"gpt-4\"] }],\r\n        }),\r\n        \"utf-8\"\r\n      );\r\n      process.env.MUX_POLICY_FILE = policyPath;\r\n\r\n      const service = new PolicyService(config);\r\n      await service.initialize();\r\n\r\n      expect(service.getPolicyGetResponse().source).toBe(\"env\");\r\n      expect(service.isEnforced()).toBe(true);\r\n      expect(service.isProviderAllowed(\"openai\")).toBe(true);\r\n      expect(service.isProviderAllowed(\"anthropic\")).toBe(false);\r\n      expect(requestCount).toBe(0);\r\n\r\n      service.dispose();\r\n    } finally {\r\n      await new Promise<void>((resolve) => server.close(() => resolve()));\r\n    }\r\n  });\r\n\r\n  test(\"refreshNow returns Err on Governor errors and keeps last-known-good\", async () => {\r\n    delete process.env.MUX_POLICY_FILE;\r\n\r\n    const token = \"governor-test-token\";\r\n    const policy = {\r\n      policy_format_version: \"0.1\",\r\n      provider_access: [{ id: \"openai\", model_access: [\"gpt-4\"] }],\r\n    };\r\n\r\n    let mode: \"ok\" | \"error\" = \"ok\";\r\n\r\n    const server = createServer((req, res) => {\r\n      if (req.url !== \"/api/v1/policy.json\") {\r\n        res.writeHead(404);\r\n        res.end(\"Not found\");\r\n        return;\r\n      }\r\n\r\n      if (mode === \"error\") {\r\n        res.writeHead(500);\r\n        res.end(\"boom\");\r\n        return;\r\n      }\r\n\r\n      res.writeHead(200, {\r\n        \"content-type\": \"application/json\",\r\n      });\r\n      res.end(JSON.stringify(policy));\r\n    });\r\n\r\n    await new Promise<void>((resolve) => server.listen(0, \"127.0.0.1\", resolve));\r\n\r\n    try {\r\n      const address = server.address();\r\n      if (!address || typeof address === \"string\") {\r\n        throw new Error(\"Failed to bind test server\");\r\n      }\r\n\r\n      const governorOrigin = `http://127.0.0.1:${address.port}`;\r\n      await config.editConfig((existing) => ({\r\n        ...existing,\r\n        muxGovernorUrl: governorOrigin,\r\n        muxGovernorToken: token,\r\n      }));\r\n\r\n      const service = new PolicyService(config);\r\n      await service.initialize();\r\n\r\n      expect(service.getPolicyGetResponse().source).toBe(\"governor\");\r\n      expect(service.isEnforced()).toBe(true);\r\n\r\n      mode = \"error\";\r\n\r\n      const refresh = await service.refreshNow();\r\n      expect(refresh.success).toBe(false);\r\n      if (!refresh.success) {\r\n        expect(refresh.error).toContain(\"HTTP 500\");\r\n      }\r\n\r\n      expect(service.isEnforced()).toBe(true);\r\n      expect(service.isProviderAllowed(\"openai\")).toBe(true);\r\n      expect(service.isModelAllowed(\"openai\", \"gpt-4\")).toBe(true);\r\n\r\n      service.dispose();\r\n    } finally {\r\n      await new Promise<void>((resolve) => server.close(() => resolve()));\r\n    }\r\n  });\r\n});\r\n"]}