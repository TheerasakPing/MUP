{"version":3,"file":"quickjsRuntime.js","sourceRoot":"","sources":["../../../../src/node/services/ptc/quickjsRuntime.ts"],"names":[],"mappings":";AAAA;;;;;GAKG;;;;;;AAEH,qEAIiC;AACjC,qEAA8E;AAC9E,oDAA4B;AAG5B,qDAA2D;AAE3D,iBAAiB;AACjB,MAAM,oBAAoB,GAAG,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC,CAAC,OAAO;AACtD,MAAM,kBAAkB,GAAG,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,YAAY;AAEtD,2EAA2E;AAC3E,SAAS,cAAc,GAAW;IAChC,OAAO,gBAAM,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;AAAA,CAC9C;AAED;;;GAGG;AACH;IAYuC,GAAG;IAXhC,QAAQ,GAAG,KAAK,CAAC;IACjB,YAAY,CAA6B;IACzC,eAAe,CAAmB;IAClC,cAAc,GAAG,KAAK,CAAC,CAAC,4CAA4C;IACpE,MAAM,GAAkB,EAAE,CAAC;IAC3B,YAAY,GAAG,KAAK,CAAC;IAE7B,mCAAmC;IAC3B,SAAS,GAAwB,EAAE,CAAC;IACpC,aAAa,GAAuB,EAAE,CAAC;IAE/C,YAAqC,GAAwB,EAAE;mBAA1B,GAAG;IAAwB,CAAC;IAEjE,MAAM,CAAC,KAAK,CAAC,MAAM,GAA4B;QAC7C,mFAAmF;QACnF,gFAAgF;QAChF,MAAM,OAAO,GAAG;YACd,IAAI,EAAE,OAAgB;YACtB,SAAS,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,qBAAe,CAAC;YACjD,kGAAkG;YAClG,kBAAkB,EAAE,KAAK,IAAI,EAAE,CAAC;gBAC9B,wEAAwE;gBACxE,qEAAqE;gBACrE,0GAA0G;gBAC1G,MAAM,GAAG,GAAG,OAAO,CAAC,2DAA2D,CAAC,CAAC;gBACjF,2GAA2G;gBAC3G,OAAO,GAAG,CAAC,OAAO,IAAI,GAAG,CAAC;YAAA,CAC3B;SACF,CAAC;QAEF,MAAM,OAAO,GAAG,MAAM,IAAA,8DAAoC,EAAC,OAAO,CAAC,CAAC;QACpE,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,EAAE,CAAC;QACjC,OAAO,IAAI,cAAc,CAAC,GAAG,CAAC,CAAC;IAAA,CAChC;IAED,SAAS,CAAC,MAAqB,EAAQ;QACrC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QAErB,oCAAoC;QACpC,MAAM,WAAW,GAAG,MAAM,CAAC,WAAW,IAAI,oBAAoB,CAAC;QAC/D,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;IAAA,CAC9C;IAED,OAAO,CAAC,OAAkC,EAAQ;QAChD,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC;IAAA,CAC7B;IAED,gBAAgB,CAAC,IAAY,EAAE,EAA4C,EAAQ;QACjF,IAAI,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC;QAE3C,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,qBAAqB,CAAC,IAAI,EAAE,KAAK,EAAE,GAAG,UAAU,EAAE,EAAE,CAAC;YAC3E,IAAI,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;gBACzC,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;YACvC,CAAC;YAED,6EAA6E;YAC7E,MAAM,IAAI,GAAc,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAY,CAAC,CAAC;YAC3E,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YAC7B,iFAAiF;YACjF,kFAAkF;YAClF,uDAAuD;YACvD,MAAM,MAAM,GAAG,cAAc,EAAE,CAAC;YAEhC,mBAAmB;YACnB,IAAI,CAAC,YAAY,EAAE,CAAC;gBAClB,IAAI,EAAE,iBAAiB;gBACvB,MAAM;gBACN,QAAQ,EAAE,IAAI;gBACd,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;gBACb,SAAS;aACV,CAAC,CAAC;YAEH,IAAI,CAAC;gBACH,MAAM,MAAM,GAAG,MAAM,EAAE,CAAC,GAAG,IAAI,CAAC,CAAC;gBACjC,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAC3B,MAAM,WAAW,GAAG,OAAO,GAAG,SAAS,CAAC;gBAExC,mBAAmB;gBACnB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;gBAE5E,iBAAiB;gBACjB,IAAI,CAAC,YAAY,EAAE,CAAC;oBAClB,IAAI,EAAE,eAAe;oBACrB,MAAM;oBACN,QAAQ,EAAE,IAAI;oBACd,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;oBACb,MAAM;oBACN,SAAS;oBACT,OAAO;iBACR,CAAC,CAAC;gBAEH,iCAAiC;gBACjC,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAC9B,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAC3B,MAAM,WAAW,GAAG,OAAO,GAAG,SAAS,CAAC;gBACxC,MAAM,QAAQ,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBAExE,0BAA0B;gBAC1B,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;oBAClB,QAAQ,EAAE,IAAI;oBACd,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;oBACb,KAAK,EAAE,QAAQ;oBACf,WAAW;iBACZ,CAAC,CAAC;gBAEH,4BAA4B;gBAC5B,IAAI,CAAC,YAAY,EAAE,CAAC;oBAClB,IAAI,EAAE,eAAe;oBACrB,MAAM;oBACN,QAAQ,EAAE,IAAI;oBACd,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;oBACb,KAAK,EAAE,QAAQ;oBACf,SAAS;oBACT,OAAO;iBACR,CAAC,CAAC;gBAEH,yCAAyC;gBACzC,MAAM,KAAK,CAAC;YACd,CAAC;QAAA,CACF,CAAC,CAAC;QAEH,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;QAChD,MAAM,CAAC,OAAO,EAAE,CAAC;IAAA,CAClB;IAED,cAAc,CACZ,IAAY,EACZ,GAA6D,EACvD;QACN,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,CAAC;QAEzC,2BAA2B;QAC3B,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC;QAEvC,KAAK,MAAM,CAAC,UAAU,EAAE,EAAE,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;YACnD,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,qBAAqB,CAAC,UAAU,EAAE,KAAK,EAAE,GAAG,UAAU,EAAE,EAAE,CAAC;gBACnF,IAAI,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;oBACzC,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;gBACvC,CAAC;gBAED,6EAA6E;gBAC7E,MAAM,IAAI,GAAc,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAY,CAAC,CAAC;gBAC3E,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAC7B,MAAM,MAAM,GAAG,cAAc,EAAE,CAAC;gBAEhC,mBAAmB;gBACnB,IAAI,CAAC,YAAY,EAAE,CAAC;oBAClB,IAAI,EAAE,iBAAiB;oBACvB,MAAM;oBACN,QAAQ,EAAE,UAAU;oBACpB,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;oBACb,SAAS;iBACV,CAAC,CAAC;gBAEH,IAAI,CAAC;oBACH,MAAM,MAAM,GAAG,MAAM,EAAE,CAAC,GAAG,IAAI,CAAC,CAAC;oBACjC,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;oBAC3B,MAAM,WAAW,GAAG,OAAO,GAAG,SAAS,CAAC;oBAExC,mBAAmB;oBACnB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,UAAU,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;oBAElF,iBAAiB;oBACjB,IAAI,CAAC,YAAY,EAAE,CAAC;wBAClB,IAAI,EAAE,eAAe;wBACrB,MAAM;wBACN,QAAQ,EAAE,UAAU;wBACpB,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;wBACb,MAAM;wBACN,SAAS;wBACT,OAAO;qBACR,CAAC,CAAC;oBAEH,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAC9B,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;oBAC3B,MAAM,WAAW,GAAG,OAAO,GAAG,SAAS,CAAC;oBACxC,MAAM,QAAQ,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAExE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;wBAClB,QAAQ,EAAE,UAAU;wBACpB,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;wBACb,KAAK,EAAE,QAAQ;wBACf,WAAW;qBACZ,CAAC,CAAC;oBAEH,IAAI,CAAC,YAAY,EAAE,CAAC;wBAClB,IAAI,EAAE,eAAe;wBACrB,MAAM;wBACN,QAAQ,EAAE,UAAU;wBACpB,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;wBACb,KAAK,EAAE,QAAQ;wBACf,SAAS;wBACT,OAAO;qBACR,CAAC,CAAC;oBAEH,MAAM,KAAK,CAAC;gBACd,CAAC;YAAA,CACF,CAAC,CAAC;YAEH,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,UAAU,EAAE,QAAQ,CAAC,CAAC;YAClD,QAAQ,CAAC,OAAO,EAAE,CAAC;QACrB,CAAC;QAED,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,IAAI,EAAE,SAAS,CAAC,CAAC;QACnD,SAAS,CAAC,OAAO,EAAE,CAAC;IAAA,CACrB;IAED,KAAK,CAAC,IAAI,CAAC,IAAY,EAA+B;QACpD,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAC;QAE/B,MAAM,aAAa,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACjC,IAAI,CAAC,eAAe,GAAG,IAAI,eAAe,EAAE,CAAC;QAC7C,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;QACpB,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;QAExB,qDAAqD;QACrD,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;YACxB,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,CAAC;QAC/B,CAAC;QAED,uCAAuC;QACvC,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC;YACvB,IAAI,CAAC,YAAY,EAAE,CAAC;YACpB,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QAC3B,CAAC;QAED,wDAAwD;QACxD,MAAM,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,SAAS,IAAI,kBAAkB,CAAC;QAC9D,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;QAExC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,mBAAmB,CAAC,GAAG,EAAE,CAAC;YACzC,IAAI,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;gBACzC,OAAO,IAAI,CAAC,CAAC,sBAAsB;YACrC,CAAC;YACD,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,QAAQ,EAAE,CAAC;gBAC1B,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;gBAC9B,OAAO,IAAI,CAAC,CAAC,qCAAqC;YACpD,CAAC;YACD,OAAO,KAAK,CAAC,CAAC,qBAAqB;QAAtB,CACd,CAAC,CAAC;QAEH,uEAAuE;QACvE,+EAA+E;QAC/E,yEAAyE;QACzE,+EAA+E;QAC/E,MAAM,SAAS,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;YACjC,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;QAAA,CAC/B,EAAE,SAAS,CAAC,CAAC;QAEd,oDAAoD;QACpD,qEAAqE;QACrE,8EAA8E;QAC9E,MAAM,WAAW,GAAG,iBAAiB,IAAI,OAAO,CAAC;QAEjD,IAAI,CAAC;YACH,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC;YAE7D,IAAI,UAAU,CAAC,KAAK,EAAE,CAAC;gBACrB,MAAM,MAAM,GAAY,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAY,CAAC;gBACnE,UAAU,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;gBAE3B,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,aAAa,CAAC;gBAC/C,MAAM,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;gBAEvE,OAAO;oBACL,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,YAAY;oBACnB,SAAS,EAAE,IAAI,CAAC,SAAS;oBACzB,aAAa,EAAE,IAAI,CAAC,aAAa;oBACjC,WAAW;iBACZ,CAAC;YACJ,CAAC;YAED,6EAA6E;YAC7E,mEAAmE;YACnE,MAAM,KAAK,GAAY,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAY,CAAC;YAClE,UAAU,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;YAE3B,OAAO;gBACL,OAAO,EAAE,IAAI;gBACb,MAAM,EAAE,KAAK;gBACb,SAAS,EAAE,IAAI,CAAC,SAAS;gBACzB,aAAa,EAAE,IAAI,CAAC,aAAa;gBACjC,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,aAAa;aACxC,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,aAAa,CAAC;YAC/C,MAAM,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;YAEtE,OAAO;gBACL,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,YAAY;gBACnB,SAAS,EAAE,IAAI,CAAC,SAAS;gBACzB,aAAa,EAAE,IAAI,CAAC,aAAa;gBACjC,WAAW;aACZ,CAAC;QACJ,CAAC;gBAAS,CAAC;YACT,YAAY,CAAC,SAAS,CAAC,CAAC;QAC1B,CAAC;IAAA,CACF;IAED,KAAK,GAAS;QACZ,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC;QAC3B,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;IAAA,CAC/B;IAED,cAAc,GAA4B;QACxC,OAAO,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC;IAAA,CACrC;IAED,OAAO,GAAS;QACd,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;YACnB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACvB,CAAC;IAAA,CACF;IAED,CAAC,MAAM,CAAC,OAAO,CAAC,GAAS;QACvB,IAAI,CAAC,OAAO,EAAE,CAAC;IAAA,CAChB;IAED,0BAA0B;IAElB,iBAAiB,CAAC,MAAc,EAAQ;QAC9C,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAClB,MAAM,IAAI,KAAK,CAAC,eAAe,MAAM,6BAA6B,CAAC,CAAC;QACtE,CAAC;IAAA,CACF;IAED;;OAEG;IACK,WAAW,CAAC,QAAiB,EAAU;QAC7C,IAAI,OAAO,QAAQ,KAAK,QAAQ,IAAI,QAAQ,KAAK,IAAI,EAAE,CAAC;YACtD,MAAM,GAAG,GAAG,QAA+D,CAAC;YAC5E,IAAI,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;gBAC5B,OAAO,GAAG,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,OAAO,EAAE,CAAC;YACvC,CAAC;YACD,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;gBAChB,OAAO,GAAG,CAAC,OAAO,CAAC;YACrB,CAAC;QACH,CAAC;QACD,OAAO,MAAM,CAAC,QAAQ,CAAC,CAAC;IAAA,CACzB;IAED;;;OAGG;IACK,eAAe,CAAC,QAAiB,EAAE,QAAgB,EAAE,SAAiB,EAAU;QACtF,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC,OAAO,CAAC;QACvD,MAAM,UAAU,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,QAAQ,CAAC;QAEzC,IAAI,SAAS,IAAI,UAAU,EAAE,CAAC;YAC5B,OAAO,sBAAsB,SAAS,cAAc,CAAC;QACvD,CAAC;QACD,IAAI,SAAS,EAAE,CAAC;YACd,OAAO,mBAAmB,CAAC;QAC7B,CAAC;QAED,oCAAoC;QACpC,MAAM,SAAS,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QAC7C,IAAI,SAAS,CAAC,QAAQ,CAAC,aAAa,CAAC,EAAE,CAAC;YACtC,IAAI,UAAU,EAAE,CAAC;gBACf,OAAO,sBAAsB,SAAS,cAAc,CAAC;YACvD,CAAC;YACD,OAAO,uBAAuB,CAAC;QACjC,CAAC;QAED,qDAAqD;QACrD,MAAM,aAAa,GAAG,0CAA0C,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QACjF,IAAI,aAAa,EAAE,CAAC;YAClB,MAAM,UAAU,GAAG,aAAa,CAAC,CAAC,CAAC,CAAC;YACpC,IAAI,wCAAuB,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC;gBAC5C,OAAO,IAAI,UAAU,wEAAwE,CAAC;YAChG,CAAC;QACH,CAAC;QAED,OAAO,SAAS,CAAC;IAAA,CAClB;IAED;;OAEG;IACK,YAAY,GAAS;QAC3B,MAAM,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC;QAExC,KAAK,MAAM,KAAK,IAAI,CAAC,KAAK,EAAE,MAAM,EAAE,OAAO,CAAU,EAAE,CAAC;YACtD,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC,GAAG,UAAU,EAAE,EAAE,CAAC;gBACxD,MAAM,IAAI,GAAc,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAY,CAAC,CAAC;gBAC3E,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAE7B,wBAAwB;gBACxB,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAC;gBAEpD,qBAAqB;gBACrB,IAAI,CAAC,YAAY,EAAE,CAAC;oBAClB,IAAI,EAAE,SAAS;oBACf,KAAK;oBACL,IAAI;oBACJ,SAAS;iBACV,CAAC,CAAC;YAAA,CACJ,CAAC,CAAC;YACH,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,UAAU,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;YACxC,EAAE,CAAC,OAAO,EAAE,CAAC;QACf,CAAC;QAED,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,SAAS,EAAE,UAAU,CAAC,CAAC;QACzD,UAAU,CAAC,OAAO,EAAE,CAAC;IAAA,CACtB;IAED;;;;;;;;OAQG;IACK,OAAO,CAAC,KAAc,EAAE,IAAI,GAAG,IAAI,OAAO,EAAU,EAAiB;QAC3E,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;YACxB,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC;QAC5B,CAAC;QACD,IAAI,KAAK,KAAK,IAAI,EAAE,CAAC;YACnB,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC;QACvB,CAAC;QACD,IAAI,OAAO,KAAK,KAAK,SAAS,EAAE,CAAC;YAC/B,OAAO,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC;QAChD,CAAC;QACD,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YAC9B,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACnC,CAAC;QACD,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YAC9B,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACnC,CAAC;QACD,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YAC9B,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACnC,CAAC;QAED,oEAAoE;QACpE,IAAI,OAAO,KAAK,KAAK,UAAU,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YAC7D,OAAO,IAAI,CAAC,aAAa,CAAC,EAAE,kBAAkB,EAAE,OAAO,KAAK,EAAE,EAAE,IAAI,CAAC,CAAC;QACxE,CAAC;QAED,gEAAgE;QAChE,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YAC9B,wDAAsD;YACtD,IAAI,KAAK,YAAY,IAAI,EAAE,CAAC;gBAC1B,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC;YACjD,CAAC;YAED,wEAAwE;YACxE,yEAAyE;YACzE,8DAA8D;YAC9D,IAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC;gBACpB,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC;YAC1C,CAAC;YACD,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAEhB,IAAI,CAAC;gBACH,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC;oBACzB,OAAO,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;gBACxC,CAAC;gBACD,OAAO,IAAI,CAAC,aAAa,CAAC,KAAgC,EAAE,IAAI,CAAC,CAAC;YACpE,CAAC;oBAAS,CAAC;gBACT,mEAAmE;gBACnE,yDAAyD;gBACzD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YACrB,CAAC;QACH,CAAC;QAED,mDAAmD;QACnD,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC;IAAA,CAC3B;IAEO,YAAY,CAAC,GAAc,EAAE,IAAqB,EAAiB;QACzE,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;QACnC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACpC,MAAM,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;YACxC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,EAAE,IAAI,CAAC,CAAC;YAClC,IAAI,CAAC,OAAO,EAAE,CAAC;QACjB,CAAC;QACD,OAAO,MAAM,CAAC;IAAA,CACf;IAEO,aAAa,CAAC,GAA4B,EAAE,IAAqB,EAAiB;QACxF,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC;QACpC,KAAK,MAAM,CAAC,GAAG,EAAE,GAAG,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;YAC7C,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;YAC1C,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,MAAM,EAAE,GAAG,EAAE,SAAS,CAAC,CAAC;YACzC,SAAS,CAAC,OAAO,EAAE,CAAC;QACtB,CAAC;QACD,OAAO,MAAM,CAAC;IAAA,CACf;CACF;;AAED;;GAEG;AACH;IACE,KAAK,CAAC,MAAM,GAA4B;QACtC,OAAO,cAAc,CAAC,MAAM,EAAE,CAAC;IAAA,CAChC;CACF","sourcesContent":["/**\r\n * QuickJS Runtime Implementation\r\n *\r\n * Implements IJSRuntime using quickjs-emscripten for sandboxed JavaScript execution.\r\n * Uses Asyncify to allow async host functions to appear synchronous in the sandbox.\r\n */\r\n\r\nimport {\r\n  newQuickJSAsyncWASMModuleFromVariant,\r\n  type QuickJSAsyncContext,\r\n  type QuickJSHandle,\r\n} from \"quickjs-emscripten-core\";\r\nimport { QuickJSAsyncFFI } from \"@jitl/quickjs-wasmfile-release-asyncify/ffi\";\r\nimport crypto from \"crypto\";\r\nimport type { IJSRuntime, IJSRuntimeFactory, RuntimeLimits } from \"./runtime\";\r\nimport type { PTCEvent, PTCExecutionResult, PTCToolCallRecord, PTCConsoleRecord } from \"./types\";\r\nimport { UNAVAILABLE_IDENTIFIERS } from \"./staticAnalysis\";\r\n\r\n// Default limits\r\nconst DEFAULT_MEMORY_BYTES = 64 * 1024 * 1024; // 64MB\r\nconst DEFAULT_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes\r\n\r\n/** Generate a short random ID for PTC nested tool calls (10 hex chars). */\r\nfunction generateCallId(): string {\r\n  return crypto.randomBytes(5).toString(\"hex\");\r\n}\r\n\r\n/**\r\n * QuickJS-based JavaScript runtime for PTC.\r\n * Uses Asyncify build for async host function support.\r\n */\r\nexport class QuickJSRuntime implements IJSRuntime {\r\n  private disposed = false;\r\n  private eventHandler?: (event: PTCEvent) => void;\r\n  private abortController?: AbortController;\r\n  private abortRequested = false; // Track abort requests before eval() starts\r\n  private limits: RuntimeLimits = {};\r\n  private consoleSetup = false;\r\n\r\n  // Execution state (reset per eval)\r\n  private toolCalls: PTCToolCallRecord[] = [];\r\n  private consoleOutput: PTCConsoleRecord[] = [];\r\n\r\n  private constructor(private readonly ctx: QuickJSAsyncContext) {}\r\n\r\n  static async create(): Promise<QuickJSRuntime> {\r\n    // Create the async variant manually due to bun's package export resolution issues.\r\n    // The self-referential import in the variant package doesn't resolve correctly.\r\n    const variant = {\r\n      type: \"async\" as const,\r\n      importFFI: () => Promise.resolve(QuickJSAsyncFFI),\r\n      // eslint-disable-next-line @typescript-eslint/require-await -- sync require wrapped for interface\r\n      importModuleLoader: async () => {\r\n        // Use require() with the named export path since bun's dynamic import()\r\n        // doesn't resolve package exports correctly from within node_modules\r\n        // eslint-disable-next-line @typescript-eslint/no-require-imports, @typescript-eslint/no-unsafe-assignment\r\n        const mod = require(\"@jitl/quickjs-wasmfile-release-asyncify/emscripten-module\");\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\r\n        return mod.default ?? mod;\r\n      },\r\n    };\r\n\r\n    const QuickJS = await newQuickJSAsyncWASMModuleFromVariant(variant);\r\n    const ctx = QuickJS.newContext();\r\n    return new QuickJSRuntime(ctx);\r\n  }\r\n\r\n  setLimits(limits: RuntimeLimits): void {\r\n    this.limits = limits;\r\n\r\n    // Apply memory limit to the runtime\r\n    const memoryBytes = limits.memoryBytes ?? DEFAULT_MEMORY_BYTES;\r\n    this.ctx.runtime.setMemoryLimit(memoryBytes);\r\n  }\r\n\r\n  onEvent(handler: (event: PTCEvent) => void): void {\r\n    this.eventHandler = handler;\r\n  }\r\n\r\n  registerFunction(name: string, fn: (...args: unknown[]) => Promise<unknown>): void {\r\n    this.assertNotDisposed(\"registerFunction\");\r\n\r\n    const handle = this.ctx.newAsyncifiedFunction(name, async (...argHandles) => {\r\n      if (this.abortController?.signal.aborted) {\r\n        throw new Error(\"Execution aborted\");\r\n      }\r\n\r\n      // Convert QuickJS handles to JS values - cast to unknown at the FFI boundary\r\n      const args: unknown[] = argHandles.map((h) => this.ctx.dump(h) as unknown);\r\n      const startTime = Date.now();\r\n      // Generate our own callId for nested tool calls. Regular tool calls get IDs from\r\n      // the model (e.g. Anthropic's toolu_*, OpenAI's call_*), but PTC nested calls are\r\n      // executed in our sandbox, not requested by the model.\r\n      const callId = generateCallId();\r\n\r\n      // Emit start event\r\n      this.eventHandler?.({\r\n        type: \"tool-call-start\",\r\n        callId,\r\n        toolName: name,\r\n        args: args[0],\r\n        startTime,\r\n      });\r\n\r\n      try {\r\n        const result = await fn(...args);\r\n        const endTime = Date.now();\r\n        const duration_ms = endTime - startTime;\r\n\r\n        // Record tool call\r\n        this.toolCalls.push({ toolName: name, args: args[0], result, duration_ms });\r\n\r\n        // Emit end event\r\n        this.eventHandler?.({\r\n          type: \"tool-call-end\",\r\n          callId,\r\n          toolName: name,\r\n          args: args[0],\r\n          result,\r\n          startTime,\r\n          endTime,\r\n        });\r\n\r\n        // Marshal result back to QuickJS\r\n        return this.marshal(result);\r\n      } catch (error) {\r\n        const endTime = Date.now();\r\n        const duration_ms = endTime - startTime;\r\n        const errorStr = error instanceof Error ? error.message : String(error);\r\n\r\n        // Record failed tool call\r\n        this.toolCalls.push({\r\n          toolName: name,\r\n          args: args[0],\r\n          error: errorStr,\r\n          duration_ms,\r\n        });\r\n\r\n        // Emit end event with error\r\n        this.eventHandler?.({\r\n          type: \"tool-call-end\",\r\n          callId,\r\n          toolName: name,\r\n          args: args[0],\r\n          error: errorStr,\r\n          startTime,\r\n          endTime,\r\n        });\r\n\r\n        // Re-throw to propagate error to sandbox\r\n        throw error;\r\n      }\r\n    });\r\n\r\n    this.ctx.setProp(this.ctx.global, name, handle);\r\n    handle.dispose();\r\n  }\r\n\r\n  registerObject(\r\n    name: string,\r\n    obj: Record<string, (...args: unknown[]) => Promise<unknown>>\r\n  ): void {\r\n    this.assertNotDisposed(\"registerObject\");\r\n\r\n    // Create object in QuickJS\r\n    const objHandle = this.ctx.newObject();\r\n\r\n    for (const [methodName, fn] of Object.entries(obj)) {\r\n      const fnHandle = this.ctx.newAsyncifiedFunction(methodName, async (...argHandles) => {\r\n        if (this.abortController?.signal.aborted) {\r\n          throw new Error(\"Execution aborted\");\r\n        }\r\n\r\n        // Convert QuickJS handles to JS values - cast to unknown at the FFI boundary\r\n        const args: unknown[] = argHandles.map((h) => this.ctx.dump(h) as unknown);\r\n        const startTime = Date.now();\r\n        const callId = generateCallId();\r\n\r\n        // Emit start event\r\n        this.eventHandler?.({\r\n          type: \"tool-call-start\",\r\n          callId,\r\n          toolName: methodName,\r\n          args: args[0],\r\n          startTime,\r\n        });\r\n\r\n        try {\r\n          const result = await fn(...args);\r\n          const endTime = Date.now();\r\n          const duration_ms = endTime - startTime;\r\n\r\n          // Record tool call\r\n          this.toolCalls.push({ toolName: methodName, args: args[0], result, duration_ms });\r\n\r\n          // Emit end event\r\n          this.eventHandler?.({\r\n            type: \"tool-call-end\",\r\n            callId,\r\n            toolName: methodName,\r\n            args: args[0],\r\n            result,\r\n            startTime,\r\n            endTime,\r\n          });\r\n\r\n          return this.marshal(result);\r\n        } catch (error) {\r\n          const endTime = Date.now();\r\n          const duration_ms = endTime - startTime;\r\n          const errorStr = error instanceof Error ? error.message : String(error);\r\n\r\n          this.toolCalls.push({\r\n            toolName: methodName,\r\n            args: args[0],\r\n            error: errorStr,\r\n            duration_ms,\r\n          });\r\n\r\n          this.eventHandler?.({\r\n            type: \"tool-call-end\",\r\n            callId,\r\n            toolName: methodName,\r\n            args: args[0],\r\n            error: errorStr,\r\n            startTime,\r\n            endTime,\r\n          });\r\n\r\n          throw error;\r\n        }\r\n      });\r\n\r\n      this.ctx.setProp(objHandle, methodName, fnHandle);\r\n      fnHandle.dispose();\r\n    }\r\n\r\n    this.ctx.setProp(this.ctx.global, name, objHandle);\r\n    objHandle.dispose();\r\n  }\r\n\r\n  async eval(code: string): Promise<PTCExecutionResult> {\r\n    this.assertNotDisposed(\"eval\");\r\n\r\n    const execStartTime = Date.now();\r\n    this.abortController = new AbortController();\r\n    this.toolCalls = [];\r\n    this.consoleOutput = [];\r\n\r\n    // Honor abort requests made before eval() was called\r\n    if (this.abortRequested) {\r\n      this.abortController.abort();\r\n    }\r\n\r\n    // Set up console capturing (only once)\r\n    if (!this.consoleSetup) {\r\n      this.setupConsole();\r\n      this.consoleSetup = true;\r\n    }\r\n\r\n    // Set up interrupt handler for cancellation and timeout\r\n    const timeoutMs = this.limits.timeoutMs ?? DEFAULT_TIMEOUT_MS;\r\n    const deadline = Date.now() + timeoutMs;\r\n\r\n    this.ctx.runtime.setInterruptHandler(() => {\r\n      if (this.abortController?.signal.aborted) {\r\n        return true; // Interrupt execution\r\n      }\r\n      if (Date.now() > deadline) {\r\n        this.abortController?.abort();\r\n        return true; // Interrupt execution due to timeout\r\n      }\r\n      return false; // Continue execution\r\n    });\r\n\r\n    // Set up a real timeout timer that fires even during async suspension.\r\n    // The interrupt handler only runs during QuickJS execution, but when suspended\r\n    // waiting for an async host function (e.g., mux.bash()), it never fires.\r\n    // This timer ensures nested tools are cancelled when the deadline is exceeded.\r\n    const timeoutId = setTimeout(() => {\r\n      this.abortController?.abort();\r\n    }, timeoutMs);\r\n\r\n    // Wrap code in function to allow return statements.\r\n    // With asyncify, async host functions appear synchronous to QuickJS,\r\n    // so we don't need an async IIFE. Using evalCodeAsync handles the suspension.\r\n    const wrappedCode = `(function() { ${code} })()`;\r\n\r\n    try {\r\n      const evalResult = await this.ctx.evalCodeAsync(wrappedCode);\r\n\r\n      if (evalResult.error) {\r\n        const errObj: unknown = this.ctx.dump(evalResult.error) as unknown;\r\n        evalResult.error.dispose();\r\n\r\n        const duration_ms = Date.now() - execStartTime;\r\n        const errorMessage = this.getErrorMessage(errObj, deadline, timeoutMs);\r\n\r\n        return {\r\n          success: false,\r\n          error: errorMessage,\r\n          toolCalls: this.toolCalls,\r\n          consoleOutput: this.consoleOutput,\r\n          duration_ms,\r\n        };\r\n      }\r\n\r\n      // With asyncify, evalCodeAsync suspends until async host functions complete.\r\n      // The result is already resolved - no need to resolve the promise.\r\n      const value: unknown = this.ctx.dump(evalResult.value) as unknown;\r\n      evalResult.value.dispose();\r\n\r\n      return {\r\n        success: true,\r\n        result: value,\r\n        toolCalls: this.toolCalls,\r\n        consoleOutput: this.consoleOutput,\r\n        duration_ms: Date.now() - execStartTime,\r\n      };\r\n    } catch (error) {\r\n      const duration_ms = Date.now() - execStartTime;\r\n      const errorMessage = this.getErrorMessage(error, deadline, timeoutMs);\r\n\r\n      return {\r\n        success: false,\r\n        error: errorMessage,\r\n        toolCalls: this.toolCalls,\r\n        consoleOutput: this.consoleOutput,\r\n        duration_ms,\r\n      };\r\n    } finally {\r\n      clearTimeout(timeoutId);\r\n    }\r\n  }\r\n\r\n  abort(): void {\r\n    this.abortRequested = true;\r\n    this.abortController?.abort();\r\n  }\r\n\r\n  getAbortSignal(): AbortSignal | undefined {\r\n    return this.abortController?.signal;\r\n  }\r\n\r\n  dispose(): void {\r\n    if (!this.disposed) {\r\n      this.ctx.dispose();\r\n      this.disposed = true;\r\n    }\r\n  }\r\n\r\n  [Symbol.dispose](): void {\r\n    this.dispose();\r\n  }\r\n\r\n  // --- Private helpers ---\r\n\r\n  private assertNotDisposed(method: string): void {\r\n    if (this.disposed) {\r\n      throw new Error(`Cannot call ${method} on disposed QuickJSRuntime`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Format a QuickJS error object into a readable error message.\r\n   */\r\n  private formatError(errorObj: unknown): string {\r\n    if (typeof errorObj === \"object\" && errorObj !== null) {\r\n      const err = errorObj as { name?: string; message?: string; stack?: string };\r\n      if (err.name && err.message) {\r\n        return `${err.name}: ${err.message}`;\r\n      }\r\n      if (err.message) {\r\n        return err.message;\r\n      }\r\n    }\r\n    return String(errorObj);\r\n  }\r\n\r\n  /**\r\n   * Get appropriate error message, checking for timeout/abort conditions.\r\n   * Also provides friendlier messages for common sandbox errors.\r\n   */\r\n  private getErrorMessage(errorObj: unknown, deadline: number, timeoutMs: number): string {\r\n    const isAborted = this.abortController?.signal.aborted;\r\n    const isTimedOut = Date.now() > deadline;\r\n\r\n    if (isAborted && isTimedOut) {\r\n      return `Execution timeout (${timeoutMs}ms exceeded)`;\r\n    }\r\n    if (isAborted) {\r\n      return \"Execution aborted\";\r\n    }\r\n\r\n    // Check for QuickJS interrupt error\r\n    const formatted = this.formatError(errorObj);\r\n    if (formatted.includes(\"interrupted\")) {\r\n      if (isTimedOut) {\r\n        return `Execution timeout (${timeoutMs}ms exceeded)`;\r\n      }\r\n      return \"Execution interrupted\";\r\n    }\r\n\r\n    // Provide friendlier message for unavailable globals\r\n    const refErrorMatch = /ReferenceError: '?(\\w+)'? is not defined/.exec(formatted);\r\n    if (refErrorMatch) {\r\n      const identifier = refErrorMatch[1];\r\n      if (UNAVAILABLE_IDENTIFIERS.has(identifier)) {\r\n        return `'${identifier}' is not available in the sandbox. Use mux.* tools for I/O operations.`;\r\n      }\r\n    }\r\n\r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Set up console.log/warn/error to capture output.\r\n   */\r\n  private setupConsole(): void {\r\n    const consoleObj = this.ctx.newObject();\r\n\r\n    for (const level of [\"log\", \"warn\", \"error\"] as const) {\r\n      const fn = this.ctx.newFunction(level, (...argHandles) => {\r\n        const args: unknown[] = argHandles.map((h) => this.ctx.dump(h) as unknown);\r\n        const timestamp = Date.now();\r\n\r\n        // Record console output\r\n        this.consoleOutput.push({ level, args, timestamp });\r\n\r\n        // Emit console event\r\n        this.eventHandler?.({\r\n          type: \"console\",\r\n          level,\r\n          args,\r\n          timestamp,\r\n        });\r\n      });\r\n      this.ctx.setProp(consoleObj, level, fn);\r\n      fn.dispose();\r\n    }\r\n\r\n    this.ctx.setProp(this.ctx.global, \"console\", consoleObj);\r\n    consoleObj.dispose();\r\n  }\r\n\r\n  /**\r\n   * Marshal a JavaScript value into a QuickJS handle.\r\n   *\r\n   * Recursively converts JS values to QuickJS handles with:\r\n   * - Cycle detection (circular refs become \"[Circular]\")\r\n   * - Native BigInt support\r\n   * - Preserved undefined in objects/arrays\r\n   * - Explicit markers for unserializable types (functions, symbols)\r\n   */\r\n  private marshal(value: unknown, seen = new WeakSet<object>()): QuickJSHandle {\r\n    if (value === undefined) {\r\n      return this.ctx.undefined;\r\n    }\r\n    if (value === null) {\r\n      return this.ctx.null;\r\n    }\r\n    if (typeof value === \"boolean\") {\r\n      return value ? this.ctx.true : this.ctx.false;\r\n    }\r\n    if (typeof value === \"number\") {\r\n      return this.ctx.newNumber(value);\r\n    }\r\n    if (typeof value === \"string\") {\r\n      return this.ctx.newString(value);\r\n    }\r\n    if (typeof value === \"bigint\") {\r\n      return this.ctx.newBigInt(value);\r\n    }\r\n\r\n    // Functions and symbols can't be marshaled - return explicit marker\r\n    if (typeof value === \"function\" || typeof value === \"symbol\") {\r\n      return this.marshalObject({ __unserializable__: typeof value }, seen);\r\n    }\r\n\r\n    // Objects and arrays - recursively marshal with cycle detection\r\n    if (typeof value === \"object\") {\r\n      // Date â†’ ISO string (matches JSON.stringify behavior)\r\n      if (value instanceof Date) {\r\n        return this.ctx.newString(value.toISOString());\r\n      }\r\n\r\n      // Check for circular reference - `seen` tracks current ancestors in the\r\n      // traversal path, not all visited objects. This correctly handles shared\r\n      // references (same object in multiple places) vs true cycles.\r\n      if (seen.has(value)) {\r\n        return this.ctx.newString(\"[Circular]\");\r\n      }\r\n      seen.add(value);\r\n\r\n      try {\r\n        if (Array.isArray(value)) {\r\n          return this.marshalArray(value, seen);\r\n        }\r\n        return this.marshalObject(value as Record<string, unknown>, seen);\r\n      } finally {\r\n        // Remove from path after processing - allows same object to appear\r\n        // in multiple non-circular positions (shared references)\r\n        seen.delete(value);\r\n      }\r\n    }\r\n\r\n    // Unknown type - shouldn't happen but be defensive\r\n    return this.ctx.undefined;\r\n  }\r\n\r\n  private marshalArray(arr: unknown[], seen: WeakSet<object>): QuickJSHandle {\r\n    const handle = this.ctx.newArray();\r\n    for (let i = 0; i < arr.length; i++) {\r\n      const elem = this.marshal(arr[i], seen);\r\n      this.ctx.setProp(handle, i, elem);\r\n      elem.dispose();\r\n    }\r\n    return handle;\r\n  }\r\n\r\n  private marshalObject(obj: Record<string, unknown>, seen: WeakSet<object>): QuickJSHandle {\r\n    const handle = this.ctx.newObject();\r\n    for (const [key, val] of Object.entries(obj)) {\r\n      const valHandle = this.marshal(val, seen);\r\n      this.ctx.setProp(handle, key, valHandle);\r\n      valHandle.dispose();\r\n    }\r\n    return handle;\r\n  }\r\n}\r\n\r\n/**\r\n * Factory for creating QuickJS runtime instances.\r\n */\r\nexport class QuickJSRuntimeFactory implements IJSRuntimeFactory {\r\n  async create(): Promise<QuickJSRuntime> {\r\n    return QuickJSRuntime.create();\r\n  }\r\n}\r\n"]}