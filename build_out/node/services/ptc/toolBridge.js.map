{"version":3,"file":"toolBridge.js","sourceRoot":"","sources":["../../../../src/node/services/ptc/toolBridge.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Tool Bridge for PTC\n *\n * Bridges Mux tools into the QuickJS sandbox, making them callable via `mux.*` namespace.\n * Handles argument validation via Zod schemas and result serialization.\n */\n\nimport type { Tool } from \"ai\";\nimport type { z } from \"zod\";\nimport type { IJSRuntime } from \"./runtime\";\n\n/** Tools excluded from sandbox - UI-specific or would cause recursion */\nconst EXCLUDED_TOOLS = new Set([\n  \"code_execution\", // Prevent recursive sandbox creation\n  \"ask_user_question\", // Requires UI interaction\n  \"propose_plan\", // Mode-specific, call directly\n  \"todo_write\", // UI-specific\n  \"todo_read\", // UI-specific\n  \"status_set\", // UI-specific\n  \"agent_report\", // Must be top-level for taskService to read args from history\n]);\n\n/**\n * Bridge that exposes Mux tools in the QuickJS sandbox under `mux.*` namespace.\n */\nexport class ToolBridge {\n  private readonly bridgeableTools: Map<string, Tool>;\n  private readonly nonBridgeableTools: Map<string, Tool>;\n\n  constructor(tools: Record<string, Tool>) {\n    this.bridgeableTools = new Map();\n    this.nonBridgeableTools = new Map();\n\n    for (const [name, tool] of Object.entries(tools)) {\n      // code_execution is the tool that uses the bridge, not a candidate for bridging\n      if (name === \"code_execution\") continue;\n\n      const isBridgeable = !EXCLUDED_TOOLS.has(name) && this.hasExecute(tool);\n      if (isBridgeable) {\n        this.bridgeableTools.set(name, tool);\n      } else {\n        this.nonBridgeableTools.set(name, tool);\n      }\n    }\n  }\n\n  /** Get list of tools that will be exposed in sandbox */\n  getBridgeableToolNames(): string[] {\n    return Array.from(this.bridgeableTools.keys());\n  }\n\n  /** Get the bridgeable tools as a Record */\n  getBridgeableTools(): Record<string, Tool> {\n    return Object.fromEntries(this.bridgeableTools.entries());\n  }\n\n  /**\n   * Get tools that cannot be bridged into the sandbox.\n   * These are tools that either:\n   * - Are explicitly excluded (UI-specific, mode-specific)\n   * - Don't have an execute function (provider-native like web_search)\n   *\n   * In exclusive PTC mode, these should still be available to the model directly.\n   */\n  getNonBridgeableTools(): Record<string, Tool> {\n    return Object.fromEntries(this.nonBridgeableTools.entries());\n  }\n\n  /**\n   * Register all bridgeable tools on the runtime under `mux` namespace.\n   *\n   * Tools receive the runtime's abort signal, which is aborted when:\n   * - The sandbox timeout is exceeded\n   * - runtime.abort() is called (e.g., from the parent's abort signal)\n   *\n   * This ensures nested tool calls are cancelled when the sandbox times out,\n   * not just when the parent stream is cancelled.\n   */\n  register(runtime: IJSRuntime): void {\n    const muxObj: Record<string, (...args: unknown[]) => Promise<unknown>> = {};\n\n    for (const [name, tool] of this.bridgeableTools) {\n      // Capture tool for closure\n      const boundTool = tool;\n      const toolName = name;\n\n      muxObj[name] = async (args: unknown) => {\n        // Get the runtime's abort signal - this is aborted on timeout or manual abort\n        const abortSignal = runtime.getAbortSignal();\n\n        // Check if already aborted before executing\n        if (abortSignal?.aborted) {\n          throw new Error(\"Execution aborted\");\n        }\n\n        // Validate args against tool's Zod schema\n        const validatedArgs = this.validateArgs(toolName, boundTool, args);\n\n        // Execute tool with full options (toolCallId and messages are required by type\n        // but not used by most tools - generate synthetic values for sandbox context)\n        const result: unknown = await boundTool.execute!(validatedArgs, {\n          abortSignal,\n          toolCallId: `ptc-${toolName}-${Date.now()}`,\n          messages: [],\n        });\n\n        // Ensure result is JSON-serializable\n        return this.serializeResult(result);\n      };\n    }\n\n    runtime.registerObject(\"mux\", muxObj);\n  }\n\n  private hasExecute(tool: Tool): tool is Tool & { execute: NonNullable<Tool[\"execute\"]> } {\n    return typeof tool.execute === \"function\";\n  }\n\n  private validateArgs(toolName: string, tool: Tool, args: unknown): unknown {\n    // Access the tool's Zod schema - AI SDK tools use 'inputSchema', some use 'parameters'\n    const toolRecord = tool as { inputSchema?: z.ZodType; parameters?: z.ZodType };\n    const schema = toolRecord.inputSchema ?? toolRecord.parameters;\n    if (!schema) return args;\n\n    const result = schema.safeParse(args);\n    if (!result.success) {\n      const issues = result.error.issues.map((i) => `${i.path.join(\".\")}: ${i.message}`).join(\"; \");\n      throw new Error(`Invalid arguments for ${toolName}: ${issues}`);\n    }\n    return result.data;\n  }\n\n  private serializeResult(result: unknown): unknown {\n    try {\n      // Round-trip through JSON to ensure QuickJS can handle the value\n      return JSON.parse(JSON.stringify(result));\n    } catch {\n      return { error: \"Result not JSON-serializable\" };\n    }\n  }\n}\n"]}