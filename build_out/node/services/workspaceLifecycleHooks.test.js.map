{"version":3,"file":"workspaceLifecycleHooks.test.js","sourceRoot":"","sources":["../../../src/node/services/workspaceLifecycleHooks.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport { WorkspaceLifecycleHooks } from \"./workspaceLifecycleHooks\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\n\nconst TEST_METADATA: WorkspaceMetadata = {\n  id: \"ws\",\n  name: \"ws\",\n  projectName: \"proj\",\n  projectPath: \"/tmp/proj\",\n  runtimeConfig: { type: \"local\", srcBaseDir: \"/tmp\" },\n};\n\ndescribe(\"WorkspaceLifecycleHooks\", () => {\n  it(\"runs beforeArchive hooks sequentially in registration order\", async () => {\n    const hooks = new WorkspaceLifecycleHooks();\n\n    const calls: string[] = [];\n    hooks.registerBeforeArchive(() => {\n      calls.push(\"first\");\n      return Promise.resolve(Ok(undefined));\n    });\n    hooks.registerBeforeArchive(() => {\n      calls.push(\"second\");\n      return Promise.resolve(Ok(undefined));\n    });\n\n    const result = await hooks.runBeforeArchive({\n      workspaceId: \"ws\",\n      workspaceMetadata: TEST_METADATA,\n    });\n\n    expect(result.success).toBe(true);\n    expect(calls).toEqual([\"first\", \"second\"]);\n  });\n\n  it(\"stops running hooks after the first Err result\", async () => {\n    const hooks = new WorkspaceLifecycleHooks();\n\n    const calls: string[] = [];\n    hooks.registerBeforeArchive(() => {\n      calls.push(\"first\");\n      return Promise.resolve(Ok(undefined));\n    });\n    hooks.registerBeforeArchive(() => {\n      calls.push(\"second\");\n      return Promise.resolve(Err(\"nope\\nextra\"));\n    });\n    hooks.registerBeforeArchive(() => {\n      calls.push(\"third\");\n      return Promise.resolve(Ok(undefined));\n    });\n\n    const result = await hooks.runBeforeArchive({\n      workspaceId: \"ws\",\n      workspaceMetadata: TEST_METADATA,\n    });\n\n    expect(calls).toEqual([\"first\", \"second\"]);\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      // Hook errors are sanitized to a single line.\n      expect(result.error).toBe(\"nope\");\n    }\n  });\n\n  it(\"returns Err when a hook throws (and sanitizes the thrown message)\", async () => {\n    const hooks = new WorkspaceLifecycleHooks();\n\n    hooks.registerBeforeArchive(() => Promise.reject(new Error(\"boom\\nstack\")));\n\n    const result = await hooks.runBeforeArchive({\n      workspaceId: \"ws\",\n      workspaceMetadata: TEST_METADATA,\n    });\n\n    expect(result.success).toBe(false);\n    if (!result.success) {\n      expect(result.error).toBe(\"beforeArchive hook threw: boom\");\n    }\n  });\n\n  it(\"runs afterUnarchive hooks sequentially (best-effort) even when one returns Err\", async () => {\n    const hooks = new WorkspaceLifecycleHooks();\n\n    const calls: string[] = [];\n    hooks.registerAfterUnarchive(() => {\n      calls.push(\"first\");\n      return Promise.resolve(Err(\"nope\\nextra\"));\n    });\n    hooks.registerAfterUnarchive(() => {\n      calls.push(\"second\");\n      return Promise.resolve(Ok(undefined));\n    });\n\n    await hooks.runAfterUnarchive({\n      workspaceId: \"ws\",\n      workspaceMetadata: TEST_METADATA,\n    });\n\n    expect(calls).toEqual([\"first\", \"second\"]);\n  });\n\n  it(\"swallows thrown errors from afterUnarchive hooks and continues\", async () => {\n    const hooks = new WorkspaceLifecycleHooks();\n\n    const calls: string[] = [];\n    hooks.registerAfterUnarchive(() => {\n      calls.push(\"first\");\n      return Promise.reject(new Error(\"boom\\nstack\"));\n    });\n    hooks.registerAfterUnarchive(() => {\n      calls.push(\"second\");\n      return Promise.resolve(Ok(undefined));\n    });\n\n    await hooks.runAfterUnarchive({\n      workspaceId: \"ws\",\n      workspaceMetadata: TEST_METADATA,\n    });\n\n    expect(calls).toEqual([\"first\", \"second\"]);\n  });\n});\n"]}