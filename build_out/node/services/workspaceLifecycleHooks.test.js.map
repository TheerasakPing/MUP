{"version":3,"file":"workspaceLifecycleHooks.test.js","sourceRoot":"","sources":["../../../src/node/services/workspaceLifecycleHooks.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\r\nimport { WorkspaceLifecycleHooks } from \"./workspaceLifecycleHooks\";\r\nimport { Err, Ok } from \"@/common/types/result\";\r\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\r\n\r\nconst TEST_METADATA: WorkspaceMetadata = {\r\n  id: \"ws\",\r\n  name: \"ws\",\r\n  projectName: \"proj\",\r\n  projectPath: \"/tmp/proj\",\r\n  runtimeConfig: { type: \"local\", srcBaseDir: \"/tmp\" },\r\n};\r\n\r\ndescribe(\"WorkspaceLifecycleHooks\", () => {\r\n  it(\"runs beforeArchive hooks sequentially in registration order\", async () => {\r\n    const hooks = new WorkspaceLifecycleHooks();\r\n\r\n    const calls: string[] = [];\r\n    hooks.registerBeforeArchive(() => {\r\n      calls.push(\"first\");\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n    hooks.registerBeforeArchive(() => {\r\n      calls.push(\"second\");\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    const result = await hooks.runBeforeArchive({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: TEST_METADATA,\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(calls).toEqual([\"first\", \"second\"]);\r\n  });\r\n\r\n  it(\"stops running hooks after the first Err result\", async () => {\r\n    const hooks = new WorkspaceLifecycleHooks();\r\n\r\n    const calls: string[] = [];\r\n    hooks.registerBeforeArchive(() => {\r\n      calls.push(\"first\");\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n    hooks.registerBeforeArchive(() => {\r\n      calls.push(\"second\");\r\n      return Promise.resolve(Err(\"nope\\nextra\"));\r\n    });\r\n    hooks.registerBeforeArchive(() => {\r\n      calls.push(\"third\");\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    const result = await hooks.runBeforeArchive({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: TEST_METADATA,\r\n    });\r\n\r\n    expect(calls).toEqual([\"first\", \"second\"]);\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      // Hook errors are sanitized to a single line.\r\n      expect(result.error).toBe(\"nope\");\r\n    }\r\n  });\r\n\r\n  it(\"returns Err when a hook throws (and sanitizes the thrown message)\", async () => {\r\n    const hooks = new WorkspaceLifecycleHooks();\r\n\r\n    hooks.registerBeforeArchive(() => Promise.reject(new Error(\"boom\\nstack\")));\r\n\r\n    const result = await hooks.runBeforeArchive({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: TEST_METADATA,\r\n    });\r\n\r\n    expect(result.success).toBe(false);\r\n    if (!result.success) {\r\n      expect(result.error).toBe(\"beforeArchive hook threw: boom\");\r\n    }\r\n  });\r\n\r\n  it(\"runs afterUnarchive hooks sequentially (best-effort) even when one returns Err\", async () => {\r\n    const hooks = new WorkspaceLifecycleHooks();\r\n\r\n    const calls: string[] = [];\r\n    hooks.registerAfterUnarchive(() => {\r\n      calls.push(\"first\");\r\n      return Promise.resolve(Err(\"nope\\nextra\"));\r\n    });\r\n    hooks.registerAfterUnarchive(() => {\r\n      calls.push(\"second\");\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    await hooks.runAfterUnarchive({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: TEST_METADATA,\r\n    });\r\n\r\n    expect(calls).toEqual([\"first\", \"second\"]);\r\n  });\r\n\r\n  it(\"swallows thrown errors from afterUnarchive hooks and continues\", async () => {\r\n    const hooks = new WorkspaceLifecycleHooks();\r\n\r\n    const calls: string[] = [];\r\n    hooks.registerAfterUnarchive(() => {\r\n      calls.push(\"first\");\r\n      return Promise.reject(new Error(\"boom\\nstack\"));\r\n    });\r\n    hooks.registerAfterUnarchive(() => {\r\n      calls.push(\"second\");\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n\r\n    await hooks.runAfterUnarchive({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: TEST_METADATA,\r\n    });\r\n\r\n    expect(calls).toEqual([\"first\", \"second\"]);\r\n  });\r\n});\r\n"]}