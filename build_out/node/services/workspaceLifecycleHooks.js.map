{"version":3,"file":"workspaceLifecycleHooks.js","sourceRoot":"","sources":["../../../src/node/services/workspaceLifecycleHooks.ts"],"names":[],"mappings":";;;AAEA,kDAAgD;AAChD,6CAA0C;AAgB1C,SAAS,oBAAoB,CAAC,KAAc,EAAU;IACpD,MAAM,GAAG,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IACnE,4FAA4F;IAC5F,MAAM,UAAU,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;IACpD,OAAO,UAAU,CAAC,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC,IAAI,eAAe,CAAC;AAAA,CACpD;AAED;;;;;;GAMG;AACH;IACmB,kBAAkB,GAAwB,EAAE,CAAC;IAC7C,mBAAmB,GAAyB,EAAE,CAAC;IAEhE,qBAAqB,CAAC,IAAuB,EAAQ;QACnD,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAAA,CACpC;IAED,sBAAsB,CAAC,IAAwB,EAAQ;QACrD,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAAA,CACrC;IAED,KAAK,CAAC,gBAAgB,CAAC,IAA2B,EAAyB;QACzE,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC3C,IAAI,CAAC;gBACH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,CAAC;gBAChC,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;oBACpB,OAAO,IAAA,YAAG,EAAC,oBAAoB,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;gBACjD,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,OAAO,IAAA,YAAG,EAAC,6BAA6B,oBAAoB,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YACzE,CAAC;QACH,CAAC;QAED,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;IAAA,CACtB;IAED,KAAK,CAAC,iBAAiB,CAAC,IAA4B,EAAiB;QACnE,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC;YAC5C,IAAI,CAAC;gBACH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,CAAC;gBAChC,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;oBACpB,SAAG,CAAC,KAAK,CAAC,4BAA4B,EAAE;wBACtC,WAAW,EAAE,IAAI,CAAC,WAAW;wBAC7B,KAAK,EAAE,oBAAoB,CAAC,MAAM,CAAC,KAAK,CAAC;qBAC1C,CAAC,CAAC;gBACL,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,SAAG,CAAC,KAAK,CAAC,2BAA2B,EAAE;oBACrC,WAAW,EAAE,IAAI,CAAC,WAAW;oBAC7B,KAAK,EAAE,oBAAoB,CAAC,KAAK,CAAC;iBACnC,CAAC,CAAC;YACL,CAAC;QACH,CAAC;IAAA,CACF;CACF","sourcesContent":["import type { WorkspaceMetadata } from \"@/common/types/workspace\";\nimport type { Result } from \"@/common/types/result\";\nimport { Ok, Err } from \"@/common/types/result\";\nimport { log } from \"@/node/services/log\";\n\nexport interface BeforeArchiveHookArgs {\n  workspaceId: string;\n  workspaceMetadata: WorkspaceMetadata;\n}\n\nexport type BeforeArchiveHook = (args: BeforeArchiveHookArgs) => Promise<Result<void>>;\n\nexport interface AfterUnarchiveHookArgs {\n  workspaceId: string;\n  workspaceMetadata: WorkspaceMetadata;\n}\n\nexport type AfterUnarchiveHook = (args: AfterUnarchiveHookArgs) => Promise<Result<void>>;\n\nfunction sanitizeErrorMessage(error: unknown): string {\n  const raw = error instanceof Error ? error.message : String(error);\n  // Keep single-line, capped error messages to avoid leaking stack traces or long CLI output.\n  const singleLine = raw.split(\"\\n\")[0]?.trim() ?? \"\";\n  return singleLine.slice(0, 200) || \"Unknown error\";\n}\n\n/**\n * Backend registry for workspace lifecycle hooks.\n *\n * Hooks run in-process (sequentially).\n * - beforeArchive hooks may block the operation if they return Err.\n * - afterUnarchive hooks are best-effort and never block unarchive.\n */\nexport class WorkspaceLifecycleHooks {\n  private readonly beforeArchiveHooks: BeforeArchiveHook[] = [];\n  private readonly afterUnarchiveHooks: AfterUnarchiveHook[] = [];\n\n  registerBeforeArchive(hook: BeforeArchiveHook): void {\n    this.beforeArchiveHooks.push(hook);\n  }\n\n  registerAfterUnarchive(hook: AfterUnarchiveHook): void {\n    this.afterUnarchiveHooks.push(hook);\n  }\n\n  async runBeforeArchive(args: BeforeArchiveHookArgs): Promise<Result<void>> {\n    for (const hook of this.beforeArchiveHooks) {\n      try {\n        const result = await hook(args);\n        if (!result.success) {\n          return Err(sanitizeErrorMessage(result.error));\n        }\n      } catch (error) {\n        return Err(`beforeArchive hook threw: ${sanitizeErrorMessage(error)}`);\n      }\n    }\n\n    return Ok(undefined);\n  }\n\n  async runAfterUnarchive(args: AfterUnarchiveHookArgs): Promise<void> {\n    for (const hook of this.afterUnarchiveHooks) {\n      try {\n        const result = await hook(args);\n        if (!result.success) {\n          log.debug(\"afterUnarchive hook failed\", {\n            workspaceId: args.workspaceId,\n            error: sanitizeErrorMessage(result.error),\n          });\n        }\n      } catch (error) {\n        log.debug(\"afterUnarchive hook threw\", {\n          workspaceId: args.workspaceId,\n          error: sanitizeErrorMessage(error),\n        });\n      }\n    }\n  }\n}\n"]}