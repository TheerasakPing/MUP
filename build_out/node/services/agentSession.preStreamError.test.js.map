{"version":3,"file":"agentSession.preStreamError.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.preStreamError.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it, mock, afterEach } from \"bun:test\";\nimport { EventEmitter } from \"events\";\nimport type { Config } from \"@/node/config\";\nimport type { AIService } from \"@/node/services/aiService\";\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\nimport type { PartialService } from \"@/node/services/partialService\";\nimport type { SendMessageError } from \"@/common/types/errors\";\nimport type { MuxMessage } from \"@/common/types/message\";\nimport type { Result } from \"@/common/types/result\";\nimport { Err, Ok } from \"@/common/types/result\";\nimport type { StreamErrorMessage, WorkspaceChatMessage } from \"@/common/orpc/types\";\nimport { AgentSession } from \"./agentSession\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport type { CostTrackingService } from \"./costTrackingService\";\n\ndescribe(\"AgentSession pre-stream errors\", () => {\n  let historyCleanup: (() => Promise<void>) | undefined;\n  afterEach(async () => {\n    await historyCleanup?.();\n  });\n\n  it(\"emits stream-error when stream startup fails\", async () => {\n    const workspaceId = \"ws-test\";\n\n    const config = {\n      srcDir: \"/tmp\",\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\n    } as unknown as Config;\n\n    const { historyService, cleanup } = await createTestHistoryService();\n    historyCleanup = cleanup;\n\n    const partialService = {\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\n    } as unknown as PartialService;\n\n    const aiEmitter = new EventEmitter();\n    const streamMessage = mock((_history: MuxMessage[]) => {\n      return Promise.resolve(\n        Err({\n          type: \"api_key_not_found\",\n          provider: \"anthropic\",\n        })\n      );\n    });\n    const aiService = Object.assign(aiEmitter, {\n      isStreaming: mock((_workspaceId: string) => false),\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\n      streamMessage: streamMessage as unknown as (\n        ...args: Parameters<AIService[\"streamMessage\"]>\n      ) => Promise<Result<void, SendMessageError>>,\n    }) as unknown as AIService;\n\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\n\n    const backgroundProcessManager = {\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\n        void _queued;\n      }),\n    } as unknown as BackgroundProcessManager;\n\n    const session = new AgentSession({\n      workspaceId,\n      config,\n      historyService,\n      partialService,\n      aiService,\n      initStateManager,\n      costTrackingService: {} as unknown as CostTrackingService,\n      backgroundProcessManager,\n    });\n\n    const events: WorkspaceChatMessage[] = [];\n    session.onChatEvent((event) => {\n      events.push(event.message);\n    });\n\n    const result = await session.sendMessage(\"hello\", {\n      model: \"anthropic:claude-3-5-sonnet-latest\",\n      agentId: \"exec\",\n    });\n\n    expect(result.success).toBe(false);\n    expect(streamMessage.mock.calls).toHaveLength(1);\n\n    const streamError = events.find(\n      (event): event is StreamErrorMessage => event.type === \"stream-error\"\n    );\n\n    expect(streamError).toBeDefined();\n    expect(streamError?.errorType).toBe(\"authentication\");\n    expect(streamError?.error).toContain(\"anthropic\");\n    expect(streamError?.messageId).toMatch(/^assistant-/);\n  });\n});\n"]}