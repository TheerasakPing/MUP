{"version":3,"file":"fileAtMentions.test.js","sourceRoot":"","sources":["../../../src/node/services/fileAtMentions.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAgD;AAChD,MAAY,UAAU,wCAAoB;AAC1C,MAAY,EAAE,+BAAW;AACzB,MAAY,IAAI,iCAAa;AAE7B,oDAA0D;AAC1D,kEAA8D;AAE9D,qDAAmF;AAEnF,IAAA,mBAAQ,EAAC,sBAAsB,EAAE,GAAG,EAAE,CAAC;IACrC,IAAA,aAAE,EAAC,iFAAiF,EAAE,KAAK,IAAI,EAAE,CAAC;QAChG,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACtE,MAAM,UAAU,CAAC,SAAS,CACxB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,EAClC,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EACtC,MAAM,CACP,CAAC;YAEF,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1E,MAAM,QAAQ,GAAG;gBACf,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,0BAA0B,CAAC;gBAC1D,IAAA,0BAAgB,EAAC,IAAI,EAAE,WAAW,EAAE,OAAO,CAAC;gBAC5C,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,yBAAyB,CAAC;aAC1D,CAAC;YAEF,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,oEAAoE;YACpE,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YAC/B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClD,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YACvC,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YACvC,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YAEvC,MAAM,YAAY,GAAG,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,IAAI,EAAE,CAAC;YACjF,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC;YAC9D,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YACxC,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YACxC,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QAC1C,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IACH,IAAA,aAAE,EAAC,iEAAiE,EAAE,KAAK,IAAI,EAAE,CAAC;QAChF,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YAEtE,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC7B,MAAM,UAAU,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,EAAE,OAAO,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC;YACvF,CAAC;YAED,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1E,MAAM,QAAQ,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC,EAAE,GAAG,EAAE,EAAE,CAAC;gBACtD,MAAM,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC;gBAClB,OAAO,IAAA,0BAAgB,EAAC,IAAI,CAAC,EAAE,EAAE,MAAM,EAAE,sBAAsB,CAAC,KAAK,CAAC,CAAC;YAAA,CACxE,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,MAAM,iBAAiB,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,QAAQ,EAAE,SAAS,KAAK,IAAI,CAAC,CAAC;YAC/E,IAAA,iBAAM,EAAC,iBAAiB,CAAC,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;YAE3C,MAAM,YAAY,GAAG,iBAAiB;iBACnC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,IAAI,EAAE,CAAC;iBAC9D,IAAI,CAAC,MAAM,CAAC,CAAC;YAChB,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC;QAChE,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,uEAAuE,EAAE,KAAK,IAAI,EAAE,CAAC;QACtF,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACtE,MAAM,UAAU,CAAC,SAAS,CACxB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,EAClC,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAC/C,MAAM,CACP,CAAC;YAEF,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1E,MAAM,QAAQ,GAAG,CAAC,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,+BAA+B,CAAC,CAAC,CAAC;YAEnF,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YAC/B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACrC,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClD,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YAEvC,MAAM,YAAY,GAAG,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,IAAI,EAAE,CAAC;YACjF,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,2CAA2C,CAAC,CAAC;YAC5E,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YACxC,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YACxC,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YACxC,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,GAAG,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,GAAG,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QAC9C,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,oCAAoC,EAAE,KAAK,IAAI,EAAE,CAAC;QACnD,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1E,MAAM,QAAQ,GAAG,CAAC,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,8BAA8B,CAAC,CAAC,CAAC;YAElF,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QACnC,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IACH,IAAA,aAAE,EAAC,mCAAmC,EAAE,KAAK,IAAI,EAAE,CAAC;QAClD,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,SAAS,CACxB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,UAAU,CAAC,EAC7B,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAC7B,MAAM,CACP,CAAC;YAEF,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1E,MAAM,QAAQ,GAAG,CAAC,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,wBAAwB,CAAC,CAAC,CAAC;YAE5E,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YAC/B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAElD,MAAM,YAAY,GAAG,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,IAAI,EAAE,CAAC;YACjF,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,yCAAyC,CAAC,CAAC;YAC1E,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YACxC,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QAC1C,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,6CAA6C,EAAE,KAAK,IAAI,EAAE,CAAC;QAC5D,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1E,MAAM,QAAQ,GAAG,CAAC,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,iBAAiB,CAAC,CAAC,CAAC;YAErE,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QACnC,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,qFAAqF,EAAE,KAAK,IAAI,EAAE,CAAC;QACpG,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC,CAAC;QAEzF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACtE,MAAM,UAAU,CAAC,SAAS,CACxB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,EAClC,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EACrC,MAAM,CACP,CAAC;YAEF,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAE1E,4DAA4D;YAC5D,MAAM,eAAe,GAAG,IAAA,0BAAgB,EACtC,YAAY,EACZ,MAAM,EACN,2FAA2F,EAC3F;gBACE,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;gBACrB,SAAS,EAAE,IAAI;gBACf,qBAAqB,EAAE,CAAC,YAAY,CAAC,EAAE,8BAA8B;aACtE,CACF,CAAC;YACF,MAAM,WAAW,GAAG,IAAA,0BAAgB,EAAC,IAAI,EAAE,MAAM,EAAE,0BAA0B,CAAC,CAAC;YAC/E,MAAM,QAAQ,GAAG,CAAC,eAAe,EAAE,WAAW,CAAC,CAAC;YAEhD,MAAM,MAAM,GAAG,MAAM,IAAA,qCAAoB,EAAC,QAAQ,EAAE;gBAClD,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,uFAAuF;YACvF,iEAAiE;YACjE,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YAC/B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,eAAe,CAAC,CAAC;YAC3C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;YAEvC,kEAAkE;YAClE,MAAM,YAAY,GAAG,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,EAAE,IAAI,IAAI,EAAE,CAAC;YACjF,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,YAAY,CAAC,CAAC,GAAG,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;QAClD,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC;AAEH,IAAA,mBAAQ,EAAC,2BAA2B,EAAE,GAAG,EAAE,CAAC;IAC1C,IAAA,aAAE,EAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE,CAAC;QACjE,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC;QAEpF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACtE,MAAM,UAAU,CAAC,SAAS,CACxB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,EAClC,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EACtC,MAAM,CACP,CAAC;YAEF,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAE1E,MAAM,MAAM,GAAG,MAAM,IAAA,0CAAyB,EAAC,0BAA0B,EAAE;gBACzE,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YAC/B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,YAAY,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,CAAC;YACzE,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC;YAClE,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;YACvD,IAAA,iBAAM,EAAC,OAAO,MAAM,CAAC,CAAC,CAAC,EAAE,cAAc,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC1D,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,kCAAkC,EAAE,KAAK,IAAI,EAAE,CAAC;QACjD,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC;QAEpF,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACtE,MAAM,UAAU,CAAC,SAAS,CACxB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,EAClC,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAC/C,MAAM,CACP,CAAC;YAEF,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAE1E,MAAM,MAAM,GAAG,MAAM,IAAA,0CAAyB,EAAC,wBAAwB,EAAE;gBACvE,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YAC/B,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;YACjD,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC;YACpD,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,GAAG,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAChD,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,GAAG,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QAClD,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE,CAAC;QACjE,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC;QAEpF,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAE1E,MAAM,MAAM,GAAG,MAAM,IAAA,0CAAyB,EAAC,uBAAuB,EAAE;gBACtE,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QACjC,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,4BAA4B,EAAE,KAAK,IAAI,EAAE,CAAC;QAC3C,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC,CAAC;QAEpF,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,EAAE,CAAC,CAAC;YAE1E,MAAM,MAAM,GAAG,MAAM,IAAA,0CAAyB,EAAC,2BAA2B,EAAE;gBAC1E,OAAO;gBACP,aAAa,EAAE,MAAM;aACtB,CAAC,CAAC;YAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QACjC,CAAC;gBAAS,CAAC;YACT,MAAM,UAAU,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IAAA,CACF,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport * as fsPromises from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\nimport { createMuxMessage } from \"@/common/types/message\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\n\nimport { injectFileAtMentions, materializeFileAtMentions } from \"./fileAtMentions\";\n\ndescribe(\"injectFileAtMentions\", () => {\n  it(\"expands @file mentions from earlier user messages even when the latest has none\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      await fsPromises.mkdir(path.join(tmpDir, \"src\"), { recursive: true });\n      await fsPromises.writeFile(\n        path.join(tmpDir, \"src\", \"foo.ts\"),\n        [\"line1\", \"line2\", \"line3\"].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n      const messages = [\n        createMuxMessage(\"u1\", \"user\", \"Please check @src/foo.ts\"),\n        createMuxMessage(\"a1\", \"assistant\", \"Sure.\"),\n        createMuxMessage(\"u2\", \"user\", \"Now do X (no mentions).\"),\n      ];\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      // Injection should stay anchored to the *original* mention message.\n      expect(result).toHaveLength(4);\n      expect(result[0]?.metadata?.synthetic).toBe(true);\n      expect(result[1]).toEqual(messages[0]);\n      expect(result[2]).toEqual(messages[1]);\n      expect(result[3]).toEqual(messages[2]);\n\n      const injectedText = result[0]?.parts.find((p) => p.type === \"text\")?.text ?? \"\";\n      expect(injectedText).toContain('<mux-file path=\"src/foo.ts\"');\n      expect(injectedText).toContain(\"line1\");\n      expect(injectedText).toContain(\"line2\");\n      expect(injectedText).toContain(\"line3\");\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n  it(\"prioritizes the latest @file mention when the global cap is hit\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      await fsPromises.mkdir(path.join(tmpDir, \"src\"), { recursive: true });\n\n      for (let i = 1; i <= 11; i++) {\n        await fsPromises.writeFile(path.join(tmpDir, \"src\", `f${i}.ts`), `line${i}`, \"utf8\");\n      }\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n      const messages = Array.from({ length: 11 }, (_, idx) => {\n        const i = idx + 1;\n        return createMuxMessage(`u${i}`, \"user\", `Please check @src/f${i}.ts`);\n      });\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      const syntheticMessages = result.filter((m) => m.metadata?.synthetic === true);\n      expect(syntheticMessages).toHaveLength(10);\n\n      const injectedText = syntheticMessages\n        .map((m) => m.parts.find((p) => p.type === \"text\")?.text ?? \"\")\n        .join(\"\\n\\n\");\n      expect(injectedText).toContain('<mux-file path=\"src/f11.ts\"');\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"injects a synthetic user message with file contents before the prompt\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      await fsPromises.mkdir(path.join(tmpDir, \"src\"), { recursive: true });\n      await fsPromises.writeFile(\n        path.join(tmpDir, \"src\", \"foo.ts\"),\n        [\"line1\", \"line2\", \"line3\", \"line4\"].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n      const messages = [createMuxMessage(\"u1\", \"user\", \"Please check @src/foo.ts#L2-3\")];\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toHaveLength(2);\n      expect(result[0]?.role).toBe(\"user\");\n      expect(result[0]?.metadata?.synthetic).toBe(true);\n      expect(result[1]).toEqual(messages[0]);\n\n      const injectedText = result[0]?.parts.find((p) => p.type === \"text\")?.text ?? \"\";\n      expect(injectedText).toContain('<mux-file path=\"src/foo.ts\" range=\"L2-L3\"');\n      expect(injectedText).toContain(\"```ts\");\n      expect(injectedText).toContain(\"line2\");\n      expect(injectedText).toContain(\"line3\");\n      expect(injectedText).not.toContain(\"line1\");\n      expect(injectedText).not.toContain(\"line4\");\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"ignores non-existent file mentions\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n      const messages = [createMuxMessage(\"u1\", \"user\", \"Please check @src/missing.ts\")];\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toEqual(messages);\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n  it(\"injects root files like @Makefile\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      await fsPromises.writeFile(\n        path.join(tmpDir, \"Makefile\"),\n        [\"line1\", \"line2\"].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n      const messages = [createMuxMessage(\"u1\", \"user\", \"Please check @Makefile\")];\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toHaveLength(2);\n      expect(result[0]?.metadata?.synthetic).toBe(true);\n\n      const injectedText = result[0]?.parts.find((p) => p.type === \"text\")?.text ?? \"\";\n      expect(injectedText).toContain('<mux-file path=\"Makefile\" range=\"L1-L2\"');\n      expect(injectedText).toContain(\"line1\");\n      expect(injectedText).toContain(\"line2\");\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"ignores non-file @mentions with # fragments\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n      const messages = [createMuxMessage(\"u1\", \"user\", \"Ping @alice#123\")];\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toEqual(messages);\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"skips tokens that already have persisted snapshots (fileAtMentionSnapshot metadata)\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-file-at-mentions-\"));\n\n    try {\n      await fsPromises.mkdir(path.join(tmpDir, \"src\"), { recursive: true });\n      await fsPromises.writeFile(\n        path.join(tmpDir, \"src\", \"foo.ts\"),\n        [\"new line1\", \"new line2\"].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n\n      // Simulate a message that has already-materialized snapshot\n      const snapshotMessage = createMuxMessage(\n        \"snapshot-1\",\n        \"user\",\n        '<mux-file path=\"src/foo.ts\" range=\"L1-L2\">\\n```ts\\nold line1\\nold line2\\n```\\n</mux-file>',\n        {\n          timestamp: Date.now(),\n          synthetic: true,\n          fileAtMentionSnapshot: [\"src/foo.ts\"], // Token that was materialized\n        }\n      );\n      const userMessage = createMuxMessage(\"u1\", \"user\", \"Please check @src/foo.ts\");\n      const messages = [snapshotMessage, userMessage];\n\n      const result = await injectFileAtMentions(messages, {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      // Should NOT inject a new synthetic message because the token was already materialized\n      // The messages should remain unchanged (snapshot + user message)\n      expect(result).toHaveLength(2);\n      expect(result[0]).toEqual(snapshotMessage);\n      expect(result[1]).toEqual(userMessage);\n\n      // Verify the old content is preserved (not re-read from the file)\n      const snapshotText = result[0]?.parts.find((p) => p.type === \"text\")?.text ?? \"\";\n      expect(snapshotText).toContain(\"old line1\");\n      expect(snapshotText).not.toContain(\"new line1\");\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n});\n\ndescribe(\"materializeFileAtMentions\", () => {\n  it(\"materializes @file mentions into snapshot blocks\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-materialize-\"));\n\n    try {\n      await fsPromises.mkdir(path.join(tmpDir, \"src\"), { recursive: true });\n      await fsPromises.writeFile(\n        path.join(tmpDir, \"src\", \"foo.ts\"),\n        [\"line1\", \"line2\", \"line3\"].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n\n      const result = await materializeFileAtMentions(\"Please check @src/foo.ts\", {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toHaveLength(1);\n      expect(result[0]?.token).toBe(\"src/foo.ts\");\n      expect(result[0]?.resolvedPath).toBe(path.join(tmpDir, \"src\", \"foo.ts\"));\n      expect(result[0]?.block).toContain('<mux-file path=\"src/foo.ts\"');\n      expect(result[0]?.block).toContain(\"line1\");\n      expect(result[0]?.block).toContain(\"line2\");\n      expect(result[0]?.content).toBe(\"line1\\nline2\\nline3\");\n      expect(typeof result[0]?.modifiedTimeMs).toBe(\"number\");\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"materializes line range mentions\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-materialize-\"));\n\n    try {\n      await fsPromises.mkdir(path.join(tmpDir, \"src\"), { recursive: true });\n      await fsPromises.writeFile(\n        path.join(tmpDir, \"src\", \"foo.ts\"),\n        [\"line1\", \"line2\", \"line3\", \"line4\"].join(\"\\n\"),\n        \"utf8\"\n      );\n\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n\n      const result = await materializeFileAtMentions(\"Check @src/foo.ts#L2-3\", {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toHaveLength(1);\n      expect(result[0]?.token).toBe(\"src/foo.ts#L2-3\");\n      expect(result[0]?.block).toContain('range=\"L2-L3\"');\n      expect(result[0]?.block).toContain(\"line2\");\n      expect(result[0]?.block).toContain(\"line3\");\n      expect(result[0]?.block).not.toContain(\"line1\");\n      expect(result[0]?.block).not.toContain(\"line4\");\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"returns empty array when no @file mentions found\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-materialize-\"));\n\n    try {\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n\n      const result = await materializeFileAtMentions(\"No file mentions here\", {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toHaveLength(0);\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n\n  it(\"ignores non-existent files\", async () => {\n    const tmpDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-materialize-\"));\n\n    try {\n      const runtime = createRuntime({ type: \"local\" }, { projectPath: tmpDir });\n\n      const result = await materializeFileAtMentions(\"Check @src/nonexistent.ts\", {\n        runtime,\n        workspacePath: tmpDir,\n      });\n\n      expect(result).toHaveLength(0);\n    } finally {\n      await fsPromises.rm(tmpDir, { recursive: true, force: true });\n    }\n  });\n});\n"]}