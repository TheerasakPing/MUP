{"version":3,"file":"coderService.js","sourceRoot":"","sources":["../../../src/node/services/coderService.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;GAGG;AACH,4DAAsD;AACtD,gEAAwD;AACxD,yDAAyD;AACzD,6CAA0C;AAC1C,iDAAyD;AAEzD,kDAAgD;AAChD,uDAUqC;AA+BrC;;;GAGG;AACH,SAAS,yBAAyB,CAAC,KAAc,EAAU;IACzD,IAAI,KAAK,IAAI,IAAI;QAAE,OAAO,EAAE,CAAC;IAC7B,IAAI,OAAO,KAAK,KAAK,QAAQ;QAAE,OAAO,KAAK,CAAC;IAC5C,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,OAAO,KAAK,KAAK,SAAS;QAAE,OAAO,MAAM,CAAC,KAAK,CAAC,CAAC;IAClF,oDAAkD;IAClD,OAAO,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;AAAA,CAC9B;AAED,sCAAsC;AACtC,MAAM,iBAAiB,GAAG,QAAQ,CAAC;AAEnC;;;;GAIG;AACH,SAAS,gBAAgB,CAAC,CAAS,EAAU;IAC3C,OAAO,CAAC;SACL,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC,oBAAoB;SACvC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,4BAA4B;SAC1C,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,wBAAwB;AAAzB,CAClB;AAED;;;;;GAKG;AACH,yBAAgC,CAAS,EAAE,CAAS,EAAU;IAC5D,MAAM,MAAM,GAAG,gBAAgB,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;IAC1D,MAAM,MAAM,GAAG,gBAAgB,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;IAE1D,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;QAChE,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;QAC7B,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;QAC7B,IAAI,KAAK,KAAK,KAAK;YAAE,OAAO,KAAK,GAAG,KAAK,CAAC;IAC5C,CAAC;IACD,OAAO,CAAC,CAAC;AAAA,CACV;AAED,MAAM,uBAAuB,GAAG,IAAI,CAAC;AAErC,SAAS,wBAAwB,CAC/B,KAAmB,EACnB,OAAqC,EAIrC;IACA,MAAM,cAAc,GAAG,OAAO,EAAE,cAAc,IAAI,uBAAuB,CAAC;IAC1E,IAAI,YAAY,GAAyC,IAAI,CAAC;IAE9D,MAAM,eAAe,GAAG,GAAG,EAAE,CAAC;QAC5B,IAAI,YAAY;YAAE,OAAO;QACzB,YAAY,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;YAC9B,YAAY,GAAG,IAAI,CAAC;YACpB,mEAAmE;YACnE,IAAI,KAAK,CAAC,QAAQ,KAAK,IAAI,IAAI,KAAK,CAAC,UAAU,KAAK,IAAI,EAAE,CAAC;gBACzD,IAAI,CAAC;oBACH,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBACxB,CAAC;gBAAC,MAAM,CAAC;oBACP,SAAS;gBACX,CAAC;YACH,CAAC;QAAA,CACF,EAAE,cAAc,CAAC,CAAC;IAAA,CACpB,CAAC;IAEF,MAAM,SAAS,GAAG,GAAG,EAAE,CAAC;QACtB,IAAI,CAAC;YACH,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QACxB,CAAC;QAAC,MAAM,CAAC;YACP,SAAS;QACX,CAAC;QACD,eAAe,EAAE,CAAC;IAAA,CACnB,CAAC;IAEF,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;QACpB,IAAI,YAAY,EAAE,CAAC;YACjB,YAAY,CAAC,YAAY,CAAC,CAAC;YAC3B,YAAY,GAAG,IAAI,CAAC;QACtB,CAAC;IAAA,CACF,CAAC;IAEF,OAAO,EAAE,SAAS,EAAE,OAAO,EAAE,CAAC;AAAA,CAC/B;AAED;;;;;;;;;GASG;AACH,KAAK,SAAS,CAAC,CAAC,kBAAkB,CAChC,IAAc,EACd,WAAmB,EACnB,WAAyB,EACzB,YAAY,GAAG,uBAAuB,EACC;IACvC,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;QACzB,MAAM,IAAI,KAAK,CAAC,YAAY,CAAC,CAAC;IAChC,CAAC;IAED,6DAA6D;IAC7D,MAAM,WAAW,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC;IAElC,MAAM,KAAK,GAAG,IAAA,qBAAK,EAAC,OAAO,EAAE,IAAI,EAAE;QACjC,KAAK,EAAE,CAAC,QAAQ,EAAE,MAAM,EAAE,MAAM,CAAC;KAClC,CAAC,CAAC;IAEH,MAAM,UAAU,GAAG,wBAAwB,CAAC,KAAK,CAAC,CAAC;IAEnD,MAAM,YAAY,GAAG,GAAG,EAAE,CAAC;QACzB,UAAU,CAAC,SAAS,EAAE,CAAC;IAAA,CACxB,CAAC;IACF,WAAW,EAAE,gBAAgB,CAAC,OAAO,EAAE,YAAY,CAAC,CAAC;IAErD,IAAI,CAAC;QACH,oDAAoD;QACpD,MAAM,SAAS,GAAa,EAAE,CAAC;QAC/B,MAAM,WAAW,GAAa,EAAE,CAAC;QACjC,IAAI,WAAW,GAAG,KAAK,CAAC;QACxB,IAAI,WAAW,GAAwB,IAAI,CAAC;QAE5C,MAAM,QAAQ,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC;YACjC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACrB,IAAI,WAAW,EAAE,CAAC;gBAChB,WAAW,EAAE,CAAC;gBACd,WAAW,GAAG,IAAI,CAAC;YACrB,CAAC;QAAA,CACF,CAAC;QAEF,IAAI,OAAO,GAAG,CAAC,CAAC;QAChB,MAAM,QAAQ,GAAG,GAAG,EAAE,CAAC;YACrB,OAAO,EAAE,CAAC;YACV,IAAI,OAAO,KAAK,CAAC,EAAE,CAAC;gBAClB,WAAW,GAAG,IAAI,CAAC;gBACnB,IAAI,WAAW,EAAE,CAAC;oBAChB,WAAW,EAAE,CAAC;oBACd,WAAW,GAAG,IAAI,CAAC;gBACrB,CAAC;YACH,CAAC;QAAA,CACF,CAAC;QAEF,MAAM,aAAa,GAAG,CAAC,MAAoC,EAAE,QAAiB,EAAE,EAAE,CAAC;YACjF,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,QAAQ,EAAE,CAAC;gBACX,OAAO;YACT,CAAC;YACD,IAAI,MAAM,GAAG,EAAE,CAAC;YAChB,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,KAAa,EAAE,EAAE,CAAC;gBACnC,MAAM,IAAI,KAAK,CAAC,QAAQ,EAAE,CAAC;gBAC3B,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACjC,MAAM,GAAG,KAAK,CAAC,GAAG,EAAE,IAAI,EAAE,CAAC;gBAC3B,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE,CAAC;oBACzB,MAAM,OAAO,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;oBAC5B,IAAI,OAAO,EAAE,CAAC;wBACZ,QAAQ,CAAC,OAAO,CAAC,CAAC;wBAClB,IAAI,QAAQ;4BAAE,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;oBAC1C,CAAC;gBACH,CAAC;YAAA,CACF,CAAC,CAAC;YACH,MAAM,CAAC,EAAE,CAAC,KAAK,EAAE,GAAG,EAAE,CAAC;gBACrB,IAAI,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;oBAClB,QAAQ,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;oBACxB,IAAI,QAAQ;wBAAE,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;gBAChD,CAAC;gBACD,QAAQ,EAAE,CAAC;YAAA,CACZ,CAAC,CAAC;YACH,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;QAAA,CAC9B,CAAC;QAEF,aAAa,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QACnC,aAAa,CAAC,KAAK,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;QAElC,6BAA6B;QAC7B,OAAO,CAAC,WAAW,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC5C,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACzB,MAAM,SAAS,CAAC,KAAK,EAAG,CAAC;YAC3B,CAAC;iBAAM,IAAI,CAAC,WAAW,EAAE,CAAC;gBACxB,MAAM,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,EAAE,CAAC;oBACnC,WAAW,GAAG,OAAO,CAAC;gBAAA,CACvB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,2BAA2B;QAC3B,MAAM,QAAQ,GAAG,MAAM,IAAI,OAAO,CAAgB,CAAC,OAAO,EAAE,EAAE,CAAC;YAC7D,KAAK,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;YAC3B,KAAK,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC;QAAA,CACxC,CAAC,CAAC;QAEH,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;YACzB,MAAM,IAAI,KAAK,CAAC,YAAY,CAAC,CAAC;QAChC,CAAC;QAED,IAAI,QAAQ,KAAK,CAAC,EAAE,CAAC;YACnB,MAAM,WAAW,GAAG,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;YACjF,MAAM,IAAI,KAAK,CAAC,GAAG,WAAW,UAAU,MAAM,CAAC,QAAQ,CAAC,IAAI,WAAW,EAAE,CAAC,CAAC;QAC7E,CAAC;IACH,CAAC;YAAS,CAAC;QACT,UAAU,CAAC,OAAO,EAAE,CAAC;QACrB,WAAW,EAAE,mBAAmB,CAAC,OAAO,EAAE,YAAY,CAAC,CAAC;IAC1D,CAAC;AAAA,CACF;AAaD,SAAS,oBAAoB,CAAC,MAA0B,EAAiC;IACvF,MAAM,QAAQ,GAAG,GAAG,MAAM,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC;IAE7D,IAAI,MAAM,CAAC,KAAK,EAAE,CAAC;QACjB,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,EAAE,QAAQ,EAAE,CAAC;IACtD,CAAC;IAED,IAAI,MAAM,CAAC,QAAQ,KAAK,CAAC,EAAE,CAAC;QAC1B,OAAO;YACL,EAAE,EAAE,KAAK;YACT,KAAK,EAAE,QAAQ,IAAI,aAAa,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE;YACzD,QAAQ;SACT,CAAC;IACJ,CAAC;IAED,OAAO,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,EAAE,CAAC;AAAA,CACnE;AAED,SAAS,0BAA0B,CAAC,KAAc,EAAU;IAC1D,IAAI,CAAC,CAAC,KAAK,YAAY,KAAK,CAAC,EAAE,CAAC;QAC9B,OAAO,eAAe,CAAC;IACzB,CAAC;IAED,MAAM,GAAG,GAAG,KAAqD,CAAC;IAClE,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;IAElE,MAAM,KAAK,GAAG,GAAG;SACd,KAAK,CAAC,OAAO,CAAC;SACd,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;SAC1B,MAAM,CAAC,OAAO,CAAC,CAAC;IAEnB,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QACvB,OAAO,eAAe,CAAC;IACzB,CAAC;IAED,kFAAkF;IAClF,uEAAuE;IACvE,MAAM,SAAS,GACb,CAAC,GAAG,KAAK,CAAC,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;IAE3F,OAAO,CACL,SAAS;SACN,OAAO,CAAC,aAAa,EAAE,EAAE,CAAC;SAC1B,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC;SACb,IAAI,EAAE,IAAI,eAAe,CAC7B,CAAC;AAAA,CACH;AAED;IACE,2DAA2D;IAC3D,uEAAuE;IAC/D,oBAAoB,GAAG,IAAI,GAAG,EAA2B,CAAC;IAC1D,UAAU,GAAqB,IAAI,CAAC;IAC5C,6EAA6E;IACrE,YAAY,GAA2B,IAAI,CAAC;IAE5C,KAAK,CAAC,sBAAsB,GAA2B;QAC7D,IAAI,KAAyB,CAAC;QAC9B,IAAI,OAAO,CAAC,QAAQ,KAAK,OAAO,EAAE,CAAC;YACjC,IAAI,CAAC;gBACH,KAAK,GAAG,IAAA,sBAAW,GAAE,CAAC;YACxB,CAAC;YAAC,MAAM,CAAC;gBACP,6FAA6F;YAC/F,CAAC;QACH,CAAC;QAED,IAAI,CAAC;;;gBACH,MAAM,IAAI,kCAAG,IAAA,0BAAS,EAAC,kBAAkB,EAAE,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,QAAA,CAAC;gBAC1E,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBACrC,MAAM,SAAS,GAAG,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,CAAC;gBACnD,OAAO,SAAS,IAAI,IAAI,CAAC;;;;;;;;;QAC3B,CAAC;QAAC,MAAM,CAAC;YACP,OAAO,IAAI,CAAC;QACd,CAAC;IAAA,CACF;IAED;;;OAGG;IACH,KAAK,CAAC,YAAY,GAAuB;QACvC,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;YACpB,OAAO,IAAI,CAAC,UAAU,CAAC;QACzB,CAAC;QAED,sGAAsG;QACtG,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,sBAAsB,EAAE,CAAC;QAEvD,IAAI,CAAC;;;gBACH,MAAM,IAAI,kCAAG,IAAA,0BAAS,EAAC,6BAA6B,CAAC,QAAA,CAAC;gBACtD,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBAErC,oBAAoB;gBACpB,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAyB,CAAC;gBACxD,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;gBAE7B,IAAI,CAAC,OAAO,EAAE,CAAC;oBACb,IAAI,CAAC,UAAU,GAAG;wBAChB,KAAK,EAAE,aAAa;wBACpB,MAAM,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,iCAAiC,EAAE;qBACtE,CAAC;oBACF,OAAO,IAAI,CAAC,UAAU,CAAC;gBACzB,CAAC;gBAED,wBAAwB;gBACxB,IAAI,eAAe,CAAC,OAAO,EAAE,iBAAiB,CAAC,GAAG,CAAC,EAAE,CAAC;oBACpD,SAAG,CAAC,KAAK,CAAC,qBAAqB,OAAO,qBAAqB,iBAAiB,EAAE,CAAC,CAAC;oBAChF,IAAI,CAAC,UAAU,GAAG;wBAChB,KAAK,EAAE,UAAU;wBACjB,OAAO;wBACP,UAAU,EAAE,iBAAiB;wBAC7B,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,EAAE,UAAU,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;qBACtC,CAAC;oBACF,OAAO,IAAI,CAAC,UAAU,CAAC;gBACzB,CAAC;gBAED,IAAI,MAAM,GAA2B,IAAI,CAAC;gBAC1C,IAAI,CAAC;oBACH,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;gBACtC,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,mEAAmE;oBACnE,2FAA2F;oBAC3F,MAAM,GAAG,GAAG,KAAqD,CAAC;oBAClE,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;oBAClE,MAAM,UAAU,GAAG,GAAG,CAAC,WAAW,EAAE,CAAC;oBAErC,MAAM,aAAa,GACjB,UAAU,CAAC,QAAQ,CAAC,eAAe,CAAC;wBACpC,UAAU,CAAC,QAAQ,CAAC,gBAAgB,CAAC;wBACrC,UAAU,CAAC,QAAQ,CAAC,cAAc,CAAC;wBACnC,UAAU,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC;oBAErC,MAAM,QAAQ,GACZ,GAAG;yBACA,KAAK,CAAC,OAAO,CAAC;yBACd,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;yBAC1B,MAAM,CAAC,OAAO,CAAC;yBACf,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;oBAElB,MAAM,aAAa,GACjB,QAAQ;yBACL,OAAO,CAAC,aAAa,EAAE,EAAE,CAAC;yBAC1B,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC;yBACb,IAAI,EAAE,IAAI,eAAe,CAAC;oBAE/B,MAAM,kBAAkB,GAAG,UAAU;wBACnC,CAAC,CAAC,GAAG,UAAU,OAAO,aAAa,CAAC,OAAO,CAAC,cAAc,EAAE,EAAE,CAAC,EAAE;wBACjE,CAAC,CAAC,aAAa,CAAC;oBAElB,SAAG,CAAC,KAAK,CAAC,mCAAmC,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;oBAE1D,MAAM,MAAM,GAAc,aAAa;wBACrC,CAAC,CAAC,EAAE,KAAK,EAAE,aAAa,EAAE,MAAM,EAAE,EAAE,IAAI,EAAE,eAAe,EAAE,OAAO,EAAE,kBAAkB,EAAE,EAAE;wBAC1F,CAAC,CAAC,EAAE,KAAK,EAAE,aAAa,EAAE,MAAM,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,aAAa,EAAE,EAAE,CAAC;oBAEhF,kFAAkF;oBAClF,qDAAqD;oBACrD,OAAO,MAAM,CAAC;gBAChB,CAAC;gBAED,MAAM,aAAa,GAAc;oBAC/B,KAAK,EAAE,WAAW;oBAClB,OAAO;oBACP,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC,CAAC,EAAE,QAAQ,EAAE,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;oBAC1D,GAAG,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;iBAC5C,CAAC;gBAEF,IAAI,CAAC,UAAU,GAAG,aAAa,CAAC;gBAChC,OAAO,IAAI,CAAC,UAAU,CAAC;;;;;;;;;QACzB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,KAAK,CAAC,yBAAyB,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YAChD,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,CAAC;YACjD,OAAO,IAAI,CAAC,UAAU,CAAC;QACzB,CAAC;IAAA,CACF;IAED;;OAEG;IACK,kBAAkB,CAAC,KAAc,EAAa;QACpD,oDAAoD;QACpD,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;YAC3B,MAAM,IAAI,GAAI,KAA+B,CAAC,IAAI,CAAC;YACnD,MAAM,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC,WAAW,EAAE,CAAC;YAC5C,IACE,IAAI,KAAK,QAAQ;gBACjB,OAAO,CAAC,QAAQ,CAAC,mBAAmB,CAAC;gBACrC,OAAO,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAC1B,CAAC;gBACD,OAAO,EAAE,KAAK,EAAE,aAAa,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC;YACrD,CAAC;YACD,uEAAuE;YACvE,MAAM,SAAS,GAAG,0BAA0B,CAAC,KAAK,CAAC,CAAC;YACpD,OAAO;gBACL,KAAK,EAAE,aAAa;gBACpB,MAAM,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,SAAS,EAAE;aAC9C,CAAC;QACJ,CAAC;QACD,OAAO,EAAE,KAAK,EAAE,aAAa,EAAE,MAAM,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,eAAe,EAAE,EAAE,CAAC;IAAA,CACtF;IAED;;OAEG;IACK,KAAK,CAAC,gBAAgB,CAAC,SAAiB,EAA4B;;;YAC1E,MAAM,SAAS,kCAAG,IAAA,0BAAS,EACzB,4CAA4C,sBAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,EAAE,CACxE,QAAA,CAAC;YACF,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,CAAC,MAAM,CAAC;YACjD,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;YAE7B,OAAO;gBACL,KAAK,EAAE,OAAO;gBACd,OAAO,EAAE,KAAK,IAAI,EAAE,CAAC;oBACnB,IAAI,CAAC;;;4BACH,MAAM,UAAU,kCAAG,IAAA,0BAAS,EAAC,uBAAuB,sBAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,EAAE,CAAC,QAAA,CAAC;4BACjF,MAAM,UAAU,CAAC,MAAM,CAAC;;;;;;;;;oBAC1B,CAAC;oBAAC,MAAM,CAAC;wBACP,8DAA8D;wBAC9D,SAAG,CAAC,KAAK,CAAC,4CAA4C,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC;oBACzE,CAAC;gBAAA,CACF;aACF,CAAC;;;;;;;;;IAAA,CACH;IAEO,KAAK,CAAC,cAAc,CAC1B,SAAiB,EACjB,EAA4C,EAChC;QACZ,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC;QACvD,IAAI,CAAC;YACH,OAAO,MAAM,EAAE,CAAC,OAAO,CAAC,CAAC;QAC3B,CAAC;gBAAS,CAAC;YACT,MAAM,OAAO,CAAC,OAAO,EAAE,CAAC;QAC1B,CAAC;IAAA,CACF;IAED,KAAK,CAAC,yBAAyB,CAAC,aAAqB,EAA4B;QAC/E,MAAM,QAAQ,GAAG,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;QAC9D,IAAI,QAAQ,EAAE,CAAC;YACb,OAAO,QAAQ,CAAC;QAClB,CAAC;QAED,MAAM,SAAS,GAAG,OAAO,aAAa,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE,CAAC;QACpE,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC;QACvD,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC;QACtD,OAAO,OAAO,CAAC;IAAA,CAChB;IAED,uBAAuB,CAAC,aAAqB,EAA+B;QAC1E,MAAM,OAAO,GAAG,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;QAC7D,IAAI,OAAO,EAAE,CAAC;YACZ,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC;QAClD,CAAC;QACD,OAAO,OAAO,CAAC;IAAA,CAChB;IAED,KAAK,CAAC,0BAA0B,CAAC,aAAqB,EAAiB;QACrE,MAAM,OAAO,GAAG,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;QAC7D,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,OAAO;QACT,CAAC;QACD,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC;QAChD,MAAM,OAAO,CAAC,OAAO,EAAE,CAAC;IAAA,CACzB;IAEO,uBAAuB,CAAC,GAAuB,EAAU;QAC/D,MAAM,OAAO,GAAG,CAAC,GAAG,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;QACtD,OAAO,OAAO,IAAI,OAAO,CAAC;IAAA,CAC3B;IAED,KAAK,CAAC,wBAAwB,CAAC,OAAyB,EAAuC;QAC7F,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,gBAAgB,EAAE,CAAC;QACpD,MAAM,SAAS,GAAG,kBAAkB,IAAI,CAAC,GAAG,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE,CAAC;QAE9D,MAAM,GAAG,GAAG,KAAK,EAAE,GAAoB,EAAE,EAAE,CAAC;YAC1C,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,wBAAwB,EAAE,aAAa,CAAC,CAAC;YAC7D,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,GAAG,EAAE;gBAChC,OAAO,EAAE,EAAE,qBAAqB,EAAE,GAAG,CAAC,KAAK,EAAE;aAC9C,CAAC,CAAC;YACH,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;gBACjB,MAAM,IAAI,KAAK,CAAC,+BAA+B,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC;YACpE,CAAC;YAED,MAAM,IAAI,GAAG,CAAC,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAiC,CAAC;YACrE,OAAO,EAAE,cAAc,EAAE,IAAI,CAAC,uBAAuB,CAAC,IAAI,CAAC,eAAe,CAAC,EAAE,CAAC;QAAA,CAC/E,CAAC;QAEF,OAAO,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;IAAA,CACrE;IACD;;OAEG;IACH,UAAU,GAAS;QACjB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QACvB,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;IAAA,CAC1B;IAED,uFAAuF;IACvF,iFAAiF;IACzE,KAAK,CAAC,aAAa,CAAC,OAAgC,EAA4B;;;YACtF,IAAI,OAAO,EAAE,QAAQ,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;gBAC3C,OAAO,IAAI,CAAC,YAAY,CAAC;YAC3B,CAAC;YAED,MAAM,IAAI,kCAAG,IAAA,0BAAS,EAAC,4BAA4B,CAAC,QAAA,CAAC;YACrD,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;YAErC,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAoC,CAAC;YACnE,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,CAAC;gBAClB,MAAM,IAAI,KAAK,CAAC,8DAA8D,CAAC,CAAC;YAClF,CAAC;YAED,IAAI,CAAC,YAAY,GAAG;gBAClB,GAAG,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,GAAG;gBAChB,QAAQ,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,QAAQ;gBAC1B,EAAE,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE;aACf,CAAC;YAEF,OAAO,IAAI,CAAC,YAAY,CAAC;;;;;;;;;IAAA,CAC1B;IAED;;;OAGG;IACK,KAAK,CAAC,gBAAgB,GAAoB;QAChD,MAAM,EAAE,GAAG,EAAE,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC,CAAC;QAC7D,OAAO,GAAG,CAAC;IAAA,CACZ;IAED;;;OAGG;IACK,KAAK,CAAC,0BAA0B,CAAC,YAAoB,EAAE,GAAY,EAAmB;;;YAC5F,oFAAoF;YACpF,MAAM,IAAI,kCAAG,IAAA,0BAAS,EAAC,oCAAoC,CAAC,QAAA,CAAC;YAC7D,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;YAErC,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;gBACnB,MAAM,IAAI,KAAK,CAAC,aAAa,YAAY,kCAAkC,CAAC,CAAC;YAC/E,CAAC;YAED,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAM3B,CAAC;YAEH,0DAA0D;YAC1D,MAAM,QAAQ,GAAG,GAAG,CAAC,IAAI,CACvB,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAI,KAAK,YAAY,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,QAAQ,CAAC,iBAAiB,KAAK,GAAG,CAAC,CAC1F,CAAC;YACF,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACd,MAAM,SAAS,GAAG,GAAG,CAAC,CAAC,CAAC,qBAAqB,GAAG,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC;gBACzD,MAAM,IAAI,KAAK,CAAC,aAAa,YAAY,cAAc,SAAS,EAAE,CAAC,CAAC;YACtE,CAAC;YAED,OAAO,QAAQ,CAAC,QAAQ,CAAC,iBAAiB,CAAC;;;;;;;;;IAAA,CAC5C;IAED;;;OAGG;IACK,KAAK,CAAC,mBAAmB,CAC/B,YAAoB,EACpB,UAAkB,EAClB,GAAY,EACU;QACtB,IAAI,CAAC;;;gBACH,MAAM,OAAO,GAAG,GAAG,CAAC,CAAC,CAAC,UAAU,sBAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;gBAC3D,MAAM,IAAI,kCAAG,IAAA,0BAAS,EACpB,gCAAgC,sBAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,GAAG,OAAO,gBAAgB,CACvF,QAAA,CAAC;gBACF,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBAErC,8EAA8E;gBAC9E,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC;oBAC1D,OAAO,IAAI,GAAG,EAAE,CAAC;gBACnB,CAAC;gBAED,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAK3B,CAAC;gBAEH,MAAM,MAAM,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,cAAc,CAAC,IAAI,KAAK,UAAU,CAAC,CAAC;gBACrE,IAAI,CAAC,MAAM,EAAE,cAAc,CAAC,UAAU,EAAE,CAAC;oBACvC,OAAO,IAAI,GAAG,EAAE,CAAC;gBACnB,CAAC;gBAED,OAAO,IAAI,GAAG,CAAC,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;;;;;;;;;QACtE,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,SAAG,CAAC,KAAK,CAAC,kCAAkC,EAAE,EAAE,YAAY,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,CAAC;YACnF,OAAO,IAAI,GAAG,EAAE,CAAC;QACnB,CAAC;IAAA,CACF;IAED;;;OAGG;IACK,mBAAmB,CAAC,IAAa,EAMtC;QACD,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;YACzB,MAAM,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC;QACvD,CAAC;QACD,OAAO,IAAI;aACR,MAAM,CAAC,CAAC,CAAC,EAAgC,EAAE,CAAC;YAC3C,IAAI,CAAC,KAAK,IAAI,IAAI,OAAO,CAAC,KAAK,QAAQ;gBAAE,OAAO,KAAK,CAAC;YACtD,MAAM,GAAG,GAAG,CAA4B,CAAC;YACzC,OAAO,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ,IAAI,GAAG,CAAC,IAAI,KAAK,EAAE,CAAC;QAAA,CACxD,CAAC;aACD,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;YACX,IAAI,EAAE,CAAC,CAAC,IAAc;YACtB,YAAY,EAAE,yBAAyB,CAAC,CAAC,CAAC,aAAa,CAAC;YACxD,IAAI,EAAE,OAAO,CAAC,CAAC,IAAI,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ;YACpD,SAAS,EAAE,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;YAC/B,QAAQ,EAAE,OAAO,CAAC,CAAC,CAAC,QAAQ,CAAC;SAC9B,CAAC,CAAC,CAAC;IAAA,CACP;IAED;;;OAGG;IACK,KAAK,CAAC,yBAAyB,CACrC,aAAqB,EACrB,SAAiB,EACjB,aAAqB,EACrB,OAAyB,EASzB;QACA,MAAM,GAAG,GAAG,KAAK,EAAE,GAAoB,EAAE,EAAE,CAAC;YAC1C,MAAM,GAAG,GAAG,IAAI,GAAG,CACjB,4BAA4B,SAAS,kBAAkB,EACvD,aAAa,CACd,CAAC,QAAQ,EAAE,CAAC;YAEb,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,GAAG,EAAE;gBAChC,OAAO,EAAE;oBACP,qBAAqB,EAAE,GAAG,CAAC,KAAK;iBACjC;aACF,CAAC,CAAC;YAEH,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;gBACjB,MAAM,IAAI,KAAK,CACb,oCAAoC,QAAQ,CAAC,MAAM,IAAI,QAAQ,CAAC,UAAU,EAAE,CAC7E,CAAC;YACJ,CAAC;YAED,MAAM,IAAI,GAAY,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC;YAC5C,OAAO,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;QAAA,CACvC,CAAC;QAEF,MAAM,SAAS,GAAG,OAAO,aAAa,EAAE,CAAC;QACzC,OAAO,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;IAAA,CACrE;IAED;;;;;OAKG;IACK,oBAAoB,CAAC,SAAiB,EAAU;QACtD,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;YACzD,OAAO,SAAS,CAAC;QACnB,CAAC;QACD,4DAA4D;QAC5D,OAAO,IAAI,SAAS,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,CAAC;IAAA,CAC7C;IAED;;;;OAIG;IACH,kBAAkB,CAChB,SAME,EACF,eAA4B,EACc;QAC1C,MAAM,KAAK,GAA6C,EAAE,CAAC;QAE3D,KAAK,MAAM,CAAC,IAAI,SAAS,EAAE,CAAC;YAC1B,wBAAwB;YACxB,IAAI,CAAC,CAAC,SAAS;gBAAE,SAAS;YAC1B,gCAAgC;YAChC,IAAI,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC;gBAAE,SAAS;YAE1C,qDAAqD;YACrD,MAAM,OAAO,GAAG,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,YAAY,EAAE,CAAC,CAAC;YACzE,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;QACxC,CAAC;QAED,OAAO,KAAK,CAAC;IAAA,CACd;IAED;;;OAGG;IACH,sBAAsB,CACpB,SAME,EACF,eAA4B,EACtB;QACN,MAAM,OAAO,GAAa,EAAE,CAAC;QAE7B,KAAK,MAAM,CAAC,IAAI,SAAS,EAAE,CAAC;YAC1B,IAAI,CAAC,CAAC,SAAS;gBAAE,SAAS;YAC1B,IAAI,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,CAAC,YAAY,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;gBAClE,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;YACvB,CAAC;QACH,CAAC;QAED,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACvB,MAAM,IAAI,KAAK,CACb,gDAAgD,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI;gBACpE,4EAA4E,CAC/E,CAAC;QACJ,CAAC;IAAA,CACF;IAED;;OAEG;IACH,KAAK,CAAC,aAAa,GAAsC;QACvD,IAAI,CAAC;;;gBACH,MAAM,IAAI,kCAAG,IAAA,0BAAS,EAAC,oCAAoC,CAAC,QAAA,CAAC;gBAC7D,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBAErC,qCAAqC;gBACrC,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;oBACnB,OAAO,EAAE,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,EAAE,EAAE,CAAC;gBACrC,CAAC;gBAED,yDAAyD;gBACzD,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAM3B,CAAC;gBAEH,OAAO;oBACL,EAAE,EAAE,IAAI;oBACR,SAAS,EAAE,GAAG,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;wBAC7B,IAAI,EAAE,KAAK,CAAC,QAAQ,CAAC,IAAI;wBACzB,WAAW,EAAE,KAAK,CAAC,QAAQ,CAAC,YAAY,IAAI,KAAK,CAAC,QAAQ,CAAC,IAAI;wBAC/D,gBAAgB,EAAE,KAAK,CAAC,QAAQ,CAAC,iBAAiB,IAAI,SAAS;qBAChE,CAAC,CAAC;iBACJ,CAAC;;;;;;;;;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,0BAA0B,CAAC,KAAK,CAAC,CAAC;YAClD,0EAA0E;YAC1E,SAAG,CAAC,IAAI,CAAC,gCAAgC,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YACtD,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,OAAO,IAAI,eAAe,EAAE,CAAC;QAC1D,CAAC;IAAA,CACF;IAED;;;;OAIG;IACH,KAAK,CAAC,WAAW,CAAC,YAAoB,EAAE,GAAY,EAAmC;QACrF,IAAI,CAAC;;;gBACH,MAAM,OAAO,GAAG,GAAG,CAAC,CAAC,CAAC,UAAU,sBAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;gBAC3D,MAAM,IAAI,kCAAG,IAAA,0BAAS,EACpB,gCAAgC,sBAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,GAAG,OAAO,gBAAgB,CACvF,QAAA,CAAC;gBACF,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBAErC,8DAA8D;gBAC9D,mFAAmF;gBACnF,kEAAkE;gBAClE,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC;oBAC1D,OAAO,EAAE,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC;gBACnC,CAAC;gBAED,yEAAyE;gBACzE,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAO3B,CAAC;gBAEH,OAAO;oBACL,EAAE,EAAE,IAAI;oBACR,OAAO,EAAE,GAAG,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;wBAC3B,EAAE,EAAE,KAAK,CAAC,cAAc,CAAC,EAAE;wBAC3B,IAAI,EAAE,KAAK,CAAC,cAAc,CAAC,IAAI;wBAC/B,WAAW,EAAE,KAAK,CAAC,cAAc,CAAC,WAAW;wBAC7C,SAAS,EAAE,KAAK,CAAC,cAAc,CAAC,OAAO,IAAI,KAAK;qBACjD,CAAC,CAAC;iBACJ,CAAC;;;;;;;;;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,0BAA0B,CAAC,KAAK,CAAC,CAAC;YAClD,wEAAwE;YACxE,SAAG,CAAC,IAAI,CAAC,8BAA8B,EAAE,EAAE,YAAY,EAAE,KAAK,EAAE,CAAC,CAAC;YAClE,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,OAAO,IAAI,eAAe,EAAE,CAAC;QAC1D,CAAC;IAAA,CACF;IAED;;;;;OAKG;IACH,KAAK,CAAC,eAAe,CAAC,aAAqB,EAAoB;QAC7D,IAAI,CAAC;;;gBACH,MAAM,IAAI,mCAAG,IAAA,0BAAS,EACpB,uBAAuB,sBAAQ,CAAC,KAAK,CAAC,QAAQ,aAAa,EAAE,CAAC,gBAAgB,CAC/E,QAAA,CAAC;gBACF,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBAErC,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;oBACnB,OAAO,KAAK,CAAC;gBACf,CAAC;gBAED,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAA4B,CAAC;gBACjE,OAAO,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,aAAa,CAAC,CAAC;;;;;;;;;QAC1D,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,mFAAmF;YACnF,6EAA6E;YAC7E,SAAG,CAAC,KAAK,CAAC,2CAA2C,EAAE,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC,CAAC;YACjF,OAAO,KAAK,CAAC;QACf,CAAC;IAAA,CACF;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,GAAuC;QACzD,4FAA4F;QAC5F,MAAM,cAAc,GAAG,IAAI,GAAG,CAAS,kCAA0B,CAAC,OAAO,CAAC,CAAC;QAE3E,IAAI,CAAC;;;gBACH,MAAM,IAAI,mCAAG,IAAA,0BAAS,EAAC,0BAA0B,CAAC,QAAA,CAAC;gBACnD,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC;gBAErC,sCAAsC;gBACtC,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;oBACnB,OAAO,EAAE,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,CAAC;gBACtC,CAAC;gBAED,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAOlC,CAAC;gBAEH,oEAAoE;gBACpE,OAAO;oBACL,EAAE,EAAE,IAAI;oBACR,UAAU,EAAE,UAAU;yBACnB,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;yBACxD,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;wBACX,IAAI,EAAE,CAAC,CAAC,IAAI;wBACZ,YAAY,EAAE,CAAC,CAAC,aAAa;wBAC7B,mBAAmB,EAAE,CAAC,CAAC,qBAAqB,IAAI,CAAC,CAAC,aAAa;wBAC/D,MAAM,EAAE,CAAC,CAAC,YAAY,CAAC,MAA8B;qBACtD,CAAC,CAAC;iBACN,CAAC;;;;;;;;;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,0BAA0B,CAAC,KAAK,CAAC,CAAC;YAClD,wEAAwE;YACxE,yEAAyE;YACzE,SAAG,CAAC,IAAI,CAAC,iCAAiC,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YACvD,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,OAAO,IAAI,eAAe,EAAE,CAAC;QAC1D,CAAC;IAAA,CACF;IAED;;;;;OAKG;IACK,eAAe,CACrB,IAAc,EACd,OAAoD,EACvB;QAC7B,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC;YAC9B,IAAI,OAAO,CAAC,SAAS,IAAI,CAAC,EAAE,CAAC;gBAC3B,OAAO,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,CAAC;gBACtE,OAAO;YACT,CAAC;YAED,IAAI,OAAO,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC;gBAC5B,OAAO,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,CAAC;gBACtE,OAAO;YACT,CAAC;YAED,MAAM,KAAK,GAAG,IAAA,qBAAK,EAAC,OAAO,EAAE,IAAI,EAAE;gBACjC,KAAK,EAAE,CAAC,QAAQ,EAAE,MAAM,EAAE,MAAM,CAAC;aAClC,CAAC,CAAC;YAEH,IAAI,MAAM,GAAG,EAAE,CAAC;YAChB,IAAI,MAAM,GAAG,EAAE,CAAC;YAChB,IAAI,QAAQ,GAAG,KAAK,CAAC;YAErB,IAAI,YAAY,GAAyC,IAAI,CAAC;YAE9D,MAAM,UAAU,GAAG,wBAAwB,CAAC,KAAK,CAAC,CAAC;YAEnD,MAAM,WAAW,GAAG,CAAC,MAA0B,EAAE,EAAE,CAAC;gBAClD,IAAI,QAAQ;oBAAE,OAAO;gBACrB,QAAQ,GAAG,IAAI,CAAC;gBAChB,OAAO,CAAC,MAAM,CAAC,CAAC;YAAA,CACjB,CAAC;YAEF,MAAM,OAAO,GAAG,CAAC,cAA+C,EAAE,EAAE,CAAC;gBACnE,IAAI,YAAY,EAAE,CAAC;oBACjB,YAAY,CAAC,YAAY,CAAC,CAAC;oBAC3B,YAAY,GAAG,IAAI,CAAC;gBACtB,CAAC;gBACD,IAAI,CAAC,cAAc,EAAE,gBAAgB,EAAE,CAAC;oBACtC,UAAU,CAAC,OAAO,EAAE,CAAC;gBACvB,CAAC;gBACD,KAAK,CAAC,cAAc,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBACvC,KAAK,CAAC,cAAc,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBACvC,OAAO,CAAC,MAAM,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;YAAA,CACvD,CAAC;YAEF,SAAS,OAAO,GAAG;gBACjB,UAAU,CAAC,SAAS,EAAE,CAAC;gBACvB,yDAAyD;gBACzD,OAAO,CAAC,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,CAAC;gBACpC,WAAW,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,CAAC;YAAA,CACnE;YAED,SAAS,OAAO,GAAG;gBACjB,OAAO,EAAE,CAAC;gBACV,WAAW,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;YAAA,CACjD;YAED,SAAS,OAAO,CAAC,IAAmB,EAAE;gBACpC,OAAO,EAAE,CAAC;gBACV,WAAW,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;YAAA,CACjD;YAED,KAAK,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC;gBAClC,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,CAAC;YAAA,CACzB,CAAC,CAAC;YAEH,KAAK,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC;gBAClC,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,CAAC;YAAA,CACzB,CAAC,CAAC;YAEH,KAAK,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;YAC3B,KAAK,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;YAE3B,YAAY,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;gBAC9B,UAAU,CAAC,SAAS,EAAE,CAAC;gBAEvB,yDAAyD;gBACzD,0EAA0E;gBAC1E,OAAO,CAAC,MAAM,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBAEtD,WAAW,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,CAAC;YAAA,CACnE,EAAE,OAAO,CAAC,SAAS,CAAC,CAAC;YAEtB,OAAO,CAAC,MAAM,EAAE,gBAAgB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAAA,CACpD,CAAC,CAAC;IAAA,CACJ;IAED;;;;;OAKG;IACH,KAAK,CAAC,kBAAkB,CACtB,aAAqB,EACrB,OAAsD,EACtB;QAChC,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,IAAI,MAAM,CAAC;QAE/C,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,eAAe,CACvC,CAAC,MAAM,EAAE,UAAU,EAAE,QAAQ,aAAa,EAAE,EAAE,UAAU,EAAE,MAAM,CAAC,EACjE,EAAE,SAAS,EAAE,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,CACvC,CAAC;YAEF,MAAM,WAAW,GAAG,oBAAoB,CAAC,MAAM,CAAC,CAAC;YACjD,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,CAAC;gBACpB,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,WAAW,CAAC,KAAK,EAAE,CAAC;YACrD,CAAC;YAED,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;gBAC/B,OAAO,EAAE,IAAI,EAAE,WAAW,EAAE,CAAC;YAC/B,CAAC;YAED,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,MAAM,CAG9C,CAAC;YAEH,gDAAgD;YAChD,MAAM,KAAK,GAAG,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,aAAa,CAAC,CAAC;YAC/D,IAAI,CAAC,KAAK,EAAE,CAAC;gBACX,OAAO,EAAE,IAAI,EAAE,WAAW,EAAE,CAAC;YAC/B,CAAC;YAED,8CAA8C;YAC9C,MAAM,MAAM,GAAG,KAAK,CAAC,YAAY,CAAC,MAAM,CAAC;YACzC,MAAM,MAAM,GAAG,kCAA0B,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YAC5D,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;gBACpB,SAAG,CAAC,IAAI,CAAC,gCAAgC,EAAE,EAAE,aAAa,EAAE,MAAM,EAAE,CAAC,CAAC;gBACtE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,mBAAmB,MAAM,EAAE,EAAE,CAAC;YAC/D,CAAC;YAED,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC;QAC7C,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YACvE,SAAG,CAAC,KAAK,CAAC,sCAAsC,EAAE,EAAE,aAAa,EAAE,KAAK,EAAE,OAAO,EAAE,CAAC,CAAC;YACrF,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,CAAC;QAC3C,CAAC;IAAA,CACF;IAED;;;;OAIG;IACH,KAAK,CAAC,cAAc,CAClB,aAAqB,EACrB,OAAsD,EAC/B;QACvB,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,IAAI,MAAM,CAAC;QAE/C,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,CAAC,OAAO,EAAE,aAAa,EAAE,OAAO,CAAC,EAAE;gBAC3E,SAAS;gBACT,MAAM,EAAE,OAAO,EAAE,MAAM;aACxB,CAAC,CAAC;YAEH,MAAM,WAAW,GAAG,oBAAoB,CAAC,MAAM,CAAC,CAAC;YACjD,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,CAAC;gBACpB,OAAO,IAAA,YAAG,EAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAChC,CAAC;YAED,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;QACvB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YACvE,OAAO,IAAA,YAAG,EAAC,OAAO,CAAC,CAAC;QACtB,CAAC;IAAA,CACF;IAED;;;;OAIG;IACH,KAAK,CAAC,aAAa,CACjB,aAAqB,EACrB,OAAsD,EAC/B;QACvB,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,IAAI,MAAM,CAAC;QAE/C,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,CAAC,MAAM,EAAE,aAAa,EAAE,OAAO,CAAC,EAAE;gBAC1E,SAAS;gBACT,MAAM,EAAE,OAAO,EAAE,MAAM;aACxB,CAAC,CAAC;YAEH,MAAM,WAAW,GAAG,oBAAoB,CAAC,MAAM,CAAC,CAAC;YACjD,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,CAAC;gBACpB,OAAO,IAAA,YAAG,EAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAChC,CAAC;YAED,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;QACvB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YACvE,OAAO,IAAA,YAAG,EAAC,OAAO,CAAC,CAAC;QACtB,CAAC;IAAA,CACF;IAED;;;OAGG;IACH,KAAK,CAAC,CAAC,qBAAqB,CAC1B,aAAqB,EACrB,WAAyB,EACc;QACvC,SAAG,CAAC,KAAK,CAAC,mCAAmC,EAAE,EAAE,aAAa,EAAE,CAAC,CAAC;QAClE,KAAK,CAAC,CAAC,kBAAkB,CACvB,CAAC,KAAK,EAAE,aAAa,EAAE,YAAY,EAAE,IAAI,EAAE,MAAM,CAAC,EAClD,yBAAyB,EACzB,WAAW,EACX,mCAAmC,CACpC,CAAC;IAAA,CACH;IAED;;;;;;;;;;;;OAYG;IACH,KAAK,CAAC,CAAC,eAAe,CACpB,IAAY,EACZ,QAAgB,EAChB,MAAe,EACf,WAAyB,EACzB,GAAY,EACZ,OAAyB,EACc;QACvC,SAAG,CAAC,KAAK,CAAC,0BAA0B,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC;QAEvE,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;YACzB,MAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;QACtD,CAAC;QAED,wBAAwB;QACxB,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,gBAAgB,EAAE,CAAC;QAEpD,oCAAoC;QACpC,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,0BAA0B,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;QAEvE,oDAAoD;QACpD,MAAM,eAAe,GAAG,MAAM;YAC5B,CAAC,CAAC,MAAM,IAAI,CAAC,mBAAmB,CAAC,QAAQ,EAAE,MAAM,EAAE,GAAG,CAAC;YACvD,CAAC,CAAC,IAAI,GAAG,EAAU,CAAC;QAEtB,4CAA4C;QAC5C,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,yBAAyB,CAAC,aAAa,EAAE,SAAS,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC;QAEhG,0CAA0C;QAC1C,IAAI,CAAC,sBAAsB,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;QAExD,4EAA4E;QAC5E,MAAM,WAAW,GAAG,IAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;QAExE,SAAG,CAAC,KAAK,CAAC,wCAAwC,EAAE;YAClD,IAAI;YACJ,QAAQ;YACR,MAAM;YACN,GAAG;YACH,eAAe,EAAE,WAAW,CAAC,MAAM;YACnC,eAAe,EAAE,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;SAChD,CAAC,CAAC;QAEH,+CAA+C;QAC/C,MAAM,IAAI,GAAG,CAAC,QAAQ,EAAE,IAAI,EAAE,IAAI,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;QACvD,IAAI,GAAG,EAAE,CAAC;YACR,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QAC1B,CAAC;QACD,IAAI,MAAM,EAAE,CAAC;YACX,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;QAChC,CAAC;QACD,KAAK,MAAM,CAAC,IAAI,WAAW,EAAE,CAAC;YAC5B,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;QACtC,CAAC;QAED,KAAK,CAAC,CAAC,kBAAkB,CACvB,IAAI,EACJ,qBAAqB,EACrB,WAAW,EACX,kCAAkC,CACnC,CAAC;IAAA,CACH;IAED,iCAAiC;IACzB,KAAK,CAAC,EAAU,EAAE,MAAoB,EAAiB;QAC7D,IAAI,MAAM,EAAE,OAAO,EAAE,CAAC;YACpB,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;QAC3B,CAAC;QAED,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC;YAC9B,MAAM,OAAO,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;gBAC/B,MAAM,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBAC9C,OAAO,EAAE,CAAC;YAAA,CACX,EAAE,EAAE,CAAC,CAAC;YAEP,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;gBACpB,YAAY,CAAC,OAAO,CAAC,CAAC;gBACtB,MAAM,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBAC9C,OAAO,EAAE,CAAC;YAAA,CACX,CAAC;YAEF,MAAM,EAAE,gBAAgB,CAAC,OAAO,EAAE,OAAO,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;QAAA,CAC5D,CAAC,CAAC;IAAA,CACJ;IAED;;;;;OAKG;IACH,KAAK,CAAC,yBAAyB,CAC7B,IAAY,EACZ,OAcC,EACsB;QACvB,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,IAAI,MAAM,CAAC;QAC/C,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAE7B,2DAA2D;QAC3D,qDAAqD;QACrD,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC;YAC7B,SAAG,CAAC,IAAI,CAAC,wDAAwD,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC;YAC7E,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;QACvB,CAAC;QAED,MAAM,UAAU,GAAG,GAAG,EAAE,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,GAAG,SAAS,CAAC;QAC5D,MAAM,WAAW,GAAG,GAAG,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC,CAAC,CAAC;QAE5E,MAAM,cAAc,GAAG,IAAI,GAAG,CAAuB;YACnD,UAAU;YACV,SAAS;YACT,UAAU;YACV,WAAW;SACZ,CAAC,CAAC;QAEH,IAAI,iBAAiB,GAAG,KAAK,CAAC;QAC9B,IAAI,SAA6B,CAAC;QAClC,IAAI,OAAO,GAAG,CAAC,CAAC;QAEhB,OAAO,CAAC,UAAU,EAAE,EAAE,CAAC;YACrB,IAAI,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;gBAC7B,OAAO,IAAA,YAAG,EAAC,0BAA0B,CAAC,CAAC;YACzC,CAAC;YAED,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE;gBACvD,SAAS,EAAE,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,MAAM,CAAC;gBAC1C,MAAM,EAAE,OAAO,EAAE,MAAM;aACxB,CAAC,CAAC;YAEH,IAAI,YAAY,CAAC,IAAI,KAAK,IAAI,EAAE,CAAC;gBAC/B,iBAAiB,GAAG,IAAI,CAAC;gBAEzB,IAAI,YAAY,CAAC,MAAM,KAAK,SAAS,IAAI,YAAY,CAAC,MAAM,KAAK,UAAU,EAAE,CAAC;oBAC5E,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;gBACvB,CAAC;gBAED,sFAAsF;gBACtF,oDAAoD;gBACpD,IAAI,cAAc,CAAC,GAAG,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE,CAAC;oBAC5C,SAAG,CAAC,KAAK,CAAC,0DAA0D,EAAE;wBACpE,IAAI;wBACJ,MAAM,EAAE,YAAY,CAAC,MAAM;qBAC5B,CAAC,CAAC;gBACL,CAAC;YACH,CAAC;YAED,IAAI,YAAY,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;gBACtC,IAAI,OAAO,EAAE,gBAAgB,KAAK,IAAI,EAAE,CAAC;oBACvC,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;gBACvB,CAAC;gBAED,4FAA4F;gBAC5F,0FAA0F;gBAC1F,iFAAiF;gBACjF,IAAI,iBAAiB,EAAE,CAAC;oBACtB,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;gBACvB,CAAC;gBAED,kFAAkF;gBAClF,qEAAqE;gBACrE,MAAM,gBAAgB,GAAG,OAAO,EAAE,yBAAyB,IAAI,SAAS,CAAC;gBACzE,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,GAAG,gBAAgB,EAAE,CAAC;oBAC9C,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;gBACvB,CAAC;gBAED,OAAO,EAAE,CAAC;gBACV,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,GAAG,OAAO,GAAG,GAAG,CAAC,CAAC;gBACvD,MAAM,IAAI,CAAC,KAAK,CAAC,SAAS,EAAE,OAAO,EAAE,MAAM,CAAC,CAAC;gBAC7C,SAAS;YACX,CAAC;YAED,IAAI,YAAY,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;gBAClC,0EAA0E;gBAC1E,SAAS,GAAG,YAAY,CAAC,KAAK,CAAC;YACjC,CAAC;YAED,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,CAAC,QAAQ,EAAE,IAAI,EAAE,OAAO,CAAC,EAAE;gBAC1E,SAAS,EAAE,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,MAAM,CAAC;gBAC1C,MAAM,EAAE,OAAO,EAAE,MAAM;aACxB,CAAC,CAAC;YAEH,MAAM,WAAW,GAAG,oBAAoB,CAAC,aAAa,CAAC,CAAC;YACxD,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,CAAC;gBACpB,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC;YAChC,CAAC;iBAAM,CAAC;gBACN,gEAAgE;gBAChE,SAAS,GAAG,SAAS,CAAC;gBACtB,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;YACvB,CAAC;YAED,OAAO,EAAE,CAAC;YACV,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,GAAG,OAAO,GAAG,GAAG,CAAC,CAAC;YACvD,MAAM,IAAI,CAAC,KAAK,CAAC,SAAS,EAAE,OAAO,EAAE,MAAM,CAAC,CAAC;QAC/C,CAAC;QAED,IAAI,OAAO,EAAE,gBAAgB,KAAK,IAAI,IAAI,CAAC,iBAAiB,IAAI,CAAC,SAAS,EAAE,CAAC;YAC3E,OAAO,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC;QACvB,CAAC;QAED,OAAO,IAAA,YAAG,EAAC,SAAS,IAAI,oCAAoC,CAAC,CAAC;IAAA,CAC/D;IAED;;;;;OAKG;IACH,KAAK,CAAC,eAAe,CAAC,IAAY,EAAiB;QACjD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE;YACxD,SAAS,EAAE,MAAM;YACjB,gBAAgB,EAAE,KAAK;SACxB,CAAC,CAAC;QAEH,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;YACpB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAChC,CAAC;IAAA,CACF;IAED;;;OAGG;IACH,KAAK,CAAC,eAAe,GAAkB;;;YACrC,SAAG,CAAC,KAAK,CAAC,2BAA2B,CAAC,CAAC;YACvC,MAAM,IAAI,mCAAG,IAAA,0BAAS,EAAC,wBAAwB,CAAC,QAAA,CAAC;YACjD,MAAM,IAAI,CAAC,MAAM,CAAC;;;;;;;;;IAAA,CACnB;CACF;;AAED,qBAAqB;AACR,QAAA,YAAY,GAAG,IAAI,YAAY,EAAE,CAAC","sourcesContent":["/**\r\n * Service for interacting with the Coder CLI.\r\n * Used to create/manage Coder workspaces as SSH targets for Mux workspaces.\r\n */\r\nimport { shescape } from \"@/node/runtime/streamUtils\";\r\nimport { execAsync } from \"@/node/utils/disposableExec\";\r\nimport { getBashPath } from \"@/node/utils/main/bashPath\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { spawn, type ChildProcess } from \"child_process\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport {\r\n  CoderWorkspaceStatusSchema,\r\n  type CoderInfo,\r\n  type CoderListPresetsResult,\r\n  type CoderListTemplatesResult,\r\n  type CoderListWorkspacesResult,\r\n  type CoderTemplate,\r\n  type CoderPreset,\r\n  type CoderWorkspace,\r\n  type CoderWorkspaceStatus,\r\n} from \"@/common/orpc/schemas/coder\";\r\n\r\n// Re-export types for consumers that import from this module\r\n\r\nexport interface CoderApiSession {\r\n  token: string;\r\n  dispose: () => Promise<void>;\r\n}\r\nexport type {\r\n  CoderInfo,\r\n  CoderListPresetsResult,\r\n  CoderListTemplatesResult,\r\n  CoderListWorkspacesResult,\r\n  CoderTemplate,\r\n  CoderPreset,\r\n  CoderWorkspace,\r\n  CoderWorkspaceStatus,\r\n};\r\n\r\ninterface CoderWhoamiData {\r\n  url: string;\r\n  username?: string;\r\n  id?: string;\r\n}\r\n\r\n/** Discriminated union for workspace status check results */\r\nexport type WorkspaceStatusResult =\r\n  | { kind: \"ok\"; status: CoderWorkspaceStatus }\r\n  | { kind: \"not_found\" }\r\n  | { kind: \"error\"; error: string };\r\n\r\n/**\r\n * Serialize a Coder parameter default_value to string.\r\n * Preserves numeric/boolean/array values instead of coercing to \"\".\r\n */\r\nfunction serializeParameterDefault(value: unknown): string {\r\n  if (value == null) return \"\";\r\n  if (typeof value === \"string\") return value;\r\n  if (typeof value === \"number\" || typeof value === \"boolean\") return String(value);\r\n  // Arrays/objects (e.g., list(string) type) → JSON\r\n  return JSON.stringify(value);\r\n}\r\n\r\n// Minimum supported Coder CLI version\r\nconst MIN_CODER_VERSION = \"2.25.0\";\r\n\r\n/**\r\n * Normalize a version string for comparison.\r\n * Strips leading \"v\", dev suffixes like \"-devel+hash\", and build metadata.\r\n * Example: \"v2.28.6+df47153\" → \"2.28.6\"\r\n */\r\nfunction normalizeVersion(v: string): string {\r\n  return v\r\n    .replace(/^v/i, \"\") // Strip leading v/V\r\n    .split(\"-\")[0] // Remove pre-release suffix\r\n    .split(\"+\")[0]; // Remove build metadata\r\n}\r\n\r\n/**\r\n * Compare two semver versions. Returns:\r\n * - negative if a < b\r\n * - 0 if a === b\r\n * - positive if a > b\r\n */\r\nexport function compareVersions(a: string, b: string): number {\r\n  const aParts = normalizeVersion(a).split(\".\").map(Number);\r\n  const bParts = normalizeVersion(b).split(\".\").map(Number);\r\n\r\n  for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {\r\n    const aPart = aParts[i] ?? 0;\r\n    const bPart = bParts[i] ?? 0;\r\n    if (aPart !== bPart) return aPart - bPart;\r\n  }\r\n  return 0;\r\n}\r\n\r\nconst SIGKILL_GRACE_PERIOD_MS = 5000;\r\n\r\nfunction createGracefulTerminator(\r\n  child: ChildProcess,\r\n  options?: { sigkillAfterMs?: number }\r\n): {\r\n  terminate: () => void;\r\n  cleanup: () => void;\r\n} {\r\n  const sigkillAfterMs = options?.sigkillAfterMs ?? SIGKILL_GRACE_PERIOD_MS;\r\n  let sigkillTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  const scheduleSigkill = () => {\r\n    if (sigkillTimer) return;\r\n    sigkillTimer = setTimeout(() => {\r\n      sigkillTimer = null;\r\n      // Only attempt SIGKILL if the process still appears to be running.\r\n      if (child.exitCode === null && child.signalCode === null) {\r\n        try {\r\n          child.kill(\"SIGKILL\");\r\n        } catch {\r\n          // ignore\r\n        }\r\n      }\r\n    }, sigkillAfterMs);\r\n  };\r\n\r\n  const terminate = () => {\r\n    try {\r\n      child.kill(\"SIGTERM\");\r\n    } catch {\r\n      // ignore\r\n    }\r\n    scheduleSigkill();\r\n  };\r\n\r\n  const cleanup = () => {\r\n    if (sigkillTimer) {\r\n      clearTimeout(sigkillTimer);\r\n      sigkillTimer = null;\r\n    }\r\n  };\r\n\r\n  return { terminate, cleanup };\r\n}\r\n\r\n/**\r\n * Stream output from a coder CLI command line by line.\r\n * Yields lines as they arrive from stdout/stderr.\r\n * Throws on non-zero exit with stderr content in the error message.\r\n *\r\n * @param args Command arguments (e.g., [\"start\", \"-y\", \"my-ws\"])\r\n * @param errorPrefix Prefix for error messages (e.g., \"coder start failed\")\r\n * @param abortSignal Optional signal to cancel the command\r\n * @param abortMessage Message to throw when aborted\r\n */\r\nasync function* streamCoderCommand(\r\n  args: string[],\r\n  errorPrefix: string,\r\n  abortSignal?: AbortSignal,\r\n  abortMessage = \"Coder command aborted\"\r\n): AsyncGenerator<string, void, unknown> {\r\n  if (abortSignal?.aborted) {\r\n    throw new Error(abortMessage);\r\n  }\r\n\r\n  // Yield the command we're about to run so it's visible in UI\r\n  yield `$ coder ${args.join(\" \")}`;\r\n\r\n  const child = spawn(\"coder\", args, {\r\n    stdio: [\"ignore\", \"pipe\", \"pipe\"],\r\n  });\r\n\r\n  const terminator = createGracefulTerminator(child);\r\n\r\n  const abortHandler = () => {\r\n    terminator.terminate();\r\n  };\r\n  abortSignal?.addEventListener(\"abort\", abortHandler);\r\n\r\n  try {\r\n    // Use an async queue to stream lines as they arrive\r\n    const lineQueue: string[] = [];\r\n    const stderrLines: string[] = [];\r\n    let streamsDone = false;\r\n    let resolveNext: (() => void) | null = null;\r\n\r\n    const pushLine = (line: string) => {\r\n      lineQueue.push(line);\r\n      if (resolveNext) {\r\n        resolveNext();\r\n        resolveNext = null;\r\n      }\r\n    };\r\n\r\n    let pending = 2;\r\n    const markDone = () => {\r\n      pending--;\r\n      if (pending === 0) {\r\n        streamsDone = true;\r\n        if (resolveNext) {\r\n          resolveNext();\r\n          resolveNext = null;\r\n        }\r\n      }\r\n    };\r\n\r\n    const processStream = (stream: NodeJS.ReadableStream | null, isStderr: boolean) => {\r\n      if (!stream) {\r\n        markDone();\r\n        return;\r\n      }\r\n      let buffer = \"\";\r\n      stream.on(\"data\", (chunk: Buffer) => {\r\n        buffer += chunk.toString();\r\n        const parts = buffer.split(\"\\n\");\r\n        buffer = parts.pop() ?? \"\";\r\n        for (const line of parts) {\r\n          const trimmed = line.trim();\r\n          if (trimmed) {\r\n            pushLine(trimmed);\r\n            if (isStderr) stderrLines.push(trimmed);\r\n          }\r\n        }\r\n      });\r\n      stream.on(\"end\", () => {\r\n        if (buffer.trim()) {\r\n          pushLine(buffer.trim());\r\n          if (isStderr) stderrLines.push(buffer.trim());\r\n        }\r\n        markDone();\r\n      });\r\n      stream.on(\"error\", markDone);\r\n    };\r\n\r\n    processStream(child.stdout, false);\r\n    processStream(child.stderr, true);\r\n\r\n    // Yield lines as they arrive\r\n    while (!streamsDone || lineQueue.length > 0) {\r\n      if (lineQueue.length > 0) {\r\n        yield lineQueue.shift()!;\r\n      } else if (!streamsDone) {\r\n        await new Promise<void>((resolve) => {\r\n          resolveNext = resolve;\r\n        });\r\n      }\r\n    }\r\n\r\n    // Wait for process to exit\r\n    const exitCode = await new Promise<number | null>((resolve) => {\r\n      child.on(\"close\", resolve);\r\n      child.on(\"error\", () => resolve(null));\r\n    });\r\n\r\n    if (abortSignal?.aborted) {\r\n      throw new Error(abortMessage);\r\n    }\r\n\r\n    if (exitCode !== 0) {\r\n      const errorDetail = stderrLines.length > 0 ? `: ${stderrLines.join(\" | \")}` : \"\";\r\n      throw new Error(`${errorPrefix} (exit ${String(exitCode)})${errorDetail}`);\r\n    }\r\n  } finally {\r\n    terminator.cleanup();\r\n    abortSignal?.removeEventListener(\"abort\", abortHandler);\r\n  }\r\n}\r\n\r\ninterface CoderCommandResult {\r\n  exitCode: number | null;\r\n  stdout: string;\r\n  stderr: string;\r\n  error?: \"timeout\" | \"aborted\";\r\n}\r\n\r\ntype InterpretedCoderCommandResult =\r\n  | { ok: true; stdout: string; stderr: string }\r\n  | { ok: false; error: string; combined: string };\r\n\r\nfunction interpretCoderResult(result: CoderCommandResult): InterpretedCoderCommandResult {\r\n  const combined = `${result.stderr}\\n${result.stdout}`.trim();\r\n\r\n  if (result.error) {\r\n    return { ok: false, error: result.error, combined };\r\n  }\r\n\r\n  if (result.exitCode !== 0) {\r\n    return {\r\n      ok: false,\r\n      error: combined || `Exit code ${String(result.exitCode)}`,\r\n      combined,\r\n    };\r\n  }\r\n\r\n  return { ok: true, stdout: result.stdout, stderr: result.stderr };\r\n}\r\n\r\nfunction sanitizeCoderCliErrorForUi(error: unknown): string {\r\n  if (!(error instanceof Error)) {\r\n    return \"Unknown error\";\r\n  }\r\n\r\n  const err = error as Partial<{ stderr: string; message: string }>;\r\n  const raw = (err.stderr?.trim() ? err.stderr : err.message) ?? \"\";\r\n\r\n  const lines = raw\r\n    .split(/\\r?\\n/)\r\n    .map((line) => line.trim())\r\n    .filter(Boolean);\r\n\r\n  if (lines.length === 0) {\r\n    return \"Unknown error\";\r\n  }\r\n\r\n  // Coder often prints a generic \"Encountered an error running...\" line followed by\r\n  // a more actionable \"error: ...\" line. Prefer the latter when present.\r\n  const preferred =\r\n    [...lines].reverse().find((line) => /^error:\\s*/i.test(line)) ?? lines[lines.length - 1];\r\n\r\n  return (\r\n    preferred\r\n      .replace(/^error:\\s*/i, \"\")\r\n      .slice(0, 200)\r\n      .trim() || \"Unknown error\"\r\n  );\r\n}\r\n\r\nexport class CoderService {\r\n  // Ephemeral API sessions scoped to workspace provisioning.\r\n  // This keeps token reuse explicit without persisting anything to disk.\r\n  private provisioningSessions = new Map<string, CoderApiSession>();\r\n  private cachedInfo: CoderInfo | null = null;\r\n  // Cache whoami results so later URL lookups can reuse the last CLI response.\r\n  private cachedWhoami: CoderWhoamiData | null = null;\r\n\r\n  private async resolveCoderBinaryPath(): Promise<string | null> {\r\n    let shell: string | undefined;\r\n    if (process.platform === \"win32\") {\r\n      try {\r\n        shell = getBashPath();\r\n      } catch {\r\n        // Best-effort; if Git Bash isn't available, the lookup may fail and we'll fall back to null.\r\n      }\r\n    }\r\n\r\n    try {\r\n      using proc = execAsync(\"command -v coder\", shell ? { shell } : undefined);\r\n      const { stdout } = await proc.result;\r\n      const firstLine = stdout.split(/\\r?\\n/)[0]?.trim();\r\n      return firstLine || null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get Coder CLI info. Caches result for the session.\r\n   * Returns discriminated union: available | outdated | unavailable.\r\n   */\r\n  async getCoderInfo(): Promise<CoderInfo> {\r\n    if (this.cachedInfo) {\r\n      return this.cachedInfo;\r\n    }\r\n\r\n    // Resolve the Coder binary path for better error messages (helps when multiple binaries are on PATH).\r\n    const binaryPath = await this.resolveCoderBinaryPath();\r\n\r\n    try {\r\n      using proc = execAsync(\"coder version --output=json\");\r\n      const { stdout } = await proc.result;\r\n\r\n      // Parse JSON output\r\n      const data = JSON.parse(stdout) as { version?: string };\r\n      const version = data.version;\r\n\r\n      if (!version) {\r\n        this.cachedInfo = {\r\n          state: \"unavailable\",\r\n          reason: { kind: \"error\", message: \"Version output missing from CLI\" },\r\n        };\r\n        return this.cachedInfo;\r\n      }\r\n\r\n      // Check minimum version\r\n      if (compareVersions(version, MIN_CODER_VERSION) < 0) {\r\n        log.debug(`Coder CLI version ${version} is below minimum ${MIN_CODER_VERSION}`);\r\n        this.cachedInfo = {\r\n          state: \"outdated\",\r\n          version,\r\n          minVersion: MIN_CODER_VERSION,\r\n          ...(binaryPath ? { binaryPath } : {}),\r\n        };\r\n        return this.cachedInfo;\r\n      }\r\n\r\n      let whoami: CoderWhoamiData | null = null;\r\n      try {\r\n        whoami = await this.getWhoamiData();\r\n      } catch (error) {\r\n        // Treat whoami failures as a blocking issue for the Coder runtime.\r\n        // If the CLI isn't logged in, users will hit confusing failures later during provisioning.\r\n        const err = error as Partial<{ stderr: string; message: string }>;\r\n        const raw = (err.stderr?.trim() ? err.stderr : err.message) ?? \"\";\r\n        const normalized = raw.toLowerCase();\r\n\r\n        const isNotLoggedIn =\r\n          normalized.includes(\"not logged in\") ||\r\n          normalized.includes(\"try logging in\") ||\r\n          normalized.includes(\"please login\") ||\r\n          normalized.includes(\"coder login\");\r\n\r\n        const lastLine =\r\n          raw\r\n            .split(/\\r?\\n/)\r\n            .map((line) => line.trim())\r\n            .filter(Boolean)\r\n            .at(-1) ?? \"\";\r\n\r\n        const sanitizedLine =\r\n          lastLine\r\n            .replace(/^error:\\s*/i, \"\")\r\n            .slice(0, 200)\r\n            .trim() || \"Unknown error\";\r\n\r\n        const notLoggedInMessage = binaryPath\r\n          ? `${binaryPath} is ${sanitizedLine.replace(/^you are\\s+/i, \"\")}`\r\n          : sanitizedLine;\r\n\r\n        log.debug(\"Failed to fetch Coder whoami data\", { error });\r\n\r\n        const result: CoderInfo = isNotLoggedIn\r\n          ? { state: \"unavailable\", reason: { kind: \"not-logged-in\", message: notLoggedInMessage } }\r\n          : { state: \"unavailable\", reason: { kind: \"error\", message: sanitizedLine } };\r\n\r\n        // Don't cache whoami failures: users can often recover without restarting the app\r\n        // (e.g., temporary network issues or `coder login`).\r\n        return result;\r\n      }\r\n\r\n      const availableInfo: CoderInfo = {\r\n        state: \"available\",\r\n        version,\r\n        ...(whoami?.username ? { username: whoami.username } : {}),\r\n        ...(whoami?.url ? { url: whoami.url } : {}),\r\n      };\r\n\r\n      this.cachedInfo = availableInfo;\r\n      return this.cachedInfo;\r\n    } catch (error) {\r\n      log.debug(\"Coder CLI not available\", { error });\r\n      this.cachedInfo = this.classifyCoderError(error);\r\n      return this.cachedInfo;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Classify an error from the Coder CLI as missing or error with message.\r\n   */\r\n  private classifyCoderError(error: unknown): CoderInfo {\r\n    // ENOENT or \"command not found\" = CLI not installed\r\n    if (error instanceof Error) {\r\n      const code = (error as NodeJS.ErrnoException).code;\r\n      const message = error.message.toLowerCase();\r\n      if (\r\n        code === \"ENOENT\" ||\r\n        message.includes(\"command not found\") ||\r\n        message.includes(\"enoent\")\r\n      ) {\r\n        return { state: \"unavailable\", reason: \"missing\" };\r\n      }\r\n      // Other errors: include sanitized message (single line, capped length)\r\n      const sanitized = sanitizeCoderCliErrorForUi(error);\r\n      return {\r\n        state: \"unavailable\",\r\n        reason: { kind: \"error\", message: sanitized },\r\n      };\r\n    }\r\n    return { state: \"unavailable\", reason: { kind: \"error\", message: \"Unknown error\" } };\r\n  }\r\n\r\n  /**\r\n   * Create a short-lived Coder API token for deployment endpoints.\r\n   */\r\n  private async createApiSession(tokenName: string): Promise<CoderApiSession> {\r\n    using tokenProc = execAsync(\r\n      `coder tokens create --lifetime 5m --name ${shescape.quote(tokenName)}`\r\n    );\r\n    const { stdout: token } = await tokenProc.result;\r\n    const trimmed = token.trim();\r\n\r\n    return {\r\n      token: trimmed,\r\n      dispose: async () => {\r\n        try {\r\n          using deleteProc = execAsync(`coder tokens delete ${shescape.quote(tokenName)}`);\r\n          await deleteProc.result;\r\n        } catch {\r\n          // Best-effort cleanup; token will expire in 5 minutes anyway.\r\n          log.debug(\"Failed to delete temporary Coder API token\", { tokenName });\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  private async withApiSession<T>(\r\n    tokenName: string,\r\n    fn: (session: CoderApiSession) => Promise<T>\r\n  ): Promise<T> {\r\n    const session = await this.createApiSession(tokenName);\r\n    try {\r\n      return await fn(session);\r\n    } finally {\r\n      await session.dispose();\r\n    }\r\n  }\r\n\r\n  async ensureProvisioningSession(workspaceName: string): Promise<CoderApiSession> {\r\n    const existing = this.provisioningSessions.get(workspaceName);\r\n    if (existing) {\r\n      return existing;\r\n    }\r\n\r\n    const tokenName = `mux-${workspaceName}-${Date.now().toString(36)}`;\r\n    const session = await this.createApiSession(tokenName);\r\n    this.provisioningSessions.set(workspaceName, session);\r\n    return session;\r\n  }\r\n\r\n  takeProvisioningSession(workspaceName: string): CoderApiSession | undefined {\r\n    const session = this.provisioningSessions.get(workspaceName);\r\n    if (session) {\r\n      this.provisioningSessions.delete(workspaceName);\r\n    }\r\n    return session;\r\n  }\r\n\r\n  async disposeProvisioningSession(workspaceName: string): Promise<void> {\r\n    const session = this.provisioningSessions.get(workspaceName);\r\n    if (!session) {\r\n      return;\r\n    }\r\n    this.provisioningSessions.delete(workspaceName);\r\n    await session.dispose();\r\n  }\r\n\r\n  private normalizeHostnameSuffix(raw: string | undefined): string {\r\n    const cleaned = (raw ?? \"\").trim().replace(/^\\./, \"\");\r\n    return cleaned || \"coder\";\r\n  }\r\n\r\n  async fetchDeploymentSshConfig(session?: CoderApiSession): Promise<{ hostnameSuffix: string }> {\r\n    const deploymentUrl = await this.getDeploymentUrl();\r\n    const tokenName = `mux-ssh-config-${Date.now().toString(36)}`;\r\n\r\n    const run = async (api: CoderApiSession) => {\r\n      const url = new URL(\"/api/v2/deployment/ssh\", deploymentUrl);\r\n      const response = await fetch(url, {\r\n        headers: { \"Coder-Session-Token\": api.token },\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to fetch SSH config: ${response.status}`);\r\n      }\r\n\r\n      const data = (await response.json()) as { hostname_suffix?: string };\r\n      return { hostnameSuffix: this.normalizeHostnameSuffix(data.hostname_suffix) };\r\n    };\r\n\r\n    return session ? run(session) : this.withApiSession(tokenName, run);\r\n  }\r\n  /**\r\n   * Clear cached Coder info. Used for testing.\r\n   */\r\n  clearCache(): void {\r\n    this.cachedInfo = null;\r\n    this.cachedWhoami = null;\r\n  }\r\n\r\n  // Preserve the old behavior: explicit whoami checks should hit the CLI even if cached.\r\n  // The cache only exists so later URL lookups can reuse the last whoami response.\r\n  private async getWhoamiData(options?: { useCache?: boolean }): Promise<CoderWhoamiData> {\r\n    if (options?.useCache && this.cachedWhoami) {\r\n      return this.cachedWhoami;\r\n    }\r\n\r\n    using proc = execAsync(\"coder whoami --output=json\");\r\n    const { stdout } = await proc.result;\r\n\r\n    const data = JSON.parse(stdout) as Array<Partial<CoderWhoamiData>>;\r\n    if (!data[0]?.url) {\r\n      throw new Error(\"Could not determine Coder deployment URL from `coder whoami`\");\r\n    }\r\n\r\n    this.cachedWhoami = {\r\n      url: data[0].url,\r\n      username: data[0].username,\r\n      id: data[0].id,\r\n    };\r\n\r\n    return this.cachedWhoami;\r\n  }\r\n\r\n  /**\r\n   * Get the Coder deployment URL via `coder whoami`.\r\n   * Throws if Coder CLI is not configured/logged in.\r\n   */\r\n  private async getDeploymentUrl(): Promise<string> {\r\n    const { url } = await this.getWhoamiData({ useCache: true });\r\n    return url;\r\n  }\r\n\r\n  /**\r\n   * Get the active template version ID for a template.\r\n   * Throws if template not found.\r\n   */\r\n  private async getActiveTemplateVersionId(templateName: string, org?: string): Promise<string> {\r\n    // Note: `coder templates list` doesn't support --org flag, so we filter client-side\r\n    using proc = execAsync(\"coder templates list --output=json\");\r\n    const { stdout } = await proc.result;\r\n\r\n    if (!stdout.trim()) {\r\n      throw new Error(`Template \"${templateName}\" not found (no templates exist)`);\r\n    }\r\n\r\n    const raw = JSON.parse(stdout) as Array<{\r\n      Template: {\r\n        name: string;\r\n        organization_name: string;\r\n        active_version_id: string;\r\n      };\r\n    }>;\r\n\r\n    // Filter by name and optionally by org for disambiguation\r\n    const template = raw.find(\r\n      (t) => t.Template.name === templateName && (!org || t.Template.organization_name === org)\r\n    );\r\n    if (!template) {\r\n      const orgSuffix = org ? ` in organization \"${org}\"` : \"\";\r\n      throw new Error(`Template \"${templateName}\" not found${orgSuffix}`);\r\n    }\r\n\r\n    return template.Template.active_version_id;\r\n  }\r\n\r\n  /**\r\n   * Get parameter names covered by a preset.\r\n   * Returns empty set if preset not found (allows creation to proceed without preset params).\r\n   */\r\n  private async getPresetParamNames(\r\n    templateName: string,\r\n    presetName: string,\r\n    org?: string\r\n  ): Promise<Set<string>> {\r\n    try {\r\n      const orgFlag = org ? ` --org ${shescape.quote(org)}` : \"\";\r\n      using proc = execAsync(\r\n        `coder templates presets list ${shescape.quote(templateName)}${orgFlag} --output=json`\r\n      );\r\n      const { stdout } = await proc.result;\r\n\r\n      // Same non-JSON guard as listPresets (CLI prints info message for no presets)\r\n      if (!stdout.trim() || !stdout.trimStart().startsWith(\"[\")) {\r\n        return new Set();\r\n      }\r\n\r\n      const raw = JSON.parse(stdout) as Array<{\r\n        TemplatePreset: {\r\n          Name: string;\r\n          Parameters?: Array<{ Name: string }>;\r\n        };\r\n      }>;\r\n\r\n      const preset = raw.find((p) => p.TemplatePreset.Name === presetName);\r\n      if (!preset?.TemplatePreset.Parameters) {\r\n        return new Set();\r\n      }\r\n\r\n      return new Set(preset.TemplatePreset.Parameters.map((p) => p.Name));\r\n    } catch (error) {\r\n      log.debug(\"Failed to get preset param names\", { templateName, presetName, error });\r\n      return new Set();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse rich parameter data from the Coder API.\r\n   * Filters out entries with missing/invalid names to avoid generating invalid --parameter flags.\r\n   */\r\n  private parseRichParameters(data: unknown): Array<{\r\n    name: string;\r\n    defaultValue: string;\r\n    type: string;\r\n    ephemeral: boolean;\r\n    required: boolean;\r\n  }> {\r\n    if (!Array.isArray(data)) {\r\n      throw new Error(\"Expected array of rich parameters\");\r\n    }\r\n    return data\r\n      .filter((p): p is Record<string, unknown> => {\r\n        if (p === null || typeof p !== \"object\") return false;\r\n        const obj = p as Record<string, unknown>;\r\n        return typeof obj.name === \"string\" && obj.name !== \"\";\r\n      })\r\n      .map((p) => ({\r\n        name: p.name as string,\r\n        defaultValue: serializeParameterDefault(p.default_value),\r\n        type: typeof p.type === \"string\" ? p.type : \"string\",\r\n        ephemeral: Boolean(p.ephemeral),\r\n        required: Boolean(p.required),\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * Fetch template rich parameters from Coder API.\r\n   * Uses an optional API session to avoid generating multiple tokens.\r\n   */\r\n  private async getTemplateRichParameters(\r\n    deploymentUrl: string,\r\n    versionId: string,\r\n    workspaceName: string,\r\n    session?: CoderApiSession\r\n  ): Promise<\r\n    Array<{\r\n      name: string;\r\n      defaultValue: string;\r\n      type: string;\r\n      ephemeral: boolean;\r\n      required: boolean;\r\n    }>\r\n  > {\r\n    const run = async (api: CoderApiSession) => {\r\n      const url = new URL(\r\n        `/api/v2/templateversions/${versionId}/rich-parameters`,\r\n        deploymentUrl\r\n      ).toString();\r\n\r\n      const response = await fetch(url, {\r\n        headers: {\r\n          \"Coder-Session-Token\": api.token,\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(\r\n          `Failed to fetch rich parameters: ${response.status} ${response.statusText}`\r\n        );\r\n      }\r\n\r\n      const data: unknown = await response.json();\r\n      return this.parseRichParameters(data);\r\n    };\r\n\r\n    const tokenName = `mux-${workspaceName}`;\r\n    return session ? run(session) : this.withApiSession(tokenName, run);\r\n  }\r\n\r\n  /**\r\n   * Encode a parameter string for the Coder CLI's --parameter flag.\r\n   * The CLI uses CSV parsing, so values containing quotes or commas need escaping:\r\n   * - Wrap the entire string in double quotes\r\n   * - Escape internal double quotes as \"\"\r\n   */\r\n  private encodeParameterValue(nameValue: string): string {\r\n    if (!nameValue.includes('\"') && !nameValue.includes(\",\")) {\r\n      return nameValue;\r\n    }\r\n    // CSV quoting: wrap in quotes, escape internal quotes as \"\"\r\n    return `\"${nameValue.replace(/\"/g, '\"\"')}\"`;\r\n  }\r\n\r\n  /**\r\n   * Compute extra --parameter flags needed for workspace creation.\r\n   * Filters to non-ephemeral params not covered by preset, using their defaults.\r\n   * Values are passed through as-is (list(string) types expect JSON-encoded arrays).\r\n   */\r\n  computeExtraParams(\r\n    allParams: Array<{\r\n      name: string;\r\n      defaultValue: string;\r\n      type: string;\r\n      ephemeral: boolean;\r\n      required: boolean;\r\n    }>,\r\n    coveredByPreset: Set<string>\r\n  ): Array<{ name: string; encoded: string }> {\r\n    const extra: Array<{ name: string; encoded: string }> = [];\r\n\r\n    for (const p of allParams) {\r\n      // Skip ephemeral params\r\n      if (p.ephemeral) continue;\r\n      // Skip params covered by preset\r\n      if (coveredByPreset.has(p.name)) continue;\r\n\r\n      // Encode for CLI's CSV parser (escape quotes/commas)\r\n      const encoded = this.encodeParameterValue(`${p.name}=${p.defaultValue}`);\r\n      extra.push({ name: p.name, encoded });\r\n    }\r\n\r\n    return extra;\r\n  }\r\n\r\n  /**\r\n   * Validate that all required params have values (either from preset or defaults).\r\n   * Throws if any required param is missing a value.\r\n   */\r\n  validateRequiredParams(\r\n    allParams: Array<{\r\n      name: string;\r\n      defaultValue: string;\r\n      type: string;\r\n      ephemeral: boolean;\r\n      required: boolean;\r\n    }>,\r\n    coveredByPreset: Set<string>\r\n  ): void {\r\n    const missing: string[] = [];\r\n\r\n    for (const p of allParams) {\r\n      if (p.ephemeral) continue;\r\n      if (p.required && !p.defaultValue && !coveredByPreset.has(p.name)) {\r\n        missing.push(p.name);\r\n      }\r\n    }\r\n\r\n    if (missing.length > 0) {\r\n      throw new Error(\r\n        `Required template parameters missing values: ${missing.join(\", \")}. ` +\r\n          `Select a preset that provides these values or contact your template admin.`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List available Coder templates.\r\n   */\r\n  async listTemplates(): Promise<CoderListTemplatesResult> {\r\n    try {\r\n      using proc = execAsync(\"coder templates list --output=json\");\r\n      const { stdout } = await proc.result;\r\n\r\n      // Handle empty output (no templates)\r\n      if (!stdout.trim()) {\r\n        return { ok: true, templates: [] };\r\n      }\r\n\r\n      // CLI returns [{Template: {...}}, ...] wrapper structure\r\n      const raw = JSON.parse(stdout) as Array<{\r\n        Template: {\r\n          name: string;\r\n          display_name?: string;\r\n          organization_name?: string;\r\n        };\r\n      }>;\r\n\r\n      return {\r\n        ok: true,\r\n        templates: raw.map((entry) => ({\r\n          name: entry.Template.name,\r\n          displayName: entry.Template.display_name ?? entry.Template.name,\r\n          organizationName: entry.Template.organization_name ?? \"default\",\r\n        })),\r\n      };\r\n    } catch (error) {\r\n      const message = sanitizeCoderCliErrorForUi(error);\r\n      // Surface CLI failures so the UI doesn't show \"No templates\" incorrectly.\r\n      log.warn(\"Failed to list Coder templates\", { error });\r\n      return { ok: false, error: message || \"Unknown error\" };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List presets for a template.\r\n   * @param templateName - Template name\r\n   * @param org - Organization name for disambiguation (optional)\r\n   */\r\n  async listPresets(templateName: string, org?: string): Promise<CoderListPresetsResult> {\r\n    try {\r\n      const orgFlag = org ? ` --org ${shescape.quote(org)}` : \"\";\r\n      using proc = execAsync(\r\n        `coder templates presets list ${shescape.quote(templateName)}${orgFlag} --output=json`\r\n      );\r\n      const { stdout } = await proc.result;\r\n\r\n      // Handle empty output or non-JSON info messages (no presets).\r\n      // CLI prints \"No presets found for template ...\" to stdout even with --output=json\r\n      // because the Go handler returns early before the formatter runs.\r\n      if (!stdout.trim() || !stdout.trimStart().startsWith(\"[\")) {\r\n        return { ok: true, presets: [] };\r\n      }\r\n\r\n      // CLI returns [{TemplatePreset: {ID, Name, ...}}, ...] wrapper structure\r\n      const raw = JSON.parse(stdout) as Array<{\r\n        TemplatePreset: {\r\n          ID: string;\r\n          Name: string;\r\n          Description?: string;\r\n          Default?: boolean;\r\n        };\r\n      }>;\r\n\r\n      return {\r\n        ok: true,\r\n        presets: raw.map((entry) => ({\r\n          id: entry.TemplatePreset.ID,\r\n          name: entry.TemplatePreset.Name,\r\n          description: entry.TemplatePreset.Description,\r\n          isDefault: entry.TemplatePreset.Default ?? false,\r\n        })),\r\n      };\r\n    } catch (error) {\r\n      const message = sanitizeCoderCliErrorForUi(error);\r\n      // Surface CLI failures so the UI doesn't show \"No presets\" incorrectly.\r\n      log.warn(\"Failed to list Coder presets\", { templateName, error });\r\n      return { ok: false, error: message || \"Unknown error\" };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if a Coder workspace exists by name.\r\n   *\r\n   * Uses `coder list --search name:<workspace>` so we don't have to fetch all workspaces.\r\n   * Note: Coder's `--search` is prefix-based server-side, so we must exact-match locally.\r\n   */\r\n  async workspaceExists(workspaceName: string): Promise<boolean> {\r\n    try {\r\n      using proc = execAsync(\r\n        `coder list --search ${shescape.quote(`name:${workspaceName}`)} --output=json`\r\n      );\r\n      const { stdout } = await proc.result;\r\n\r\n      if (!stdout.trim()) {\r\n        return false;\r\n      }\r\n\r\n      const workspaces = JSON.parse(stdout) as Array<{ name: string }>;\r\n      return workspaces.some((w) => w.name === workspaceName);\r\n    } catch (error) {\r\n      // Best-effort: if Coder isn't configured/logged in, treat as \"doesn't exist\" so we\r\n      // don't block creation (later steps will fail with a more actionable error).\r\n      log.debug(\"Failed to check if Coder workspace exists\", { workspaceName, error });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List Coder workspaces (all statuses).\r\n   */\r\n  async listWorkspaces(): Promise<CoderListWorkspacesResult> {\r\n    // Derive known statuses from schema to avoid duplication and prevent ORPC validation errors\r\n    const KNOWN_STATUSES = new Set<string>(CoderWorkspaceStatusSchema.options);\r\n\r\n    try {\r\n      using proc = execAsync(\"coder list --output=json\");\r\n      const { stdout } = await proc.result;\r\n\r\n      // Handle empty output (no workspaces)\r\n      if (!stdout.trim()) {\r\n        return { ok: true, workspaces: [] };\r\n      }\r\n\r\n      const workspaces = JSON.parse(stdout) as Array<{\r\n        name: string;\r\n        template_name: string;\r\n        template_display_name: string;\r\n        latest_build: {\r\n          status: string;\r\n        };\r\n      }>;\r\n\r\n      // Filter to known statuses to avoid ORPC schema validation failures\r\n      return {\r\n        ok: true,\r\n        workspaces: workspaces\r\n          .filter((w) => KNOWN_STATUSES.has(w.latest_build.status))\r\n          .map((w) => ({\r\n            name: w.name,\r\n            templateName: w.template_name,\r\n            templateDisplayName: w.template_display_name || w.template_name,\r\n            status: w.latest_build.status as CoderWorkspaceStatus,\r\n          })),\r\n      };\r\n    } catch (error) {\r\n      const message = sanitizeCoderCliErrorForUi(error);\r\n      // Users reported seeing \"No workspaces found\" even when the CLI failed,\r\n      // so surface an error state instead of silently returning an empty list.\r\n      log.warn(\"Failed to list Coder workspaces\", { error });\r\n      return { ok: false, error: message || \"Unknown error\" };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run a `coder` CLI command with timeout + optional cancellation.\r\n   *\r\n   * We use spawn (not execAsync) so ensureReady() can't hang forever on a stuck\r\n   * Coder CLI invocation.\r\n   */\r\n  private runCoderCommand(\r\n    args: string[],\r\n    options: { timeoutMs: number; signal?: AbortSignal }\r\n  ): Promise<CoderCommandResult> {\r\n    return new Promise((resolve) => {\r\n      if (options.timeoutMs <= 0) {\r\n        resolve({ exitCode: null, stdout: \"\", stderr: \"\", error: \"timeout\" });\r\n        return;\r\n      }\r\n\r\n      if (options.signal?.aborted) {\r\n        resolve({ exitCode: null, stdout: \"\", stderr: \"\", error: \"aborted\" });\r\n        return;\r\n      }\r\n\r\n      const child = spawn(\"coder\", args, {\r\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\r\n      });\r\n\r\n      let stdout = \"\";\r\n      let stderr = \"\";\r\n      let resolved = false;\r\n\r\n      let timeoutTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\n      const terminator = createGracefulTerminator(child);\r\n\r\n      const resolveOnce = (result: CoderCommandResult) => {\r\n        if (resolved) return;\r\n        resolved = true;\r\n        resolve(result);\r\n      };\r\n\r\n      const cleanup = (cleanupOptions?: { keepSigkillTimer?: boolean }) => {\r\n        if (timeoutTimer) {\r\n          clearTimeout(timeoutTimer);\r\n          timeoutTimer = null;\r\n        }\r\n        if (!cleanupOptions?.keepSigkillTimer) {\r\n          terminator.cleanup();\r\n        }\r\n        child.removeListener(\"close\", onClose);\r\n        child.removeListener(\"error\", onError);\r\n        options.signal?.removeEventListener(\"abort\", onAbort);\r\n      };\r\n\r\n      function onAbort() {\r\n        terminator.terminate();\r\n        // Keep SIGKILL escalation alive if SIGTERM doesn't work.\r\n        cleanup({ keepSigkillTimer: true });\r\n        resolveOnce({ exitCode: null, stdout, stderr, error: \"aborted\" });\r\n      }\r\n\r\n      function onError() {\r\n        cleanup();\r\n        resolveOnce({ exitCode: null, stdout, stderr });\r\n      }\r\n\r\n      function onClose(code: number | null) {\r\n        cleanup();\r\n        resolveOnce({ exitCode: code, stdout, stderr });\r\n      }\r\n\r\n      child.stdout?.on(\"data\", (chunk) => {\r\n        stdout += String(chunk);\r\n      });\r\n\r\n      child.stderr?.on(\"data\", (chunk) => {\r\n        stderr += String(chunk);\r\n      });\r\n\r\n      child.on(\"error\", onError);\r\n      child.on(\"close\", onClose);\r\n\r\n      timeoutTimer = setTimeout(() => {\r\n        terminator.terminate();\r\n\r\n        // Keep SIGKILL escalation alive if SIGTERM doesn't work.\r\n        // We still remove the abort listener to avoid leaking it beyond the call.\r\n        options.signal?.removeEventListener(\"abort\", onAbort);\r\n\r\n        resolveOnce({ exitCode: null, stdout, stderr, error: \"timeout\" });\r\n      }, options.timeoutMs);\r\n\r\n      options.signal?.addEventListener(\"abort\", onAbort);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get workspace status using control-plane query.\r\n   *\r\n   * Note: `coder list --search 'name:X'` is prefix-based on the server,\r\n   * so we must exact-match the workspace name client-side.\r\n   */\r\n  async getWorkspaceStatus(\r\n    workspaceName: string,\r\n    options?: { timeoutMs?: number; signal?: AbortSignal }\r\n  ): Promise<WorkspaceStatusResult> {\r\n    const timeoutMs = options?.timeoutMs ?? 10_000;\r\n\r\n    try {\r\n      const result = await this.runCoderCommand(\r\n        [\"list\", \"--search\", `name:${workspaceName}`, \"--output\", \"json\"],\r\n        { timeoutMs, signal: options?.signal }\r\n      );\r\n\r\n      const interpreted = interpretCoderResult(result);\r\n      if (!interpreted.ok) {\r\n        return { kind: \"error\", error: interpreted.error };\r\n      }\r\n\r\n      if (!interpreted.stdout.trim()) {\r\n        return { kind: \"not_found\" };\r\n      }\r\n\r\n      const workspaces = JSON.parse(interpreted.stdout) as Array<{\r\n        name: string;\r\n        latest_build: { status: string };\r\n      }>;\r\n\r\n      // Exact match required (search is prefix-based)\r\n      const match = workspaces.find((w) => w.name === workspaceName);\r\n      if (!match) {\r\n        return { kind: \"not_found\" };\r\n      }\r\n\r\n      // Validate status against known schema values\r\n      const status = match.latest_build.status;\r\n      const parsed = CoderWorkspaceStatusSchema.safeParse(status);\r\n      if (!parsed.success) {\r\n        log.warn(\"Unknown Coder workspace status\", { workspaceName, status });\r\n        return { kind: \"error\", error: `Unknown status: ${status}` };\r\n      }\r\n\r\n      return { kind: \"ok\", status: parsed.data };\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      log.debug(\"Failed to get Coder workspace status\", { workspaceName, error: message });\r\n      return { kind: \"error\", error: message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start a Coder workspace.\r\n   *\r\n   * Uses spawn + timeout so callers don't hang forever on a stuck CLI invocation.\r\n   */\r\n  async startWorkspace(\r\n    workspaceName: string,\r\n    options?: { timeoutMs?: number; signal?: AbortSignal }\r\n  ): Promise<Result<void>> {\r\n    const timeoutMs = options?.timeoutMs ?? 60_000;\r\n\r\n    try {\r\n      const result = await this.runCoderCommand([\"start\", workspaceName, \"--yes\"], {\r\n        timeoutMs,\r\n        signal: options?.signal,\r\n      });\r\n\r\n      const interpreted = interpretCoderResult(result);\r\n      if (!interpreted.ok) {\r\n        return Err(interpreted.error);\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop a Coder workspace.\r\n   *\r\n   * Uses spawn + timeout so callers don't hang forever on a stuck CLI invocation.\r\n   */\r\n  async stopWorkspace(\r\n    workspaceName: string,\r\n    options?: { timeoutMs?: number; signal?: AbortSignal }\r\n  ): Promise<Result<void>> {\r\n    const timeoutMs = options?.timeoutMs ?? 60_000;\r\n\r\n    try {\r\n      const result = await this.runCoderCommand([\"stop\", workspaceName, \"--yes\"], {\r\n        timeoutMs,\r\n        signal: options?.signal,\r\n      });\r\n\r\n      const interpreted = interpretCoderResult(result);\r\n      if (!interpreted.ok) {\r\n        return Err(interpreted.error);\r\n      }\r\n\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Wait for Coder workspace startup scripts to complete.\r\n   * Runs `coder ssh <workspace> --wait=yes -- true` and streams output.\r\n   */\r\n  async *waitForStartupScripts(\r\n    workspaceName: string,\r\n    abortSignal?: AbortSignal\r\n  ): AsyncGenerator<string, void, unknown> {\r\n    log.debug(\"Waiting for Coder startup scripts\", { workspaceName });\r\n    yield* streamCoderCommand(\r\n      [\"ssh\", workspaceName, \"--wait=yes\", \"--\", \"true\"],\r\n      \"coder ssh --wait failed\",\r\n      abortSignal,\r\n      \"Coder startup script wait aborted\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Create a new Coder workspace. Yields build log lines as they arrive.\r\n   *\r\n   * Pre-fetches template parameters and passes defaults via --parameter flags\r\n   * to avoid interactive prompts during creation.\r\n   *\r\n   * @param name Workspace name\r\n   * @param template Template name\r\n   * @param preset Optional preset name\r\n   * @param abortSignal Optional signal to cancel workspace creation\r\n   * @param org Optional organization name for disambiguation\r\n   * @param session Optional API session to reuse across deployment endpoints\r\n   */\r\n  async *createWorkspace(\r\n    name: string,\r\n    template: string,\r\n    preset?: string,\r\n    abortSignal?: AbortSignal,\r\n    org?: string,\r\n    session?: CoderApiSession\r\n  ): AsyncGenerator<string, void, unknown> {\r\n    log.debug(\"Creating Coder workspace\", { name, template, preset, org });\r\n\r\n    if (abortSignal?.aborted) {\r\n      throw new Error(\"Coder workspace creation aborted\");\r\n    }\r\n\r\n    // 1. Get deployment URL\r\n    const deploymentUrl = await this.getDeploymentUrl();\r\n\r\n    // 2. Get active template version ID\r\n    const versionId = await this.getActiveTemplateVersionId(template, org);\r\n\r\n    // 3. Get parameter names covered by preset (if any)\r\n    const coveredByPreset = preset\r\n      ? await this.getPresetParamNames(template, preset, org)\r\n      : new Set<string>();\r\n\r\n    // 4. Fetch all template parameters from API\r\n    const allParams = await this.getTemplateRichParameters(deploymentUrl, versionId, name, session);\r\n\r\n    // 5. Validate required params have values\r\n    this.validateRequiredParams(allParams, coveredByPreset);\r\n\r\n    // 6. Compute extra --parameter flags for non-ephemeral params not in preset\r\n    const extraParams = this.computeExtraParams(allParams, coveredByPreset);\r\n\r\n    log.debug(\"Computed extra params for coder create\", {\r\n      name,\r\n      template,\r\n      preset,\r\n      org,\r\n      extraParamCount: extraParams.length,\r\n      extraParamNames: extraParams.map((p) => p.name),\r\n    });\r\n\r\n    // 7. Build and run single coder create command\r\n    const args = [\"create\", name, \"-t\", template, \"--yes\"];\r\n    if (org) {\r\n      args.push(\"--org\", org);\r\n    }\r\n    if (preset) {\r\n      args.push(\"--preset\", preset);\r\n    }\r\n    for (const p of extraParams) {\r\n      args.push(\"--parameter\", p.encoded);\r\n    }\r\n\r\n    yield* streamCoderCommand(\r\n      args,\r\n      \"coder create failed\",\r\n      abortSignal,\r\n      \"Coder workspace creation aborted\"\r\n    );\r\n  }\r\n\r\n  /** Promise-based sleep helper */\r\n  private sleep(ms: number, signal?: AbortSignal): Promise<void> {\r\n    if (signal?.aborted) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    return new Promise((resolve) => {\r\n      const timeout = setTimeout(() => {\r\n        signal?.removeEventListener(\"abort\", onAbort);\r\n        resolve();\r\n      }, ms);\r\n\r\n      const onAbort = () => {\r\n        clearTimeout(timeout);\r\n        signal?.removeEventListener(\"abort\", onAbort);\r\n        resolve();\r\n      };\r\n\r\n      signal?.addEventListener(\"abort\", onAbort, { once: true });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete a Coder workspace, retrying across transient build states.\r\n   *\r\n   * This is used for \"cancel creation\" because aborting the local `coder create`\r\n   * process does not guarantee the control-plane build is canceled.\r\n   */\r\n  async deleteWorkspaceEventually(\r\n    name: string,\r\n    options?: {\r\n      timeoutMs?: number;\r\n      signal?: AbortSignal;\r\n      /**\r\n       * If true, treat an initial \"not found\" as inconclusive and keep polling.\r\n       * This avoids races where `coder create` finishes server-side after mux aborts the CLI.\r\n       */\r\n      waitForExistence?: boolean;\r\n      /**\r\n       * When `waitForExistence` is true: if we only see \"not found\" for this many ms\r\n       * without ever observing the workspace exist, treat it as success and return early.\r\n       * Defaults to `timeoutMs` (no separate short-circuit).\r\n       */\r\n      waitForExistenceTimeoutMs?: number;\r\n    }\r\n  ): Promise<Result<void>> {\r\n    const timeoutMs = options?.timeoutMs ?? 60_000;\r\n    const startTime = Date.now();\r\n\r\n    // Safety: never delete Coder workspaces mux didn't create.\r\n    // Mux-created workspaces always use the mux- prefix.\r\n    if (!name.startsWith(\"mux-\")) {\r\n      log.warn(\"Refusing to delete Coder workspace without mux- prefix\", { name });\r\n      return Ok(undefined);\r\n    }\r\n\r\n    const isTimedOut = () => Date.now() - startTime > timeoutMs;\r\n    const remainingMs = () => Math.max(0, timeoutMs - (Date.now() - startTime));\r\n\r\n    const unstableStates = new Set<CoderWorkspaceStatus>([\r\n      \"starting\",\r\n      \"pending\",\r\n      \"stopping\",\r\n      \"canceling\",\r\n    ]);\r\n\r\n    let sawWorkspaceExist = false;\r\n    let lastError: string | undefined;\r\n    let attempt = 0;\r\n\r\n    while (!isTimedOut()) {\r\n      if (options?.signal?.aborted) {\r\n        return Err(\"Delete operation aborted\");\r\n      }\r\n\r\n      const statusResult = await this.getWorkspaceStatus(name, {\r\n        timeoutMs: Math.min(remainingMs(), 10_000),\r\n        signal: options?.signal,\r\n      });\r\n\r\n      if (statusResult.kind === \"ok\") {\r\n        sawWorkspaceExist = true;\r\n\r\n        if (statusResult.status === \"deleted\" || statusResult.status === \"deleting\") {\r\n          return Ok(undefined);\r\n        }\r\n\r\n        // If a build is transitioning (starting/stopping/etc), deletion may fail temporarily.\r\n        // We'll keep polling + retrying the delete command.\r\n        if (unstableStates.has(statusResult.status)) {\r\n          log.debug(\"Coder workspace in transitional state; will retry delete\", {\r\n            name,\r\n            status: statusResult.status,\r\n          });\r\n        }\r\n      }\r\n\r\n      if (statusResult.kind === \"not_found\") {\r\n        if (options?.waitForExistence !== true) {\r\n          return Ok(undefined);\r\n        }\r\n\r\n        // For cancel-init, avoid treating an initial not_found as success: `coder create` may still\r\n        // complete server-side after we abort the local CLI. Keep polling until we either observe\r\n        // the workspace exist (and then disappear), or we hit the existence-wait window.\r\n        if (sawWorkspaceExist) {\r\n          return Ok(undefined);\r\n        }\r\n\r\n        // Short-circuit: if we've never seen the workspace and the shorter existence-wait\r\n        // window has elapsed, assume the server-side create never completed.\r\n        const existenceTimeout = options?.waitForExistenceTimeoutMs ?? timeoutMs;\r\n        if (Date.now() - startTime > existenceTimeout) {\r\n          return Ok(undefined);\r\n        }\r\n\r\n        attempt++;\r\n        const backoffMs = Math.min(2_000, 250 + attempt * 150);\r\n        await this.sleep(backoffMs, options?.signal);\r\n        continue;\r\n      }\r\n\r\n      if (statusResult.kind === \"error\") {\r\n        // If status checks fail (auth/network), still attempt delete best-effort.\r\n        lastError = statusResult.error;\r\n      }\r\n\r\n      const deleteAttempt = await this.runCoderCommand([\"delete\", name, \"--yes\"], {\r\n        timeoutMs: Math.min(remainingMs(), 20_000),\r\n        signal: options?.signal,\r\n      });\r\n\r\n      const interpreted = interpretCoderResult(deleteAttempt);\r\n      if (!interpreted.ok) {\r\n        lastError = interpreted.error;\r\n      } else {\r\n        // Successful delete is terminal; status polling is best-effort.\r\n        lastError = undefined;\r\n        return Ok(undefined);\r\n      }\r\n\r\n      attempt++;\r\n      const backoffMs = Math.min(2_000, 250 + attempt * 150);\r\n      await this.sleep(backoffMs, options?.signal);\r\n    }\r\n\r\n    if (options?.waitForExistence === true && !sawWorkspaceExist && !lastError) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    return Err(lastError ?? \"Timed out deleting Coder workspace\");\r\n  }\r\n\r\n  /**\r\n   * Delete a Coder workspace.\r\n   *\r\n   * Safety: Only deletes workspaces with \"mux-\" prefix to prevent accidentally\r\n   * deleting user workspaces that weren't created by mux.\r\n   */\r\n  async deleteWorkspace(name: string): Promise<void> {\r\n    const result = await this.deleteWorkspaceEventually(name, {\r\n      timeoutMs: 30_000,\r\n      waitForExistence: false,\r\n    });\r\n\r\n    if (!result.success) {\r\n      throw new Error(result.error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ensure SSH config is set up for Coder workspaces.\r\n   * Run before every Coder workspace connection (idempotent).\r\n   */\r\n  async ensureSSHConfig(): Promise<void> {\r\n    log.debug(\"Ensuring Coder SSH config\");\r\n    using proc = execAsync(\"coder config-ssh --yes\");\r\n    await proc.result;\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const coderService = new CoderService();\r\n"]}