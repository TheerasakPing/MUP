{"version":3,"file":"coderService.js","sourceRoot":"","sources":["../../../src/node/services/coderService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Service for interacting with the Coder CLI.\n * Used to create/manage Coder workspaces as SSH targets for Mux workspaces.\n */\nimport { shescape } from \"@/node/runtime/streamUtils\";\nimport { execAsync } from \"@/node/utils/disposableExec\";\nimport { getBashPath } from \"@/node/utils/main/bashPath\";\nimport { log } from \"@/node/services/log\";\nimport { spawn, type ChildProcess } from \"child_process\";\nimport type { Result } from \"@/common/types/result\";\nimport { Ok, Err } from \"@/common/types/result\";\nimport {\n  CoderWorkspaceStatusSchema,\n  type CoderInfo,\n  type CoderListPresetsResult,\n  type CoderListTemplatesResult,\n  type CoderListWorkspacesResult,\n  type CoderTemplate,\n  type CoderPreset,\n  type CoderWorkspace,\n  type CoderWorkspaceStatus,\n} from \"@/common/orpc/schemas/coder\";\n\n// Re-export types for consumers that import from this module\n\nexport interface CoderApiSession {\n  token: string;\n  dispose: () => Promise<void>;\n}\nexport type {\n  CoderInfo,\n  CoderListPresetsResult,\n  CoderListTemplatesResult,\n  CoderListWorkspacesResult,\n  CoderTemplate,\n  CoderPreset,\n  CoderWorkspace,\n  CoderWorkspaceStatus,\n};\n\ninterface CoderWhoamiData {\n  url: string;\n  username?: string;\n  id?: string;\n}\n\n/** Discriminated union for workspace status check results */\nexport type WorkspaceStatusResult =\n  | { kind: \"ok\"; status: CoderWorkspaceStatus }\n  | { kind: \"not_found\" }\n  | { kind: \"error\"; error: string };\n\n/**\n * Serialize a Coder parameter default_value to string.\n * Preserves numeric/boolean/array values instead of coercing to \"\".\n */\nfunction serializeParameterDefault(value: unknown): string {\n  if (value == null) return \"\";\n  if (typeof value === \"string\") return value;\n  if (typeof value === \"number\" || typeof value === \"boolean\") return String(value);\n  // Arrays/objects (e.g., list(string) type) → JSON\n  return JSON.stringify(value);\n}\n\n// Minimum supported Coder CLI version\nconst MIN_CODER_VERSION = \"2.25.0\";\n\n/**\n * Normalize a version string for comparison.\n * Strips leading \"v\", dev suffixes like \"-devel+hash\", and build metadata.\n * Example: \"v2.28.6+df47153\" → \"2.28.6\"\n */\nfunction normalizeVersion(v: string): string {\n  return v\n    .replace(/^v/i, \"\") // Strip leading v/V\n    .split(\"-\")[0] // Remove pre-release suffix\n    .split(\"+\")[0]; // Remove build metadata\n}\n\n/**\n * Compare two semver versions. Returns:\n * - negative if a < b\n * - 0 if a === b\n * - positive if a > b\n */\nexport function compareVersions(a: string, b: string): number {\n  const aParts = normalizeVersion(a).split(\".\").map(Number);\n  const bParts = normalizeVersion(b).split(\".\").map(Number);\n\n  for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {\n    const aPart = aParts[i] ?? 0;\n    const bPart = bParts[i] ?? 0;\n    if (aPart !== bPart) return aPart - bPart;\n  }\n  return 0;\n}\n\nconst SIGKILL_GRACE_PERIOD_MS = 5000;\n\nfunction createGracefulTerminator(\n  child: ChildProcess,\n  options?: { sigkillAfterMs?: number }\n): {\n  terminate: () => void;\n  cleanup: () => void;\n} {\n  const sigkillAfterMs = options?.sigkillAfterMs ?? SIGKILL_GRACE_PERIOD_MS;\n  let sigkillTimer: ReturnType<typeof setTimeout> | null = null;\n\n  const scheduleSigkill = () => {\n    if (sigkillTimer) return;\n    sigkillTimer = setTimeout(() => {\n      sigkillTimer = null;\n      // Only attempt SIGKILL if the process still appears to be running.\n      if (child.exitCode === null && child.signalCode === null) {\n        try {\n          child.kill(\"SIGKILL\");\n        } catch {\n          // ignore\n        }\n      }\n    }, sigkillAfterMs);\n  };\n\n  const terminate = () => {\n    try {\n      child.kill(\"SIGTERM\");\n    } catch {\n      // ignore\n    }\n    scheduleSigkill();\n  };\n\n  const cleanup = () => {\n    if (sigkillTimer) {\n      clearTimeout(sigkillTimer);\n      sigkillTimer = null;\n    }\n  };\n\n  return { terminate, cleanup };\n}\n\n/**\n * Stream output from a coder CLI command line by line.\n * Yields lines as they arrive from stdout/stderr.\n * Throws on non-zero exit with stderr content in the error message.\n *\n * @param args Command arguments (e.g., [\"start\", \"-y\", \"my-ws\"])\n * @param errorPrefix Prefix for error messages (e.g., \"coder start failed\")\n * @param abortSignal Optional signal to cancel the command\n * @param abortMessage Message to throw when aborted\n */\nasync function* streamCoderCommand(\n  args: string[],\n  errorPrefix: string,\n  abortSignal?: AbortSignal,\n  abortMessage = \"Coder command aborted\"\n): AsyncGenerator<string, void, unknown> {\n  if (abortSignal?.aborted) {\n    throw new Error(abortMessage);\n  }\n\n  // Yield the command we're about to run so it's visible in UI\n  yield `$ coder ${args.join(\" \")}`;\n\n  const child = spawn(\"coder\", args, {\n    stdio: [\"ignore\", \"pipe\", \"pipe\"],\n  });\n\n  const terminator = createGracefulTerminator(child);\n\n  const abortHandler = () => {\n    terminator.terminate();\n  };\n  abortSignal?.addEventListener(\"abort\", abortHandler);\n\n  try {\n    // Use an async queue to stream lines as they arrive\n    const lineQueue: string[] = [];\n    const stderrLines: string[] = [];\n    let streamsDone = false;\n    let resolveNext: (() => void) | null = null;\n\n    const pushLine = (line: string) => {\n      lineQueue.push(line);\n      if (resolveNext) {\n        resolveNext();\n        resolveNext = null;\n      }\n    };\n\n    let pending = 2;\n    const markDone = () => {\n      pending--;\n      if (pending === 0) {\n        streamsDone = true;\n        if (resolveNext) {\n          resolveNext();\n          resolveNext = null;\n        }\n      }\n    };\n\n    const processStream = (stream: NodeJS.ReadableStream | null, isStderr: boolean) => {\n      if (!stream) {\n        markDone();\n        return;\n      }\n      let buffer = \"\";\n      stream.on(\"data\", (chunk: Buffer) => {\n        buffer += chunk.toString();\n        const parts = buffer.split(\"\\n\");\n        buffer = parts.pop() ?? \"\";\n        for (const line of parts) {\n          const trimmed = line.trim();\n          if (trimmed) {\n            pushLine(trimmed);\n            if (isStderr) stderrLines.push(trimmed);\n          }\n        }\n      });\n      stream.on(\"end\", () => {\n        if (buffer.trim()) {\n          pushLine(buffer.trim());\n          if (isStderr) stderrLines.push(buffer.trim());\n        }\n        markDone();\n      });\n      stream.on(\"error\", markDone);\n    };\n\n    processStream(child.stdout, false);\n    processStream(child.stderr, true);\n\n    // Yield lines as they arrive\n    while (!streamsDone || lineQueue.length > 0) {\n      if (lineQueue.length > 0) {\n        yield lineQueue.shift()!;\n      } else if (!streamsDone) {\n        await new Promise<void>((resolve) => {\n          resolveNext = resolve;\n        });\n      }\n    }\n\n    // Wait for process to exit\n    const exitCode = await new Promise<number | null>((resolve) => {\n      child.on(\"close\", resolve);\n      child.on(\"error\", () => resolve(null));\n    });\n\n    if (abortSignal?.aborted) {\n      throw new Error(abortMessage);\n    }\n\n    if (exitCode !== 0) {\n      const errorDetail = stderrLines.length > 0 ? `: ${stderrLines.join(\" | \")}` : \"\";\n      throw new Error(`${errorPrefix} (exit ${String(exitCode)})${errorDetail}`);\n    }\n  } finally {\n    terminator.cleanup();\n    abortSignal?.removeEventListener(\"abort\", abortHandler);\n  }\n}\n\ninterface CoderCommandResult {\n  exitCode: number | null;\n  stdout: string;\n  stderr: string;\n  error?: \"timeout\" | \"aborted\";\n}\n\ntype InterpretedCoderCommandResult =\n  | { ok: true; stdout: string; stderr: string }\n  | { ok: false; error: string; combined: string };\n\nfunction interpretCoderResult(result: CoderCommandResult): InterpretedCoderCommandResult {\n  const combined = `${result.stderr}\\n${result.stdout}`.trim();\n\n  if (result.error) {\n    return { ok: false, error: result.error, combined };\n  }\n\n  if (result.exitCode !== 0) {\n    return {\n      ok: false,\n      error: combined || `Exit code ${String(result.exitCode)}`,\n      combined,\n    };\n  }\n\n  return { ok: true, stdout: result.stdout, stderr: result.stderr };\n}\n\nfunction sanitizeCoderCliErrorForUi(error: unknown): string {\n  if (!(error instanceof Error)) {\n    return \"Unknown error\";\n  }\n\n  const err = error as Partial<{ stderr: string; message: string }>;\n  const raw = (err.stderr?.trim() ? err.stderr : err.message) ?? \"\";\n\n  const lines = raw\n    .split(/\\r?\\n/)\n    .map((line) => line.trim())\n    .filter(Boolean);\n\n  if (lines.length === 0) {\n    return \"Unknown error\";\n  }\n\n  // Coder often prints a generic \"Encountered an error running...\" line followed by\n  // a more actionable \"error: ...\" line. Prefer the latter when present.\n  const preferred =\n    [...lines].reverse().find((line) => /^error:\\s*/i.test(line)) ?? lines[lines.length - 1];\n\n  return (\n    preferred\n      .replace(/^error:\\s*/i, \"\")\n      .slice(0, 200)\n      .trim() || \"Unknown error\"\n  );\n}\n\nexport class CoderService {\n  // Ephemeral API sessions scoped to workspace provisioning.\n  // This keeps token reuse explicit without persisting anything to disk.\n  private provisioningSessions = new Map<string, CoderApiSession>();\n  private cachedInfo: CoderInfo | null = null;\n  // Cache whoami results so later URL lookups can reuse the last CLI response.\n  private cachedWhoami: CoderWhoamiData | null = null;\n\n  private async resolveCoderBinaryPath(): Promise<string | null> {\n    let shell: string | undefined;\n    if (process.platform === \"win32\") {\n      try {\n        shell = getBashPath();\n      } catch {\n        // Best-effort; if Git Bash isn't available, the lookup may fail and we'll fall back to null.\n      }\n    }\n\n    try {\n      using proc = execAsync(\"command -v coder\", shell ? { shell } : undefined);\n      const { stdout } = await proc.result;\n      const firstLine = stdout.split(/\\r?\\n/)[0]?.trim();\n      return firstLine || null;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Get Coder CLI info. Caches result for the session.\n   * Returns discriminated union: available | outdated | unavailable.\n   */\n  async getCoderInfo(): Promise<CoderInfo> {\n    if (this.cachedInfo) {\n      return this.cachedInfo;\n    }\n\n    // Resolve the Coder binary path for better error messages (helps when multiple binaries are on PATH).\n    const binaryPath = await this.resolveCoderBinaryPath();\n\n    try {\n      using proc = execAsync(\"coder version --output=json\");\n      const { stdout } = await proc.result;\n\n      // Parse JSON output\n      const data = JSON.parse(stdout) as { version?: string };\n      const version = data.version;\n\n      if (!version) {\n        this.cachedInfo = {\n          state: \"unavailable\",\n          reason: { kind: \"error\", message: \"Version output missing from CLI\" },\n        };\n        return this.cachedInfo;\n      }\n\n      // Check minimum version\n      if (compareVersions(version, MIN_CODER_VERSION) < 0) {\n        log.debug(`Coder CLI version ${version} is below minimum ${MIN_CODER_VERSION}`);\n        this.cachedInfo = {\n          state: \"outdated\",\n          version,\n          minVersion: MIN_CODER_VERSION,\n          ...(binaryPath ? { binaryPath } : {}),\n        };\n        return this.cachedInfo;\n      }\n\n      let whoami: CoderWhoamiData | null = null;\n      try {\n        whoami = await this.getWhoamiData();\n      } catch (error) {\n        // Treat whoami failures as a blocking issue for the Coder runtime.\n        // If the CLI isn't logged in, users will hit confusing failures later during provisioning.\n        const err = error as Partial<{ stderr: string; message: string }>;\n        const raw = (err.stderr?.trim() ? err.stderr : err.message) ?? \"\";\n        const normalized = raw.toLowerCase();\n\n        const isNotLoggedIn =\n          normalized.includes(\"not logged in\") ||\n          normalized.includes(\"try logging in\") ||\n          normalized.includes(\"please login\") ||\n          normalized.includes(\"coder login\");\n\n        const lastLine =\n          raw\n            .split(/\\r?\\n/)\n            .map((line) => line.trim())\n            .filter(Boolean)\n            .at(-1) ?? \"\";\n\n        const sanitizedLine =\n          lastLine\n            .replace(/^error:\\s*/i, \"\")\n            .slice(0, 200)\n            .trim() || \"Unknown error\";\n\n        const notLoggedInMessage = binaryPath\n          ? `${binaryPath} is ${sanitizedLine.replace(/^you are\\s+/i, \"\")}`\n          : sanitizedLine;\n\n        log.debug(\"Failed to fetch Coder whoami data\", { error });\n\n        const result: CoderInfo = isNotLoggedIn\n          ? { state: \"unavailable\", reason: { kind: \"not-logged-in\", message: notLoggedInMessage } }\n          : { state: \"unavailable\", reason: { kind: \"error\", message: sanitizedLine } };\n\n        // Don't cache whoami failures: users can often recover without restarting the app\n        // (e.g., temporary network issues or `coder login`).\n        return result;\n      }\n\n      const availableInfo: CoderInfo = {\n        state: \"available\",\n        version,\n        ...(whoami?.username ? { username: whoami.username } : {}),\n        ...(whoami?.url ? { url: whoami.url } : {}),\n      };\n\n      this.cachedInfo = availableInfo;\n      return this.cachedInfo;\n    } catch (error) {\n      log.debug(\"Coder CLI not available\", { error });\n      this.cachedInfo = this.classifyCoderError(error);\n      return this.cachedInfo;\n    }\n  }\n\n  /**\n   * Classify an error from the Coder CLI as missing or error with message.\n   */\n  private classifyCoderError(error: unknown): CoderInfo {\n    // ENOENT or \"command not found\" = CLI not installed\n    if (error instanceof Error) {\n      const code = (error as NodeJS.ErrnoException).code;\n      const message = error.message.toLowerCase();\n      if (\n        code === \"ENOENT\" ||\n        message.includes(\"command not found\") ||\n        message.includes(\"enoent\")\n      ) {\n        return { state: \"unavailable\", reason: \"missing\" };\n      }\n      // Other errors: include sanitized message (single line, capped length)\n      const sanitized = sanitizeCoderCliErrorForUi(error);\n      return {\n        state: \"unavailable\",\n        reason: { kind: \"error\", message: sanitized },\n      };\n    }\n    return { state: \"unavailable\", reason: { kind: \"error\", message: \"Unknown error\" } };\n  }\n\n  /**\n   * Create a short-lived Coder API token for deployment endpoints.\n   */\n  private async createApiSession(tokenName: string): Promise<CoderApiSession> {\n    using tokenProc = execAsync(\n      `coder tokens create --lifetime 5m --name ${shescape.quote(tokenName)}`\n    );\n    const { stdout: token } = await tokenProc.result;\n    const trimmed = token.trim();\n\n    return {\n      token: trimmed,\n      dispose: async () => {\n        try {\n          using deleteProc = execAsync(`coder tokens delete ${shescape.quote(tokenName)}`);\n          await deleteProc.result;\n        } catch {\n          // Best-effort cleanup; token will expire in 5 minutes anyway.\n          log.debug(\"Failed to delete temporary Coder API token\", { tokenName });\n        }\n      },\n    };\n  }\n\n  private async withApiSession<T>(\n    tokenName: string,\n    fn: (session: CoderApiSession) => Promise<T>\n  ): Promise<T> {\n    const session = await this.createApiSession(tokenName);\n    try {\n      return await fn(session);\n    } finally {\n      await session.dispose();\n    }\n  }\n\n  async ensureProvisioningSession(workspaceName: string): Promise<CoderApiSession> {\n    const existing = this.provisioningSessions.get(workspaceName);\n    if (existing) {\n      return existing;\n    }\n\n    const tokenName = `mux-${workspaceName}-${Date.now().toString(36)}`;\n    const session = await this.createApiSession(tokenName);\n    this.provisioningSessions.set(workspaceName, session);\n    return session;\n  }\n\n  takeProvisioningSession(workspaceName: string): CoderApiSession | undefined {\n    const session = this.provisioningSessions.get(workspaceName);\n    if (session) {\n      this.provisioningSessions.delete(workspaceName);\n    }\n    return session;\n  }\n\n  async disposeProvisioningSession(workspaceName: string): Promise<void> {\n    const session = this.provisioningSessions.get(workspaceName);\n    if (!session) {\n      return;\n    }\n    this.provisioningSessions.delete(workspaceName);\n    await session.dispose();\n  }\n\n  private normalizeHostnameSuffix(raw: string | undefined): string {\n    const cleaned = (raw ?? \"\").trim().replace(/^\\./, \"\");\n    return cleaned || \"coder\";\n  }\n\n  async fetchDeploymentSshConfig(session?: CoderApiSession): Promise<{ hostnameSuffix: string }> {\n    const deploymentUrl = await this.getDeploymentUrl();\n    const tokenName = `mux-ssh-config-${Date.now().toString(36)}`;\n\n    const run = async (api: CoderApiSession) => {\n      const url = new URL(\"/api/v2/deployment/ssh\", deploymentUrl);\n      const response = await fetch(url, {\n        headers: { \"Coder-Session-Token\": api.token },\n      });\n      if (!response.ok) {\n        throw new Error(`Failed to fetch SSH config: ${response.status}`);\n      }\n\n      const data = (await response.json()) as { hostname_suffix?: string };\n      return { hostnameSuffix: this.normalizeHostnameSuffix(data.hostname_suffix) };\n    };\n\n    return session ? run(session) : this.withApiSession(tokenName, run);\n  }\n  /**\n   * Clear cached Coder info. Used for testing.\n   */\n  clearCache(): void {\n    this.cachedInfo = null;\n    this.cachedWhoami = null;\n  }\n\n  // Preserve the old behavior: explicit whoami checks should hit the CLI even if cached.\n  // The cache only exists so later URL lookups can reuse the last whoami response.\n  private async getWhoamiData(options?: { useCache?: boolean }): Promise<CoderWhoamiData> {\n    if (options?.useCache && this.cachedWhoami) {\n      return this.cachedWhoami;\n    }\n\n    using proc = execAsync(\"coder whoami --output=json\");\n    const { stdout } = await proc.result;\n\n    const data = JSON.parse(stdout) as Array<Partial<CoderWhoamiData>>;\n    if (!data[0]?.url) {\n      throw new Error(\"Could not determine Coder deployment URL from `coder whoami`\");\n    }\n\n    this.cachedWhoami = {\n      url: data[0].url,\n      username: data[0].username,\n      id: data[0].id,\n    };\n\n    return this.cachedWhoami;\n  }\n\n  /**\n   * Get the Coder deployment URL via `coder whoami`.\n   * Throws if Coder CLI is not configured/logged in.\n   */\n  private async getDeploymentUrl(): Promise<string> {\n    const { url } = await this.getWhoamiData({ useCache: true });\n    return url;\n  }\n\n  /**\n   * Get the active template version ID for a template.\n   * Throws if template not found.\n   */\n  private async getActiveTemplateVersionId(templateName: string, org?: string): Promise<string> {\n    // Note: `coder templates list` doesn't support --org flag, so we filter client-side\n    using proc = execAsync(\"coder templates list --output=json\");\n    const { stdout } = await proc.result;\n\n    if (!stdout.trim()) {\n      throw new Error(`Template \"${templateName}\" not found (no templates exist)`);\n    }\n\n    const raw = JSON.parse(stdout) as Array<{\n      Template: {\n        name: string;\n        organization_name: string;\n        active_version_id: string;\n      };\n    }>;\n\n    // Filter by name and optionally by org for disambiguation\n    const template = raw.find(\n      (t) => t.Template.name === templateName && (!org || t.Template.organization_name === org)\n    );\n    if (!template) {\n      const orgSuffix = org ? ` in organization \"${org}\"` : \"\";\n      throw new Error(`Template \"${templateName}\" not found${orgSuffix}`);\n    }\n\n    return template.Template.active_version_id;\n  }\n\n  /**\n   * Get parameter names covered by a preset.\n   * Returns empty set if preset not found (allows creation to proceed without preset params).\n   */\n  private async getPresetParamNames(\n    templateName: string,\n    presetName: string,\n    org?: string\n  ): Promise<Set<string>> {\n    try {\n      const orgFlag = org ? ` --org ${shescape.quote(org)}` : \"\";\n      using proc = execAsync(\n        `coder templates presets list ${shescape.quote(templateName)}${orgFlag} --output=json`\n      );\n      const { stdout } = await proc.result;\n\n      // Same non-JSON guard as listPresets (CLI prints info message for no presets)\n      if (!stdout.trim() || !stdout.trimStart().startsWith(\"[\")) {\n        return new Set();\n      }\n\n      const raw = JSON.parse(stdout) as Array<{\n        TemplatePreset: {\n          Name: string;\n          Parameters?: Array<{ Name: string }>;\n        };\n      }>;\n\n      const preset = raw.find((p) => p.TemplatePreset.Name === presetName);\n      if (!preset?.TemplatePreset.Parameters) {\n        return new Set();\n      }\n\n      return new Set(preset.TemplatePreset.Parameters.map((p) => p.Name));\n    } catch (error) {\n      log.debug(\"Failed to get preset param names\", { templateName, presetName, error });\n      return new Set();\n    }\n  }\n\n  /**\n   * Parse rich parameter data from the Coder API.\n   * Filters out entries with missing/invalid names to avoid generating invalid --parameter flags.\n   */\n  private parseRichParameters(data: unknown): Array<{\n    name: string;\n    defaultValue: string;\n    type: string;\n    ephemeral: boolean;\n    required: boolean;\n  }> {\n    if (!Array.isArray(data)) {\n      throw new Error(\"Expected array of rich parameters\");\n    }\n    return data\n      .filter((p): p is Record<string, unknown> => {\n        if (p === null || typeof p !== \"object\") return false;\n        const obj = p as Record<string, unknown>;\n        return typeof obj.name === \"string\" && obj.name !== \"\";\n      })\n      .map((p) => ({\n        name: p.name as string,\n        defaultValue: serializeParameterDefault(p.default_value),\n        type: typeof p.type === \"string\" ? p.type : \"string\",\n        ephemeral: Boolean(p.ephemeral),\n        required: Boolean(p.required),\n      }));\n  }\n\n  /**\n   * Fetch template rich parameters from Coder API.\n   * Uses an optional API session to avoid generating multiple tokens.\n   */\n  private async getTemplateRichParameters(\n    deploymentUrl: string,\n    versionId: string,\n    workspaceName: string,\n    session?: CoderApiSession\n  ): Promise<\n    Array<{\n      name: string;\n      defaultValue: string;\n      type: string;\n      ephemeral: boolean;\n      required: boolean;\n    }>\n  > {\n    const run = async (api: CoderApiSession) => {\n      const url = new URL(\n        `/api/v2/templateversions/${versionId}/rich-parameters`,\n        deploymentUrl\n      ).toString();\n\n      const response = await fetch(url, {\n        headers: {\n          \"Coder-Session-Token\": api.token,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\n          `Failed to fetch rich parameters: ${response.status} ${response.statusText}`\n        );\n      }\n\n      const data: unknown = await response.json();\n      return this.parseRichParameters(data);\n    };\n\n    const tokenName = `mux-${workspaceName}`;\n    return session ? run(session) : this.withApiSession(tokenName, run);\n  }\n\n  /**\n   * Encode a parameter string for the Coder CLI's --parameter flag.\n   * The CLI uses CSV parsing, so values containing quotes or commas need escaping:\n   * - Wrap the entire string in double quotes\n   * - Escape internal double quotes as \"\"\n   */\n  private encodeParameterValue(nameValue: string): string {\n    if (!nameValue.includes('\"') && !nameValue.includes(\",\")) {\n      return nameValue;\n    }\n    // CSV quoting: wrap in quotes, escape internal quotes as \"\"\n    return `\"${nameValue.replace(/\"/g, '\"\"')}\"`;\n  }\n\n  /**\n   * Compute extra --parameter flags needed for workspace creation.\n   * Filters to non-ephemeral params not covered by preset, using their defaults.\n   * Values are passed through as-is (list(string) types expect JSON-encoded arrays).\n   */\n  computeExtraParams(\n    allParams: Array<{\n      name: string;\n      defaultValue: string;\n      type: string;\n      ephemeral: boolean;\n      required: boolean;\n    }>,\n    coveredByPreset: Set<string>\n  ): Array<{ name: string; encoded: string }> {\n    const extra: Array<{ name: string; encoded: string }> = [];\n\n    for (const p of allParams) {\n      // Skip ephemeral params\n      if (p.ephemeral) continue;\n      // Skip params covered by preset\n      if (coveredByPreset.has(p.name)) continue;\n\n      // Encode for CLI's CSV parser (escape quotes/commas)\n      const encoded = this.encodeParameterValue(`${p.name}=${p.defaultValue}`);\n      extra.push({ name: p.name, encoded });\n    }\n\n    return extra;\n  }\n\n  /**\n   * Validate that all required params have values (either from preset or defaults).\n   * Throws if any required param is missing a value.\n   */\n  validateRequiredParams(\n    allParams: Array<{\n      name: string;\n      defaultValue: string;\n      type: string;\n      ephemeral: boolean;\n      required: boolean;\n    }>,\n    coveredByPreset: Set<string>\n  ): void {\n    const missing: string[] = [];\n\n    for (const p of allParams) {\n      if (p.ephemeral) continue;\n      if (p.required && !p.defaultValue && !coveredByPreset.has(p.name)) {\n        missing.push(p.name);\n      }\n    }\n\n    if (missing.length > 0) {\n      throw new Error(\n        `Required template parameters missing values: ${missing.join(\", \")}. ` +\n          `Select a preset that provides these values or contact your template admin.`\n      );\n    }\n  }\n\n  /**\n   * List available Coder templates.\n   */\n  async listTemplates(): Promise<CoderListTemplatesResult> {\n    try {\n      using proc = execAsync(\"coder templates list --output=json\");\n      const { stdout } = await proc.result;\n\n      // Handle empty output (no templates)\n      if (!stdout.trim()) {\n        return { ok: true, templates: [] };\n      }\n\n      // CLI returns [{Template: {...}}, ...] wrapper structure\n      const raw = JSON.parse(stdout) as Array<{\n        Template: {\n          name: string;\n          display_name?: string;\n          organization_name?: string;\n        };\n      }>;\n\n      return {\n        ok: true,\n        templates: raw.map((entry) => ({\n          name: entry.Template.name,\n          displayName: entry.Template.display_name ?? entry.Template.name,\n          organizationName: entry.Template.organization_name ?? \"default\",\n        })),\n      };\n    } catch (error) {\n      const message = sanitizeCoderCliErrorForUi(error);\n      // Surface CLI failures so the UI doesn't show \"No templates\" incorrectly.\n      log.warn(\"Failed to list Coder templates\", { error });\n      return { ok: false, error: message || \"Unknown error\" };\n    }\n  }\n\n  /**\n   * List presets for a template.\n   * @param templateName - Template name\n   * @param org - Organization name for disambiguation (optional)\n   */\n  async listPresets(templateName: string, org?: string): Promise<CoderListPresetsResult> {\n    try {\n      const orgFlag = org ? ` --org ${shescape.quote(org)}` : \"\";\n      using proc = execAsync(\n        `coder templates presets list ${shescape.quote(templateName)}${orgFlag} --output=json`\n      );\n      const { stdout } = await proc.result;\n\n      // Handle empty output or non-JSON info messages (no presets).\n      // CLI prints \"No presets found for template ...\" to stdout even with --output=json\n      // because the Go handler returns early before the formatter runs.\n      if (!stdout.trim() || !stdout.trimStart().startsWith(\"[\")) {\n        return { ok: true, presets: [] };\n      }\n\n      // CLI returns [{TemplatePreset: {ID, Name, ...}}, ...] wrapper structure\n      const raw = JSON.parse(stdout) as Array<{\n        TemplatePreset: {\n          ID: string;\n          Name: string;\n          Description?: string;\n          Default?: boolean;\n        };\n      }>;\n\n      return {\n        ok: true,\n        presets: raw.map((entry) => ({\n          id: entry.TemplatePreset.ID,\n          name: entry.TemplatePreset.Name,\n          description: entry.TemplatePreset.Description,\n          isDefault: entry.TemplatePreset.Default ?? false,\n        })),\n      };\n    } catch (error) {\n      const message = sanitizeCoderCliErrorForUi(error);\n      // Surface CLI failures so the UI doesn't show \"No presets\" incorrectly.\n      log.warn(\"Failed to list Coder presets\", { templateName, error });\n      return { ok: false, error: message || \"Unknown error\" };\n    }\n  }\n\n  /**\n   * Check if a Coder workspace exists by name.\n   *\n   * Uses `coder list --search name:<workspace>` so we don't have to fetch all workspaces.\n   * Note: Coder's `--search` is prefix-based server-side, so we must exact-match locally.\n   */\n  async workspaceExists(workspaceName: string): Promise<boolean> {\n    try {\n      using proc = execAsync(\n        `coder list --search ${shescape.quote(`name:${workspaceName}`)} --output=json`\n      );\n      const { stdout } = await proc.result;\n\n      if (!stdout.trim()) {\n        return false;\n      }\n\n      const workspaces = JSON.parse(stdout) as Array<{ name: string }>;\n      return workspaces.some((w) => w.name === workspaceName);\n    } catch (error) {\n      // Best-effort: if Coder isn't configured/logged in, treat as \"doesn't exist\" so we\n      // don't block creation (later steps will fail with a more actionable error).\n      log.debug(\"Failed to check if Coder workspace exists\", { workspaceName, error });\n      return false;\n    }\n  }\n\n  /**\n   * List Coder workspaces (all statuses).\n   */\n  async listWorkspaces(): Promise<CoderListWorkspacesResult> {\n    // Derive known statuses from schema to avoid duplication and prevent ORPC validation errors\n    const KNOWN_STATUSES = new Set<string>(CoderWorkspaceStatusSchema.options);\n\n    try {\n      using proc = execAsync(\"coder list --output=json\");\n      const { stdout } = await proc.result;\n\n      // Handle empty output (no workspaces)\n      if (!stdout.trim()) {\n        return { ok: true, workspaces: [] };\n      }\n\n      const workspaces = JSON.parse(stdout) as Array<{\n        name: string;\n        template_name: string;\n        template_display_name: string;\n        latest_build: {\n          status: string;\n        };\n      }>;\n\n      // Filter to known statuses to avoid ORPC schema validation failures\n      return {\n        ok: true,\n        workspaces: workspaces\n          .filter((w) => KNOWN_STATUSES.has(w.latest_build.status))\n          .map((w) => ({\n            name: w.name,\n            templateName: w.template_name,\n            templateDisplayName: w.template_display_name || w.template_name,\n            status: w.latest_build.status as CoderWorkspaceStatus,\n          })),\n      };\n    } catch (error) {\n      const message = sanitizeCoderCliErrorForUi(error);\n      // Users reported seeing \"No workspaces found\" even when the CLI failed,\n      // so surface an error state instead of silently returning an empty list.\n      log.warn(\"Failed to list Coder workspaces\", { error });\n      return { ok: false, error: message || \"Unknown error\" };\n    }\n  }\n\n  /**\n   * Run a `coder` CLI command with timeout + optional cancellation.\n   *\n   * We use spawn (not execAsync) so ensureReady() can't hang forever on a stuck\n   * Coder CLI invocation.\n   */\n  private runCoderCommand(\n    args: string[],\n    options: { timeoutMs: number; signal?: AbortSignal }\n  ): Promise<CoderCommandResult> {\n    return new Promise((resolve) => {\n      if (options.timeoutMs <= 0) {\n        resolve({ exitCode: null, stdout: \"\", stderr: \"\", error: \"timeout\" });\n        return;\n      }\n\n      if (options.signal?.aborted) {\n        resolve({ exitCode: null, stdout: \"\", stderr: \"\", error: \"aborted\" });\n        return;\n      }\n\n      const child = spawn(\"coder\", args, {\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\n      });\n\n      let stdout = \"\";\n      let stderr = \"\";\n      let resolved = false;\n\n      let timeoutTimer: ReturnType<typeof setTimeout> | null = null;\n\n      const terminator = createGracefulTerminator(child);\n\n      const resolveOnce = (result: CoderCommandResult) => {\n        if (resolved) return;\n        resolved = true;\n        resolve(result);\n      };\n\n      const cleanup = (cleanupOptions?: { keepSigkillTimer?: boolean }) => {\n        if (timeoutTimer) {\n          clearTimeout(timeoutTimer);\n          timeoutTimer = null;\n        }\n        if (!cleanupOptions?.keepSigkillTimer) {\n          terminator.cleanup();\n        }\n        child.removeListener(\"close\", onClose);\n        child.removeListener(\"error\", onError);\n        options.signal?.removeEventListener(\"abort\", onAbort);\n      };\n\n      function onAbort() {\n        terminator.terminate();\n        // Keep SIGKILL escalation alive if SIGTERM doesn't work.\n        cleanup({ keepSigkillTimer: true });\n        resolveOnce({ exitCode: null, stdout, stderr, error: \"aborted\" });\n      }\n\n      function onError() {\n        cleanup();\n        resolveOnce({ exitCode: null, stdout, stderr });\n      }\n\n      function onClose(code: number | null) {\n        cleanup();\n        resolveOnce({ exitCode: code, stdout, stderr });\n      }\n\n      child.stdout?.on(\"data\", (chunk) => {\n        stdout += String(chunk);\n      });\n\n      child.stderr?.on(\"data\", (chunk) => {\n        stderr += String(chunk);\n      });\n\n      child.on(\"error\", onError);\n      child.on(\"close\", onClose);\n\n      timeoutTimer = setTimeout(() => {\n        terminator.terminate();\n\n        // Keep SIGKILL escalation alive if SIGTERM doesn't work.\n        // We still remove the abort listener to avoid leaking it beyond the call.\n        options.signal?.removeEventListener(\"abort\", onAbort);\n\n        resolveOnce({ exitCode: null, stdout, stderr, error: \"timeout\" });\n      }, options.timeoutMs);\n\n      options.signal?.addEventListener(\"abort\", onAbort);\n    });\n  }\n\n  /**\n   * Get workspace status using control-plane query.\n   *\n   * Note: `coder list --search 'name:X'` is prefix-based on the server,\n   * so we must exact-match the workspace name client-side.\n   */\n  async getWorkspaceStatus(\n    workspaceName: string,\n    options?: { timeoutMs?: number; signal?: AbortSignal }\n  ): Promise<WorkspaceStatusResult> {\n    const timeoutMs = options?.timeoutMs ?? 10_000;\n\n    try {\n      const result = await this.runCoderCommand(\n        [\"list\", \"--search\", `name:${workspaceName}`, \"--output\", \"json\"],\n        { timeoutMs, signal: options?.signal }\n      );\n\n      const interpreted = interpretCoderResult(result);\n      if (!interpreted.ok) {\n        return { kind: \"error\", error: interpreted.error };\n      }\n\n      if (!interpreted.stdout.trim()) {\n        return { kind: \"not_found\" };\n      }\n\n      const workspaces = JSON.parse(interpreted.stdout) as Array<{\n        name: string;\n        latest_build: { status: string };\n      }>;\n\n      // Exact match required (search is prefix-based)\n      const match = workspaces.find((w) => w.name === workspaceName);\n      if (!match) {\n        return { kind: \"not_found\" };\n      }\n\n      // Validate status against known schema values\n      const status = match.latest_build.status;\n      const parsed = CoderWorkspaceStatusSchema.safeParse(status);\n      if (!parsed.success) {\n        log.warn(\"Unknown Coder workspace status\", { workspaceName, status });\n        return { kind: \"error\", error: `Unknown status: ${status}` };\n      }\n\n      return { kind: \"ok\", status: parsed.data };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      log.debug(\"Failed to get Coder workspace status\", { workspaceName, error: message });\n      return { kind: \"error\", error: message };\n    }\n  }\n\n  /**\n   * Start a Coder workspace.\n   *\n   * Uses spawn + timeout so callers don't hang forever on a stuck CLI invocation.\n   */\n  async startWorkspace(\n    workspaceName: string,\n    options?: { timeoutMs?: number; signal?: AbortSignal }\n  ): Promise<Result<void>> {\n    const timeoutMs = options?.timeoutMs ?? 60_000;\n\n    try {\n      const result = await this.runCoderCommand([\"start\", workspaceName, \"--yes\"], {\n        timeoutMs,\n        signal: options?.signal,\n      });\n\n      const interpreted = interpretCoderResult(result);\n      if (!interpreted.ok) {\n        return Err(interpreted.error);\n      }\n\n      return Ok(undefined);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(message);\n    }\n  }\n\n  /**\n   * Stop a Coder workspace.\n   *\n   * Uses spawn + timeout so callers don't hang forever on a stuck CLI invocation.\n   */\n  async stopWorkspace(\n    workspaceName: string,\n    options?: { timeoutMs?: number; signal?: AbortSignal }\n  ): Promise<Result<void>> {\n    const timeoutMs = options?.timeoutMs ?? 60_000;\n\n    try {\n      const result = await this.runCoderCommand([\"stop\", workspaceName, \"--yes\"], {\n        timeoutMs,\n        signal: options?.signal,\n      });\n\n      const interpreted = interpretCoderResult(result);\n      if (!interpreted.ok) {\n        return Err(interpreted.error);\n      }\n\n      return Ok(undefined);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      return Err(message);\n    }\n  }\n\n  /**\n   * Wait for Coder workspace startup scripts to complete.\n   * Runs `coder ssh <workspace> --wait=yes -- true` and streams output.\n   */\n  async *waitForStartupScripts(\n    workspaceName: string,\n    abortSignal?: AbortSignal\n  ): AsyncGenerator<string, void, unknown> {\n    log.debug(\"Waiting for Coder startup scripts\", { workspaceName });\n    yield* streamCoderCommand(\n      [\"ssh\", workspaceName, \"--wait=yes\", \"--\", \"true\"],\n      \"coder ssh --wait failed\",\n      abortSignal,\n      \"Coder startup script wait aborted\"\n    );\n  }\n\n  /**\n   * Create a new Coder workspace. Yields build log lines as they arrive.\n   *\n   * Pre-fetches template parameters and passes defaults via --parameter flags\n   * to avoid interactive prompts during creation.\n   *\n   * @param name Workspace name\n   * @param template Template name\n   * @param preset Optional preset name\n   * @param abortSignal Optional signal to cancel workspace creation\n   * @param org Optional organization name for disambiguation\n   * @param session Optional API session to reuse across deployment endpoints\n   */\n  async *createWorkspace(\n    name: string,\n    template: string,\n    preset?: string,\n    abortSignal?: AbortSignal,\n    org?: string,\n    session?: CoderApiSession\n  ): AsyncGenerator<string, void, unknown> {\n    log.debug(\"Creating Coder workspace\", { name, template, preset, org });\n\n    if (abortSignal?.aborted) {\n      throw new Error(\"Coder workspace creation aborted\");\n    }\n\n    // 1. Get deployment URL\n    const deploymentUrl = await this.getDeploymentUrl();\n\n    // 2. Get active template version ID\n    const versionId = await this.getActiveTemplateVersionId(template, org);\n\n    // 3. Get parameter names covered by preset (if any)\n    const coveredByPreset = preset\n      ? await this.getPresetParamNames(template, preset, org)\n      : new Set<string>();\n\n    // 4. Fetch all template parameters from API\n    const allParams = await this.getTemplateRichParameters(deploymentUrl, versionId, name, session);\n\n    // 5. Validate required params have values\n    this.validateRequiredParams(allParams, coveredByPreset);\n\n    // 6. Compute extra --parameter flags for non-ephemeral params not in preset\n    const extraParams = this.computeExtraParams(allParams, coveredByPreset);\n\n    log.debug(\"Computed extra params for coder create\", {\n      name,\n      template,\n      preset,\n      org,\n      extraParamCount: extraParams.length,\n      extraParamNames: extraParams.map((p) => p.name),\n    });\n\n    // 7. Build and run single coder create command\n    const args = [\"create\", name, \"-t\", template, \"--yes\"];\n    if (org) {\n      args.push(\"--org\", org);\n    }\n    if (preset) {\n      args.push(\"--preset\", preset);\n    }\n    for (const p of extraParams) {\n      args.push(\"--parameter\", p.encoded);\n    }\n\n    yield* streamCoderCommand(\n      args,\n      \"coder create failed\",\n      abortSignal,\n      \"Coder workspace creation aborted\"\n    );\n  }\n\n  /** Promise-based sleep helper */\n  private sleep(ms: number, signal?: AbortSignal): Promise<void> {\n    if (signal?.aborted) {\n      return Promise.resolve();\n    }\n\n    return new Promise((resolve) => {\n      const timeout = setTimeout(() => {\n        signal?.removeEventListener(\"abort\", onAbort);\n        resolve();\n      }, ms);\n\n      const onAbort = () => {\n        clearTimeout(timeout);\n        signal?.removeEventListener(\"abort\", onAbort);\n        resolve();\n      };\n\n      signal?.addEventListener(\"abort\", onAbort, { once: true });\n    });\n  }\n\n  /**\n   * Delete a Coder workspace, retrying across transient build states.\n   *\n   * This is used for \"cancel creation\" because aborting the local `coder create`\n   * process does not guarantee the control-plane build is canceled.\n   */\n  async deleteWorkspaceEventually(\n    name: string,\n    options?: {\n      timeoutMs?: number;\n      signal?: AbortSignal;\n      /**\n       * If true, treat an initial \"not found\" as inconclusive and keep polling.\n       * This avoids races where `coder create` finishes server-side after mux aborts the CLI.\n       */\n      waitForExistence?: boolean;\n      /**\n       * When `waitForExistence` is true: if we only see \"not found\" for this many ms\n       * without ever observing the workspace exist, treat it as success and return early.\n       * Defaults to `timeoutMs` (no separate short-circuit).\n       */\n      waitForExistenceTimeoutMs?: number;\n    }\n  ): Promise<Result<void>> {\n    const timeoutMs = options?.timeoutMs ?? 60_000;\n    const startTime = Date.now();\n\n    // Safety: never delete Coder workspaces mux didn't create.\n    // Mux-created workspaces always use the mux- prefix.\n    if (!name.startsWith(\"mux-\")) {\n      log.warn(\"Refusing to delete Coder workspace without mux- prefix\", { name });\n      return Ok(undefined);\n    }\n\n    const isTimedOut = () => Date.now() - startTime > timeoutMs;\n    const remainingMs = () => Math.max(0, timeoutMs - (Date.now() - startTime));\n\n    const unstableStates = new Set<CoderWorkspaceStatus>([\n      \"starting\",\n      \"pending\",\n      \"stopping\",\n      \"canceling\",\n    ]);\n\n    let sawWorkspaceExist = false;\n    let lastError: string | undefined;\n    let attempt = 0;\n\n    while (!isTimedOut()) {\n      if (options?.signal?.aborted) {\n        return Err(\"Delete operation aborted\");\n      }\n\n      const statusResult = await this.getWorkspaceStatus(name, {\n        timeoutMs: Math.min(remainingMs(), 10_000),\n        signal: options?.signal,\n      });\n\n      if (statusResult.kind === \"ok\") {\n        sawWorkspaceExist = true;\n\n        if (statusResult.status === \"deleted\" || statusResult.status === \"deleting\") {\n          return Ok(undefined);\n        }\n\n        // If a build is transitioning (starting/stopping/etc), deletion may fail temporarily.\n        // We'll keep polling + retrying the delete command.\n        if (unstableStates.has(statusResult.status)) {\n          log.debug(\"Coder workspace in transitional state; will retry delete\", {\n            name,\n            status: statusResult.status,\n          });\n        }\n      }\n\n      if (statusResult.kind === \"not_found\") {\n        if (options?.waitForExistence !== true) {\n          return Ok(undefined);\n        }\n\n        // For cancel-init, avoid treating an initial not_found as success: `coder create` may still\n        // complete server-side after we abort the local CLI. Keep polling until we either observe\n        // the workspace exist (and then disappear), or we hit the existence-wait window.\n        if (sawWorkspaceExist) {\n          return Ok(undefined);\n        }\n\n        // Short-circuit: if we've never seen the workspace and the shorter existence-wait\n        // window has elapsed, assume the server-side create never completed.\n        const existenceTimeout = options?.waitForExistenceTimeoutMs ?? timeoutMs;\n        if (Date.now() - startTime > existenceTimeout) {\n          return Ok(undefined);\n        }\n\n        attempt++;\n        const backoffMs = Math.min(2_000, 250 + attempt * 150);\n        await this.sleep(backoffMs, options?.signal);\n        continue;\n      }\n\n      if (statusResult.kind === \"error\") {\n        // If status checks fail (auth/network), still attempt delete best-effort.\n        lastError = statusResult.error;\n      }\n\n      const deleteAttempt = await this.runCoderCommand([\"delete\", name, \"--yes\"], {\n        timeoutMs: Math.min(remainingMs(), 20_000),\n        signal: options?.signal,\n      });\n\n      const interpreted = interpretCoderResult(deleteAttempt);\n      if (!interpreted.ok) {\n        lastError = interpreted.error;\n      } else {\n        // Successful delete is terminal; status polling is best-effort.\n        lastError = undefined;\n        return Ok(undefined);\n      }\n\n      attempt++;\n      const backoffMs = Math.min(2_000, 250 + attempt * 150);\n      await this.sleep(backoffMs, options?.signal);\n    }\n\n    if (options?.waitForExistence === true && !sawWorkspaceExist && !lastError) {\n      return Ok(undefined);\n    }\n\n    return Err(lastError ?? \"Timed out deleting Coder workspace\");\n  }\n\n  /**\n   * Delete a Coder workspace.\n   *\n   * Safety: Only deletes workspaces with \"mux-\" prefix to prevent accidentally\n   * deleting user workspaces that weren't created by mux.\n   */\n  async deleteWorkspace(name: string): Promise<void> {\n    const result = await this.deleteWorkspaceEventually(name, {\n      timeoutMs: 30_000,\n      waitForExistence: false,\n    });\n\n    if (!result.success) {\n      throw new Error(result.error);\n    }\n  }\n\n  /**\n   * Ensure SSH config is set up for Coder workspaces.\n   * Run before every Coder workspace connection (idempotent).\n   */\n  async ensureSSHConfig(): Promise<void> {\n    log.debug(\"Ensuring Coder SSH config\");\n    using proc = execAsync(\"coder config-ssh --yes\");\n    await proc.result;\n  }\n}\n\n// Singleton instance\nexport const coderService = new CoderService();\n"]}