{"version":3,"file":"sessionUsageService.test.js","sourceRoot":"","sources":["../../../src/node/services/sessionUsageService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport { SessionUsageService, type SessionUsageTokenStatsCacheV1 } from \"./sessionUsageService\";\r\nimport type { HistoryService } from \"./historyService\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\nimport type { ChatUsageDisplay } from \"@/common/utils/tokens/usageAggregator\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\n\r\nfunction createUsage(input: number, output: number): ChatUsageDisplay {\r\n  return {\r\n    input: { tokens: input },\r\n    output: { tokens: output },\r\n    cached: { tokens: 0 },\r\n    cacheCreate: { tokens: 0 },\r\n    reasoning: { tokens: 0 },\r\n  };\r\n}\r\n\r\ndescribe(\"SessionUsageService\", () => {\r\n  let service: SessionUsageService;\r\n  let config: Config;\r\n  let historyService: HistoryService;\r\n  let cleanup: () => Promise<void>;\r\n\r\n  beforeEach(async () => {\r\n    ({ config, historyService, cleanup } = await createTestHistoryService());\r\n    service = new SessionUsageService(config, historyService);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await cleanup();\r\n  });\r\n\r\n  describe(\"rollUpUsageIntoParent\", () => {\r\n    it(\"should roll up child usage into parent without changing parent's lastRequest\", async () => {\r\n      const projectPath = \"/tmp/mux-session-usage-test-project\";\r\n      const model = \"claude-sonnet-4-20250514\";\r\n\r\n      const parentWorkspaceId = \"parent-workspace\";\r\n      const childWorkspaceId = \"child-workspace\";\r\n\r\n      await config.addWorkspace(projectPath, {\r\n        id: parentWorkspaceId,\r\n        name: \"parent-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n      });\r\n      await config.addWorkspace(projectPath, {\r\n        id: childWorkspaceId,\r\n        name: \"child-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n        parentWorkspaceId: parentWorkspaceId,\r\n      });\r\n\r\n      const parentUsage = createUsage(100, 50);\r\n      await service.recordUsage(parentWorkspaceId, model, parentUsage);\r\n      const before = await service.getSessionUsage(parentWorkspaceId);\r\n      expect(before?.lastRequest).toBeDefined();\r\n\r\n      const beforeLastRequest = before!.lastRequest!;\r\n\r\n      const childUsageByModel = { [model]: createUsage(7, 3) };\r\n      const rollupResult = await service.rollUpUsageIntoParent(\r\n        parentWorkspaceId,\r\n        childWorkspaceId,\r\n        childUsageByModel\r\n      );\r\n      expect(rollupResult.didRollUp).toBe(true);\r\n\r\n      const after = await service.getSessionUsage(parentWorkspaceId);\r\n      expect(after).toBeDefined();\r\n      expect(after!.byModel[model].input.tokens).toBe(107);\r\n      expect(after!.byModel[model].output.tokens).toBe(53);\r\n\r\n      // lastRequest is preserved\r\n      expect(after!.lastRequest).toEqual(beforeLastRequest);\r\n    });\r\n\r\n    it(\"should be idempotent for the same child workspace\", async () => {\r\n      const projectPath = \"/tmp/mux-session-usage-test-project\";\r\n      const model = \"claude-sonnet-4-20250514\";\r\n\r\n      const parentWorkspaceId = \"parent-workspace\";\r\n      const childWorkspaceId = \"child-workspace\";\r\n\r\n      await config.addWorkspace(projectPath, {\r\n        id: parentWorkspaceId,\r\n        name: \"parent-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n      });\r\n\r\n      const childUsageByModel = { [model]: createUsage(10, 5) };\r\n\r\n      const first = await service.rollUpUsageIntoParent(\r\n        parentWorkspaceId,\r\n        childWorkspaceId,\r\n        childUsageByModel\r\n      );\r\n      expect(first.didRollUp).toBe(true);\r\n\r\n      const second = await service.rollUpUsageIntoParent(\r\n        parentWorkspaceId,\r\n        childWorkspaceId,\r\n        childUsageByModel\r\n      );\r\n      expect(second.didRollUp).toBe(false);\r\n\r\n      const result = await service.getSessionUsage(parentWorkspaceId);\r\n      expect(result).toBeDefined();\r\n      expect(result!.byModel[model].input.tokens).toBe(10);\r\n      expect(result!.byModel[model].output.tokens).toBe(5);\r\n      expect(result!.rolledUpFrom?.[childWorkspaceId]).toBe(true);\r\n    });\r\n  });\r\n  describe(\"recordUsage\", () => {\r\n    it(\"should accumulate usage for same model (not overwrite)\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const model = \"claude-sonnet-4-20250514\";\r\n      const usage1 = createUsage(100, 50);\r\n      const usage2 = createUsage(200, 75);\r\n\r\n      await service.recordUsage(workspaceId, model, usage1);\r\n      await service.recordUsage(workspaceId, model, usage2);\r\n\r\n      const result = await service.getSessionUsage(workspaceId);\r\n      expect(result).toBeDefined();\r\n      expect(result!.byModel[model].input.tokens).toBe(300); // 100 + 200\r\n      expect(result!.byModel[model].output.tokens).toBe(125); // 50 + 75\r\n    });\r\n\r\n    it(\"should track separate usage per model\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const sonnet = createUsage(100, 50);\r\n      const opus = createUsage(500, 200);\r\n\r\n      await service.recordUsage(workspaceId, \"claude-sonnet-4-20250514\", sonnet);\r\n      await service.recordUsage(workspaceId, \"claude-opus-4-20250514\", opus);\r\n\r\n      const result = await service.getSessionUsage(workspaceId);\r\n      expect(result).toBeDefined();\r\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"].input.tokens).toBe(100);\r\n      expect(result!.byModel[\"claude-opus-4-20250514\"].input.tokens).toBe(500);\r\n    });\r\n\r\n    it(\"should update lastRequest with each recordUsage call\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      const usage1 = createUsage(100, 50);\r\n      const usage2 = createUsage(200, 75);\r\n\r\n      await service.recordUsage(workspaceId, \"claude-sonnet-4-20250514\", usage1);\r\n      let result = await service.getSessionUsage(workspaceId);\r\n      expect(result?.lastRequest?.model).toBe(\"claude-sonnet-4-20250514\");\r\n      expect(result?.lastRequest?.usage.input.tokens).toBe(100);\r\n\r\n      await service.recordUsage(workspaceId, \"claude-opus-4-20250514\", usage2);\r\n      result = await service.getSessionUsage(workspaceId);\r\n      expect(result?.lastRequest?.model).toBe(\"claude-opus-4-20250514\");\r\n      expect(result?.lastRequest?.usage.input.tokens).toBe(200);\r\n    });\r\n  });\r\n\r\n  describe(\"setTokenStatsCache\", () => {\r\n    it(\"should persist tokenStatsCache and preserve existing usage fields\", async () => {\r\n      const projectPath = \"/tmp/mux-session-usage-test-project\";\r\n      const model = \"claude-sonnet-4-20250514\";\r\n\r\n      const parentWorkspaceId = \"parent-workspace\";\r\n      const childWorkspaceId = \"child-workspace\";\r\n\r\n      await config.addWorkspace(projectPath, {\r\n        id: parentWorkspaceId,\r\n        name: \"parent-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n      });\r\n      await config.addWorkspace(projectPath, {\r\n        id: childWorkspaceId,\r\n        name: \"child-branch\",\r\n        projectName: \"test-project\",\r\n        projectPath,\r\n        runtimeConfig: { type: \"local\" },\r\n        parentWorkspaceId: parentWorkspaceId,\r\n      });\r\n\r\n      // Seed: base usage + rolledUpFrom ledger\r\n      await service.recordUsage(parentWorkspaceId, model, createUsage(100, 50));\r\n      await service.rollUpUsageIntoParent(parentWorkspaceId, childWorkspaceId, {\r\n        [model]: createUsage(7, 3),\r\n      });\r\n\r\n      const cache: SessionUsageTokenStatsCacheV1 = {\r\n        version: 1,\r\n        computedAt: 123,\r\n        model: \"gpt-4\",\r\n        tokenizerName: \"cl100k\",\r\n        history: { messageCount: 2, maxHistorySequence: 42 },\r\n        consumers: [{ name: \"User\", tokens: 10, percentage: 100 }],\r\n        totalTokens: 10,\r\n        topFilePaths: [{ path: \"/tmp/file.ts\", tokens: 10 }],\r\n      };\r\n\r\n      await service.setTokenStatsCache(parentWorkspaceId, cache);\r\n\r\n      const result = await service.getSessionUsage(parentWorkspaceId);\r\n      expect(result).toBeDefined();\r\n      expect(result!.tokenStatsCache).toEqual(cache);\r\n      expect(result!.rolledUpFrom?.[childWorkspaceId]).toBe(true);\r\n\r\n      // Existing usage fields preserved\r\n      expect(result!.byModel[model].input.tokens).toBe(107);\r\n      expect(result!.byModel[model].output.tokens).toBe(53);\r\n      expect(result!.lastRequest).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe(\"getSessionUsage\", () => {\r\n    it(\"should rebuild from messages when file missing (ENOENT)\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      // Seed messages via real historyService\r\n      await historyService.appendToHistory(\r\n        workspaceId,\r\n        createMuxMessage(\"msg1\", \"assistant\", \"Hello\", {\r\n          model: \"claude-sonnet-4-20250514\",\r\n          usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\r\n        })\r\n      );\r\n      await historyService.appendToHistory(\r\n        workspaceId,\r\n        createMuxMessage(\"msg2\", \"assistant\", \"World\", {\r\n          model: \"claude-sonnet-4-20250514\",\r\n          usage: { inputTokens: 200, outputTokens: 75, totalTokens: 275 },\r\n        })\r\n      );\r\n\r\n      // Delete session-usage.json but keep session dir (appendToHistory created it)\r\n      const usagePath = path.join(config.getSessionDir(workspaceId), \"session-usage.json\");\r\n      await fs.rm(usagePath, { force: true });\r\n\r\n      const result = await service.getSessionUsage(workspaceId);\r\n\r\n      expect(result).toBeDefined();\r\n      // Should have rebuilt and summed the usage\r\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"]).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe(\"rebuildFromMessages\", () => {\r\n    it(\"should rebuild from messages when file is corrupted JSON\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n      // Seed messages via real historyService\r\n      await historyService.appendToHistory(\r\n        workspaceId,\r\n        createMuxMessage(\"msg1\", \"assistant\", \"Hello\", {\r\n          model: \"claude-sonnet-4-20250514\",\r\n          usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\r\n        })\r\n      );\r\n\r\n      // Overwrite session-usage.json with corrupted JSON\r\n      const sessionDir = config.getSessionDir(workspaceId);\r\n      await fs.writeFile(path.join(sessionDir, \"session-usage.json\"), \"{ invalid json\");\r\n\r\n      const result = await service.getSessionUsage(workspaceId);\r\n\r\n      expect(result).toBeDefined();\r\n      // Should have rebuilt from messages\r\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"]).toBeDefined();\r\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"].input.tokens).toBe(100);\r\n    });\r\n\r\n    it(\"should include historicalUsage from legacy compaction summaries\", async () => {\r\n      const workspaceId = \"test-workspace\";\r\n\r\n      // Create a compaction summary with historicalUsage (legacy format)\r\n      const compactionSummary = createMuxMessage(\"summary-1\", \"assistant\", \"Compacted summary\", {\r\n        historySequence: 1,\r\n        compacted: true,\r\n        model: \"anthropic:claude-sonnet-4-5\",\r\n        usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\r\n      });\r\n\r\n      // Add historicalUsage - this field was removed from MuxMetadata type\r\n      // but may still exist in persisted data from before the change\r\n      (compactionSummary.metadata as Record<string, unknown>).historicalUsage = createUsage(\r\n        5000,\r\n        1000\r\n      );\r\n\r\n      // Add a post-compaction message\r\n      const postCompactionMsg = createMuxMessage(\"msg2\", \"assistant\", \"New response\", {\r\n        historySequence: 2,\r\n        model: \"anthropic:claude-sonnet-4-5\",\r\n        usage: { inputTokens: 200, outputTokens: 75, totalTokens: 275 },\r\n      });\r\n\r\n      // Seed messages via real historyService\r\n      await historyService.appendToHistory(workspaceId, compactionSummary);\r\n      await historyService.appendToHistory(workspaceId, postCompactionMsg);\r\n\r\n      // Delete session-usage.json to trigger rebuild from messages\r\n      const usagePath = path.join(config.getSessionDir(workspaceId), \"session-usage.json\");\r\n      await fs.rm(usagePath, { force: true });\r\n\r\n      const result = await service.getSessionUsage(workspaceId);\r\n\r\n      expect(result).toBeDefined();\r\n      // Should include historical usage under \"historical\" key\r\n      expect(result!.byModel.historical).toBeDefined();\r\n      expect(result!.byModel.historical.input.tokens).toBe(5000);\r\n      expect(result!.byModel.historical.output.tokens).toBe(1000);\r\n\r\n      // Should also include current model usage (compaction summary + post-compaction)\r\n      expect(result!.byModel[\"anthropic:claude-sonnet-4-5\"]).toBeDefined();\r\n      expect(result!.byModel[\"anthropic:claude-sonnet-4-5\"].input.tokens).toBe(300); // 100 + 200\r\n    });\r\n  });\r\n});\r\n"]}