{"version":3,"file":"sessionUsageService.test.js","sourceRoot":"","sources":["../../../src/node/services/sessionUsageService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\nimport { SessionUsageService, type SessionUsageTokenStatsCacheV1 } from \"./sessionUsageService\";\nimport type { HistoryService } from \"./historyService\";\nimport type { Config } from \"@/node/config\";\nimport { createMuxMessage } from \"@/common/types/message\";\nimport type { ChatUsageDisplay } from \"@/common/utils/tokens/usageAggregator\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\n\nfunction createUsage(input: number, output: number): ChatUsageDisplay {\n  return {\n    input: { tokens: input },\n    output: { tokens: output },\n    cached: { tokens: 0 },\n    cacheCreate: { tokens: 0 },\n    reasoning: { tokens: 0 },\n  };\n}\n\ndescribe(\"SessionUsageService\", () => {\n  let service: SessionUsageService;\n  let config: Config;\n  let historyService: HistoryService;\n  let cleanup: () => Promise<void>;\n\n  beforeEach(async () => {\n    ({ config, historyService, cleanup } = await createTestHistoryService());\n    service = new SessionUsageService(config, historyService);\n  });\n\n  afterEach(async () => {\n    await cleanup();\n  });\n\n  describe(\"rollUpUsageIntoParent\", () => {\n    it(\"should roll up child usage into parent without changing parent's lastRequest\", async () => {\n      const projectPath = \"/tmp/mux-session-usage-test-project\";\n      const model = \"claude-sonnet-4-20250514\";\n\n      const parentWorkspaceId = \"parent-workspace\";\n      const childWorkspaceId = \"child-workspace\";\n\n      await config.addWorkspace(projectPath, {\n        id: parentWorkspaceId,\n        name: \"parent-branch\",\n        projectName: \"test-project\",\n        projectPath,\n        runtimeConfig: { type: \"local\" },\n      });\n      await config.addWorkspace(projectPath, {\n        id: childWorkspaceId,\n        name: \"child-branch\",\n        projectName: \"test-project\",\n        projectPath,\n        runtimeConfig: { type: \"local\" },\n        parentWorkspaceId: parentWorkspaceId,\n      });\n\n      const parentUsage = createUsage(100, 50);\n      await service.recordUsage(parentWorkspaceId, model, parentUsage);\n      const before = await service.getSessionUsage(parentWorkspaceId);\n      expect(before?.lastRequest).toBeDefined();\n\n      const beforeLastRequest = before!.lastRequest!;\n\n      const childUsageByModel = { [model]: createUsage(7, 3) };\n      const rollupResult = await service.rollUpUsageIntoParent(\n        parentWorkspaceId,\n        childWorkspaceId,\n        childUsageByModel\n      );\n      expect(rollupResult.didRollUp).toBe(true);\n\n      const after = await service.getSessionUsage(parentWorkspaceId);\n      expect(after).toBeDefined();\n      expect(after!.byModel[model].input.tokens).toBe(107);\n      expect(after!.byModel[model].output.tokens).toBe(53);\n\n      // lastRequest is preserved\n      expect(after!.lastRequest).toEqual(beforeLastRequest);\n    });\n\n    it(\"should be idempotent for the same child workspace\", async () => {\n      const projectPath = \"/tmp/mux-session-usage-test-project\";\n      const model = \"claude-sonnet-4-20250514\";\n\n      const parentWorkspaceId = \"parent-workspace\";\n      const childWorkspaceId = \"child-workspace\";\n\n      await config.addWorkspace(projectPath, {\n        id: parentWorkspaceId,\n        name: \"parent-branch\",\n        projectName: \"test-project\",\n        projectPath,\n        runtimeConfig: { type: \"local\" },\n      });\n\n      const childUsageByModel = { [model]: createUsage(10, 5) };\n\n      const first = await service.rollUpUsageIntoParent(\n        parentWorkspaceId,\n        childWorkspaceId,\n        childUsageByModel\n      );\n      expect(first.didRollUp).toBe(true);\n\n      const second = await service.rollUpUsageIntoParent(\n        parentWorkspaceId,\n        childWorkspaceId,\n        childUsageByModel\n      );\n      expect(second.didRollUp).toBe(false);\n\n      const result = await service.getSessionUsage(parentWorkspaceId);\n      expect(result).toBeDefined();\n      expect(result!.byModel[model].input.tokens).toBe(10);\n      expect(result!.byModel[model].output.tokens).toBe(5);\n      expect(result!.rolledUpFrom?.[childWorkspaceId]).toBe(true);\n    });\n  });\n  describe(\"recordUsage\", () => {\n    it(\"should accumulate usage for same model (not overwrite)\", async () => {\n      const workspaceId = \"test-workspace\";\n      const model = \"claude-sonnet-4-20250514\";\n      const usage1 = createUsage(100, 50);\n      const usage2 = createUsage(200, 75);\n\n      await service.recordUsage(workspaceId, model, usage1);\n      await service.recordUsage(workspaceId, model, usage2);\n\n      const result = await service.getSessionUsage(workspaceId);\n      expect(result).toBeDefined();\n      expect(result!.byModel[model].input.tokens).toBe(300); // 100 + 200\n      expect(result!.byModel[model].output.tokens).toBe(125); // 50 + 75\n    });\n\n    it(\"should track separate usage per model\", async () => {\n      const workspaceId = \"test-workspace\";\n      const sonnet = createUsage(100, 50);\n      const opus = createUsage(500, 200);\n\n      await service.recordUsage(workspaceId, \"claude-sonnet-4-20250514\", sonnet);\n      await service.recordUsage(workspaceId, \"claude-opus-4-20250514\", opus);\n\n      const result = await service.getSessionUsage(workspaceId);\n      expect(result).toBeDefined();\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"].input.tokens).toBe(100);\n      expect(result!.byModel[\"claude-opus-4-20250514\"].input.tokens).toBe(500);\n    });\n\n    it(\"should update lastRequest with each recordUsage call\", async () => {\n      const workspaceId = \"test-workspace\";\n      const usage1 = createUsage(100, 50);\n      const usage2 = createUsage(200, 75);\n\n      await service.recordUsage(workspaceId, \"claude-sonnet-4-20250514\", usage1);\n      let result = await service.getSessionUsage(workspaceId);\n      expect(result?.lastRequest?.model).toBe(\"claude-sonnet-4-20250514\");\n      expect(result?.lastRequest?.usage.input.tokens).toBe(100);\n\n      await service.recordUsage(workspaceId, \"claude-opus-4-20250514\", usage2);\n      result = await service.getSessionUsage(workspaceId);\n      expect(result?.lastRequest?.model).toBe(\"claude-opus-4-20250514\");\n      expect(result?.lastRequest?.usage.input.tokens).toBe(200);\n    });\n  });\n\n  describe(\"setTokenStatsCache\", () => {\n    it(\"should persist tokenStatsCache and preserve existing usage fields\", async () => {\n      const projectPath = \"/tmp/mux-session-usage-test-project\";\n      const model = \"claude-sonnet-4-20250514\";\n\n      const parentWorkspaceId = \"parent-workspace\";\n      const childWorkspaceId = \"child-workspace\";\n\n      await config.addWorkspace(projectPath, {\n        id: parentWorkspaceId,\n        name: \"parent-branch\",\n        projectName: \"test-project\",\n        projectPath,\n        runtimeConfig: { type: \"local\" },\n      });\n      await config.addWorkspace(projectPath, {\n        id: childWorkspaceId,\n        name: \"child-branch\",\n        projectName: \"test-project\",\n        projectPath,\n        runtimeConfig: { type: \"local\" },\n        parentWorkspaceId: parentWorkspaceId,\n      });\n\n      // Seed: base usage + rolledUpFrom ledger\n      await service.recordUsage(parentWorkspaceId, model, createUsage(100, 50));\n      await service.rollUpUsageIntoParent(parentWorkspaceId, childWorkspaceId, {\n        [model]: createUsage(7, 3),\n      });\n\n      const cache: SessionUsageTokenStatsCacheV1 = {\n        version: 1,\n        computedAt: 123,\n        model: \"gpt-4\",\n        tokenizerName: \"cl100k\",\n        history: { messageCount: 2, maxHistorySequence: 42 },\n        consumers: [{ name: \"User\", tokens: 10, percentage: 100 }],\n        totalTokens: 10,\n        topFilePaths: [{ path: \"/tmp/file.ts\", tokens: 10 }],\n      };\n\n      await service.setTokenStatsCache(parentWorkspaceId, cache);\n\n      const result = await service.getSessionUsage(parentWorkspaceId);\n      expect(result).toBeDefined();\n      expect(result!.tokenStatsCache).toEqual(cache);\n      expect(result!.rolledUpFrom?.[childWorkspaceId]).toBe(true);\n\n      // Existing usage fields preserved\n      expect(result!.byModel[model].input.tokens).toBe(107);\n      expect(result!.byModel[model].output.tokens).toBe(53);\n      expect(result!.lastRequest).toBeDefined();\n    });\n  });\n\n  describe(\"getSessionUsage\", () => {\n    it(\"should rebuild from messages when file missing (ENOENT)\", async () => {\n      const workspaceId = \"test-workspace\";\n      // Seed messages via real historyService\n      await historyService.appendToHistory(\n        workspaceId,\n        createMuxMessage(\"msg1\", \"assistant\", \"Hello\", {\n          model: \"claude-sonnet-4-20250514\",\n          usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\n        })\n      );\n      await historyService.appendToHistory(\n        workspaceId,\n        createMuxMessage(\"msg2\", \"assistant\", \"World\", {\n          model: \"claude-sonnet-4-20250514\",\n          usage: { inputTokens: 200, outputTokens: 75, totalTokens: 275 },\n        })\n      );\n\n      // Delete session-usage.json but keep session dir (appendToHistory created it)\n      const usagePath = path.join(config.getSessionDir(workspaceId), \"session-usage.json\");\n      await fs.rm(usagePath, { force: true });\n\n      const result = await service.getSessionUsage(workspaceId);\n\n      expect(result).toBeDefined();\n      // Should have rebuilt and summed the usage\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"]).toBeDefined();\n    });\n  });\n\n  describe(\"rebuildFromMessages\", () => {\n    it(\"should rebuild from messages when file is corrupted JSON\", async () => {\n      const workspaceId = \"test-workspace\";\n      // Seed messages via real historyService\n      await historyService.appendToHistory(\n        workspaceId,\n        createMuxMessage(\"msg1\", \"assistant\", \"Hello\", {\n          model: \"claude-sonnet-4-20250514\",\n          usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\n        })\n      );\n\n      // Overwrite session-usage.json with corrupted JSON\n      const sessionDir = config.getSessionDir(workspaceId);\n      await fs.writeFile(path.join(sessionDir, \"session-usage.json\"), \"{ invalid json\");\n\n      const result = await service.getSessionUsage(workspaceId);\n\n      expect(result).toBeDefined();\n      // Should have rebuilt from messages\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"]).toBeDefined();\n      expect(result!.byModel[\"claude-sonnet-4-20250514\"].input.tokens).toBe(100);\n    });\n\n    it(\"should include historicalUsage from legacy compaction summaries\", async () => {\n      const workspaceId = \"test-workspace\";\n\n      // Create a compaction summary with historicalUsage (legacy format)\n      const compactionSummary = createMuxMessage(\"summary-1\", \"assistant\", \"Compacted summary\", {\n        historySequence: 1,\n        compacted: true,\n        model: \"anthropic:claude-sonnet-4-5\",\n        usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },\n      });\n\n      // Add historicalUsage - this field was removed from MuxMetadata type\n      // but may still exist in persisted data from before the change\n      (compactionSummary.metadata as Record<string, unknown>).historicalUsage = createUsage(\n        5000,\n        1000\n      );\n\n      // Add a post-compaction message\n      const postCompactionMsg = createMuxMessage(\"msg2\", \"assistant\", \"New response\", {\n        historySequence: 2,\n        model: \"anthropic:claude-sonnet-4-5\",\n        usage: { inputTokens: 200, outputTokens: 75, totalTokens: 275 },\n      });\n\n      // Seed messages via real historyService\n      await historyService.appendToHistory(workspaceId, compactionSummary);\n      await historyService.appendToHistory(workspaceId, postCompactionMsg);\n\n      // Delete session-usage.json to trigger rebuild from messages\n      const usagePath = path.join(config.getSessionDir(workspaceId), \"session-usage.json\");\n      await fs.rm(usagePath, { force: true });\n\n      const result = await service.getSessionUsage(workspaceId);\n\n      expect(result).toBeDefined();\n      // Should include historical usage under \"historical\" key\n      expect(result!.byModel.historical).toBeDefined();\n      expect(result!.byModel.historical.input.tokens).toBe(5000);\n      expect(result!.byModel.historical.output.tokens).toBe(1000);\n\n      // Should also include current model usage (compaction summary + post-compaction)\n      expect(result!.byModel[\"anthropic:claude-sonnet-4-5\"]).toBeDefined();\n      expect(result!.byModel[\"anthropic:claude-sonnet-4-5\"].input.tokens).toBe(300); // 100 + 200\n    });\n  });\n});\n"]}