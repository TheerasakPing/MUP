{"version":3,"file":"ExtensionMetadataService.js","sourceRoot":"","sources":["../../../src/node/services/ExtensionMetadataService.ts"],"names":[],"mappings":"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","sourcesContent":["import { dirname } from \"path\";\r\nimport { mkdir, readFile, access } from \"fs/promises\";\r\nimport { constants } from \"fs\";\r\nimport writeFileAtomic from \"write-file-atomic\";\r\nimport {\r\n  type ExtensionMetadata,\r\n  type ExtensionMetadataFile,\r\n  getExtensionMetadataPath,\r\n} from \"@/node/utils/extensionMetadata\";\r\nimport type { WorkspaceActivitySnapshot } from \"@/common/types/workspace\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\n/**\r\n * Stateless service for managing workspace metadata used by VS Code extension integration.\r\n *\r\n * This service tracks:\r\n * - recency: Unix timestamp (ms) of last user interaction\r\n * - streaming: Boolean indicating if workspace has an active stream\r\n * - lastModel: Last model used in this workspace\r\n * - lastThinkingLevel: Last thinking/reasoning level used in this workspace\r\n *\r\n * File location: ~/.mux/extensionMetadata.json\r\n *\r\n * Design:\r\n * - Stateless: reads from disk on every operation, no in-memory cache\r\n * - Atomic writes: uses write-file-atomic to prevent corruption\r\n * - Read-heavy workload: extension reads, main app writes on user interactions\r\n */\r\n\r\nexport interface ExtensionWorkspaceMetadata extends ExtensionMetadata {\r\n  workspaceId: string;\r\n  updatedAt: number;\r\n}\r\n\r\nexport class ExtensionMetadataService {\r\n  private readonly filePath: string;\r\n  private toSnapshot(entry: ExtensionMetadata): WorkspaceActivitySnapshot {\r\n    return {\r\n      recency: entry.recency,\r\n      streaming: entry.streaming,\r\n      lastModel: entry.lastModel ?? null,\r\n      lastThinkingLevel: entry.lastThinkingLevel ?? null,\r\n    };\r\n  }\r\n\r\n  constructor(filePath?: string) {\r\n    this.filePath = filePath ?? getExtensionMetadataPath();\r\n  }\r\n\r\n  /**\r\n   * Initialize the service by ensuring directory exists and clearing stale streaming flags.\r\n   * Call this once on app startup.\r\n   */\r\n  async initialize(): Promise<void> {\r\n    // Ensure directory exists\r\n    const dir = dirname(this.filePath);\r\n    try {\r\n      await access(dir, constants.F_OK);\r\n    } catch {\r\n      await mkdir(dir, { recursive: true });\r\n    }\r\n\r\n    // Clear stale streaming flags (from crashes)\r\n    await this.clearStaleStreaming();\r\n  }\r\n\r\n  private async load(): Promise<ExtensionMetadataFile> {\r\n    try {\r\n      await access(this.filePath, constants.F_OK);\r\n    } catch {\r\n      return { version: 1, workspaces: {} };\r\n    }\r\n\r\n    try {\r\n      const content = await readFile(this.filePath, \"utf-8\");\r\n      const parsed = JSON.parse(content) as ExtensionMetadataFile;\r\n\r\n      // Validate structure\r\n      if (typeof parsed !== \"object\" || parsed.version !== 1) {\r\n        log.error(\"Invalid metadata file, resetting\");\r\n        return { version: 1, workspaces: {} };\r\n      }\r\n\r\n      return parsed;\r\n    } catch (error) {\r\n      log.error(\"Failed to load metadata:\", error);\r\n      return { version: 1, workspaces: {} };\r\n    }\r\n  }\r\n\r\n  private async save(data: ExtensionMetadataFile): Promise<void> {\r\n    try {\r\n      const content = JSON.stringify(data, null, 2);\r\n      await writeFileAtomic(this.filePath, content, \"utf-8\");\r\n    } catch (error) {\r\n      log.error(\"Failed to save metadata:\", error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the recency timestamp for a workspace.\r\n   * Call this on user messages or other interactions.\r\n   */\r\n  async updateRecency(\r\n    workspaceId: string,\r\n    timestamp: number = Date.now()\r\n  ): Promise<WorkspaceActivitySnapshot> {\r\n    const data = await this.load();\r\n\r\n    if (!data.workspaces[workspaceId]) {\r\n      data.workspaces[workspaceId] = {\r\n        recency: timestamp,\r\n        streaming: false,\r\n        lastModel: null,\r\n        lastThinkingLevel: null,\r\n      };\r\n    } else {\r\n      data.workspaces[workspaceId].recency = timestamp;\r\n    }\r\n\r\n    await this.save(data);\r\n    const workspace = data.workspaces[workspaceId];\r\n    if (!workspace) {\r\n      throw new Error(`Workspace ${workspaceId} metadata missing after update.`);\r\n    }\r\n    return this.toSnapshot(workspace);\r\n  }\r\n\r\n  /**\r\n   * Set the streaming status for a workspace.\r\n   * Call this when streams start/end.\r\n   */\r\n  async setStreaming(\r\n    workspaceId: string,\r\n    streaming: boolean,\r\n    model?: string,\r\n    thinkingLevel?: ExtensionMetadata[\"lastThinkingLevel\"]\r\n  ): Promise<WorkspaceActivitySnapshot> {\r\n    const data = await this.load();\r\n    const now = Date.now();\r\n\r\n    if (!data.workspaces[workspaceId]) {\r\n      data.workspaces[workspaceId] = {\r\n        recency: now,\r\n        streaming,\r\n        lastModel: model ?? null,\r\n        lastThinkingLevel: thinkingLevel ?? null,\r\n      };\r\n    } else {\r\n      data.workspaces[workspaceId].streaming = streaming;\r\n      if (model) {\r\n        data.workspaces[workspaceId].lastModel = model;\r\n      }\r\n      if (thinkingLevel !== undefined) {\r\n        data.workspaces[workspaceId].lastThinkingLevel = thinkingLevel;\r\n      }\r\n    }\r\n\r\n    await this.save(data);\r\n    const workspace = data.workspaces[workspaceId];\r\n    if (!workspace) {\r\n      throw new Error(`Workspace ${workspaceId} metadata missing after streaming update.`);\r\n    }\r\n    return this.toSnapshot(workspace);\r\n  }\r\n\r\n  /**\r\n   * Get metadata for a single workspace.\r\n   */\r\n  async getMetadata(workspaceId: string): Promise<ExtensionWorkspaceMetadata | null> {\r\n    const data = await this.load();\r\n    const entry = data.workspaces[workspaceId];\r\n    if (!entry) return null;\r\n\r\n    return {\r\n      workspaceId,\r\n      updatedAt: entry.recency, // Use recency as updatedAt for backwards compatibility\r\n      ...entry,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get all workspace metadata, ordered by recency.\r\n   * Used by VS Code extension to sort workspace list.\r\n   */\r\n  async getAllMetadata(): Promise<Map<string, ExtensionWorkspaceMetadata>> {\r\n    const data = await this.load();\r\n    const map = new Map<string, ExtensionWorkspaceMetadata>();\r\n\r\n    // Convert to array, sort by recency, then create map\r\n    const entries = Object.entries(data.workspaces);\r\n    entries.sort((a, b) => b[1].recency - a[1].recency);\r\n\r\n    for (const [workspaceId, entry] of entries) {\r\n      map.set(workspaceId, {\r\n        workspaceId,\r\n        updatedAt: entry.recency, // Use recency as updatedAt for backwards compatibility\r\n        ...entry,\r\n      });\r\n    }\r\n\r\n    return map;\r\n  }\r\n\r\n  /**\r\n   * Delete metadata for a workspace.\r\n   * Call this when a workspace is deleted.\r\n   */\r\n  async deleteWorkspace(workspaceId: string): Promise<void> {\r\n    const data = await this.load();\r\n\r\n    if (data.workspaces[workspaceId]) {\r\n      delete data.workspaces[workspaceId];\r\n      await this.save(data);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all streaming flags.\r\n   * Call this on app startup to clean up stale streaming states from crashes.\r\n   */\r\n  async clearStaleStreaming(): Promise<void> {\r\n    const data = await this.load();\r\n    let modified = false;\r\n\r\n    for (const entry of Object.values(data.workspaces)) {\r\n      if (entry.streaming) {\r\n        entry.streaming = false;\r\n        modified = true;\r\n      }\r\n    }\r\n\r\n    if (modified) {\r\n      await this.save(data);\r\n    }\r\n  }\r\n\r\n  async getAllSnapshots(): Promise<Map<string, WorkspaceActivitySnapshot>> {\r\n    const data = await this.load();\r\n    const map = new Map<string, WorkspaceActivitySnapshot>();\r\n    for (const [workspaceId, entry] of Object.entries(data.workspaces)) {\r\n      map.set(workspaceId, this.toSnapshot(entry));\r\n    }\r\n    return map;\r\n  }\r\n}\r\n"]}