{"version":3,"file":"signingService.js","sourceRoot":"","sources":["../../../src/node/services/signingService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Signing Service\r\n *\r\n * Provides message signing for mux.md shares.\r\n *\r\n * - Loads unencrypted key files from disk via sshpk\r\n * - Can sign via SSH agent (SSH_AUTH_SOCK), including 1Password's SSH agent\r\n * - Produces mux.md-compatible SignatureEnvelopes (no private key bytes cross IPC)\r\n * - Detects GitHub username via `gh auth status`\r\n */\r\n\r\nimport assert from \"node:assert/strict\";\r\nimport { existsSync, readFileSync } from \"fs\";\r\nimport { homedir } from \"os\";\r\nimport { join } from \"path\";\r\nimport {\r\n  computeFingerprint,\r\n  createSignatureEnvelope,\r\n  parsePublicKey,\r\n  type KeyType as MuxMdKeyType,\r\n  type SignatureEnvelope,\r\n} from \"@coder/mux-md-client\";\r\nimport sshpk from \"sshpk\";\r\nimport { OpenSSHAgent, type KnownPublicKeys, type ParsedKey, type PublicKeyEntry } from \"ssh2\";\r\nimport { getMuxHome } from \"@/common/constants/paths\";\r\nimport { execAsync } from \"@/node/utils/disposableExec\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\ninterface KeyPair {\r\n  privateKey: sshpk.PrivateKey;\r\n  privateKeyBytes: Uint8Array;\r\n  publicKeyOpenSSH: string;\r\n}\r\n\r\ninterface IdentityStatus {\r\n  githubUser: string | null;\r\n  error: string | null;\r\n}\r\n\r\ninterface SigningError {\r\n  /** Error message */\r\n  message: string;\r\n  /** True if a compatible key was found but requires a passphrase */\r\n  hasEncryptedKey: boolean;\r\n}\r\n\r\ninterface SigningCapabilities {\r\n  /** Public key in OpenSSH format (ssh-ed25519 AAAA...), null if unavailable */\r\n  publicKey: string | null;\r\n  /** Detected GitHub username, if any */\r\n  githubUser: string | null;\r\n  /** Error info if key loading or identity detection failed */\r\n  error: SigningError | null;\r\n}\r\n\r\ntype SigningKeySelection =\r\n  | {\r\n      kind: \"disk\";\r\n      keyPair: KeyPair;\r\n    }\r\n  | {\r\n      kind: \"ssh-agent\";\r\n      sshAuthSock: string;\r\n      publicKeyOpenSSH: string;\r\n      fingerprint: string;\r\n    };\r\n\r\ninterface AgentKeyCandidate {\r\n  publicKeyOpenSSH: string;\r\n  fingerprint: string;\r\n  muxKeyType: MuxMdKeyType;\r\n}\r\n\r\nconst SUPPORTED_AGENT_KEY_TYPES = new Set([\r\n  \"ssh-ed25519\",\r\n  \"ecdsa-sha2-nistp256\",\r\n  \"ecdsa-sha2-nistp384\",\r\n  \"ecdsa-sha2-nistp521\",\r\n]);\r\n\r\n/**\r\n * Probe whether the @coder/mux-md-client/ssh-agent subpath is importable.\r\n * Caches the result so we only pay the cost once. If the module is missing\r\n * (e.g. bun resolved to a version without the export), ssh-agent signing is\r\n * silently unavailable and the service falls back to disk keys.\r\n */\r\nlet sshAgentModuleAvailable: boolean | null = null;\r\nasync function isSshAgentModuleAvailable(): Promise<boolean> {\r\n  if (sshAgentModuleAvailable != null) return sshAgentModuleAvailable;\r\n  try {\r\n    // eslint-disable-next-line no-restricted-syntax -- startup resilience probe\r\n    await import(\"@coder/mux-md-client/ssh-agent\");\r\n    sshAgentModuleAvailable = true;\r\n  } catch {\r\n    log.warn(\r\n      \"[SigningService] @coder/mux-md-client/ssh-agent is not available — ssh-agent signing disabled. \" +\r\n        \"This usually means the package resolved to a version missing the export.\"\r\n    );\r\n    sshAgentModuleAvailable = false;\r\n  }\r\n  return sshAgentModuleAvailable;\r\n}\r\n\r\nconst AGENT_KEY_TYPE_PRIORITY: Record<MuxMdKeyType, number> = {\r\n  ed25519: 0,\r\n  \"ecdsa-p256\": 1,\r\n  \"ecdsa-p384\": 2,\r\n  \"ecdsa-p521\": 3,\r\n};\r\n\r\n/** Default paths to check for signing keys, in order of preference */\r\nexport function getDefaultKeyPaths(): string[] {\r\n  return [\r\n    join(getMuxHome(), \"message_signing_key\"), // Explicit mux key (any supported type, symlink-friendly)\r\n    join(homedir(), \".ssh\", \"id_ed25519\"), // SSH Ed25519\r\n    join(homedir(), \".ssh\", \"id_ecdsa\"), // SSH ECDSA\r\n  ];\r\n}\r\n\r\nfunction normalizeOpenSshPublicKey(publicKey: string): string | null {\r\n  const parts = publicKey.trim().split(/\\s+/);\r\n  if (parts.length < 2) return null;\r\n  return `${parts[0]} ${parts[1]}`;\r\n}\r\n\r\n/**\r\n * Service for message signing (Ed25519 or ECDSA).\r\n * Loads keys from disk or uses an SSH agent if available.\r\n */\r\nexport class SigningService {\r\n  private signingKey: SigningKeySelection | null = null;\r\n  private keyLoadAttempted = false;\r\n  private keyLoadPromise: Promise<SigningKeySelection | null> | null = null;\r\n  private keyLoadError: string | null = null;\r\n  private hasEncryptedKey = false;\r\n\r\n  private identityCache: IdentityStatus | null = null;\r\n  private identityPromise: Promise<IdentityStatus> | null = null;\r\n  private readonly keyPaths: string[];\r\n\r\n  constructor(keyPaths?: string[]) {\r\n    this.keyPaths = keyPaths ?? getDefaultKeyPaths();\r\n    assert(this.keyPaths.length > 0, \"SigningService: keyPaths must be non-empty\");\r\n  }\r\n\r\n  private static isParsedKey(value: unknown): value is ParsedKey {\r\n    return (\r\n      typeof value === \"object\" &&\r\n      value !== null &&\r\n      \"type\" in value &&\r\n      typeof (value as ParsedKey).getPublicSSH === \"function\"\r\n    );\r\n  }\r\n\r\n  private static unwrapSshAgentIdentity(identity: ParsedKey | PublicKeyEntry): ParsedKey | null {\r\n    if (SigningService.isParsedKey(identity)) return identity;\r\n\r\n    const pubKey = identity.pubKey;\r\n    if (SigningService.isParsedKey(pubKey)) return pubKey;\r\n\r\n    if (typeof pubKey === \"object\" && pubKey !== null && \"pubKey\" in pubKey) {\r\n      const inner = (pubKey as { pubKey: ParsedKey | Buffer | string }).pubKey;\r\n      if (SigningService.isParsedKey(inner)) return inner;\r\n    }\r\n\r\n    return null;\r\n  }\r\n  private static isSupportedDiskKeyType(type: string): type is \"ed25519\" | \"ecdsa\" {\r\n    return type === \"ed25519\" || type === \"ecdsa\";\r\n  }\r\n\r\n  /**\r\n   * Load a signing keypair from disk using sshpk.\r\n   * Supports Ed25519 and ECDSA keys in PEM or OpenSSH format.\r\n   */\r\n  private tryLoadDiskKeyPair(keyPaths: string[]): KeyPair | null {\r\n    for (const keyPath of keyPaths) {\r\n      if (!existsSync(keyPath)) continue;\r\n\r\n      try {\r\n        log.info(\"[SigningService] Attempting to load key from:\", keyPath);\r\n        const keyData = readFileSync(keyPath, \"utf-8\");\r\n\r\n        // Parse with sshpk (auto-detects format)\r\n        const privateKey = sshpk.parsePrivateKey(keyData, \"auto\", { filename: keyPath });\r\n\r\n        // Verify it's a supported key type\r\n        if (!SigningService.isSupportedDiskKeyType(privateKey.type)) {\r\n          log.info(\r\n            \"[SigningService] Key at\",\r\n            keyPath,\r\n            \"is\",\r\n            privateKey.type,\r\n            \"- not supported (need ed25519 or ecdsa), skipping\"\r\n          );\r\n          continue;\r\n        }\r\n\r\n        // Get public key in OpenSSH format\r\n        const publicKeyOpenSSH = privateKey.toPublic().toString(\"ssh\");\r\n\r\n        // Extract raw private key bytes for use with mux-md-client signing\r\n        const privateKeyBytes = this.extractPrivateKeyBytes(privateKey);\r\n\r\n        const keyPair = { privateKey, privateKeyBytes, publicKeyOpenSSH };\r\n\r\n        log.info(\"[SigningService] Loaded\", privateKey.type, \"key from:\", keyPath);\r\n        log.info(\"[SigningService] Public key:\", publicKeyOpenSSH.slice(0, 50) + \"...\");\r\n        return keyPair;\r\n      } catch (err) {\r\n        const message = err instanceof Error ? err.message : String(err);\r\n        // Check for encrypted key\r\n        if (message.includes(\"encrypted\") || message.includes(\"passphrase\")) {\r\n          log.info(\r\n            \"[SigningService] Encrypted key at\",\r\n            keyPath,\r\n            \"- skipping (passphrase required)\"\r\n          );\r\n          this.hasEncryptedKey = true;\r\n          continue;\r\n        }\r\n        log.warn(\"[SigningService] Failed to load key from\", keyPath + \":\", message);\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  private async listSshAgentKeyCandidates(sshAuthSock: string): Promise<AgentKeyCandidate[]> {\r\n    assert(\r\n      sshAuthSock.trim().length > 0,\r\n      \"listSshAgentKeyCandidates: sshAuthSock must be non-empty\"\r\n    );\r\n\r\n    const agent = new OpenSSHAgent(sshAuthSock);\r\n    const identities = await new Promise<KnownPublicKeys<ParsedKey>>((resolve, reject) => {\r\n      agent.getIdentities((err, keys) => {\r\n        if (err) {\r\n          reject(err);\r\n          return;\r\n        }\r\n        resolve(keys ?? []);\r\n      });\r\n    });\r\n\r\n    const candidates: AgentKeyCandidate[] = [];\r\n\r\n    for (const identity of identities) {\r\n      const parsedIdentity = SigningService.unwrapSshAgentIdentity(identity);\r\n      if (!parsedIdentity) continue;\r\n      if (!SUPPORTED_AGENT_KEY_TYPES.has(parsedIdentity.type)) continue;\r\n\r\n      // OpenSSH public key format: \"<type> <base64(blob)> [comment]\"\r\n      const publicKeyOpenSSH = `${parsedIdentity.type} ${parsedIdentity\r\n        .getPublicSSH()\r\n        .toString(\"base64\")}`;\r\n\r\n      try {\r\n        const parsed = parsePublicKey(publicKeyOpenSSH);\r\n        const fingerprint = await computeFingerprint(parsed.keyBytes);\r\n\r\n        candidates.push({\r\n          publicKeyOpenSSH,\r\n          fingerprint,\r\n          muxKeyType: parsed.type,\r\n        });\r\n      } catch (err) {\r\n        const message = err instanceof Error ? err.message : String(err);\r\n        log.debug(\"[SigningService] Skipping unsupported SSH agent key:\", message);\r\n      }\r\n    }\r\n\r\n    return candidates;\r\n  }\r\n\r\n  private pickPreferredAgentKey(candidates: AgentKeyCandidate[]): AgentKeyCandidate | null {\r\n    let best: AgentKeyCandidate | null = null;\r\n\r\n    for (const candidate of candidates) {\r\n      if (!best) {\r\n        best = candidate;\r\n        continue;\r\n      }\r\n      if (\r\n        AGENT_KEY_TYPE_PRIORITY[candidate.muxKeyType] < AGENT_KEY_TYPE_PRIORITY[best.muxKeyType]\r\n      ) {\r\n        best = candidate;\r\n      }\r\n    }\r\n\r\n    return best;\r\n  }\r\n\r\n  private async trySelectSshAgentKey(): Promise<{\r\n    selection: SigningKeySelection | null;\r\n    error: string | null;\r\n  }> {\r\n    const desiredPublicKeyRaw = process.env.MUX_SIGNING_PUBLIC_KEY?.trim();\r\n    const desiredFingerprint = process.env.MUX_SIGNING_KEY_FINGERPRINT?.trim();\r\n    const hasOverride = Boolean(desiredPublicKeyRaw?.length) || Boolean(desiredFingerprint?.length);\r\n\r\n    // If the ssh-agent module isn't available, skip agent key selection entirely\r\n    // so the service falls back to disk keys. But if the caller explicitly requested\r\n    // a specific key via env overrides, report an error — silently signing with a\r\n    // different disk key would produce signatures that fail verification.\r\n    if (!(await isSshAgentModuleAvailable())) {\r\n      if (hasOverride) {\r\n        return {\r\n          selection: null,\r\n          error:\r\n            \"SSH agent signing module is unavailable (possible dependency resolution issue). \" +\r\n            \"Cannot honor MUX_SIGNING_PUBLIC_KEY/MUX_SIGNING_KEY_FINGERPRINT — try updating mux.\",\r\n        };\r\n      }\r\n      return { selection: null, error: null };\r\n    }\r\n\r\n    const sshAuthSock = process.env.SSH_AUTH_SOCK?.trim();\r\n    if (!sshAuthSock) {\r\n      if (hasOverride) {\r\n        return {\r\n          selection: null,\r\n          error:\r\n            \"MUX_SIGNING_PUBLIC_KEY/MUX_SIGNING_KEY_FINGERPRINT is set but SSH_AUTH_SOCK is not set\",\r\n        };\r\n      }\r\n      return { selection: null, error: null };\r\n    }\r\n\r\n    let candidates: AgentKeyCandidate[];\r\n    try {\r\n      candidates = await this.listSshAgentKeyCandidates(sshAuthSock);\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : String(err);\r\n      log.info(\"[SigningService] Failed to query SSH agent:\", message);\r\n      if (hasOverride) {\r\n        return {\r\n          selection: null,\r\n          error: `Failed to query SSH agent (SSH_AUTH_SOCK=${sshAuthSock})`,\r\n        };\r\n      }\r\n      return { selection: null, error: null };\r\n    }\r\n\r\n    if (candidates.length === 0) {\r\n      if (hasOverride) {\r\n        return { selection: null, error: `No supported signing keys found in SSH agent` };\r\n      }\r\n      return { selection: null, error: null };\r\n    }\r\n\r\n    // Apply optional selection constraints for agent-backed keys.\r\n    if (hasOverride) {\r\n      let filtered = candidates;\r\n\r\n      if (desiredPublicKeyRaw) {\r\n        const normalized = normalizeOpenSshPublicKey(desiredPublicKeyRaw);\r\n        if (!normalized) {\r\n          return {\r\n            selection: null,\r\n            error:\r\n              \"MUX_SIGNING_PUBLIC_KEY must be an OpenSSH public key string (e.g. 'ssh-ed25519 AAAA...')\",\r\n          };\r\n        }\r\n\r\n        try {\r\n          parsePublicKey(normalized);\r\n        } catch {\r\n          return {\r\n            selection: null,\r\n            error: \"MUX_SIGNING_PUBLIC_KEY is not a supported SSH public key\",\r\n          };\r\n        }\r\n\r\n        filtered = filtered.filter((c) => c.publicKeyOpenSSH === normalized);\r\n      }\r\n\r\n      if (desiredFingerprint) {\r\n        filtered = filtered.filter((c) => c.fingerprint === desiredFingerprint);\r\n      }\r\n\r\n      if (filtered.length === 0) {\r\n        return {\r\n          selection: null,\r\n          error:\r\n            \"No SSH agent key matched MUX_SIGNING_PUBLIC_KEY/MUX_SIGNING_KEY_FINGERPRINT (check your SSH agent)\",\r\n        };\r\n      }\r\n\r\n      const chosen = filtered[0];\r\n      return {\r\n        selection: {\r\n          kind: \"ssh-agent\",\r\n          sshAuthSock,\r\n          publicKeyOpenSSH: chosen.publicKeyOpenSSH,\r\n          fingerprint: chosen.fingerprint,\r\n        },\r\n        error: null,\r\n      };\r\n    }\r\n\r\n    // Otherwise, pick a reasonable default.\r\n    const chosen = this.pickPreferredAgentKey(candidates);\r\n    if (!chosen) {\r\n      return { selection: null, error: null };\r\n    }\r\n\r\n    return {\r\n      selection: {\r\n        kind: \"ssh-agent\",\r\n        sshAuthSock,\r\n        publicKeyOpenSSH: chosen.publicKeyOpenSSH,\r\n        fingerprint: chosen.fingerprint,\r\n      },\r\n      error: null,\r\n    };\r\n  }\r\n\r\n  private async loadSigningKey(): Promise<SigningKeySelection | null> {\r\n    if (this.keyLoadAttempted) return this.signingKey;\r\n    if (this.keyLoadPromise) return this.keyLoadPromise;\r\n\r\n    this.keyLoadPromise = (async () => {\r\n      try {\r\n        const loaded = await this.doLoadSigningKey();\r\n        this.signingKey = loaded;\r\n        return loaded;\r\n      } catch (err) {\r\n        const message = err instanceof Error ? err.message : String(err);\r\n        log.warn(\"[SigningService] Unexpected key load error:\", message);\r\n        this.signingKey = null;\r\n        this.keyLoadError = \"Failed to load signing key\";\r\n        return null;\r\n      } finally {\r\n        this.keyLoadAttempted = true;\r\n        this.keyLoadPromise = null;\r\n      }\r\n    })();\r\n\r\n    return this.keyLoadPromise;\r\n  }\r\n\r\n  private async doLoadSigningKey(): Promise<SigningKeySelection | null> {\r\n    this.keyLoadError = null;\r\n    this.hasEncryptedKey = false;\r\n\r\n    // 1) Explicit disk key always wins.\r\n    const explicitPath = this.keyPaths[0];\r\n    if (explicitPath) {\r\n      const explicitDisk = this.tryLoadDiskKeyPair([explicitPath]);\r\n      if (explicitDisk) {\r\n        return { kind: \"disk\", keyPair: explicitDisk };\r\n      }\r\n    }\r\n\r\n    // 2) Prefer SSH-agent keys over default ~/.ssh/id_* keys.\r\n    const agentResult = await this.trySelectSshAgentKey();\r\n    if (agentResult.error) {\r\n      this.keyLoadError = agentResult.error;\r\n      return null;\r\n    }\r\n    if (agentResult.selection) {\r\n      return agentResult.selection;\r\n    }\r\n\r\n    // 3) Fall back to disk defaults.\r\n    const fallbackDisk = this.tryLoadDiskKeyPair(this.keyPaths.slice(1));\r\n    if (fallbackDisk) {\r\n      return { kind: \"disk\", keyPair: fallbackDisk };\r\n    }\r\n\r\n    // Set appropriate error based on what we found.\r\n    if (this.hasEncryptedKey) {\r\n      this.keyLoadError =\r\n        \"Signing key requires a passphrase. Encrypted key files are skipped unless loaded in your SSH agent (SSH_AUTH_SOCK).\";\r\n    } else {\r\n      this.keyLoadError =\r\n        \"No signing key found. Create ~/.mux/message_signing_key or ensure your SSH agent is running (SSH_AUTH_SOCK).\";\r\n    }\r\n    log.info(\"[SigningService]\", this.keyLoadError);\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Extract raw private key bytes from sshpk key for use with mux-md-client.\r\n   */\r\n  private extractPrivateKeyBytes(privateKey: sshpk.PrivateKey): Uint8Array {\r\n    // sshpk stores keys with a 'part' object lookup by key component name\r\n    // For Ed25519: part.k contains the 32-byte seed (private key)\r\n    // For ECDSA: part.d contains the private scalar\r\n    // The types are incomplete, so we use type assertions\r\n    const parts = privateKey.part as unknown as Record<string, { data: Buffer }>;\r\n    if (privateKey.type === \"ed25519\") {\r\n      const kPart = parts.k;\r\n      if (!kPart) throw new Error(\"Ed25519 key missing 'k' component\");\r\n      return new Uint8Array(kPart.data);\r\n    } else if (privateKey.type === \"ecdsa\") {\r\n      const dPart = parts.d;\r\n      if (!dPart) throw new Error(\"ECDSA key missing 'd' component\");\r\n      // sshpk may pad with leading zero byte for ASN.1 encoding; strip it\r\n      let data = dPart.data;\r\n      if (data[0] === 0 && data.length > 32) {\r\n        data = data.subarray(1);\r\n      }\r\n      return new Uint8Array(data);\r\n    }\r\n    throw new Error(`Unsupported key type: ${privateKey.type}`);\r\n  }\r\n\r\n  /**\r\n   * Detect identity: GitHub username via `gh auth status`.\r\n   * Result is cached after first call.\r\n   */\r\n  private async detectIdentity(): Promise<IdentityStatus> {\r\n    if (this.identityCache) return this.identityCache;\r\n    if (this.identityPromise) return this.identityPromise;\r\n\r\n    this.identityPromise = this.doDetectIdentity();\r\n    this.identityCache = await this.identityPromise;\r\n    this.identityPromise = null;\r\n\r\n    return this.identityCache;\r\n  }\r\n\r\n  private async doDetectIdentity(): Promise<IdentityStatus> {\r\n    let githubUser: string | null = null;\r\n    let error: string | null = null;\r\n\r\n    // Detect GitHub username via CLI\r\n    try {\r\n      using proc = execAsync(\"gh auth status 2>&1\");\r\n      const { stdout } = await proc.result;\r\n\r\n      const accountMatch = /account\\s+(\\S+)/i.exec(stdout);\r\n      if (accountMatch) {\r\n        githubUser = accountMatch[1];\r\n        log.info(\"[SigningService] Detected GitHub user:\", githubUser);\r\n      } else if (stdout.includes(\"Logged in\")) {\r\n        log.warn(\"[SigningService] gh auth status indicates logged in but couldn't parse username\");\r\n        error = \"Could not parse GitHub username from gh auth status\";\r\n      } else {\r\n        error = \"Not logged in to GitHub CLI (run: gh auth login)\";\r\n      }\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : String(err);\r\n      if (message.includes(\"command not found\") || message.includes(\"ENOENT\")) {\r\n        log.info(\"[SigningService] gh CLI not installed\");\r\n        error = \"GitHub CLI not installed (brew install gh)\";\r\n      } else {\r\n        log.info(\"[SigningService] gh auth status failed:\", message);\r\n        error = \"GitHub CLI error\";\r\n      }\r\n    }\r\n\r\n    return { githubUser, error };\r\n  }\r\n\r\n  /**\r\n   * Get signing capabilities - public key and identity info.\r\n   */\r\n  async getCapabilities(): Promise<SigningCapabilities> {\r\n    const signingKey = await this.loadSigningKey();\r\n\r\n    if (!signingKey) {\r\n      return {\r\n        publicKey: null,\r\n        githubUser: null,\r\n        error: this.keyLoadError\r\n          ? { message: this.keyLoadError, hasEncryptedKey: this.hasEncryptedKey }\r\n          : null,\r\n      };\r\n    }\r\n\r\n    const identity = await this.detectIdentity();\r\n\r\n    const publicKey =\r\n      signingKey.kind === \"disk\"\r\n        ? signingKey.keyPair.publicKeyOpenSSH\r\n        : signingKey.publicKeyOpenSSH;\r\n\r\n    return {\r\n      publicKey,\r\n      githubUser: identity.githubUser,\r\n      error: identity.error ? { message: identity.error, hasEncryptedKey: false } : null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Sign a mux.md share payload.\r\n   *\r\n   * Returns a mux.md SignatureEnvelope that can be embedded during upload.\r\n   *\r\n   * @throws Error if no signing key is available.\r\n   */\r\n  async signMessage(content: string): Promise<SignatureEnvelope> {\r\n    assert(typeof content === \"string\", \"signMessage: content must be a string\");\r\n\r\n    const signingKey = await this.loadSigningKey();\r\n    if (!signingKey) {\r\n      throw new Error(this.keyLoadError ?? \"No signing key available\");\r\n    }\r\n\r\n    const identity = await this.detectIdentity();\r\n    const githubUser = identity.githubUser ?? undefined;\r\n\r\n    const bytes = new TextEncoder().encode(content);\r\n\r\n    if (signingKey.kind === \"disk\") {\r\n      const envelope = await createSignatureEnvelope(\r\n        bytes,\r\n        signingKey.keyPair.privateKeyBytes,\r\n        signingKey.keyPair.publicKeyOpenSSH,\r\n        { githubUser }\r\n      );\r\n      assert(\r\n        normalizeOpenSshPublicKey(envelope.publicKey) ===\r\n          normalizeOpenSshPublicKey(signingKey.keyPair.publicKeyOpenSSH),\r\n        \"signMessage: disk signature returned unexpected public key\"\r\n      );\r\n      return envelope;\r\n    }\r\n\r\n    // eslint-disable-next-line no-restricted-syntax -- not circular-dep hiding; startup resilience\r\n    const sshAgentModule = await import(\"@coder/mux-md-client/ssh-agent\").catch((err: unknown) => {\r\n      const message = err instanceof Error ? err.message : String(err);\r\n      log.error(\"[SigningService] Failed to load ssh-agent signing module:\", message);\r\n      throw new Error(\r\n        \"SSH agent signing is unavailable — the @coder/mux-md-client/ssh-agent module failed to load. \" +\r\n          \"Try updating mux or falling back to disk key signing.\"\r\n      );\r\n    });\r\n\r\n    const envelope = await sshAgentModule.createSshAgentSignatureEnvelope(bytes, {\r\n      sshAuthSock: signingKey.sshAuthSock,\r\n      publicKey: signingKey.publicKeyOpenSSH,\r\n      fingerprint: signingKey.fingerprint,\r\n      githubUser,\r\n    });\r\n\r\n    assert(\r\n      normalizeOpenSshPublicKey(envelope.publicKey) ===\r\n        normalizeOpenSshPublicKey(signingKey.publicKeyOpenSSH),\r\n      \"signMessage: ssh-agent signature returned unexpected public key\"\r\n    );\r\n\r\n    return envelope;\r\n  }\r\n\r\n  /**\r\n   * Clear all cached state including key and identity.\r\n   * Allows re-detection after user creates a key or logs in.\r\n   */\r\n  clearIdentityCache(): void {\r\n    this.signingKey = null;\r\n    this.keyLoadAttempted = false;\r\n    this.keyLoadPromise = null;\r\n    this.keyLoadError = null;\r\n    this.hasEncryptedKey = false;\r\n\r\n    this.identityCache = null;\r\n    this.identityPromise = null;\r\n\r\n    log.info(\"[SigningService] Cleared key and identity cache\");\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nlet signingService: SigningService | null = null;\r\n\r\nexport function getSigningService(): SigningService {\r\n  signingService ??= new SigningService();\r\n  return signingService;\r\n}\r\n"]}