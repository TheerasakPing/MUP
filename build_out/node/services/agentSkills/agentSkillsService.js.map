{"version":3,"file":"agentSkillsService.js","sourceRoot":"","sources":["../../../../src/node/services/agentSkills/agentSkillsService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\r\nimport * as path from \"node:path\";\r\n\r\nimport type { Runtime } from \"@/node/runtime/Runtime\";\r\nimport { SSHRuntime } from \"@/node/runtime/SSHRuntime\";\r\nimport { shellQuote } from \"@/node/runtime/backgroundCommands\";\r\nimport { execBuffered, readFileString } from \"@/node/utils/runtime/helpers\";\r\n\r\nimport {\r\n  AgentSkillDescriptorSchema,\r\n  AgentSkillPackageSchema,\r\n  SkillNameSchema,\r\n} from \"@/common/orpc/schemas\";\r\nimport type {\r\n  AgentSkillDescriptor,\r\n  AgentSkillIssue,\r\n  AgentSkillPackage,\r\n  AgentSkillScope,\r\n  SkillName,\r\n} from \"@/common/types/agentSkill\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { validateFileSize } from \"@/node/services/tools/fileCommon\";\r\nimport { AgentSkillParseError, parseSkillMarkdown } from \"./parseSkillMarkdown\";\r\nimport { getBuiltInSkillByName, getBuiltInSkillDescriptors } from \"./builtInSkillDefinitions\";\r\n\r\nconst GLOBAL_SKILLS_ROOT = \"~/.mux/skills\";\r\n\r\nexport interface AgentSkillsRoots {\r\n  projectRoot: string;\r\n  globalRoot: string;\r\n}\r\n\r\nexport function getDefaultAgentSkillsRoots(\r\n  runtime: Runtime,\r\n  workspacePath: string\r\n): AgentSkillsRoots {\r\n  if (!workspacePath) {\r\n    throw new Error(\"getDefaultAgentSkillsRoots: workspacePath is required\");\r\n  }\r\n\r\n  return {\r\n    projectRoot: runtime.normalizePath(\".mux/skills\", workspacePath),\r\n    globalRoot: GLOBAL_SKILLS_ROOT,\r\n  };\r\n}\r\n\r\nfunction formatError(error: unknown): string {\r\n  return error instanceof Error ? error.message : String(error);\r\n}\r\n\r\nasync function listSkillDirectoriesFromLocalFs(root: string): Promise<string[]> {\r\n  try {\r\n    const entries = await fs.readdir(root, { withFileTypes: true });\r\n    // Include symlinks to directories â€” users commonly symlink skill dirs\r\n    return entries\r\n      .filter((entry) => entry.isDirectory() || entry.isSymbolicLink())\r\n      .map((entry) => entry.name);\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nasync function listSkillDirectoriesFromRuntime(\r\n  runtime: Runtime,\r\n  root: string,\r\n  options: { cwd: string }\r\n): Promise<string[]> {\r\n  if (!options.cwd) {\r\n    throw new Error(\"listSkillDirectoriesFromRuntime: options.cwd is required\");\r\n  }\r\n\r\n  const quotedRoot = shellQuote(root);\r\n  // -L follows symlinks so symlinked skill directories are discovered\r\n  const command =\r\n    `if [ -d ${quotedRoot} ]; then ` +\r\n    `find -L ${quotedRoot} -mindepth 1 -maxdepth 1 -type d -exec basename {} \\\\; ; ` +\r\n    `fi`;\r\n\r\n  const result = await execBuffered(runtime, command, { cwd: options.cwd, timeout: 10 });\r\n  if (result.exitCode !== 0) {\r\n    log.warn(`Failed to read skills directory ${root}: ${result.stderr || result.stdout}`);\r\n    return [];\r\n  }\r\n\r\n  return result.stdout\r\n    .split(\"\\n\")\r\n    .map((line) => line.trim())\r\n    .filter(Boolean);\r\n}\r\n\r\nasync function readSkillDescriptorFromDir(\r\n  runtime: Runtime,\r\n  skillDir: string,\r\n  directoryName: SkillName,\r\n  scope: AgentSkillScope,\r\n  options?: { invalidSkills?: AgentSkillIssue[] }\r\n): Promise<AgentSkillDescriptor | null> {\r\n  const skillFilePath = runtime.normalizePath(\"SKILL.md\", skillDir);\r\n\r\n  let stat;\r\n  try {\r\n    stat = await runtime.stat(skillFilePath);\r\n  } catch {\r\n    options?.invalidSkills?.push({\r\n      directoryName,\r\n      scope,\r\n      displayPath: skillFilePath,\r\n      message: \"SKILL.md is missing or unreadable.\",\r\n      hint: \"Create a SKILL.md file with YAML frontmatter (--- ... ---).\",\r\n    });\r\n    return null;\r\n  }\r\n\r\n  if (stat.isDirectory) {\r\n    options?.invalidSkills?.push({\r\n      directoryName,\r\n      scope,\r\n      displayPath: skillFilePath,\r\n      message: \"SKILL.md is a directory (expected a file).\",\r\n      hint: \"Replace SKILL.md with a regular file.\",\r\n    });\r\n    return null;\r\n  }\r\n\r\n  // Avoid reading very large files into memory (parseSkillMarkdown enforces the same limit).\r\n  const sizeValidation = validateFileSize(stat);\r\n  if (sizeValidation) {\r\n    log.warn(`Skipping skill '${directoryName}' (${scope}): ${sizeValidation.error}`);\r\n    options?.invalidSkills?.push({\r\n      directoryName,\r\n      scope,\r\n      displayPath: skillFilePath,\r\n      message: sizeValidation.error,\r\n      hint: \"Reduce SKILL.md size below 1MB.\",\r\n    });\r\n    return null;\r\n  }\r\n\r\n  let content: string;\r\n  try {\r\n    content = await readFileString(runtime, skillFilePath);\r\n  } catch (err) {\r\n    const message = formatError(err);\r\n    log.warn(`Failed to read SKILL.md for ${directoryName}: ${message}`);\r\n    options?.invalidSkills?.push({\r\n      directoryName,\r\n      scope,\r\n      displayPath: skillFilePath,\r\n      message: `Failed to read SKILL.md: ${message}`,\r\n      hint: \"Check file permissions and ensure the file is UTF-8 text.\",\r\n    });\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const parsed = parseSkillMarkdown({\r\n      content,\r\n      byteSize: stat.size,\r\n      directoryName,\r\n    });\r\n\r\n    const descriptor: AgentSkillDescriptor = {\r\n      name: parsed.frontmatter.name,\r\n      description: parsed.frontmatter.description,\r\n      scope,\r\n      advertise: parsed.frontmatter.advertise,\r\n    };\r\n\r\n    const validated = AgentSkillDescriptorSchema.safeParse(descriptor);\r\n    if (!validated.success) {\r\n      log.warn(`Invalid agent skill descriptor for ${directoryName}: ${validated.error.message}`);\r\n      options?.invalidSkills?.push({\r\n        directoryName,\r\n        scope,\r\n        displayPath: skillFilePath,\r\n        message: `Invalid agent skill descriptor: ${validated.error.message}`,\r\n        hint: \"Fix SKILL.md frontmatter fields to satisfy the skill schema.\",\r\n      });\r\n      return null;\r\n    }\r\n\r\n    return validated.data;\r\n  } catch (err) {\r\n    const message = err instanceof AgentSkillParseError ? err.message : formatError(err);\r\n    log.warn(`Skipping invalid skill '${directoryName}' (${scope}): ${message}`);\r\n    options?.invalidSkills?.push({\r\n      directoryName,\r\n      scope,\r\n      displayPath: skillFilePath,\r\n      message,\r\n      hint: \"Fix SKILL.md frontmatter (name + description) and ensure it matches the directory name.\",\r\n    });\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function discoverAgentSkills(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  options?: { roots?: AgentSkillsRoots }\r\n): Promise<AgentSkillDescriptor[]> {\r\n  if (!workspacePath) {\r\n    throw new Error(\"discoverAgentSkills: workspacePath is required\");\r\n  }\r\n\r\n  const roots = options?.roots ?? getDefaultAgentSkillsRoots(runtime, workspacePath);\r\n\r\n  const byName = new Map<SkillName, AgentSkillDescriptor>();\r\n\r\n  // Project skills take precedence over global.\r\n  const scans: Array<{ scope: AgentSkillScope; root: string }> = [\r\n    { scope: \"project\", root: roots.projectRoot },\r\n    { scope: \"global\", root: roots.globalRoot },\r\n  ];\r\n\r\n  for (const scan of scans) {\r\n    let resolvedRoot: string;\r\n    try {\r\n      resolvedRoot = await runtime.resolvePath(scan.root);\r\n    } catch (err) {\r\n      log.warn(`Failed to resolve skills root ${scan.root}: ${formatError(err)}`);\r\n      continue;\r\n    }\r\n\r\n    const directoryNames =\r\n      runtime instanceof SSHRuntime\r\n        ? await listSkillDirectoriesFromRuntime(runtime, resolvedRoot, { cwd: workspacePath })\r\n        : await listSkillDirectoriesFromLocalFs(resolvedRoot);\r\n\r\n    for (const directoryNameRaw of directoryNames) {\r\n      const nameParsed = SkillNameSchema.safeParse(directoryNameRaw);\r\n      if (!nameParsed.success) {\r\n        log.warn(`Skipping invalid skill directory name '${directoryNameRaw}' in ${resolvedRoot}`);\r\n        continue;\r\n      }\r\n\r\n      const directoryName = nameParsed.data;\r\n\r\n      if (scan.scope === \"global\" && byName.has(directoryName)) {\r\n        continue;\r\n      }\r\n\r\n      const skillDir = runtime.normalizePath(directoryName, resolvedRoot);\r\n      const descriptor = await readSkillDescriptorFromDir(\r\n        runtime,\r\n        skillDir,\r\n        directoryName,\r\n        scan.scope\r\n      );\r\n      if (!descriptor) continue;\r\n\r\n      // Precedence: project overwrites global.\r\n      byName.set(descriptor.name, descriptor);\r\n    }\r\n  }\r\n\r\n  // Add built-in skills (lowest precedence - only if not overridden by project/global)\r\n  for (const builtIn of getBuiltInSkillDescriptors()) {\r\n    if (!byName.has(builtIn.name)) {\r\n      byName.set(builtIn.name, builtIn);\r\n    }\r\n  }\r\n\r\n  return Array.from(byName.values()).sort((a, b) => a.name.localeCompare(b.name));\r\n}\r\n\r\nexport interface DiscoverAgentSkillsDiagnosticsResult {\r\n  skills: AgentSkillDescriptor[];\r\n  invalidSkills: AgentSkillIssue[];\r\n}\r\n\r\nexport async function discoverAgentSkillsDiagnostics(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  options?: { roots?: AgentSkillsRoots }\r\n): Promise<DiscoverAgentSkillsDiagnosticsResult> {\r\n  if (!workspacePath) {\r\n    throw new Error(\"discoverAgentSkillsDiagnostics: workspacePath is required\");\r\n  }\r\n\r\n  const roots = options?.roots ?? getDefaultAgentSkillsRoots(runtime, workspacePath);\r\n\r\n  const byName = new Map<SkillName, AgentSkillDescriptor>();\r\n  const invalidSkills: AgentSkillIssue[] = [];\r\n\r\n  // Project skills take precedence over global.\r\n  const scans: Array<{ scope: AgentSkillScope; root: string }> = [\r\n    { scope: \"project\", root: roots.projectRoot },\r\n    { scope: \"global\", root: roots.globalRoot },\r\n  ];\r\n\r\n  for (const scan of scans) {\r\n    let resolvedRoot: string;\r\n    try {\r\n      resolvedRoot = await runtime.resolvePath(scan.root);\r\n    } catch (err) {\r\n      log.warn(`Failed to resolve skills root ${scan.root}: ${formatError(err)}`);\r\n      continue;\r\n    }\r\n\r\n    const directoryNames =\r\n      runtime instanceof SSHRuntime\r\n        ? await listSkillDirectoriesFromRuntime(runtime, resolvedRoot, { cwd: workspacePath })\r\n        : await listSkillDirectoriesFromLocalFs(resolvedRoot);\r\n\r\n    for (const directoryNameRaw of directoryNames) {\r\n      const nameParsed = SkillNameSchema.safeParse(directoryNameRaw);\r\n      if (!nameParsed.success) {\r\n        log.warn(`Skipping invalid skill directory name '${directoryNameRaw}' in ${resolvedRoot}`);\r\n        invalidSkills.push({\r\n          directoryName: directoryNameRaw,\r\n          scope: scan.scope,\r\n          displayPath: runtime.normalizePath(directoryNameRaw, resolvedRoot),\r\n          message: `Invalid skill directory name '${directoryNameRaw}'.`,\r\n          hint: \"Rename the directory to kebab-case (lowercase letters/numbers/hyphens).\",\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const directoryName = nameParsed.data;\r\n\r\n      if (scan.scope === \"global\" && byName.has(directoryName)) {\r\n        continue;\r\n      }\r\n\r\n      const skillDir = runtime.normalizePath(directoryName, resolvedRoot);\r\n      const descriptor = await readSkillDescriptorFromDir(\r\n        runtime,\r\n        skillDir,\r\n        directoryName,\r\n        scan.scope,\r\n        {\r\n          invalidSkills,\r\n        }\r\n      );\r\n      if (!descriptor) continue;\r\n\r\n      // Precedence: project overwrites global.\r\n      byName.set(descriptor.name, descriptor);\r\n    }\r\n  }\r\n\r\n  // Add built-in skills (lowest precedence - only if not overridden by project/global)\r\n  for (const builtIn of getBuiltInSkillDescriptors()) {\r\n    if (!byName.has(builtIn.name)) {\r\n      byName.set(builtIn.name, builtIn);\r\n    }\r\n  }\r\n\r\n  const skills = Array.from(byName.values()).sort((a, b) => a.name.localeCompare(b.name));\r\n\r\n  const scopeOrder: Readonly<Record<AgentSkillScope, number>> = {\r\n    project: 0,\r\n    global: 1,\r\n    \"built-in\": 2,\r\n  };\r\n\r\n  invalidSkills.sort((a, b) => {\r\n    const scopeDiff = (scopeOrder[a.scope] ?? 0) - (scopeOrder[b.scope] ?? 0);\r\n    if (scopeDiff !== 0) return scopeDiff;\r\n    return a.directoryName.localeCompare(b.directoryName);\r\n  });\r\n\r\n  return {\r\n    skills,\r\n    invalidSkills,\r\n  };\r\n}\r\n\r\nexport interface ResolvedAgentSkill {\r\n  package: AgentSkillPackage;\r\n  skillDir: string;\r\n}\r\n\r\nasync function readAgentSkillFromDir(\r\n  runtime: Runtime,\r\n  skillDir: string,\r\n  directoryName: SkillName,\r\n  scope: AgentSkillScope\r\n): Promise<ResolvedAgentSkill> {\r\n  const skillFilePath = runtime.normalizePath(\"SKILL.md\", skillDir);\r\n\r\n  const stat = await runtime.stat(skillFilePath);\r\n  if (stat.isDirectory) {\r\n    throw new Error(`SKILL.md is not a file: ${skillFilePath}`);\r\n  }\r\n\r\n  const sizeValidation = validateFileSize(stat);\r\n  if (sizeValidation) {\r\n    throw new Error(sizeValidation.error);\r\n  }\r\n\r\n  const content = await readFileString(runtime, skillFilePath);\r\n  const parsed = parseSkillMarkdown({\r\n    content,\r\n    byteSize: stat.size,\r\n    directoryName,\r\n  });\r\n\r\n  const pkg: AgentSkillPackage = {\r\n    scope,\r\n    directoryName,\r\n    frontmatter: parsed.frontmatter,\r\n    body: parsed.body,\r\n  };\r\n\r\n  const validated = AgentSkillPackageSchema.safeParse(pkg);\r\n  if (!validated.success) {\r\n    throw new Error(\r\n      `Invalid agent skill package for '${directoryName}': ${validated.error.message}`\r\n    );\r\n  }\r\n\r\n  return {\r\n    package: validated.data,\r\n    skillDir,\r\n  };\r\n}\r\n\r\nexport async function readAgentSkill(\r\n  runtime: Runtime,\r\n  workspacePath: string,\r\n  name: SkillName,\r\n  options?: { roots?: AgentSkillsRoots }\r\n): Promise<ResolvedAgentSkill> {\r\n  if (!workspacePath) {\r\n    throw new Error(\"readAgentSkill: workspacePath is required\");\r\n  }\r\n\r\n  const roots = options?.roots ?? getDefaultAgentSkillsRoots(runtime, workspacePath);\r\n\r\n  // Project overrides global.\r\n  const candidates: Array<{ scope: AgentSkillScope; root: string }> = [\r\n    { scope: \"project\", root: roots.projectRoot },\r\n    { scope: \"global\", root: roots.globalRoot },\r\n  ];\r\n\r\n  for (const candidate of candidates) {\r\n    let resolvedRoot: string;\r\n    try {\r\n      resolvedRoot = await runtime.resolvePath(candidate.root);\r\n    } catch {\r\n      continue;\r\n    }\r\n\r\n    const skillDir = runtime.normalizePath(name, resolvedRoot);\r\n\r\n    try {\r\n      const stat = await runtime.stat(skillDir);\r\n      if (!stat.isDirectory) continue;\r\n\r\n      return await readAgentSkillFromDir(runtime, skillDir, name, candidate.scope);\r\n    } catch {\r\n      continue;\r\n    }\r\n  }\r\n\r\n  // Check built-in skills as fallback\r\n  const builtIn = getBuiltInSkillByName(name);\r\n  if (builtIn) {\r\n    return {\r\n      package: builtIn,\r\n      // Built-in skills don't have a real skillDir on disk.\r\n      // agent_skill_read_file handles built-in skills specially; this is a sentinel value.\r\n      skillDir: `<built-in:${name}>`,\r\n    };\r\n  }\r\n\r\n  throw new Error(`Agent skill not found: ${name}`);\r\n}\r\n\r\nfunction isAbsolutePathAny(filePath: string): boolean {\r\n  if (filePath.startsWith(\"/\") || filePath.startsWith(\"\\\\\")) return true;\r\n  // Windows drive letter paths (e.g., C:\\foo or C:/foo)\r\n  return /^[A-Za-z]:[\\\\/]/.test(filePath);\r\n}\r\n\r\nexport function resolveAgentSkillFilePath(\r\n  runtime: Runtime,\r\n  skillDir: string,\r\n  filePath: string\r\n): string {\r\n  if (!filePath) {\r\n    throw new Error(\"filePath is required\");\r\n  }\r\n\r\n  // Disallow absolute paths and home-relative paths.\r\n  if (isAbsolutePathAny(filePath) || filePath.startsWith(\"~\")) {\r\n    throw new Error(`Invalid filePath (must be relative to the skill directory): ${filePath}`);\r\n  }\r\n\r\n  const pathModule = runtime instanceof SSHRuntime ? path.posix : path;\r\n\r\n  // Resolve relative to skillDir and ensure it stays within skillDir.\r\n  const resolved = pathModule.resolve(skillDir, filePath);\r\n  const relative = pathModule.relative(skillDir, resolved);\r\n\r\n  if (relative === \"\" || relative === \".\") {\r\n    throw new Error(`Invalid filePath (expected a file, got directory): ${filePath}`);\r\n  }\r\n\r\n  if (relative.startsWith(\"..\") || pathModule.isAbsolute(relative)) {\r\n    throw new Error(`Invalid filePath (path traversal): ${filePath}`);\r\n  }\r\n\r\n  return resolved;\r\n}\r\n"]}