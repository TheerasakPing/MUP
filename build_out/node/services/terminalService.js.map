{"version":3,"file":"terminalService.js","sourceRoot":"","sources":["../../../src/node/services/terminalService.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from \"events\";\r\nimport { spawn } from \"child_process\";\r\nimport type { Config } from \"@/node/config\";\r\nimport type { PTYService } from \"@/node/services/ptyService\";\r\nimport type { TerminalWindowManager } from \"@/desktop/terminalWindowManager\";\r\nimport type {\r\n  TerminalSession,\r\n  TerminalCreateParams,\r\n  TerminalResizeParams,\r\n} from \"@/common/types/terminal\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\r\nimport { isSSHRuntime, isDockerRuntime, isDevcontainerRuntime } from \"@/common/types/runtime\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { isCommandAvailable, findAvailableCommand } from \"@/node/utils/commandDiscovery\";\r\nimport { Terminal } from \"@xterm/headless\";\r\nimport { SerializeAddon } from \"@xterm/addon-serialize\";\r\n\r\n/**\r\n * Configuration for opening a native terminal\r\n */\r\ntype NativeTerminalConfig =\r\n  | { type: \"local\"; workspacePath: string; command?: string }\r\n  | {\r\n      type: \"ssh\";\r\n      sshConfig: Extract<RuntimeConfig, { type: \"ssh\" }>;\r\n      remotePath: string;\r\n      command?: string;\r\n    };\r\n\r\nexport class TerminalService {\r\n  private readonly config: Config;\r\n  private readonly ptyService: PTYService;\r\n  private terminalWindowManager?: TerminalWindowManager;\r\n\r\n  // Event emitters for each session\r\n  private readonly outputEmitters = new Map<string, EventEmitter>();\r\n  private readonly exitEmitters = new Map<string, EventEmitter>();\r\n\r\n  // Headless terminals for maintaining parsed terminal state on the backend.\r\n  // On reconnect, we serialize the screen state (~4KB) instead of replaying raw output (~512KB).\r\n  private readonly headlessTerminals = new Map<string, Terminal>();\r\n  private readonly serializeAddons = new Map<string, SerializeAddon>();\r\n  private readonly headlessOnDataDisposables = new Map<string, { dispose: () => void }>();\r\n\r\n  constructor(config: Config, ptyService: PTYService) {\r\n    this.config = config;\r\n    this.ptyService = ptyService;\r\n  }\r\n\r\n  setTerminalWindowManager(manager: TerminalWindowManager) {\r\n    this.terminalWindowManager = manager;\r\n  }\r\n\r\n  /**\r\n   * Check if we're running in desktop mode (Electron) vs server mode (browser).\r\n   */\r\n  isDesktopMode(): boolean {\r\n    return !!this.terminalWindowManager;\r\n  }\r\n\r\n  async create(params: TerminalCreateParams): Promise<TerminalSession> {\r\n    try {\r\n      // 1. Resolve workspace\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const workspaceMetadata = allMetadata.find((w) => w.id === params.workspaceId);\r\n\r\n      if (!workspaceMetadata) {\r\n        throw new Error(`Workspace not found: ${params.workspaceId}`);\r\n      }\r\n\r\n      // Validate required fields before proceeding - projectPath is required for project-dir runtimes\r\n      if (!workspaceMetadata.projectPath) {\r\n        log.error(\"Workspace metadata missing projectPath\", {\r\n          workspaceId: params.workspaceId,\r\n          name: workspaceMetadata.name,\r\n          runtimeConfig: workspaceMetadata.runtimeConfig,\r\n          projectName: workspaceMetadata.projectName,\r\n          metadata: JSON.stringify(workspaceMetadata),\r\n        });\r\n        throw new Error(\r\n          `Workspace \"${workspaceMetadata.name}\" (${params.workspaceId}) is missing projectPath. ` +\r\n            `This may indicate a corrupted config or a workspace that was not properly associated with a project.`\r\n        );\r\n      }\r\n\r\n      // 2. Create runtime (pass workspace info for Docker container name derivation)\r\n      const runtime = createRuntime(workspaceMetadata.runtimeConfig, {\r\n        projectPath: workspaceMetadata.projectPath,\r\n        workspaceName: workspaceMetadata.name,\r\n      });\r\n\r\n      // 3. Compute workspace path\r\n      const workspacePath = runtime.getWorkspacePath(\r\n        workspaceMetadata.projectPath,\r\n        workspaceMetadata.name\r\n      );\r\n\r\n      // 4. Setup emitters and buffer\r\n      // We don't know the sessionId yet (PTYService generates it), but PTYService uses a callback.\r\n      // We need to capture the sessionId.\r\n      // Actually PTYService returns the session object with ID.\r\n      // But the callbacks are passed IN to createSession.\r\n      // So we need a way to map the callback to the future sessionId.\r\n\r\n      // Hack: We'll create a temporary object to hold the emitter/buffer and assign it to the map once we have the ID.\r\n      // But the callback runs *after* creation usually (when data comes).\r\n      // However, it's safer to create the emitter *before* passing callbacks if we can.\r\n      // We can't key it by sessionId yet.\r\n\r\n      let tempSessionId: string | null = null;\r\n      const localBuffer: string[] = [];\r\n\r\n      const onData = (data: string) => {\r\n        if (tempSessionId) {\r\n          this.emitOutput(tempSessionId, data);\r\n        } else {\r\n          // Buffer data if session ID is not yet available (race condition during creation)\r\n          localBuffer.push(data);\r\n        }\r\n      };\r\n\r\n      const onExit = (code: number) => {\r\n        if (tempSessionId) {\r\n          const emitter = this.exitEmitters.get(tempSessionId);\r\n          emitter?.emit(\"exit\", code);\r\n          this.cleanup(tempSessionId);\r\n        }\r\n      };\r\n\r\n      // 5. Create session\r\n      const session = await this.ptyService.createSession(\r\n        params,\r\n        runtime,\r\n        workspacePath,\r\n        onData,\r\n        onExit,\r\n        workspaceMetadata.runtimeConfig\r\n      );\r\n\r\n      tempSessionId = session.sessionId;\r\n\r\n      // Initialize emitters and headless terminal for state tracking\r\n      this.outputEmitters.set(session.sessionId, new EventEmitter());\r\n      this.exitEmitters.set(session.sessionId, new EventEmitter());\r\n\r\n      // Create headless terminal to maintain parsed state for reconnection\r\n      // allowProposedApi is required for SerializeAddon to access the buffer\r\n      const headless = new Terminal({\r\n        cols: params.cols,\r\n        rows: params.rows,\r\n        allowProposedApi: true,\r\n      });\r\n\r\n      // Respond to terminal device queries (DA1/DSR) on the backend.\r\n      //\r\n      // Some TUIs (e.g. Yazi) issue terminal probes like `\\x1b[0c` during startup and expect\r\n      // the terminal emulator to reply quickly. When the renderer isn't mounted yet (or IPC\r\n      // is slow), relying on the frontend alone can lead to timeouts.\r\n      const disposeHeadlessOnData = headless.onData((data: string) => {\r\n        if (!data) {\r\n          return;\r\n        }\r\n\r\n        try {\r\n          this.ptyService.sendInput(session.sessionId, data);\r\n        } catch (error) {\r\n          log.debug(\"[TerminalService] Failed to forward terminal response\", {\r\n            sessionId: session.sessionId,\r\n            error,\r\n          });\r\n        }\r\n      });\r\n      const serializeAddon = new SerializeAddon();\r\n      headless.loadAddon(serializeAddon);\r\n      this.headlessOnDataDisposables.set(session.sessionId, disposeHeadlessOnData);\r\n      this.headlessTerminals.set(session.sessionId, headless);\r\n      this.serializeAddons.set(session.sessionId, serializeAddon);\r\n\r\n      // Replay local buffer that arrived during creation\r\n      for (const data of localBuffer) {\r\n        this.emitOutput(session.sessionId, data);\r\n      }\r\n\r\n      // Send initial command if provided\r\n      if (params.initialCommand) {\r\n        this.sendInput(session.sessionId, `${params.initialCommand}\\n`);\r\n      }\r\n\r\n      return session;\r\n    } catch (err) {\r\n      log.error(\"Error creating terminal session:\", err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  close(sessionId: string): void {\r\n    try {\r\n      this.ptyService.closeSession(sessionId);\r\n      this.cleanup(sessionId);\r\n    } catch (err) {\r\n      log.error(\"Error closing terminal session:\", err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  resize(params: TerminalResizeParams): void {\r\n    try {\r\n      this.ptyService.resize(params);\r\n\r\n      // Also resize the headless terminal to keep state in sync\r\n      const headless = this.headlessTerminals.get(params.sessionId);\r\n      headless?.resize(params.cols, params.rows);\r\n    } catch (err) {\r\n      log.error(\"Error resizing terminal:\", err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  sendInput(sessionId: string, data: string): void {\r\n    try {\r\n      this.ptyService.sendInput(sessionId, data);\r\n    } catch (err) {\r\n      log.error(`Error sending input to terminal ${sessionId}:`, err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  async openWindow(workspaceId: string, sessionId?: string): Promise<void> {\r\n    try {\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const workspace = allMetadata.find((w) => w.id === workspaceId);\r\n\r\n      if (!workspace) {\r\n        throw new Error(`Workspace not found: ${workspaceId}`);\r\n      }\r\n\r\n      const runtimeConfig = workspace.runtimeConfig;\r\n      const isSSH = isSSHRuntime(runtimeConfig);\r\n      const isDesktop = !!this.terminalWindowManager;\r\n\r\n      if (isDesktop) {\r\n        log.info(\r\n          `Opening terminal window for workspace: ${workspaceId}${sessionId ? ` (session: ${sessionId})` : \"\"}`\r\n        );\r\n        await this.terminalWindowManager!.openTerminalWindow(workspaceId, sessionId);\r\n      } else {\r\n        log.info(\r\n          `Browser mode: terminal UI handled by browser for ${isSSH ? \"SSH\" : \"local\"} workspace: ${workspaceId}`\r\n        );\r\n      }\r\n    } catch (err) {\r\n      log.error(\"Error opening terminal window:\", err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  closeWindow(workspaceId: string): void {\r\n    try {\r\n      if (!this.terminalWindowManager) {\r\n        // Not an error in server mode, just no-op\r\n        return;\r\n      }\r\n      this.terminalWindowManager.closeTerminalWindow(workspaceId);\r\n    } catch (err) {\r\n      log.error(\"Error closing terminal window:\", err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Open the native system terminal for a workspace.\r\n   * Opens the user's preferred terminal emulator (Ghostty, Terminal.app, etc.)\r\n   * with the working directory set to the workspace path.\r\n   *\r\n   * For SSH workspaces, opens a terminal that SSHs into the remote host.\r\n   */\r\n  async openNative(workspaceId: string): Promise<void> {\r\n    try {\r\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n      const workspace = allMetadata.find((w) => w.id === workspaceId);\r\n\r\n      if (!workspace) {\r\n        throw new Error(`Workspace not found: ${workspaceId}`);\r\n      }\r\n\r\n      const runtimeConfig = workspace.runtimeConfig;\r\n\r\n      if (isSSHRuntime(runtimeConfig)) {\r\n        // SSH workspace - spawn local terminal that SSHs into remote host\r\n        await this.openNativeTerminal({\r\n          type: \"ssh\",\r\n          sshConfig: runtimeConfig,\r\n          remotePath: workspace.namedWorkspacePath,\r\n        });\r\n      } else if (isDockerRuntime(runtimeConfig)) {\r\n        // Docker workspace - spawn terminal that docker execs into container\r\n        const containerName = runtimeConfig.containerName;\r\n        if (!containerName) {\r\n          throw new Error(\"Docker container not initialized\");\r\n        }\r\n        await this.openNativeTerminal({\r\n          type: \"local\",\r\n          workspacePath: process.cwd(), // cwd doesn't matter, we're running docker exec\r\n          command: `docker exec -it ${containerName} /bin/sh -c \"cd ${workspace.namedWorkspacePath} && exec /bin/sh\"`,\r\n        });\r\n      } else if (isDevcontainerRuntime(runtimeConfig)) {\r\n        const quotedPath = JSON.stringify(workspace.namedWorkspacePath);\r\n        const configArg = runtimeConfig.configPath\r\n          ? ` --config ${JSON.stringify(runtimeConfig.configPath)}`\r\n          : \"\";\r\n        await this.openNativeTerminal({\r\n          type: \"local\",\r\n          workspacePath: workspace.namedWorkspacePath,\r\n          command: `devcontainer exec --workspace-folder ${quotedPath}${configArg} -- /bin/sh`,\r\n        });\r\n      } else {\r\n        // Local workspace - spawn terminal with cwd set\r\n        await this.openNativeTerminal({\r\n          type: \"local\",\r\n          workspacePath: workspace.namedWorkspacePath,\r\n        });\r\n      }\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : String(err);\r\n      log.error(`Failed to open native terminal: ${message}`);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Open a native terminal and run a command.\r\n   * Used for opening $EDITOR in a terminal when editing files.\r\n   * @param command The command to run\r\n   * @param workspacePath Optional directory to run the command in (defaults to cwd)\r\n   */\r\n  async openNativeWithCommand(command: string, workspacePath?: string): Promise<void> {\r\n    await this.openNativeTerminal({\r\n      type: \"local\",\r\n      workspacePath: workspacePath ?? process.cwd(),\r\n      command,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Open a native terminal (local or SSH) with platform-specific handling.\r\n   * This spawns the user's native terminal emulator, not a web-based terminal.\r\n   */\r\n  private async openNativeTerminal(config: NativeTerminalConfig): Promise<void> {\r\n    const isSSH = config.type === \"ssh\";\r\n\r\n    // Build SSH args if needed\r\n    let sshArgs: string[] | null = null;\r\n    if (isSSH) {\r\n      sshArgs = [];\r\n      // Add port if specified\r\n      if (config.sshConfig.port) {\r\n        sshArgs.push(\"-p\", String(config.sshConfig.port));\r\n      }\r\n      // Add identity file if specified\r\n      if (config.sshConfig.identityFile) {\r\n        sshArgs.push(\"-i\", config.sshConfig.identityFile);\r\n      }\r\n      // Force pseudo-terminal allocation\r\n      sshArgs.push(\"-t\");\r\n      // Add host\r\n      sshArgs.push(config.sshConfig.host);\r\n      // Add remote command to cd into directory and start shell\r\n      // Use single quotes to prevent local shell expansion\r\n      // exec $SHELL replaces the SSH process with the shell, avoiding nested processes\r\n      sshArgs.push(`cd '${config.remotePath.replace(/'/g, \"'\\\\''\")}' && exec $SHELL`);\r\n    }\r\n\r\n    const logPrefix = isSSH ? \"SSH terminal\" : \"terminal\";\r\n\r\n    if (process.platform === \"darwin\") {\r\n      await this.openNativeTerminalMacOS(config, sshArgs, logPrefix);\r\n    } else if (process.platform === \"win32\") {\r\n      this.openNativeTerminalWindows(config, sshArgs, logPrefix);\r\n    } else {\r\n      await this.openNativeTerminalLinux(config, sshArgs, logPrefix);\r\n    }\r\n  }\r\n\r\n  private async openNativeTerminalMacOS(\r\n    config: NativeTerminalConfig,\r\n    sshArgs: string[] | null,\r\n    logPrefix: string\r\n  ): Promise<void> {\r\n    const isSSH = config.type === \"ssh\";\r\n    const command = config.command;\r\n    const workspacePath = config.type === \"local\" ? config.workspacePath : config.remotePath;\r\n\r\n    // macOS - try Ghostty first, fallback to Terminal.app\r\n    const terminal = await findAvailableCommand([\"ghostty\", \"terminal\"]);\r\n    if (terminal === \"ghostty\") {\r\n      const cmd = \"open\";\r\n      let args: string[];\r\n      if (isSSH && sshArgs) {\r\n        // Ghostty: Use --command flag to run SSH\r\n        // Build the full SSH command as a single string\r\n        const sshCommand = [\"ssh\", ...sshArgs].join(\" \");\r\n        args = [\"-n\", \"-a\", \"Ghostty\", \"--args\", `--command=${sshCommand}`];\r\n      } else if (command) {\r\n        // Ghostty: Run command in workspace directory\r\n        // Wrap in sh -c to handle cd and command properly\r\n        const escapedPath = workspacePath.replace(/'/g, \"'\\\\''\");\r\n        const escapedCmd = command.replace(/'/g, \"'\\\\''\");\r\n        const fullCommand = `sh -c 'cd \"${escapedPath}\" && ${escapedCmd}'`;\r\n        args = [\"-n\", \"-a\", \"Ghostty\", \"--args\", `--command=${fullCommand}`];\r\n      } else {\r\n        // Ghostty: Pass workspacePath to 'open -a Ghostty' to avoid regressions\r\n        args = [\"-a\", \"Ghostty\", workspacePath];\r\n      }\r\n      log.info(`Opening ${logPrefix}: ${cmd} ${args.join(\" \")}`);\r\n      const child = spawn(cmd, args, {\r\n        detached: true,\r\n        stdio: \"ignore\",\r\n      });\r\n      child.unref();\r\n    } else {\r\n      // Terminal.app\r\n      const cmd = isSSH || command ? \"osascript\" : \"open\";\r\n      let args: string[];\r\n      if (isSSH && sshArgs) {\r\n        // Terminal.app: Use osascript with proper AppleScript structure\r\n        // Properly escape single quotes in args before wrapping in quotes\r\n        const sshCommand = `ssh ${sshArgs\r\n          .map((arg) => {\r\n            if (arg.includes(\" \") || arg.includes(\"'\")) {\r\n              // Escape single quotes by ending quote, adding escaped quote, starting quote again\r\n              return `'${arg.replace(/'/g, \"'\\\\''\")}'`;\r\n            }\r\n            return arg;\r\n          })\r\n          .join(\" \")}`;\r\n        // Escape double quotes for AppleScript string\r\n        const escapedCommand = sshCommand.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"');\r\n        const script = `tell application \"Terminal\"\\nactivate\\ndo script \"${escapedCommand}\"\\nend tell`;\r\n        args = [\"-e\", script];\r\n      } else if (command) {\r\n        // Terminal.app: Run command in workspace directory via AppleScript\r\n        const fullCommand = `cd \"${workspacePath}\" && ${command}`;\r\n        const escapedCommand = fullCommand.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"');\r\n        const script = `tell application \"Terminal\"\\nactivate\\ndo script \"${escapedCommand}\"\\nend tell`;\r\n        args = [\"-e\", script];\r\n      } else {\r\n        // Terminal.app opens in the directory when passed as argument\r\n        args = [\"-a\", \"Terminal\", workspacePath];\r\n      }\r\n      log.info(`Opening ${logPrefix}: ${cmd} ${args.join(\" \")}`);\r\n      const child = spawn(cmd, args, {\r\n        detached: true,\r\n        stdio: \"ignore\",\r\n      });\r\n      child.unref();\r\n    }\r\n  }\r\n\r\n  private openNativeTerminalWindows(\r\n    config: NativeTerminalConfig,\r\n    sshArgs: string[] | null,\r\n    logPrefix: string\r\n  ): void {\r\n    const isSSH = config.type === \"ssh\";\r\n    const command = config.command;\r\n    const workspacePath = config.type === \"local\" ? config.workspacePath : config.remotePath;\r\n\r\n    // Windows\r\n    const cmd = \"cmd\";\r\n    let args: string[];\r\n    if (isSSH && sshArgs) {\r\n      // Windows - use cmd to start ssh\r\n      args = [\"/c\", \"start\", \"cmd\", \"/K\", \"ssh\", ...sshArgs];\r\n    } else if (command) {\r\n      // Windows - cd to directory and run command\r\n      args = [\"/c\", \"start\", \"cmd\", \"/K\", `cd /D \"${workspacePath}\" && ${command}`];\r\n    } else {\r\n      // Windows - just cd to directory\r\n      args = [\"/c\", \"start\", \"cmd\", \"/K\", \"cd\", \"/D\", workspacePath];\r\n    }\r\n    log.info(`Opening ${logPrefix}: ${cmd} ${args.join(\" \")}`);\r\n    const child = spawn(cmd, args, {\r\n      detached: true,\r\n      shell: true,\r\n      stdio: \"ignore\",\r\n    });\r\n    child.unref();\r\n  }\r\n\r\n  private async openNativeTerminalLinux(\r\n    config: NativeTerminalConfig,\r\n    sshArgs: string[] | null,\r\n    logPrefix: string\r\n  ): Promise<void> {\r\n    const isSSH = config.type === \"ssh\";\r\n    const command = config.command;\r\n    const workspacePath = config.type === \"local\" ? config.workspacePath : config.remotePath;\r\n\r\n    // Linux - try terminal emulators in order of preference\r\n    let terminals: Array<{ cmd: string; args: string[]; cwd?: string }>;\r\n\r\n    if (isSSH && sshArgs) {\r\n      // x-terminal-emulator is checked first as it respects user's system-wide preference\r\n      terminals = [\r\n        { cmd: \"x-terminal-emulator\", args: [\"-e\", \"ssh\", ...sshArgs] },\r\n        { cmd: \"ghostty\", args: [\"ssh\", ...sshArgs] },\r\n        { cmd: \"alacritty\", args: [\"-e\", \"ssh\", ...sshArgs] },\r\n        { cmd: \"kitty\", args: [\"ssh\", ...sshArgs] },\r\n        { cmd: \"wezterm\", args: [\"start\", \"--\", \"ssh\", ...sshArgs] },\r\n        { cmd: \"gnome-terminal\", args: [\"--\", \"ssh\", ...sshArgs] },\r\n        { cmd: \"konsole\", args: [\"-e\", \"ssh\", ...sshArgs] },\r\n        { cmd: \"xfce4-terminal\", args: [\"-e\", `ssh ${sshArgs.join(\" \")}`] },\r\n        { cmd: \"xterm\", args: [\"-e\", \"ssh\", ...sshArgs] },\r\n      ];\r\n    } else if (command) {\r\n      // Run command in workspace directory\r\n      const fullCommand = `cd \"${workspacePath}\" && ${command}`;\r\n      terminals = [\r\n        { cmd: \"x-terminal-emulator\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"ghostty\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"alacritty\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"kitty\", args: [\"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"wezterm\", args: [\"start\", \"--\", \"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"gnome-terminal\", args: [\"--\", \"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"konsole\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\r\n        { cmd: \"xfce4-terminal\", args: [\"-e\", `sh -c '${fullCommand.replace(/'/g, \"'\\\\''\")}'`] },\r\n        { cmd: \"xterm\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\r\n      ];\r\n    } else {\r\n      // Just open terminal in directory\r\n      terminals = [\r\n        { cmd: \"x-terminal-emulator\", args: [], cwd: workspacePath },\r\n        { cmd: \"ghostty\", args: [\"--working-directory=\" + workspacePath] },\r\n        { cmd: \"alacritty\", args: [\"--working-directory\", workspacePath] },\r\n        { cmd: \"kitty\", args: [\"--directory\", workspacePath] },\r\n        { cmd: \"wezterm\", args: [\"start\", \"--cwd\", workspacePath] },\r\n        { cmd: \"gnome-terminal\", args: [\"--working-directory\", workspacePath] },\r\n        { cmd: \"konsole\", args: [\"--workdir\", workspacePath] },\r\n        { cmd: \"xfce4-terminal\", args: [\"--working-directory\", workspacePath] },\r\n        { cmd: \"xterm\", args: [], cwd: workspacePath },\r\n      ];\r\n    }\r\n\r\n    const availableTerminal = await this.findAvailableTerminal(terminals);\r\n\r\n    if (availableTerminal) {\r\n      const cwdInfo = availableTerminal.cwd ? ` (cwd: ${availableTerminal.cwd})` : \"\";\r\n      log.info(\r\n        `Opening ${logPrefix}: ${availableTerminal.cmd} ${availableTerminal.args.join(\" \")}${cwdInfo}`\r\n      );\r\n      const child = spawn(availableTerminal.cmd, availableTerminal.args, {\r\n        cwd: availableTerminal.cwd,\r\n        detached: true,\r\n        stdio: \"ignore\",\r\n      });\r\n      child.unref();\r\n    } else {\r\n      log.error(\"No terminal emulator found. Tried: \" + terminals.map((t) => t.cmd).join(\", \"));\r\n      throw new Error(\"No terminal emulator found\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the first available terminal emulator from a list\r\n   */\r\n  private async findAvailableTerminal(\r\n    terminals: Array<{ cmd: string; args: string[]; cwd?: string }>\r\n  ): Promise<{ cmd: string; args: string[]; cwd?: string } | null> {\r\n    for (const terminal of terminals) {\r\n      if (await isCommandAvailable(terminal.cmd)) {\r\n        return terminal;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  onOutput(sessionId: string, callback: (data: string) => void): () => void {\r\n    const emitter = this.outputEmitters.get(sessionId);\r\n    if (!emitter) {\r\n      // Session might not exist yet or closed.\r\n      // If it doesn't exist, we can't subscribe.\r\n      return () => {\r\n        /* no-op */\r\n      };\r\n    }\r\n\r\n    // Note: The attach stream yields screenState first, then live output.\r\n    // This subscription only provides live output from the point of subscription onward.\r\n\r\n    const handler = (data: string) => callback(data);\r\n    emitter.on(\"data\", handler);\r\n\r\n    return () => {\r\n      emitter.off(\"data\", handler);\r\n    };\r\n  }\r\n\r\n  onExit(sessionId: string, callback: (code: number) => void): () => void {\r\n    const emitter = this.exitEmitters.get(sessionId);\r\n    if (!emitter)\r\n      return () => {\r\n        /* no-op */\r\n      };\r\n\r\n    const handler = (code: number) => callback(code);\r\n    emitter.on(\"exit\", handler);\r\n\r\n    return () => {\r\n      emitter.off(\"exit\", handler);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get serialized screen state for a session.\r\n   * Called by frontend on reconnect to restore terminal view instantly (~4KB vs 512KB raw replay).\r\n   * Returns VT escape sequences that reconstruct the current screen state.\r\n   *\r\n   * Note: @xterm/addon-serialize v0.14+ automatically includes the alternate buffer switch\r\n   * sequence (\\x1b[?1049h) when the terminal is in alternate screen mode (htop, vim, etc.).\r\n   */\r\n  getScreenState(sessionId: string): string {\r\n    const addon = this.serializeAddons.get(sessionId);\r\n    return addon?.serialize() ?? \"\";\r\n  }\r\n\r\n  private emitOutput(sessionId: string, data: string) {\r\n    // Write to headless terminal to maintain parsed state (and generate device-query responses)\r\n    const headless = this.headlessTerminals.get(sessionId);\r\n    headless?.write(data);\r\n\r\n    const emitter = this.outputEmitters.get(sessionId);\r\n    if (emitter) {\r\n      emitter.emit(\"data\", data);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all session IDs for a workspace.\r\n   * Used by frontend to discover existing sessions to reattach to after reload.\r\n   */\r\n  getWorkspaceSessionIds(workspaceId: string): string[] {\r\n    return this.ptyService.getWorkspaceSessionIds(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Close all terminal sessions for a workspace.\r\n   * Called when a workspace is removed to prevent resource leaks.\r\n   */\r\n  closeWorkspaceSessions(workspaceId: string): void {\r\n    this.ptyService.closeWorkspaceSessions(workspaceId);\r\n  }\r\n\r\n  /**\r\n   * Close all terminal sessions.\r\n   * Called during server shutdown to prevent orphan PTY processes.\r\n   */\r\n  closeAllSessions(): void {\r\n    this.ptyService.closeAllSessions();\r\n  }\r\n\r\n  private cleanup(sessionId: string) {\r\n    const disposeHeadlessOnData = this.headlessOnDataDisposables.get(sessionId);\r\n    disposeHeadlessOnData?.dispose();\r\n    this.headlessOnDataDisposables.delete(sessionId);\r\n    this.outputEmitters.delete(sessionId);\r\n    this.exitEmitters.delete(sessionId);\r\n\r\n    // Dispose and clean up headless terminal\r\n    const headless = this.headlessTerminals.get(sessionId);\r\n    headless?.dispose();\r\n    this.headlessTerminals.delete(sessionId);\r\n    this.serializeAddons.delete(sessionId);\r\n  }\r\n}\r\n"]}