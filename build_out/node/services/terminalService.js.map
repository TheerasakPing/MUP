{"version":3,"file":"terminalService.js","sourceRoot":"","sources":["../../../src/node/services/terminalService.ts"],"names":[],"mappings":";;;AAAA,mCAAsC;AACtC,iDAAsC;AAStC,kEAA8D;AAE9D,oDAA8F;AAC9F,6CAA0C;AAC1C,oEAAyF;AACzF,8CAA2C;AAC3C,4DAAwD;AAcxD;IACmB,MAAM,CAAS;IACf,UAAU,CAAa;IAChC,qBAAqB,CAAyB;IAEtD,kCAAkC;IACjB,cAAc,GAAG,IAAI,GAAG,EAAwB,CAAC;IACjD,YAAY,GAAG,IAAI,GAAG,EAAwB,CAAC;IAEhE,2EAA2E;IAC3E,+FAA+F;IAC9E,iBAAiB,GAAG,IAAI,GAAG,EAAoB,CAAC;IAChD,eAAe,GAAG,IAAI,GAAG,EAA0B,CAAC;IACpD,yBAAyB,GAAG,IAAI,GAAG,EAAmC,CAAC;IAExF,YAAY,MAAc,EAAE,UAAsB,EAAE;QAClD,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;IAAA,CAC9B;IAED,wBAAwB,CAAC,OAA8B,EAAE;QACvD,IAAI,CAAC,qBAAqB,GAAG,OAAO,CAAC;IAAA,CACtC;IAED;;OAEG;IACH,aAAa,GAAY;QACvB,OAAO,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC;IAAA,CACrC;IAED,KAAK,CAAC,MAAM,CAAC,MAA4B,EAA4B;QACnE,IAAI,CAAC;YACH,uBAAuB;YACvB,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,uBAAuB,EAAE,CAAC;YAChE,MAAM,iBAAiB,GAAG,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,KAAK,MAAM,CAAC,WAAW,CAAC,CAAC;YAE/E,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBACvB,MAAM,IAAI,KAAK,CAAC,wBAAwB,MAAM,CAAC,WAAW,EAAE,CAAC,CAAC;YAChE,CAAC;YAED,gGAAgG;YAChG,IAAI,CAAC,iBAAiB,CAAC,WAAW,EAAE,CAAC;gBACnC,SAAG,CAAC,KAAK,CAAC,wCAAwC,EAAE;oBAClD,WAAW,EAAE,MAAM,CAAC,WAAW;oBAC/B,IAAI,EAAE,iBAAiB,CAAC,IAAI;oBAC5B,aAAa,EAAE,iBAAiB,CAAC,aAAa;oBAC9C,WAAW,EAAE,iBAAiB,CAAC,WAAW;oBAC1C,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC;iBAC5C,CAAC,CAAC;gBACH,MAAM,IAAI,KAAK,CACb,cAAc,iBAAiB,CAAC,IAAI,MAAM,MAAM,CAAC,WAAW,4BAA4B;oBACtF,sGAAsG,CACzG,CAAC;YACJ,CAAC;YAED,+EAA+E;YAC/E,MAAM,OAAO,GAAG,IAAA,8BAAa,EAAC,iBAAiB,CAAC,aAAa,EAAE;gBAC7D,WAAW,EAAE,iBAAiB,CAAC,WAAW;gBAC1C,aAAa,EAAE,iBAAiB,CAAC,IAAI;aACtC,CAAC,CAAC;YAEH,4BAA4B;YAC5B,MAAM,aAAa,GAAG,OAAO,CAAC,gBAAgB,CAC5C,iBAAiB,CAAC,WAAW,EAC7B,iBAAiB,CAAC,IAAI,CACvB,CAAC;YAEF,+BAA+B;YAC/B,6FAA6F;YAC7F,oCAAoC;YACpC,0DAA0D;YAC1D,oDAAoD;YACpD,gEAAgE;YAEhE,iHAAiH;YACjH,oEAAoE;YACpE,kFAAkF;YAClF,oCAAoC;YAEpC,IAAI,aAAa,GAAkB,IAAI,CAAC;YACxC,MAAM,WAAW,GAAa,EAAE,CAAC;YAEjC,MAAM,MAAM,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC;gBAC/B,IAAI,aAAa,EAAE,CAAC;oBAClB,IAAI,CAAC,UAAU,CAAC,aAAa,EAAE,IAAI,CAAC,CAAC;gBACvC,CAAC;qBAAM,CAAC;oBACN,kFAAkF;oBAClF,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACzB,CAAC;YAAA,CACF,CAAC;YAEF,MAAM,MAAM,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC;gBAC/B,IAAI,aAAa,EAAE,CAAC;oBAClB,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;oBACrD,OAAO,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;oBAC5B,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;gBAC9B,CAAC;YAAA,CACF,CAAC;YAEF,oBAAoB;YACpB,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,aAAa,CACjD,MAAM,EACN,OAAO,EACP,aAAa,EACb,MAAM,EACN,MAAM,EACN,iBAAiB,CAAC,aAAa,CAChC,CAAC;YAEF,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC;YAElC,+DAA+D;YAC/D,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,IAAI,qBAAY,EAAE,CAAC,CAAC;YAC/D,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,IAAI,qBAAY,EAAE,CAAC,CAAC;YAE7D,qEAAqE;YACrE,uEAAuE;YACvE,MAAM,QAAQ,GAAG,IAAI,mBAAQ,CAAC;gBAC5B,IAAI,EAAE,MAAM,CAAC,IAAI;gBACjB,IAAI,EAAE,MAAM,CAAC,IAAI;gBACjB,gBAAgB,EAAE,IAAI;aACvB,CAAC,CAAC;YAEH,+DAA+D;YAC/D,EAAE;YACF,uFAAuF;YACvF,sFAAsF;YACtF,gEAAgE;YAChE,MAAM,qBAAqB,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC,IAAY,EAAE,EAAE,CAAC;gBAC9D,IAAI,CAAC,IAAI,EAAE,CAAC;oBACV,OAAO;gBACT,CAAC;gBAED,IAAI,CAAC;oBACH,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,OAAO,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;gBACrD,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,SAAG,CAAC,KAAK,CAAC,uDAAuD,EAAE;wBACjE,SAAS,EAAE,OAAO,CAAC,SAAS;wBAC5B,KAAK;qBACN,CAAC,CAAC;gBACL,CAAC;YAAA,CACF,CAAC,CAAC;YACH,MAAM,cAAc,GAAG,IAAI,gCAAc,EAAE,CAAC;YAC5C,QAAQ,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;YACnC,IAAI,CAAC,yBAAyB,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,qBAAqB,CAAC,CAAC;YAC7E,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;YACxD,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,cAAc,CAAC,CAAC;YAE5D,mDAAmD;YACnD,KAAK,MAAM,IAAI,IAAI,WAAW,EAAE,CAAC;gBAC/B,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;YAC3C,CAAC;YAED,mCAAmC;YACnC,IAAI,MAAM,CAAC,cAAc,EAAE,CAAC;gBAC1B,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,SAAS,EAAE,GAAG,MAAM,CAAC,cAAc,IAAI,CAAC,CAAC;YAClE,CAAC;YAED,OAAO,OAAO,CAAC;QACjB,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,SAAG,CAAC,KAAK,CAAC,kCAAkC,EAAE,GAAG,CAAC,CAAC;YACnD,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED,KAAK,CAAC,SAAiB,EAAQ;QAC7B,IAAI,CAAC;YACH,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;YACxC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;QAC1B,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,SAAG,CAAC,KAAK,CAAC,iCAAiC,EAAE,GAAG,CAAC,CAAC;YAClD,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED,MAAM,CAAC,MAA4B,EAAQ;QACzC,IAAI,CAAC;YACH,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YAE/B,0DAA0D;YAC1D,MAAM,QAAQ,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;YAC9D,QAAQ,EAAE,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;QAC7C,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,SAAG,CAAC,KAAK,CAAC,0BAA0B,EAAE,GAAG,CAAC,CAAC;YAC3C,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED,SAAS,CAAC,SAAiB,EAAE,IAAY,EAAQ;QAC/C,IAAI,CAAC;YACH,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;QAC7C,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,SAAG,CAAC,KAAK,CAAC,mCAAmC,SAAS,GAAG,EAAE,GAAG,CAAC,CAAC;YAChE,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED,KAAK,CAAC,UAAU,CAAC,WAAmB,EAAE,SAAkB,EAAiB;QACvE,IAAI,CAAC;YACH,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,uBAAuB,EAAE,CAAC;YAChE,MAAM,SAAS,GAAG,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,KAAK,WAAW,CAAC,CAAC;YAEhE,IAAI,CAAC,SAAS,EAAE,CAAC;gBACf,MAAM,IAAI,KAAK,CAAC,wBAAwB,WAAW,EAAE,CAAC,CAAC;YACzD,CAAC;YAED,MAAM,aAAa,GAAG,SAAS,CAAC,aAAa,CAAC;YAC9C,MAAM,KAAK,GAAG,IAAA,sBAAY,EAAC,aAAa,CAAC,CAAC;YAC1C,MAAM,SAAS,GAAG,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC;YAE/C,IAAI,SAAS,EAAE,CAAC;gBACd,SAAG,CAAC,IAAI,CACN,0CAA0C,WAAW,GAAG,SAAS,CAAC,CAAC,CAAC,cAAc,SAAS,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CACtG,CAAC;gBACF,MAAM,IAAI,CAAC,qBAAsB,CAAC,kBAAkB,CAAC,WAAW,EAAE,SAAS,CAAC,CAAC;YAC/E,CAAC;iBAAM,CAAC;gBACN,SAAG,CAAC,IAAI,CACN,oDAAoD,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,eAAe,WAAW,EAAE,CACxG,CAAC;YACJ,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,SAAG,CAAC,KAAK,CAAC,gCAAgC,EAAE,GAAG,CAAC,CAAC;YACjD,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED,WAAW,CAAC,WAAmB,EAAQ;QACrC,IAAI,CAAC;YACH,IAAI,CAAC,IAAI,CAAC,qBAAqB,EAAE,CAAC;gBAChC,0CAA0C;gBAC1C,OAAO;YACT,CAAC;YACD,IAAI,CAAC,qBAAqB,CAAC,mBAAmB,CAAC,WAAW,CAAC,CAAC;QAC9D,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,SAAG,CAAC,KAAK,CAAC,gCAAgC,EAAE,GAAG,CAAC,CAAC;YACjD,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED;;;;;;OAMG;IACH,KAAK,CAAC,UAAU,CAAC,WAAmB,EAAiB;QACnD,IAAI,CAAC;YACH,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,uBAAuB,EAAE,CAAC;YAChE,MAAM,SAAS,GAAG,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,KAAK,WAAW,CAAC,CAAC;YAEhE,IAAI,CAAC,SAAS,EAAE,CAAC;gBACf,MAAM,IAAI,KAAK,CAAC,wBAAwB,WAAW,EAAE,CAAC,CAAC;YACzD,CAAC;YAED,MAAM,aAAa,GAAG,SAAS,CAAC,aAAa,CAAC;YAE9C,IAAI,IAAA,sBAAY,EAAC,aAAa,CAAC,EAAE,CAAC;gBAChC,kEAAkE;gBAClE,MAAM,IAAI,CAAC,kBAAkB,CAAC;oBAC5B,IAAI,EAAE,KAAK;oBACX,SAAS,EAAE,aAAa;oBACxB,UAAU,EAAE,SAAS,CAAC,kBAAkB;iBACzC,CAAC,CAAC;YACL,CAAC;iBAAM,IAAI,IAAA,yBAAe,EAAC,aAAa,CAAC,EAAE,CAAC;gBAC1C,qEAAqE;gBACrE,MAAM,aAAa,GAAG,aAAa,CAAC,aAAa,CAAC;gBAClD,IAAI,CAAC,aAAa,EAAE,CAAC;oBACnB,MAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;gBACtD,CAAC;gBACD,MAAM,IAAI,CAAC,kBAAkB,CAAC;oBAC5B,IAAI,EAAE,OAAO;oBACb,aAAa,EAAE,OAAO,CAAC,GAAG,EAAE,EAAE,gDAAgD;oBAC9E,OAAO,EAAE,mBAAmB,aAAa,mBAAmB,SAAS,CAAC,kBAAkB,mBAAmB;iBAC5G,CAAC,CAAC;YACL,CAAC;iBAAM,IAAI,IAAA,+BAAqB,EAAC,aAAa,CAAC,EAAE,CAAC;gBAChD,MAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,kBAAkB,CAAC,CAAC;gBAChE,MAAM,SAAS,GAAG,aAAa,CAAC,UAAU;oBACxC,CAAC,CAAC,aAAa,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,UAAU,CAAC,EAAE;oBACzD,CAAC,CAAC,EAAE,CAAC;gBACP,MAAM,IAAI,CAAC,kBAAkB,CAAC;oBAC5B,IAAI,EAAE,OAAO;oBACb,aAAa,EAAE,SAAS,CAAC,kBAAkB;oBAC3C,OAAO,EAAE,wCAAwC,UAAU,GAAG,SAAS,aAAa;iBACrF,CAAC,CAAC;YACL,CAAC;iBAAM,CAAC;gBACN,gDAAgD;gBAChD,MAAM,IAAI,CAAC,kBAAkB,CAAC;oBAC5B,IAAI,EAAE,OAAO;oBACb,aAAa,EAAE,SAAS,CAAC,kBAAkB;iBAC5C,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,MAAM,OAAO,GAAG,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;YACjE,SAAG,CAAC,KAAK,CAAC,mCAAmC,OAAO,EAAE,CAAC,CAAC;YACxD,MAAM,GAAG,CAAC;QACZ,CAAC;IAAA,CACF;IAED;;;;;OAKG;IACH,KAAK,CAAC,qBAAqB,CAAC,OAAe,EAAE,aAAsB,EAAiB;QAClF,MAAM,IAAI,CAAC,kBAAkB,CAAC;YAC5B,IAAI,EAAE,OAAO;YACb,aAAa,EAAE,aAAa,IAAI,OAAO,CAAC,GAAG,EAAE;YAC7C,OAAO;SACR,CAAC,CAAC;IAAA,CACJ;IAED;;;OAGG;IACK,KAAK,CAAC,kBAAkB,CAAC,MAA4B,EAAiB;QAC5E,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,KAAK,KAAK,CAAC;QAEpC,2BAA2B;QAC3B,IAAI,OAAO,GAAoB,IAAI,CAAC;QACpC,IAAI,KAAK,EAAE,CAAC;YACV,OAAO,GAAG,EAAE,CAAC;YACb,wBAAwB;YACxB,IAAI,MAAM,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC;gBAC1B,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC;YACpD,CAAC;YACD,iCAAiC;YACjC,IAAI,MAAM,CAAC,SAAS,CAAC,YAAY,EAAE,CAAC;gBAClC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC;YACpD,CAAC;YACD,mCAAmC;YACnC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACnB,WAAW;YACX,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YACpC,0DAA0D;YAC1D,qDAAqD;YACrD,iFAAiF;YACjF,OAAO,CAAC,IAAI,CAAC,OAAO,MAAM,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,kBAAkB,CAAC,CAAC;QAClF,CAAC;QAED,MAAM,SAAS,GAAG,KAAK,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,UAAU,CAAC;QAEtD,IAAI,OAAO,CAAC,QAAQ,KAAK,QAAQ,EAAE,CAAC;YAClC,MAAM,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC;QACjE,CAAC;aAAM,IAAI,OAAO,CAAC,QAAQ,KAAK,OAAO,EAAE,CAAC;YACxC,IAAI,CAAC,yBAAyB,CAAC,MAAM,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC;QAC7D,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC;QACjE,CAAC;IAAA,CACF;IAEO,KAAK,CAAC,uBAAuB,CACnC,MAA4B,EAC5B,OAAwB,EACxB,SAAiB,EACF;QACf,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,KAAK,KAAK,CAAC;QACpC,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;QAC/B,MAAM,aAAa,GAAG,MAAM,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,MAAM,CAAC,UAAU,CAAC;QAEzF,sDAAsD;QACtD,MAAM,QAAQ,GAAG,MAAM,IAAA,uCAAoB,EAAC,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC,CAAC;QACrE,IAAI,QAAQ,KAAK,SAAS,EAAE,CAAC;YAC3B,MAAM,GAAG,GAAG,MAAM,CAAC;YACnB,IAAI,IAAc,CAAC;YACnB,IAAI,KAAK,IAAI,OAAO,EAAE,CAAC;gBACrB,yCAAyC;gBACzC,gDAAgD;gBAChD,MAAM,UAAU,GAAG,CAAC,KAAK,EAAE,GAAG,OAAO,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACjD,IAAI,GAAG,CAAC,IAAI,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,EAAE,aAAa,UAAU,EAAE,CAAC,CAAC;YACtE,CAAC;iBAAM,IAAI,OAAO,EAAE,CAAC;gBACnB,8CAA8C;gBAC9C,kDAAkD;gBAClD,MAAM,WAAW,GAAG,aAAa,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;gBACzD,MAAM,UAAU,GAAG,OAAO,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;gBAClD,MAAM,WAAW,GAAG,cAAc,WAAW,QAAQ,UAAU,GAAG,CAAC;gBACnE,IAAI,GAAG,CAAC,IAAI,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,EAAE,aAAa,WAAW,EAAE,CAAC,CAAC;YACvE,CAAC;iBAAM,CAAC;gBACN,wEAAwE;gBACxE,IAAI,GAAG,CAAC,IAAI,EAAE,SAAS,EAAE,aAAa,CAAC,CAAC;YAC1C,CAAC;YACD,SAAG,CAAC,IAAI,CAAC,WAAW,SAAS,KAAK,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAC3D,MAAM,KAAK,GAAG,IAAA,qBAAK,EAAC,GAAG,EAAE,IAAI,EAAE;gBAC7B,QAAQ,EAAE,IAAI;gBACd,KAAK,EAAE,QAAQ;aAChB,CAAC,CAAC;YACH,KAAK,CAAC,KAAK,EAAE,CAAC;QAChB,CAAC;aAAM,CAAC;YACN,eAAe;YACf,MAAM,GAAG,GAAG,KAAK,IAAI,OAAO,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,MAAM,CAAC;YACpD,IAAI,IAAc,CAAC;YACnB,IAAI,KAAK,IAAI,OAAO,EAAE,CAAC;gBACrB,gEAAgE;gBAChE,kEAAkE;gBAClE,MAAM,UAAU,GAAG,OAAO,OAAO;qBAC9B,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;oBACZ,IAAI,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;wBAC3C,mFAAmF;wBACnF,OAAO,IAAI,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,GAAG,CAAC;oBAC3C,CAAC;oBACD,OAAO,GAAG,CAAC;gBAAA,CACZ,CAAC;qBACD,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC;gBACf,8CAA8C;gBAC9C,MAAM,cAAc,GAAG,UAAU,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;gBAC9E,MAAM,MAAM,GAAG,qDAAqD,cAAc,aAAa,CAAC;gBAChG,IAAI,GAAG,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;YACxB,CAAC;iBAAM,IAAI,OAAO,EAAE,CAAC;gBACnB,mEAAmE;gBACnE,MAAM,WAAW,GAAG,OAAO,aAAa,QAAQ,OAAO,EAAE,CAAC;gBAC1D,MAAM,cAAc,GAAG,WAAW,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;gBAC/E,MAAM,MAAM,GAAG,qDAAqD,cAAc,aAAa,CAAC;gBAChG,IAAI,GAAG,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;YACxB,CAAC;iBAAM,CAAC;gBACN,8DAA8D;gBAC9D,IAAI,GAAG,CAAC,IAAI,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC;YAC3C,CAAC;YACD,SAAG,CAAC,IAAI,CAAC,WAAW,SAAS,KAAK,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAC3D,MAAM,KAAK,GAAG,IAAA,qBAAK,EAAC,GAAG,EAAE,IAAI,EAAE;gBAC7B,QAAQ,EAAE,IAAI;gBACd,KAAK,EAAE,QAAQ;aAChB,CAAC,CAAC;YACH,KAAK,CAAC,KAAK,EAAE,CAAC;QAChB,CAAC;IAAA,CACF;IAEO,yBAAyB,CAC/B,MAA4B,EAC5B,OAAwB,EACxB,SAAiB,EACX;QACN,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,KAAK,KAAK,CAAC;QACpC,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;QAC/B,MAAM,aAAa,GAAG,MAAM,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,MAAM,CAAC,UAAU,CAAC;QAEzF,UAAU;QACV,MAAM,GAAG,GAAG,KAAK,CAAC;QAClB,IAAI,IAAc,CAAC;QACnB,IAAI,KAAK,IAAI,OAAO,EAAE,CAAC;YACrB,iCAAiC;YACjC,IAAI,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,CAAC;QACzD,CAAC;aAAM,IAAI,OAAO,EAAE,CAAC;YACnB,4CAA4C;YAC5C,IAAI,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,UAAU,aAAa,QAAQ,OAAO,EAAE,CAAC,CAAC;QAChF,CAAC;aAAM,CAAC;YACN,iCAAiC;YACjC,IAAI,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,aAAa,CAAC,CAAC;QACjE,CAAC;QACD,SAAG,CAAC,IAAI,CAAC,WAAW,SAAS,KAAK,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QAC3D,MAAM,KAAK,GAAG,IAAA,qBAAK,EAAC,GAAG,EAAE,IAAI,EAAE;YAC7B,QAAQ,EAAE,IAAI;YACd,KAAK,EAAE,IAAI;YACX,KAAK,EAAE,QAAQ;SAChB,CAAC,CAAC;QACH,KAAK,CAAC,KAAK,EAAE,CAAC;IAAA,CACf;IAEO,KAAK,CAAC,uBAAuB,CACnC,MAA4B,EAC5B,OAAwB,EACxB,SAAiB,EACF;QACf,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,KAAK,KAAK,CAAC;QACpC,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;QAC/B,MAAM,aAAa,GAAG,MAAM,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,MAAM,CAAC,UAAU,CAAC;QAEzF,wDAAwD;QACxD,IAAI,SAA+D,CAAC;QAEpE,IAAI,KAAK,IAAI,OAAO,EAAE,CAAC;YACrB,oFAAoF;YACpF,SAAS,GAAG;gBACV,EAAE,GAAG,EAAE,qBAAqB,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBAC/D,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBAC7C,EAAE,GAAG,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBACrD,EAAE,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBAC3C,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBAC5D,EAAE,GAAG,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBAC1D,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;gBACnD,EAAE,GAAG,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,OAAO,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE;gBACnE,EAAE,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,GAAG,OAAO,CAAC,EAAE;aAClD,CAAC;QACJ,CAAC;aAAM,IAAI,OAAO,EAAE,CAAC;YACnB,qCAAqC;YACrC,MAAM,WAAW,GAAG,OAAO,aAAa,QAAQ,OAAO,EAAE,CAAC;YAC1D,SAAS,GAAG;gBACV,EAAE,GAAG,EAAE,qBAAqB,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBACrE,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBACzD,EAAE,GAAG,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBAC3D,EAAE,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBACjD,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBAClE,EAAE,GAAG,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBAChE,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;gBACzD,EAAE,GAAG,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,UAAU,WAAW,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,GAAG,CAAC,EAAE;gBACxF,EAAE,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,WAAW,CAAC,EAAE;aACxD,CAAC;QACJ,CAAC;aAAM,CAAC;YACN,kCAAkC;YAClC,SAAS,GAAG;gBACV,EAAE,GAAG,EAAE,qBAAqB,EAAE,IAAI,EAAE,EAAE,EAAE,GAAG,EAAE,aAAa,EAAE;gBAC5D,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,sBAAsB,GAAG,aAAa,CAAC,EAAE;gBAClE,EAAE,GAAG,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,qBAAqB,EAAE,aAAa,CAAC,EAAE;gBAClE,EAAE,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,aAAa,EAAE,aAAa,CAAC,EAAE;gBACtD,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,OAAO,EAAE,OAAO,EAAE,aAAa,CAAC,EAAE;gBAC3D,EAAE,GAAG,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,qBAAqB,EAAE,aAAa,CAAC,EAAE;gBACvE,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,WAAW,EAAE,aAAa,CAAC,EAAE;gBACtD,EAAE,GAAG,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,qBAAqB,EAAE,aAAa,CAAC,EAAE;gBACvE,EAAE,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,EAAE,EAAE,GAAG,EAAE,aAAa,EAAE;aAC/C,CAAC;QACJ,CAAC;QAED,MAAM,iBAAiB,GAAG,MAAM,IAAI,CAAC,qBAAqB,CAAC,SAAS,CAAC,CAAC;QAEtE,IAAI,iBAAiB,EAAE,CAAC;YACtB,MAAM,OAAO,GAAG,iBAAiB,CAAC,GAAG,CAAC,CAAC,CAAC,UAAU,iBAAiB,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC;YAChF,SAAG,CAAC,IAAI,CACN,WAAW,SAAS,KAAK,iBAAiB,CAAC,GAAG,IAAI,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,OAAO,EAAE,CAC/F,CAAC;YACF,MAAM,KAAK,GAAG,IAAA,qBAAK,EAAC,iBAAiB,CAAC,GAAG,EAAE,iBAAiB,CAAC,IAAI,EAAE;gBACjE,GAAG,EAAE,iBAAiB,CAAC,GAAG;gBAC1B,QAAQ,EAAE,IAAI;gBACd,KAAK,EAAE,QAAQ;aAChB,CAAC,CAAC;YACH,KAAK,CAAC,KAAK,EAAE,CAAC;QAChB,CAAC;aAAM,CAAC;YACN,SAAG,CAAC,KAAK,CAAC,qCAAqC,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YAC1F,MAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;QAChD,CAAC;IAAA,CACF;IAED;;OAEG;IACK,KAAK,CAAC,qBAAqB,CACjC,SAA+D,EACA;QAC/D,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE,CAAC;YACjC,IAAI,MAAM,IAAA,qCAAkB,EAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;gBAC3C,OAAO,QAAQ,CAAC;YAClB,CAAC;QACH,CAAC;QACD,OAAO,IAAI,CAAC;IAAA,CACb;IAED,QAAQ,CAAC,SAAiB,EAAE,QAAgC,EAAc;QACxE,MAAM,OAAO,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACnD,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,yCAAyC;YACzC,2CAA2C;YAC3C,OAAO,GAAG,EAAE,CAAC;gBACX,WAAW;YADC,CAEb,CAAC;QACJ,CAAC;QAED,sEAAsE;QACtE,qFAAqF;QAErF,MAAM,OAAO,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACjD,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;QAE5B,OAAO,GAAG,EAAE,CAAC;YACX,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;QAAA,CAC9B,CAAC;IAAA,CACH;IAED,MAAM,CAAC,SAAiB,EAAE,QAAgC,EAAc;QACtE,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACjD,IAAI,CAAC,OAAO;YACV,OAAO,GAAG,EAAE,CAAC;gBACX,WAAW;YADC,CAEb,CAAC;QAEJ,MAAM,OAAO,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACjD,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;QAE5B,OAAO,GAAG,EAAE,CAAC;YACX,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;QAAA,CAC9B,CAAC;IAAA,CACH;IAED;;;;;;;OAOG;IACH,cAAc,CAAC,SAAiB,EAAU;QACxC,MAAM,KAAK,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QAClD,OAAO,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;IAAA,CACjC;IAEO,UAAU,CAAC,SAAiB,EAAE,IAAY,EAAE;QAClD,4FAA4F;QAC5F,MAAM,QAAQ,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACvD,QAAQ,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC;QAEtB,MAAM,OAAO,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACnD,IAAI,OAAO,EAAE,CAAC;YACZ,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;QAC7B,CAAC;IAAA,CACF;IAED;;;OAGG;IACH,sBAAsB,CAAC,WAAmB,EAAY;QACpD,OAAO,IAAI,CAAC,UAAU,CAAC,sBAAsB,CAAC,WAAW,CAAC,CAAC;IAAA,CAC5D;IAED;;;OAGG;IACH,sBAAsB,CAAC,WAAmB,EAAQ;QAChD,IAAI,CAAC,UAAU,CAAC,sBAAsB,CAAC,WAAW,CAAC,CAAC;IAAA,CACrD;IAED;;;OAGG;IACH,gBAAgB,GAAS;QACvB,IAAI,CAAC,UAAU,CAAC,gBAAgB,EAAE,CAAC;IAAA,CACpC;IAEO,OAAO,CAAC,SAAiB,EAAE;QACjC,MAAM,qBAAqB,GAAG,IAAI,CAAC,yBAAyB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QAC5E,qBAAqB,EAAE,OAAO,EAAE,CAAC;QACjC,IAAI,CAAC,yBAAyB,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QACjD,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QACtC,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QAEpC,yCAAyC;QACzC,MAAM,QAAQ,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACvD,QAAQ,EAAE,OAAO,EAAE,CAAC;QACpB,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QACzC,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;IAAA,CACxC;CACF","sourcesContent":["import { EventEmitter } from \"events\";\nimport { spawn } from \"child_process\";\nimport type { Config } from \"@/node/config\";\nimport type { PTYService } from \"@/node/services/ptyService\";\nimport type { TerminalWindowManager } from \"@/desktop/terminalWindowManager\";\nimport type {\n  TerminalSession,\n  TerminalCreateParams,\n  TerminalResizeParams,\n} from \"@/common/types/terminal\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\nimport { isSSHRuntime, isDockerRuntime, isDevcontainerRuntime } from \"@/common/types/runtime\";\nimport { log } from \"@/node/services/log\";\nimport { isCommandAvailable, findAvailableCommand } from \"@/node/utils/commandDiscovery\";\nimport { Terminal } from \"@xterm/headless\";\nimport { SerializeAddon } from \"@xterm/addon-serialize\";\n\n/**\n * Configuration for opening a native terminal\n */\ntype NativeTerminalConfig =\n  | { type: \"local\"; workspacePath: string; command?: string }\n  | {\n      type: \"ssh\";\n      sshConfig: Extract<RuntimeConfig, { type: \"ssh\" }>;\n      remotePath: string;\n      command?: string;\n    };\n\nexport class TerminalService {\n  private readonly config: Config;\n  private readonly ptyService: PTYService;\n  private terminalWindowManager?: TerminalWindowManager;\n\n  // Event emitters for each session\n  private readonly outputEmitters = new Map<string, EventEmitter>();\n  private readonly exitEmitters = new Map<string, EventEmitter>();\n\n  // Headless terminals for maintaining parsed terminal state on the backend.\n  // On reconnect, we serialize the screen state (~4KB) instead of replaying raw output (~512KB).\n  private readonly headlessTerminals = new Map<string, Terminal>();\n  private readonly serializeAddons = new Map<string, SerializeAddon>();\n  private readonly headlessOnDataDisposables = new Map<string, { dispose: () => void }>();\n\n  constructor(config: Config, ptyService: PTYService) {\n    this.config = config;\n    this.ptyService = ptyService;\n  }\n\n  setTerminalWindowManager(manager: TerminalWindowManager) {\n    this.terminalWindowManager = manager;\n  }\n\n  /**\n   * Check if we're running in desktop mode (Electron) vs server mode (browser).\n   */\n  isDesktopMode(): boolean {\n    return !!this.terminalWindowManager;\n  }\n\n  async create(params: TerminalCreateParams): Promise<TerminalSession> {\n    try {\n      // 1. Resolve workspace\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\n      const workspaceMetadata = allMetadata.find((w) => w.id === params.workspaceId);\n\n      if (!workspaceMetadata) {\n        throw new Error(`Workspace not found: ${params.workspaceId}`);\n      }\n\n      // Validate required fields before proceeding - projectPath is required for project-dir runtimes\n      if (!workspaceMetadata.projectPath) {\n        log.error(\"Workspace metadata missing projectPath\", {\n          workspaceId: params.workspaceId,\n          name: workspaceMetadata.name,\n          runtimeConfig: workspaceMetadata.runtimeConfig,\n          projectName: workspaceMetadata.projectName,\n          metadata: JSON.stringify(workspaceMetadata),\n        });\n        throw new Error(\n          `Workspace \"${workspaceMetadata.name}\" (${params.workspaceId}) is missing projectPath. ` +\n            `This may indicate a corrupted config or a workspace that was not properly associated with a project.`\n        );\n      }\n\n      // 2. Create runtime (pass workspace info for Docker container name derivation)\n      const runtime = createRuntime(workspaceMetadata.runtimeConfig, {\n        projectPath: workspaceMetadata.projectPath,\n        workspaceName: workspaceMetadata.name,\n      });\n\n      // 3. Compute workspace path\n      const workspacePath = runtime.getWorkspacePath(\n        workspaceMetadata.projectPath,\n        workspaceMetadata.name\n      );\n\n      // 4. Setup emitters and buffer\n      // We don't know the sessionId yet (PTYService generates it), but PTYService uses a callback.\n      // We need to capture the sessionId.\n      // Actually PTYService returns the session object with ID.\n      // But the callbacks are passed IN to createSession.\n      // So we need a way to map the callback to the future sessionId.\n\n      // Hack: We'll create a temporary object to hold the emitter/buffer and assign it to the map once we have the ID.\n      // But the callback runs *after* creation usually (when data comes).\n      // However, it's safer to create the emitter *before* passing callbacks if we can.\n      // We can't key it by sessionId yet.\n\n      let tempSessionId: string | null = null;\n      const localBuffer: string[] = [];\n\n      const onData = (data: string) => {\n        if (tempSessionId) {\n          this.emitOutput(tempSessionId, data);\n        } else {\n          // Buffer data if session ID is not yet available (race condition during creation)\n          localBuffer.push(data);\n        }\n      };\n\n      const onExit = (code: number) => {\n        if (tempSessionId) {\n          const emitter = this.exitEmitters.get(tempSessionId);\n          emitter?.emit(\"exit\", code);\n          this.cleanup(tempSessionId);\n        }\n      };\n\n      // 5. Create session\n      const session = await this.ptyService.createSession(\n        params,\n        runtime,\n        workspacePath,\n        onData,\n        onExit,\n        workspaceMetadata.runtimeConfig\n      );\n\n      tempSessionId = session.sessionId;\n\n      // Initialize emitters and headless terminal for state tracking\n      this.outputEmitters.set(session.sessionId, new EventEmitter());\n      this.exitEmitters.set(session.sessionId, new EventEmitter());\n\n      // Create headless terminal to maintain parsed state for reconnection\n      // allowProposedApi is required for SerializeAddon to access the buffer\n      const headless = new Terminal({\n        cols: params.cols,\n        rows: params.rows,\n        allowProposedApi: true,\n      });\n\n      // Respond to terminal device queries (DA1/DSR) on the backend.\n      //\n      // Some TUIs (e.g. Yazi) issue terminal probes like `\\x1b[0c` during startup and expect\n      // the terminal emulator to reply quickly. When the renderer isn't mounted yet (or IPC\n      // is slow), relying on the frontend alone can lead to timeouts.\n      const disposeHeadlessOnData = headless.onData((data: string) => {\n        if (!data) {\n          return;\n        }\n\n        try {\n          this.ptyService.sendInput(session.sessionId, data);\n        } catch (error) {\n          log.debug(\"[TerminalService] Failed to forward terminal response\", {\n            sessionId: session.sessionId,\n            error,\n          });\n        }\n      });\n      const serializeAddon = new SerializeAddon();\n      headless.loadAddon(serializeAddon);\n      this.headlessOnDataDisposables.set(session.sessionId, disposeHeadlessOnData);\n      this.headlessTerminals.set(session.sessionId, headless);\n      this.serializeAddons.set(session.sessionId, serializeAddon);\n\n      // Replay local buffer that arrived during creation\n      for (const data of localBuffer) {\n        this.emitOutput(session.sessionId, data);\n      }\n\n      // Send initial command if provided\n      if (params.initialCommand) {\n        this.sendInput(session.sessionId, `${params.initialCommand}\\n`);\n      }\n\n      return session;\n    } catch (err) {\n      log.error(\"Error creating terminal session:\", err);\n      throw err;\n    }\n  }\n\n  close(sessionId: string): void {\n    try {\n      this.ptyService.closeSession(sessionId);\n      this.cleanup(sessionId);\n    } catch (err) {\n      log.error(\"Error closing terminal session:\", err);\n      throw err;\n    }\n  }\n\n  resize(params: TerminalResizeParams): void {\n    try {\n      this.ptyService.resize(params);\n\n      // Also resize the headless terminal to keep state in sync\n      const headless = this.headlessTerminals.get(params.sessionId);\n      headless?.resize(params.cols, params.rows);\n    } catch (err) {\n      log.error(\"Error resizing terminal:\", err);\n      throw err;\n    }\n  }\n\n  sendInput(sessionId: string, data: string): void {\n    try {\n      this.ptyService.sendInput(sessionId, data);\n    } catch (err) {\n      log.error(`Error sending input to terminal ${sessionId}:`, err);\n      throw err;\n    }\n  }\n\n  async openWindow(workspaceId: string, sessionId?: string): Promise<void> {\n    try {\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\n      const workspace = allMetadata.find((w) => w.id === workspaceId);\n\n      if (!workspace) {\n        throw new Error(`Workspace not found: ${workspaceId}`);\n      }\n\n      const runtimeConfig = workspace.runtimeConfig;\n      const isSSH = isSSHRuntime(runtimeConfig);\n      const isDesktop = !!this.terminalWindowManager;\n\n      if (isDesktop) {\n        log.info(\n          `Opening terminal window for workspace: ${workspaceId}${sessionId ? ` (session: ${sessionId})` : \"\"}`\n        );\n        await this.terminalWindowManager!.openTerminalWindow(workspaceId, sessionId);\n      } else {\n        log.info(\n          `Browser mode: terminal UI handled by browser for ${isSSH ? \"SSH\" : \"local\"} workspace: ${workspaceId}`\n        );\n      }\n    } catch (err) {\n      log.error(\"Error opening terminal window:\", err);\n      throw err;\n    }\n  }\n\n  closeWindow(workspaceId: string): void {\n    try {\n      if (!this.terminalWindowManager) {\n        // Not an error in server mode, just no-op\n        return;\n      }\n      this.terminalWindowManager.closeTerminalWindow(workspaceId);\n    } catch (err) {\n      log.error(\"Error closing terminal window:\", err);\n      throw err;\n    }\n  }\n\n  /**\n   * Open the native system terminal for a workspace.\n   * Opens the user's preferred terminal emulator (Ghostty, Terminal.app, etc.)\n   * with the working directory set to the workspace path.\n   *\n   * For SSH workspaces, opens a terminal that SSHs into the remote host.\n   */\n  async openNative(workspaceId: string): Promise<void> {\n    try {\n      const allMetadata = await this.config.getAllWorkspaceMetadata();\n      const workspace = allMetadata.find((w) => w.id === workspaceId);\n\n      if (!workspace) {\n        throw new Error(`Workspace not found: ${workspaceId}`);\n      }\n\n      const runtimeConfig = workspace.runtimeConfig;\n\n      if (isSSHRuntime(runtimeConfig)) {\n        // SSH workspace - spawn local terminal that SSHs into remote host\n        await this.openNativeTerminal({\n          type: \"ssh\",\n          sshConfig: runtimeConfig,\n          remotePath: workspace.namedWorkspacePath,\n        });\n      } else if (isDockerRuntime(runtimeConfig)) {\n        // Docker workspace - spawn terminal that docker execs into container\n        const containerName = runtimeConfig.containerName;\n        if (!containerName) {\n          throw new Error(\"Docker container not initialized\");\n        }\n        await this.openNativeTerminal({\n          type: \"local\",\n          workspacePath: process.cwd(), // cwd doesn't matter, we're running docker exec\n          command: `docker exec -it ${containerName} /bin/sh -c \"cd ${workspace.namedWorkspacePath} && exec /bin/sh\"`,\n        });\n      } else if (isDevcontainerRuntime(runtimeConfig)) {\n        const quotedPath = JSON.stringify(workspace.namedWorkspacePath);\n        const configArg = runtimeConfig.configPath\n          ? ` --config ${JSON.stringify(runtimeConfig.configPath)}`\n          : \"\";\n        await this.openNativeTerminal({\n          type: \"local\",\n          workspacePath: workspace.namedWorkspacePath,\n          command: `devcontainer exec --workspace-folder ${quotedPath}${configArg} -- /bin/sh`,\n        });\n      } else {\n        // Local workspace - spawn terminal with cwd set\n        await this.openNativeTerminal({\n          type: \"local\",\n          workspacePath: workspace.namedWorkspacePath,\n        });\n      }\n    } catch (err) {\n      const message = err instanceof Error ? err.message : String(err);\n      log.error(`Failed to open native terminal: ${message}`);\n      throw err;\n    }\n  }\n\n  /**\n   * Open a native terminal and run a command.\n   * Used for opening $EDITOR in a terminal when editing files.\n   * @param command The command to run\n   * @param workspacePath Optional directory to run the command in (defaults to cwd)\n   */\n  async openNativeWithCommand(command: string, workspacePath?: string): Promise<void> {\n    await this.openNativeTerminal({\n      type: \"local\",\n      workspacePath: workspacePath ?? process.cwd(),\n      command,\n    });\n  }\n\n  /**\n   * Open a native terminal (local or SSH) with platform-specific handling.\n   * This spawns the user's native terminal emulator, not a web-based terminal.\n   */\n  private async openNativeTerminal(config: NativeTerminalConfig): Promise<void> {\n    const isSSH = config.type === \"ssh\";\n\n    // Build SSH args if needed\n    let sshArgs: string[] | null = null;\n    if (isSSH) {\n      sshArgs = [];\n      // Add port if specified\n      if (config.sshConfig.port) {\n        sshArgs.push(\"-p\", String(config.sshConfig.port));\n      }\n      // Add identity file if specified\n      if (config.sshConfig.identityFile) {\n        sshArgs.push(\"-i\", config.sshConfig.identityFile);\n      }\n      // Force pseudo-terminal allocation\n      sshArgs.push(\"-t\");\n      // Add host\n      sshArgs.push(config.sshConfig.host);\n      // Add remote command to cd into directory and start shell\n      // Use single quotes to prevent local shell expansion\n      // exec $SHELL replaces the SSH process with the shell, avoiding nested processes\n      sshArgs.push(`cd '${config.remotePath.replace(/'/g, \"'\\\\''\")}' && exec $SHELL`);\n    }\n\n    const logPrefix = isSSH ? \"SSH terminal\" : \"terminal\";\n\n    if (process.platform === \"darwin\") {\n      await this.openNativeTerminalMacOS(config, sshArgs, logPrefix);\n    } else if (process.platform === \"win32\") {\n      this.openNativeTerminalWindows(config, sshArgs, logPrefix);\n    } else {\n      await this.openNativeTerminalLinux(config, sshArgs, logPrefix);\n    }\n  }\n\n  private async openNativeTerminalMacOS(\n    config: NativeTerminalConfig,\n    sshArgs: string[] | null,\n    logPrefix: string\n  ): Promise<void> {\n    const isSSH = config.type === \"ssh\";\n    const command = config.command;\n    const workspacePath = config.type === \"local\" ? config.workspacePath : config.remotePath;\n\n    // macOS - try Ghostty first, fallback to Terminal.app\n    const terminal = await findAvailableCommand([\"ghostty\", \"terminal\"]);\n    if (terminal === \"ghostty\") {\n      const cmd = \"open\";\n      let args: string[];\n      if (isSSH && sshArgs) {\n        // Ghostty: Use --command flag to run SSH\n        // Build the full SSH command as a single string\n        const sshCommand = [\"ssh\", ...sshArgs].join(\" \");\n        args = [\"-n\", \"-a\", \"Ghostty\", \"--args\", `--command=${sshCommand}`];\n      } else if (command) {\n        // Ghostty: Run command in workspace directory\n        // Wrap in sh -c to handle cd and command properly\n        const escapedPath = workspacePath.replace(/'/g, \"'\\\\''\");\n        const escapedCmd = command.replace(/'/g, \"'\\\\''\");\n        const fullCommand = `sh -c 'cd \"${escapedPath}\" && ${escapedCmd}'`;\n        args = [\"-n\", \"-a\", \"Ghostty\", \"--args\", `--command=${fullCommand}`];\n      } else {\n        // Ghostty: Pass workspacePath to 'open -a Ghostty' to avoid regressions\n        args = [\"-a\", \"Ghostty\", workspacePath];\n      }\n      log.info(`Opening ${logPrefix}: ${cmd} ${args.join(\" \")}`);\n      const child = spawn(cmd, args, {\n        detached: true,\n        stdio: \"ignore\",\n      });\n      child.unref();\n    } else {\n      // Terminal.app\n      const cmd = isSSH || command ? \"osascript\" : \"open\";\n      let args: string[];\n      if (isSSH && sshArgs) {\n        // Terminal.app: Use osascript with proper AppleScript structure\n        // Properly escape single quotes in args before wrapping in quotes\n        const sshCommand = `ssh ${sshArgs\n          .map((arg) => {\n            if (arg.includes(\" \") || arg.includes(\"'\")) {\n              // Escape single quotes by ending quote, adding escaped quote, starting quote again\n              return `'${arg.replace(/'/g, \"'\\\\''\")}'`;\n            }\n            return arg;\n          })\n          .join(\" \")}`;\n        // Escape double quotes for AppleScript string\n        const escapedCommand = sshCommand.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"');\n        const script = `tell application \"Terminal\"\\nactivate\\ndo script \"${escapedCommand}\"\\nend tell`;\n        args = [\"-e\", script];\n      } else if (command) {\n        // Terminal.app: Run command in workspace directory via AppleScript\n        const fullCommand = `cd \"${workspacePath}\" && ${command}`;\n        const escapedCommand = fullCommand.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"');\n        const script = `tell application \"Terminal\"\\nactivate\\ndo script \"${escapedCommand}\"\\nend tell`;\n        args = [\"-e\", script];\n      } else {\n        // Terminal.app opens in the directory when passed as argument\n        args = [\"-a\", \"Terminal\", workspacePath];\n      }\n      log.info(`Opening ${logPrefix}: ${cmd} ${args.join(\" \")}`);\n      const child = spawn(cmd, args, {\n        detached: true,\n        stdio: \"ignore\",\n      });\n      child.unref();\n    }\n  }\n\n  private openNativeTerminalWindows(\n    config: NativeTerminalConfig,\n    sshArgs: string[] | null,\n    logPrefix: string\n  ): void {\n    const isSSH = config.type === \"ssh\";\n    const command = config.command;\n    const workspacePath = config.type === \"local\" ? config.workspacePath : config.remotePath;\n\n    // Windows\n    const cmd = \"cmd\";\n    let args: string[];\n    if (isSSH && sshArgs) {\n      // Windows - use cmd to start ssh\n      args = [\"/c\", \"start\", \"cmd\", \"/K\", \"ssh\", ...sshArgs];\n    } else if (command) {\n      // Windows - cd to directory and run command\n      args = [\"/c\", \"start\", \"cmd\", \"/K\", `cd /D \"${workspacePath}\" && ${command}`];\n    } else {\n      // Windows - just cd to directory\n      args = [\"/c\", \"start\", \"cmd\", \"/K\", \"cd\", \"/D\", workspacePath];\n    }\n    log.info(`Opening ${logPrefix}: ${cmd} ${args.join(\" \")}`);\n    const child = spawn(cmd, args, {\n      detached: true,\n      shell: true,\n      stdio: \"ignore\",\n    });\n    child.unref();\n  }\n\n  private async openNativeTerminalLinux(\n    config: NativeTerminalConfig,\n    sshArgs: string[] | null,\n    logPrefix: string\n  ): Promise<void> {\n    const isSSH = config.type === \"ssh\";\n    const command = config.command;\n    const workspacePath = config.type === \"local\" ? config.workspacePath : config.remotePath;\n\n    // Linux - try terminal emulators in order of preference\n    let terminals: Array<{ cmd: string; args: string[]; cwd?: string }>;\n\n    if (isSSH && sshArgs) {\n      // x-terminal-emulator is checked first as it respects user's system-wide preference\n      terminals = [\n        { cmd: \"x-terminal-emulator\", args: [\"-e\", \"ssh\", ...sshArgs] },\n        { cmd: \"ghostty\", args: [\"ssh\", ...sshArgs] },\n        { cmd: \"alacritty\", args: [\"-e\", \"ssh\", ...sshArgs] },\n        { cmd: \"kitty\", args: [\"ssh\", ...sshArgs] },\n        { cmd: \"wezterm\", args: [\"start\", \"--\", \"ssh\", ...sshArgs] },\n        { cmd: \"gnome-terminal\", args: [\"--\", \"ssh\", ...sshArgs] },\n        { cmd: \"konsole\", args: [\"-e\", \"ssh\", ...sshArgs] },\n        { cmd: \"xfce4-terminal\", args: [\"-e\", `ssh ${sshArgs.join(\" \")}`] },\n        { cmd: \"xterm\", args: [\"-e\", \"ssh\", ...sshArgs] },\n      ];\n    } else if (command) {\n      // Run command in workspace directory\n      const fullCommand = `cd \"${workspacePath}\" && ${command}`;\n      terminals = [\n        { cmd: \"x-terminal-emulator\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\n        { cmd: \"ghostty\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\n        { cmd: \"alacritty\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\n        { cmd: \"kitty\", args: [\"sh\", \"-c\", fullCommand] },\n        { cmd: \"wezterm\", args: [\"start\", \"--\", \"sh\", \"-c\", fullCommand] },\n        { cmd: \"gnome-terminal\", args: [\"--\", \"sh\", \"-c\", fullCommand] },\n        { cmd: \"konsole\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\n        { cmd: \"xfce4-terminal\", args: [\"-e\", `sh -c '${fullCommand.replace(/'/g, \"'\\\\''\")}'`] },\n        { cmd: \"xterm\", args: [\"-e\", \"sh\", \"-c\", fullCommand] },\n      ];\n    } else {\n      // Just open terminal in directory\n      terminals = [\n        { cmd: \"x-terminal-emulator\", args: [], cwd: workspacePath },\n        { cmd: \"ghostty\", args: [\"--working-directory=\" + workspacePath] },\n        { cmd: \"alacritty\", args: [\"--working-directory\", workspacePath] },\n        { cmd: \"kitty\", args: [\"--directory\", workspacePath] },\n        { cmd: \"wezterm\", args: [\"start\", \"--cwd\", workspacePath] },\n        { cmd: \"gnome-terminal\", args: [\"--working-directory\", workspacePath] },\n        { cmd: \"konsole\", args: [\"--workdir\", workspacePath] },\n        { cmd: \"xfce4-terminal\", args: [\"--working-directory\", workspacePath] },\n        { cmd: \"xterm\", args: [], cwd: workspacePath },\n      ];\n    }\n\n    const availableTerminal = await this.findAvailableTerminal(terminals);\n\n    if (availableTerminal) {\n      const cwdInfo = availableTerminal.cwd ? ` (cwd: ${availableTerminal.cwd})` : \"\";\n      log.info(\n        `Opening ${logPrefix}: ${availableTerminal.cmd} ${availableTerminal.args.join(\" \")}${cwdInfo}`\n      );\n      const child = spawn(availableTerminal.cmd, availableTerminal.args, {\n        cwd: availableTerminal.cwd,\n        detached: true,\n        stdio: \"ignore\",\n      });\n      child.unref();\n    } else {\n      log.error(\"No terminal emulator found. Tried: \" + terminals.map((t) => t.cmd).join(\", \"));\n      throw new Error(\"No terminal emulator found\");\n    }\n  }\n\n  /**\n   * Find the first available terminal emulator from a list\n   */\n  private async findAvailableTerminal(\n    terminals: Array<{ cmd: string; args: string[]; cwd?: string }>\n  ): Promise<{ cmd: string; args: string[]; cwd?: string } | null> {\n    for (const terminal of terminals) {\n      if (await isCommandAvailable(terminal.cmd)) {\n        return terminal;\n      }\n    }\n    return null;\n  }\n\n  onOutput(sessionId: string, callback: (data: string) => void): () => void {\n    const emitter = this.outputEmitters.get(sessionId);\n    if (!emitter) {\n      // Session might not exist yet or closed.\n      // If it doesn't exist, we can't subscribe.\n      return () => {\n        /* no-op */\n      };\n    }\n\n    // Note: The attach stream yields screenState first, then live output.\n    // This subscription only provides live output from the point of subscription onward.\n\n    const handler = (data: string) => callback(data);\n    emitter.on(\"data\", handler);\n\n    return () => {\n      emitter.off(\"data\", handler);\n    };\n  }\n\n  onExit(sessionId: string, callback: (code: number) => void): () => void {\n    const emitter = this.exitEmitters.get(sessionId);\n    if (!emitter)\n      return () => {\n        /* no-op */\n      };\n\n    const handler = (code: number) => callback(code);\n    emitter.on(\"exit\", handler);\n\n    return () => {\n      emitter.off(\"exit\", handler);\n    };\n  }\n\n  /**\n   * Get serialized screen state for a session.\n   * Called by frontend on reconnect to restore terminal view instantly (~4KB vs 512KB raw replay).\n   * Returns VT escape sequences that reconstruct the current screen state.\n   *\n   * Note: @xterm/addon-serialize v0.14+ automatically includes the alternate buffer switch\n   * sequence (\\x1b[?1049h) when the terminal is in alternate screen mode (htop, vim, etc.).\n   */\n  getScreenState(sessionId: string): string {\n    const addon = this.serializeAddons.get(sessionId);\n    return addon?.serialize() ?? \"\";\n  }\n\n  private emitOutput(sessionId: string, data: string) {\n    // Write to headless terminal to maintain parsed state (and generate device-query responses)\n    const headless = this.headlessTerminals.get(sessionId);\n    headless?.write(data);\n\n    const emitter = this.outputEmitters.get(sessionId);\n    if (emitter) {\n      emitter.emit(\"data\", data);\n    }\n  }\n\n  /**\n   * Get all session IDs for a workspace.\n   * Used by frontend to discover existing sessions to reattach to after reload.\n   */\n  getWorkspaceSessionIds(workspaceId: string): string[] {\n    return this.ptyService.getWorkspaceSessionIds(workspaceId);\n  }\n\n  /**\n   * Close all terminal sessions for a workspace.\n   * Called when a workspace is removed to prevent resource leaks.\n   */\n  closeWorkspaceSessions(workspaceId: string): void {\n    this.ptyService.closeWorkspaceSessions(workspaceId);\n  }\n\n  /**\n   * Close all terminal sessions.\n   * Called during server shutdown to prevent orphan PTY processes.\n   */\n  closeAllSessions(): void {\n    this.ptyService.closeAllSessions();\n  }\n\n  private cleanup(sessionId: string) {\n    const disposeHeadlessOnData = this.headlessOnDataDisposables.get(sessionId);\n    disposeHeadlessOnData?.dispose();\n    this.headlessOnDataDisposables.delete(sessionId);\n    this.outputEmitters.delete(sessionId);\n    this.exitEmitters.delete(sessionId);\n\n    // Dispose and clean up headless terminal\n    const headless = this.headlessTerminals.get(sessionId);\n    headless?.dispose();\n    this.headlessTerminals.delete(sessionId);\n    this.serializeAddons.delete(sessionId);\n  }\n}\n"]}