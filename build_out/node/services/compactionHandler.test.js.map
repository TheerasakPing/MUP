{"version":3,"file":"compactionHandler.test.js","sourceRoot":"","sources":["../../../src/node/services/compactionHandler.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach, mock, spyOn } from \"bun:test\";\r\nimport { CompactionHandler } from \"./compactionHandler\";\r\nimport type { HistoryService } from \"./historyService\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\n\r\nimport type { EventEmitter } from \"events\";\r\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\r\nimport type { StreamEndEvent } from \"@/common/types/stream\";\r\nimport type { TelemetryService } from \"./telemetryService\";\r\nimport type { TelemetryEventPayload } from \"@/common/telemetry/payload\";\r\nimport { Ok, Err, type Result } from \"@/common/types/result\";\r\n\r\ninterface EmittedEvent {\r\n  event: string;\r\n  data: ChatEventData;\r\n}\r\n\r\n// Type guards for emitted events\r\ninterface ChatEventData {\r\n  workspaceId: string;\r\n  message: unknown;\r\n}\r\n\r\nconst createMockPartialService = () => {\r\n  let deletePartialResult: Result<void, string> = Ok(undefined);\r\n\r\n  const deletePartial = mock((_) => Promise.resolve(deletePartialResult));\r\n  const readPartial = mock((_) => Promise.resolve(null));\r\n  const writePartial = mock((_, __) => Promise.resolve(Ok(undefined)));\r\n  const commitToHistory = mock((_) => Promise.resolve(Ok(undefined)));\r\n\r\n  return {\r\n    deletePartial,\r\n    readPartial,\r\n    writePartial,\r\n    commitToHistory,\r\n    // Allow setting mock return values\r\n    mockDeletePartial: (result: Result<void, string>) => {\r\n      deletePartialResult = result;\r\n    },\r\n  };\r\n};\r\n\r\nconst createMockEmitter = (): { emitter: EventEmitter; events: EmittedEvent[] } => {\r\n  const events: EmittedEvent[] = [];\r\n  const emitter = {\r\n    emit: (_event: string, data: ChatEventData) => {\r\n      events.push({ event: _event, data });\r\n      return true;\r\n    },\r\n  };\r\n  return { emitter: emitter as EventEmitter, events };\r\n};\r\n\r\nconst createCompactionRequest = (id = \"req-1\"): MuxMessage =>\r\n  createMuxMessage(id, \"user\", \"Please summarize the conversation\", {\r\n    historySequence: 0,\r\n    muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n  });\r\n\r\nconst createSuccessfulFileEditMessage = (\r\n  id: string,\r\n  filePath: string,\r\n  diff: string,\r\n  metadata?: MuxMessage[\"metadata\"]\r\n): MuxMessage => ({\r\n  id,\r\n  role: \"assistant\",\r\n  parts: [\r\n    {\r\n      type: \"dynamic-tool\",\r\n      toolCallId: `tool-${id}`,\r\n      toolName: \"file_edit_replace_string\",\r\n      state: \"output-available\",\r\n      input: { file_path: filePath },\r\n      output: { success: true, diff },\r\n    },\r\n  ],\r\n  metadata: {\r\n    timestamp: 1234,\r\n    ...(metadata ?? {}),\r\n  },\r\n});\r\n\r\nconst createStreamEndEvent = (\r\n  summary: string,\r\n  metadata?: Record<string, unknown>\r\n): StreamEndEvent => ({\r\n  type: \"stream-end\",\r\n  workspaceId: \"test-workspace\",\r\n  messageId: \"msg-id\",\r\n  parts: [{ type: \"text\", text: summary }],\r\n  metadata: {\r\n    model: \"claude-3-5-sonnet-20241022\",\r\n    usage: { inputTokens: 100, outputTokens: 50, totalTokens: undefined },\r\n    duration: 1500,\r\n    ...metadata,\r\n  },\r\n});\r\n\r\nconst getEmittedStreamEndEvent = (events: EmittedEvent[]): StreamEndEvent | undefined => {\r\n  return events\r\n    .map((event) => event.data.message)\r\n    .find((message): message is StreamEndEvent => {\r\n      return (\r\n        typeof message === \"object\" &&\r\n        message !== null &&\r\n        \"type\" in message &&\r\n        (message as { type?: unknown }).type === \"stream-end\"\r\n      );\r\n    });\r\n};\r\n\r\ndescribe(\"CompactionHandler\", () => {\r\n  let handler: CompactionHandler;\r\n  let historyService: HistoryService;\r\n  let cleanup: () => Promise<void>;\r\n  let mockPartialService: ReturnType<typeof createMockPartialService>;\r\n  let mockEmitter: EventEmitter;\r\n  let telemetryCapture: ReturnType<typeof mock>;\r\n  let telemetryService: TelemetryService;\r\n  let sessionDir: string;\r\n  let emittedEvents: EmittedEvent[];\r\n  const workspaceId = \"test-workspace\";\r\n\r\n  // Helper: seed messages into real history and return spies for tracking handler calls.\r\n  // Spies are created AFTER seeding so they only track handler-initiated calls.\r\n  const seedHistory = async (...messages: MuxMessage[]) => {\r\n    for (const msg of messages) {\r\n      const result = await historyService.appendToHistory(workspaceId, msg);\r\n      if (!result.success) throw new Error(`Seed failed: ${result.error}`);\r\n    }\r\n    return {\r\n      appendSpy: spyOn(historyService, \"appendToHistory\"),\r\n      clearSpy: spyOn(historyService, \"clearHistory\"),\r\n      updateSpy: spyOn(historyService, \"updateHistory\"),\r\n    };\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    const testHistory = await createTestHistoryService();\r\n    historyService = testHistory.historyService;\r\n    cleanup = testHistory.cleanup;\r\n\r\n    const { emitter, events } = createMockEmitter();\r\n    mockEmitter = emitter;\r\n    emittedEvents = events;\r\n\r\n    telemetryCapture = mock((_payload: TelemetryEventPayload) => {\r\n      void _payload;\r\n    });\r\n    telemetryService = { capture: telemetryCapture } as unknown as TelemetryService;\r\n\r\n    sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-compaction-handler-\"));\r\n\r\n    mockPartialService = createMockPartialService();\r\n\r\n    handler = new CompactionHandler({\r\n      workspaceId,\r\n      historyService,\r\n      partialService: mockPartialService as unknown as PartialService,\r\n      sessionDir,\r\n      telemetryService,\r\n      emitter: mockEmitter,\r\n    });\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await cleanup();\r\n  });\r\n\r\n  describe(\"handleCompletion() - Normal Compaction Flow\", () => {\r\n    it(\"should return false when no compaction request found\", async () => {\r\n      const normalMsg = createMuxMessage(\"msg1\", \"user\", \"Hello\", {\r\n        historySequence: 0,\r\n        muxMetadata: { type: \"normal\" },\r\n      });\r\n      const { clearSpy } = await seedHistory(normalMsg);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(false);\r\n      expect(clearSpy.mock.calls).toHaveLength(0);\r\n    });\r\n\r\n    it(\"should return false when historyService fails\", async () => {\r\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(Err(\"Database error\"));\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(false);\r\n    });\r\n\r\n    it(\"should capture compaction_completed telemetry on successful compaction\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\", {\r\n        duration: 1500,\r\n        // Prefer contextUsage (context size) over total usage.\r\n        contextUsage: { inputTokens: 1000, outputTokens: 333, totalTokens: undefined },\r\n      });\r\n\r\n      await handler.handleCompletion(event);\r\n\r\n      expect(telemetryCapture.mock.calls).toHaveLength(1);\r\n      const payload = telemetryCapture.mock.calls[0][0] as TelemetryEventPayload;\r\n      expect(payload.event).toBe(\"compaction_completed\");\r\n      if (payload.event !== \"compaction_completed\") {\r\n        throw new Error(\"Expected compaction_completed payload\");\r\n      }\r\n\r\n      expect(payload.properties).toEqual({\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        // 1.5s -> 2\r\n        duration_b2: 2,\r\n        // 1000 -> 1024\r\n        input_tokens_b2: 1024,\r\n        // 333 -> 512\r\n        output_tokens_b2: 512,\r\n        compaction_source: \"manual\",\r\n      });\r\n    });\r\n\r\n    it(\"persists pending diffs to disk and reloads them on restart\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n\r\n      const fileEditMessage = createSuccessfulFileEditMessage(\r\n        \"assistant-edit\",\r\n        \"/tmp/foo.ts\",\r\n        \"@@ -1 +1 @@\\n-foo\\n+bar\\n\"\r\n      );\r\n\r\n      await seedHistory(fileEditMessage, compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const handled = await handler.handleCompletion(event);\r\n      expect(handled).toBe(true);\r\n\r\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\r\n      const raw = await fsPromises.readFile(persistedPath, \"utf-8\");\r\n      const parsed = JSON.parse(raw) as { version?: unknown; diffs?: unknown };\r\n      expect(parsed.version).toBe(1);\r\n\r\n      const diffs = (parsed as { diffs?: Array<{ path: string; diff: string }> }).diffs;\r\n      expect(Array.isArray(diffs)).toBe(true);\r\n      if (Array.isArray(diffs)) {\r\n        expect(diffs[0]?.path).toBe(\"/tmp/foo.ts\");\r\n        expect(diffs[0]?.diff).toContain(\"@@ -1 +1 @@\");\r\n      }\r\n\r\n      // Simulate a restart: create a new handler and load from disk.\r\n      const { emitter: newEmitter } = createMockEmitter();\r\n      const reloaded = new CompactionHandler({\r\n        workspaceId,\r\n        historyService,\r\n        partialService: mockPartialService as unknown as PartialService,\r\n        sessionDir,\r\n        telemetryService,\r\n        emitter: newEmitter,\r\n      });\r\n\r\n      const pending = await reloaded.peekPendingDiffs();\r\n      expect(pending).not.toBeNull();\r\n      expect(pending?.[0]?.path).toBe(\"/tmp/foo.ts\");\r\n\r\n      await reloaded.ackPendingDiffsConsumed();\r\n\r\n      let exists = true;\r\n      try {\r\n        await fsPromises.stat(persistedPath);\r\n      } catch {\r\n        exists = false;\r\n      }\r\n      expect(exists).toBe(false);\r\n    });\r\n\r\n    it(\"persists only latest-epoch diffs when a durable compaction boundary exists\", async () => {\r\n      const staleEditMessage = createSuccessfulFileEditMessage(\r\n        \"assistant-stale-edit\",\r\n        \"/tmp/stale.ts\",\r\n        \"@@ -1 +1 @@\\n-old\\n+stale\\n\",\r\n        { historySequence: 0 }\r\n      );\r\n      const latestBoundary = createMuxMessage(\"summary-boundary\", \"assistant\", \"Older summary\", {\r\n        historySequence: 1,\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        compactionEpoch: 1,\r\n      });\r\n      const recentEditMessage = createSuccessfulFileEditMessage(\r\n        \"assistant-recent-edit\",\r\n        \"/tmp/recent.ts\",\r\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\",\r\n        { historySequence: 2 }\r\n      );\r\n      const compactionReq = createMuxMessage(\"req-latest-epoch\", \"user\", \"Please summarize\", {\r\n        historySequence: 3,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n\r\n      await seedHistory(staleEditMessage, latestBoundary, recentEditMessage, compactionReq);\r\n\r\n      const handled = await handler.handleCompletion(createStreamEndEvent(\"Summary\"));\r\n      expect(handled).toBe(true);\r\n\r\n      const pending = await handler.peekPendingDiffs();\r\n      expect(pending?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\"]);\r\n\r\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\r\n      const raw = await fsPromises.readFile(persistedPath, \"utf-8\");\r\n      const parsed = JSON.parse(raw) as { diffs?: Array<{ path: string }> };\r\n      expect(parsed.diffs?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\"]);\r\n    });\r\n\r\n    it(\"falls back to full-history diff extraction when boundary marker is malformed\", async () => {\r\n      const staleEditMessage = createSuccessfulFileEditMessage(\r\n        \"assistant-stale-edit\",\r\n        \"/tmp/stale.ts\",\r\n        \"@@ -1 +1 @@\\n-old\\n+stale\\n\",\r\n        { historySequence: 0 }\r\n      );\r\n      const malformedBoundaryMissingEpoch = createMuxMessage(\r\n        \"summary-malformed-boundary\",\r\n        \"assistant\",\r\n        \"Malformed summary\",\r\n        {\r\n          historySequence: 1,\r\n          compacted: \"user\",\r\n          compactionBoundary: true,\r\n          // Missing compactionEpoch should be treated as malformed and ignored.\r\n        }\r\n      );\r\n      const recentEditMessage = createSuccessfulFileEditMessage(\r\n        \"assistant-recent-edit\",\r\n        \"/tmp/recent.ts\",\r\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\",\r\n        { historySequence: 2 }\r\n      );\r\n      const compactionReq = createMuxMessage(\"req-malformed-boundary\", \"user\", \"Please summarize\", {\r\n        historySequence: 3,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n\r\n      await seedHistory(\r\n        staleEditMessage,\r\n        malformedBoundaryMissingEpoch,\r\n        recentEditMessage,\r\n        compactionReq\r\n      );\r\n\r\n      const handled = await handler.handleCompletion(createStreamEndEvent(\"Summary\"));\r\n      expect(handled).toBe(true);\r\n\r\n      const pending = await handler.peekPendingDiffs();\r\n      expect(pending?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\", \"/tmp/stale.ts\"]);\r\n\r\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\r\n      const raw = await fsPromises.readFile(persistedPath, \"utf-8\");\r\n      const parsed = JSON.parse(raw) as { diffs?: Array<{ path: string }> };\r\n      expect(parsed.diffs?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\", \"/tmp/stale.ts\"]);\r\n    });\r\n    it(\"should return true when successful\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Complete summary\");\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(true);\r\n    });\r\n\r\n    it(\"should join multiple text parts from event.parts\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      const { appendSpy } = await seedHistory(compactionReq);\r\n\r\n      // Create event with multiple text parts\r\n      const event: StreamEndEvent = {\r\n        type: \"stream-end\",\r\n        workspaceId: \"test-workspace\",\r\n        messageId: \"msg-id\",\r\n        parts: [\r\n          { type: \"text\", text: \"Part 1 \" },\r\n          { type: \"text\", text: \"Part 2 \" },\r\n          { type: \"text\", text: \"Part 3\" },\r\n        ],\r\n        metadata: {\r\n          model: \"claude-3-5-sonnet-20241022\",\r\n          usage: { inputTokens: 100, outputTokens: 50, totalTokens: undefined },\r\n          duration: 1500,\r\n        },\r\n      };\r\n      await handler.handleCompletion(event);\r\n\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect((appendedMsg.parts[0] as { type: \"text\"; text: string }).text).toBe(\r\n        \"Part 1 Part 2 Part 3\"\r\n      );\r\n    });\r\n\r\n    it(\"should extract summary text from event.parts\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      const { appendSpy } = await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"This is the summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect((appendedMsg.parts[0] as { type: \"text\"; text: string }).text).toBe(\r\n        \"This is the summary\"\r\n      );\r\n    });\r\n\r\n    it(\"should delete partial.json before appending summary (race condition fix)\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      // deletePartial should be called once before appendToHistory\r\n      expect(mockPartialService.deletePartial.mock.calls).toHaveLength(1);\r\n      expect(mockPartialService.deletePartial.mock.calls[0][0]).toBe(workspaceId);\r\n\r\n      // Verify deletePartial was called (we can't easily verify order without more complex mocking,\r\n      // but the important thing is that it IS called during compaction)\r\n    });\r\n\r\n    it(\"should append summary without clearing history\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      expect(clearSpy.mock.calls).toHaveLength(0);\r\n      expect(appendSpy.mock.calls).toHaveLength(1);\r\n      expect(appendSpy.mock.calls[0][0]).toBe(workspaceId);\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect(appendedMsg.role).toBe(\"assistant\");\r\n      expect((appendedMsg.parts[0] as { type: \"text\"; text: string }).text).toBe(\"Summary\");\r\n    });\r\n\r\n    it(\"should not emit delete events when compaction is append-only\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const deleteEvent = emittedEvents.find(\r\n        (_e) => (_e.data.message as { type?: string })?.type === \"delete\"\r\n      );\r\n      expect(deleteEvent).toBeUndefined();\r\n    });\r\n\r\n    it(\"should emit summary message with complete metadata\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const usage = { inputTokens: 200, outputTokens: 100, totalTokens: 300 };\r\n      const event = createStreamEndEvent(\"Summary\", {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        usage,\r\n        duration: 2000,\r\n        providerMetadata: { anthropic: { cacheCreationInputTokens: 50000 } },\r\n        systemMessageTokens: 100,\r\n      });\r\n      await handler.handleCompletion(event);\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.parts !== undefined;\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const sevt = summaryEvent?.data.message as MuxMessage;\r\n      // providerMetadata is omitted to avoid inflating context with pre-compaction cacheCreationInputTokens\r\n      expect(sevt.metadata).toMatchObject({\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        usage,\r\n        duration: 2000,\r\n        systemMessageTokens: 100,\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        compactionEpoch: 1,\r\n      });\r\n      expect(sevt.metadata?.providerMetadata).toBeUndefined();\r\n    });\r\n\r\n    it(\"should emit stream-end event to frontend\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\", { duration: 1234 });\r\n      await handler.handleCompletion(event);\r\n\r\n      const streamMsg = getEmittedStreamEndEvent(emittedEvents);\r\n      expect(streamMsg).toBeDefined();\r\n      expect(streamMsg?.workspaceId).toBe(workspaceId);\r\n      expect(streamMsg?.metadata.duration).toBe(1234);\r\n    });\r\n\r\n    it(\"should set boundary metadata and keep historySequence monotonic\", async () => {\r\n      const priorMessage = createMuxMessage(\"user-1\", \"user\", \"Earlier\", {\r\n        historySequence: 4,\r\n      });\r\n      const compactionReq = createMuxMessage(\"req-1\", \"user\", \"Please summarize\", {\r\n        historySequence: 5,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const { appendSpy } = await seedHistory(priorMessage, compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect(appendedMsg.metadata?.compacted).toBe(\"user\");\r\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\r\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(1);\r\n      expect(appendedMsg.metadata?.historySequence).toBe(6);\r\n    });\r\n    it(\"should ignore malformed persisted historySequence values when deriving monotonic bounds\", async () => {\r\n      const malformedNegativeSequence = createMuxMessage(\r\n        \"assistant-malformed-negative-sequence\",\r\n        \"assistant\",\r\n        \"Corrupted persisted metadata\",\r\n        {\r\n          historySequence: -7,\r\n        }\r\n      );\r\n      const malformedFractionalSequence = createMuxMessage(\r\n        \"assistant-malformed-fractional-sequence\",\r\n        \"assistant\",\r\n        \"Corrupted persisted metadata\",\r\n        {\r\n          historySequence: 99.5,\r\n        }\r\n      );\r\n      const priorMessage = createMuxMessage(\"user-1\", \"user\", \"Earlier\", {\r\n        historySequence: 4,\r\n      });\r\n      const compactionReq = createMuxMessage(\"req-1\", \"user\", \"Please summarize\", {\r\n        historySequence: 5,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n\r\n      // Seed valid messages so the service's sequence counter advances to 6,\r\n      // then mock getLastMessages to inject the malformed messages alongside them.\r\n      // The malformed historySequence values (-7, 99.5) would fail real appendToHistory assertions,\r\n      // so they can only be introduced via the mocked read path.\r\n      await historyService.appendToHistory(workspaceId, priorMessage);\r\n      await historyService.appendToHistory(workspaceId, compactionReq);\r\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\r\n        Ok([malformedNegativeSequence, malformedFractionalSequence, priorMessage, compactionReq])\r\n      );\r\n      const appendSpy = spyOn(historyService, \"appendToHistory\");\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(true);\r\n      expect(appendSpy.mock.calls).toHaveLength(1);\r\n\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect(appendedMsg.metadata?.historySequence).toBe(6);\r\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\r\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(1);\r\n    });\r\n\r\n    it(\"should derive next compaction epoch from legacy compacted summaries\", async () => {\r\n      const legacySummary = createMuxMessage(\"summary-legacy\", \"assistant\", \"Older summary\", {\r\n        historySequence: 2,\r\n        compacted: \"user\",\r\n      });\r\n      const compactionReq = createMuxMessage(\"req-epoch\", \"user\", \"Please summarize\", {\r\n        historySequence: 3,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n\r\n      const { appendSpy } = await seedHistory(legacySummary, compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(2);\r\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\r\n      expect(appendedMsg.metadata?.historySequence).toBe(4);\r\n    });\r\n\r\n    it(\"should update streamed summaries in-place without carrying stale provider metadata\", async () => {\r\n      const compactionReq = createMuxMessage(\"req-streamed\", \"user\", \"Please summarize\", {\r\n        historySequence: 5,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const streamedSummary = createMuxMessage(\"msg-id\", \"assistant\", \"Summary\", {\r\n        historySequence: 6,\r\n        timestamp: Date.now(),\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        providerMetadata: { anthropic: { cacheCreationInputTokens: 50_000 } },\r\n        contextProviderMetadata: { anthropic: { cacheReadInputTokens: 10_000 } },\r\n      });\r\n\r\n      const { appendSpy, updateSpy } = await seedHistory(compactionReq, streamedSummary);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(true);\r\n      expect(updateSpy.mock.calls).toHaveLength(1);\r\n      expect(appendSpy.mock.calls).toHaveLength(0);\r\n\r\n      const updatedSummary = updateSpy.mock.calls[0][1];\r\n      expect(updatedSummary.id).toBe(\"msg-id\");\r\n      expect(updatedSummary.metadata?.historySequence).toBe(6);\r\n      expect(updatedSummary.metadata?.compactionBoundary).toBe(true);\r\n      expect(updatedSummary.metadata?.compactionEpoch).toBe(1);\r\n      expect(updatedSummary.metadata?.providerMetadata).toBeUndefined();\r\n      expect(updatedSummary.metadata?.contextProviderMetadata).toBeUndefined();\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.id === \"msg-id\" && m?.metadata?.compactionBoundary === true;\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n    });\r\n\r\n    it(\"should strip stale provider metadata from emitted stream-end when reusing streamed summary ID\", async () => {\r\n      const compactionReq = createMuxMessage(\"req-streamed-sanitize\", \"user\", \"Please summarize\", {\r\n        historySequence: 5,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const streamedSummary = createMuxMessage(\"msg-id\", \"assistant\", \"Summary\", {\r\n        historySequence: 6,\r\n        timestamp: Date.now(),\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n      });\r\n\r\n      await seedHistory(compactionReq, streamedSummary);\r\n\r\n      const event = createStreamEndEvent(\"Summary\", {\r\n        providerMetadata: { anthropic: { cacheCreationInputTokens: 50_000 } },\r\n        contextProviderMetadata: { anthropic: { cacheReadInputTokens: 10_000 } },\r\n        customField: \"preserved\",\r\n      });\r\n\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(true);\r\n      const streamMsg = getEmittedStreamEndEvent(emittedEvents);\r\n      expect(streamMsg).toBeDefined();\r\n      expect(streamMsg?.messageId).toBe(\"msg-id\");\r\n      expect(streamMsg?.metadata.providerMetadata).toBeUndefined();\r\n      expect(streamMsg?.metadata.contextProviderMetadata).toBeUndefined();\r\n      expect((streamMsg?.metadata as Record<string, unknown> | undefined)?.customField).toBe(\r\n        \"preserved\"\r\n      );\r\n    });\r\n\r\n    it(\"should skip malformed compaction boundary markers when deriving next epoch\", async () => {\r\n      const validBoundary = createMuxMessage(\"summary-valid\", \"assistant\", \"Valid summary\", {\r\n        historySequence: 1,\r\n        compacted: \"user\",\r\n        compactionBoundary: true,\r\n        compactionEpoch: 3,\r\n      });\r\n      const malformedBoundaryMissingEpoch = createMuxMessage(\r\n        \"summary-malformed-1\",\r\n        \"assistant\",\r\n        \"Malformed boundary\",\r\n        {\r\n          historySequence: 2,\r\n          compacted: \"user\",\r\n          compactionBoundary: true,\r\n        }\r\n      );\r\n      const malformedBoundaryMissingCompacted = createMuxMessage(\r\n        \"summary-malformed-2\",\r\n        \"assistant\",\r\n        \"Malformed boundary\",\r\n        {\r\n          historySequence: 3,\r\n          compactionBoundary: true,\r\n          compactionEpoch: 99,\r\n        }\r\n      );\r\n      const malformedBoundaryInvalidCompacted = createMuxMessage(\r\n        \"summary-malformed-invalid-compacted\",\r\n        \"assistant\",\r\n        \"Malformed boundary\",\r\n        {\r\n          historySequence: 4,\r\n          compactionBoundary: true,\r\n          compactionEpoch: 200,\r\n        }\r\n      );\r\n      if (malformedBoundaryInvalidCompacted.metadata) {\r\n        (malformedBoundaryInvalidCompacted.metadata as Record<string, unknown>).compacted =\r\n          \"corrupted\";\r\n      }\r\n      const malformedBoundaryInvalidEpoch = createMuxMessage(\r\n        \"summary-malformed-3\",\r\n        \"assistant\",\r\n        \"Malformed boundary\",\r\n        {\r\n          historySequence: 4,\r\n          compacted: \"user\",\r\n          compactionBoundary: true,\r\n          compactionEpoch: 0,\r\n        }\r\n      );\r\n      const compactionReq = createMuxMessage(\"req-malformed\", \"user\", \"Please summarize\", {\r\n        historySequence: 5,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n\r\n      const { appendSpy } = await seedHistory(\r\n        validBoundary,\r\n        malformedBoundaryMissingEpoch,\r\n        malformedBoundaryMissingCompacted,\r\n        malformedBoundaryInvalidCompacted,\r\n        malformedBoundaryInvalidEpoch,\r\n        compactionReq\r\n      );\r\n\r\n      const result = await handler.handleCompletion(createStreamEndEvent(\"Summary\"));\r\n\r\n      expect(result).toBe(true);\r\n      expect(appendSpy.mock.calls).toHaveLength(1);\r\n      const appendedMsg = appendSpy.mock.calls[0][1];\r\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(4);\r\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe(\"handleCompletion() - Deduplication\", () => {\r\n    it(\"should track processed compaction-request IDs\", async () => {\r\n      const compactionReq = createCompactionRequest(\"req-unique\");\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      expect(clearSpy.mock.calls).toHaveLength(0);\r\n      expect(appendSpy.mock.calls).toHaveLength(1);\r\n    });\r\n\r\n    it(\"should return true without re-processing when same request ID seen twice\", async () => {\r\n      const compactionReq = createCompactionRequest(\"req-dupe\");\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const result1 = await handler.handleCompletion(event);\r\n      const result2 = await handler.handleCompletion(event);\r\n\r\n      expect(result1).toBe(true);\r\n      expect(result2).toBe(true);\r\n      expect(clearSpy.mock.calls).toHaveLength(0);\r\n      expect(appendSpy.mock.calls).toHaveLength(1);\r\n    });\r\n\r\n    it(\"should not emit duplicate events\", async () => {\r\n      const compactionReq = createCompactionRequest(\"req-dupe-2\");\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n      const eventCountAfterFirst = emittedEvents.length;\r\n\r\n      await handler.handleCompletion(event);\r\n      const eventCountAfterSecond = emittedEvents.length;\r\n\r\n      expect(eventCountAfterSecond).toBe(eventCountAfterFirst);\r\n    });\r\n\r\n    it(\"should not append summary twice\", async () => {\r\n      const compactionReq = createCompactionRequest(\"req-dupe-3\");\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n      await handler.handleCompletion(event);\r\n\r\n      expect(clearSpy.mock.calls).toHaveLength(0);\r\n      expect(appendSpy.mock.calls).toHaveLength(1);\r\n    });\r\n  });\r\n\r\n  describe(\"Error Handling\", () => {\r\n    it(\"should return false when appendToHistory() fails\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      const { appendSpy } = await seedHistory(compactionReq);\r\n      appendSpy.mockResolvedValueOnce(Err(\"Append failed\"));\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(false);\r\n\r\n      // Ensure we don't keep a persisted snapshot when summary append fails.\r\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\r\n      let exists = true;\r\n      try {\r\n        await fsPromises.stat(persistedPath);\r\n      } catch {\r\n        exists = false;\r\n      }\r\n      expect(exists).toBe(false);\r\n    });\r\n\r\n    it(\"should log errors but not throw\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      const { appendSpy } = await seedHistory(compactionReq);\r\n      appendSpy.mockResolvedValueOnce(Err(\"Database corruption\"));\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n\r\n      // Should not throw\r\n      const result = await handler.handleCompletion(event);\r\n      expect(result).toBe(false);\r\n    });\r\n\r\n    it(\"should not emit events when compaction fails mid-process\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      const { appendSpy } = await seedHistory(compactionReq);\r\n      appendSpy.mockResolvedValueOnce(Err(\"Append failed\"));\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      expect(emittedEvents).toHaveLength(0);\r\n    });\r\n  });\r\n\r\n  describe(\"Event Emission\", () => {\r\n    it(\"should include workspaceId in all chat-event emissions\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const chatEvents = emittedEvents.filter((e) => e.event === \"chat-event\");\r\n      expect(chatEvents.length).toBeGreaterThan(0);\r\n      chatEvents.forEach((e) => {\r\n        expect(e.data.workspaceId).toBe(workspaceId);\r\n      });\r\n    });\r\n\r\n    it(\"should not emit DeleteMessage events during append-only compaction\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const deleteEvent = emittedEvents.find(\r\n        (_e) => (_e.data.message as { type?: string })?.type === \"delete\"\r\n      );\r\n      expect(deleteEvent).toBeUndefined();\r\n    });\r\n\r\n    it(\"should emit summary message with proper MuxMessage structure\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary text\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.parts !== undefined;\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\r\n      expect(summaryMsg).toMatchObject({\r\n        id: expect.stringContaining(\"summary-\") as string,\r\n        role: \"assistant\",\r\n        parts: [{ type: \"text\", text: \"Summary text\" }],\r\n        metadata: expect.objectContaining({\r\n          compacted: \"user\",\r\n          compactionBoundary: true,\r\n          compactionEpoch: 1,\r\n          muxMetadata: { type: \"compaction-summary\" },\r\n        }) as MuxMessage[\"metadata\"],\r\n      });\r\n    });\r\n\r\n    it(\"should forward stream events (stream-end, stream-abort) correctly\", async () => {\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(compactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\", { customField: \"test\" });\r\n      await handler.handleCompletion(event);\r\n\r\n      const streamMsg = getEmittedStreamEndEvent(emittedEvents);\r\n      expect(streamMsg).toBeDefined();\r\n      expect((streamMsg?.metadata as Record<string, unknown> | undefined)?.customField).toBe(\r\n        \"test\"\r\n      );\r\n    });\r\n  });\r\n\r\n  describe(\"Idle Compaction\", () => {\r\n    it(\"should preserve original recency timestamp from last user message\", async () => {\r\n      const originalTimestamp = Date.now() - 3600 * 1000; // 1 hour ago\r\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\r\n        timestamp: originalTimestamp,\r\n        historySequence: 0,\r\n      });\r\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\r\n        historySequence: 1,\r\n        muxMetadata: {\r\n          type: \"compaction-request\",\r\n          source: \"idle-compaction\",\r\n          rawCommand: \"/compact\",\r\n          parsed: {},\r\n        },\r\n      });\r\n\r\n      await seedHistory(userMessage, idleCompactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.metadata?.compacted;\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\r\n      expect(summaryMsg.metadata?.timestamp).toBe(originalTimestamp);\r\n      expect(summaryMsg.metadata?.compacted).toBe(\"idle\");\r\n    });\r\n\r\n    it(\"should preserve recency from last compacted message if no user message\", async () => {\r\n      const compactedTimestamp = Date.now() - 7200 * 1000; // 2 hours ago\r\n      const compactedMessage = createMuxMessage(\"compacted-1\", \"assistant\", \"Previous summary\", {\r\n        timestamp: compactedTimestamp,\r\n        compacted: \"user\",\r\n        historySequence: 0,\r\n      });\r\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\r\n        historySequence: 1,\r\n        muxMetadata: {\r\n          type: \"compaction-request\",\r\n          source: \"idle-compaction\",\r\n          rawCommand: \"/compact\",\r\n          parsed: {},\r\n        },\r\n      });\r\n\r\n      await seedHistory(compactedMessage, idleCompactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.metadata?.compacted === \"idle\";\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\r\n      expect(summaryMsg.metadata?.timestamp).toBe(compactedTimestamp);\r\n    });\r\n\r\n    it(\"should use max of user and compacted timestamps\", async () => {\r\n      const olderCompactedTimestamp = Date.now() - 7200 * 1000; // 2 hours ago\r\n      const newerUserTimestamp = Date.now() - 3600 * 1000; // 1 hour ago\r\n      const compactedMessage = createMuxMessage(\"compacted-1\", \"assistant\", \"Previous summary\", {\r\n        timestamp: olderCompactedTimestamp,\r\n        compacted: \"user\",\r\n        historySequence: 0,\r\n      });\r\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\r\n        timestamp: newerUserTimestamp,\r\n        historySequence: 1,\r\n      });\r\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\r\n        historySequence: 2,\r\n        muxMetadata: {\r\n          type: \"compaction-request\",\r\n          source: \"idle-compaction\",\r\n          rawCommand: \"/compact\",\r\n          parsed: {},\r\n        },\r\n      });\r\n\r\n      await seedHistory(compactedMessage, userMessage, idleCompactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.metadata?.compacted === \"idle\";\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\r\n      // Should use the newer timestamp (user message)\r\n      expect(summaryMsg.metadata?.timestamp).toBe(newerUserTimestamp);\r\n    });\r\n\r\n    it(\"should skip compaction-request message when finding timestamp to preserve\", async () => {\r\n      const originalTimestamp = Date.now() - 3600 * 1000; // 1 hour ago - the real user message\r\n      const freshTimestamp = Date.now(); // The compaction request has a fresh timestamp\r\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\r\n        timestamp: originalTimestamp,\r\n        historySequence: 0,\r\n      });\r\n      // Idle compaction request WITH a timestamp (as happens in production)\r\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\r\n        timestamp: freshTimestamp,\r\n        historySequence: 1,\r\n        muxMetadata: {\r\n          type: \"compaction-request\",\r\n          source: \"idle-compaction\",\r\n          rawCommand: \"/compact\",\r\n          parsed: {},\r\n        },\r\n      });\r\n\r\n      await seedHistory(userMessage, idleCompactionReq);\r\n\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.metadata?.compacted;\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\r\n      // Should use the OLD user message timestamp, NOT the fresh compaction request timestamp\r\n      expect(summaryMsg.metadata?.timestamp).toBe(originalTimestamp);\r\n      expect(summaryMsg.metadata?.compacted).toBe(\"idle\");\r\n    });\r\n\r\n    it(\"should use current time for non-idle compaction\", async () => {\r\n      const oldTimestamp = Date.now() - 3600 * 1000; // 1 hour ago\r\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\r\n        timestamp: oldTimestamp,\r\n        historySequence: 0,\r\n      });\r\n      // Regular compaction (not idle)\r\n      const compactionReq = createCompactionRequest();\r\n      await seedHistory(userMessage, compactionReq);\r\n\r\n      const beforeTime = Date.now();\r\n      const event = createStreamEndEvent(\"Summary\");\r\n      await handler.handleCompletion(event);\r\n      const afterTime = Date.now();\r\n\r\n      const summaryEvent = emittedEvents.find((_e) => {\r\n        const m = _e.data.message as MuxMessage | undefined;\r\n        return m?.role === \"assistant\" && m?.metadata?.compacted;\r\n      });\r\n      expect(summaryEvent).toBeDefined();\r\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\r\n      // Should use current time, not the old user message timestamp\r\n      expect(summaryMsg.metadata?.timestamp).toBeGreaterThanOrEqual(beforeTime);\r\n      expect(summaryMsg.metadata?.timestamp).toBeLessThanOrEqual(afterTime);\r\n      expect(summaryMsg.metadata?.compacted).toBe(\"user\");\r\n    });\r\n  });\r\n\r\n  describe(\"Empty Summary Validation\", () => {\r\n    it(\"should reject compaction when summary is empty (stream crashed)\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionRequestMsg);\r\n\r\n      // Empty parts array simulates stream crash before producing content\r\n      const event = createStreamEndEvent(\"\");\r\n\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      // Should return false and NOT perform compaction\r\n      expect(result).toBe(false);\r\n      expect(clearSpy).not.toHaveBeenCalled();\r\n      expect(appendSpy).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject compaction when summary is only whitespace\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const { clearSpy } = await seedHistory(compactionRequestMsg);\r\n\r\n      // Whitespace-only should also be rejected\r\n      const event = createStreamEndEvent(\"   \\n\\t  \");\r\n\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      expect(result).toBe(false);\r\n      expect(clearSpy).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Raw JSON Object Validation\", () => {\r\n    it(\"should reject compaction when summary is a raw JSON object\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionRequestMsg);\r\n\r\n      // Any JSON object should be rejected - this catches all tool call leaks\r\n      const jsonObject = JSON.stringify({\r\n        script: \"cd tpred && sed -n '405,520p' train/trainer.py\",\r\n        timeout_secs: 10,\r\n        run_in_background: false,\r\n        display_name: \"Inspect trainer\",\r\n      });\r\n      const event = createStreamEndEvent(jsonObject);\r\n\r\n      const result = await handler.handleCompletion(event);\r\n\r\n      // Should return false and NOT perform compaction\r\n      expect(result).toBe(false);\r\n      expect(clearSpy).not.toHaveBeenCalled();\r\n      expect(appendSpy).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject any JSON object regardless of structure\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      await seedHistory(compactionRequestMsg);\r\n\r\n      // Even arbitrary JSON objects should be rejected\r\n      const arbitraryJson = JSON.stringify({\r\n        foo: \"bar\",\r\n        nested: { a: 1, b: 2 },\r\n      });\r\n      const event = createStreamEndEvent(arbitraryJson);\r\n\r\n      const result = await handler.handleCompletion(event);\r\n      expect(result).toBe(false);\r\n    });\r\n\r\n    it(\"should accept valid compaction summary text\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      const { appendSpy, clearSpy } = await seedHistory(compactionRequestMsg);\r\n\r\n      // Normal summary text\r\n      const event = createStreamEndEvent(\r\n        \"The user was working on implementing a new feature. Key decisions included using TypeScript.\"\r\n      );\r\n\r\n      const result = await handler.handleCompletion(event);\r\n      expect(result).toBe(true);\r\n      expect(clearSpy).not.toHaveBeenCalled();\r\n      expect(appendSpy).toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should accept summary with embedded JSON as part of prose\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      await seedHistory(compactionRequestMsg);\r\n\r\n      // Prose that contains JSON snippets is fine - only reject pure JSON objects\r\n      const event = createStreamEndEvent(\r\n        'The user configured {\"apiKey\": \"xxx\", \"endpoint\": \"http://localhost\"} in config.json.'\r\n      );\r\n\r\n      const result = await handler.handleCompletion(event);\r\n      expect(result).toBe(true);\r\n    });\r\n\r\n    it(\"should not reject JSON arrays (only objects)\", async () => {\r\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\r\n        historySequence: 0,\r\n        timestamp: Date.now() - 1000,\r\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\r\n      });\r\n      await seedHistory(compactionRequestMsg);\r\n\r\n      // Arrays are not tool calls, so they should pass (even though unusual)\r\n      const event = createStreamEndEvent('[\"item1\", \"item2\"]');\r\n\r\n      const result = await handler.handleCompletion(event);\r\n      expect(result).toBe(true);\r\n    });\r\n  });\r\n});\r\n"]}