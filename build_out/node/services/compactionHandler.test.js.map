{"version":3,"file":"compactionHandler.test.js","sourceRoot":"","sources":["../../../src/node/services/compactionHandler.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach, mock, spyOn } from \"bun:test\";\nimport { CompactionHandler } from \"./compactionHandler\";\nimport type { HistoryService } from \"./historyService\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport type { PartialService } from \"./partialService\";\nimport * as fsPromises from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\nimport type { EventEmitter } from \"events\";\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\nimport type { StreamEndEvent } from \"@/common/types/stream\";\nimport type { TelemetryService } from \"./telemetryService\";\nimport type { TelemetryEventPayload } from \"@/common/telemetry/payload\";\nimport { Ok, Err, type Result } from \"@/common/types/result\";\n\ninterface EmittedEvent {\n  event: string;\n  data: ChatEventData;\n}\n\n// Type guards for emitted events\ninterface ChatEventData {\n  workspaceId: string;\n  message: unknown;\n}\n\nconst createMockPartialService = () => {\n  let deletePartialResult: Result<void, string> = Ok(undefined);\n\n  const deletePartial = mock((_) => Promise.resolve(deletePartialResult));\n  const readPartial = mock((_) => Promise.resolve(null));\n  const writePartial = mock((_, __) => Promise.resolve(Ok(undefined)));\n  const commitToHistory = mock((_) => Promise.resolve(Ok(undefined)));\n\n  return {\n    deletePartial,\n    readPartial,\n    writePartial,\n    commitToHistory,\n    // Allow setting mock return values\n    mockDeletePartial: (result: Result<void, string>) => {\n      deletePartialResult = result;\n    },\n  };\n};\n\nconst createMockEmitter = (): { emitter: EventEmitter; events: EmittedEvent[] } => {\n  const events: EmittedEvent[] = [];\n  const emitter = {\n    emit: (_event: string, data: ChatEventData) => {\n      events.push({ event: _event, data });\n      return true;\n    },\n  };\n  return { emitter: emitter as EventEmitter, events };\n};\n\nconst createCompactionRequest = (id = \"req-1\"): MuxMessage =>\n  createMuxMessage(id, \"user\", \"Please summarize the conversation\", {\n    historySequence: 0,\n    muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n  });\n\nconst createSuccessfulFileEditMessage = (\n  id: string,\n  filePath: string,\n  diff: string,\n  metadata?: MuxMessage[\"metadata\"]\n): MuxMessage => ({\n  id,\n  role: \"assistant\",\n  parts: [\n    {\n      type: \"dynamic-tool\",\n      toolCallId: `tool-${id}`,\n      toolName: \"file_edit_replace_string\",\n      state: \"output-available\",\n      input: { file_path: filePath },\n      output: { success: true, diff },\n    },\n  ],\n  metadata: {\n    timestamp: 1234,\n    ...(metadata ?? {}),\n  },\n});\n\nconst createStreamEndEvent = (\n  summary: string,\n  metadata?: Record<string, unknown>\n): StreamEndEvent => ({\n  type: \"stream-end\",\n  workspaceId: \"test-workspace\",\n  messageId: \"msg-id\",\n  parts: [{ type: \"text\", text: summary }],\n  metadata: {\n    model: \"claude-3-5-sonnet-20241022\",\n    usage: { inputTokens: 100, outputTokens: 50, totalTokens: undefined },\n    duration: 1500,\n    ...metadata,\n  },\n});\n\nconst getEmittedStreamEndEvent = (events: EmittedEvent[]): StreamEndEvent | undefined => {\n  return events\n    .map((event) => event.data.message)\n    .find((message): message is StreamEndEvent => {\n      return (\n        typeof message === \"object\" &&\n        message !== null &&\n        \"type\" in message &&\n        (message as { type?: unknown }).type === \"stream-end\"\n      );\n    });\n};\n\ndescribe(\"CompactionHandler\", () => {\n  let handler: CompactionHandler;\n  let historyService: HistoryService;\n  let cleanup: () => Promise<void>;\n  let mockPartialService: ReturnType<typeof createMockPartialService>;\n  let mockEmitter: EventEmitter;\n  let telemetryCapture: ReturnType<typeof mock>;\n  let telemetryService: TelemetryService;\n  let sessionDir: string;\n  let emittedEvents: EmittedEvent[];\n  const workspaceId = \"test-workspace\";\n\n  // Helper: seed messages into real history and return spies for tracking handler calls.\n  // Spies are created AFTER seeding so they only track handler-initiated calls.\n  const seedHistory = async (...messages: MuxMessage[]) => {\n    for (const msg of messages) {\n      const result = await historyService.appendToHistory(workspaceId, msg);\n      if (!result.success) throw new Error(`Seed failed: ${result.error}`);\n    }\n    return {\n      appendSpy: spyOn(historyService, \"appendToHistory\"),\n      clearSpy: spyOn(historyService, \"clearHistory\"),\n      updateSpy: spyOn(historyService, \"updateHistory\"),\n    };\n  };\n\n  beforeEach(async () => {\n    const testHistory = await createTestHistoryService();\n    historyService = testHistory.historyService;\n    cleanup = testHistory.cleanup;\n\n    const { emitter, events } = createMockEmitter();\n    mockEmitter = emitter;\n    emittedEvents = events;\n\n    telemetryCapture = mock((_payload: TelemetryEventPayload) => {\n      void _payload;\n    });\n    telemetryService = { capture: telemetryCapture } as unknown as TelemetryService;\n\n    sessionDir = await fsPromises.mkdtemp(path.join(os.tmpdir(), \"mux-compaction-handler-\"));\n\n    mockPartialService = createMockPartialService();\n\n    handler = new CompactionHandler({\n      workspaceId,\n      historyService,\n      partialService: mockPartialService as unknown as PartialService,\n      sessionDir,\n      telemetryService,\n      emitter: mockEmitter,\n    });\n  });\n\n  afterEach(async () => {\n    await cleanup();\n  });\n\n  describe(\"handleCompletion() - Normal Compaction Flow\", () => {\n    it(\"should return false when no compaction request found\", async () => {\n      const normalMsg = createMuxMessage(\"msg1\", \"user\", \"Hello\", {\n        historySequence: 0,\n        muxMetadata: { type: \"normal\" },\n      });\n      const { clearSpy } = await seedHistory(normalMsg);\n\n      const event = createStreamEndEvent(\"Summary\");\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(false);\n      expect(clearSpy.mock.calls).toHaveLength(0);\n    });\n\n    it(\"should return false when historyService fails\", async () => {\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(Err(\"Database error\"));\n\n      const event = createStreamEndEvent(\"Summary\");\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(false);\n    });\n\n    it(\"should capture compaction_completed telemetry on successful compaction\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\", {\n        duration: 1500,\n        // Prefer contextUsage (context size) over total usage.\n        contextUsage: { inputTokens: 1000, outputTokens: 333, totalTokens: undefined },\n      });\n\n      await handler.handleCompletion(event);\n\n      expect(telemetryCapture.mock.calls).toHaveLength(1);\n      const payload = telemetryCapture.mock.calls[0][0] as TelemetryEventPayload;\n      expect(payload.event).toBe(\"compaction_completed\");\n      if (payload.event !== \"compaction_completed\") {\n        throw new Error(\"Expected compaction_completed payload\");\n      }\n\n      expect(payload.properties).toEqual({\n        model: \"claude-3-5-sonnet-20241022\",\n        // 1.5s -> 2\n        duration_b2: 2,\n        // 1000 -> 1024\n        input_tokens_b2: 1024,\n        // 333 -> 512\n        output_tokens_b2: 512,\n        compaction_source: \"manual\",\n      });\n    });\n\n    it(\"persists pending diffs to disk and reloads them on restart\", async () => {\n      const compactionReq = createCompactionRequest();\n\n      const fileEditMessage = createSuccessfulFileEditMessage(\n        \"assistant-edit\",\n        \"/tmp/foo.ts\",\n        \"@@ -1 +1 @@\\n-foo\\n+bar\\n\"\n      );\n\n      await seedHistory(fileEditMessage, compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      const handled = await handler.handleCompletion(event);\n      expect(handled).toBe(true);\n\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\n      const raw = await fsPromises.readFile(persistedPath, \"utf-8\");\n      const parsed = JSON.parse(raw) as { version?: unknown; diffs?: unknown };\n      expect(parsed.version).toBe(1);\n\n      const diffs = (parsed as { diffs?: Array<{ path: string; diff: string }> }).diffs;\n      expect(Array.isArray(diffs)).toBe(true);\n      if (Array.isArray(diffs)) {\n        expect(diffs[0]?.path).toBe(\"/tmp/foo.ts\");\n        expect(diffs[0]?.diff).toContain(\"@@ -1 +1 @@\");\n      }\n\n      // Simulate a restart: create a new handler and load from disk.\n      const { emitter: newEmitter } = createMockEmitter();\n      const reloaded = new CompactionHandler({\n        workspaceId,\n        historyService,\n        partialService: mockPartialService as unknown as PartialService,\n        sessionDir,\n        telemetryService,\n        emitter: newEmitter,\n      });\n\n      const pending = await reloaded.peekPendingDiffs();\n      expect(pending).not.toBeNull();\n      expect(pending?.[0]?.path).toBe(\"/tmp/foo.ts\");\n\n      await reloaded.ackPendingDiffsConsumed();\n\n      let exists = true;\n      try {\n        await fsPromises.stat(persistedPath);\n      } catch {\n        exists = false;\n      }\n      expect(exists).toBe(false);\n    });\n\n    it(\"persists only latest-epoch diffs when a durable compaction boundary exists\", async () => {\n      const staleEditMessage = createSuccessfulFileEditMessage(\n        \"assistant-stale-edit\",\n        \"/tmp/stale.ts\",\n        \"@@ -1 +1 @@\\n-old\\n+stale\\n\",\n        { historySequence: 0 }\n      );\n      const latestBoundary = createMuxMessage(\"summary-boundary\", \"assistant\", \"Older summary\", {\n        historySequence: 1,\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      });\n      const recentEditMessage = createSuccessfulFileEditMessage(\n        \"assistant-recent-edit\",\n        \"/tmp/recent.ts\",\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\",\n        { historySequence: 2 }\n      );\n      const compactionReq = createMuxMessage(\"req-latest-epoch\", \"user\", \"Please summarize\", {\n        historySequence: 3,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n\n      await seedHistory(staleEditMessage, latestBoundary, recentEditMessage, compactionReq);\n\n      const handled = await handler.handleCompletion(createStreamEndEvent(\"Summary\"));\n      expect(handled).toBe(true);\n\n      const pending = await handler.peekPendingDiffs();\n      expect(pending?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\"]);\n\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\n      const raw = await fsPromises.readFile(persistedPath, \"utf-8\");\n      const parsed = JSON.parse(raw) as { diffs?: Array<{ path: string }> };\n      expect(parsed.diffs?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\"]);\n    });\n\n    it(\"falls back to full-history diff extraction when boundary marker is malformed\", async () => {\n      const staleEditMessage = createSuccessfulFileEditMessage(\n        \"assistant-stale-edit\",\n        \"/tmp/stale.ts\",\n        \"@@ -1 +1 @@\\n-old\\n+stale\\n\",\n        { historySequence: 0 }\n      );\n      const malformedBoundaryMissingEpoch = createMuxMessage(\n        \"summary-malformed-boundary\",\n        \"assistant\",\n        \"Malformed summary\",\n        {\n          historySequence: 1,\n          compacted: \"user\",\n          compactionBoundary: true,\n          // Missing compactionEpoch should be treated as malformed and ignored.\n        }\n      );\n      const recentEditMessage = createSuccessfulFileEditMessage(\n        \"assistant-recent-edit\",\n        \"/tmp/recent.ts\",\n        \"@@ -1 +1 @@\\n-before\\n+after\\n\",\n        { historySequence: 2 }\n      );\n      const compactionReq = createMuxMessage(\"req-malformed-boundary\", \"user\", \"Please summarize\", {\n        historySequence: 3,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n\n      await seedHistory(\n        staleEditMessage,\n        malformedBoundaryMissingEpoch,\n        recentEditMessage,\n        compactionReq\n      );\n\n      const handled = await handler.handleCompletion(createStreamEndEvent(\"Summary\"));\n      expect(handled).toBe(true);\n\n      const pending = await handler.peekPendingDiffs();\n      expect(pending?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\", \"/tmp/stale.ts\"]);\n\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\n      const raw = await fsPromises.readFile(persistedPath, \"utf-8\");\n      const parsed = JSON.parse(raw) as { diffs?: Array<{ path: string }> };\n      expect(parsed.diffs?.map((diff) => diff.path)).toEqual([\"/tmp/recent.ts\", \"/tmp/stale.ts\"]);\n    });\n    it(\"should return true when successful\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Complete summary\");\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(true);\n    });\n\n    it(\"should join multiple text parts from event.parts\", async () => {\n      const compactionReq = createCompactionRequest();\n      const { appendSpy } = await seedHistory(compactionReq);\n\n      // Create event with multiple text parts\n      const event: StreamEndEvent = {\n        type: \"stream-end\",\n        workspaceId: \"test-workspace\",\n        messageId: \"msg-id\",\n        parts: [\n          { type: \"text\", text: \"Part 1 \" },\n          { type: \"text\", text: \"Part 2 \" },\n          { type: \"text\", text: \"Part 3\" },\n        ],\n        metadata: {\n          model: \"claude-3-5-sonnet-20241022\",\n          usage: { inputTokens: 100, outputTokens: 50, totalTokens: undefined },\n          duration: 1500,\n        },\n      };\n      await handler.handleCompletion(event);\n\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect((appendedMsg.parts[0] as { type: \"text\"; text: string }).text).toBe(\n        \"Part 1 Part 2 Part 3\"\n      );\n    });\n\n    it(\"should extract summary text from event.parts\", async () => {\n      const compactionReq = createCompactionRequest();\n      const { appendSpy } = await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"This is the summary\");\n      await handler.handleCompletion(event);\n\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect((appendedMsg.parts[0] as { type: \"text\"; text: string }).text).toBe(\n        \"This is the summary\"\n      );\n    });\n\n    it(\"should delete partial.json before appending summary (race condition fix)\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      // deletePartial should be called once before appendToHistory\n      expect(mockPartialService.deletePartial.mock.calls).toHaveLength(1);\n      expect(mockPartialService.deletePartial.mock.calls[0][0]).toBe(workspaceId);\n\n      // Verify deletePartial was called (we can't easily verify order without more complex mocking,\n      // but the important thing is that it IS called during compaction)\n    });\n\n    it(\"should append summary without clearing history\", async () => {\n      const compactionReq = createCompactionRequest();\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      expect(clearSpy.mock.calls).toHaveLength(0);\n      expect(appendSpy.mock.calls).toHaveLength(1);\n      expect(appendSpy.mock.calls[0][0]).toBe(workspaceId);\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect(appendedMsg.role).toBe(\"assistant\");\n      expect((appendedMsg.parts[0] as { type: \"text\"; text: string }).text).toBe(\"Summary\");\n    });\n\n    it(\"should not emit delete events when compaction is append-only\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const deleteEvent = emittedEvents.find(\n        (_e) => (_e.data.message as { type?: string })?.type === \"delete\"\n      );\n      expect(deleteEvent).toBeUndefined();\n    });\n\n    it(\"should emit summary message with complete metadata\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const usage = { inputTokens: 200, outputTokens: 100, totalTokens: 300 };\n      const event = createStreamEndEvent(\"Summary\", {\n        model: \"claude-3-5-sonnet-20241022\",\n        usage,\n        duration: 2000,\n        providerMetadata: { anthropic: { cacheCreationInputTokens: 50000 } },\n        systemMessageTokens: 100,\n      });\n      await handler.handleCompletion(event);\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.parts !== undefined;\n      });\n      expect(summaryEvent).toBeDefined();\n      const sevt = summaryEvent?.data.message as MuxMessage;\n      // providerMetadata is omitted to avoid inflating context with pre-compaction cacheCreationInputTokens\n      expect(sevt.metadata).toMatchObject({\n        model: \"claude-3-5-sonnet-20241022\",\n        usage,\n        duration: 2000,\n        systemMessageTokens: 100,\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 1,\n      });\n      expect(sevt.metadata?.providerMetadata).toBeUndefined();\n    });\n\n    it(\"should emit stream-end event to frontend\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\", { duration: 1234 });\n      await handler.handleCompletion(event);\n\n      const streamMsg = getEmittedStreamEndEvent(emittedEvents);\n      expect(streamMsg).toBeDefined();\n      expect(streamMsg?.workspaceId).toBe(workspaceId);\n      expect(streamMsg?.metadata.duration).toBe(1234);\n    });\n\n    it(\"should set boundary metadata and keep historySequence monotonic\", async () => {\n      const priorMessage = createMuxMessage(\"user-1\", \"user\", \"Earlier\", {\n        historySequence: 4,\n      });\n      const compactionReq = createMuxMessage(\"req-1\", \"user\", \"Please summarize\", {\n        historySequence: 5,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const { appendSpy } = await seedHistory(priorMessage, compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect(appendedMsg.metadata?.compacted).toBe(\"user\");\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(1);\n      expect(appendedMsg.metadata?.historySequence).toBe(6);\n    });\n    it(\"should ignore malformed persisted historySequence values when deriving monotonic bounds\", async () => {\n      const malformedNegativeSequence = createMuxMessage(\n        \"assistant-malformed-negative-sequence\",\n        \"assistant\",\n        \"Corrupted persisted metadata\",\n        {\n          historySequence: -7,\n        }\n      );\n      const malformedFractionalSequence = createMuxMessage(\n        \"assistant-malformed-fractional-sequence\",\n        \"assistant\",\n        \"Corrupted persisted metadata\",\n        {\n          historySequence: 99.5,\n        }\n      );\n      const priorMessage = createMuxMessage(\"user-1\", \"user\", \"Earlier\", {\n        historySequence: 4,\n      });\n      const compactionReq = createMuxMessage(\"req-1\", \"user\", \"Please summarize\", {\n        historySequence: 5,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n\n      // Seed valid messages so the service's sequence counter advances to 6,\n      // then mock getLastMessages to inject the malformed messages alongside them.\n      // The malformed historySequence values (-7, 99.5) would fail real appendToHistory assertions,\n      // so they can only be introduced via the mocked read path.\n      await historyService.appendToHistory(workspaceId, priorMessage);\n      await historyService.appendToHistory(workspaceId, compactionReq);\n      spyOn(historyService, \"getLastMessages\").mockResolvedValueOnce(\n        Ok([malformedNegativeSequence, malformedFractionalSequence, priorMessage, compactionReq])\n      );\n      const appendSpy = spyOn(historyService, \"appendToHistory\");\n\n      const event = createStreamEndEvent(\"Summary\");\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(true);\n      expect(appendSpy.mock.calls).toHaveLength(1);\n\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect(appendedMsg.metadata?.historySequence).toBe(6);\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(1);\n    });\n\n    it(\"should derive next compaction epoch from legacy compacted summaries\", async () => {\n      const legacySummary = createMuxMessage(\"summary-legacy\", \"assistant\", \"Older summary\", {\n        historySequence: 2,\n        compacted: \"user\",\n      });\n      const compactionReq = createMuxMessage(\"req-epoch\", \"user\", \"Please summarize\", {\n        historySequence: 3,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n\n      const { appendSpy } = await seedHistory(legacySummary, compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(2);\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\n      expect(appendedMsg.metadata?.historySequence).toBe(4);\n    });\n\n    it(\"should update streamed summaries in-place without carrying stale provider metadata\", async () => {\n      const compactionReq = createMuxMessage(\"req-streamed\", \"user\", \"Please summarize\", {\n        historySequence: 5,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const streamedSummary = createMuxMessage(\"msg-id\", \"assistant\", \"Summary\", {\n        historySequence: 6,\n        timestamp: Date.now(),\n        model: \"claude-3-5-sonnet-20241022\",\n        providerMetadata: { anthropic: { cacheCreationInputTokens: 50_000 } },\n        contextProviderMetadata: { anthropic: { cacheReadInputTokens: 10_000 } },\n      });\n\n      const { appendSpy, updateSpy } = await seedHistory(compactionReq, streamedSummary);\n\n      const event = createStreamEndEvent(\"Summary\");\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(true);\n      expect(updateSpy.mock.calls).toHaveLength(1);\n      expect(appendSpy.mock.calls).toHaveLength(0);\n\n      const updatedSummary = updateSpy.mock.calls[0][1];\n      expect(updatedSummary.id).toBe(\"msg-id\");\n      expect(updatedSummary.metadata?.historySequence).toBe(6);\n      expect(updatedSummary.metadata?.compactionBoundary).toBe(true);\n      expect(updatedSummary.metadata?.compactionEpoch).toBe(1);\n      expect(updatedSummary.metadata?.providerMetadata).toBeUndefined();\n      expect(updatedSummary.metadata?.contextProviderMetadata).toBeUndefined();\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.id === \"msg-id\" && m?.metadata?.compactionBoundary === true;\n      });\n      expect(summaryEvent).toBeDefined();\n    });\n\n    it(\"should strip stale provider metadata from emitted stream-end when reusing streamed summary ID\", async () => {\n      const compactionReq = createMuxMessage(\"req-streamed-sanitize\", \"user\", \"Please summarize\", {\n        historySequence: 5,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const streamedSummary = createMuxMessage(\"msg-id\", \"assistant\", \"Summary\", {\n        historySequence: 6,\n        timestamp: Date.now(),\n        model: \"claude-3-5-sonnet-20241022\",\n      });\n\n      await seedHistory(compactionReq, streamedSummary);\n\n      const event = createStreamEndEvent(\"Summary\", {\n        providerMetadata: { anthropic: { cacheCreationInputTokens: 50_000 } },\n        contextProviderMetadata: { anthropic: { cacheReadInputTokens: 10_000 } },\n        customField: \"preserved\",\n      });\n\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(true);\n      const streamMsg = getEmittedStreamEndEvent(emittedEvents);\n      expect(streamMsg).toBeDefined();\n      expect(streamMsg?.messageId).toBe(\"msg-id\");\n      expect(streamMsg?.metadata.providerMetadata).toBeUndefined();\n      expect(streamMsg?.metadata.contextProviderMetadata).toBeUndefined();\n      expect((streamMsg?.metadata as Record<string, unknown> | undefined)?.customField).toBe(\n        \"preserved\"\n      );\n    });\n\n    it(\"should skip malformed compaction boundary markers when deriving next epoch\", async () => {\n      const validBoundary = createMuxMessage(\"summary-valid\", \"assistant\", \"Valid summary\", {\n        historySequence: 1,\n        compacted: \"user\",\n        compactionBoundary: true,\n        compactionEpoch: 3,\n      });\n      const malformedBoundaryMissingEpoch = createMuxMessage(\n        \"summary-malformed-1\",\n        \"assistant\",\n        \"Malformed boundary\",\n        {\n          historySequence: 2,\n          compacted: \"user\",\n          compactionBoundary: true,\n        }\n      );\n      const malformedBoundaryMissingCompacted = createMuxMessage(\n        \"summary-malformed-2\",\n        \"assistant\",\n        \"Malformed boundary\",\n        {\n          historySequence: 3,\n          compactionBoundary: true,\n          compactionEpoch: 99,\n        }\n      );\n      const malformedBoundaryInvalidCompacted = createMuxMessage(\n        \"summary-malformed-invalid-compacted\",\n        \"assistant\",\n        \"Malformed boundary\",\n        {\n          historySequence: 4,\n          compactionBoundary: true,\n          compactionEpoch: 200,\n        }\n      );\n      if (malformedBoundaryInvalidCompacted.metadata) {\n        (malformedBoundaryInvalidCompacted.metadata as Record<string, unknown>).compacted =\n          \"corrupted\";\n      }\n      const malformedBoundaryInvalidEpoch = createMuxMessage(\n        \"summary-malformed-3\",\n        \"assistant\",\n        \"Malformed boundary\",\n        {\n          historySequence: 4,\n          compacted: \"user\",\n          compactionBoundary: true,\n          compactionEpoch: 0,\n        }\n      );\n      const compactionReq = createMuxMessage(\"req-malformed\", \"user\", \"Please summarize\", {\n        historySequence: 5,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n\n      const { appendSpy } = await seedHistory(\n        validBoundary,\n        malformedBoundaryMissingEpoch,\n        malformedBoundaryMissingCompacted,\n        malformedBoundaryInvalidCompacted,\n        malformedBoundaryInvalidEpoch,\n        compactionReq\n      );\n\n      const result = await handler.handleCompletion(createStreamEndEvent(\"Summary\"));\n\n      expect(result).toBe(true);\n      expect(appendSpy.mock.calls).toHaveLength(1);\n      const appendedMsg = appendSpy.mock.calls[0][1];\n      expect(appendedMsg.metadata?.compactionEpoch).toBe(4);\n      expect(appendedMsg.metadata?.compactionBoundary).toBe(true);\n    });\n  });\n\n  describe(\"handleCompletion() - Deduplication\", () => {\n    it(\"should track processed compaction-request IDs\", async () => {\n      const compactionReq = createCompactionRequest(\"req-unique\");\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      expect(clearSpy.mock.calls).toHaveLength(0);\n      expect(appendSpy.mock.calls).toHaveLength(1);\n    });\n\n    it(\"should return true without re-processing when same request ID seen twice\", async () => {\n      const compactionReq = createCompactionRequest(\"req-dupe\");\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      const result1 = await handler.handleCompletion(event);\n      const result2 = await handler.handleCompletion(event);\n\n      expect(result1).toBe(true);\n      expect(result2).toBe(true);\n      expect(clearSpy.mock.calls).toHaveLength(0);\n      expect(appendSpy.mock.calls).toHaveLength(1);\n    });\n\n    it(\"should not emit duplicate events\", async () => {\n      const compactionReq = createCompactionRequest(\"req-dupe-2\");\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n      const eventCountAfterFirst = emittedEvents.length;\n\n      await handler.handleCompletion(event);\n      const eventCountAfterSecond = emittedEvents.length;\n\n      expect(eventCountAfterSecond).toBe(eventCountAfterFirst);\n    });\n\n    it(\"should not append summary twice\", async () => {\n      const compactionReq = createCompactionRequest(\"req-dupe-3\");\n      const { appendSpy, clearSpy } = await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n      await handler.handleCompletion(event);\n\n      expect(clearSpy.mock.calls).toHaveLength(0);\n      expect(appendSpy.mock.calls).toHaveLength(1);\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"should return false when appendToHistory() fails\", async () => {\n      const compactionReq = createCompactionRequest();\n      const { appendSpy } = await seedHistory(compactionReq);\n      appendSpy.mockResolvedValueOnce(Err(\"Append failed\"));\n\n      const event = createStreamEndEvent(\"Summary\");\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(false);\n\n      // Ensure we don't keep a persisted snapshot when summary append fails.\n      const persistedPath = path.join(sessionDir, \"post-compaction.json\");\n      let exists = true;\n      try {\n        await fsPromises.stat(persistedPath);\n      } catch {\n        exists = false;\n      }\n      expect(exists).toBe(false);\n    });\n\n    it(\"should log errors but not throw\", async () => {\n      const compactionReq = createCompactionRequest();\n      const { appendSpy } = await seedHistory(compactionReq);\n      appendSpy.mockResolvedValueOnce(Err(\"Database corruption\"));\n\n      const event = createStreamEndEvent(\"Summary\");\n\n      // Should not throw\n      const result = await handler.handleCompletion(event);\n      expect(result).toBe(false);\n    });\n\n    it(\"should not emit events when compaction fails mid-process\", async () => {\n      const compactionReq = createCompactionRequest();\n      const { appendSpy } = await seedHistory(compactionReq);\n      appendSpy.mockResolvedValueOnce(Err(\"Append failed\"));\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      expect(emittedEvents).toHaveLength(0);\n    });\n  });\n\n  describe(\"Event Emission\", () => {\n    it(\"should include workspaceId in all chat-event emissions\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const chatEvents = emittedEvents.filter((e) => e.event === \"chat-event\");\n      expect(chatEvents.length).toBeGreaterThan(0);\n      chatEvents.forEach((e) => {\n        expect(e.data.workspaceId).toBe(workspaceId);\n      });\n    });\n\n    it(\"should not emit DeleteMessage events during append-only compaction\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const deleteEvent = emittedEvents.find(\n        (_e) => (_e.data.message as { type?: string })?.type === \"delete\"\n      );\n      expect(deleteEvent).toBeUndefined();\n    });\n\n    it(\"should emit summary message with proper MuxMessage structure\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary text\");\n      await handler.handleCompletion(event);\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.parts !== undefined;\n      });\n      expect(summaryEvent).toBeDefined();\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\n      expect(summaryMsg).toMatchObject({\n        id: expect.stringContaining(\"summary-\") as string,\n        role: \"assistant\",\n        parts: [{ type: \"text\", text: \"Summary text\" }],\n        metadata: expect.objectContaining({\n          compacted: \"user\",\n          compactionBoundary: true,\n          compactionEpoch: 1,\n          muxMetadata: { type: \"compaction-summary\" },\n        }) as MuxMessage[\"metadata\"],\n      });\n    });\n\n    it(\"should forward stream events (stream-end, stream-abort) correctly\", async () => {\n      const compactionReq = createCompactionRequest();\n      await seedHistory(compactionReq);\n\n      const event = createStreamEndEvent(\"Summary\", { customField: \"test\" });\n      await handler.handleCompletion(event);\n\n      const streamMsg = getEmittedStreamEndEvent(emittedEvents);\n      expect(streamMsg).toBeDefined();\n      expect((streamMsg?.metadata as Record<string, unknown> | undefined)?.customField).toBe(\n        \"test\"\n      );\n    });\n  });\n\n  describe(\"Idle Compaction\", () => {\n    it(\"should preserve original recency timestamp from last user message\", async () => {\n      const originalTimestamp = Date.now() - 3600 * 1000; // 1 hour ago\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\n        timestamp: originalTimestamp,\n        historySequence: 0,\n      });\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\n        historySequence: 1,\n        muxMetadata: {\n          type: \"compaction-request\",\n          source: \"idle-compaction\",\n          rawCommand: \"/compact\",\n          parsed: {},\n        },\n      });\n\n      await seedHistory(userMessage, idleCompactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.metadata?.compacted;\n      });\n      expect(summaryEvent).toBeDefined();\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\n      expect(summaryMsg.metadata?.timestamp).toBe(originalTimestamp);\n      expect(summaryMsg.metadata?.compacted).toBe(\"idle\");\n    });\n\n    it(\"should preserve recency from last compacted message if no user message\", async () => {\n      const compactedTimestamp = Date.now() - 7200 * 1000; // 2 hours ago\n      const compactedMessage = createMuxMessage(\"compacted-1\", \"assistant\", \"Previous summary\", {\n        timestamp: compactedTimestamp,\n        compacted: \"user\",\n        historySequence: 0,\n      });\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\n        historySequence: 1,\n        muxMetadata: {\n          type: \"compaction-request\",\n          source: \"idle-compaction\",\n          rawCommand: \"/compact\",\n          parsed: {},\n        },\n      });\n\n      await seedHistory(compactedMessage, idleCompactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.metadata?.compacted === \"idle\";\n      });\n      expect(summaryEvent).toBeDefined();\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\n      expect(summaryMsg.metadata?.timestamp).toBe(compactedTimestamp);\n    });\n\n    it(\"should use max of user and compacted timestamps\", async () => {\n      const olderCompactedTimestamp = Date.now() - 7200 * 1000; // 2 hours ago\n      const newerUserTimestamp = Date.now() - 3600 * 1000; // 1 hour ago\n      const compactedMessage = createMuxMessage(\"compacted-1\", \"assistant\", \"Previous summary\", {\n        timestamp: olderCompactedTimestamp,\n        compacted: \"user\",\n        historySequence: 0,\n      });\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\n        timestamp: newerUserTimestamp,\n        historySequence: 1,\n      });\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\n        historySequence: 2,\n        muxMetadata: {\n          type: \"compaction-request\",\n          source: \"idle-compaction\",\n          rawCommand: \"/compact\",\n          parsed: {},\n        },\n      });\n\n      await seedHistory(compactedMessage, userMessage, idleCompactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.metadata?.compacted === \"idle\";\n      });\n      expect(summaryEvent).toBeDefined();\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\n      // Should use the newer timestamp (user message)\n      expect(summaryMsg.metadata?.timestamp).toBe(newerUserTimestamp);\n    });\n\n    it(\"should skip compaction-request message when finding timestamp to preserve\", async () => {\n      const originalTimestamp = Date.now() - 3600 * 1000; // 1 hour ago - the real user message\n      const freshTimestamp = Date.now(); // The compaction request has a fresh timestamp\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\n        timestamp: originalTimestamp,\n        historySequence: 0,\n      });\n      // Idle compaction request WITH a timestamp (as happens in production)\n      const idleCompactionReq = createMuxMessage(\"req-1\", \"user\", \"Summarize\", {\n        timestamp: freshTimestamp,\n        historySequence: 1,\n        muxMetadata: {\n          type: \"compaction-request\",\n          source: \"idle-compaction\",\n          rawCommand: \"/compact\",\n          parsed: {},\n        },\n      });\n\n      await seedHistory(userMessage, idleCompactionReq);\n\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.metadata?.compacted;\n      });\n      expect(summaryEvent).toBeDefined();\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\n      // Should use the OLD user message timestamp, NOT the fresh compaction request timestamp\n      expect(summaryMsg.metadata?.timestamp).toBe(originalTimestamp);\n      expect(summaryMsg.metadata?.compacted).toBe(\"idle\");\n    });\n\n    it(\"should use current time for non-idle compaction\", async () => {\n      const oldTimestamp = Date.now() - 3600 * 1000; // 1 hour ago\n      const userMessage = createMuxMessage(\"user-1\", \"user\", \"Hello\", {\n        timestamp: oldTimestamp,\n        historySequence: 0,\n      });\n      // Regular compaction (not idle)\n      const compactionReq = createCompactionRequest();\n      await seedHistory(userMessage, compactionReq);\n\n      const beforeTime = Date.now();\n      const event = createStreamEndEvent(\"Summary\");\n      await handler.handleCompletion(event);\n      const afterTime = Date.now();\n\n      const summaryEvent = emittedEvents.find((_e) => {\n        const m = _e.data.message as MuxMessage | undefined;\n        return m?.role === \"assistant\" && m?.metadata?.compacted;\n      });\n      expect(summaryEvent).toBeDefined();\n      const summaryMsg = summaryEvent?.data.message as MuxMessage;\n      // Should use current time, not the old user message timestamp\n      expect(summaryMsg.metadata?.timestamp).toBeGreaterThanOrEqual(beforeTime);\n      expect(summaryMsg.metadata?.timestamp).toBeLessThanOrEqual(afterTime);\n      expect(summaryMsg.metadata?.compacted).toBe(\"user\");\n    });\n  });\n\n  describe(\"Empty Summary Validation\", () => {\n    it(\"should reject compaction when summary is empty (stream crashed)\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const { appendSpy, clearSpy } = await seedHistory(compactionRequestMsg);\n\n      // Empty parts array simulates stream crash before producing content\n      const event = createStreamEndEvent(\"\");\n\n      const result = await handler.handleCompletion(event);\n\n      // Should return false and NOT perform compaction\n      expect(result).toBe(false);\n      expect(clearSpy).not.toHaveBeenCalled();\n      expect(appendSpy).not.toHaveBeenCalled();\n    });\n\n    it(\"should reject compaction when summary is only whitespace\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const { clearSpy } = await seedHistory(compactionRequestMsg);\n\n      // Whitespace-only should also be rejected\n      const event = createStreamEndEvent(\"   \\n\\t  \");\n\n      const result = await handler.handleCompletion(event);\n\n      expect(result).toBe(false);\n      expect(clearSpy).not.toHaveBeenCalled();\n    });\n  });\n\n  describe(\"Raw JSON Object Validation\", () => {\n    it(\"should reject compaction when summary is a raw JSON object\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const { appendSpy, clearSpy } = await seedHistory(compactionRequestMsg);\n\n      // Any JSON object should be rejected - this catches all tool call leaks\n      const jsonObject = JSON.stringify({\n        script: \"cd tpred && sed -n '405,520p' train/trainer.py\",\n        timeout_secs: 10,\n        run_in_background: false,\n        display_name: \"Inspect trainer\",\n      });\n      const event = createStreamEndEvent(jsonObject);\n\n      const result = await handler.handleCompletion(event);\n\n      // Should return false and NOT perform compaction\n      expect(result).toBe(false);\n      expect(clearSpy).not.toHaveBeenCalled();\n      expect(appendSpy).not.toHaveBeenCalled();\n    });\n\n    it(\"should reject any JSON object regardless of structure\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      await seedHistory(compactionRequestMsg);\n\n      // Even arbitrary JSON objects should be rejected\n      const arbitraryJson = JSON.stringify({\n        foo: \"bar\",\n        nested: { a: 1, b: 2 },\n      });\n      const event = createStreamEndEvent(arbitraryJson);\n\n      const result = await handler.handleCompletion(event);\n      expect(result).toBe(false);\n    });\n\n    it(\"should accept valid compaction summary text\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      const { appendSpy, clearSpy } = await seedHistory(compactionRequestMsg);\n\n      // Normal summary text\n      const event = createStreamEndEvent(\n        \"The user was working on implementing a new feature. Key decisions included using TypeScript.\"\n      );\n\n      const result = await handler.handleCompletion(event);\n      expect(result).toBe(true);\n      expect(clearSpy).not.toHaveBeenCalled();\n      expect(appendSpy).toHaveBeenCalled();\n    });\n\n    it(\"should accept summary with embedded JSON as part of prose\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      await seedHistory(compactionRequestMsg);\n\n      // Prose that contains JSON snippets is fine - only reject pure JSON objects\n      const event = createStreamEndEvent(\n        'The user configured {\"apiKey\": \"xxx\", \"endpoint\": \"http://localhost\"} in config.json.'\n      );\n\n      const result = await handler.handleCompletion(event);\n      expect(result).toBe(true);\n    });\n\n    it(\"should not reject JSON arrays (only objects)\", async () => {\n      const compactionRequestMsg = createMuxMessage(\"compact-req-1\", \"user\", \"/compact\", {\n        historySequence: 0,\n        timestamp: Date.now() - 1000,\n        muxMetadata: { type: \"compaction-request\", rawCommand: \"/compact\", parsed: {} },\n      });\n      await seedHistory(compactionRequestMsg);\n\n      // Arrays are not tool calls, so they should pass (even though unusual)\n      const event = createStreamEndEvent('[\"item1\", \"item2\"]');\n\n      const result = await handler.handleCompletion(event);\n      expect(result).toBe(true);\n    });\n  });\n});\n"]}