{"version":3,"file":"agentSession.changeDetection.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.changeDetection.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from \"bun:test\";\r\nimport { mkdtemp, writeFile, rm, utimes, stat } from \"fs/promises\";\r\nimport { join } from \"path\";\r\nimport { tmpdir } from \"os\";\r\nimport { FileChangeTracker } from \"@/node/services/utils/fileChangeTracker\";\r\nimport { computeDiff } from \"@/node/utils/diff\";\r\n\r\n/**\r\n * Tests for external file change detection via FileChangeTracker.\r\n *\r\n * Pattern: timestamp-based polling with diff injection\r\n * 1. Track file state (content + mtime) when reading/writing files\r\n * 2. Poll before each LLM query to detect external modifications\r\n * 3. Compute diff and inject as context attachment if changed\r\n */\r\n\r\ndescribe(\"AgentSession change detection\", () => {\r\n  let tmpDir: string;\r\n\r\n  beforeEach(async () => {\r\n    tmpDir = await mkdtemp(join(tmpdir(), \"mux-change-detection-test-\"));\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await rm(tmpDir, { recursive: true, force: true });\r\n  });\r\n\r\n  // Helper to get mtime for a file\r\n  async function getMtime(filePath: string): Promise<number> {\r\n    return (await stat(filePath)).mtimeMs;\r\n  }\r\n\r\n  describe(\"FileChangeTracker\", () => {\r\n    it(\"should detect no changes when file unchanged\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const testFile = join(tmpDir, \"plan.md\");\r\n      const content = \"# Plan\\n\\n## Step 1\\n\\nDo something\";\r\n\r\n      await writeFile(testFile, content);\r\n      const mtime = await getMtime(testFile);\r\n\r\n      // Record initial state\r\n      tracker.record(testFile, { content, timestamp: mtime });\r\n\r\n      // Check for changes - should be empty since file is unchanged\r\n      const attachments = await tracker.getChangedAttachments();\r\n      expect(attachments).toHaveLength(0);\r\n    });\r\n\r\n    it(\"should detect changes when file content modified externally\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const testFile = join(tmpDir, \"plan.md\");\r\n      const originalContent = \"# Plan\\n\\n## Step 1\\n\\nDo something\";\r\n\r\n      await writeFile(testFile, originalContent);\r\n      const originalMtime = await getMtime(testFile);\r\n\r\n      // Record initial state\r\n      tracker.record(testFile, { content: originalContent, timestamp: originalMtime });\r\n\r\n      // Simulate external edit (wait briefly to ensure mtime changes)\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n      const modifiedContent = \"# Plan\\n\\n## Step 1\\n\\nDo something better\\n\\n## Step 2\\n\\nNew step\";\r\n      await writeFile(testFile, modifiedContent);\r\n\r\n      // Update mtime to be in the future to simulate external edit\r\n      const newMtime = Date.now() + 1000;\r\n      await utimes(testFile, newMtime / 1000, newMtime / 1000);\r\n\r\n      // Check for changes - should detect the modification\r\n      const attachments = await tracker.getChangedAttachments();\r\n\r\n      expect(attachments).toHaveLength(1);\r\n      expect(attachments[0].type).toBe(\"edited_text_file\");\r\n      expect(attachments[0].filename).toBe(testFile);\r\n      expect(attachments[0].snippet).toContain(\"Do something better\");\r\n      expect(attachments[0].snippet).toContain(\"Step 2\");\r\n      expect(attachments[0].snippet).toContain(\"New step\");\r\n    });\r\n\r\n    it(\"should update stored state after detecting change\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const testFile = join(tmpDir, \"plan.md\");\r\n      const originalContent = \"# Original\";\r\n\r\n      await writeFile(testFile, originalContent);\r\n      const originalMtime = await getMtime(testFile);\r\n\r\n      tracker.record(testFile, { content: originalContent, timestamp: originalMtime });\r\n\r\n      // Modify file\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n      const modifiedContent = \"# Modified\";\r\n      await writeFile(testFile, modifiedContent);\r\n      const newMtime = Date.now() + 1000;\r\n      await utimes(testFile, newMtime / 1000, newMtime / 1000);\r\n\r\n      // First detection\r\n      const firstCheck = await tracker.getChangedAttachments();\r\n      expect(firstCheck).toHaveLength(1);\r\n\r\n      // Second check without further changes - should be empty\r\n      // because state was updated after first detection\r\n      const secondCheck = await tracker.getChangedAttachments();\r\n      expect(secondCheck).toHaveLength(0);\r\n    });\r\n\r\n    it(\"should return empty when file deleted\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const testFile = join(tmpDir, \"plan.md\");\r\n      const content = \"# Plan\";\r\n\r\n      await writeFile(testFile, content);\r\n      const mtime = await getMtime(testFile);\r\n\r\n      tracker.record(testFile, { content, timestamp: mtime });\r\n\r\n      // Delete the file\r\n      await rm(testFile);\r\n\r\n      // Should gracefully handle deleted file\r\n      const attachments = await tracker.getChangedAttachments();\r\n      expect(attachments).toHaveLength(0);\r\n    });\r\n\r\n    it(\"should detect changes across multiple tracked files\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const file1 = join(tmpDir, \"plan.md\");\r\n      const file2 = join(tmpDir, \"notes.md\");\r\n      const file3 = join(tmpDir, \"unchanged.md\");\r\n\r\n      await writeFile(file1, \"Original 1\");\r\n      await writeFile(file2, \"Original 2\");\r\n      await writeFile(file3, \"Original 3\");\r\n\r\n      const mtime1 = await getMtime(file1);\r\n      const mtime2 = await getMtime(file2);\r\n      const mtime3 = await getMtime(file3);\r\n\r\n      tracker.record(file1, { content: \"Original 1\", timestamp: mtime1 });\r\n      tracker.record(file2, { content: \"Original 2\", timestamp: mtime2 });\r\n      tracker.record(file3, { content: \"Original 3\", timestamp: mtime3 });\r\n\r\n      // Modify only files 1 and 2\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n      await writeFile(file1, \"Modified 1\");\r\n      await writeFile(file2, \"Modified 2\");\r\n      const newMtime = Date.now() + 1000;\r\n      await utimes(file1, newMtime / 1000, newMtime / 1000);\r\n      await utimes(file2, newMtime / 1000, newMtime / 1000);\r\n\r\n      const attachments = await tracker.getChangedAttachments();\r\n\r\n      expect(attachments).toHaveLength(2);\r\n      const filenames = attachments.map((a) => a.filename);\r\n      expect(filenames).toContain(file1);\r\n      expect(filenames).toContain(file2);\r\n      expect(filenames).not.toContain(file3);\r\n    });\r\n\r\n    it(\"should ignore mtime change when content identical (touch scenario)\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const testFile = join(tmpDir, \"plan.md\");\r\n      const content = \"# Plan unchanged\";\r\n\r\n      await writeFile(testFile, content);\r\n      const originalMtime = await getMtime(testFile);\r\n\r\n      tracker.record(testFile, { content, timestamp: originalMtime });\r\n\r\n      // Update only mtime (like 'touch' command) without changing content\r\n      const newMtime = Date.now() + 1000;\r\n      await utimes(testFile, newMtime / 1000, newMtime / 1000);\r\n\r\n      // Should not report change since content is identical\r\n      const attachments = await tracker.getChangedAttachments();\r\n      expect(attachments).toHaveLength(0);\r\n    });\r\n\r\n    it(\"should produce valid unified diff format\", async () => {\r\n      const tracker = new FileChangeTracker();\r\n      const testFile = join(tmpDir, \"plan.md\");\r\n      const originalContent = \"line 1\\nline 2\\nline 3\\nline 4\\nline 5\";\r\n\r\n      await writeFile(testFile, originalContent);\r\n      const originalMtime = await getMtime(testFile);\r\n\r\n      tracker.record(testFile, { content: originalContent, timestamp: originalMtime });\r\n\r\n      // Modify middle line\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n      const modifiedContent = \"line 1\\nline 2\\nmodified line 3\\nline 4\\nline 5\";\r\n      await writeFile(testFile, modifiedContent);\r\n      const newMtime = Date.now() + 1000;\r\n      await utimes(testFile, newMtime / 1000, newMtime / 1000);\r\n\r\n      const attachments = await tracker.getChangedAttachments();\r\n\r\n      expect(attachments).toHaveLength(1);\r\n      const diff = attachments[0].snippet;\r\n\r\n      // Verify unified diff format\r\n      expect(diff).toContain(\"@@\");\r\n      expect(diff).toContain(\"-line 3\");\r\n      expect(diff).toContain(\"+modified line 3\");\r\n    });\r\n\r\n    it(\"should expose count and paths getters\", () => {\r\n      const tracker = new FileChangeTracker();\r\n      const file1 = join(tmpDir, \"file1.md\");\r\n      const file2 = join(tmpDir, \"file2.md\");\r\n\r\n      expect(tracker.count).toBe(0);\r\n      expect(tracker.paths).toEqual([]);\r\n\r\n      tracker.record(file1, { content: \"content1\", timestamp: Date.now() });\r\n      expect(tracker.count).toBe(1);\r\n      expect(tracker.paths).toContain(file1);\r\n\r\n      tracker.record(file2, { content: \"content2\", timestamp: Date.now() });\r\n      expect(tracker.count).toBe(2);\r\n      expect(tracker.paths).toContain(file1);\r\n      expect(tracker.paths).toContain(file2);\r\n\r\n      tracker.clear();\r\n      expect(tracker.count).toBe(0);\r\n      expect(tracker.paths).toEqual([]);\r\n    });\r\n  });\r\n\r\n  describe(\"computeDiff utility\", () => {\r\n    it(\"should return null for identical content\", () => {\r\n      const content = \"# Plan\\n\\nContent here\";\r\n      expect(computeDiff(content, content)).toBeNull();\r\n    });\r\n\r\n    it(\"should return diff for modified content\", () => {\r\n      const old = \"line 1\\nline 2\\nline 3\";\r\n      const modified = \"line 1\\nmodified line 2\\nline 3\";\r\n\r\n      const diff = computeDiff(old, modified);\r\n      expect(diff).not.toBeNull();\r\n      expect(diff).toContain(\"-line 2\");\r\n      expect(diff).toContain(\"+modified line 2\");\r\n    });\r\n\r\n    it(\"should handle added lines\", () => {\r\n      const old = \"line 1\\nline 2\";\r\n      const modified = \"line 1\\nline 2\\nline 3\";\r\n\r\n      const diff = computeDiff(old, modified);\r\n      expect(diff).not.toBeNull();\r\n      expect(diff).toContain(\"+line 3\");\r\n    });\r\n\r\n    it(\"should handle removed lines\", () => {\r\n      const old = \"line 1\\nline 2\\nline 3\";\r\n      const modified = \"line 1\\nline 3\";\r\n\r\n      const diff = computeDiff(old, modified);\r\n      expect(diff).not.toBeNull();\r\n      expect(diff).toContain(\"-line 2\");\r\n    });\r\n\r\n    it(\"should handle empty to non-empty\", () => {\r\n      const diff = computeDiff(\"\", \"new content\");\r\n      expect(diff).not.toBeNull();\r\n      expect(diff).toContain(\"+new content\");\r\n    });\r\n\r\n    it(\"should handle non-empty to empty\", () => {\r\n      const diff = computeDiff(\"old content\", \"\");\r\n      expect(diff).not.toBeNull();\r\n      expect(diff).toContain(\"-old content\");\r\n    });\r\n  });\r\n});\r\n"]}