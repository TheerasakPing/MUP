{"version":3,"file":"streamManager.test.js","sourceRoot":"","sources":["../../../src/node/services/streamManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, afterEach, beforeEach, mock } from \"bun:test\";\r\nimport * as fs from \"node:fs/promises\";\r\n\r\nimport { KNOWN_MODELS } from \"@/common/constants/knownModels\";\r\nimport { StreamManager, stripEncryptedContent } from \"./streamManager\";\r\nimport { APICallError, RetryError, type ModelMessage } from \"ai\";\r\nimport type { HistoryService } from \"./historyService\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { PartialService } from \"./partialService\";\r\nimport { createAnthropic } from \"@ai-sdk/anthropic\";\r\nimport { shouldRunIntegrationTests, validateApiKeys } from \"../../../tests/testUtils\";\r\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\r\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\r\n\r\n// Skip integration tests if TEST_INTEGRATION is not set\r\nconst describeIntegration = shouldRunIntegrationTests() ? describe : describe.skip;\r\n\r\n// Validate API keys before running tests\r\nif (shouldRunIntegrationTests()) {\r\n  validateApiKeys([\"ANTHROPIC_API_KEY\"]);\r\n}\r\n\r\n// Real HistoryService backed by a temp directory (created fresh per test)\r\nlet historyService: HistoryService;\r\nlet historyCleanup: () => Promise<void>;\r\n\r\nbeforeEach(async () => {\r\n  ({ historyService, cleanup: historyCleanup } = await createTestHistoryService());\r\n});\r\n\r\nafterEach(async () => {\r\n  await historyCleanup();\r\n});\r\n\r\n// Mock PartialService\r\nconst createMockPartialService = (): PartialService => {\r\n  return {\r\n    writePartial: mock(() => Promise.resolve({ success: true })),\r\n    readPartial: mock(() => Promise.resolve(null)),\r\n    deletePartial: mock(() => Promise.resolve({ success: true })),\r\n    commitToHistory: mock(() => Promise.resolve({ success: true })),\r\n  } as unknown as PartialService;\r\n};\r\n\r\ndescribe(\"StreamManager - createTempDirForStream\", () => {\r\n  test(\"creates ~/.mux-tmp/<token> under the runtime's home\", async () => {\r\n    using home = new DisposableTempDir(\"stream-home\");\r\n\r\n    const prevHome = process.env.HOME;\r\n    const prevUserProfile = process.env.USERPROFILE;\r\n\r\n    process.env.HOME = home.path;\r\n    process.env.USERPROFILE = home.path;\r\n\r\n    try {\r\n      const streamManager = new StreamManager(historyService, createMockPartialService());\r\n      const runtime = createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" });\r\n\r\n      const token = streamManager.generateStreamToken();\r\n      const resolved = await streamManager.createTempDirForStream(token, runtime);\r\n\r\n      // StreamManager normalizes Windows paths to forward slashes.\r\n      const normalizedHomePath = home.path.replace(/\\\\/g, \"/\");\r\n      expect(resolved.startsWith(normalizedHomePath)).toBe(true);\r\n      expect(resolved).toContain(`/.mux-tmp/${token}`);\r\n\r\n      const stat = await fs.stat(resolved);\r\n      expect(stat.isDirectory()).toBe(true);\r\n    } finally {\r\n      if (prevHome === undefined) {\r\n        delete process.env.HOME;\r\n      } else {\r\n        process.env.HOME = prevHome;\r\n      }\r\n\r\n      if (prevUserProfile === undefined) {\r\n        delete process.env.USERPROFILE;\r\n      } else {\r\n        process.env.USERPROFILE = prevUserProfile;\r\n      }\r\n    }\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - stopWhen configuration\", () => {\r\n  type StopWhenCondition = (options: { steps: unknown[] }) => boolean;\r\n  type BuildStopWhenCondition = (request: {\r\n    toolChoice?: { type: \"tool\"; toolName: string } | \"required\";\r\n    hasQueuedMessage?: () => boolean;\r\n  }) => StopWhenCondition | StopWhenCondition[];\r\n\r\n  test(\"uses single-step stopWhen when a tool is required\", () => {\r\n    const streamManager = new StreamManager(historyService, createMockPartialService());\r\n    const buildStopWhen = Reflect.get(streamManager, \"createStopWhenCondition\") as\r\n      | BuildStopWhenCondition\r\n      | undefined;\r\n    expect(typeof buildStopWhen).toBe(\"function\");\r\n\r\n    const stopWhen = buildStopWhen!({ toolChoice: { type: \"tool\", toolName: \"bash\" } });\r\n    if (typeof stopWhen !== \"function\") {\r\n      throw new Error(\"Expected required-tool stopWhen to be a single condition function\");\r\n    }\r\n\r\n    expect(stopWhen({ steps: [] })).toBe(false);\r\n    expect(stopWhen({ steps: [{}] })).toBe(true);\r\n    expect(stopWhen({ steps: [{}, {}] })).toBe(false);\r\n  });\r\n\r\n  test(\"uses autonomous step cap and queued-message interrupt conditions\", () => {\r\n    const streamManager = new StreamManager(historyService, createMockPartialService());\r\n    const buildStopWhen = Reflect.get(streamManager, \"createStopWhenCondition\") as\r\n      | BuildStopWhenCondition\r\n      | undefined;\r\n    expect(typeof buildStopWhen).toBe(\"function\");\r\n\r\n    let queued = false;\r\n    const stopWhen = buildStopWhen!({ hasQueuedMessage: () => queued });\r\n    if (!Array.isArray(stopWhen)) {\r\n      throw new Error(\"Expected autonomous stopWhen to be an array of conditions\");\r\n    }\r\n    expect(stopWhen).toHaveLength(2);\r\n\r\n    const [maxStepCondition, queuedMessageCondition] = stopWhen;\r\n    expect(maxStepCondition({ steps: new Array(99999) })).toBe(false);\r\n    expect(maxStepCondition({ steps: new Array(100000) })).toBe(true);\r\n\r\n    expect(queuedMessageCondition({ steps: [] })).toBe(false);\r\n    queued = true;\r\n    expect(queuedMessageCondition({ steps: [] })).toBe(true);\r\n  });\r\n\r\n  test(\"treats missing queued-message callback as not queued\", () => {\r\n    const streamManager = new StreamManager(historyService, createMockPartialService());\r\n    const buildStopWhen = Reflect.get(streamManager, \"createStopWhenCondition\") as\r\n      | BuildStopWhenCondition\r\n      | undefined;\r\n    expect(typeof buildStopWhen).toBe(\"function\");\r\n\r\n    const stopWhen = buildStopWhen!({});\r\n    if (!Array.isArray(stopWhen)) {\r\n      throw new Error(\"Expected autonomous stopWhen to remain array-based without callback\");\r\n    }\r\n\r\n    const [, queuedMessageCondition] = stopWhen;\r\n    expect(queuedMessageCondition({ steps: [] })).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - stripEncryptedContent\", () => {\r\n  test(\"strips encryptedContent from array output shape\", () => {\r\n    const output = [\r\n      {\r\n        url: \"https://example.com/a\",\r\n        title: \"Result A\",\r\n        pageAge: \"2d\",\r\n        encryptedContent: \"secret-a\",\r\n      },\r\n      {\r\n        url: \"https://example.com/b\",\r\n        title: \"Result B\",\r\n      },\r\n      \"non-object-item\",\r\n    ];\r\n\r\n    expect(stripEncryptedContent(output)).toEqual([\r\n      {\r\n        url: \"https://example.com/a\",\r\n        title: \"Result A\",\r\n        pageAge: \"2d\",\r\n      },\r\n      {\r\n        url: \"https://example.com/b\",\r\n        title: \"Result B\",\r\n      },\r\n      \"non-object-item\",\r\n    ]);\r\n  });\r\n\r\n  test(\"strips encryptedContent from json value output shape\", () => {\r\n    const output = {\r\n      type: \"json\",\r\n      value: [\r\n        {\r\n          url: \"https://example.com/c\",\r\n          title: \"Result C\",\r\n          encryptedContent: \"secret-c\",\r\n        },\r\n        {\r\n          url: \"https://example.com/d\",\r\n          title: \"Result D\",\r\n          pageAge: \"5h\",\r\n        },\r\n      ],\r\n      source: \"web_search\",\r\n    };\r\n\r\n    expect(stripEncryptedContent(output)).toEqual({\r\n      type: \"json\",\r\n      value: [\r\n        {\r\n          url: \"https://example.com/c\",\r\n          title: \"Result C\",\r\n        },\r\n        {\r\n          url: \"https://example.com/d\",\r\n          title: \"Result D\",\r\n          pageAge: \"5h\",\r\n        },\r\n      ],\r\n      source: \"web_search\",\r\n    });\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - Concurrent Stream Prevention\", () => {\r\n  let streamManager: StreamManager;\r\n  let mockPartialService: PartialService;\r\n  const runtime = createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" });\r\n\r\n  beforeEach(() => {\r\n    mockPartialService = createMockPartialService();\r\n    streamManager = new StreamManager(historyService, mockPartialService);\r\n    // Suppress error events from bubbling up as uncaught exceptions during tests\r\n    streamManager.on(\"error\", () => undefined);\r\n  });\r\n\r\n  // Integration test - requires API key and TEST_INTEGRATION=1\r\n  describeIntegration(\"with real API\", () => {\r\n    test(\"should prevent concurrent streams for the same workspace\", async () => {\r\n      const workspaceId = \"test-workspace-concurrent\";\r\n      const anthropic = createAnthropic({ apiKey: process.env.ANTHROPIC_API_KEY });\r\n      const model = anthropic(\"claude-sonnet-4-5\");\r\n\r\n      // Track when streams are actively processing\r\n      const streamStates: Record<string, { started: boolean; finished: boolean }> = {};\r\n      let firstMessageId: string | undefined;\r\n\r\n      streamManager.on(\"stream-start\", (data: { messageId: string; historySequence: number }) => {\r\n        streamStates[data.messageId] = { started: true, finished: false };\r\n        if (data.historySequence === 1) {\r\n          firstMessageId = data.messageId;\r\n        }\r\n      });\r\n\r\n      streamManager.on(\"stream-end\", (data: { messageId: string }) => {\r\n        if (streamStates[data.messageId]) {\r\n          streamStates[data.messageId].finished = true;\r\n        }\r\n      });\r\n\r\n      streamManager.on(\"stream-abort\", (data: { messageId: string }) => {\r\n        if (streamStates[data.messageId]) {\r\n          streamStates[data.messageId].finished = true;\r\n        }\r\n      });\r\n\r\n      // Start first stream\r\n      const result1 = await streamManager.startStream(\r\n        workspaceId,\r\n        [{ role: \"user\", content: \"Say hello and nothing else\" }],\r\n        model,\r\n        KNOWN_MODELS.SONNET.id,\r\n        1,\r\n        \"You are a helpful assistant\",\r\n        runtime,\r\n        \"test-msg-1\",\r\n        undefined,\r\n        {}\r\n      );\r\n\r\n      expect(result1.success).toBe(true);\r\n\r\n      // Wait for first stream to actually start\r\n      await new Promise((resolve) => setTimeout(resolve, 200));\r\n\r\n      // Start second stream - should cancel first\r\n      const result2 = await streamManager.startStream(\r\n        workspaceId,\r\n        [{ role: \"user\", content: \"Say goodbye and nothing else\" }],\r\n        model,\r\n        KNOWN_MODELS.SONNET.id,\r\n        2,\r\n        \"You are a helpful assistant\",\r\n        runtime,\r\n        \"test-msg-2\",\r\n        undefined,\r\n        {}\r\n      );\r\n\r\n      expect(result2.success).toBe(true);\r\n\r\n      // Wait for second stream to complete\r\n      await new Promise((resolve) => setTimeout(resolve, 5000));\r\n\r\n      // Verify: first stream should have been cancelled before second stream started\r\n      expect(firstMessageId).toBeDefined();\r\n      const trackedFirstMessageId = firstMessageId!;\r\n      expect(streamStates[trackedFirstMessageId]).toBeDefined();\r\n      expect(streamStates[trackedFirstMessageId].started).toBe(true);\r\n      expect(streamStates[trackedFirstMessageId].finished).toBe(true);\r\n\r\n      // Verify no streams are active after completion\r\n      expect(streamManager.isStreaming(workspaceId)).toBe(false);\r\n    }, 10000);\r\n  });\r\n\r\n  // Unit test - doesn't require API key\r\n  test(\"should serialize multiple rapid startStream calls\", async () => {\r\n    // This is a simpler test that doesn't require API key\r\n    // It tests the mutex behavior without actually streaming\r\n\r\n    const workspaceId = \"test-workspace-serial\";\r\n\r\n    // Track the order of operations\r\n    const operations: string[] = [];\r\n\r\n    // Create a dummy model (won't actually be used since we're mocking the core behavior)\r\n    const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\r\n\r\n    interface WorkspaceStreamInfoStub {\r\n      state: string;\r\n      streamResult: {\r\n        fullStream: AsyncGenerator<unknown, void, unknown>;\r\n        usage: Promise<unknown>;\r\n        providerMetadata: Promise<unknown>;\r\n      };\r\n      abortController: AbortController;\r\n      messageId: string;\r\n      token: string;\r\n      startTime: number;\r\n      model: string;\r\n      initialMetadata?: Record<string, unknown>;\r\n      historySequence: number;\r\n      parts: unknown[];\r\n      lastPartialWriteTime: number;\r\n      partialWriteTimer?: ReturnType<typeof setTimeout>;\r\n      partialWritePromise?: Promise<void>;\r\n      processingPromise: Promise<void>;\r\n    }\r\n\r\n    const replaceEnsureResult = Reflect.set(\r\n      streamManager,\r\n      \"ensureStreamSafety\",\r\n      async (_wsId: string): Promise<string> => {\r\n        operations.push(\"ensure-start\");\r\n        await new Promise((resolve) => setTimeout(resolve, 50));\r\n        operations.push(\"ensure-end\");\r\n        return \"test-token\";\r\n      }\r\n    );\r\n\r\n    const replaceTempDirResult = Reflect.set(\r\n      streamManager,\r\n      \"createTempDirForStream\",\r\n      (_streamToken: string, _runtime: unknown): Promise<string> => {\r\n        return Promise.resolve(\"/tmp/mock-stream-temp\");\r\n      }\r\n    );\r\n\r\n    if (!replaceTempDirResult) {\r\n      throw new Error(\"Failed to mock StreamManager.createTempDirForStream\");\r\n    }\r\n    if (!replaceEnsureResult) {\r\n      throw new Error(\"Failed to mock StreamManager.ensureStreamSafety\");\r\n    }\r\n\r\n    const workspaceStreamsValue = Reflect.get(streamManager, \"workspaceStreams\") as unknown;\r\n    if (!(workspaceStreamsValue instanceof Map)) {\r\n      throw new Error(\"StreamManager.workspaceStreams is not a Map\");\r\n    }\r\n    const workspaceStreams = workspaceStreamsValue as Map<string, WorkspaceStreamInfoStub>;\r\n\r\n    const replaceCreateResult = Reflect.set(\r\n      streamManager,\r\n      \"createStreamAtomically\",\r\n      (\r\n        wsId: string,\r\n        streamToken: string,\r\n        _runtimeTempDir: string,\r\n        _runtime: unknown,\r\n        _messages: unknown,\r\n        _modelArg: unknown,\r\n        modelString: string,\r\n        abortController: AbortController,\r\n        _system: string,\r\n        historySequence: number,\r\n        _messageId: string,\r\n        _tools?: Record<string, unknown>,\r\n        initialMetadata?: Record<string, unknown>,\r\n        _providerOptions?: Record<string, unknown>,\r\n        _maxOutputTokens?: number,\r\n        _toolPolicy?: unknown\r\n      ): WorkspaceStreamInfoStub => {\r\n        operations.push(\"create\");\r\n\r\n        const streamInfo: WorkspaceStreamInfoStub = {\r\n          state: \"starting\",\r\n          streamResult: {\r\n            fullStream: (async function* asyncGenerator() {\r\n              // No-op generator; we only care about synchronization\r\n            })(),\r\n            usage: Promise.resolve(undefined),\r\n            providerMetadata: Promise.resolve(undefined),\r\n          },\r\n          abortController,\r\n          messageId: `test-${Math.random().toString(36).slice(2)}`,\r\n          token: streamToken,\r\n          startTime: Date.now(),\r\n          model: modelString,\r\n          initialMetadata,\r\n          historySequence,\r\n          parts: [],\r\n          lastPartialWriteTime: 0,\r\n          partialWriteTimer: undefined,\r\n          partialWritePromise: undefined,\r\n          processingPromise: Promise.resolve(),\r\n        };\r\n\r\n        workspaceStreams.set(wsId, streamInfo);\r\n        return streamInfo;\r\n      }\r\n    );\r\n\r\n    if (!replaceCreateResult) {\r\n      throw new Error(\"Failed to mock StreamManager.createStreamAtomically\");\r\n    }\r\n\r\n    const replaceProcessResult = Reflect.set(\r\n      streamManager,\r\n      \"processStreamWithCleanup\",\r\n      async (_wsId: string, info: WorkspaceStreamInfoStub): Promise<void> => {\r\n        operations.push(\"process-start\");\r\n        await sleep(20);\r\n        info.state = \"streaming\";\r\n        operations.push(\"process-end\");\r\n      }\r\n    );\r\n\r\n    if (!replaceProcessResult) {\r\n      throw new Error(\"Failed to mock StreamManager.processStreamWithCleanup\");\r\n    }\r\n\r\n    const anthropic = createAnthropic({ apiKey: \"dummy-key\" });\r\n    const model = anthropic(\"claude-sonnet-4-5\");\r\n\r\n    // Start three streams rapidly\r\n    // Without mutex, these would interleave (ensure-start, ensure-start, ensure-start, ensure-end, ensure-end, ensure-end)\r\n    // With mutex, they should be serialized (ensure-start, ensure-end, ensure-start, ensure-end, ensure-start, ensure-end)\r\n    const promises = [\r\n      streamManager.startStream(\r\n        workspaceId,\r\n        [{ role: \"user\", content: \"test 1\" }],\r\n        model,\r\n        KNOWN_MODELS.SONNET.id,\r\n        1,\r\n        \"system\",\r\n        runtime,\r\n        \"test-msg-1\",\r\n        undefined,\r\n        {}\r\n      ),\r\n      streamManager.startStream(\r\n        workspaceId,\r\n        [{ role: \"user\", content: \"test 2\" }],\r\n        model,\r\n        KNOWN_MODELS.SONNET.id,\r\n        2,\r\n        \"system\",\r\n        runtime,\r\n        \"test-msg-2\",\r\n        undefined,\r\n        {}\r\n      ),\r\n      streamManager.startStream(\r\n        workspaceId,\r\n        [{ role: \"user\", content: \"test 3\" }],\r\n        model,\r\n        KNOWN_MODELS.SONNET.id,\r\n        3,\r\n        \"system\",\r\n        runtime,\r\n        \"test-msg-3\",\r\n        undefined,\r\n        {}\r\n      ),\r\n    ];\r\n\r\n    // Wait for all to complete (they will fail due to dummy API key, but that's ok)\r\n    await Promise.allSettled(promises);\r\n\r\n    // Verify operations are serialized: each ensure-start should be followed by its ensure-end\r\n    // before the next ensure-start\r\n    const ensureOperations = operations.filter((op) => op.startsWith(\"ensure\"));\r\n    for (let i = 0; i < ensureOperations.length - 1; i += 2) {\r\n      expect(ensureOperations[i]).toBe(\"ensure-start\");\r\n      expect(ensureOperations[i + 1]).toBe(\"ensure-end\");\r\n    }\r\n  });\r\n\r\n  test(\"should honor abortSignal before atomic stream creation\", async () => {\r\n    const workspaceId = \"test-workspace-abort-before-create\";\r\n\r\n    let createCalled = false;\r\n    let processCalled = false;\r\n    let streamStartEmitted = false;\r\n\r\n    streamManager.on(\"stream-start\", () => {\r\n      streamStartEmitted = true;\r\n    });\r\n\r\n    const abortController = new AbortController();\r\n\r\n    let tempDirStartedResolve: (() => void) | undefined;\r\n    const tempDirStarted = new Promise<void>((resolve) => {\r\n      tempDirStartedResolve = resolve;\r\n    });\r\n\r\n    const replaceTempDirResult = Reflect.set(\r\n      streamManager,\r\n      \"createTempDirForStream\",\r\n      (_streamToken: string, _runtime: unknown): Promise<string> => {\r\n        tempDirStartedResolve?.();\r\n        return new Promise((resolve) => {\r\n          abortController.signal.addEventListener(\"abort\", () => resolve(\"/tmp/mock-stream-temp\"), {\r\n            once: true,\r\n          });\r\n        });\r\n      }\r\n    );\r\n\r\n    if (!replaceTempDirResult) {\r\n      throw new Error(\"Failed to mock StreamManager.createTempDirForStream\");\r\n    }\r\n\r\n    let cleanupCalled = false;\r\n    const replaceCleanupResult = Reflect.set(\r\n      streamManager,\r\n      \"cleanupStreamTempDir\",\r\n      (..._args: unknown[]): void => {\r\n        cleanupCalled = true;\r\n      }\r\n    );\r\n\r\n    if (!replaceCleanupResult) {\r\n      throw new Error(\"Failed to mock StreamManager.cleanupStreamTempDir\");\r\n    }\r\n\r\n    const replaceCreateResult = Reflect.set(\r\n      streamManager,\r\n      \"createStreamAtomically\",\r\n      (..._args: unknown[]): never => {\r\n        createCalled = true;\r\n        throw new Error(\"createStreamAtomically should not be called\");\r\n      }\r\n    );\r\n\r\n    if (!replaceCreateResult) {\r\n      throw new Error(\"Failed to mock StreamManager.createStreamAtomically\");\r\n    }\r\n\r\n    const replaceProcessResult = Reflect.set(\r\n      streamManager,\r\n      \"processStreamWithCleanup\",\r\n      (..._args: unknown[]): Promise<void> => {\r\n        processCalled = true;\r\n        return Promise.resolve();\r\n      }\r\n    );\r\n\r\n    if (!replaceProcessResult) {\r\n      throw new Error(\"Failed to mock StreamManager.processStreamWithCleanup\");\r\n    }\r\n\r\n    const anthropic = createAnthropic({ apiKey: \"dummy-key\" });\r\n    const model = anthropic(\"claude-sonnet-4-5\");\r\n\r\n    const startPromise = streamManager.startStream(\r\n      workspaceId,\r\n      [{ role: \"user\", content: \"test\" }],\r\n      model,\r\n      KNOWN_MODELS.SONNET.id,\r\n      1,\r\n      \"system\",\r\n      runtime,\r\n      \"test-msg-abort\",\r\n      abortController.signal,\r\n      {}\r\n    );\r\n\r\n    await tempDirStarted;\r\n    abortController.abort();\r\n\r\n    const result = await startPromise;\r\n    expect(result.success).toBe(true);\r\n    expect(createCalled).toBe(false);\r\n    expect(cleanupCalled).toBe(true);\r\n    expect(processCalled).toBe(false);\r\n    expect(streamStartEmitted).toBe(false);\r\n    expect(streamManager.isStreaming(workspaceId)).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - Unavailable Tool Handling\", () => {\r\n  let streamManager: StreamManager;\r\n  let mockPartialService: PartialService;\r\n\r\n  beforeEach(() => {\r\n    mockPartialService = createMockPartialService();\r\n    streamManager = new StreamManager(historyService, mockPartialService);\r\n    // Suppress error events - processStreamWithCleanup may throw due to tokenizer worker issues in test env\r\n    streamManager.on(\"error\", () => undefined);\r\n  });\r\n\r\n  test.skip(\"should handle tool-error events from SDK\", async () => {\r\n    const workspaceId = \"test-workspace-tool-error\";\r\n\r\n    // Track emitted events\r\n    interface ToolEvent {\r\n      type: string;\r\n      toolName?: string;\r\n      result?: unknown;\r\n    }\r\n    const events: ToolEvent[] = [];\r\n\r\n    streamManager.on(\"tool-call-start\", (data: { toolName: string }) => {\r\n      events.push({ type: \"tool-call-start\", toolName: data.toolName });\r\n    });\r\n\r\n    streamManager.on(\"tool-call-end\", (data: { toolName: string; result: unknown }) => {\r\n      events.push({ type: \"tool-call-end\", toolName: data.toolName, result: data.result });\r\n    });\r\n\r\n    // Mock a stream that emits tool-error event (AI SDK 5.0 behavior)\r\n    const mockStreamResult = {\r\n      // eslint-disable-next-line @typescript-eslint/require-await\r\n      fullStream: (async function* () {\r\n        // SDK emits tool-call when model requests a tool\r\n        yield {\r\n          type: \"tool-call\",\r\n          toolCallId: \"test-call-1\",\r\n          toolName: \"file_edit_replace\",\r\n          input: { file_path: \"/test\", old_string: \"foo\", new_string: \"bar\" },\r\n        };\r\n        // SDK emits tool-error when tool execution fails\r\n        yield {\r\n          type: \"tool-error\",\r\n          toolCallId: \"test-call-1\",\r\n          toolName: \"file_edit_replace\",\r\n          error: \"Tool not found\",\r\n        };\r\n      })(),\r\n      usage: Promise.resolve(undefined),\r\n      providerMetadata: Promise.resolve({}),\r\n    };\r\n\r\n    // Create streamInfo for testing\r\n    const streamInfo = {\r\n      state: 2, // STREAMING\r\n      streamResult: mockStreamResult,\r\n      abortController: new AbortController(),\r\n      messageId: \"test-message-1\",\r\n      token: \"test-token\",\r\n      startTime: Date.now(),\r\n      model: KNOWN_MODELS.SONNET.id,\r\n      historySequence: 1,\r\n      parts: [],\r\n      lastPartialWriteTime: 0,\r\n      processingPromise: Promise.resolve(),\r\n    };\r\n\r\n    // Access private method for testing\r\n    // @ts-expect-error - accessing private method for testing\r\n    await streamManager.processStreamWithCleanup(workspaceId, streamInfo, 1);\r\n\r\n    // Verify events were emitted correctly\r\n    expect(events.length).toBeGreaterThanOrEqual(2);\r\n    expect(events[0]).toMatchObject({\r\n      type: \"tool-call-start\",\r\n      toolName: \"file_edit_replace\",\r\n    });\r\n    expect(events[1]).toMatchObject({\r\n      type: \"tool-call-end\",\r\n      toolName: \"file_edit_replace\",\r\n    });\r\n\r\n    // Verify error result\r\n    const errorResult = events[1].result as { error?: string };\r\n    expect(errorResult?.error).toBe(\"Tool not found\");\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - previousResponseId recovery\", () => {\r\n  test(\"isResponseIdLost returns false for unknown IDs\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    // Verify the ID is not lost initially\r\n    expect(streamManager.isResponseIdLost(\"resp_123abc\")).toBe(false);\r\n    expect(streamManager.isResponseIdLost(\"resp_different\")).toBe(false);\r\n  });\r\n\r\n  test(\"extractPreviousResponseIdFromError extracts ID from various error formats\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    // Get the private method via reflection\r\n    const extractMethod = Reflect.get(streamManager, \"extractPreviousResponseIdFromError\") as (\r\n      error: unknown\r\n    ) => string | undefined;\r\n    expect(typeof extractMethod).toBe(\"function\");\r\n\r\n    // Test extraction from APICallError with responseBody\r\n    const apiError = new APICallError({\r\n      message: \"Previous response with id 'resp_abc123' not found.\",\r\n      url: \"https://api.openai.com/v1/responses\",\r\n      requestBodyValues: {},\r\n      statusCode: 400,\r\n      responseHeaders: {},\r\n      responseBody:\r\n        '{\"error\":{\"message\":\"Previous response with id \\'resp_abc123\\' not found.\",\"code\":\"previous_response_not_found\"}}',\r\n      isRetryable: false,\r\n      data: { error: { code: \"previous_response_not_found\" } },\r\n    });\r\n    expect(extractMethod.call(streamManager, apiError)).toBe(\"resp_abc123\");\r\n\r\n    // Test extraction from error message\r\n    const errorWithMessage = new Error(\"Previous response with id 'resp_def456' not found.\");\r\n    expect(extractMethod.call(streamManager, errorWithMessage)).toBe(\"resp_def456\");\r\n\r\n    // Test when no ID is present\r\n    const errorWithoutId = new Error(\"Some other error\");\r\n    expect(extractMethod.call(streamManager, errorWithoutId)).toBeUndefined();\r\n  });\r\n\r\n  test(\"recordLostResponseIdIfApplicable records IDs for explicit OpenAI errors\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const recordMethod = Reflect.get(streamManager, \"recordLostResponseIdIfApplicable\") as (\r\n      workspaceId: string,\r\n      error: unknown,\r\n      streamInfo: unknown\r\n    ) => void;\r\n    expect(typeof recordMethod).toBe(\"function\");\r\n\r\n    const apiError = new APICallError({\r\n      message: \"Previous response with id 'resp_deadbeef' not found.\",\r\n      url: \"https://api.openai.com/v1/responses\",\r\n      requestBodyValues: {},\r\n      statusCode: 400,\r\n      responseHeaders: {},\r\n      responseBody: \"Previous response with id 'resp_deadbeef' not found.\",\r\n      isRetryable: false,\r\n      data: { error: { code: \"previous_response_not_found\" } },\r\n    });\r\n\r\n    recordMethod.call(streamManager, \"workspace-1\", apiError, {\r\n      messageId: \"msg-1\",\r\n      model: \"openai:gpt-mini\",\r\n    });\r\n\r\n    expect(streamManager.isResponseIdLost(\"resp_deadbeef\")).toBe(true);\r\n  });\r\n\r\n  test(\"recordLostResponseIdIfApplicable records IDs for 500 errors referencing previous responses\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const recordMethod = Reflect.get(streamManager, \"recordLostResponseIdIfApplicable\") as (\r\n      workspaceId: string,\r\n      error: unknown,\r\n      streamInfo: unknown\r\n    ) => void;\r\n    expect(typeof recordMethod).toBe(\"function\");\r\n\r\n    const apiError = new APICallError({\r\n      message: \"Internal error: Previous response with id 'resp_cafebabe' not found.\",\r\n      url: \"https://api.openai.com/v1/responses\",\r\n      requestBodyValues: {},\r\n      statusCode: 500,\r\n      responseHeaders: {},\r\n      responseBody: \"Internal error: Previous response with id 'resp_cafebabe' not found.\",\r\n      isRetryable: false,\r\n      data: { error: { code: \"server_error\" } },\r\n    });\r\n\r\n    recordMethod.call(streamManager, \"workspace-2\", apiError, {\r\n      messageId: \"msg-2\",\r\n      model: \"openai:gpt-mini\",\r\n    });\r\n\r\n    expect(streamManager.isResponseIdLost(\"resp_cafebabe\")).toBe(true);\r\n  });\r\n\r\n  test(\"retryStreamWithoutPreviousResponseId retries at step boundary with existing parts\", async () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const retryMethod = Reflect.get(streamManager, \"retryStreamWithoutPreviousResponseId\") as (\r\n      workspaceId: string,\r\n      streamInfo: unknown,\r\n      error: unknown,\r\n      hasRetried: boolean\r\n    ) => Promise<boolean>;\r\n\r\n    const model = createAnthropic({ apiKey: \"test\" })(\"claude-sonnet-4-5\");\r\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" });\r\n    const stepMessages: ModelMessage[] = [{ role: \"user\", content: \"next step\" }];\r\n\r\n    const streamInfo = {\r\n      state: \"streaming\",\r\n      streamResult: {},\r\n      abortController: new AbortController(),\r\n      messageId: \"msg-1\",\r\n      token: \"token\",\r\n      startTime: Date.now(),\r\n      model: \"mux-gateway:openai/gpt-5.2-codex\",\r\n      historySequence: 1,\r\n      stepTracker: { latestMessages: stepMessages },\r\n      didRetryPreviousResponseIdAtStep: false,\r\n      currentStepStartIndex: 1,\r\n      request: {\r\n        model,\r\n        messages: [{ role: \"user\", content: \"original\" }],\r\n        system: \"system\",\r\n        providerOptions: { openai: { previousResponseId: \"resp_abc123\" } },\r\n      },\r\n      parts: [\r\n        {\r\n          type: \"dynamic-tool\",\r\n          toolCallId: \"tool-1\",\r\n          toolName: \"test\",\r\n          state: \"output-available\",\r\n          input: {},\r\n          output: {},\r\n        },\r\n      ],\r\n      lastPartialWriteTime: 0,\r\n      processingPromise: Promise.resolve(),\r\n      softInterrupt: { pending: false },\r\n      runtimeTempDir: \"/tmp\",\r\n      runtime,\r\n      cumulativeUsage: { inputTokens: 1, outputTokens: 2, totalTokens: 3 },\r\n      cumulativeProviderMetadata: { openai: {} },\r\n    };\r\n\r\n    (streamManager as unknown as { createStreamResult: () => unknown }).createStreamResult =\r\n      () => ({\r\n        fullStream: (async function* () {\r\n          await Promise.resolve();\r\n          yield* [];\r\n        })(),\r\n        totalUsage: Promise.resolve(undefined),\r\n        usage: Promise.resolve(undefined),\r\n        providerMetadata: Promise.resolve(undefined),\r\n        steps: Promise.resolve([]),\r\n      });\r\n\r\n    const apiError = new APICallError({\r\n      message: \"Previous response with id 'resp_abc123' not found.\",\r\n      url: \"https://api.openai.com/v1/responses\",\r\n      requestBodyValues: {},\r\n      statusCode: 400,\r\n      responseHeaders: {},\r\n      responseBody: \"Previous response with id 'resp_abc123' not found.\",\r\n      isRetryable: false,\r\n      data: { error: { code: \"previous_response_not_found\" } },\r\n    });\r\n\r\n    const retried = await retryMethod.call(streamManager, \"ws-step\", streamInfo, apiError, false);\r\n    expect(retried).toBe(true);\r\n    expect(streamInfo.parts).toHaveLength(1);\r\n    expect(streamInfo.didRetryPreviousResponseIdAtStep).toBe(true);\r\n    expect(streamInfo.request.messages as ModelMessage[]).toBe(stepMessages);\r\n\r\n    const openaiOptions = streamInfo.request.providerOptions as {\r\n      openai?: Record<string, unknown>;\r\n    };\r\n    expect(openaiOptions.openai?.previousResponseId).toBeUndefined();\r\n  });\r\n\r\n  test(\"resolveTotalUsageForStreamEnd prefers cumulative usage after step retry\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const resolveMethod = Reflect.get(streamManager, \"resolveTotalUsageForStreamEnd\") as (\r\n      streamInfo: unknown,\r\n      totalUsage: unknown\r\n    ) => unknown;\r\n    expect(typeof resolveMethod).toBe(\"function\");\r\n\r\n    const cumulativeUsage = { inputTokens: 4, outputTokens: 5, totalTokens: 9 };\r\n    const totalUsage = { inputTokens: 1, outputTokens: 2, totalTokens: 3 };\r\n\r\n    const result = resolveMethod.call(\r\n      streamManager,\r\n      { didRetryPreviousResponseIdAtStep: true, cumulativeUsage },\r\n      totalUsage\r\n    );\r\n\r\n    expect(result).toEqual(cumulativeUsage);\r\n  });\r\n\r\n  test(\"resolveTotalUsageForStreamEnd treats non-zero fields as valid usage\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const resolveMethod = Reflect.get(streamManager, \"resolveTotalUsageForStreamEnd\") as (\r\n      streamInfo: unknown,\r\n      totalUsage: unknown\r\n    ) => unknown;\r\n    expect(typeof resolveMethod).toBe(\"function\");\r\n\r\n    const cumulativeUsage = { inputTokens: 4, outputTokens: 1, totalTokens: 0 };\r\n    const totalUsage = { inputTokens: 1, outputTokens: 2, totalTokens: 3 };\r\n\r\n    const result = resolveMethod.call(\r\n      streamManager,\r\n      { didRetryPreviousResponseIdAtStep: true, cumulativeUsage },\r\n      totalUsage\r\n    );\r\n\r\n    expect(result).toEqual(cumulativeUsage);\r\n  });\r\n\r\n  test(\"resolveTotalUsageForStreamEnd keeps stream total without step retry\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const resolveMethod = Reflect.get(streamManager, \"resolveTotalUsageForStreamEnd\") as (\r\n      streamInfo: unknown,\r\n      totalUsage: unknown\r\n    ) => unknown;\r\n    expect(typeof resolveMethod).toBe(\"function\");\r\n\r\n    const cumulativeUsage = { inputTokens: 4, outputTokens: 5, totalTokens: 9 };\r\n    const totalUsage = { inputTokens: 1, outputTokens: 2, totalTokens: 3 };\r\n\r\n    const result = resolveMethod.call(\r\n      streamManager,\r\n      { didRetryPreviousResponseIdAtStep: false, cumulativeUsage },\r\n      totalUsage\r\n    );\r\n\r\n    expect(result).toEqual(totalUsage);\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - replayStream\", () => {\r\n  test(\"replayStream snapshots parts so reconnect doesn't block until stream ends\", async () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    // Suppress error events from bubbling up as uncaught exceptions during tests\r\n    streamManager.on(\"error\", () => undefined);\r\n\r\n    let sawStreamStart = false;\r\n    streamManager.on(\"stream-start\", (event: { replay?: boolean | undefined }) => {\r\n      sawStreamStart = true;\r\n      expect(event.replay).toBe(true);\r\n    });\r\n    const workspaceId = \"ws-replay-snapshot\";\r\n\r\n    const deltas: string[] = [];\r\n    streamManager.on(\"stream-delta\", (event: { delta: string; replay?: boolean | undefined }) => {\r\n      expect(event.replay).toBe(true);\r\n      deltas.push(event.delta);\r\n    });\r\n\r\n    // Inject an active stream into the private workspaceStreams map.\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n    const workspaceStreamsValue = Reflect.get(streamManager, \"workspaceStreams\");\r\n    if (!(workspaceStreamsValue instanceof Map)) {\r\n      throw new Error(\"StreamManager.workspaceStreams is not a Map\");\r\n    }\r\n    const workspaceStreams = workspaceStreamsValue as Map<string, unknown>;\r\n\r\n    const streamInfo = {\r\n      state: \"streaming\",\r\n      messageId: \"msg-1\",\r\n      model: \"claude-sonnet-4\",\r\n      historySequence: 1,\r\n      startTime: 123,\r\n      initialMetadata: {},\r\n      parts: [{ type: \"text\", text: \"a\", timestamp: 10 }],\r\n    };\r\n\r\n    workspaceStreams.set(workspaceId, streamInfo);\r\n\r\n    // Patch the private tokenTracker to (a) avoid worker setup and (b) mutate parts during replay.\r\n    const tokenTracker = Reflect.get(streamManager, \"tokenTracker\") as {\r\n      setModel: (model: string) => Promise<void>;\r\n      countTokens: (text: string) => Promise<number>;\r\n    };\r\n\r\n    tokenTracker.setModel = () => Promise.resolve();\r\n\r\n    let pushed = false;\r\n    tokenTracker.countTokens = async () => {\r\n      if (!pushed) {\r\n        pushed = true;\r\n        // While replay is mid-await, simulate the running stream appending more parts.\r\n        (streamInfo.parts as Array<{ type: string; text?: string; timestamp?: number }>).push({\r\n          type: \"text\",\r\n          text: \"b\",\r\n          timestamp: 20,\r\n        });\r\n      }\r\n      // Force an await boundary so the mutation happens during replay.\r\n      await new Promise((resolve) => setTimeout(resolve, 0));\r\n      return 1;\r\n    };\r\n\r\n    await streamManager.replayStream(workspaceId);\r\n    expect(sawStreamStart).toBe(true);\r\n\r\n    // If replayStream iterates the live array, it would also emit \"b\".\r\n    expect(deltas).toEqual([\"a\"]);\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - categorizeError\", () => {\r\n  test(\"unwraps RetryError.lastError to classify model_not_found\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const categorizeMethod = Reflect.get(streamManager, \"categorizeError\") as (\r\n      error: unknown\r\n    ) => unknown;\r\n    expect(typeof categorizeMethod).toBe(\"function\");\r\n\r\n    const apiError = new APICallError({\r\n      message: \"The model `gpt-5.2-codex` does not exist or you do not have access to it.\",\r\n      url: \"https://api.openai.com/v1/responses\",\r\n      requestBodyValues: {},\r\n      statusCode: 400,\r\n      responseHeaders: {},\r\n      responseBody:\r\n        '{\"error\":{\"message\":\"The model `gpt-5.2-codex` does not exist or you do not have access to it.\",\"code\":\"model_not_found\"}}',\r\n      isRetryable: false,\r\n      data: { error: { code: \"model_not_found\" } },\r\n    });\r\n\r\n    const retryError = new RetryError({\r\n      message: \"AI SDK retry exhausted\",\r\n      reason: \"maxRetriesExceeded\",\r\n      errors: [apiError],\r\n    });\r\n\r\n    expect(categorizeMethod.call(streamManager, retryError)).toBe(\"model_not_found\");\r\n  });\r\n\r\n  test(\"classifies model_not_found via message fallback\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const categorizeMethod = Reflect.get(streamManager, \"categorizeError\") as (\r\n      error: unknown\r\n    ) => unknown;\r\n    expect(typeof categorizeMethod).toBe(\"function\");\r\n\r\n    const error = new Error(\r\n      \"The model `gpt-5.2-codex` does not exist or you do not have access to it.\"\r\n    );\r\n\r\n    expect(categorizeMethod.call(streamManager, error)).toBe(\"model_not_found\");\r\n  });\r\n\r\n  test(\"classifies 402 payment required as quota (avoid auto-retry)\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    const categorizeMethod = Reflect.get(streamManager, \"categorizeError\") as (\r\n      error: unknown\r\n    ) => unknown;\r\n    expect(typeof categorizeMethod).toBe(\"function\");\r\n\r\n    const apiError = new APICallError({\r\n      message: \"Insufficient balance. Please add credits to continue.\",\r\n      url: \"https://gateway.mux.coder.com/api/v1/ai-gateway/v1/ai/language-model\",\r\n      requestBodyValues: {},\r\n      statusCode: 402,\r\n      responseHeaders: {},\r\n      responseBody:\r\n        '{\"error\":{\"message\":\"Insufficient balance. Please add credits to continue.\",\"type\":\"invalid_request_error\"}}',\r\n      isRetryable: false,\r\n      data: {\r\n        error: { message: \"Insufficient balance. Please add credits to continue.\" },\r\n      },\r\n    });\r\n\r\n    expect(categorizeMethod.call(streamManager, apiError)).toBe(\"quota\");\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - ask_user_question Partial Persistence\", () => {\r\n  // Note: The ask_user_question tool blocks waiting for user input.\r\n  // If the app restarts during that wait, the partial must be persisted.\r\n  // The fix (flush partial immediately for ask_user_question) is verified\r\n  // by the code path in processStreamWithCleanup's tool-call handler:\r\n  //\r\n  //   if (part.toolName === \"ask_user_question\") {\r\n  //     await this.flushPartialWrite(workspaceId, streamInfo);\r\n  //   }\r\n  //\r\n  // Full integration test would require mocking the entire streaming pipeline.\r\n  // Instead, we verify the StreamManager has the expected method signature.\r\n\r\n  test(\"flushPartialWrite is a callable method\", () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    // Verify the private method exists and is callable\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n    const flushMethod = Reflect.get(streamManager, \"flushPartialWrite\");\r\n    expect(typeof flushMethod).toBe(\"function\");\r\n  });\r\n});\r\n\r\ndescribe(\"StreamManager - stopStream\", () => {\r\n  test(\"emits stream-abort when stopping non-existent stream\", async () => {\r\n    const mockPartialService = createMockPartialService();\r\n    const streamManager = new StreamManager(historyService, mockPartialService);\r\n\r\n    // Track emitted events\r\n    const abortEvents: Array<{ workspaceId: string; messageId: string }> = [];\r\n    streamManager.on(\"stream-abort\", (data: { workspaceId: string; messageId: string }) => {\r\n      abortEvents.push(data);\r\n    });\r\n\r\n    // Stop a stream that doesn't exist (simulates interrupt before stream-start)\r\n    const result = await streamManager.stopStream(\"test-workspace\");\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(abortEvents).toHaveLength(1);\r\n    expect(abortEvents[0].workspaceId).toBe(\"test-workspace\");\r\n    // messageId is empty for synthetic abort (no actual stream existed)\r\n    expect(abortEvents[0].messageId).toBe(\"\");\r\n  });\r\n});\r\n\r\n// Note: Comprehensive Anthropic cache control tests are in cacheStrategy.test.ts\r\n// Those unit tests cover all cache control functionality without requiring\r\n// complex setup. StreamManager integrates those functions directly.\r\n"]}