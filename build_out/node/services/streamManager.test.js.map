{"version":3,"file":"streamManager.test.js","sourceRoot":"","sources":["../../../src/node/services/streamManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, test, expect, afterEach, beforeEach, mock } from \"bun:test\";\nimport * as fs from \"node:fs/promises\";\n\nimport { KNOWN_MODELS } from \"@/common/constants/knownModels\";\nimport { StreamManager, stripEncryptedContent } from \"./streamManager\";\nimport { APICallError, RetryError, type ModelMessage } from \"ai\";\nimport type { HistoryService } from \"./historyService\";\nimport { createTestHistoryService } from \"./testHistoryService\";\nimport type { PartialService } from \"./partialService\";\nimport { createAnthropic } from \"@ai-sdk/anthropic\";\nimport { shouldRunIntegrationTests, validateApiKeys } from \"../../../tests/testUtils\";\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\nimport { createRuntime } from \"@/node/runtime/runtimeFactory\";\n\n// Skip integration tests if TEST_INTEGRATION is not set\nconst describeIntegration = shouldRunIntegrationTests() ? describe : describe.skip;\n\n// Validate API keys before running tests\nif (shouldRunIntegrationTests()) {\n  validateApiKeys([\"ANTHROPIC_API_KEY\"]);\n}\n\n// Real HistoryService backed by a temp directory (created fresh per test)\nlet historyService: HistoryService;\nlet historyCleanup: () => Promise<void>;\n\nbeforeEach(async () => {\n  ({ historyService, cleanup: historyCleanup } = await createTestHistoryService());\n});\n\nafterEach(async () => {\n  await historyCleanup();\n});\n\n// Mock PartialService\nconst createMockPartialService = (): PartialService => {\n  return {\n    writePartial: mock(() => Promise.resolve({ success: true })),\n    readPartial: mock(() => Promise.resolve(null)),\n    deletePartial: mock(() => Promise.resolve({ success: true })),\n    commitToHistory: mock(() => Promise.resolve({ success: true })),\n  } as unknown as PartialService;\n};\n\ndescribe(\"StreamManager - createTempDirForStream\", () => {\n  test(\"creates ~/.mux-tmp/<token> under the runtime's home\", async () => {\n    using home = new DisposableTempDir(\"stream-home\");\n\n    const prevHome = process.env.HOME;\n    const prevUserProfile = process.env.USERPROFILE;\n\n    process.env.HOME = home.path;\n    process.env.USERPROFILE = home.path;\n\n    try {\n      const streamManager = new StreamManager(historyService, createMockPartialService());\n      const runtime = createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" });\n\n      const token = streamManager.generateStreamToken();\n      const resolved = await streamManager.createTempDirForStream(token, runtime);\n\n      // StreamManager normalizes Windows paths to forward slashes.\n      const normalizedHomePath = home.path.replace(/\\\\/g, \"/\");\n      expect(resolved.startsWith(normalizedHomePath)).toBe(true);\n      expect(resolved).toContain(`/.mux-tmp/${token}`);\n\n      const stat = await fs.stat(resolved);\n      expect(stat.isDirectory()).toBe(true);\n    } finally {\n      if (prevHome === undefined) {\n        delete process.env.HOME;\n      } else {\n        process.env.HOME = prevHome;\n      }\n\n      if (prevUserProfile === undefined) {\n        delete process.env.USERPROFILE;\n      } else {\n        process.env.USERPROFILE = prevUserProfile;\n      }\n    }\n  });\n});\n\ndescribe(\"StreamManager - stopWhen configuration\", () => {\n  type StopWhenCondition = (options: { steps: unknown[] }) => boolean;\n  type BuildStopWhenCondition = (request: {\n    toolChoice?: { type: \"tool\"; toolName: string } | \"required\";\n    hasQueuedMessage?: () => boolean;\n  }) => StopWhenCondition | StopWhenCondition[];\n\n  test(\"uses single-step stopWhen when a tool is required\", () => {\n    const streamManager = new StreamManager(historyService, createMockPartialService());\n    const buildStopWhen = Reflect.get(streamManager, \"createStopWhenCondition\") as\n      | BuildStopWhenCondition\n      | undefined;\n    expect(typeof buildStopWhen).toBe(\"function\");\n\n    const stopWhen = buildStopWhen!({ toolChoice: { type: \"tool\", toolName: \"bash\" } });\n    if (typeof stopWhen !== \"function\") {\n      throw new Error(\"Expected required-tool stopWhen to be a single condition function\");\n    }\n\n    expect(stopWhen({ steps: [] })).toBe(false);\n    expect(stopWhen({ steps: [{}] })).toBe(true);\n    expect(stopWhen({ steps: [{}, {}] })).toBe(false);\n  });\n\n  test(\"uses autonomous step cap and queued-message interrupt conditions\", () => {\n    const streamManager = new StreamManager(historyService, createMockPartialService());\n    const buildStopWhen = Reflect.get(streamManager, \"createStopWhenCondition\") as\n      | BuildStopWhenCondition\n      | undefined;\n    expect(typeof buildStopWhen).toBe(\"function\");\n\n    let queued = false;\n    const stopWhen = buildStopWhen!({ hasQueuedMessage: () => queued });\n    if (!Array.isArray(stopWhen)) {\n      throw new Error(\"Expected autonomous stopWhen to be an array of conditions\");\n    }\n    expect(stopWhen).toHaveLength(2);\n\n    const [maxStepCondition, queuedMessageCondition] = stopWhen;\n    expect(maxStepCondition({ steps: new Array(99999) })).toBe(false);\n    expect(maxStepCondition({ steps: new Array(100000) })).toBe(true);\n\n    expect(queuedMessageCondition({ steps: [] })).toBe(false);\n    queued = true;\n    expect(queuedMessageCondition({ steps: [] })).toBe(true);\n  });\n\n  test(\"treats missing queued-message callback as not queued\", () => {\n    const streamManager = new StreamManager(historyService, createMockPartialService());\n    const buildStopWhen = Reflect.get(streamManager, \"createStopWhenCondition\") as\n      | BuildStopWhenCondition\n      | undefined;\n    expect(typeof buildStopWhen).toBe(\"function\");\n\n    const stopWhen = buildStopWhen!({});\n    if (!Array.isArray(stopWhen)) {\n      throw new Error(\"Expected autonomous stopWhen to remain array-based without callback\");\n    }\n\n    const [, queuedMessageCondition] = stopWhen;\n    expect(queuedMessageCondition({ steps: [] })).toBe(false);\n  });\n});\n\ndescribe(\"StreamManager - stripEncryptedContent\", () => {\n  test(\"strips encryptedContent from array output shape\", () => {\n    const output = [\n      {\n        url: \"https://example.com/a\",\n        title: \"Result A\",\n        pageAge: \"2d\",\n        encryptedContent: \"secret-a\",\n      },\n      {\n        url: \"https://example.com/b\",\n        title: \"Result B\",\n      },\n      \"non-object-item\",\n    ];\n\n    expect(stripEncryptedContent(output)).toEqual([\n      {\n        url: \"https://example.com/a\",\n        title: \"Result A\",\n        pageAge: \"2d\",\n      },\n      {\n        url: \"https://example.com/b\",\n        title: \"Result B\",\n      },\n      \"non-object-item\",\n    ]);\n  });\n\n  test(\"strips encryptedContent from json value output shape\", () => {\n    const output = {\n      type: \"json\",\n      value: [\n        {\n          url: \"https://example.com/c\",\n          title: \"Result C\",\n          encryptedContent: \"secret-c\",\n        },\n        {\n          url: \"https://example.com/d\",\n          title: \"Result D\",\n          pageAge: \"5h\",\n        },\n      ],\n      source: \"web_search\",\n    };\n\n    expect(stripEncryptedContent(output)).toEqual({\n      type: \"json\",\n      value: [\n        {\n          url: \"https://example.com/c\",\n          title: \"Result C\",\n        },\n        {\n          url: \"https://example.com/d\",\n          title: \"Result D\",\n          pageAge: \"5h\",\n        },\n      ],\n      source: \"web_search\",\n    });\n  });\n});\n\ndescribe(\"StreamManager - Concurrent Stream Prevention\", () => {\n  let streamManager: StreamManager;\n  let mockPartialService: PartialService;\n  const runtime = createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" });\n\n  beforeEach(() => {\n    mockPartialService = createMockPartialService();\n    streamManager = new StreamManager(historyService, mockPartialService);\n    // Suppress error events from bubbling up as uncaught exceptions during tests\n    streamManager.on(\"error\", () => undefined);\n  });\n\n  // Integration test - requires API key and TEST_INTEGRATION=1\n  describeIntegration(\"with real API\", () => {\n    test(\"should prevent concurrent streams for the same workspace\", async () => {\n      const workspaceId = \"test-workspace-concurrent\";\n      const anthropic = createAnthropic({ apiKey: process.env.ANTHROPIC_API_KEY });\n      const model = anthropic(\"claude-sonnet-4-5\");\n\n      // Track when streams are actively processing\n      const streamStates: Record<string, { started: boolean; finished: boolean }> = {};\n      let firstMessageId: string | undefined;\n\n      streamManager.on(\"stream-start\", (data: { messageId: string; historySequence: number }) => {\n        streamStates[data.messageId] = { started: true, finished: false };\n        if (data.historySequence === 1) {\n          firstMessageId = data.messageId;\n        }\n      });\n\n      streamManager.on(\"stream-end\", (data: { messageId: string }) => {\n        if (streamStates[data.messageId]) {\n          streamStates[data.messageId].finished = true;\n        }\n      });\n\n      streamManager.on(\"stream-abort\", (data: { messageId: string }) => {\n        if (streamStates[data.messageId]) {\n          streamStates[data.messageId].finished = true;\n        }\n      });\n\n      // Start first stream\n      const result1 = await streamManager.startStream(\n        workspaceId,\n        [{ role: \"user\", content: \"Say hello and nothing else\" }],\n        model,\n        KNOWN_MODELS.SONNET.id,\n        1,\n        \"You are a helpful assistant\",\n        runtime,\n        \"test-msg-1\",\n        undefined,\n        {}\n      );\n\n      expect(result1.success).toBe(true);\n\n      // Wait for first stream to actually start\n      await new Promise((resolve) => setTimeout(resolve, 200));\n\n      // Start second stream - should cancel first\n      const result2 = await streamManager.startStream(\n        workspaceId,\n        [{ role: \"user\", content: \"Say goodbye and nothing else\" }],\n        model,\n        KNOWN_MODELS.SONNET.id,\n        2,\n        \"You are a helpful assistant\",\n        runtime,\n        \"test-msg-2\",\n        undefined,\n        {}\n      );\n\n      expect(result2.success).toBe(true);\n\n      // Wait for second stream to complete\n      await new Promise((resolve) => setTimeout(resolve, 5000));\n\n      // Verify: first stream should have been cancelled before second stream started\n      expect(firstMessageId).toBeDefined();\n      const trackedFirstMessageId = firstMessageId!;\n      expect(streamStates[trackedFirstMessageId]).toBeDefined();\n      expect(streamStates[trackedFirstMessageId].started).toBe(true);\n      expect(streamStates[trackedFirstMessageId].finished).toBe(true);\n\n      // Verify no streams are active after completion\n      expect(streamManager.isStreaming(workspaceId)).toBe(false);\n    }, 10000);\n  });\n\n  // Unit test - doesn't require API key\n  test(\"should serialize multiple rapid startStream calls\", async () => {\n    // This is a simpler test that doesn't require API key\n    // It tests the mutex behavior without actually streaming\n\n    const workspaceId = \"test-workspace-serial\";\n\n    // Track the order of operations\n    const operations: string[] = [];\n\n    // Create a dummy model (won't actually be used since we're mocking the core behavior)\n    const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\n\n    interface WorkspaceStreamInfoStub {\n      state: string;\n      streamResult: {\n        fullStream: AsyncGenerator<unknown, void, unknown>;\n        usage: Promise<unknown>;\n        providerMetadata: Promise<unknown>;\n      };\n      abortController: AbortController;\n      messageId: string;\n      token: string;\n      startTime: number;\n      model: string;\n      initialMetadata?: Record<string, unknown>;\n      historySequence: number;\n      parts: unknown[];\n      lastPartialWriteTime: number;\n      partialWriteTimer?: ReturnType<typeof setTimeout>;\n      partialWritePromise?: Promise<void>;\n      processingPromise: Promise<void>;\n    }\n\n    const replaceEnsureResult = Reflect.set(\n      streamManager,\n      \"ensureStreamSafety\",\n      async (_wsId: string): Promise<string> => {\n        operations.push(\"ensure-start\");\n        await new Promise((resolve) => setTimeout(resolve, 50));\n        operations.push(\"ensure-end\");\n        return \"test-token\";\n      }\n    );\n\n    const replaceTempDirResult = Reflect.set(\n      streamManager,\n      \"createTempDirForStream\",\n      (_streamToken: string, _runtime: unknown): Promise<string> => {\n        return Promise.resolve(\"/tmp/mock-stream-temp\");\n      }\n    );\n\n    if (!replaceTempDirResult) {\n      throw new Error(\"Failed to mock StreamManager.createTempDirForStream\");\n    }\n    if (!replaceEnsureResult) {\n      throw new Error(\"Failed to mock StreamManager.ensureStreamSafety\");\n    }\n\n    const workspaceStreamsValue = Reflect.get(streamManager, \"workspaceStreams\") as unknown;\n    if (!(workspaceStreamsValue instanceof Map)) {\n      throw new Error(\"StreamManager.workspaceStreams is not a Map\");\n    }\n    const workspaceStreams = workspaceStreamsValue as Map<string, WorkspaceStreamInfoStub>;\n\n    const replaceCreateResult = Reflect.set(\n      streamManager,\n      \"createStreamAtomically\",\n      (\n        wsId: string,\n        streamToken: string,\n        _runtimeTempDir: string,\n        _runtime: unknown,\n        _messages: unknown,\n        _modelArg: unknown,\n        modelString: string,\n        abortController: AbortController,\n        _system: string,\n        historySequence: number,\n        _messageId: string,\n        _tools?: Record<string, unknown>,\n        initialMetadata?: Record<string, unknown>,\n        _providerOptions?: Record<string, unknown>,\n        _maxOutputTokens?: number,\n        _toolPolicy?: unknown\n      ): WorkspaceStreamInfoStub => {\n        operations.push(\"create\");\n\n        const streamInfo: WorkspaceStreamInfoStub = {\n          state: \"starting\",\n          streamResult: {\n            fullStream: (async function* asyncGenerator() {\n              // No-op generator; we only care about synchronization\n            })(),\n            usage: Promise.resolve(undefined),\n            providerMetadata: Promise.resolve(undefined),\n          },\n          abortController,\n          messageId: `test-${Math.random().toString(36).slice(2)}`,\n          token: streamToken,\n          startTime: Date.now(),\n          model: modelString,\n          initialMetadata,\n          historySequence,\n          parts: [],\n          lastPartialWriteTime: 0,\n          partialWriteTimer: undefined,\n          partialWritePromise: undefined,\n          processingPromise: Promise.resolve(),\n        };\n\n        workspaceStreams.set(wsId, streamInfo);\n        return streamInfo;\n      }\n    );\n\n    if (!replaceCreateResult) {\n      throw new Error(\"Failed to mock StreamManager.createStreamAtomically\");\n    }\n\n    const replaceProcessResult = Reflect.set(\n      streamManager,\n      \"processStreamWithCleanup\",\n      async (_wsId: string, info: WorkspaceStreamInfoStub): Promise<void> => {\n        operations.push(\"process-start\");\n        await sleep(20);\n        info.state = \"streaming\";\n        operations.push(\"process-end\");\n      }\n    );\n\n    if (!replaceProcessResult) {\n      throw new Error(\"Failed to mock StreamManager.processStreamWithCleanup\");\n    }\n\n    const anthropic = createAnthropic({ apiKey: \"dummy-key\" });\n    const model = anthropic(\"claude-sonnet-4-5\");\n\n    // Start three streams rapidly\n    // Without mutex, these would interleave (ensure-start, ensure-start, ensure-start, ensure-end, ensure-end, ensure-end)\n    // With mutex, they should be serialized (ensure-start, ensure-end, ensure-start, ensure-end, ensure-start, ensure-end)\n    const promises = [\n      streamManager.startStream(\n        workspaceId,\n        [{ role: \"user\", content: \"test 1\" }],\n        model,\n        KNOWN_MODELS.SONNET.id,\n        1,\n        \"system\",\n        runtime,\n        \"test-msg-1\",\n        undefined,\n        {}\n      ),\n      streamManager.startStream(\n        workspaceId,\n        [{ role: \"user\", content: \"test 2\" }],\n        model,\n        KNOWN_MODELS.SONNET.id,\n        2,\n        \"system\",\n        runtime,\n        \"test-msg-2\",\n        undefined,\n        {}\n      ),\n      streamManager.startStream(\n        workspaceId,\n        [{ role: \"user\", content: \"test 3\" }],\n        model,\n        KNOWN_MODELS.SONNET.id,\n        3,\n        \"system\",\n        runtime,\n        \"test-msg-3\",\n        undefined,\n        {}\n      ),\n    ];\n\n    // Wait for all to complete (they will fail due to dummy API key, but that's ok)\n    await Promise.allSettled(promises);\n\n    // Verify operations are serialized: each ensure-start should be followed by its ensure-end\n    // before the next ensure-start\n    const ensureOperations = operations.filter((op) => op.startsWith(\"ensure\"));\n    for (let i = 0; i < ensureOperations.length - 1; i += 2) {\n      expect(ensureOperations[i]).toBe(\"ensure-start\");\n      expect(ensureOperations[i + 1]).toBe(\"ensure-end\");\n    }\n  });\n\n  test(\"should honor abortSignal before atomic stream creation\", async () => {\n    const workspaceId = \"test-workspace-abort-before-create\";\n\n    let createCalled = false;\n    let processCalled = false;\n    let streamStartEmitted = false;\n\n    streamManager.on(\"stream-start\", () => {\n      streamStartEmitted = true;\n    });\n\n    const abortController = new AbortController();\n\n    let tempDirStartedResolve: (() => void) | undefined;\n    const tempDirStarted = new Promise<void>((resolve) => {\n      tempDirStartedResolve = resolve;\n    });\n\n    const replaceTempDirResult = Reflect.set(\n      streamManager,\n      \"createTempDirForStream\",\n      (_streamToken: string, _runtime: unknown): Promise<string> => {\n        tempDirStartedResolve?.();\n        return new Promise((resolve) => {\n          abortController.signal.addEventListener(\"abort\", () => resolve(\"/tmp/mock-stream-temp\"), {\n            once: true,\n          });\n        });\n      }\n    );\n\n    if (!replaceTempDirResult) {\n      throw new Error(\"Failed to mock StreamManager.createTempDirForStream\");\n    }\n\n    let cleanupCalled = false;\n    const replaceCleanupResult = Reflect.set(\n      streamManager,\n      \"cleanupStreamTempDir\",\n      (..._args: unknown[]): void => {\n        cleanupCalled = true;\n      }\n    );\n\n    if (!replaceCleanupResult) {\n      throw new Error(\"Failed to mock StreamManager.cleanupStreamTempDir\");\n    }\n\n    const replaceCreateResult = Reflect.set(\n      streamManager,\n      \"createStreamAtomically\",\n      (..._args: unknown[]): never => {\n        createCalled = true;\n        throw new Error(\"createStreamAtomically should not be called\");\n      }\n    );\n\n    if (!replaceCreateResult) {\n      throw new Error(\"Failed to mock StreamManager.createStreamAtomically\");\n    }\n\n    const replaceProcessResult = Reflect.set(\n      streamManager,\n      \"processStreamWithCleanup\",\n      (..._args: unknown[]): Promise<void> => {\n        processCalled = true;\n        return Promise.resolve();\n      }\n    );\n\n    if (!replaceProcessResult) {\n      throw new Error(\"Failed to mock StreamManager.processStreamWithCleanup\");\n    }\n\n    const anthropic = createAnthropic({ apiKey: \"dummy-key\" });\n    const model = anthropic(\"claude-sonnet-4-5\");\n\n    const startPromise = streamManager.startStream(\n      workspaceId,\n      [{ role: \"user\", content: \"test\" }],\n      model,\n      KNOWN_MODELS.SONNET.id,\n      1,\n      \"system\",\n      runtime,\n      \"test-msg-abort\",\n      abortController.signal,\n      {}\n    );\n\n    await tempDirStarted;\n    abortController.abort();\n\n    const result = await startPromise;\n    expect(result.success).toBe(true);\n    expect(createCalled).toBe(false);\n    expect(cleanupCalled).toBe(true);\n    expect(processCalled).toBe(false);\n    expect(streamStartEmitted).toBe(false);\n    expect(streamManager.isStreaming(workspaceId)).toBe(false);\n  });\n});\n\ndescribe(\"StreamManager - Unavailable Tool Handling\", () => {\n  let streamManager: StreamManager;\n  let mockPartialService: PartialService;\n\n  beforeEach(() => {\n    mockPartialService = createMockPartialService();\n    streamManager = new StreamManager(historyService, mockPartialService);\n    // Suppress error events - processStreamWithCleanup may throw due to tokenizer worker issues in test env\n    streamManager.on(\"error\", () => undefined);\n  });\n\n  test.skip(\"should handle tool-error events from SDK\", async () => {\n    const workspaceId = \"test-workspace-tool-error\";\n\n    // Track emitted events\n    interface ToolEvent {\n      type: string;\n      toolName?: string;\n      result?: unknown;\n    }\n    const events: ToolEvent[] = [];\n\n    streamManager.on(\"tool-call-start\", (data: { toolName: string }) => {\n      events.push({ type: \"tool-call-start\", toolName: data.toolName });\n    });\n\n    streamManager.on(\"tool-call-end\", (data: { toolName: string; result: unknown }) => {\n      events.push({ type: \"tool-call-end\", toolName: data.toolName, result: data.result });\n    });\n\n    // Mock a stream that emits tool-error event (AI SDK 5.0 behavior)\n    const mockStreamResult = {\n      // eslint-disable-next-line @typescript-eslint/require-await\n      fullStream: (async function* () {\n        // SDK emits tool-call when model requests a tool\n        yield {\n          type: \"tool-call\",\n          toolCallId: \"test-call-1\",\n          toolName: \"file_edit_replace\",\n          input: { file_path: \"/test\", old_string: \"foo\", new_string: \"bar\" },\n        };\n        // SDK emits tool-error when tool execution fails\n        yield {\n          type: \"tool-error\",\n          toolCallId: \"test-call-1\",\n          toolName: \"file_edit_replace\",\n          error: \"Tool not found\",\n        };\n      })(),\n      usage: Promise.resolve(undefined),\n      providerMetadata: Promise.resolve({}),\n    };\n\n    // Create streamInfo for testing\n    const streamInfo = {\n      state: 2, // STREAMING\n      streamResult: mockStreamResult,\n      abortController: new AbortController(),\n      messageId: \"test-message-1\",\n      token: \"test-token\",\n      startTime: Date.now(),\n      model: KNOWN_MODELS.SONNET.id,\n      historySequence: 1,\n      parts: [],\n      lastPartialWriteTime: 0,\n      processingPromise: Promise.resolve(),\n    };\n\n    // Access private method for testing\n    // @ts-expect-error - accessing private method for testing\n    await streamManager.processStreamWithCleanup(workspaceId, streamInfo, 1);\n\n    // Verify events were emitted correctly\n    expect(events.length).toBeGreaterThanOrEqual(2);\n    expect(events[0]).toMatchObject({\n      type: \"tool-call-start\",\n      toolName: \"file_edit_replace\",\n    });\n    expect(events[1]).toMatchObject({\n      type: \"tool-call-end\",\n      toolName: \"file_edit_replace\",\n    });\n\n    // Verify error result\n    const errorResult = events[1].result as { error?: string };\n    expect(errorResult?.error).toBe(\"Tool not found\");\n  });\n});\n\ndescribe(\"StreamManager - previousResponseId recovery\", () => {\n  test(\"isResponseIdLost returns false for unknown IDs\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    // Verify the ID is not lost initially\n    expect(streamManager.isResponseIdLost(\"resp_123abc\")).toBe(false);\n    expect(streamManager.isResponseIdLost(\"resp_different\")).toBe(false);\n  });\n\n  test(\"extractPreviousResponseIdFromError extracts ID from various error formats\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    // Get the private method via reflection\n    const extractMethod = Reflect.get(streamManager, \"extractPreviousResponseIdFromError\") as (\n      error: unknown\n    ) => string | undefined;\n    expect(typeof extractMethod).toBe(\"function\");\n\n    // Test extraction from APICallError with responseBody\n    const apiError = new APICallError({\n      message: \"Previous response with id 'resp_abc123' not found.\",\n      url: \"https://api.openai.com/v1/responses\",\n      requestBodyValues: {},\n      statusCode: 400,\n      responseHeaders: {},\n      responseBody:\n        '{\"error\":{\"message\":\"Previous response with id \\'resp_abc123\\' not found.\",\"code\":\"previous_response_not_found\"}}',\n      isRetryable: false,\n      data: { error: { code: \"previous_response_not_found\" } },\n    });\n    expect(extractMethod.call(streamManager, apiError)).toBe(\"resp_abc123\");\n\n    // Test extraction from error message\n    const errorWithMessage = new Error(\"Previous response with id 'resp_def456' not found.\");\n    expect(extractMethod.call(streamManager, errorWithMessage)).toBe(\"resp_def456\");\n\n    // Test when no ID is present\n    const errorWithoutId = new Error(\"Some other error\");\n    expect(extractMethod.call(streamManager, errorWithoutId)).toBeUndefined();\n  });\n\n  test(\"recordLostResponseIdIfApplicable records IDs for explicit OpenAI errors\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const recordMethod = Reflect.get(streamManager, \"recordLostResponseIdIfApplicable\") as (\n      workspaceId: string,\n      error: unknown,\n      streamInfo: unknown\n    ) => void;\n    expect(typeof recordMethod).toBe(\"function\");\n\n    const apiError = new APICallError({\n      message: \"Previous response with id 'resp_deadbeef' not found.\",\n      url: \"https://api.openai.com/v1/responses\",\n      requestBodyValues: {},\n      statusCode: 400,\n      responseHeaders: {},\n      responseBody: \"Previous response with id 'resp_deadbeef' not found.\",\n      isRetryable: false,\n      data: { error: { code: \"previous_response_not_found\" } },\n    });\n\n    recordMethod.call(streamManager, \"workspace-1\", apiError, {\n      messageId: \"msg-1\",\n      model: \"openai:gpt-mini\",\n    });\n\n    expect(streamManager.isResponseIdLost(\"resp_deadbeef\")).toBe(true);\n  });\n\n  test(\"recordLostResponseIdIfApplicable records IDs for 500 errors referencing previous responses\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const recordMethod = Reflect.get(streamManager, \"recordLostResponseIdIfApplicable\") as (\n      workspaceId: string,\n      error: unknown,\n      streamInfo: unknown\n    ) => void;\n    expect(typeof recordMethod).toBe(\"function\");\n\n    const apiError = new APICallError({\n      message: \"Internal error: Previous response with id 'resp_cafebabe' not found.\",\n      url: \"https://api.openai.com/v1/responses\",\n      requestBodyValues: {},\n      statusCode: 500,\n      responseHeaders: {},\n      responseBody: \"Internal error: Previous response with id 'resp_cafebabe' not found.\",\n      isRetryable: false,\n      data: { error: { code: \"server_error\" } },\n    });\n\n    recordMethod.call(streamManager, \"workspace-2\", apiError, {\n      messageId: \"msg-2\",\n      model: \"openai:gpt-mini\",\n    });\n\n    expect(streamManager.isResponseIdLost(\"resp_cafebabe\")).toBe(true);\n  });\n\n  test(\"retryStreamWithoutPreviousResponseId retries at step boundary with existing parts\", async () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const retryMethod = Reflect.get(streamManager, \"retryStreamWithoutPreviousResponseId\") as (\n      workspaceId: string,\n      streamInfo: unknown,\n      error: unknown,\n      hasRetried: boolean\n    ) => Promise<boolean>;\n\n    const model = createAnthropic({ apiKey: \"test\" })(\"claude-sonnet-4-5\");\n    const runtime = createRuntime({ type: \"local\", srcBaseDir: \"/tmp\" });\n    const stepMessages: ModelMessage[] = [{ role: \"user\", content: \"next step\" }];\n\n    const streamInfo = {\n      state: \"streaming\",\n      streamResult: {},\n      abortController: new AbortController(),\n      messageId: \"msg-1\",\n      token: \"token\",\n      startTime: Date.now(),\n      model: \"mux-gateway:openai/gpt-5.2-codex\",\n      historySequence: 1,\n      stepTracker: { latestMessages: stepMessages },\n      didRetryPreviousResponseIdAtStep: false,\n      currentStepStartIndex: 1,\n      request: {\n        model,\n        messages: [{ role: \"user\", content: \"original\" }],\n        system: \"system\",\n        providerOptions: { openai: { previousResponseId: \"resp_abc123\" } },\n      },\n      parts: [\n        {\n          type: \"dynamic-tool\",\n          toolCallId: \"tool-1\",\n          toolName: \"test\",\n          state: \"output-available\",\n          input: {},\n          output: {},\n        },\n      ],\n      lastPartialWriteTime: 0,\n      processingPromise: Promise.resolve(),\n      softInterrupt: { pending: false },\n      runtimeTempDir: \"/tmp\",\n      runtime,\n      cumulativeUsage: { inputTokens: 1, outputTokens: 2, totalTokens: 3 },\n      cumulativeProviderMetadata: { openai: {} },\n    };\n\n    (streamManager as unknown as { createStreamResult: () => unknown }).createStreamResult =\n      () => ({\n        fullStream: (async function* () {\n          await Promise.resolve();\n          yield* [];\n        })(),\n        totalUsage: Promise.resolve(undefined),\n        usage: Promise.resolve(undefined),\n        providerMetadata: Promise.resolve(undefined),\n        steps: Promise.resolve([]),\n      });\n\n    const apiError = new APICallError({\n      message: \"Previous response with id 'resp_abc123' not found.\",\n      url: \"https://api.openai.com/v1/responses\",\n      requestBodyValues: {},\n      statusCode: 400,\n      responseHeaders: {},\n      responseBody: \"Previous response with id 'resp_abc123' not found.\",\n      isRetryable: false,\n      data: { error: { code: \"previous_response_not_found\" } },\n    });\n\n    const retried = await retryMethod.call(streamManager, \"ws-step\", streamInfo, apiError, false);\n    expect(retried).toBe(true);\n    expect(streamInfo.parts).toHaveLength(1);\n    expect(streamInfo.didRetryPreviousResponseIdAtStep).toBe(true);\n    expect(streamInfo.request.messages as ModelMessage[]).toBe(stepMessages);\n\n    const openaiOptions = streamInfo.request.providerOptions as {\n      openai?: Record<string, unknown>;\n    };\n    expect(openaiOptions.openai?.previousResponseId).toBeUndefined();\n  });\n\n  test(\"resolveTotalUsageForStreamEnd prefers cumulative usage after step retry\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const resolveMethod = Reflect.get(streamManager, \"resolveTotalUsageForStreamEnd\") as (\n      streamInfo: unknown,\n      totalUsage: unknown\n    ) => unknown;\n    expect(typeof resolveMethod).toBe(\"function\");\n\n    const cumulativeUsage = { inputTokens: 4, outputTokens: 5, totalTokens: 9 };\n    const totalUsage = { inputTokens: 1, outputTokens: 2, totalTokens: 3 };\n\n    const result = resolveMethod.call(\n      streamManager,\n      { didRetryPreviousResponseIdAtStep: true, cumulativeUsage },\n      totalUsage\n    );\n\n    expect(result).toEqual(cumulativeUsage);\n  });\n\n  test(\"resolveTotalUsageForStreamEnd treats non-zero fields as valid usage\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const resolveMethod = Reflect.get(streamManager, \"resolveTotalUsageForStreamEnd\") as (\n      streamInfo: unknown,\n      totalUsage: unknown\n    ) => unknown;\n    expect(typeof resolveMethod).toBe(\"function\");\n\n    const cumulativeUsage = { inputTokens: 4, outputTokens: 1, totalTokens: 0 };\n    const totalUsage = { inputTokens: 1, outputTokens: 2, totalTokens: 3 };\n\n    const result = resolveMethod.call(\n      streamManager,\n      { didRetryPreviousResponseIdAtStep: true, cumulativeUsage },\n      totalUsage\n    );\n\n    expect(result).toEqual(cumulativeUsage);\n  });\n\n  test(\"resolveTotalUsageForStreamEnd keeps stream total without step retry\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const resolveMethod = Reflect.get(streamManager, \"resolveTotalUsageForStreamEnd\") as (\n      streamInfo: unknown,\n      totalUsage: unknown\n    ) => unknown;\n    expect(typeof resolveMethod).toBe(\"function\");\n\n    const cumulativeUsage = { inputTokens: 4, outputTokens: 5, totalTokens: 9 };\n    const totalUsage = { inputTokens: 1, outputTokens: 2, totalTokens: 3 };\n\n    const result = resolveMethod.call(\n      streamManager,\n      { didRetryPreviousResponseIdAtStep: false, cumulativeUsage },\n      totalUsage\n    );\n\n    expect(result).toEqual(totalUsage);\n  });\n});\n\ndescribe(\"StreamManager - replayStream\", () => {\n  test(\"replayStream snapshots parts so reconnect doesn't block until stream ends\", async () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    // Suppress error events from bubbling up as uncaught exceptions during tests\n    streamManager.on(\"error\", () => undefined);\n\n    let sawStreamStart = false;\n    streamManager.on(\"stream-start\", (event: { replay?: boolean | undefined }) => {\n      sawStreamStart = true;\n      expect(event.replay).toBe(true);\n    });\n    const workspaceId = \"ws-replay-snapshot\";\n\n    const deltas: string[] = [];\n    streamManager.on(\"stream-delta\", (event: { delta: string; replay?: boolean | undefined }) => {\n      expect(event.replay).toBe(true);\n      deltas.push(event.delta);\n    });\n\n    // Inject an active stream into the private workspaceStreams map.\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n    const workspaceStreamsValue = Reflect.get(streamManager, \"workspaceStreams\");\n    if (!(workspaceStreamsValue instanceof Map)) {\n      throw new Error(\"StreamManager.workspaceStreams is not a Map\");\n    }\n    const workspaceStreams = workspaceStreamsValue as Map<string, unknown>;\n\n    const streamInfo = {\n      state: \"streaming\",\n      messageId: \"msg-1\",\n      model: \"claude-sonnet-4\",\n      historySequence: 1,\n      startTime: 123,\n      initialMetadata: {},\n      parts: [{ type: \"text\", text: \"a\", timestamp: 10 }],\n    };\n\n    workspaceStreams.set(workspaceId, streamInfo);\n\n    // Patch the private tokenTracker to (a) avoid worker setup and (b) mutate parts during replay.\n    const tokenTracker = Reflect.get(streamManager, \"tokenTracker\") as {\n      setModel: (model: string) => Promise<void>;\n      countTokens: (text: string) => Promise<number>;\n    };\n\n    tokenTracker.setModel = () => Promise.resolve();\n\n    let pushed = false;\n    tokenTracker.countTokens = async () => {\n      if (!pushed) {\n        pushed = true;\n        // While replay is mid-await, simulate the running stream appending more parts.\n        (streamInfo.parts as Array<{ type: string; text?: string; timestamp?: number }>).push({\n          type: \"text\",\n          text: \"b\",\n          timestamp: 20,\n        });\n      }\n      // Force an await boundary so the mutation happens during replay.\n      await new Promise((resolve) => setTimeout(resolve, 0));\n      return 1;\n    };\n\n    await streamManager.replayStream(workspaceId);\n    expect(sawStreamStart).toBe(true);\n\n    // If replayStream iterates the live array, it would also emit \"b\".\n    expect(deltas).toEqual([\"a\"]);\n  });\n});\n\ndescribe(\"StreamManager - categorizeError\", () => {\n  test(\"unwraps RetryError.lastError to classify model_not_found\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const categorizeMethod = Reflect.get(streamManager, \"categorizeError\") as (\n      error: unknown\n    ) => unknown;\n    expect(typeof categorizeMethod).toBe(\"function\");\n\n    const apiError = new APICallError({\n      message: \"The model `gpt-5.2-codex` does not exist or you do not have access to it.\",\n      url: \"https://api.openai.com/v1/responses\",\n      requestBodyValues: {},\n      statusCode: 400,\n      responseHeaders: {},\n      responseBody:\n        '{\"error\":{\"message\":\"The model `gpt-5.2-codex` does not exist or you do not have access to it.\",\"code\":\"model_not_found\"}}',\n      isRetryable: false,\n      data: { error: { code: \"model_not_found\" } },\n    });\n\n    const retryError = new RetryError({\n      message: \"AI SDK retry exhausted\",\n      reason: \"maxRetriesExceeded\",\n      errors: [apiError],\n    });\n\n    expect(categorizeMethod.call(streamManager, retryError)).toBe(\"model_not_found\");\n  });\n\n  test(\"classifies model_not_found via message fallback\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const categorizeMethod = Reflect.get(streamManager, \"categorizeError\") as (\n      error: unknown\n    ) => unknown;\n    expect(typeof categorizeMethod).toBe(\"function\");\n\n    const error = new Error(\n      \"The model `gpt-5.2-codex` does not exist or you do not have access to it.\"\n    );\n\n    expect(categorizeMethod.call(streamManager, error)).toBe(\"model_not_found\");\n  });\n\n  test(\"classifies 402 payment required as quota (avoid auto-retry)\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    const categorizeMethod = Reflect.get(streamManager, \"categorizeError\") as (\n      error: unknown\n    ) => unknown;\n    expect(typeof categorizeMethod).toBe(\"function\");\n\n    const apiError = new APICallError({\n      message: \"Insufficient balance. Please add credits to continue.\",\n      url: \"https://gateway.mux.coder.com/api/v1/ai-gateway/v1/ai/language-model\",\n      requestBodyValues: {},\n      statusCode: 402,\n      responseHeaders: {},\n      responseBody:\n        '{\"error\":{\"message\":\"Insufficient balance. Please add credits to continue.\",\"type\":\"invalid_request_error\"}}',\n      isRetryable: false,\n      data: {\n        error: { message: \"Insufficient balance. Please add credits to continue.\" },\n      },\n    });\n\n    expect(categorizeMethod.call(streamManager, apiError)).toBe(\"quota\");\n  });\n});\n\ndescribe(\"StreamManager - ask_user_question Partial Persistence\", () => {\n  // Note: The ask_user_question tool blocks waiting for user input.\n  // If the app restarts during that wait, the partial must be persisted.\n  // The fix (flush partial immediately for ask_user_question) is verified\n  // by the code path in processStreamWithCleanup's tool-call handler:\n  //\n  //   if (part.toolName === \"ask_user_question\") {\n  //     await this.flushPartialWrite(workspaceId, streamInfo);\n  //   }\n  //\n  // Full integration test would require mocking the entire streaming pipeline.\n  // Instead, we verify the StreamManager has the expected method signature.\n\n  test(\"flushPartialWrite is a callable method\", () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    // Verify the private method exists and is callable\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n    const flushMethod = Reflect.get(streamManager, \"flushPartialWrite\");\n    expect(typeof flushMethod).toBe(\"function\");\n  });\n});\n\ndescribe(\"StreamManager - stopStream\", () => {\n  test(\"emits stream-abort when stopping non-existent stream\", async () => {\n    const mockPartialService = createMockPartialService();\n    const streamManager = new StreamManager(historyService, mockPartialService);\n\n    // Track emitted events\n    const abortEvents: Array<{ workspaceId: string; messageId: string }> = [];\n    streamManager.on(\"stream-abort\", (data: { workspaceId: string; messageId: string }) => {\n      abortEvents.push(data);\n    });\n\n    // Stop a stream that doesn't exist (simulates interrupt before stream-start)\n    const result = await streamManager.stopStream(\"test-workspace\");\n\n    expect(result.success).toBe(true);\n    expect(abortEvents).toHaveLength(1);\n    expect(abortEvents[0].workspaceId).toBe(\"test-workspace\");\n    // messageId is empty for synthetic abort (no actual stream existed)\n    expect(abortEvents[0].messageId).toBe(\"\");\n  });\n});\n\n// Note: Comprehensive Anthropic cache control tests are in cacheStrategy.test.ts\n// Those unit tests cover all cache control functionality without requiring\n// complex setup. StreamManager integrates those functions directly.\n"]}