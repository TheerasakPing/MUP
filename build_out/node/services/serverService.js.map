{"version":3,"file":"serverService.js","sourceRoot":"","sources":["../../../src/node/services/serverService.ts"],"names":[],"mappings":"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","sourcesContent":["import { createOrpcServer, type OrpcServer, type OrpcServerOptions } from \"@/node/orpc/server\";\nimport { ServerLockfile } from \"./serverLockfile\";\nimport type { ORPCContext } from \"@/node/orpc/context\";\nimport * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport { log } from \"./log\";\nimport * as os from \"os\";\nimport { VERSION } from \"@/version\";\nimport { buildMuxMdnsServiceOptions, MdnsAdvertiserService } from \"./mdnsAdvertiserService\";\nimport type { AppRouter } from \"@/node/orpc/router\";\n\nexport interface ServerInfo {\n  /** Base URL that is always connectable from the local machine (loopback for wildcard binds). */\n  baseUrl: string;\n  /** Auth token required for HTTP/WS API access. */\n  token: string;\n  /** The host/interface the server is actually bound to (e.g. \"127.0.0.1\" or \"0.0.0.0\"). */\n  bindHost: string;\n  /** The port the server is listening on. */\n  port: number;\n  /** Additional base URLs that may be reachable from other devices (LAN/VPN). */\n  networkBaseUrls: string[];\n}\n\nexport interface StartServerOptions {\n  /** Path to mux home directory (for lockfile) */\n  muxHome: string;\n  /** oRPC context with services */\n  context: ORPCContext;\n  /** Host/interface to bind to (default: \"127.0.0.1\") */\n  host?: string;\n  /** Auth token for the server */\n  authToken: string;\n  /** Port to bind to (0 = random) */\n  port?: number;\n  /** Optional pre-created router (if not provided, creates router(authToken)) */\n  router?: AppRouter;\n  /** Whether to serve static files */\n  serveStatic?: boolean;\n}\n\ntype NetworkInterfaces = NodeJS.Dict<os.NetworkInterfaceInfo[]>;\n\nfunction isLoopbackHost(host: string): boolean {\n  const normalized = host.trim().toLowerCase();\n\n  // IPv4 loopback range (RFC 1122): 127.0.0.0/8\n  if (normalized.startsWith(\"127.\")) {\n    return true;\n  }\n\n  return normalized === \"localhost\" || normalized === \"::1\";\n}\n\nfunction formatHostForUrl(host: string): string {\n  const trimmed = host.trim();\n\n  // IPv6 URLs must be bracketed: http://[::1]:1234\n  if (trimmed.includes(\":\")) {\n    if (trimmed.startsWith(\"[\") && trimmed.endsWith(\"]\")) {\n      return trimmed;\n    }\n\n    return `[${trimmed}]`;\n  }\n\n  return trimmed;\n}\n\nfunction buildHttpBaseUrl(host: string, port: number): string {\n  return `http://${formatHostForUrl(host)}:${port}`;\n}\n\nfunction getNonInternalInterfaceAddresses(\n  networkInterfaces: NetworkInterfaces,\n  family: \"IPv4\" | \"IPv6\"\n): string[] {\n  const addresses: string[] = [];\n  const emptyInfos: os.NetworkInterfaceInfo[] = [];\n\n  for (const name of Object.keys(networkInterfaces)) {\n    const infos: os.NetworkInterfaceInfo[] = networkInterfaces[name] ?? emptyInfos;\n    for (const info of infos) {\n      const infoFamily = info.family;\n\n      if (infoFamily !== family) {\n        continue;\n      }\n\n      if (info.internal) {\n        continue;\n      }\n\n      const address = info.address;\n\n      // Filter out link-local addresses (they are rarely what users want to copy/paste).\n      if (family === \"IPv4\" && address.startsWith(\"169.254.\")) {\n        continue;\n      }\n      if (family === \"IPv6\" && address.toLowerCase().startsWith(\"fe80:\")) {\n        continue;\n      }\n\n      addresses.push(address);\n    }\n  }\n\n  return Array.from(new Set(addresses)).sort();\n}\n\n/**\n * Compute base URLs that are reachable from other devices (LAN/VPN).\n *\n * NOTE: This is for UI/display and should not be used for lockfile discovery,\n * since lockfiles are local-machine concerns.\n */\nexport function computeNetworkBaseUrls(options: {\n  bindHost: string;\n  port: number;\n  networkInterfaces?: NetworkInterfaces;\n}): string[] {\n  const bindHost = options.bindHost.trim();\n  if (!bindHost) {\n    return [];\n  }\n\n  if (isLoopbackHost(bindHost)) {\n    return [];\n  }\n\n  const networkInterfaces = options.networkInterfaces ?? os.networkInterfaces();\n\n  if (bindHost === \"0.0.0.0\") {\n    return getNonInternalInterfaceAddresses(networkInterfaces, \"IPv4\").map((address) =>\n      buildHttpBaseUrl(address, options.port)\n    );\n  }\n\n  if (bindHost === \"::\") {\n    return getNonInternalInterfaceAddresses(networkInterfaces, \"IPv6\").map((address) =>\n      buildHttpBaseUrl(address, options.port)\n    );\n  }\n\n  return [buildHttpBaseUrl(bindHost, options.port)];\n}\n\nexport class ServerService {\n  private launchProjectPath: string | null = null;\n  private server: OrpcServer | null = null;\n  private lockfile: ServerLockfile | null = null;\n  private apiAuthToken: string | null = null;\n  private serverInfo: ServerInfo | null = null;\n  private readonly mdnsAdvertiser = new MdnsAdvertiserService();\n  private sshHost: string | undefined = undefined;\n\n  /**\n   * Set the launch project path\n   */\n  setLaunchProject(path: string | null): void {\n    this.launchProjectPath = path;\n  }\n\n  /**\n   * Get the launch project path\n   */\n  getLaunchProject(): Promise<string | null> {\n    return Promise.resolve(this.launchProjectPath);\n  }\n\n  /**\n   * Set the SSH hostname for editor deep links (browser mode)\n   */\n  setSshHost(host: string | undefined): void {\n    this.sshHost = host;\n  }\n\n  /**\n   * Get the SSH hostname for editor deep links (browser mode)\n   */\n  getSshHost(): string | undefined {\n    return this.sshHost;\n  }\n\n  /**\n   * Set the auth token used for the HTTP/WS API server.\n   *\n   * This is injected by the desktop app on startup so the server can be restarted\n   * without needing to plumb the token through every callsite.\n   */\n  setApiAuthToken(token: string): void {\n    this.apiAuthToken = token;\n  }\n\n  /** Get the auth token used for the HTTP/WS API server (if initialized). */\n  getApiAuthToken(): string | null {\n    return this.apiAuthToken;\n  }\n\n  /**\n   * Start the HTTP/WS API server.\n   *\n   * @throws Error if a server is already running (check lockfile first)\n   */\n  async startServer(options: StartServerOptions): Promise<ServerInfo> {\n    if (this.server) {\n      throw new Error(\"Server already running in this process\");\n    }\n\n    // Create lockfile instance for checking - don't store yet\n    const lockfile = new ServerLockfile(options.muxHome);\n\n    // Check for existing server (another process)\n    const existing = await lockfile.read();\n    if (existing) {\n      throw new Error(\n        `Another mux server is already running at ${existing.baseUrl} (PID: ${existing.pid})`\n      );\n    }\n\n    const bindHost =\n      typeof options.host === \"string\" && options.host.trim() ? options.host.trim() : \"127.0.0.1\";\n\n    this.apiAuthToken = options.authToken;\n\n    const staticDir = path.join(__dirname, \"../..\");\n    let serveStatic = options.serveStatic ?? false;\n    if (serveStatic) {\n      const indexPath = path.join(staticDir, \"index.html\");\n      try {\n        await fs.access(indexPath);\n      } catch {\n        log.warn(`API server static UI requested, but ${indexPath} is missing. Disabling.`);\n        serveStatic = false;\n      }\n    }\n\n    const serverOptions: OrpcServerOptions = {\n      host: bindHost,\n      port: options.port ?? 0,\n      context: options.context,\n      authToken: options.authToken,\n      router: options.router,\n      serveStatic,\n      staticDir,\n    };\n\n    const server = await createOrpcServer(serverOptions);\n    const networkBaseUrls = computeNetworkBaseUrls({ bindHost, port: server.port });\n\n    // Acquire the lockfile - clean up server if this fails\n    try {\n      await lockfile.acquire(server.baseUrl, options.authToken, {\n        bindHost,\n        port: server.port,\n        networkBaseUrls,\n      });\n    } catch (err) {\n      await server.close();\n      throw err;\n    }\n\n    // Only store references after successful acquisition - ensures stopServer\n    // won't delete another process's lockfile if we failed before acquiring\n    this.lockfile = lockfile;\n    this.server = server;\n    this.serverInfo = {\n      baseUrl: server.baseUrl,\n      token: options.authToken,\n      bindHost,\n      port: server.port,\n      networkBaseUrls,\n    };\n\n    const mdnsAdvertisementEnabled = options.context.config.getMdnsAdvertisementEnabled();\n\n    // \"auto\" mode: only advertise when the bind host is reachable from other devices.\n    if (mdnsAdvertisementEnabled !== false && !isLoopbackHost(bindHost)) {\n      const instanceName = options.context.config.getMdnsServiceName() ?? `mux-${os.hostname()}`;\n      const serviceOptions = buildMuxMdnsServiceOptions({\n        bindHost,\n        port: server.port,\n        instanceName,\n        version: VERSION.git_describe,\n        authRequired: options.authToken.trim().length > 0,\n      });\n\n      try {\n        await this.mdnsAdvertiser.start(serviceOptions);\n      } catch (err) {\n        log.warn(\"Failed to advertise mux API server via mDNS:\", err);\n      }\n    } else if (mdnsAdvertisementEnabled === true && isLoopbackHost(bindHost)) {\n      log.warn(\n        \"mDNS advertisement requested, but the API server is loopback-only. \" +\n          \"Set apiServerBindHost to 0.0.0.0 (or a LAN IP) to enable LAN discovery.\"\n      );\n    }\n\n    return this.serverInfo;\n  }\n\n  /**\n   * Stop the HTTP/WS API server and release the lockfile.\n   */\n  async stopServer(): Promise<void> {\n    try {\n      await this.mdnsAdvertiser.stop();\n    } catch (err) {\n      log.warn(\"Failed to stop mDNS advertiser:\", err);\n    }\n\n    if (this.lockfile) {\n      await this.lockfile.release();\n      this.lockfile = null;\n    }\n    if (this.server) {\n      await this.server.close();\n      this.server = null;\n    }\n    this.serverInfo = null;\n  }\n\n  /**\n   * Get information about the running server.\n   * Returns null if no server is running in this process.\n   */\n  getServerInfo(): ServerInfo | null {\n    return this.serverInfo;\n  }\n\n  /**\n   * Check if a server is running in this process.\n   */\n  isServerRunning(): boolean {\n    return this.server !== null;\n  }\n}\n"]}