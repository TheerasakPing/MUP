{"version":3,"file":"serverService.js","sourceRoot":"","sources":["../../../src/node/services/serverService.ts"],"names":[],"mappings":"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","sourcesContent":["import { createOrpcServer, type OrpcServer, type OrpcServerOptions } from \"@/node/orpc/server\";\r\nimport { ServerLockfile } from \"./serverLockfile\";\r\nimport type { ORPCContext } from \"@/node/orpc/context\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport { log } from \"./log\";\r\nimport * as os from \"os\";\r\nimport { VERSION } from \"@/version\";\r\nimport { buildMuxMdnsServiceOptions, MdnsAdvertiserService } from \"./mdnsAdvertiserService\";\r\nimport type { AppRouter } from \"@/node/orpc/router\";\r\n\r\nexport interface ServerInfo {\r\n  /** Base URL that is always connectable from the local machine (loopback for wildcard binds). */\r\n  baseUrl: string;\r\n  /** Auth token required for HTTP/WS API access. */\r\n  token: string;\r\n  /** The host/interface the server is actually bound to (e.g. \"127.0.0.1\" or \"0.0.0.0\"). */\r\n  bindHost: string;\r\n  /** The port the server is listening on. */\r\n  port: number;\r\n  /** Additional base URLs that may be reachable from other devices (LAN/VPN). */\r\n  networkBaseUrls: string[];\r\n}\r\n\r\nexport interface StartServerOptions {\r\n  /** Path to mux home directory (for lockfile) */\r\n  muxHome: string;\r\n  /** oRPC context with services */\r\n  context: ORPCContext;\r\n  /** Host/interface to bind to (default: \"127.0.0.1\") */\r\n  host?: string;\r\n  /** Auth token for the server */\r\n  authToken: string;\r\n  /** Port to bind to (0 = random) */\r\n  port?: number;\r\n  /** Optional pre-created router (if not provided, creates router(authToken)) */\r\n  router?: AppRouter;\r\n  /** Whether to serve static files */\r\n  serveStatic?: boolean;\r\n}\r\n\r\ntype NetworkInterfaces = NodeJS.Dict<os.NetworkInterfaceInfo[]>;\r\n\r\nfunction isLoopbackHost(host: string): boolean {\r\n  const normalized = host.trim().toLowerCase();\r\n\r\n  // IPv4 loopback range (RFC 1122): 127.0.0.0/8\r\n  if (normalized.startsWith(\"127.\")) {\r\n    return true;\r\n  }\r\n\r\n  return normalized === \"localhost\" || normalized === \"::1\";\r\n}\r\n\r\nfunction formatHostForUrl(host: string): string {\r\n  const trimmed = host.trim();\r\n\r\n  // IPv6 URLs must be bracketed: http://[::1]:1234\r\n  if (trimmed.includes(\":\")) {\r\n    if (trimmed.startsWith(\"[\") && trimmed.endsWith(\"]\")) {\r\n      return trimmed;\r\n    }\r\n\r\n    return `[${trimmed}]`;\r\n  }\r\n\r\n  return trimmed;\r\n}\r\n\r\nfunction buildHttpBaseUrl(host: string, port: number): string {\r\n  return `http://${formatHostForUrl(host)}:${port}`;\r\n}\r\n\r\nfunction getNonInternalInterfaceAddresses(\r\n  networkInterfaces: NetworkInterfaces,\r\n  family: \"IPv4\" | \"IPv6\"\r\n): string[] {\r\n  const addresses: string[] = [];\r\n  const emptyInfos: os.NetworkInterfaceInfo[] = [];\r\n\r\n  for (const name of Object.keys(networkInterfaces)) {\r\n    const infos: os.NetworkInterfaceInfo[] = networkInterfaces[name] ?? emptyInfos;\r\n    for (const info of infos) {\r\n      const infoFamily = info.family;\r\n\r\n      if (infoFamily !== family) {\r\n        continue;\r\n      }\r\n\r\n      if (info.internal) {\r\n        continue;\r\n      }\r\n\r\n      const address = info.address;\r\n\r\n      // Filter out link-local addresses (they are rarely what users want to copy/paste).\r\n      if (family === \"IPv4\" && address.startsWith(\"169.254.\")) {\r\n        continue;\r\n      }\r\n      if (family === \"IPv6\" && address.toLowerCase().startsWith(\"fe80:\")) {\r\n        continue;\r\n      }\r\n\r\n      addresses.push(address);\r\n    }\r\n  }\r\n\r\n  return Array.from(new Set(addresses)).sort();\r\n}\r\n\r\n/**\r\n * Compute base URLs that are reachable from other devices (LAN/VPN).\r\n *\r\n * NOTE: This is for UI/display and should not be used for lockfile discovery,\r\n * since lockfiles are local-machine concerns.\r\n */\r\nexport function computeNetworkBaseUrls(options: {\r\n  bindHost: string;\r\n  port: number;\r\n  networkInterfaces?: NetworkInterfaces;\r\n}): string[] {\r\n  const bindHost = options.bindHost.trim();\r\n  if (!bindHost) {\r\n    return [];\r\n  }\r\n\r\n  if (isLoopbackHost(bindHost)) {\r\n    return [];\r\n  }\r\n\r\n  const networkInterfaces = options.networkInterfaces ?? os.networkInterfaces();\r\n\r\n  if (bindHost === \"0.0.0.0\") {\r\n    return getNonInternalInterfaceAddresses(networkInterfaces, \"IPv4\").map((address) =>\r\n      buildHttpBaseUrl(address, options.port)\r\n    );\r\n  }\r\n\r\n  if (bindHost === \"::\") {\r\n    return getNonInternalInterfaceAddresses(networkInterfaces, \"IPv6\").map((address) =>\r\n      buildHttpBaseUrl(address, options.port)\r\n    );\r\n  }\r\n\r\n  return [buildHttpBaseUrl(bindHost, options.port)];\r\n}\r\n\r\nexport class ServerService {\r\n  private launchProjectPath: string | null = null;\r\n  private server: OrpcServer | null = null;\r\n  private lockfile: ServerLockfile | null = null;\r\n  private apiAuthToken: string | null = null;\r\n  private serverInfo: ServerInfo | null = null;\r\n  private readonly mdnsAdvertiser = new MdnsAdvertiserService();\r\n  private sshHost: string | undefined = undefined;\r\n\r\n  /**\r\n   * Set the launch project path\r\n   */\r\n  setLaunchProject(path: string | null): void {\r\n    this.launchProjectPath = path;\r\n  }\r\n\r\n  /**\r\n   * Get the launch project path\r\n   */\r\n  getLaunchProject(): Promise<string | null> {\r\n    return Promise.resolve(this.launchProjectPath);\r\n  }\r\n\r\n  /**\r\n   * Set the SSH hostname for editor deep links (browser mode)\r\n   */\r\n  setSshHost(host: string | undefined): void {\r\n    this.sshHost = host;\r\n  }\r\n\r\n  /**\r\n   * Get the SSH hostname for editor deep links (browser mode)\r\n   */\r\n  getSshHost(): string | undefined {\r\n    return this.sshHost;\r\n  }\r\n\r\n  /**\r\n   * Set the auth token used for the HTTP/WS API server.\r\n   *\r\n   * This is injected by the desktop app on startup so the server can be restarted\r\n   * without needing to plumb the token through every callsite.\r\n   */\r\n  setApiAuthToken(token: string): void {\r\n    this.apiAuthToken = token;\r\n  }\r\n\r\n  /** Get the auth token used for the HTTP/WS API server (if initialized). */\r\n  getApiAuthToken(): string | null {\r\n    return this.apiAuthToken;\r\n  }\r\n\r\n  /**\r\n   * Start the HTTP/WS API server.\r\n   *\r\n   * @throws Error if a server is already running (check lockfile first)\r\n   */\r\n  async startServer(options: StartServerOptions): Promise<ServerInfo> {\r\n    if (this.server) {\r\n      throw new Error(\"Server already running in this process\");\r\n    }\r\n\r\n    // Create lockfile instance for checking - don't store yet\r\n    const lockfile = new ServerLockfile(options.muxHome);\r\n\r\n    // Check for existing server (another process)\r\n    const existing = await lockfile.read();\r\n    if (existing) {\r\n      throw new Error(\r\n        `Another mux server is already running at ${existing.baseUrl} (PID: ${existing.pid})`\r\n      );\r\n    }\r\n\r\n    const bindHost =\r\n      typeof options.host === \"string\" && options.host.trim() ? options.host.trim() : \"127.0.0.1\";\r\n\r\n    this.apiAuthToken = options.authToken;\r\n\r\n    const staticDir = path.join(__dirname, \"../..\");\r\n    let serveStatic = options.serveStatic ?? false;\r\n    if (serveStatic) {\r\n      const indexPath = path.join(staticDir, \"index.html\");\r\n      try {\r\n        await fs.access(indexPath);\r\n      } catch {\r\n        log.warn(`API server static UI requested, but ${indexPath} is missing. Disabling.`);\r\n        serveStatic = false;\r\n      }\r\n    }\r\n\r\n    const serverOptions: OrpcServerOptions = {\r\n      host: bindHost,\r\n      port: options.port ?? 0,\r\n      context: options.context,\r\n      authToken: options.authToken,\r\n      router: options.router,\r\n      serveStatic,\r\n      staticDir,\r\n    };\r\n\r\n    const server = await createOrpcServer(serverOptions);\r\n    const networkBaseUrls = computeNetworkBaseUrls({ bindHost, port: server.port });\r\n\r\n    // Acquire the lockfile - clean up server if this fails\r\n    try {\r\n      await lockfile.acquire(server.baseUrl, options.authToken, {\r\n        bindHost,\r\n        port: server.port,\r\n        networkBaseUrls,\r\n      });\r\n    } catch (err) {\r\n      await server.close();\r\n      throw err;\r\n    }\r\n\r\n    // Only store references after successful acquisition - ensures stopServer\r\n    // won't delete another process's lockfile if we failed before acquiring\r\n    this.lockfile = lockfile;\r\n    this.server = server;\r\n    this.serverInfo = {\r\n      baseUrl: server.baseUrl,\r\n      token: options.authToken,\r\n      bindHost,\r\n      port: server.port,\r\n      networkBaseUrls,\r\n    };\r\n\r\n    const mdnsAdvertisementEnabled = options.context.config.getMdnsAdvertisementEnabled();\r\n\r\n    // \"auto\" mode: only advertise when the bind host is reachable from other devices.\r\n    if (mdnsAdvertisementEnabled !== false && !isLoopbackHost(bindHost)) {\r\n      const instanceName = options.context.config.getMdnsServiceName() ?? `mux-${os.hostname()}`;\r\n      const serviceOptions = buildMuxMdnsServiceOptions({\r\n        bindHost,\r\n        port: server.port,\r\n        instanceName,\r\n        version: VERSION.git_describe,\r\n        authRequired: options.authToken.trim().length > 0,\r\n      });\r\n\r\n      try {\r\n        await this.mdnsAdvertiser.start(serviceOptions);\r\n      } catch (err) {\r\n        log.warn(\"Failed to advertise mux API server via mDNS:\", err);\r\n      }\r\n    } else if (mdnsAdvertisementEnabled === true && isLoopbackHost(bindHost)) {\r\n      log.warn(\r\n        \"mDNS advertisement requested, but the API server is loopback-only. \" +\r\n          \"Set apiServerBindHost to 0.0.0.0 (or a LAN IP) to enable LAN discovery.\"\r\n      );\r\n    }\r\n\r\n    return this.serverInfo;\r\n  }\r\n\r\n  /**\r\n   * Stop the HTTP/WS API server and release the lockfile.\r\n   */\r\n  async stopServer(): Promise<void> {\r\n    try {\r\n      await this.mdnsAdvertiser.stop();\r\n    } catch (err) {\r\n      log.warn(\"Failed to stop mDNS advertiser:\", err);\r\n    }\r\n\r\n    if (this.lockfile) {\r\n      await this.lockfile.release();\r\n      this.lockfile = null;\r\n    }\r\n    if (this.server) {\r\n      await this.server.close();\r\n      this.server = null;\r\n    }\r\n    this.serverInfo = null;\r\n  }\r\n\r\n  /**\r\n   * Get information about the running server.\r\n   * Returns null if no server is running in this process.\r\n   */\r\n  getServerInfo(): ServerInfo | null {\r\n    return this.serverInfo;\r\n  }\r\n\r\n  /**\r\n   * Check if a server is running in this process.\r\n   */\r\n  isServerRunning(): boolean {\r\n    return this.server !== null;\r\n  }\r\n}\r\n"]}