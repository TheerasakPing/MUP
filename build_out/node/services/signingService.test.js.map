{"version":3,"file":"signingService.test.js","sourceRoot":"","sources":["../../../src/node/services/signingService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeAll, afterAll } from \"bun:test\";\r\nimport { parsePublicKey, verifySignature, type SignatureEnvelope } from \"@coder/mux-md-client\";\r\nimport { execSync } from \"child_process\";\r\nimport { mkdirSync, rmSync } from \"fs\";\r\nimport { tmpdir } from \"os\";\r\nimport { join } from \"path\";\r\nimport { SigningService } from \"./signingService\";\r\n\r\nasync function expectValidSignature(content: string, envelope: SignatureEnvelope): Promise<void> {\r\n  const parsed = parsePublicKey(envelope.publicKey);\r\n  const signatureBytes = Buffer.from(envelope.sig, \"base64\");\r\n  const messageBytes = new TextEncoder().encode(content);\r\n\r\n  const isValid = await verifySignature(parsed, messageBytes, new Uint8Array(signatureBytes));\r\n  expect(isValid).toBe(true);\r\n}\r\n\r\nfunction startSshAgent(): { sshAuthSock: string; sshAgentPid: string } {\r\n  const output = execSync(\"ssh-agent -s\").toString(\"utf-8\");\r\n\r\n  const sockMatch = /SSH_AUTH_SOCK=([^;]+);/m.exec(output);\r\n  const pidMatch = /SSH_AGENT_PID=([0-9]+);/m.exec(output);\r\n  if (!sockMatch || !pidMatch) {\r\n    throw new Error(`Failed to parse ssh-agent output: ${output}`);\r\n  }\r\n\r\n  return { sshAuthSock: sockMatch[1], sshAgentPid: pidMatch[1] };\r\n}\r\n\r\n/** Run test body with SSH_AUTH_SOCK cleared to ensure disk keys are used */\r\nasync function withoutSshAgent<T>(fn: () => Promise<T>): Promise<T> {\r\n  const savedSock = process.env.SSH_AUTH_SOCK;\r\n  const savedPid = process.env.SSH_AGENT_PID;\r\n\r\n  delete process.env.SSH_AUTH_SOCK;\r\n  delete process.env.SSH_AGENT_PID;\r\n\r\n  try {\r\n    return await fn();\r\n  } finally {\r\n    if (savedSock === undefined) {\r\n      delete process.env.SSH_AUTH_SOCK;\r\n    } else {\r\n      process.env.SSH_AUTH_SOCK = savedSock;\r\n    }\r\n\r\n    if (savedPid === undefined) {\r\n      delete process.env.SSH_AGENT_PID;\r\n    } else {\r\n      process.env.SSH_AGENT_PID = savedPid;\r\n    }\r\n  }\r\n}\r\n\r\ndescribe(\"SigningService\", () => {\r\n  // Create isolated temp directory for each test run\r\n  const testDir = join(\r\n    tmpdir(),\r\n    `signing-test-${Date.now()}-${Math.random().toString(36).slice(2)}`\r\n  );\r\n\r\n  const ed25519KeyPath = join(testDir, \"id_ed25519\");\r\n  const ecdsaKeyPath = join(testDir, \"id_ecdsa\");\r\n  const encryptedKeyPath = join(testDir, \"id_encrypted\");\r\n\r\n  const prevEnv = {\r\n    SSH_AUTH_SOCK: process.env.SSH_AUTH_SOCK,\r\n    SSH_AGENT_PID: process.env.SSH_AGENT_PID,\r\n  };\r\n\r\n  beforeAll(() => {\r\n    // Ensure these tests are not influenced by a user's existing ssh-agent.\r\n    delete process.env.SSH_AUTH_SOCK;\r\n    delete process.env.SSH_AGENT_PID;\r\n\r\n    mkdirSync(testDir, { recursive: true });\r\n    // Generate keys using ssh-keygen (same format users would have)\r\n    execSync(`ssh-keygen -t ed25519 -f \"${ed25519KeyPath}\" -N \"\" -q`);\r\n    execSync(`ssh-keygen -t ecdsa -b 256 -f \"${ecdsaKeyPath}\" -N \"\" -q`);\r\n    execSync(`ssh-keygen -t ed25519 -f \"${encryptedKeyPath}\" -N \"testpassword\" -q`);\r\n  });\r\n\r\n  afterAll(() => {\r\n    rmSync(testDir, { recursive: true, force: true });\r\n\r\n    if (prevEnv.SSH_AUTH_SOCK === undefined) {\r\n      delete process.env.SSH_AUTH_SOCK;\r\n    } else {\r\n      process.env.SSH_AUTH_SOCK = prevEnv.SSH_AUTH_SOCK;\r\n    }\r\n\r\n    if (prevEnv.SSH_AGENT_PID === undefined) {\r\n      delete process.env.SSH_AGENT_PID;\r\n    } else {\r\n      process.env.SSH_AGENT_PID = prevEnv.SSH_AGENT_PID;\r\n    }\r\n  });\r\n\r\n  describe(\"with Ed25519 key\", () => {\r\n    it(\"should load key and return capabilities\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([ed25519KeyPath]);\r\n        const capabilities = await service.getCapabilities();\r\n\r\n        expect(capabilities.publicKey).toBeDefined();\r\n        expect(capabilities.publicKey).toStartWith(\"ssh-ed25519 \");\r\n      }));\r\n\r\n    it(\"should sign messages\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([ed25519KeyPath]);\r\n        const content = \"hello world\";\r\n        const envelope = await service.signMessage(content);\r\n\r\n        expect(envelope.publicKey).toStartWith(\"ssh-ed25519 \");\r\n        await expectValidSignature(content, envelope);\r\n      }));\r\n\r\n    it(\"should return consistent public key across multiple calls\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([ed25519KeyPath]);\r\n        const caps1 = await service.getCapabilities();\r\n        const caps2 = await service.getCapabilities();\r\n        const envelope = await service.signMessage(\"consistency\");\r\n\r\n        expect(caps1.publicKey).toBe(caps2.publicKey);\r\n        expect(caps1.publicKey).toBe(envelope.publicKey);\r\n      }));\r\n  });\r\n\r\n  describe(\"with ECDSA key\", () => {\r\n    it(\"should load key and return capabilities\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([ecdsaKeyPath]);\r\n        const capabilities = await service.getCapabilities();\r\n\r\n        expect(capabilities.publicKey).toBeDefined();\r\n        expect(capabilities.publicKey).toStartWith(\"ecdsa-sha2-nistp256 \");\r\n      }));\r\n\r\n    it(\"should sign messages\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([ecdsaKeyPath]);\r\n        const content = \"hello ecdsa\";\r\n        const envelope = await service.signMessage(content);\r\n\r\n        expect(envelope.publicKey).toStartWith(\"ecdsa-sha2-nistp256 \");\r\n        await expectValidSignature(content, envelope);\r\n      }));\r\n  });\r\n\r\n  describe(\"with no key\", () => {\r\n    it(\"should return null publicKey when no key exists\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([\"/nonexistent/path/key\"]);\r\n        const caps = await service.getCapabilities();\r\n\r\n        expect(caps.publicKey).toBeNull();\r\n        expect(caps.error).toBeDefined();\r\n        expect(caps.error?.hasEncryptedKey).toBe(false);\r\n      }));\r\n\r\n    it(\"should throw when signing without a key\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([\"/nonexistent/path/key\"]);\r\n\r\n        let threw = false;\r\n        try {\r\n          await service.signMessage(\"no key\");\r\n        } catch {\r\n          threw = true;\r\n        }\r\n        expect(threw).toBe(true);\r\n      }));\r\n  });\r\n\r\n  describe(\"key path priority\", () => {\r\n    it(\"should use first available key in path order\", () =>\r\n      withoutSshAgent(async () => {\r\n        // ECDSA first, Ed25519 second - should pick ECDSA\r\n        const service = new SigningService([ecdsaKeyPath, ed25519KeyPath]);\r\n        const caps = await service.getCapabilities();\r\n\r\n        expect(caps.publicKey).toStartWith(\"ecdsa-sha2-nistp256 \");\r\n      }));\r\n\r\n    it(\"should skip missing paths and use next available\", () =>\r\n      withoutSshAgent(async () => {\r\n        // Nonexistent first, Ed25519 second - should pick Ed25519\r\n        const service = new SigningService([\"/nonexistent/key\", ed25519KeyPath]);\r\n        const caps = await service.getCapabilities();\r\n\r\n        expect(caps.publicKey).toStartWith(\"ssh-ed25519 \");\r\n      }));\r\n  });\r\n\r\n  describe(\"with encrypted key\", () => {\r\n    it(\"should detect encrypted key and return hasEncryptedKey=true\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([encryptedKeyPath]);\r\n        const caps = await service.getCapabilities();\r\n\r\n        expect(caps.publicKey).toBeNull();\r\n        expect(caps.error?.hasEncryptedKey).toBe(true);\r\n        expect(caps.error?.message).toContain(\"passphrase\");\r\n      }));\r\n\r\n    it(\"should skip encrypted key and use unencrypted fallback\", () =>\r\n      withoutSshAgent(async () => {\r\n        // Encrypted first, unencrypted second - should skip encrypted and use unencrypted\r\n        const service = new SigningService([encryptedKeyPath, ed25519KeyPath]);\r\n        const caps = await service.getCapabilities();\r\n\r\n        expect(caps.publicKey).toStartWith(\"ssh-ed25519 \");\r\n        // Key loaded successfully - error may exist for identity detection (gh not installed)\r\n        // but should NOT have hasEncryptedKey flag since we found a usable key\r\n        if (caps.error) {\r\n          expect(caps.error.hasEncryptedKey).toBe(false);\r\n        }\r\n      }));\r\n\r\n    it(\"should reset hasEncryptedKey on cache clear\", () =>\r\n      withoutSshAgent(async () => {\r\n        const service = new SigningService([encryptedKeyPath]);\r\n        const caps1 = await service.getCapabilities();\r\n        expect(caps1.error?.hasEncryptedKey).toBe(true);\r\n\r\n        service.clearIdentityCache();\r\n        // After clearing, a fresh load should still detect the encrypted key\r\n        const caps2 = await service.getCapabilities();\r\n        expect(caps2.error?.hasEncryptedKey).toBe(true);\r\n      }));\r\n  });\r\n\r\n  describe(\"with ssh-agent\", () => {\r\n    let sshAuthSock: string | null = null;\r\n    let sshAgentPid: string | null = null;\r\n\r\n    beforeAll(() => {\r\n      const agent = startSshAgent();\r\n      sshAuthSock = agent.sshAuthSock;\r\n      sshAgentPid = agent.sshAgentPid;\r\n\r\n      process.env.SSH_AUTH_SOCK = sshAuthSock;\r\n      process.env.SSH_AGENT_PID = sshAgentPid;\r\n\r\n      execSync(`ssh-add -q \"${ed25519KeyPath}\"`, { env: process.env });\r\n    });\r\n\r\n    afterAll(() => {\r\n      if (sshAuthSock && sshAgentPid) {\r\n        try {\r\n          execSync(\"ssh-agent -k\", {\r\n            env: {\r\n              ...process.env,\r\n              SSH_AUTH_SOCK: sshAuthSock,\r\n              SSH_AGENT_PID: sshAgentPid,\r\n            },\r\n          });\r\n        } catch {\r\n          // Best-effort cleanup.\r\n        }\r\n      }\r\n\r\n      delete process.env.SSH_AUTH_SOCK;\r\n      delete process.env.SSH_AGENT_PID;\r\n    });\r\n\r\n    it(\"should prefer agent key over disk fallback\", async () => {\r\n      // Nonexistent explicit path forces the service to choose between agent and fallback.\r\n      // The agent provides Ed25519; fallback provides ECDSA.\r\n      const service = new SigningService([\"/nonexistent/key\", ecdsaKeyPath]);\r\n      const caps = await service.getCapabilities();\r\n\r\n      expect(caps.publicKey).toStartWith(\"ssh-ed25519 \");\r\n\r\n      const content = \"agent signing\";\r\n      const envelope = await service.signMessage(content);\r\n      expect(envelope.publicKey).toStartWith(\"ssh-ed25519 \");\r\n      await expectValidSignature(content, envelope);\r\n    });\r\n\r\n    it(\"should use agent key when only encrypted disk key is present\", async () => {\r\n      const service = new SigningService([encryptedKeyPath]);\r\n      const caps = await service.getCapabilities();\r\n\r\n      expect(caps.publicKey).toStartWith(\"ssh-ed25519 \");\r\n      if (caps.error) {\r\n        expect(caps.error.hasEncryptedKey).toBe(false);\r\n      }\r\n    });\r\n  });\r\n});\r\n"]}