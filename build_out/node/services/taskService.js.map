{"version":3,"file":"taskService.js","sourceRoot":"","sources":["../../../src/node/services/taskService.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from \"node:assert/strict\";\r\nimport * as fsPromises from \"fs/promises\";\r\n\r\nimport { MutexMap } from \"@/node/utils/concurrency/mutexMap\";\r\nimport { AsyncMutex } from \"@/node/utils/concurrency/asyncMutex\";\r\nimport type { Config, Workspace as WorkspaceConfigEntry } from \"@/node/config\";\r\nimport type { AIService } from \"@/node/services/aiService\";\r\nimport type { WorkspaceService } from \"@/node/services/workspaceService\";\r\nimport type { HistoryService } from \"@/node/services/historyService\";\r\nimport type { PartialService } from \"@/node/services/partialService\";\r\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { detectDefaultTrunkBranch, listLocalBranches } from \"@/node/git\";\r\nimport {\r\n  discoverAgentDefinitions,\r\n  readAgentDefinition,\r\n  resolveAgentFrontmatter,\r\n} from \"@/node/services/agentDefinitions/agentDefinitionsService\";\r\nimport { resolveAgentInheritanceChain } from \"@/node/services/agentDefinitions/resolveAgentInheritanceChain\";\r\nimport { isAgentEffectivelyDisabled } from \"@/node/services/agentDefinitions/agentEnablement\";\r\nimport { applyForkRuntimeUpdates } from \"@/node/services/utils/forkRuntimeUpdates\";\r\nimport { createRuntimeForWorkspace } from \"@/node/runtime/runtimeHelpers\";\r\nimport { createRuntime, runBackgroundInit } from \"@/node/runtime/runtimeFactory\";\r\nimport type { InitLogger, WorkspaceCreationResult } from \"@/node/runtime/Runtime\";\r\nimport {\r\n  coerceNonEmptyString,\r\n  tryReadGitHeadCommitSha,\r\n  findWorkspaceEntry,\r\n} from \"@/node/services/taskUtils\";\r\nimport { validateWorkspaceName } from \"@/common/utils/validation/workspaceValidation\";\r\nimport { Ok, Err, type Result } from \"@/common/types/result\";\r\nimport type { TaskSettings } from \"@/common/types/tasks\";\r\nimport { DEFAULT_TASK_SETTINGS } from \"@/common/types/tasks\";\r\n\r\nimport { createMuxMessage, type MuxMessage } from \"@/common/types/message\";\r\nimport { createTaskReportMessageId } from \"@/node/services/utils/messageIds\";\r\nimport { defaultModel, normalizeGatewayModel } from \"@/common/utils/ai/models\";\r\nimport { WORKSPACE_DEFAULTS } from \"@/constants/workspaceDefaults\";\r\nimport type { RuntimeConfig } from \"@/common/types/runtime\";\r\nimport { AgentIdSchema } from \"@/common/orpc/schemas\";\r\nimport { GitPatchArtifactService } from \"@/node/services/gitPatchArtifactService\";\r\nimport type { ThinkingLevel } from \"@/common/types/thinking\";\r\nimport type { ToolCallEndEvent, StreamEndEvent } from \"@/common/types/stream\";\r\nimport { isDynamicToolPart, type DynamicToolPart } from \"@/common/types/toolParts\";\r\nimport {\r\n  AgentReportToolArgsSchema,\r\n  TaskToolResultSchema,\r\n  TaskToolArgsSchema,\r\n} from \"@/common/utils/tools/toolDefinitions\";\r\nimport { formatSendMessageError } from \"@/node/services/utils/sendMessageError\";\r\nimport { enforceThinkingPolicy } from \"@/common/utils/thinking/policy\";\r\nimport { taskQueueDebug } from \"@/node/services/taskQueueDebug\";\r\nimport { readSubagentGitPatchArtifact } from \"@/node/services/subagentGitPatchArtifacts\";\r\nimport {\r\n  readSubagentReportArtifact,\r\n  readSubagentReportArtifactsFile,\r\n  upsertSubagentReportArtifact,\r\n} from \"@/node/services/subagentReportArtifacts\";\r\nimport { secretsToRecord } from \"@/common/types/secrets\";\r\n\r\nexport type TaskKind = \"agent\";\r\n\r\nexport type AgentTaskStatus = NonNullable<WorkspaceConfigEntry[\"taskStatus\"]>;\r\n\r\nexport interface TaskCreateArgs {\r\n  parentWorkspaceId: string;\r\n  kind: TaskKind;\r\n  /** Preferred identifier (matches agent definition id). */\r\n  agentId?: string;\r\n  /** @deprecated Legacy alias for agentId (kept for on-disk compatibility). */\r\n  agentType?: string;\r\n  prompt: string;\r\n  /** Human-readable title for the task (displayed in sidebar) */\r\n  title: string;\r\n  modelString?: string;\r\n  thinkingLevel?: ThinkingLevel;\r\n  /** Experiments to inherit to subagent */\r\n  experiments?: {\r\n    programmaticToolCalling?: boolean;\r\n    programmaticToolCallingExclusive?: boolean;\r\n    execSubagentHardRestart?: boolean;\r\n  };\r\n}\r\n\r\nexport interface TaskCreateResult {\r\n  taskId: string;\r\n  kind: TaskKind;\r\n  status: \"queued\" | \"running\";\r\n}\r\n\r\nexport interface TerminateAgentTaskResult {\r\n  /** Task IDs terminated (includes descendants). */\r\n  terminatedTaskIds: string[];\r\n}\r\n\r\nexport interface DescendantAgentTaskInfo {\r\n  taskId: string;\r\n  status: AgentTaskStatus;\r\n  parentWorkspaceId: string;\r\n  agentType?: string;\r\n  workspaceName?: string;\r\n  title?: string;\r\n  createdAt?: string;\r\n  modelString?: string;\r\n  thinkingLevel?: ThinkingLevel;\r\n  depth: number;\r\n}\r\n\r\ntype AgentTaskWorkspaceEntry = WorkspaceConfigEntry & { projectPath: string };\r\n\r\nconst COMPLETED_REPORT_CACHE_MAX_ENTRIES = 128;\r\n\r\n/** Maximum consecutive auto-resumes before stopping. Prevents infinite loops when descendants are stuck. */\r\nconst MAX_CONSECUTIVE_PARENT_AUTO_RESUMES = 3;\r\n\r\ninterface AgentTaskIndex {\r\n  byId: Map<string, AgentTaskWorkspaceEntry>;\r\n  childrenByParent: Map<string, string[]>;\r\n  parentById: Map<string, string>;\r\n}\r\n\r\ninterface PendingTaskWaiter {\r\n  createdAt: number;\r\n  resolve: (report: { reportMarkdown: string; title?: string }) => void;\r\n  reject: (error: Error) => void;\r\n  cleanup: () => void;\r\n}\r\n\r\ninterface PendingTaskStartWaiter {\r\n  createdAt: number;\r\n  start: () => void;\r\n  cleanup: () => void;\r\n}\r\n\r\ninterface CompletedAgentReportCacheEntry {\r\n  reportMarkdown: string;\r\n  title?: string;\r\n  // Ancestor workspace IDs captured when the report was cached.\r\n  // Used to keep descendant-scope checks working even if the task workspace is cleaned up.\r\n  ancestorWorkspaceIds: string[];\r\n}\r\n\r\nfunction isToolCallEndEvent(value: unknown): value is ToolCallEndEvent {\r\n  return (\r\n    typeof value === \"object\" &&\r\n    value !== null &&\r\n    \"type\" in value &&\r\n    (value as { type: unknown }).type === \"tool-call-end\" &&\r\n    \"workspaceId\" in value &&\r\n    typeof (value as { workspaceId: unknown }).workspaceId === \"string\"\r\n  );\r\n}\r\n\r\nfunction isStreamEndEvent(value: unknown): value is StreamEndEvent {\r\n  return (\r\n    typeof value === \"object\" &&\r\n    value !== null &&\r\n    \"type\" in value &&\r\n    (value as { type: unknown }).type === \"stream-end\" &&\r\n    \"workspaceId\" in value &&\r\n    typeof (value as { workspaceId: unknown }).workspaceId === \"string\"\r\n  );\r\n}\r\n\r\nfunction hasAncestorWorkspaceId(\r\n  entry: { ancestorWorkspaceIds?: unknown } | null | undefined,\r\n  ancestorWorkspaceId: string\r\n): boolean {\r\n  const ids = entry?.ancestorWorkspaceIds;\r\n  return Array.isArray(ids) && ids.includes(ancestorWorkspaceId);\r\n}\r\n\r\nfunction isSuccessfulToolResult(value: unknown): boolean {\r\n  return (\r\n    typeof value === \"object\" &&\r\n    value !== null &&\r\n    \"success\" in value &&\r\n    (value as { success?: unknown }).success === true\r\n  );\r\n}\r\n\r\nfunction sanitizeAgentTypeForName(agentType: string): string {\r\n  const normalized = agentType\r\n    .trim()\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9_-]/g, \"_\")\r\n    .replace(/_+/g, \"_\")\r\n    .replace(/-+/g, \"-\")\r\n    .replace(/^[_-]+|[_-]+$/g, \"\");\r\n\r\n  return normalized.length > 0 ? normalized : \"agent\";\r\n}\r\n\r\nfunction buildAgentWorkspaceName(agentType: string, workspaceId: string): string {\r\n  const safeType = sanitizeAgentTypeForName(agentType);\r\n  const base = `agent_${safeType}_${workspaceId}`;\r\n  // Hard cap to validation limit (64). Ensure stable suffix is preserved.\r\n  if (base.length <= 64) return base;\r\n\r\n  const suffix = `_${workspaceId}`;\r\n  const maxPrefixLen = 64 - suffix.length;\r\n  const prefix = `agent_${safeType}`.slice(0, Math.max(0, maxPrefixLen));\r\n  const name = `${prefix}${suffix}`;\r\n  return name.length <= 64 ? name : `agent_${workspaceId}`.slice(0, 64);\r\n}\r\n\r\nfunction getIsoNow(): string {\r\n  return new Date().toISOString();\r\n}\r\n\r\nexport class TaskService {\r\n  // Serialize stream-end/tool-call-end processing per workspace to avoid races (e.g.\r\n  // stream-end observing awaiting_report before agent_report handling flips the status).\r\n  private readonly workspaceEventLocks = new MutexMap<string>();\r\n  private readonly mutex = new AsyncMutex();\r\n  private readonly pendingWaitersByTaskId = new Map<string, PendingTaskWaiter[]>();\r\n  private readonly pendingStartWaitersByTaskId = new Map<string, PendingTaskStartWaiter[]>();\r\n  // Tracks workspaces currently blocked in a foreground wait (e.g. a task tool call awaiting\r\n  // agent_report). Used to avoid scheduler deadlocks when maxParallelAgentTasks is low and tasks\r\n  // spawn nested tasks in the foreground.\r\n  private readonly foregroundAwaitCountByWorkspaceId = new Map<string, number>();\r\n  // Cache completed reports so callers can retrieve them without re-reading disk.\r\n  // Bounded by max entries; disk persistence is the source of truth for restart-safety.\r\n  private readonly completedReportsByTaskId = new Map<string, CompletedAgentReportCacheEntry>();\r\n  private readonly gitPatchArtifactService: GitPatchArtifactService;\r\n  private readonly remindedAwaitingReport = new Set<string>();\r\n  /** Tracks consecutive auto-resumes per workspace. Reset when a user message is sent. */\r\n  private consecutiveAutoResumes = new Map<string, number>();\r\n\r\n  constructor(\r\n    private readonly config: Config,\r\n    private readonly historyService: HistoryService,\r\n    private readonly partialService: PartialService,\r\n    private readonly aiService: AIService,\r\n    private readonly workspaceService: WorkspaceService,\r\n    private readonly initStateManager: InitStateManager\r\n  ) {\r\n    this.gitPatchArtifactService = new GitPatchArtifactService(config);\r\n\r\n    this.aiService.on(\"tool-call-end\", (payload: unknown) => {\r\n      if (!isToolCallEndEvent(payload)) return;\r\n      if (payload.toolName !== \"agent_report\") return;\r\n      // Ignore failed agent_report attempts (e.g. tool rejected due to active descendants).\r\n      if (!isSuccessfulToolResult(payload.result)) return;\r\n\r\n      void this.workspaceEventLocks\r\n        .withLock(payload.workspaceId, async () => {\r\n          await this.handleAgentReport(payload);\r\n        })\r\n        .catch((error: unknown) => {\r\n          log.error(\"TaskService.handleAgentReport failed\", { error });\r\n        });\r\n    });\r\n\r\n    this.aiService.on(\"stream-end\", (payload: unknown) => {\r\n      if (!isStreamEndEvent(payload)) return;\r\n\r\n      void this.workspaceEventLocks\r\n        .withLock(payload.workspaceId, async () => {\r\n          await this.handleStreamEnd(payload);\r\n        })\r\n        .catch((error: unknown) => {\r\n          log.error(\"TaskService.handleStreamEnd failed\", { error });\r\n        });\r\n    });\r\n  }\r\n\r\n  // Prefer per-agent settings so tasks inherit the correct agent defaults;\r\n  // fall back to legacy workspace settings for older configs.\r\n  private resolveWorkspaceAISettings(\r\n    workspace: {\r\n      aiSettingsByAgent?: Record<string, { model: string; thinkingLevel?: ThinkingLevel }>;\r\n      aiSettings?: { model: string; thinkingLevel?: ThinkingLevel };\r\n    },\r\n    agentId: string | undefined\r\n  ): { model: string; thinkingLevel?: ThinkingLevel } | undefined {\r\n    const normalizedAgentId =\r\n      typeof agentId === \"string\" && agentId.trim().length > 0\r\n        ? agentId.trim().toLowerCase()\r\n        : undefined;\r\n    return (\r\n      (normalizedAgentId ? workspace.aiSettingsByAgent?.[normalizedAgentId] : undefined) ??\r\n      workspace.aiSettings\r\n    );\r\n  }\r\n  private async emitWorkspaceMetadata(workspaceId: string): Promise<void> {\r\n    assert(workspaceId.length > 0, \"emitWorkspaceMetadata: workspaceId must be non-empty\");\r\n\r\n    const allMetadata = await this.config.getAllWorkspaceMetadata();\r\n    const metadata = allMetadata.find((m) => m.id === workspaceId) ?? null;\r\n    this.workspaceService.emit(\"metadata\", { workspaceId, metadata });\r\n  }\r\n\r\n  private async editWorkspaceEntry(\r\n    workspaceId: string,\r\n    updater: (workspace: WorkspaceConfigEntry) => void,\r\n    options?: { allowMissing?: boolean }\r\n  ): Promise<boolean> {\r\n    assert(workspaceId.length > 0, \"editWorkspaceEntry: workspaceId must be non-empty\");\r\n\r\n    let found = false;\r\n    await this.config.editConfig((config) => {\r\n      for (const [_projectPath, project] of config.projects) {\r\n        const ws = project.workspaces.find((w) => w.id === workspaceId);\r\n        if (!ws) continue;\r\n        updater(ws);\r\n        found = true;\r\n        return config;\r\n      }\r\n\r\n      if (options?.allowMissing) {\r\n        return config;\r\n      }\r\n\r\n      throw new Error(`editWorkspaceEntry: workspace ${workspaceId} not found`);\r\n    });\r\n\r\n    return found;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    await this.maybeStartQueuedTasks();\r\n\r\n    const config = this.config.loadConfigOrDefault();\r\n    const awaitingReportTasks = this.listAgentTaskWorkspaces(config).filter(\r\n      (t) => t.taskStatus === \"awaiting_report\"\r\n    );\r\n    const runningTasks = this.listAgentTaskWorkspaces(config).filter(\r\n      (t) => t.taskStatus === \"running\"\r\n    );\r\n\r\n    for (const task of awaitingReportTasks) {\r\n      if (!task.id) continue;\r\n\r\n      // Avoid resuming a task while it still has active descendants (it shouldn't report yet).\r\n      const hasActiveDescendants = this.hasActiveDescendantAgentTasks(config, task.id);\r\n      if (hasActiveDescendants) {\r\n        continue;\r\n      }\r\n\r\n      // Restart-safety: if this task stream ends again without agent_report, fall back immediately.\r\n      this.remindedAwaitingReport.add(task.id);\r\n\r\n      const model = task.taskModelString ?? defaultModel;\r\n      const sendResult = await this.workspaceService.sendMessage(\r\n        task.id,\r\n        \"This task is awaiting its final agent_report. Call agent_report exactly once now.\",\r\n        {\r\n          model,\r\n          agentId: task.agentId ?? WORKSPACE_DEFAULTS.agentId,\r\n          thinkingLevel: task.taskThinkingLevel,\r\n          toolPolicy: [{ regex_match: \"^agent_report$\", action: \"require\" }],\r\n        },\r\n        { synthetic: true }\r\n      );\r\n      if (!sendResult.success) {\r\n        log.error(\"Failed to resume awaiting_report task on startup\", {\r\n          taskId: task.id,\r\n          error: sendResult.error,\r\n        });\r\n\r\n        await this.fallbackReportMissingAgentReport({\r\n          projectPath: task.projectPath,\r\n          workspace: task,\r\n        });\r\n      }\r\n    }\r\n\r\n    for (const task of runningTasks) {\r\n      if (!task.id) continue;\r\n      // Best-effort: if mux restarted mid-stream, nudge the agent to continue and report.\r\n      // Only do this when the task has no running descendants, to avoid duplicate spawns.\r\n      const hasActiveDescendants = this.hasActiveDescendantAgentTasks(config, task.id);\r\n      if (hasActiveDescendants) {\r\n        continue;\r\n      }\r\n\r\n      const model = task.taskModelString ?? defaultModel;\r\n      await this.workspaceService.sendMessage(\r\n        task.id,\r\n        \"Mux restarted while this task was running. Continue where you left off. \" +\r\n          \"When you have a final answer, call agent_report exactly once.\",\r\n        {\r\n          model,\r\n          agentId: task.agentId ?? WORKSPACE_DEFAULTS.agentId,\r\n          thinkingLevel: task.taskThinkingLevel,\r\n          experiments: task.taskExperiments,\r\n        },\r\n        { synthetic: true }\r\n      );\r\n    }\r\n\r\n    // Restart-safety for git patch artifacts:\r\n    // - If mux crashed mid-generation, patch artifacts can be left \"pending\".\r\n    // - Reported tasks are auto-deleted once they're leaves; defer deletion while patches are pending.\r\n    const reportedTasks = this.listAgentTaskWorkspaces(config).filter(\r\n      (t) => t.taskStatus === \"reported\" && typeof t.id === \"string\" && t.id.length > 0\r\n    );\r\n\r\n    for (const task of reportedTasks) {\r\n      if (!task.parentWorkspaceId) continue;\r\n      try {\r\n        await this.gitPatchArtifactService.maybeStartGeneration(\r\n          task.parentWorkspaceId,\r\n          task.id!,\r\n          (wsId) => this.cleanupReportedLeafTask(wsId)\r\n        );\r\n      } catch (error: unknown) {\r\n        log.error(\"Failed to resume subagent git patch generation on startup\", {\r\n          parentWorkspaceId: task.parentWorkspaceId,\r\n          childWorkspaceId: task.id,\r\n          error,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Best-effort cleanup of reported leaf tasks (will no-op when patch artifacts are pending).\r\n    for (const task of reportedTasks) {\r\n      if (!task.id) continue;\r\n      await this.cleanupReportedLeafTask(task.id);\r\n    }\r\n  }\r\n\r\n  private startWorkspaceInit(workspaceId: string, projectPath: string): InitLogger {\r\n    assert(workspaceId.length > 0, \"startWorkspaceInit: workspaceId must be non-empty\");\r\n    assert(projectPath.length > 0, \"startWorkspaceInit: projectPath must be non-empty\");\r\n\r\n    this.initStateManager.startInit(workspaceId, projectPath);\r\n    return {\r\n      logStep: (message: string) => this.initStateManager.appendOutput(workspaceId, message, false),\r\n      logStdout: (line: string) => this.initStateManager.appendOutput(workspaceId, line, false),\r\n      logStderr: (line: string) => this.initStateManager.appendOutput(workspaceId, line, true),\r\n      logComplete: (exitCode: number) => void this.initStateManager.endInit(workspaceId, exitCode),\r\n      enterHookPhase: () => this.initStateManager.enterHookPhase(workspaceId),\r\n    };\r\n  }\r\n\r\n  async create(args: TaskCreateArgs): Promise<Result<TaskCreateResult, string>> {\r\n    const parentWorkspaceId = coerceNonEmptyString(args.parentWorkspaceId);\r\n    if (!parentWorkspaceId) {\r\n      return Err(\"Task.create: parentWorkspaceId is required\");\r\n    }\r\n    if (args.kind !== \"agent\") {\r\n      return Err(\"Task.create: unsupported kind\");\r\n    }\r\n\r\n    const prompt = coerceNonEmptyString(args.prompt);\r\n    if (!prompt) {\r\n      return Err(\"Task.create: prompt is required\");\r\n    }\r\n\r\n    const agentIdRaw = coerceNonEmptyString(args.agentId ?? args.agentType);\r\n    if (!agentIdRaw) {\r\n      return Err(\"Task.create: agentId is required\");\r\n    }\r\n\r\n    const normalizedAgentId = agentIdRaw.trim().toLowerCase();\r\n    const parsedAgentId = AgentIdSchema.safeParse(normalizedAgentId);\r\n    if (!parsedAgentId.success) {\r\n      return Err(`Task.create: invalid agentId (${normalizedAgentId})`);\r\n    }\r\n\r\n    const agentId = parsedAgentId.data;\r\n    const agentType = agentId; // Legacy alias for on-disk compatibility.\r\n\r\n    await using _lock = await this.mutex.acquire();\r\n\r\n    // Validate parent exists and fetch runtime context.\r\n    const parentMetaResult = await this.aiService.getWorkspaceMetadata(parentWorkspaceId);\r\n    if (!parentMetaResult.success) {\r\n      return Err(`Task.create: parent workspace not found (${parentMetaResult.error})`);\r\n    }\r\n    const parentMeta = parentMetaResult.data;\r\n\r\n    // Enforce nesting depth.\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const taskSettings = cfg.taskSettings ?? DEFAULT_TASK_SETTINGS;\r\n\r\n    const parentEntry = findWorkspaceEntry(cfg, parentWorkspaceId);\r\n    if (parentEntry?.workspace.taskStatus === \"reported\") {\r\n      return Err(\"Task.create: cannot spawn new tasks after agent_report\");\r\n    }\r\n\r\n    const requestedDepth = this.getTaskDepth(cfg, parentWorkspaceId) + 1;\r\n    if (requestedDepth > taskSettings.maxTaskNestingDepth) {\r\n      return Err(\r\n        `Task.create: maxTaskNestingDepth exceeded (requestedDepth=${requestedDepth}, max=${taskSettings.maxTaskNestingDepth})`\r\n      );\r\n    }\r\n\r\n    // Enforce parallelism (global).\r\n    const activeCount = this.countActiveAgentTasks(cfg);\r\n    const shouldQueue = activeCount >= taskSettings.maxParallelAgentTasks;\r\n\r\n    const taskId = this.config.generateStableId();\r\n    const workspaceName = buildAgentWorkspaceName(agentId, taskId);\r\n\r\n    const nameValidation = validateWorkspaceName(workspaceName);\r\n    if (!nameValidation.valid) {\r\n      return Err(\r\n        `Task.create: generated workspace name invalid (${nameValidation.error ?? \"unknown error\"})`\r\n      );\r\n    }\r\n\r\n    const parentAiSettings = this.resolveWorkspaceAISettings(parentMeta, agentId);\r\n\r\n    // If the parent workspace has an explicit per-agent override for this agentId,\r\n    // prefer it over the model/thinking inherited from the calling workspace.\r\n    const hasWorkspaceOverrideForAgent = Boolean(parentMeta.aiSettingsByAgent?.[agentId]);\r\n\r\n    const inheritedModelString = hasWorkspaceOverrideForAgent\r\n      ? (parentAiSettings?.model ?? defaultModel)\r\n      : typeof args.modelString === \"string\" && args.modelString.trim().length > 0\r\n        ? args.modelString.trim()\r\n        : (parentAiSettings?.model ?? defaultModel);\r\n\r\n    const inheritedThinkingLevel: ThinkingLevel = hasWorkspaceOverrideForAgent\r\n      ? (parentAiSettings?.thinkingLevel ?? \"off\")\r\n      : (args.thinkingLevel ?? parentAiSettings?.thinkingLevel ?? \"off\");\r\n\r\n    const parentRuntimeConfig = parentMeta.runtimeConfig;\r\n    const taskRuntimeConfig: RuntimeConfig = parentRuntimeConfig;\r\n\r\n    const runtime = createRuntimeForWorkspace({\r\n      runtimeConfig: taskRuntimeConfig,\r\n      projectPath: parentMeta.projectPath,\r\n      name: parentMeta.name,\r\n    });\r\n\r\n    // Validate the agent definition exists and is runnable as a sub-agent.\r\n    const isInPlace = parentMeta.projectPath === parentMeta.name;\r\n    const parentWorkspacePath = isInPlace\r\n      ? parentMeta.projectPath\r\n      : runtime.getWorkspacePath(parentMeta.projectPath, parentMeta.name);\r\n\r\n    let subagentDefaults = cfg.agentAiDefaults?.[agentId] ?? cfg.subagentAiDefaults?.[agentId];\r\n\r\n    // Base fallback: if the selected agent has no explicit defaults, inherit cfg.agentAiDefaults\r\n    // from its base chain (e.g. `base: exec`  agentAiDefaults.exec).\r\n    //\r\n    // IMPORTANT: Only apply base fallback when the parent workspace hasn't explicitly overridden\r\n    // AI settings for this agentId, so workspace-specific overrides keep winning.\r\n    if (!subagentDefaults && !hasWorkspaceOverrideForAgent) {\r\n      try {\r\n        const agentDefinition = await readAgentDefinition(runtime, parentWorkspacePath, agentId);\r\n        const chain = await resolveAgentInheritanceChain({\r\n          runtime,\r\n          workspacePath: parentWorkspacePath,\r\n          agentId,\r\n          agentDefinition,\r\n          workspaceId: parentWorkspaceId,\r\n        });\r\n\r\n        const inheritedDefaults = chain\r\n          .slice(1)\r\n          .map((entry) => cfg.agentAiDefaults?.[entry.id])\r\n          .find((entry) => entry !== undefined);\r\n\r\n        if (inheritedDefaults) {\r\n          subagentDefaults = inheritedDefaults;\r\n        }\r\n      } catch {\r\n        // Ignore: base fallback is best-effort. Validation happens below.\r\n      }\r\n    }\r\n\r\n    const taskModelString = subagentDefaults?.modelString ?? inheritedModelString;\r\n    const canonicalModel = normalizeGatewayModel(taskModelString).trim();\r\n\r\n    const requestedThinkingLevel = subagentDefaults?.thinkingLevel ?? inheritedThinkingLevel;\r\n    const effectiveThinkingLevel = enforceThinkingPolicy(canonicalModel, requestedThinkingLevel);\r\n\r\n    // Helper to build error hint with all available runnable agents.\r\n    // NOTE: This resolves frontmatter inheritance so same-name overrides (e.g. project exec.md\r\n    // with base: exec) still count as runnable.\r\n    const getRunnableHint = async (): Promise<string> => {\r\n      try {\r\n        const allAgents = await discoverAgentDefinitions(runtime, parentWorkspacePath);\r\n\r\n        const runnableIds = (\r\n          await Promise.all(\r\n            allAgents.map(async (agent) => {\r\n              try {\r\n                const frontmatter = await resolveAgentFrontmatter(\r\n                  runtime,\r\n                  parentWorkspacePath,\r\n                  agent.id\r\n                );\r\n                if (frontmatter.subagent?.runnable !== true) {\r\n                  return null;\r\n                }\r\n\r\n                const effectivelyDisabled = isAgentEffectivelyDisabled({\r\n                  cfg,\r\n                  agentId: agent.id,\r\n                  resolvedFrontmatter: frontmatter,\r\n                });\r\n                return effectivelyDisabled ? null : agent.id;\r\n              } catch {\r\n                return null;\r\n              }\r\n            })\r\n          )\r\n        ).filter((id): id is string => typeof id === \"string\");\r\n\r\n        return runnableIds.length > 0\r\n          ? `Runnable agentIds: ${runnableIds.join(\", \")}`\r\n          : \"No runnable agents available\";\r\n      } catch {\r\n        return \"Could not discover available agents\";\r\n      }\r\n    };\r\n\r\n    let skipInitHook = false;\r\n    try {\r\n      const frontmatter = await resolveAgentFrontmatter(runtime, parentWorkspacePath, agentId);\r\n      if (frontmatter.subagent?.runnable !== true) {\r\n        const hint = await getRunnableHint();\r\n        return Err(`Task.create: agentId is not runnable as a sub-agent (${agentId}). ${hint}`);\r\n      }\r\n\r\n      if (\r\n        isAgentEffectivelyDisabled({\r\n          cfg,\r\n          agentId,\r\n          resolvedFrontmatter: frontmatter,\r\n        })\r\n      ) {\r\n        const hint = await getRunnableHint();\r\n        return Err(`Task.create: agentId is disabled (${agentId}). ${hint}`);\r\n      }\r\n      skipInitHook = frontmatter.subagent?.skip_init_hook === true;\r\n    } catch {\r\n      const hint = await getRunnableHint();\r\n      return Err(`Task.create: unknown agentId (${agentId}). ${hint}`);\r\n    }\r\n\r\n    const createdAt = getIsoNow();\r\n\r\n    taskQueueDebug(\"TaskService.create decision\", {\r\n      parentWorkspaceId,\r\n      taskId,\r\n      agentId,\r\n      workspaceName,\r\n      createdAt,\r\n      activeCount,\r\n      maxParallelAgentTasks: taskSettings.maxParallelAgentTasks,\r\n      shouldQueue,\r\n      runtimeType: taskRuntimeConfig.type,\r\n      promptLength: prompt.length,\r\n      model: taskModelString,\r\n      thinkingLevel: effectiveThinkingLevel,\r\n    });\r\n\r\n    if (shouldQueue) {\r\n      const trunkBranch = coerceNonEmptyString(parentMeta.name);\r\n      if (!trunkBranch) {\r\n        return Err(\"Task.create: parent workspace name missing (cannot queue task)\");\r\n      }\r\n\r\n      // NOTE: Queued tasks are persisted immediately, but their workspace is created later\r\n      // when a parallel slot is available. This ensures queued tasks don't create worktrees\r\n      // or run init hooks until they actually start.\r\n      const workspacePath = runtime.getWorkspacePath(parentMeta.projectPath, workspaceName);\r\n\r\n      taskQueueDebug(\"TaskService.create queued (persist-only)\", {\r\n        taskId,\r\n        workspaceName,\r\n        parentWorkspaceId,\r\n        trunkBranch,\r\n        workspacePath,\r\n      });\r\n\r\n      await this.config.editConfig((config) => {\r\n        let projectConfig = config.projects.get(parentMeta.projectPath);\r\n        if (!projectConfig) {\r\n          projectConfig = { workspaces: [] };\r\n          config.projects.set(parentMeta.projectPath, projectConfig);\r\n        }\r\n\r\n        projectConfig.workspaces.push({\r\n          path: workspacePath,\r\n          id: taskId,\r\n          name: workspaceName,\r\n          title: args.title,\r\n          createdAt,\r\n          runtimeConfig: taskRuntimeConfig,\r\n          aiSettings: { model: canonicalModel, thinkingLevel: effectiveThinkingLevel },\r\n          parentWorkspaceId,\r\n          agentId,\r\n          agentType,\r\n          taskStatus: \"queued\",\r\n          taskPrompt: prompt,\r\n          taskTrunkBranch: trunkBranch,\r\n          taskModelString,\r\n          taskThinkingLevel: effectiveThinkingLevel,\r\n          taskExperiments: args.experiments,\r\n        });\r\n        return config;\r\n      });\r\n\r\n      // Emit metadata update so the UI sees the workspace immediately.\r\n      await this.emitWorkspaceMetadata(taskId);\r\n\r\n      // NOTE: Do NOT persist the prompt into chat history until the task actually starts.\r\n      // Otherwise the frontend treats \"last message is user\" as an interrupted stream and\r\n      // will auto-retry / backoff-spam resume attempts while the task is queued.\r\n      taskQueueDebug(\"TaskService.create queued persisted (prompt stored in config)\", {\r\n        taskId,\r\n        workspaceName,\r\n      });\r\n\r\n      // Schedule queue processing (best-effort).\r\n      void this.maybeStartQueuedTasks();\r\n      taskQueueDebug(\"TaskService.create queued scheduled maybeStartQueuedTasks\", { taskId });\r\n      return Ok({ taskId, kind: \"agent\", status: \"queued\" });\r\n    }\r\n\r\n    const initLogger = this.startWorkspaceInit(taskId, parentMeta.projectPath);\r\n\r\n    // Note: Local project-dir runtimes share the same directory (unsafe by design).\r\n    // For worktree/ssh runtimes we attempt a fork first; otherwise fall back to createWorkspace.\r\n\r\n    const forkResult = await runtime.forkWorkspace({\r\n      projectPath: parentMeta.projectPath,\r\n      sourceWorkspaceName: parentMeta.name,\r\n      newWorkspaceName: workspaceName,\r\n      initLogger,\r\n    });\r\n\r\n    const { forkedRuntimeConfig } = await applyForkRuntimeUpdates(\r\n      this.config,\r\n      parentWorkspaceId,\r\n      parentRuntimeConfig,\r\n      forkResult\r\n    );\r\n\r\n    if (forkResult.sourceRuntimeConfig) {\r\n      // Ensure UI gets the updated runtimeConfig for the parent workspace.\r\n      await this.emitWorkspaceMetadata(parentWorkspaceId);\r\n    }\r\n\r\n    const runtimeForTaskWorkspace = createRuntime(forkedRuntimeConfig, {\r\n      projectPath: parentMeta.projectPath,\r\n      workspaceName,\r\n    });\r\n\r\n    let trunkBranch: string;\r\n    if (forkResult.success && forkResult.sourceBranch) {\r\n      trunkBranch = forkResult.sourceBranch;\r\n    } else {\r\n      // Fork failed - validate parentMeta.name is a valid local branch.\r\n      // For non-git projects (LocalRuntime), git commands fail - fall back to \"main\".\r\n      try {\r\n        const localBranches = await listLocalBranches(parentMeta.projectPath);\r\n        if (localBranches.includes(parentMeta.name)) {\r\n          trunkBranch = parentMeta.name;\r\n        } else {\r\n          trunkBranch = await detectDefaultTrunkBranch(parentMeta.projectPath, localBranches);\r\n        }\r\n      } catch {\r\n        trunkBranch = \"main\";\r\n      }\r\n    }\r\n    if (!forkResult.success && forkResult.failureIsFatal) {\r\n      initLogger.logComplete(-1);\r\n      return Err(`Task fork failed: ${forkResult.error ?? \"unknown error\"}`);\r\n    }\r\n\r\n    const createResult: WorkspaceCreationResult = forkResult.success\r\n      ? { success: true as const, workspacePath: forkResult.workspacePath }\r\n      : await runtime.createWorkspace({\r\n          projectPath: parentMeta.projectPath,\r\n          branchName: workspaceName,\r\n          trunkBranch,\r\n          directoryName: workspaceName,\r\n          initLogger,\r\n        });\r\n\r\n    if (!createResult.success || !createResult.workspacePath) {\r\n      initLogger.logComplete(-1);\r\n      return Err(\r\n        `Task.create: failed to create agent workspace (${createResult.error ?? \"unknown error\"})`\r\n      );\r\n    }\r\n\r\n    const workspacePath = createResult.workspacePath;\r\n    const taskBaseCommitSha = await tryReadGitHeadCommitSha(runtimeForTaskWorkspace, workspacePath);\r\n\r\n    taskQueueDebug(\"TaskService.create started (workspace created)\", {\r\n      taskId,\r\n      workspaceName,\r\n      workspacePath,\r\n      trunkBranch,\r\n      forkSuccess: forkResult.success,\r\n    });\r\n\r\n    // Persist workspace entry before starting work so it's durable across crashes.\r\n    await this.config.editConfig((config) => {\r\n      let projectConfig = config.projects.get(parentMeta.projectPath);\r\n      if (!projectConfig) {\r\n        projectConfig = { workspaces: [] };\r\n        config.projects.set(parentMeta.projectPath, projectConfig);\r\n      }\r\n\r\n      projectConfig.workspaces.push({\r\n        path: workspacePath,\r\n        id: taskId,\r\n        name: workspaceName,\r\n        title: args.title,\r\n        createdAt,\r\n        runtimeConfig: forkedRuntimeConfig,\r\n        aiSettings: { model: canonicalModel, thinkingLevel: effectiveThinkingLevel },\r\n        agentId,\r\n        parentWorkspaceId,\r\n        agentType,\r\n        taskStatus: \"running\",\r\n        taskTrunkBranch: trunkBranch,\r\n        taskBaseCommitSha: taskBaseCommitSha ?? undefined,\r\n        taskModelString,\r\n        taskThinkingLevel: effectiveThinkingLevel,\r\n        taskExperiments: args.experiments,\r\n      });\r\n      return config;\r\n    });\r\n\r\n    // Emit metadata update so the UI sees the workspace immediately.\r\n    await this.emitWorkspaceMetadata(taskId);\r\n\r\n    // Kick init (best-effort, async).\r\n    const secrets = secretsToRecord(this.config.getEffectiveSecrets(parentMeta.projectPath));\r\n    runBackgroundInit(\r\n      runtimeForTaskWorkspace,\r\n      {\r\n        projectPath: parentMeta.projectPath,\r\n        branchName: workspaceName,\r\n        trunkBranch,\r\n        workspacePath,\r\n        initLogger,\r\n        env: secrets,\r\n        skipInitHook,\r\n      },\r\n      taskId\r\n    );\r\n\r\n    // Start immediately (counts towards parallel limit).\r\n    const sendResult = await this.workspaceService.sendMessage(taskId, prompt, {\r\n      model: taskModelString,\r\n      agentId,\r\n      thinkingLevel: effectiveThinkingLevel,\r\n      experiments: args.experiments,\r\n    });\r\n    if (!sendResult.success) {\r\n      const message =\r\n        typeof sendResult.error === \"string\"\r\n          ? sendResult.error\r\n          : formatSendMessageError(sendResult.error).message;\r\n      await this.rollbackFailedTaskCreate(\r\n        runtimeForTaskWorkspace,\r\n        parentMeta.projectPath,\r\n        workspaceName,\r\n        taskId\r\n      );\r\n      return Err(message);\r\n    }\r\n\r\n    return Ok({ taskId, kind: \"agent\", status: \"running\" });\r\n  }\r\n\r\n  async terminateDescendantAgentTask(\r\n    ancestorWorkspaceId: string,\r\n    taskId: string\r\n  ): Promise<Result<TerminateAgentTaskResult, string>> {\r\n    assert(\r\n      ancestorWorkspaceId.length > 0,\r\n      \"terminateDescendantAgentTask: ancestorWorkspaceId must be non-empty\"\r\n    );\r\n    assert(taskId.length > 0, \"terminateDescendantAgentTask: taskId must be non-empty\");\r\n\r\n    const terminatedTaskIds: string[] = [];\r\n\r\n    {\r\n      await using _lock = await this.mutex.acquire();\r\n\r\n      const cfg = this.config.loadConfigOrDefault();\r\n      const entry = findWorkspaceEntry(cfg, taskId);\r\n      if (!entry?.workspace.parentWorkspaceId) {\r\n        return Err(\"Task not found\");\r\n      }\r\n\r\n      const index = this.buildAgentTaskIndex(cfg);\r\n      if (\r\n        !this.isDescendantAgentTaskUsingParentById(index.parentById, ancestorWorkspaceId, taskId)\r\n      ) {\r\n        return Err(\"Task is not a descendant of this workspace\");\r\n      }\r\n\r\n      // Terminate the entire subtree to avoid orphaned descendant tasks.\r\n      const descendants = this.listDescendantAgentTaskIdsFromIndex(index, taskId);\r\n      const toTerminate = Array.from(new Set([taskId, ...descendants]));\r\n\r\n      // Delete leaves first to avoid leaving children with missing parents.\r\n      const parentById = index.parentById;\r\n      const depthById = new Map<string, number>();\r\n      for (const id of toTerminate) {\r\n        depthById.set(id, this.getTaskDepthFromParentById(parentById, id));\r\n      }\r\n      toTerminate.sort((a, b) => (depthById.get(b) ?? 0) - (depthById.get(a) ?? 0));\r\n\r\n      const terminationError = new Error(\"Task terminated\");\r\n\r\n      for (const id of toTerminate) {\r\n        // Best-effort: stop any active stream immediately to avoid further token usage.\r\n        try {\r\n          const stopResult = await this.aiService.stopStream(id, { abandonPartial: true });\r\n          if (!stopResult.success) {\r\n            log.debug(\"terminateDescendantAgentTask: stopStream failed\", { taskId: id });\r\n          }\r\n        } catch (error: unknown) {\r\n          log.debug(\"terminateDescendantAgentTask: stopStream threw\", { taskId: id, error });\r\n        }\r\n\r\n        this.remindedAwaitingReport.delete(id);\r\n        this.completedReportsByTaskId.delete(id);\r\n        this.rejectWaiters(id, terminationError);\r\n\r\n        const removeResult = await this.workspaceService.remove(id, true);\r\n        if (!removeResult.success) {\r\n          return Err(`Failed to remove task workspace (${id}): ${removeResult.error}`);\r\n        }\r\n\r\n        terminatedTaskIds.push(id);\r\n      }\r\n    }\r\n\r\n    // Free slots and start any queued tasks (best-effort).\r\n    await this.maybeStartQueuedTasks();\r\n\r\n    return Ok({ terminatedTaskIds });\r\n  }\r\n\r\n  private async rollbackFailedTaskCreate(\r\n    runtime: ReturnType<typeof createRuntime>,\r\n    projectPath: string,\r\n    workspaceName: string,\r\n    taskId: string\r\n  ): Promise<void> {\r\n    try {\r\n      await this.config.removeWorkspace(taskId);\r\n    } catch (error: unknown) {\r\n      log.error(\"Task.create rollback: failed to remove workspace from config\", {\r\n        taskId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n\r\n    this.workspaceService.emit(\"metadata\", { workspaceId: taskId, metadata: null });\r\n\r\n    try {\r\n      const deleteResult = await runtime.deleteWorkspace(projectPath, workspaceName, true);\r\n      if (!deleteResult.success) {\r\n        log.error(\"Task.create rollback: failed to delete workspace\", {\r\n          taskId,\r\n          error: deleteResult.error,\r\n        });\r\n      }\r\n    } catch (error: unknown) {\r\n      log.error(\"Task.create rollback: runtime.deleteWorkspace threw\", {\r\n        taskId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n\r\n    try {\r\n      const sessionDir = this.config.getSessionDir(taskId);\r\n      await fsPromises.rm(sessionDir, { recursive: true, force: true });\r\n    } catch (error: unknown) {\r\n      log.error(\"Task.create rollback: failed to remove session directory\", {\r\n        taskId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n\r\n  private isForegroundAwaiting(workspaceId: string): boolean {\r\n    const count = this.foregroundAwaitCountByWorkspaceId.get(workspaceId);\r\n    return typeof count === \"number\" && count > 0;\r\n  }\r\n\r\n  private startForegroundAwait(workspaceId: string): () => void {\r\n    assert(workspaceId.length > 0, \"startForegroundAwait: workspaceId must be non-empty\");\r\n\r\n    const current = this.foregroundAwaitCountByWorkspaceId.get(workspaceId) ?? 0;\r\n    assert(\r\n      Number.isInteger(current) && current >= 0,\r\n      \"startForegroundAwait: expected non-negative integer counter\"\r\n    );\r\n\r\n    this.foregroundAwaitCountByWorkspaceId.set(workspaceId, current + 1);\r\n\r\n    return () => {\r\n      const current = this.foregroundAwaitCountByWorkspaceId.get(workspaceId) ?? 0;\r\n      assert(\r\n        Number.isInteger(current) && current > 0,\r\n        \"startForegroundAwait cleanup: expected positive integer counter\"\r\n      );\r\n      if (current <= 1) {\r\n        this.foregroundAwaitCountByWorkspaceId.delete(workspaceId);\r\n      } else {\r\n        this.foregroundAwaitCountByWorkspaceId.set(workspaceId, current - 1);\r\n      }\r\n    };\r\n  }\r\n\r\n  async waitForAgentReport(\r\n    taskId: string,\r\n    options?: { timeoutMs?: number; abortSignal?: AbortSignal; requestingWorkspaceId?: string }\r\n  ): Promise<{ reportMarkdown: string; title?: string }> {\r\n    assert(taskId.length > 0, \"waitForAgentReport: taskId must be non-empty\");\r\n\r\n    const cached = this.completedReportsByTaskId.get(taskId);\r\n    if (cached) {\r\n      return { reportMarkdown: cached.reportMarkdown, title: cached.title };\r\n    }\r\n\r\n    const timeoutMs = options?.timeoutMs ?? 10 * 60 * 1000; // 10 minutes\r\n    assert(Number.isFinite(timeoutMs) && timeoutMs > 0, \"waitForAgentReport: timeoutMs invalid\");\r\n\r\n    const requestingWorkspaceId = coerceNonEmptyString(options?.requestingWorkspaceId);\r\n\r\n    const tryReadPersistedReport = async (): Promise<{\r\n      reportMarkdown: string;\r\n      title?: string;\r\n    } | null> => {\r\n      if (!requestingWorkspaceId) {\r\n        return null;\r\n      }\r\n\r\n      const sessionDir = this.config.getSessionDir(requestingWorkspaceId);\r\n      const artifact = await readSubagentReportArtifact(sessionDir, taskId);\r\n      if (!artifact) {\r\n        return null;\r\n      }\r\n\r\n      // Cache for the current process (best-effort). Disk is the source of truth.\r\n      this.completedReportsByTaskId.set(taskId, {\r\n        reportMarkdown: artifact.reportMarkdown,\r\n        title: artifact.title,\r\n        ancestorWorkspaceIds: artifact.ancestorWorkspaceIds,\r\n      });\r\n      this.enforceCompletedReportCacheLimit();\r\n\r\n      return { reportMarkdown: artifact.reportMarkdown, title: artifact.title };\r\n    };\r\n\r\n    // Fast-path: if the task is already gone (cleanup) or already reported (restart), return the\r\n    // persisted artifact from the requesting workspace session dir.\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const taskWorkspaceEntry = findWorkspaceEntry(cfg, taskId);\r\n    if (!taskWorkspaceEntry || taskWorkspaceEntry.workspace.taskStatus === \"reported\") {\r\n      const persisted = await tryReadPersistedReport();\r\n      if (persisted) {\r\n        return persisted;\r\n      }\r\n\r\n      throw new Error(\"Task not found\");\r\n    }\r\n\r\n    return await new Promise<{ reportMarkdown: string; title?: string }>((resolve, reject) => {\r\n      void (async () => {\r\n        // Validate existence early to avoid waiting on never-resolving task IDs.\r\n        const cfg = this.config.loadConfigOrDefault();\r\n        const taskWorkspaceEntry = findWorkspaceEntry(cfg, taskId);\r\n        if (!taskWorkspaceEntry) {\r\n          const persisted = await tryReadPersistedReport();\r\n          if (persisted) {\r\n            resolve(persisted);\r\n            return;\r\n          }\r\n\r\n          reject(new Error(\"Task not found\"));\r\n          return;\r\n        }\r\n\r\n        if (taskWorkspaceEntry.workspace.taskStatus === \"reported\") {\r\n          const persisted = await tryReadPersistedReport();\r\n          if (persisted) {\r\n            resolve(persisted);\r\n            return;\r\n          }\r\n\r\n          reject(new Error(\"Task not found\"));\r\n          return;\r\n        }\r\n\r\n        let timeout: ReturnType<typeof setTimeout> | null = null;\r\n        let startWaiter: PendingTaskStartWaiter | null = null;\r\n        let abortListener: (() => void) | null = null;\r\n        let stopBlockingRequester: (() => void) | null = requestingWorkspaceId\r\n          ? this.startForegroundAwait(requestingWorkspaceId)\r\n          : null;\r\n\r\n        const startReportTimeout = () => {\r\n          if (timeout) return;\r\n          timeout = setTimeout(() => {\r\n            entry.cleanup();\r\n            reject(new Error(\"Timed out waiting for agent_report\"));\r\n          }, timeoutMs);\r\n        };\r\n\r\n        const cleanupStartWaiter = () => {\r\n          if (!startWaiter) return;\r\n          startWaiter.cleanup();\r\n          startWaiter = null;\r\n        };\r\n\r\n        const entry: PendingTaskWaiter = {\r\n          createdAt: Date.now(),\r\n          resolve: (report) => {\r\n            entry.cleanup();\r\n            resolve(report);\r\n          },\r\n          reject: (error) => {\r\n            entry.cleanup();\r\n            reject(error);\r\n          },\r\n          cleanup: () => {\r\n            const current = this.pendingWaitersByTaskId.get(taskId);\r\n            if (current) {\r\n              const next = current.filter((w) => w !== entry);\r\n              if (next.length === 0) {\r\n                this.pendingWaitersByTaskId.delete(taskId);\r\n              } else {\r\n                this.pendingWaitersByTaskId.set(taskId, next);\r\n              }\r\n            }\r\n\r\n            cleanupStartWaiter();\r\n\r\n            if (timeout) {\r\n              clearTimeout(timeout);\r\n              timeout = null;\r\n            }\r\n\r\n            if (abortListener && options?.abortSignal) {\r\n              options.abortSignal.removeEventListener(\"abort\", abortListener);\r\n              abortListener = null;\r\n            }\r\n\r\n            if (stopBlockingRequester) {\r\n              try {\r\n                stopBlockingRequester();\r\n              } finally {\r\n                stopBlockingRequester = null;\r\n              }\r\n            }\r\n          },\r\n        };\r\n\r\n        const list = this.pendingWaitersByTaskId.get(taskId) ?? [];\r\n        list.push(entry);\r\n        this.pendingWaitersByTaskId.set(taskId, list);\r\n\r\n        // Don't start the execution timeout while the task is still queued.\r\n        // The timer starts once the child actually begins running (queued -> running).\r\n        const initialStatus = taskWorkspaceEntry.workspace.taskStatus;\r\n        if (initialStatus === \"queued\") {\r\n          const startWaiterEntry: PendingTaskStartWaiter = {\r\n            createdAt: Date.now(),\r\n            start: startReportTimeout,\r\n            cleanup: () => {\r\n              const currentStartWaiters = this.pendingStartWaitersByTaskId.get(taskId);\r\n              if (currentStartWaiters) {\r\n                const next = currentStartWaiters.filter((w) => w !== startWaiterEntry);\r\n                if (next.length === 0) {\r\n                  this.pendingStartWaitersByTaskId.delete(taskId);\r\n                } else {\r\n                  this.pendingStartWaitersByTaskId.set(taskId, next);\r\n                }\r\n              }\r\n            },\r\n          };\r\n          startWaiter = startWaiterEntry;\r\n\r\n          const currentStartWaiters = this.pendingStartWaitersByTaskId.get(taskId) ?? [];\r\n          currentStartWaiters.push(startWaiterEntry);\r\n          this.pendingStartWaitersByTaskId.set(taskId, currentStartWaiters);\r\n\r\n          // Close the race where the task starts between the initial config read and registering the waiter.\r\n          const cfgAfterRegister = this.config.loadConfigOrDefault();\r\n          const afterEntry = findWorkspaceEntry(cfgAfterRegister, taskId);\r\n          if (afterEntry?.workspace.taskStatus !== \"queued\") {\r\n            cleanupStartWaiter();\r\n            startReportTimeout();\r\n          }\r\n\r\n          // If the awaited task is queued and the caller is blocked in the foreground, ensure the\r\n          // scheduler runs after the waiter is registered. This avoids deadlocks when\r\n          // maxParallelAgentTasks is low.\r\n          if (requestingWorkspaceId) {\r\n            void this.maybeStartQueuedTasks();\r\n          }\r\n        } else {\r\n          startReportTimeout();\r\n        }\r\n\r\n        if (options?.abortSignal) {\r\n          if (options.abortSignal.aborted) {\r\n            entry.cleanup();\r\n            reject(new Error(\"Interrupted\"));\r\n            return;\r\n          }\r\n\r\n          abortListener = () => {\r\n            entry.cleanup();\r\n            reject(new Error(\"Interrupted\"));\r\n          };\r\n          options.abortSignal.addEventListener(\"abort\", abortListener, { once: true });\r\n        }\r\n      })().catch((error: unknown) => {\r\n        reject(error instanceof Error ? error : new Error(String(error)));\r\n      });\r\n    });\r\n  }\r\n\r\n  getAgentTaskStatus(taskId: string): AgentTaskStatus | null {\r\n    assert(taskId.length > 0, \"getAgentTaskStatus: taskId must be non-empty\");\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const entry = findWorkspaceEntry(cfg, taskId);\r\n    const status = entry?.workspace.taskStatus;\r\n    return status ?? null;\r\n  }\r\n\r\n  hasActiveDescendantAgentTasksForWorkspace(workspaceId: string): boolean {\r\n    assert(\r\n      workspaceId.length > 0,\r\n      \"hasActiveDescendantAgentTasksForWorkspace: workspaceId must be non-empty\"\r\n    );\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    return this.hasActiveDescendantAgentTasks(cfg, workspaceId);\r\n  }\r\n\r\n  listActiveDescendantAgentTaskIds(workspaceId: string): string[] {\r\n    assert(\r\n      workspaceId.length > 0,\r\n      \"listActiveDescendantAgentTaskIds: workspaceId must be non-empty\"\r\n    );\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const index = this.buildAgentTaskIndex(cfg);\r\n\r\n    const activeStatuses = new Set<AgentTaskStatus>([\"queued\", \"running\", \"awaiting_report\"]);\r\n    const result: string[] = [];\r\n    const stack: string[] = [...(index.childrenByParent.get(workspaceId) ?? [])];\r\n    while (stack.length > 0) {\r\n      const next = stack.pop()!;\r\n      const status = index.byId.get(next)?.taskStatus;\r\n      if (status && activeStatuses.has(status)) {\r\n        result.push(next);\r\n      }\r\n      const children = index.childrenByParent.get(next);\r\n      if (children) {\r\n        for (const child of children) {\r\n          stack.push(child);\r\n        }\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  listDescendantAgentTasks(\r\n    workspaceId: string,\r\n    options?: { statuses?: AgentTaskStatus[] }\r\n  ): DescendantAgentTaskInfo[] {\r\n    assert(workspaceId.length > 0, \"listDescendantAgentTasks: workspaceId must be non-empty\");\r\n\r\n    const statuses = options?.statuses;\r\n    const statusFilter = statuses && statuses.length > 0 ? new Set(statuses) : null;\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const index = this.buildAgentTaskIndex(cfg);\r\n\r\n    const result: DescendantAgentTaskInfo[] = [];\r\n\r\n    const stack: Array<{ taskId: string; depth: number }> = [];\r\n    for (const childTaskId of index.childrenByParent.get(workspaceId) ?? []) {\r\n      stack.push({ taskId: childTaskId, depth: 1 });\r\n    }\r\n\r\n    while (stack.length > 0) {\r\n      const next = stack.pop()!;\r\n      const entry = index.byId.get(next.taskId);\r\n      if (!entry) continue;\r\n\r\n      assert(\r\n        entry.parentWorkspaceId,\r\n        `listDescendantAgentTasks: task ${next.taskId} is missing parentWorkspaceId`\r\n      );\r\n\r\n      const status: AgentTaskStatus = entry.taskStatus ?? \"running\";\r\n      if (!statusFilter || statusFilter.has(status)) {\r\n        result.push({\r\n          taskId: next.taskId,\r\n          status,\r\n          parentWorkspaceId: entry.parentWorkspaceId,\r\n          agentType: entry.agentType,\r\n          workspaceName: entry.name,\r\n          title: entry.title,\r\n          createdAt: entry.createdAt,\r\n          modelString: entry.aiSettings?.model,\r\n          thinkingLevel: entry.aiSettings?.thinkingLevel,\r\n          depth: next.depth,\r\n        });\r\n      }\r\n\r\n      for (const childTaskId of index.childrenByParent.get(next.taskId) ?? []) {\r\n        stack.push({ taskId: childTaskId, depth: next.depth + 1 });\r\n      }\r\n    }\r\n\r\n    // Stable ordering: oldest first, then depth (ties by taskId for determinism).\r\n    result.sort((a, b) => {\r\n      const aTime = a.createdAt ? Date.parse(a.createdAt) : 0;\r\n      const bTime = b.createdAt ? Date.parse(b.createdAt) : 0;\r\n      if (aTime !== bTime) return aTime - bTime;\r\n      if (a.depth !== b.depth) return a.depth - b.depth;\r\n      return a.taskId.localeCompare(b.taskId);\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  async filterDescendantAgentTaskIds(\r\n    ancestorWorkspaceId: string,\r\n    taskIds: string[]\r\n  ): Promise<string[]> {\r\n    assert(\r\n      ancestorWorkspaceId.length > 0,\r\n      \"filterDescendantAgentTaskIds: ancestorWorkspaceId required\"\r\n    );\r\n    assert(Array.isArray(taskIds), \"filterDescendantAgentTaskIds: taskIds must be an array\");\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const parentById = this.buildAgentTaskIndex(cfg).parentById;\r\n\r\n    const result: string[] = [];\r\n    const maybePersisted: string[] = [];\r\n\r\n    for (const taskId of taskIds) {\r\n      if (typeof taskId !== \"string\" || taskId.length === 0) continue;\r\n\r\n      if (this.isDescendantAgentTaskUsingParentById(parentById, ancestorWorkspaceId, taskId)) {\r\n        result.push(taskId);\r\n        continue;\r\n      }\r\n\r\n      const cached = this.completedReportsByTaskId.get(taskId);\r\n      if (hasAncestorWorkspaceId(cached, ancestorWorkspaceId)) {\r\n        result.push(taskId);\r\n        continue;\r\n      }\r\n\r\n      maybePersisted.push(taskId);\r\n    }\r\n\r\n    if (maybePersisted.length === 0) {\r\n      return result;\r\n    }\r\n\r\n    const sessionDir = this.config.getSessionDir(ancestorWorkspaceId);\r\n    const persisted = await readSubagentReportArtifactsFile(sessionDir);\r\n    for (const taskId of maybePersisted) {\r\n      const entry = persisted.artifactsByChildTaskId[taskId];\r\n      if (!entry) continue;\r\n      if (hasAncestorWorkspaceId(entry, ancestorWorkspaceId)) {\r\n        result.push(taskId);\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  private listDescendantAgentTaskIdsFromIndex(\r\n    index: AgentTaskIndex,\r\n    workspaceId: string\r\n  ): string[] {\r\n    assert(\r\n      workspaceId.length > 0,\r\n      \"listDescendantAgentTaskIdsFromIndex: workspaceId must be non-empty\"\r\n    );\r\n\r\n    const result: string[] = [];\r\n    const stack: string[] = [...(index.childrenByParent.get(workspaceId) ?? [])];\r\n    while (stack.length > 0) {\r\n      const next = stack.pop()!;\r\n      result.push(next);\r\n      const children = index.childrenByParent.get(next);\r\n      if (children) {\r\n        for (const child of children) {\r\n          stack.push(child);\r\n        }\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  async isDescendantAgentTask(ancestorWorkspaceId: string, taskId: string): Promise<boolean> {\r\n    assert(ancestorWorkspaceId.length > 0, \"isDescendantAgentTask: ancestorWorkspaceId required\");\r\n    assert(taskId.length > 0, \"isDescendantAgentTask: taskId required\");\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const parentById = this.buildAgentTaskIndex(cfg).parentById;\r\n    if (this.isDescendantAgentTaskUsingParentById(parentById, ancestorWorkspaceId, taskId)) {\r\n      return true;\r\n    }\r\n\r\n    // The task workspace may have been removed after it reported (cleanup/restart). Preserve scope\r\n    // checks by consulting persisted report artifacts in the ancestor session dir.\r\n    const cached = this.completedReportsByTaskId.get(taskId);\r\n    if (hasAncestorWorkspaceId(cached, ancestorWorkspaceId)) {\r\n      return true;\r\n    }\r\n\r\n    const sessionDir = this.config.getSessionDir(ancestorWorkspaceId);\r\n    const persisted = await readSubagentReportArtifactsFile(sessionDir);\r\n    const entry = persisted.artifactsByChildTaskId[taskId];\r\n    return hasAncestorWorkspaceId(entry, ancestorWorkspaceId);\r\n  }\r\n\r\n  private isDescendantAgentTaskUsingParentById(\r\n    parentById: Map<string, string>,\r\n    ancestorWorkspaceId: string,\r\n    taskId: string\r\n  ): boolean {\r\n    let current = taskId;\r\n    for (let i = 0; i < 32; i++) {\r\n      const parent = parentById.get(current);\r\n      if (!parent) return false;\r\n      if (parent === ancestorWorkspaceId) return true;\r\n      current = parent;\r\n    }\r\n\r\n    throw new Error(\r\n      `isDescendantAgentTaskUsingParentById: possible parentWorkspaceId cycle starting at ${taskId}`\r\n    );\r\n  }\r\n\r\n  // --- Internal orchestration ---\r\n\r\n  private listAncestorWorkspaceIdsUsingParentById(\r\n    parentById: Map<string, string>,\r\n    taskId: string\r\n  ): string[] {\r\n    const ancestors: string[] = [];\r\n\r\n    let current = taskId;\r\n    for (let i = 0; i < 32; i++) {\r\n      const parent = parentById.get(current);\r\n      if (!parent) return ancestors;\r\n      ancestors.push(parent);\r\n      current = parent;\r\n    }\r\n\r\n    throw new Error(\r\n      `listAncestorWorkspaceIdsUsingParentById: possible parentWorkspaceId cycle starting at ${taskId}`\r\n    );\r\n  }\r\n\r\n  private listAgentTaskWorkspaces(\r\n    config: ReturnType<Config[\"loadConfigOrDefault\"]>\r\n  ): AgentTaskWorkspaceEntry[] {\r\n    const tasks: AgentTaskWorkspaceEntry[] = [];\r\n    for (const [projectPath, project] of config.projects) {\r\n      for (const workspace of project.workspaces) {\r\n        if (!workspace.id) continue;\r\n        if (!workspace.parentWorkspaceId) continue;\r\n        tasks.push({ ...workspace, projectPath });\r\n      }\r\n    }\r\n    return tasks;\r\n  }\r\n\r\n  private buildAgentTaskIndex(config: ReturnType<Config[\"loadConfigOrDefault\"]>): AgentTaskIndex {\r\n    const byId = new Map<string, AgentTaskWorkspaceEntry>();\r\n    const childrenByParent = new Map<string, string[]>();\r\n    const parentById = new Map<string, string>();\r\n\r\n    for (const task of this.listAgentTaskWorkspaces(config)) {\r\n      const taskId = task.id!;\r\n      byId.set(taskId, task);\r\n\r\n      const parent = task.parentWorkspaceId;\r\n      if (!parent) continue;\r\n\r\n      parentById.set(taskId, parent);\r\n      const list = childrenByParent.get(parent) ?? [];\r\n      list.push(taskId);\r\n      childrenByParent.set(parent, list);\r\n    }\r\n\r\n    return { byId, childrenByParent, parentById };\r\n  }\r\n\r\n  private countActiveAgentTasks(config: ReturnType<Config[\"loadConfigOrDefault\"]>): number {\r\n    let activeCount = 0;\r\n    for (const task of this.listAgentTaskWorkspaces(config)) {\r\n      const status: AgentTaskStatus = task.taskStatus ?? \"running\";\r\n      // If this task workspace is blocked in a foreground wait, do not count it towards parallelism.\r\n      // This prevents deadlocks where a task spawns a nested task in the foreground while\r\n      // maxParallelAgentTasks is low (e.g. 1).\r\n      // Note: StreamManager can still report isStreaming() while a tool call is executing, so\r\n      // isStreaming is not a reliable signal for \"actively doing work\" here.\r\n      if (status === \"running\" && task.id && this.isForegroundAwaiting(task.id)) {\r\n        continue;\r\n      }\r\n      if (status === \"running\" || status === \"awaiting_report\") {\r\n        activeCount += 1;\r\n        continue;\r\n      }\r\n\r\n      // Defensive: a task may still be streaming even after it transitioned to another status\r\n      // (e.g. tool-call-end happened but the stream hasn't ended yet). Count it as active so we\r\n      // never exceed the configured parallel limit.\r\n      if (task.id && this.aiService.isStreaming(task.id)) {\r\n        activeCount += 1;\r\n      }\r\n    }\r\n\r\n    return activeCount;\r\n  }\r\n\r\n  private hasActiveDescendantAgentTasks(\r\n    config: ReturnType<Config[\"loadConfigOrDefault\"]>,\r\n    workspaceId: string\r\n  ): boolean {\r\n    assert(workspaceId.length > 0, \"hasActiveDescendantAgentTasks: workspaceId must be non-empty\");\r\n\r\n    const index = this.buildAgentTaskIndex(config);\r\n\r\n    const activeStatuses = new Set<AgentTaskStatus>([\"queued\", \"running\", \"awaiting_report\"]);\r\n    const stack: string[] = [...(index.childrenByParent.get(workspaceId) ?? [])];\r\n    while (stack.length > 0) {\r\n      const next = stack.pop()!;\r\n      const status = index.byId.get(next)?.taskStatus;\r\n      if (status && activeStatuses.has(status)) {\r\n        return true;\r\n      }\r\n      const children = index.childrenByParent.get(next);\r\n      if (children) {\r\n        for (const child of children) {\r\n          stack.push(child);\r\n        }\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  private getTaskDepth(\r\n    config: ReturnType<Config[\"loadConfigOrDefault\"]>,\r\n    workspaceId: string\r\n  ): number {\r\n    assert(workspaceId.length > 0, \"getTaskDepth: workspaceId must be non-empty\");\r\n\r\n    return this.getTaskDepthFromParentById(\r\n      this.buildAgentTaskIndex(config).parentById,\r\n      workspaceId\r\n    );\r\n  }\r\n\r\n  private getTaskDepthFromParentById(parentById: Map<string, string>, workspaceId: string): number {\r\n    let depth = 0;\r\n    let current = workspaceId;\r\n    for (let i = 0; i < 32; i++) {\r\n      const parent = parentById.get(current);\r\n      if (!parent) break;\r\n      depth += 1;\r\n      current = parent;\r\n    }\r\n\r\n    if (depth >= 32) {\r\n      throw new Error(\r\n        `getTaskDepthFromParentById: possible parentWorkspaceId cycle starting at ${workspaceId}`\r\n      );\r\n    }\r\n\r\n    return depth;\r\n  }\r\n\r\n  async maybeStartQueuedTasks(): Promise<void> {\r\n    await using _lock = await this.mutex.acquire();\r\n\r\n    const configAtStart = this.config.loadConfigOrDefault();\r\n    const taskSettingsAtStart: TaskSettings = configAtStart.taskSettings ?? DEFAULT_TASK_SETTINGS;\r\n\r\n    const activeCount = this.countActiveAgentTasks(configAtStart);\r\n    const availableSlots = Math.max(0, taskSettingsAtStart.maxParallelAgentTasks - activeCount);\r\n    taskQueueDebug(\"TaskService.maybeStartQueuedTasks summary\", {\r\n      activeCount,\r\n      maxParallelAgentTasks: taskSettingsAtStart.maxParallelAgentTasks,\r\n      availableSlots,\r\n    });\r\n    if (availableSlots === 0) return;\r\n\r\n    const queuedTaskIds = this.listAgentTaskWorkspaces(configAtStart)\r\n      .filter((t) => t.taskStatus === \"queued\" && typeof t.id === \"string\")\r\n      .sort((a, b) => {\r\n        const aTime = a.createdAt ? Date.parse(a.createdAt) : 0;\r\n        const bTime = b.createdAt ? Date.parse(b.createdAt) : 0;\r\n        return aTime - bTime;\r\n      })\r\n      .map((t) => t.id!);\r\n\r\n    taskQueueDebug(\"TaskService.maybeStartQueuedTasks candidates\", {\r\n      queuedCount: queuedTaskIds.length,\r\n      queuedIds: queuedTaskIds,\r\n    });\r\n\r\n    for (const taskId of queuedTaskIds) {\r\n      const config = this.config.loadConfigOrDefault();\r\n      const taskSettings: TaskSettings = config.taskSettings ?? DEFAULT_TASK_SETTINGS;\r\n      assert(\r\n        Number.isFinite(taskSettings.maxParallelAgentTasks) &&\r\n          taskSettings.maxParallelAgentTasks > 0,\r\n        \"TaskService.maybeStartQueuedTasks: maxParallelAgentTasks must be a positive number\"\r\n      );\r\n\r\n      const activeCount = this.countActiveAgentTasks(config);\r\n      if (activeCount >= taskSettings.maxParallelAgentTasks) {\r\n        break;\r\n      }\r\n\r\n      const taskEntry = findWorkspaceEntry(config, taskId);\r\n      if (!taskEntry?.workspace.parentWorkspaceId) continue;\r\n      const task = taskEntry.workspace;\r\n      if (task.taskStatus !== \"queued\") continue;\r\n\r\n      // Defensive: tasks can begin streaming before taskStatus flips to \"running\".\r\n      if (this.aiService.isStreaming(taskId)) {\r\n        taskQueueDebug(\"TaskService.maybeStartQueuedTasks queued-but-streaming; marking running\", {\r\n          taskId,\r\n        });\r\n        await this.setTaskStatus(taskId, \"running\");\r\n        continue;\r\n      }\r\n\r\n      assert(typeof task.name === \"string\" && task.name.trim().length > 0, \"Task name missing\");\r\n\r\n      const parentId = coerceNonEmptyString(task.parentWorkspaceId);\r\n      if (!parentId) {\r\n        log.error(\"Queued task missing parentWorkspaceId; cannot start\", { taskId });\r\n        continue;\r\n      }\r\n\r\n      const parentEntry = findWorkspaceEntry(config, parentId);\r\n      if (!parentEntry) {\r\n        log.error(\"Queued task parent not found; cannot start\", { taskId, parentId });\r\n        continue;\r\n      }\r\n\r\n      const parentWorkspaceName = coerceNonEmptyString(parentEntry.workspace.name);\r\n      if (!parentWorkspaceName) {\r\n        log.error(\"Queued task parent missing workspace name; cannot start\", {\r\n          taskId,\r\n          parentId,\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const taskRuntimeConfig = task.runtimeConfig ?? parentEntry.workspace.runtimeConfig;\r\n      if (!taskRuntimeConfig) {\r\n        log.error(\"Queued task missing runtimeConfig; cannot start\", { taskId });\r\n        continue;\r\n      }\r\n\r\n      const parentRuntimeConfig = parentEntry.workspace.runtimeConfig ?? taskRuntimeConfig;\r\n      const workspaceName = task.name.trim();\r\n      const runtime = createRuntimeForWorkspace({\r\n        runtimeConfig: taskRuntimeConfig,\r\n        projectPath: taskEntry.projectPath,\r\n        name: workspaceName,\r\n      });\r\n      let runtimeForTaskWorkspace = runtime;\r\n      let forkedRuntimeConfig = taskRuntimeConfig;\r\n\r\n      let workspacePath =\r\n        coerceNonEmptyString(task.path) ??\r\n        runtime.getWorkspacePath(taskEntry.projectPath, workspaceName);\r\n\r\n      let workspaceExists = false;\r\n      try {\r\n        await runtime.stat(workspacePath);\r\n        workspaceExists = true;\r\n      } catch {\r\n        workspaceExists = false;\r\n      }\r\n\r\n      const inMemoryInit = this.initStateManager.getInitState(taskId);\r\n      const persistedInit = inMemoryInit\r\n        ? null\r\n        : await this.initStateManager.readInitStatus(taskId);\r\n\r\n      // Re-check capacity after awaiting IO to avoid dequeuing work (worktree creation/init) when\r\n      // another task became active in the meantime.\r\n      const latestConfig = this.config.loadConfigOrDefault();\r\n      const latestTaskSettings: TaskSettings = latestConfig.taskSettings ?? DEFAULT_TASK_SETTINGS;\r\n      const latestActiveCount = this.countActiveAgentTasks(latestConfig);\r\n      if (latestActiveCount >= latestTaskSettings.maxParallelAgentTasks) {\r\n        taskQueueDebug(\"TaskService.maybeStartQueuedTasks became full mid-loop\", {\r\n          taskId,\r\n          activeCount: latestActiveCount,\r\n          maxParallelAgentTasks: latestTaskSettings.maxParallelAgentTasks,\r\n        });\r\n        break;\r\n      }\r\n\r\n      // Ensure the workspace exists before starting. Queued tasks should not create worktrees/directories\r\n      // until they are actually dequeued.\r\n      let trunkBranch =\r\n        typeof task.taskTrunkBranch === \"string\" && task.taskTrunkBranch.trim().length > 0\r\n          ? task.taskTrunkBranch.trim()\r\n          : parentWorkspaceName;\r\n      if (trunkBranch.length === 0) {\r\n        trunkBranch = \"main\";\r\n      }\r\n\r\n      let shouldRunInit = !inMemoryInit && !persistedInit;\r\n      let initLogger: InitLogger | null = null;\r\n      const getInitLogger = (): InitLogger => {\r\n        if (initLogger) return initLogger;\r\n        initLogger = this.startWorkspaceInit(taskId, taskEntry.projectPath);\r\n        return initLogger;\r\n      };\r\n\r\n      taskQueueDebug(\"TaskService.maybeStartQueuedTasks start attempt\", {\r\n        taskId,\r\n        workspaceName,\r\n        parentId,\r\n        parentWorkspaceName,\r\n        runtimeType: taskRuntimeConfig.type,\r\n        workspacePath,\r\n        workspaceExists,\r\n        trunkBranch,\r\n        shouldRunInit,\r\n        inMemoryInit: Boolean(inMemoryInit),\r\n        persistedInit: Boolean(persistedInit),\r\n      });\r\n\r\n      // If the workspace doesn't exist yet, create it now (fork preferred, else createWorkspace).\r\n      if (!workspaceExists) {\r\n        shouldRunInit = true;\r\n        const initLogger = getInitLogger();\r\n\r\n        const forkResult = await runtime.forkWorkspace({\r\n          projectPath: taskEntry.projectPath,\r\n          sourceWorkspaceName: parentWorkspaceName,\r\n          newWorkspaceName: workspaceName,\r\n          initLogger,\r\n        });\r\n\r\n        const { forkedRuntimeConfig: resolvedForkedRuntimeConfig } = await applyForkRuntimeUpdates(\r\n          this.config,\r\n          parentId,\r\n          parentRuntimeConfig,\r\n          forkResult\r\n        );\r\n        forkedRuntimeConfig = resolvedForkedRuntimeConfig;\r\n\r\n        if (forkResult.sourceRuntimeConfig) {\r\n          // Ensure UI gets the updated runtimeConfig for the parent workspace.\r\n          await this.emitWorkspaceMetadata(parentId);\r\n        }\r\n\r\n        if (!forkResult.success && forkResult.failureIsFatal) {\r\n          initLogger.logComplete(-1);\r\n          log.error(\"Task fork failed\", { taskId, error: forkResult.error });\r\n          taskQueueDebug(\"TaskService.maybeStartQueuedTasks fork failed\", {\r\n            taskId,\r\n            error: forkResult.error,\r\n          });\r\n          continue;\r\n        }\r\n\r\n        runtimeForTaskWorkspace = createRuntime(forkedRuntimeConfig, {\r\n          projectPath: taskEntry.projectPath,\r\n          workspaceName,\r\n        });\r\n\r\n        trunkBranch = forkResult.success ? (forkResult.sourceBranch ?? trunkBranch) : trunkBranch;\r\n        const createResult: WorkspaceCreationResult = forkResult.success\r\n          ? { success: true as const, workspacePath: forkResult.workspacePath }\r\n          : await runtime.createWorkspace({\r\n              projectPath: taskEntry.projectPath,\r\n              branchName: workspaceName,\r\n              trunkBranch,\r\n              directoryName: workspaceName,\r\n              initLogger,\r\n            });\r\n\r\n        if (!createResult.success || !createResult.workspacePath) {\r\n          initLogger.logComplete(-1);\r\n          const errorMessage = createResult.error ?? \"unknown error\";\r\n          log.error(\"Failed to create queued task workspace\", { taskId, error: errorMessage });\r\n          taskQueueDebug(\"TaskService.maybeStartQueuedTasks createWorkspace failed\", {\r\n            taskId,\r\n            error: errorMessage,\r\n            forkSuccess: forkResult.success,\r\n          });\r\n          continue;\r\n        }\r\n\r\n        workspacePath = createResult.workspacePath;\r\n        workspaceExists = true;\r\n\r\n        taskQueueDebug(\"TaskService.maybeStartQueuedTasks workspace created\", {\r\n          taskId,\r\n          workspacePath,\r\n          forkSuccess: forkResult.success,\r\n          trunkBranch,\r\n        });\r\n\r\n        // Persist any corrected path/trunkBranch for restart-safe init.\r\n        await this.editWorkspaceEntry(\r\n          taskId,\r\n          (ws) => {\r\n            ws.path = workspacePath;\r\n            ws.taskTrunkBranch = trunkBranch;\r\n            ws.runtimeConfig = forkedRuntimeConfig;\r\n          },\r\n          { allowMissing: true }\r\n        );\r\n      }\r\n\r\n      // If init has not yet run for this workspace, start it now (best-effort, async).\r\n      // This is intentionally coupled to task start so queued tasks don't run init hooks\r\n      // Capture base commit for git-format-patch generation before the agent starts.\r\n      // This must reflect the *actual* workspace HEAD after creation/fork, not the parent's current HEAD\r\n      // (queued tasks can start much later).\r\n      if (!coerceNonEmptyString(task.taskBaseCommitSha)) {\r\n        const taskBaseCommitSha = await tryReadGitHeadCommitSha(\r\n          runtimeForTaskWorkspace,\r\n          workspacePath\r\n        );\r\n        if (taskBaseCommitSha) {\r\n          await this.editWorkspaceEntry(\r\n            taskId,\r\n            (ws) => {\r\n              ws.taskBaseCommitSha = taskBaseCommitSha;\r\n            },\r\n            { allowMissing: true }\r\n          );\r\n        }\r\n      }\r\n\r\n      // (SSH sync, .mux/init scripts, etc.) until they actually begin execution.\r\n      if (shouldRunInit) {\r\n        const initLogger = getInitLogger();\r\n        taskQueueDebug(\"TaskService.maybeStartQueuedTasks initWorkspace starting\", {\r\n          taskId,\r\n          workspacePath,\r\n          trunkBranch,\r\n        });\r\n        const secrets = secretsToRecord(this.config.getEffectiveSecrets(taskEntry.projectPath));\r\n        let skipInitHook = false;\r\n        const agentIdRaw = coerceNonEmptyString(task.agentId ?? task.agentType);\r\n        if (agentIdRaw) {\r\n          const parsedAgentId = AgentIdSchema.safeParse(agentIdRaw.trim().toLowerCase());\r\n          if (parsedAgentId.success) {\r\n            const isInPlace = taskEntry.projectPath === parentWorkspaceName;\r\n            const parentWorkspacePath =\r\n              coerceNonEmptyString(parentEntry.workspace.path) ??\r\n              (isInPlace\r\n                ? taskEntry.projectPath\r\n                : runtime.getWorkspacePath(taskEntry.projectPath, parentWorkspaceName));\r\n\r\n            try {\r\n              const frontmatter = await resolveAgentFrontmatter(\r\n                runtime,\r\n                parentWorkspacePath,\r\n                parsedAgentId.data\r\n              );\r\n              skipInitHook = frontmatter.subagent?.skip_init_hook === true;\r\n            } catch (error: unknown) {\r\n              log.debug(\"Queued task: failed to read agent definition for skip_init_hook\", {\r\n                taskId,\r\n                agentId: parsedAgentId.data,\r\n                error: error instanceof Error ? error.message : String(error),\r\n              });\r\n            }\r\n          }\r\n        }\r\n\r\n        runBackgroundInit(\r\n          runtimeForTaskWorkspace,\r\n          {\r\n            projectPath: taskEntry.projectPath,\r\n            branchName: workspaceName,\r\n            trunkBranch,\r\n            workspacePath,\r\n            initLogger,\r\n            env: secrets,\r\n            skipInitHook,\r\n          },\r\n          taskId\r\n        );\r\n      }\r\n\r\n      const model = task.taskModelString ?? defaultModel;\r\n      const queuedPrompt = coerceNonEmptyString(task.taskPrompt);\r\n      if (queuedPrompt) {\r\n        taskQueueDebug(\"TaskService.maybeStartQueuedTasks sendMessage starting (dequeue)\", {\r\n          taskId,\r\n          model,\r\n          promptLength: queuedPrompt.length,\r\n        });\r\n        const sendResult = await this.workspaceService.sendMessage(\r\n          taskId,\r\n          queuedPrompt,\r\n          {\r\n            model,\r\n            agentId: task.agentId ?? WORKSPACE_DEFAULTS.agentId,\r\n            thinkingLevel: task.taskThinkingLevel,\r\n            experiments: task.taskExperiments,\r\n          },\r\n          { allowQueuedAgentTask: true }\r\n        );\r\n        if (!sendResult.success) {\r\n          log.error(\"Failed to start queued task via sendMessage\", {\r\n            taskId,\r\n            error: sendResult.error,\r\n          });\r\n          continue;\r\n        }\r\n      } else {\r\n        // Backward compatibility: older queued tasks persisted their prompt in chat history.\r\n        taskQueueDebug(\"TaskService.maybeStartQueuedTasks resumeStream starting (legacy dequeue)\", {\r\n          taskId,\r\n          model,\r\n        });\r\n        const resumeResult = await this.workspaceService.resumeStream(\r\n          taskId,\r\n          {\r\n            model,\r\n            agentId: task.agentId ?? WORKSPACE_DEFAULTS.agentId,\r\n            thinkingLevel: task.taskThinkingLevel,\r\n            experiments: task.taskExperiments,\r\n          },\r\n          { allowQueuedAgentTask: true }\r\n        );\r\n\r\n        if (!resumeResult.success) {\r\n          log.error(\"Failed to start queued task\", { taskId, error: resumeResult.error });\r\n          taskQueueDebug(\"TaskService.maybeStartQueuedTasks resumeStream failed\", {\r\n            taskId,\r\n            error: resumeResult.error,\r\n          });\r\n          continue;\r\n        }\r\n      }\r\n\r\n      await this.setTaskStatus(taskId, \"running\");\r\n      taskQueueDebug(\"TaskService.maybeStartQueuedTasks started\", { taskId });\r\n    }\r\n  }\r\n\r\n  private async setTaskStatus(workspaceId: string, status: AgentTaskStatus): Promise<void> {\r\n    assert(workspaceId.length > 0, \"setTaskStatus: workspaceId must be non-empty\");\r\n\r\n    await this.editWorkspaceEntry(workspaceId, (ws) => {\r\n      ws.taskStatus = status;\r\n      if (status === \"running\") {\r\n        ws.taskPrompt = undefined;\r\n      }\r\n    });\r\n\r\n    await this.emitWorkspaceMetadata(workspaceId);\r\n\r\n    if (status === \"running\") {\r\n      const waiters = this.pendingStartWaitersByTaskId.get(workspaceId);\r\n      if (!waiters || waiters.length === 0) return;\r\n      this.pendingStartWaitersByTaskId.delete(workspaceId);\r\n      for (const waiter of waiters) {\r\n        try {\r\n          waiter.start();\r\n        } catch (error: unknown) {\r\n          log.error(\"Task start waiter callback failed\", { workspaceId, error });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /** Reset the auto-resume counter for a workspace (called when user sends a real message). */\r\n  resetAutoResumeCount(workspaceId: string): void {\r\n    this.consecutiveAutoResumes.delete(workspaceId);\r\n  }\r\n\r\n  private async handleStreamEnd(event: StreamEndEvent): Promise<void> {\r\n    const workspaceId = event.workspaceId;\r\n\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const entry = findWorkspaceEntry(cfg, workspaceId);\r\n    if (!entry) return;\r\n\r\n    // Parent workspaces must not end while they have active background tasks.\r\n    // Enforce by auto-resuming the stream with a directive to await outstanding tasks.\r\n    if (!entry.workspace.parentWorkspaceId) {\r\n      const hasActiveDescendants = this.hasActiveDescendantAgentTasks(cfg, workspaceId);\r\n      if (!hasActiveDescendants) {\r\n        return;\r\n      }\r\n\r\n      if (this.aiService.isStreaming(workspaceId)) {\r\n        return;\r\n      }\r\n\r\n      const activeTaskIds = this.listActiveDescendantAgentTaskIds(workspaceId);\r\n\r\n      // Check for auto-resume flood protection\r\n      const resumeCount = this.consecutiveAutoResumes.get(workspaceId) ?? 0;\r\n      if (resumeCount >= MAX_CONSECUTIVE_PARENT_AUTO_RESUMES) {\r\n        log.warn(\"Auto-resume limit reached for parent workspace with active descendants\", {\r\n          workspaceId,\r\n          resumeCount,\r\n          activeTaskIds,\r\n          limit: MAX_CONSECUTIVE_PARENT_AUTO_RESUMES,\r\n        });\r\n        return;\r\n      }\r\n      this.consecutiveAutoResumes.set(workspaceId, resumeCount + 1);\r\n\r\n      const parentAgentId = entry.workspace.agentId ?? WORKSPACE_DEFAULTS.agentId;\r\n      const parentAiSettings = this.resolveWorkspaceAISettings(entry.workspace, parentAgentId);\r\n      const model = parentAiSettings?.model ?? defaultModel;\r\n\r\n      const sendResult = await this.workspaceService.sendMessage(\r\n        workspaceId,\r\n        `You have active background sub-agent task(s) (${activeTaskIds.join(\", \")}). ` +\r\n          \"You MUST NOT end your turn while any sub-agent tasks are queued/running/awaiting_report. \" +\r\n          \"Call task_await now to wait for them to finish (omit timeout_secs to wait up to 10 minutes). \" +\r\n          \"If any tasks are still queued/running/awaiting_report after that, call task_await again. \" +\r\n          \"Only once all tasks are completed should you write your final response, integrating their reports.\",\r\n        {\r\n          model,\r\n          agentId: parentAgentId,\r\n          thinkingLevel: parentAiSettings?.thinkingLevel,\r\n        },\r\n        // Skip auto-resume counter reset  this IS an auto-resume, not a user message.\r\n        { skipAutoResumeReset: true, synthetic: true }\r\n      );\r\n      if (!sendResult.success) {\r\n        log.error(\"Failed to resume parent with active background tasks\", {\r\n          workspaceId,\r\n          error: sendResult.error,\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const status = entry.workspace.taskStatus;\r\n    if (status === \"reported\") return;\r\n\r\n    // Never allow a task to finish/report while it still has active descendant tasks.\r\n    // We'll auto-resume this task once the last descendant reports.\r\n    const hasActiveDescendants = this.hasActiveDescendantAgentTasks(cfg, workspaceId);\r\n    if (hasActiveDescendants) {\r\n      if (status === \"awaiting_report\") {\r\n        await this.setTaskStatus(workspaceId, \"running\");\r\n      }\r\n      return;\r\n    }\r\n\r\n    const reportArgs = this.findAgentReportArgsInParts(event.parts);\r\n    if (reportArgs) {\r\n      await this.finalizeAgentTaskReport(workspaceId, entry, reportArgs);\r\n      return;\r\n    }\r\n\r\n    // If a task stream ends without agent_report, request it once.\r\n    if (status === \"awaiting_report\" && this.remindedAwaitingReport.has(workspaceId)) {\r\n      await this.fallbackReportMissingAgentReport(entry);\r\n      return;\r\n    }\r\n\r\n    await this.setTaskStatus(workspaceId, \"awaiting_report\");\r\n\r\n    this.remindedAwaitingReport.add(workspaceId);\r\n\r\n    const model = entry.workspace.taskModelString ?? defaultModel;\r\n    await this.workspaceService.sendMessage(\r\n      workspaceId,\r\n      \"Your stream ended without calling agent_report. Call agent_report exactly once now with your final report.\",\r\n      {\r\n        model,\r\n        agentId: entry.workspace.agentId ?? WORKSPACE_DEFAULTS.agentId,\r\n        thinkingLevel: entry.workspace.taskThinkingLevel,\r\n        toolPolicy: [{ regex_match: \"^agent_report$\", action: \"require\" }],\r\n      },\r\n      { synthetic: true }\r\n    );\r\n  }\r\n\r\n  private async fallbackReportMissingAgentReport(entry: {\r\n    projectPath: string;\r\n    workspace: WorkspaceConfigEntry;\r\n  }): Promise<void> {\r\n    const childWorkspaceId = entry.workspace.id;\r\n    if (!childWorkspaceId) {\r\n      return;\r\n    }\r\n\r\n    const agentType = entry.workspace.agentType ?? \"agent\";\r\n    const lastText = await this.readLatestAssistantText(childWorkspaceId);\r\n\r\n    const reportMarkdown =\r\n      \"*(Note: this agent task did not call `agent_report`; \" +\r\n      \"posting its last assistant output as a fallback.)*\\n\\n\" +\r\n      (lastText?.trim().length ? lastText : \"(No assistant output found.)\");\r\n\r\n    await this.finalizeAgentTaskReport(childWorkspaceId, entry, {\r\n      reportMarkdown,\r\n      title: `Subagent (${agentType}) report (fallback)`,\r\n    });\r\n  }\r\n\r\n  private async readLatestAssistantText(workspaceId: string): Promise<string | null> {\r\n    const partial = await this.partialService.readPartial(workspaceId);\r\n    if (partial && partial.role === \"assistant\") {\r\n      const text = this.concatTextParts(partial).trim();\r\n      if (text.length > 0) return text;\r\n    }\r\n\r\n    // Only need recent messages to find last assistant text  avoid full-file read.\r\n    // getLastMessages returns messages in chronological order.\r\n    const historyResult = await this.historyService.getLastMessages(workspaceId, 20);\r\n    if (!historyResult.success) {\r\n      log.error(\"Failed to read history for fallback report\", {\r\n        workspaceId,\r\n        error: historyResult.error,\r\n      });\r\n      return null;\r\n    }\r\n\r\n    for (let i = historyResult.data.length - 1; i >= 0; i--) {\r\n      const msg = historyResult.data[i];\r\n      if (msg?.role !== \"assistant\") continue;\r\n      const text = this.concatTextParts(msg).trim();\r\n      if (text.length > 0) return text;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  private concatTextParts(msg: MuxMessage): string {\r\n    let combined = \"\";\r\n    for (const part of msg.parts) {\r\n      if (!part || typeof part !== \"object\") continue;\r\n      const maybeText = part as { type?: unknown; text?: unknown };\r\n      if (maybeText.type !== \"text\") continue;\r\n      if (typeof maybeText.text !== \"string\") continue;\r\n      combined += maybeText.text;\r\n    }\r\n    return combined;\r\n  }\r\n\r\n  private async handleAgentReport(event: ToolCallEndEvent): Promise<void> {\r\n    const childWorkspaceId = event.workspaceId;\r\n\r\n    if (!isSuccessfulToolResult(event.result)) {\r\n      return;\r\n    }\r\n\r\n    const cfgBeforeReport = this.config.loadConfigOrDefault();\r\n    const childEntryBeforeReport = findWorkspaceEntry(cfgBeforeReport, childWorkspaceId);\r\n    if (childEntryBeforeReport?.workspace.taskStatus === \"reported\") {\r\n      return;\r\n    }\r\n\r\n    if (this.hasActiveDescendantAgentTasks(cfgBeforeReport, childWorkspaceId)) {\r\n      log.error(\"agent_report called while task has active descendants; ignoring\", {\r\n        childWorkspaceId,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Read report payload from the tool-call input (persisted in partial/history).\r\n    const reportArgs = await this.readLatestAgentReportArgs(childWorkspaceId);\r\n    if (!reportArgs) {\r\n      log.error(\"agent_report tool-call args not found\", { childWorkspaceId });\r\n      return;\r\n    }\r\n\r\n    await this.finalizeAgentTaskReport(childWorkspaceId, childEntryBeforeReport, reportArgs, {\r\n      stopStream: true,\r\n    });\r\n  }\r\n\r\n  private async finalizeAgentTaskReport(\r\n    childWorkspaceId: string,\r\n    childEntry: { projectPath: string; workspace: WorkspaceConfigEntry } | null | undefined,\r\n    reportArgs: { reportMarkdown: string; title?: string },\r\n    options?: { stopStream?: boolean }\r\n  ): Promise<void> {\r\n    assert(\r\n      childWorkspaceId.length > 0,\r\n      \"finalizeAgentTaskReport: childWorkspaceId must be non-empty\"\r\n    );\r\n    assert(\r\n      typeof reportArgs.reportMarkdown === \"string\" && reportArgs.reportMarkdown.length > 0,\r\n      \"finalizeAgentTaskReport: reportMarkdown must be non-empty\"\r\n    );\r\n\r\n    const cfgBeforeReport = this.config.loadConfigOrDefault();\r\n    const statusBefore = findWorkspaceEntry(cfgBeforeReport, childWorkspaceId)?.workspace\r\n      .taskStatus;\r\n    if (statusBefore === \"reported\") {\r\n      return;\r\n    }\r\n\r\n    // Notify clients immediately even if we can't delete the workspace yet.\r\n    await this.editWorkspaceEntry(\r\n      childWorkspaceId,\r\n      (ws) => {\r\n        ws.taskStatus = \"reported\";\r\n        ws.reportedAt = getIsoNow();\r\n      },\r\n      { allowMissing: true }\r\n    );\r\n\r\n    await this.emitWorkspaceMetadata(childWorkspaceId);\r\n\r\n    if (options?.stopStream) {\r\n      // `agent_report` is terminal. Stop the child stream immediately to prevent any further token\r\n      // usage and to ensure parallelism accounting never \"frees\" a slot while the stream is still\r\n      // active (Claude/Anthropic can emit tool calls before the final assistant block completes).\r\n      //\r\n      // Important: Do NOT abandon the partial assistant message here. The in-flight assistant block\r\n      // contains the tool calls (including the agent_report tool call) that should be archived into\r\n      // chat.jsonl for transcript viewing after workspace cleanup.\r\n      try {\r\n        const stopResult = await this.aiService.stopStream(childWorkspaceId, {\r\n          abandonPartial: false,\r\n        });\r\n        if (!stopResult.success) {\r\n          log.debug(\"Failed to stop task stream after agent_report\", {\r\n            workspaceId: childWorkspaceId,\r\n            error: stopResult.error,\r\n          });\r\n        }\r\n      } catch (error: unknown) {\r\n        log.debug(\"Failed to stop task stream after agent_report (threw)\", {\r\n          workspaceId: childWorkspaceId,\r\n          error,\r\n        });\r\n      }\r\n\r\n      // stopStream() forwards stream-abort asynchronously (after partial cleanup). Workspace cleanup\r\n      // may archive/delete session files immediately after this method returns, so commit the partial\r\n      // synchronously here (best-effort) to ensure tool calls are present in the archived transcript.\r\n      try {\r\n        const commitResult = await this.partialService.commitToHistory(childWorkspaceId);\r\n        if (!commitResult.success) {\r\n          log.error(\"Failed to commit final partial to history after agent_report\", {\r\n            workspaceId: childWorkspaceId,\r\n            error: commitResult.error,\r\n          });\r\n        }\r\n      } catch (error: unknown) {\r\n        log.error(\"Failed to commit final partial to history after agent_report (threw)\", {\r\n          workspaceId: childWorkspaceId,\r\n          error,\r\n        });\r\n      }\r\n    }\r\n\r\n    const cfgAfterReport = this.config.loadConfigOrDefault();\r\n    const latestChildEntry = findWorkspaceEntry(cfgAfterReport, childWorkspaceId) ?? childEntry;\r\n    const parentWorkspaceId = latestChildEntry?.workspace.parentWorkspaceId;\r\n    if (!parentWorkspaceId) {\r\n      const reason = latestChildEntry\r\n        ? \"missing parentWorkspaceId\"\r\n        : \"workspace not found in config\";\r\n      log.debug(\"Ignoring agent_report: workspace is not an agent task\", {\r\n        childWorkspaceId,\r\n        reason,\r\n      });\r\n      // Best-effort: resolve any foreground waiters even if we can't deliver to a parent.\r\n      this.resolveWaiters(childWorkspaceId, reportArgs);\r\n      void this.maybeStartQueuedTasks();\r\n      return;\r\n    }\r\n\r\n    const parentById = this.buildAgentTaskIndex(cfgAfterReport).parentById;\r\n    const ancestorWorkspaceIds = this.listAncestorWorkspaceIdsUsingParentById(\r\n      parentById,\r\n      childWorkspaceId\r\n    );\r\n\r\n    // Persist the completed report in the session dirs of all ancestors so `task_await` can\r\n    // retrieve it after cleanup/restart (even if the task workspace itself is deleted).\r\n    const persistedAtMs = Date.now();\r\n    for (const ancestorWorkspaceId of ancestorWorkspaceIds) {\r\n      try {\r\n        const ancestorSessionDir = this.config.getSessionDir(ancestorWorkspaceId);\r\n        await upsertSubagentReportArtifact({\r\n          workspaceId: ancestorWorkspaceId,\r\n          workspaceSessionDir: ancestorSessionDir,\r\n          childTaskId: childWorkspaceId,\r\n          parentWorkspaceId,\r\n          ancestorWorkspaceIds,\r\n          reportMarkdown: reportArgs.reportMarkdown,\r\n          model: latestChildEntry?.workspace.taskModelString,\r\n          thinkingLevel: latestChildEntry?.workspace.taskThinkingLevel,\r\n          title: reportArgs.title,\r\n          nowMs: persistedAtMs,\r\n        });\r\n      } catch (error: unknown) {\r\n        log.error(\"Failed to persist subagent report artifact\", {\r\n          workspaceId: ancestorWorkspaceId,\r\n          childTaskId: childWorkspaceId,\r\n          error,\r\n        });\r\n      }\r\n    }\r\n\r\n    await this.deliverReportToParent(\r\n      parentWorkspaceId,\r\n      childWorkspaceId,\r\n      latestChildEntry,\r\n      reportArgs\r\n    );\r\n\r\n    // Begin git-format-patch generation (best-effort).\r\n    //\r\n    // This must run before cleanup so the reported task workspace isn't deleted while we're still\r\n    // reading commits from it.\r\n    //\r\n    // It must also run before resolving waiters so an immediate `task_await` result after\r\n    // `agent_report` can include at least a pending artifact record.\r\n    try {\r\n      await this.gitPatchArtifactService.maybeStartGeneration(\r\n        parentWorkspaceId,\r\n        childWorkspaceId,\r\n        (wsId) => this.cleanupReportedLeafTask(wsId)\r\n      );\r\n    } catch (error: unknown) {\r\n      log.error(\"Failed to start subagent git patch generation\", {\r\n        parentWorkspaceId,\r\n        childWorkspaceId,\r\n        error,\r\n      });\r\n    }\r\n\r\n    // Resolve foreground waiters.\r\n    this.resolveWaiters(childWorkspaceId, reportArgs);\r\n\r\n    // Free slot and start queued tasks.\r\n    await this.maybeStartQueuedTasks();\r\n\r\n    // Attempt cleanup of reported tasks (leaf-first).\r\n    await this.cleanupReportedLeafTask(childWorkspaceId);\r\n\r\n    // Auto-resume any parent stream that was waiting on a task tool call (restart-safe).\r\n    const postCfg = this.config.loadConfigOrDefault();\r\n    if (!findWorkspaceEntry(postCfg, parentWorkspaceId)) {\r\n      // Parent may have been cleaned up (e.g. it already reported and this was its last descendant).\r\n      return;\r\n    }\r\n    const hasActiveDescendants = this.hasActiveDescendantAgentTasks(postCfg, parentWorkspaceId);\r\n    if (!hasActiveDescendants) {\r\n      this.consecutiveAutoResumes.delete(parentWorkspaceId);\r\n    }\r\n    if (!hasActiveDescendants && !this.aiService.isStreaming(parentWorkspaceId)) {\r\n      const sendResult = await this.workspaceService.sendMessage(\r\n        parentWorkspaceId,\r\n        \"Your background sub-agent task(s) have completed. Use task_await to retrieve their reports and integrate the results.\",\r\n        {\r\n          model: latestChildEntry?.workspace.taskModelString ?? defaultModel,\r\n          agentId: WORKSPACE_DEFAULTS.agentId,\r\n        },\r\n        // Skip auto-resume counter reset  this IS an auto-resume, not a user message.\r\n        { skipAutoResumeReset: true, synthetic: true }\r\n      );\r\n      if (!sendResult.success) {\r\n        log.error(\"Failed to auto-resume parent after agent_report\", {\r\n          parentWorkspaceId,\r\n          error: sendResult.error,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  private enforceCompletedReportCacheLimit(): void {\r\n    while (this.completedReportsByTaskId.size > COMPLETED_REPORT_CACHE_MAX_ENTRIES) {\r\n      const first = this.completedReportsByTaskId.keys().next();\r\n      if (first.done) break;\r\n      this.completedReportsByTaskId.delete(first.value);\r\n    }\r\n  }\r\n\r\n  private resolveWaiters(taskId: string, report: { reportMarkdown: string; title?: string }): void {\r\n    const cfg = this.config.loadConfigOrDefault();\r\n    const parentById = this.buildAgentTaskIndex(cfg).parentById;\r\n    const ancestorWorkspaceIds = this.listAncestorWorkspaceIdsUsingParentById(parentById, taskId);\r\n\r\n    this.completedReportsByTaskId.set(taskId, {\r\n      reportMarkdown: report.reportMarkdown,\r\n      title: report.title,\r\n      ancestorWorkspaceIds,\r\n    });\r\n    this.enforceCompletedReportCacheLimit();\r\n\r\n    const waiters = this.pendingWaitersByTaskId.get(taskId);\r\n    if (!waiters || waiters.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.pendingWaitersByTaskId.delete(taskId);\r\n    for (const waiter of waiters) {\r\n      try {\r\n        waiter.cleanup();\r\n        waiter.resolve(report);\r\n      } catch {\r\n        // ignore\r\n      }\r\n    }\r\n  }\r\n\r\n  private rejectWaiters(taskId: string, error: Error): void {\r\n    const waiters = this.pendingWaitersByTaskId.get(taskId);\r\n    if (!waiters || waiters.length === 0) {\r\n      return;\r\n    }\r\n\r\n    for (const waiter of [...waiters]) {\r\n      try {\r\n        waiter.reject(error);\r\n      } catch (rejectError: unknown) {\r\n        log.error(\"Task waiter reject callback failed\", { taskId, error: rejectError });\r\n      }\r\n    }\r\n  }\r\n\r\n  private async readLatestAgentReportArgs(\r\n    workspaceId: string\r\n  ): Promise<{ reportMarkdown: string; title?: string } | null> {\r\n    const partial = await this.partialService.readPartial(workspaceId);\r\n    if (partial) {\r\n      const args = this.findAgentReportArgsInMessage(partial);\r\n      if (args) return args;\r\n    }\r\n\r\n    // Only need recent messages to find agent_report  avoid full-file read.\r\n    // getLastMessages returns chronological order; scan in reverse for newest-first.\r\n    const historyResult = await this.historyService.getLastMessages(workspaceId, 20);\r\n    if (!historyResult.success) {\r\n      log.error(\"Failed to read history for agent_report args\", {\r\n        workspaceId,\r\n        error: historyResult.error,\r\n      });\r\n      return null;\r\n    }\r\n\r\n    for (let i = historyResult.data.length - 1; i >= 0; i--) {\r\n      const args = this.findAgentReportArgsInMessage(historyResult.data[i]);\r\n      if (args) return args;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  private findAgentReportArgsInParts(\r\n    parts: readonly unknown[]\r\n  ): { reportMarkdown: string; title?: string } | null {\r\n    for (let i = parts.length - 1; i >= 0; i--) {\r\n      const part = parts[i];\r\n      if (!isDynamicToolPart(part)) continue;\r\n      if (part.toolName !== \"agent_report\") continue;\r\n      if (part.state !== \"output-available\") continue;\r\n      if (!isSuccessfulToolResult(part.output)) continue;\r\n      const parsed = AgentReportToolArgsSchema.safeParse(part.input);\r\n      if (!parsed.success) continue;\r\n      // Normalize null  undefined at the schema boundary so downstream\r\n      // code that expects `title?: string` doesn't need to handle null.\r\n      return { reportMarkdown: parsed.data.reportMarkdown, title: parsed.data.title ?? undefined };\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private findAgentReportArgsInMessage(\r\n    msg: MuxMessage\r\n  ): { reportMarkdown: string; title?: string } | null {\r\n    return this.findAgentReportArgsInParts(msg.parts);\r\n  }\r\n\r\n  private async deliverReportToParent(\r\n    parentWorkspaceId: string,\r\n    childWorkspaceId: string,\r\n    childEntry: { projectPath: string; workspace: WorkspaceConfigEntry } | null | undefined,\r\n    report: { reportMarkdown: string; title?: string }\r\n  ): Promise<void> {\r\n    assert(\r\n      childWorkspaceId.length > 0,\r\n      \"deliverReportToParent: childWorkspaceId must be non-empty\"\r\n    );\r\n\r\n    const agentType = childEntry?.workspace.agentType ?? \"agent\";\r\n\r\n    const output = {\r\n      status: \"completed\" as const,\r\n      taskId: childWorkspaceId,\r\n      reportMarkdown: report.reportMarkdown,\r\n      title: report.title,\r\n      agentType,\r\n    };\r\n    const parsedOutput = TaskToolResultSchema.safeParse(output);\r\n    if (!parsedOutput.success) {\r\n      log.error(\"Task tool output schema validation failed\", { error: parsedOutput.error.message });\r\n      return;\r\n    }\r\n\r\n    // If someone is actively awaiting this report (foreground task tool call or task_await),\r\n    // skip injecting a synthetic history message to avoid duplicating the report in context.\r\n    if (childWorkspaceId) {\r\n      const waiters = this.pendingWaitersByTaskId.get(childWorkspaceId);\r\n      if (waiters && waiters.length > 0) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Restart-safe: if the parent has a pending task tool call in partial.json (interrupted stream),\r\n    // finalize it with the report. Avoid rewriting persisted history to keep earlier messages immutable.\r\n    if (!this.aiService.isStreaming(parentWorkspaceId)) {\r\n      const finalizedPending = await this.tryFinalizePendingTaskToolCallInPartial(\r\n        parentWorkspaceId,\r\n        parsedOutput.data\r\n      );\r\n      if (finalizedPending) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Background tasks: append a synthetic user message containing the report so earlier history\r\n    // remains immutable (append-only) and prompt caches can still reuse the prefix.\r\n    const titlePrefix = report.title ?? `Subagent (${agentType}) report`;\r\n    const xml = [\r\n      \"<mux_subagent_report>\",\r\n      `<task_id>${childWorkspaceId}</task_id>`,\r\n      `<agent_type>${agentType}</agent_type>`,\r\n      `<title>${titlePrefix}</title>`,\r\n      \"<report_markdown>\",\r\n      report.reportMarkdown,\r\n      \"</report_markdown>\",\r\n      \"</mux_subagent_report>\",\r\n    ].join(\"\\n\");\r\n\r\n    const messageId = createTaskReportMessageId();\r\n    const reportMessage = createMuxMessage(messageId, \"user\", xml, {\r\n      timestamp: Date.now(),\r\n      synthetic: true,\r\n    });\r\n\r\n    const appendResult = await this.historyService.appendToHistory(\r\n      parentWorkspaceId,\r\n      reportMessage\r\n    );\r\n    if (!appendResult.success) {\r\n      log.error(\"Failed to append synthetic subagent report to parent history\", {\r\n        parentWorkspaceId,\r\n        error: appendResult.error,\r\n      });\r\n    }\r\n  }\r\n\r\n  private async tryFinalizePendingTaskToolCallInPartial(\r\n    workspaceId: string,\r\n    output: unknown\r\n  ): Promise<boolean> {\r\n    const parsedOutput = TaskToolResultSchema.safeParse(output);\r\n    if (!parsedOutput.success || parsedOutput.data.status !== \"completed\") {\r\n      log.error(\"tryFinalizePendingTaskToolCallInPartial: invalid output\", {\r\n        error: parsedOutput.success ? \"status is not 'completed'\" : parsedOutput.error.message,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    const partial = await this.partialService.readPartial(workspaceId);\r\n    if (!partial) {\r\n      return false;\r\n    }\r\n\r\n    type PendingTaskToolPart = DynamicToolPart & { toolName: \"task\"; state: \"input-available\" };\r\n    const pendingParts = partial.parts.filter(\r\n      (p): p is PendingTaskToolPart =>\r\n        isDynamicToolPart(p) && p.toolName === \"task\" && p.state === \"input-available\"\r\n    );\r\n\r\n    if (pendingParts.length === 0) {\r\n      return false;\r\n    }\r\n    if (pendingParts.length > 1) {\r\n      log.error(\"tryFinalizePendingTaskToolCallInPartial: multiple pending task tool calls\", {\r\n        workspaceId,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    const toolCallId = pendingParts[0].toolCallId;\r\n\r\n    const parsedInput = TaskToolArgsSchema.safeParse(pendingParts[0].input);\r\n    if (!parsedInput.success) {\r\n      log.error(\"tryFinalizePendingTaskToolCallInPartial: task input validation failed\", {\r\n        workspaceId,\r\n        error: parsedInput.error.message,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    const updated: MuxMessage = {\r\n      ...partial,\r\n      parts: partial.parts.map((part) => {\r\n        if (!isDynamicToolPart(part)) return part;\r\n        if (part.toolCallId !== toolCallId) return part;\r\n        if (part.toolName !== \"task\") return part;\r\n        if (part.state === \"output-available\") return part;\r\n        return { ...part, state: \"output-available\" as const, output: parsedOutput.data };\r\n      }),\r\n    };\r\n\r\n    const writeResult = await this.partialService.writePartial(workspaceId, updated);\r\n    if (!writeResult.success) {\r\n      log.error(\"Failed to write finalized task tool output to partial\", {\r\n        workspaceId,\r\n        error: writeResult.error,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    this.workspaceService.emit(\"chat\", {\r\n      workspaceId,\r\n      message: {\r\n        type: \"tool-call-end\",\r\n        workspaceId,\r\n        messageId: updated.id,\r\n        toolCallId,\r\n        toolName: \"task\",\r\n        result: parsedOutput.data,\r\n        timestamp: Date.now(),\r\n      },\r\n    });\r\n\r\n    return true;\r\n  }\r\n\r\n  private async cleanupReportedLeafTask(workspaceId: string): Promise<void> {\r\n    assert(workspaceId.length > 0, \"cleanupReportedLeafTask: workspaceId must be non-empty\");\r\n\r\n    let currentWorkspaceId = workspaceId;\r\n    const visited = new Set<string>();\r\n    for (let depth = 0; depth < 32; depth++) {\r\n      if (visited.has(currentWorkspaceId)) {\r\n        log.error(\"cleanupReportedLeafTask: possible parentWorkspaceId cycle\", {\r\n          workspaceId: currentWorkspaceId,\r\n        });\r\n        return;\r\n      }\r\n      visited.add(currentWorkspaceId);\r\n\r\n      const config = this.config.loadConfigOrDefault();\r\n      const entry = findWorkspaceEntry(config, currentWorkspaceId);\r\n      if (!entry) return;\r\n\r\n      const ws = entry.workspace;\r\n      const parentWorkspaceId = ws.parentWorkspaceId;\r\n      if (!parentWorkspaceId) return;\r\n      if (ws.taskStatus !== \"reported\") return;\r\n\r\n      const hasChildren = this.listAgentTaskWorkspaces(config).some(\r\n        (t) => t.parentWorkspaceId === currentWorkspaceId\r\n      );\r\n      const parentSessionDir = this.config.getSessionDir(parentWorkspaceId);\r\n      const patchArtifact = await readSubagentGitPatchArtifact(\r\n        parentSessionDir,\r\n        currentWorkspaceId\r\n      );\r\n      if (patchArtifact?.status === \"pending\") {\r\n        log.debug(\"cleanupReportedLeafTask: deferring auto-delete; patch artifact pending\", {\r\n          workspaceId: currentWorkspaceId,\r\n          parentWorkspaceId,\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (hasChildren) return;\r\n\r\n      const removeResult = await this.workspaceService.remove(currentWorkspaceId, true);\r\n      if (!removeResult.success) {\r\n        log.error(\"Failed to auto-delete reported task workspace\", {\r\n          workspaceId: currentWorkspaceId,\r\n          error: removeResult.error,\r\n        });\r\n        return;\r\n      }\r\n\r\n      currentWorkspaceId = parentWorkspaceId;\r\n    }\r\n\r\n    log.error(\"cleanupReportedLeafTask: exceeded max parent traversal depth\", {\r\n      workspaceId,\r\n    });\r\n  }\r\n}\r\n"]}