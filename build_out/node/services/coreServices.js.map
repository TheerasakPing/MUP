{"version":3,"file":"coreServices.js","sourceRoot":"","sources":["../../../src/node/services/coreServices.ts"],"names":[],"mappings":";AAAA;;GAEG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,MAAY,EAAE,+BAAW;AACzB,MAAY,IAAI,iCAAa;AAE7B,mEAAgE;AAChE,mEAAgE;AAChE,uEAAoE;AACpE,qEAAkE;AAClE,yDAAsD;AACtD,uFAAoF;AACpF,6EAA0E;AAC1E,6EAA0E;AAC1E,uEAAoE;AACpE,uEAAkG;AAClG,uFAAoF;AACpF,uEAAoE;AACpE,6DAA0D;AAqC1D,4BAAmC,IAAyB,EAAgB;IAC1E,MAAM,EAAE,MAAM,EAAE,qBAAqB,EAAE,GAAG,IAAI,CAAC;IAE/C,MAAM,cAAc,GAAG,IAAI,+BAAc,CAAC,MAAM,CAAC,CAAC;IAClD,MAAM,cAAc,GAAG,IAAI,+BAAc,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;IAClE,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAAC,MAAM,CAAC,CAAC;IACtD,MAAM,eAAe,GAAG,IAAI,iCAAe,CAAC,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;IACxE,MAAM,wBAAwB,GAAG,IAAI,mDAAwB,CAC3D,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,YAAY,CAAC,CACrC,CAAC;IACF,MAAM,mBAAmB,GAAG,IAAI,yCAAmB,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;IAC5E,MAAM,mBAAmB,GAAG,IAAI,yCAAmB,CAAC,MAAM,CAAC,CAAC;IAE5D,MAAM,SAAS,GAAG,IAAI,qBAAS,CAC7B,MAAM,EACN,cAAc,EACd,cAAc,EACd,gBAAgB,EAChB,eAAe,EACf,wBAAwB,EACxB,mBAAmB,EACnB,IAAI,CAAC,4BAA4B,EACjC,IAAI,CAAC,aAAa,EAClB,IAAI,CAAC,gBAAgB,CACtB,CAAC;IAEF,0EAA0E;IAC1E,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAAC,IAAI,CAAC,SAAS,IAAI,MAAM,CAAC,CAAC;IACxE,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAC3C,gBAAgB,EAChB,IAAI,CAAC,uBAAuB,EAC5B,IAAI,CAAC,aAAa,CACnB,CAAC;IACF,SAAS,CAAC,mBAAmB,CAAC,gBAAgB,CAAC,CAAC;IAEhD,MAAM,iBAAiB,GAAG,IAAI,mDAAwB,CAAC,qBAAqB,CAAC,CAAC;IAE9E,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAC3C,MAAM,EACN,cAAc,EACd,cAAc,EACd,SAAS,EACT,gBAAgB,EAChB,iBAAiB,EACjB,wBAAwB,EACxB,mBAAmB,EACnB,mBAAmB,EACnB,IAAI,CAAC,aAAa,EAClB,IAAI,CAAC,gBAAgB,EACrB,IAAI,CAAC,kBAAkB,EACvB,IAAI,CAAC,oBAAoB,CAC1B,CAAC;IACF,gBAAgB,CAAC,mBAAmB,CAAC,gBAAgB,CAAC,CAAC;IAEvD,MAAM,WAAW,GAAG,IAAI,yBAAW,CACjC,MAAM,EACN,cAAc,EACd,cAAc,EACd,SAAS,EACT,gBAAgB,EAChB,gBAAgB,CACjB,CAAC;IACF,SAAS,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;IACtC,gBAAgB,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;IAE7C,OAAO;QACL,cAAc;QACd,cAAc;QACd,gBAAgB;QAChB,eAAe;QACf,wBAAwB;QACxB,mBAAmB;QACnB,SAAS;QACT,gBAAgB;QAChB,gBAAgB;QAChB,iBAAiB;QACjB,gBAAgB;QAChB,WAAW;QACX,mBAAmB;KACpB,CAAC;AAAA,CACH","sourcesContent":["/**\r\n * Core service graph shared by `mux run` (CLI) and `ServiceContainer` (desktop).\r\n */\r\n\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { HistoryService } from \"@/node/services/historyService\";\r\nimport { PartialService } from \"@/node/services/partialService\";\r\nimport { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport { ProviderService } from \"@/node/services/providerService\";\r\nimport { AIService } from \"@/node/services/aiService\";\r\nimport { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport { SessionUsageService } from \"@/node/services/sessionUsageService\";\r\nimport { CostTrackingService } from \"@/node/services/costTrackingService\";\r\nimport { MCPConfigService } from \"@/node/services/mcpConfigService\";\r\nimport { MCPServerManager, type MCPServerManagerOptions } from \"@/node/services/mcpServerManager\";\r\nimport { ExtensionMetadataService } from \"@/node/services/ExtensionMetadataService\";\r\nimport { WorkspaceService } from \"@/node/services/workspaceService\";\r\nimport { TaskService } from \"@/node/services/taskService\";\r\nimport type { WorkspaceMcpOverridesService } from \"@/node/services/workspaceMcpOverridesService\";\r\nimport type { PolicyService } from \"@/node/services/policyService\";\r\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\r\nimport type { ExperimentsService } from \"@/node/services/experimentsService\";\r\nimport type { SessionTimingService } from \"@/node/services/sessionTimingService\";\r\n\r\nexport interface CoreServicesOptions {\r\n  config: Config;\r\n  extensionMetadataPath: string;\r\n  /** Overrides config for MCPConfigService; CLI passes its persistent realConfig. */\r\n  mcpConfig?: Config;\r\n  mcpServerManagerOptions?: MCPServerManagerOptions;\r\n  workspaceMcpOverridesService?: WorkspaceMcpOverridesService;\r\n  /** Optional cross-cutting services (desktop creates before core services). */\r\n  policyService?: PolicyService;\r\n  telemetryService?: TelemetryService;\r\n  experimentsService?: ExperimentsService;\r\n  sessionTimingService?: SessionTimingService;\r\n}\r\n\r\nexport interface CoreServices {\r\n  historyService: HistoryService;\r\n  partialService: PartialService;\r\n  initStateManager: InitStateManager;\r\n  providerService: ProviderService;\r\n  backgroundProcessManager: BackgroundProcessManager;\r\n  sessionUsageService: SessionUsageService;\r\n  aiService: AIService;\r\n  mcpConfigService: MCPConfigService;\r\n  mcpServerManager: MCPServerManager;\r\n  extensionMetadata: ExtensionMetadataService;\r\n  workspaceService: WorkspaceService;\r\n  taskService: TaskService;\r\n  costTrackingService: CostTrackingService;\r\n}\r\n\r\nexport function createCoreServices(opts: CoreServicesOptions): CoreServices {\r\n  const { config, extensionMetadataPath } = opts;\r\n\r\n  const historyService = new HistoryService(config);\r\n  const partialService = new PartialService(config, historyService);\r\n  const initStateManager = new InitStateManager(config);\r\n  const providerService = new ProviderService(config, opts.policyService);\r\n  const backgroundProcessManager = new BackgroundProcessManager(\r\n    path.join(os.tmpdir(), \"mux-bashes\")\r\n  );\r\n  const sessionUsageService = new SessionUsageService(config, historyService);\r\n  const costTrackingService = new CostTrackingService(config);\r\n\r\n  const aiService = new AIService(\r\n    config,\r\n    historyService,\r\n    partialService,\r\n    initStateManager,\r\n    providerService,\r\n    backgroundProcessManager,\r\n    sessionUsageService,\r\n    opts.workspaceMcpOverridesService,\r\n    opts.policyService,\r\n    opts.telemetryService\r\n  );\r\n\r\n  // MCP: allow callers to override which Config provides server definitions\r\n  const mcpConfigService = new MCPConfigService(opts.mcpConfig ?? config);\r\n  const mcpServerManager = new MCPServerManager(\r\n    mcpConfigService,\r\n    opts.mcpServerManagerOptions,\r\n    opts.policyService\r\n  );\r\n  aiService.setMCPServerManager(mcpServerManager);\r\n\r\n  const extensionMetadata = new ExtensionMetadataService(extensionMetadataPath);\r\n\r\n  const workspaceService = new WorkspaceService(\r\n    config,\r\n    historyService,\r\n    partialService,\r\n    aiService,\r\n    initStateManager,\r\n    extensionMetadata,\r\n    backgroundProcessManager,\r\n    sessionUsageService,\r\n    costTrackingService,\r\n    opts.policyService,\r\n    opts.telemetryService,\r\n    opts.experimentsService,\r\n    opts.sessionTimingService\r\n  );\r\n  workspaceService.setMCPServerManager(mcpServerManager);\r\n\r\n  const taskService = new TaskService(\r\n    config,\r\n    historyService,\r\n    partialService,\r\n    aiService,\r\n    workspaceService,\r\n    initStateManager\r\n  );\r\n  aiService.setTaskService(taskService);\r\n  workspaceService.setTaskService(taskService);\r\n\r\n  return {\r\n    historyService,\r\n    partialService,\r\n    initStateManager,\r\n    providerService,\r\n    backgroundProcessManager,\r\n    sessionUsageService,\r\n    aiService,\r\n    mcpConfigService,\r\n    mcpServerManager,\r\n    extensionMetadata,\r\n    workspaceService,\r\n    taskService,\r\n    costTrackingService,\r\n  };\r\n}\r\n"]}