{"version":3,"file":"coreServices.js","sourceRoot":"","sources":["../../../src/node/services/coreServices.ts"],"names":[],"mappings":";AAAA;;GAEG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,MAAY,EAAE,+BAAW;AACzB,MAAY,IAAI,iCAAa;AAE7B,mEAAgE;AAChE,mEAAgE;AAChE,uEAAoE;AACpE,qEAAkE;AAClE,yDAAsD;AACtD,uFAAoF;AACpF,6EAA0E;AAC1E,6EAA0E;AAC1E,uEAAoE;AACpE,uEAAkG;AAClG,uFAAoF;AACpF,uEAAoE;AACpE,6DAA0D;AAqC1D,4BAAmC,IAAyB,EAAgB;IAC1E,MAAM,EAAE,MAAM,EAAE,qBAAqB,EAAE,GAAG,IAAI,CAAC;IAE/C,MAAM,cAAc,GAAG,IAAI,+BAAc,CAAC,MAAM,CAAC,CAAC;IAClD,MAAM,cAAc,GAAG,IAAI,+BAAc,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;IAClE,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAAC,MAAM,CAAC,CAAC;IACtD,MAAM,eAAe,GAAG,IAAI,iCAAe,CAAC,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;IACxE,MAAM,wBAAwB,GAAG,IAAI,mDAAwB,CAC3D,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,YAAY,CAAC,CACrC,CAAC;IACF,MAAM,mBAAmB,GAAG,IAAI,yCAAmB,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;IAC5E,MAAM,mBAAmB,GAAG,IAAI,yCAAmB,CAAC,MAAM,CAAC,CAAC;IAE5D,MAAM,SAAS,GAAG,IAAI,qBAAS,CAC7B,MAAM,EACN,cAAc,EACd,cAAc,EACd,gBAAgB,EAChB,eAAe,EACf,wBAAwB,EACxB,mBAAmB,EACnB,IAAI,CAAC,4BAA4B,EACjC,IAAI,CAAC,aAAa,EAClB,IAAI,CAAC,gBAAgB,CACtB,CAAC;IAEF,0EAA0E;IAC1E,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAAC,IAAI,CAAC,SAAS,IAAI,MAAM,CAAC,CAAC;IACxE,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAC3C,gBAAgB,EAChB,IAAI,CAAC,uBAAuB,EAC5B,IAAI,CAAC,aAAa,CACnB,CAAC;IACF,SAAS,CAAC,mBAAmB,CAAC,gBAAgB,CAAC,CAAC;IAEhD,MAAM,iBAAiB,GAAG,IAAI,mDAAwB,CAAC,qBAAqB,CAAC,CAAC;IAE9E,MAAM,gBAAgB,GAAG,IAAI,mCAAgB,CAC3C,MAAM,EACN,cAAc,EACd,cAAc,EACd,SAAS,EACT,gBAAgB,EAChB,iBAAiB,EACjB,wBAAwB,EACxB,mBAAmB,EACnB,mBAAmB,EACnB,IAAI,CAAC,aAAa,EAClB,IAAI,CAAC,gBAAgB,EACrB,IAAI,CAAC,kBAAkB,EACvB,IAAI,CAAC,oBAAoB,CAC1B,CAAC;IACF,gBAAgB,CAAC,mBAAmB,CAAC,gBAAgB,CAAC,CAAC;IAEvD,MAAM,WAAW,GAAG,IAAI,yBAAW,CACjC,MAAM,EACN,cAAc,EACd,cAAc,EACd,SAAS,EACT,gBAAgB,EAChB,gBAAgB,CACjB,CAAC;IACF,SAAS,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;IACtC,gBAAgB,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;IAE7C,OAAO;QACL,cAAc;QACd,cAAc;QACd,gBAAgB;QAChB,eAAe;QACf,wBAAwB;QACxB,mBAAmB;QACnB,SAAS;QACT,gBAAgB;QAChB,gBAAgB;QAChB,iBAAiB;QACjB,gBAAgB;QAChB,WAAW;QACX,mBAAmB;KACpB,CAAC;AAAA,CACH","sourcesContent":["/**\n * Core service graph shared by `mux run` (CLI) and `ServiceContainer` (desktop).\n */\n\nimport * as os from \"os\";\nimport * as path from \"path\";\nimport type { Config } from \"@/node/config\";\nimport { HistoryService } from \"@/node/services/historyService\";\nimport { PartialService } from \"@/node/services/partialService\";\nimport { InitStateManager } from \"@/node/services/initStateManager\";\nimport { ProviderService } from \"@/node/services/providerService\";\nimport { AIService } from \"@/node/services/aiService\";\nimport { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\nimport { SessionUsageService } from \"@/node/services/sessionUsageService\";\nimport { CostTrackingService } from \"@/node/services/costTrackingService\";\nimport { MCPConfigService } from \"@/node/services/mcpConfigService\";\nimport { MCPServerManager, type MCPServerManagerOptions } from \"@/node/services/mcpServerManager\";\nimport { ExtensionMetadataService } from \"@/node/services/ExtensionMetadataService\";\nimport { WorkspaceService } from \"@/node/services/workspaceService\";\nimport { TaskService } from \"@/node/services/taskService\";\nimport type { WorkspaceMcpOverridesService } from \"@/node/services/workspaceMcpOverridesService\";\nimport type { PolicyService } from \"@/node/services/policyService\";\nimport type { TelemetryService } from \"@/node/services/telemetryService\";\nimport type { ExperimentsService } from \"@/node/services/experimentsService\";\nimport type { SessionTimingService } from \"@/node/services/sessionTimingService\";\n\nexport interface CoreServicesOptions {\n  config: Config;\n  extensionMetadataPath: string;\n  /** Overrides config for MCPConfigService; CLI passes its persistent realConfig. */\n  mcpConfig?: Config;\n  mcpServerManagerOptions?: MCPServerManagerOptions;\n  workspaceMcpOverridesService?: WorkspaceMcpOverridesService;\n  /** Optional cross-cutting services (desktop creates before core services). */\n  policyService?: PolicyService;\n  telemetryService?: TelemetryService;\n  experimentsService?: ExperimentsService;\n  sessionTimingService?: SessionTimingService;\n}\n\nexport interface CoreServices {\n  historyService: HistoryService;\n  partialService: PartialService;\n  initStateManager: InitStateManager;\n  providerService: ProviderService;\n  backgroundProcessManager: BackgroundProcessManager;\n  sessionUsageService: SessionUsageService;\n  aiService: AIService;\n  mcpConfigService: MCPConfigService;\n  mcpServerManager: MCPServerManager;\n  extensionMetadata: ExtensionMetadataService;\n  workspaceService: WorkspaceService;\n  taskService: TaskService;\n  costTrackingService: CostTrackingService;\n}\n\nexport function createCoreServices(opts: CoreServicesOptions): CoreServices {\n  const { config, extensionMetadataPath } = opts;\n\n  const historyService = new HistoryService(config);\n  const partialService = new PartialService(config, historyService);\n  const initStateManager = new InitStateManager(config);\n  const providerService = new ProviderService(config, opts.policyService);\n  const backgroundProcessManager = new BackgroundProcessManager(\n    path.join(os.tmpdir(), \"mux-bashes\")\n  );\n  const sessionUsageService = new SessionUsageService(config, historyService);\n  const costTrackingService = new CostTrackingService(config);\n\n  const aiService = new AIService(\n    config,\n    historyService,\n    partialService,\n    initStateManager,\n    providerService,\n    backgroundProcessManager,\n    sessionUsageService,\n    opts.workspaceMcpOverridesService,\n    opts.policyService,\n    opts.telemetryService\n  );\n\n  // MCP: allow callers to override which Config provides server definitions\n  const mcpConfigService = new MCPConfigService(opts.mcpConfig ?? config);\n  const mcpServerManager = new MCPServerManager(\n    mcpConfigService,\n    opts.mcpServerManagerOptions,\n    opts.policyService\n  );\n  aiService.setMCPServerManager(mcpServerManager);\n\n  const extensionMetadata = new ExtensionMetadataService(extensionMetadataPath);\n\n  const workspaceService = new WorkspaceService(\n    config,\n    historyService,\n    partialService,\n    aiService,\n    initStateManager,\n    extensionMetadata,\n    backgroundProcessManager,\n    sessionUsageService,\n    costTrackingService,\n    opts.policyService,\n    opts.telemetryService,\n    opts.experimentsService,\n    opts.sessionTimingService\n  );\n  workspaceService.setMCPServerManager(mcpServerManager);\n\n  const taskService = new TaskService(\n    config,\n    historyService,\n    partialService,\n    aiService,\n    workspaceService,\n    initStateManager\n  );\n  aiService.setTaskService(taskService);\n  workspaceService.setTaskService(taskService);\n\n  return {\n    historyService,\n    partialService,\n    initStateManager,\n    providerService,\n    backgroundProcessManager,\n    sessionUsageService,\n    aiService,\n    mcpConfigService,\n    mcpServerManager,\n    extensionMetadata,\n    workspaceService,\n    taskService,\n    costTrackingService,\n  };\n}\n"]}