{"version":3,"file":"tokenizerService.test.js","sourceRoot":"","sources":["../../../src/node/services/tokenizerService.test.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAqE;AACrE,yDAAsD;AAEtD,MAAY,cAAc,wDAAoC;AAC9D,MAAY,UAAU,uEAAmD;AACzE,oDAA0D;AAE1D,IAAA,mBAAQ,EAAC,kBAAkB,EAAE,GAAG,EAAE,CAAC;IACjC,IAAI,mBAAwC,CAAC;IAC7C,IAAI,OAAyB,CAAC;IAE9B,IAAA,qBAAU,EAAC,GAAG,EAAE,CAAC;QACf,mBAAmB,GAAG;YACpB,kBAAkB,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE;SACV,CAAC;QACpC,OAAO,GAAG,IAAI,mCAAgB,CAAC,mBAAmB,CAAC,CAAC;IAAA,CACrD,CAAC,CAAC;IAEH,IAAA,mBAAQ,EAAC,aAAa,EAAE,GAAG,EAAE,CAAC;QAC5B,IAAA,eAAI,EAAC,kCAAkC,EAAE,KAAK,IAAI,EAAE,CAAC;YACnD,MAAM,GAAG,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,aAAa,CAAC,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAC;YAEvE,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;YACjE,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YACxB,IAAA,iBAAM,EAAC,GAAG,CAAC,CAAC,oBAAoB,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;YACzD,GAAG,CAAC,WAAW,EAAE,CAAC;QAAA,CACnB,CAAC,CAAC;QAEH,IAAA,eAAI,EAAC,uBAAuB,EAAE,GAAG,EAAE,CAAC;YAClC,IAAA,iBAAM,EAAC,OAAO,CAAC,WAAW,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,qBAAqB,CAAC,CAAC;QAAA,CAChF,CAAC,CAAC;QAEH,IAAA,eAAI,EAAC,wBAAwB,EAAE,GAAG,EAAE,CAAC;YACnC,8CAA8C;YAC9C,IAAA,iBAAM,EAAC,OAAO,CAAC,WAAW,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,CAAC;QAAA,CAC7E,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,mBAAQ,EAAC,kBAAkB,EAAE,GAAG,EAAE,CAAC;QACjC,IAAA,eAAI,EAAC,kCAAkC,EAAE,KAAK,IAAI,EAAE,CAAC;YACnD,MAAM,GAAG,GAAG,IAAA,gBAAK,EAAC,cAAc,EAAE,kBAAkB,CAAC,CAAC,iBAAiB,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;YAElF,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,gBAAgB,CAAC,OAAO,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC;YACnE,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;YACjC,IAAA,iBAAM,EAAC,GAAG,CAAC,CAAC,oBAAoB,CAAC,OAAO,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC;YACtD,GAAG,CAAC,WAAW,EAAE,CAAC;QAAA,CACnB,CAAC,CAAC;QAEH,IAAA,eAAI,EAAC,2BAA2B,EAAE,GAAG,EAAE,CAAC;YACtC,8CAA8C;YAC9C,IAAA,iBAAM,EAAC,OAAO,CAAC,gBAAgB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,mBAAmB,CAAC,CAAC;QAAA,CAC7F,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;IAEH,IAAA,mBAAQ,EAAC,gBAAgB,EAAE,GAAG,EAAE,CAAC;QAC/B,IAAA,eAAI,EAAC,iEAAiE,EAAE,KAAK,IAAI,EAAE,CAAC;YAClF,MAAM,QAAQ,GAAG;gBACf,IAAA,0BAAgB,EAAC,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,EAAE,eAAe,EAAE,CAAC,EAAE,CAAC;gBACjE,IAAA,0BAAgB,EAAC,MAAM,EAAE,WAAW,EAAE,OAAO,EAAE,EAAE,eAAe,EAAE,CAAC,EAAE,CAAC;aACvE,CAAC;YAEF,MAAM,UAAU,GAAG;gBACjB,SAAS,EAAE,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,UAAU,EAAE,GAAG,EAAE,CAAC;gBAC3D,WAAW,EAAE,GAAG;gBAChB,KAAK,EAAE,OAAO;gBACd,aAAa,EAAE,QAAQ;gBACvB,YAAY,EAAE,EAAE;aACjB,CAAC;YACF,MAAM,QAAQ,GAAG,IAAA,gBAAK,EAAC,UAAU,EAAE,qBAAqB,CAAC,CAAC,iBAAiB,CAAC,UAAU,CAAC,CAAC;YACxF,MAAM,UAAU,GAAG,IAAA,gBAAK,EAAC,mBAAmB,EAAE,oBAAoB,CAAC,CAAC,iBAAiB,CACnF,SAAS,CACV,CAAC;YACF,MAAM,MAAM,GAAG,IAAA,gBAAK,EAAC,IAAI,EAAE,KAAK,CAAC,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;YAExD,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,cAAc,CAAC,gBAAgB,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;YACjF,IAAA,iBAAM,EAAC,MAAM,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YAChC,IAAA,iBAAM,EAAC,QAAQ,CAAC,CAAC,oBAAoB,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YACzD,IAAA,iBAAM,EAAC,UAAU,CAAC,CAAC,oBAAoB,CACrC,gBAAgB,EAChB,iBAAM,CAAC,gBAAgB,CAAC;gBACtB,OAAO,EAAE,CAAC;gBACV,UAAU,EAAE,IAAI;gBAChB,KAAK,EAAE,OAAO;gBACd,aAAa,EAAE,QAAQ;gBACvB,WAAW,EAAE,GAAG;gBAChB,SAAS,EAAE,UAAU,CAAC,SAAS;gBAC/B,OAAO,EAAE,EAAE,YAAY,EAAE,CAAC,EAAE,kBAAkB,EAAE,CAAC,EAAE;aACpD,CAAC,CACH,CAAC;YAEF,MAAM,CAAC,WAAW,EAAE,CAAC;YACrB,QAAQ,CAAC,WAAW,EAAE,CAAC;YACvB,UAAU,CAAC,WAAW,EAAE,CAAC;QAAA,CAC1B,CAAC,CAAC;QAEH,IAAA,eAAI,EAAC,oEAAoE,EAAE,KAAK,IAAI,EAAE,CAAC;YACrF,MAAM,UAAU,GAAG;gBACjB,IAAA,0BAAgB,EAAC,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,EAAE,eAAe,EAAE,CAAC,EAAE,CAAC;gBACjE,IAAA,0BAAgB,EAAC,MAAM,EAAE,WAAW,EAAE,OAAO,EAAE,EAAE,eAAe,EAAE,CAAC,EAAE,CAAC;aACvE,CAAC;YAEF,MAAM,UAAU,GAAG;gBACjB,GAAG,UAAU;gBACb,IAAA,0BAAgB,EAAC,MAAM,EAAE,WAAW,EAAE,KAAK,EAAE,EAAE,eAAe,EAAE,CAAC,EAAE,CAAC;aACrE,CAAC;YAEF,MAAM,QAAQ,GAAG,GAAM,EAAE,CAAC;gBACxB,IAAI,OAA4B,CAAC;gBACjC,IAAI,MAAiC,CAAC;gBACtC,MAAM,OAAO,GAAG,IAAI,OAAO,CAAI,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE,CAAC;oBAC3C,OAAO,GAAG,GAAG,CAAC;oBACd,MAAM,GAAG,GAAG,CAAC;gBAAA,CACd,CAAC,CAAC;gBACH,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC;YAAA,CACrC,CAAC;YAEF,MAAM,OAAO,GAAG;gBACd,SAAS,EAAE,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,EAAE,UAAU,EAAE,GAAG,EAAE,CAAC;gBACzD,WAAW,EAAE,CAAC;gBACd,KAAK,EAAE,OAAO;gBACd,aAAa,EAAE,QAAQ;gBACvB,YAAY,EAAE,EAAE;aACjB,CAAC;YACF,MAAM,OAAO,GAAG;gBACd,SAAS,EAAE,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,EAAE,UAAU,EAAE,GAAG,EAAE,CAAC;gBACzD,WAAW,EAAE,CAAC;gBACd,KAAK,EAAE,OAAO;gBACd,aAAa,EAAE,QAAQ;gBACvB,YAAY,EAAE,EAAE;aACjB,CAAC;YAEF,MAAM,EAAE,GAAG,QAAQ,EAAkB,CAAC;YACtC,MAAM,EAAE,GAAG,QAAQ,EAAkB,CAAC;YAEtC,MAAM,QAAQ,GAAG,IAAA,gBAAK,EAAC,UAAU,EAAE,qBAAqB,CAAC;iBACtD,sBAAsB,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,OAAO,CAAC;iBACxC,sBAAsB,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC;YAC5C,MAAM,UAAU,GAAG,IAAA,gBAAK,EAAC,mBAAmB,EAAE,oBAAoB,CAAC,CAAC,iBAAiB,CACnF,SAAS,CACV,CAAC;YAEF,MAAM,EAAE,GAAG,OAAO,CAAC,cAAc,CAAC,gBAAgB,EAAE,UAAU,EAAE,OAAO,CAAC,CAAC;YACzE,MAAM,EAAE,GAAG,OAAO,CAAC,cAAc,CAAC,gBAAgB,EAAE,UAAU,EAAE,OAAO,CAAC,CAAC;YAEzE,uCAAuC;YACvC,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YACpB,IAAA,iBAAM,EAAC,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAE/B,qCAAqC;YACrC,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YACpB,IAAA,iBAAM,EAAC,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAE/B,mDAAmD;YACnD,IAAA,iBAAM,EAAC,UAAU,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;YAC5C,IAAA,iBAAM,EAAC,UAAU,CAAC,CAAC,oBAAoB,CACrC,gBAAgB,EAChB,iBAAM,CAAC,gBAAgB,CAAC;gBACtB,OAAO,EAAE,EAAE,YAAY,EAAE,UAAU,CAAC,MAAM,EAAE,kBAAkB,EAAE,CAAC,EAAE;aACpE,CAAC,CACH,CAAC;YAEF,QAAQ,CAAC,WAAW,EAAE,CAAC;YACvB,UAAU,CAAC,WAAW,EAAE,CAAC;QAAA,CAC1B,CAAC,CAAC;QAEH,IAAA,eAAI,EAAC,4BAA4B,EAAE,GAAG,EAAE,CAAC;YACvC,8CAA8C;YAC9C,IAAA,iBAAM,EAAC,OAAO,CAAC,cAAc,CAAC,gBAAgB,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAC7E,mBAAmB,CACpB,CAAC;QAAA,CACH,CAAC,CAAC;QAEH,IAAA,eAAI,EAAC,6BAA6B,EAAE,GAAG,EAAE,CAAC;YACxC,IAAA,iBAAM,EAAC,OAAO,CAAC,cAAc,CAAC,EAAE,EAAE,EAAE,EAAE,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAC;QAAA,CACzF,CAAC,CAAC;IAAA,CACJ,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { beforeEach, describe, expect, test, spyOn } from \"bun:test\";\r\nimport { TokenizerService } from \"./tokenizerService\";\r\nimport type { SessionUsageService } from \"./sessionUsageService\";\r\nimport * as tokenizerUtils from \"@/node/utils/main/tokenizer\";\r\nimport * as statsUtils from \"@/common/utils/tokens/tokenStatsCalculator\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\n\r\ndescribe(\"TokenizerService\", () => {\r\n  let sessionUsageService: SessionUsageService;\r\n  let service: TokenizerService;\r\n\r\n  beforeEach(() => {\r\n    sessionUsageService = {\r\n      setTokenStatsCache: () => Promise.resolve(),\r\n    } as unknown as SessionUsageService;\r\n    service = new TokenizerService(sessionUsageService);\r\n  });\r\n\r\n  describe(\"countTokens\", () => {\r\n    test(\"delegates to underlying function\", async () => {\r\n      const spy = spyOn(tokenizerUtils, \"countTokens\").mockResolvedValue(42);\r\n\r\n      const result = await service.countTokens(\"gpt-4\", \"hello world\");\r\n      expect(result).toBe(42);\r\n      expect(spy).toHaveBeenCalledWith(\"gpt-4\", \"hello world\");\r\n      spy.mockRestore();\r\n    });\r\n\r\n    test(\"throws on empty model\", () => {\r\n      expect(service.countTokens(\"\", \"text\")).rejects.toThrow(\"requires model name\");\r\n    });\r\n\r\n    test(\"throws on invalid text\", () => {\r\n      // @ts-expect-error testing runtime validation\r\n      expect(service.countTokens(\"gpt-4\", null)).rejects.toThrow(\"requires text\");\r\n    });\r\n  });\r\n\r\n  describe(\"countTokensBatch\", () => {\r\n    test(\"delegates to underlying function\", async () => {\r\n      const spy = spyOn(tokenizerUtils, \"countTokensBatch\").mockResolvedValue([10, 20]);\r\n\r\n      const result = await service.countTokensBatch(\"gpt-4\", [\"a\", \"b\"]);\r\n      expect(result).toEqual([10, 20]);\r\n      expect(spy).toHaveBeenCalledWith(\"gpt-4\", [\"a\", \"b\"]);\r\n      spy.mockRestore();\r\n    });\r\n\r\n    test(\"throws on non-array input\", () => {\r\n      // @ts-expect-error testing runtime validation\r\n      expect(service.countTokensBatch(\"gpt-4\", \"not-array\")).rejects.toThrow(\"requires an array\");\r\n    });\r\n  });\r\n\r\n  describe(\"calculateStats\", () => {\r\n    test(\"delegates to underlying function and persists token stats cache\", async () => {\r\n      const messages = [\r\n        createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 1 }),\r\n        createMuxMessage(\"msg2\", \"assistant\", \"World\", { historySequence: 2 }),\r\n      ];\r\n\r\n      const mockResult = {\r\n        consumers: [{ name: \"User\", tokens: 100, percentage: 100 }],\r\n        totalTokens: 100,\r\n        model: \"gpt-4\",\r\n        tokenizerName: \"cl100k\",\r\n        usageHistory: [],\r\n      };\r\n      const statsSpy = spyOn(statsUtils, \"calculateTokenStats\").mockResolvedValue(mockResult);\r\n      const persistSpy = spyOn(sessionUsageService, \"setTokenStatsCache\").mockResolvedValue(\r\n        undefined\r\n      );\r\n      const nowSpy = spyOn(Date, \"now\").mockReturnValue(1234);\r\n\r\n      const result = await service.calculateStats(\"test-workspace\", messages, \"gpt-4\");\r\n      expect(result).toBe(mockResult);\r\n      expect(statsSpy).toHaveBeenCalledWith(messages, \"gpt-4\");\r\n      expect(persistSpy).toHaveBeenCalledWith(\r\n        \"test-workspace\",\r\n        expect.objectContaining({\r\n          version: 1,\r\n          computedAt: 1234,\r\n          model: \"gpt-4\",\r\n          tokenizerName: \"cl100k\",\r\n          totalTokens: 100,\r\n          consumers: mockResult.consumers,\r\n          history: { messageCount: 2, maxHistorySequence: 2 },\r\n        })\r\n      );\r\n\r\n      nowSpy.mockRestore();\r\n      statsSpy.mockRestore();\r\n      persistSpy.mockRestore();\r\n    });\r\n\r\n    test(\"skips persisting stale token stats cache when calculations overlap\", async () => {\r\n      const messagesV1 = [\r\n        createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 1 }),\r\n        createMuxMessage(\"msg2\", \"assistant\", \"World\", { historySequence: 2 }),\r\n      ];\r\n\r\n      const messagesV2 = [\r\n        ...messagesV1,\r\n        createMuxMessage(\"msg3\", \"assistant\", \"!!!\", { historySequence: 3 }),\r\n      ];\r\n\r\n      const deferred = <T>() => {\r\n        let resolve!: (value: T) => void;\r\n        let reject!: (error: unknown) => void;\r\n        const promise = new Promise<T>((res, rej) => {\r\n          resolve = res;\r\n          reject = rej;\r\n        });\r\n        return { promise, resolve, reject };\r\n      };\r\n\r\n      const statsV1 = {\r\n        consumers: [{ name: \"User\", tokens: 1, percentage: 100 }],\r\n        totalTokens: 1,\r\n        model: \"gpt-4\",\r\n        tokenizerName: \"cl100k\",\r\n        usageHistory: [],\r\n      };\r\n      const statsV2 = {\r\n        consumers: [{ name: \"User\", tokens: 2, percentage: 100 }],\r\n        totalTokens: 2,\r\n        model: \"gpt-4\",\r\n        tokenizerName: \"cl100k\",\r\n        usageHistory: [],\r\n      };\r\n\r\n      const d1 = deferred<typeof statsV1>();\r\n      const d2 = deferred<typeof statsV2>();\r\n\r\n      const statsSpy = spyOn(statsUtils, \"calculateTokenStats\")\r\n        .mockImplementationOnce(() => d1.promise)\r\n        .mockImplementationOnce(() => d2.promise);\r\n      const persistSpy = spyOn(sessionUsageService, \"setTokenStatsCache\").mockResolvedValue(\r\n        undefined\r\n      );\r\n\r\n      const p1 = service.calculateStats(\"test-workspace\", messagesV1, \"gpt-4\");\r\n      const p2 = service.calculateStats(\"test-workspace\", messagesV2, \"gpt-4\");\r\n\r\n      // Resolve second (newer) request first\r\n      d2.resolve(statsV2);\r\n      expect(await p2).toBe(statsV2);\r\n\r\n      // Resolve first (older) request last\r\n      d1.resolve(statsV1);\r\n      expect(await p1).toBe(statsV1);\r\n\r\n      // Only the newer request should persist the cache.\r\n      expect(persistSpy).toHaveBeenCalledTimes(1);\r\n      expect(persistSpy).toHaveBeenCalledWith(\r\n        \"test-workspace\",\r\n        expect.objectContaining({\r\n          history: { messageCount: messagesV2.length, maxHistorySequence: 3 },\r\n        })\r\n      );\r\n\r\n      statsSpy.mockRestore();\r\n      persistSpy.mockRestore();\r\n    });\r\n\r\n    test(\"throws on invalid messages\", () => {\r\n      // @ts-expect-error testing runtime validation\r\n      expect(service.calculateStats(\"test-workspace\", null, \"gpt-4\")).rejects.toThrow(\r\n        \"requires an array\"\r\n      );\r\n    });\r\n\r\n    test(\"throws on empty workspaceId\", () => {\r\n      expect(service.calculateStats(\"\", [], \"gpt-4\")).rejects.toThrow(\"requires workspaceId\");\r\n    });\r\n  });\r\n});\r\n"]}