{"version":3,"file":"tokenizerService.test.js","sourceRoot":"","sources":["../../../src/node/services/tokenizerService.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { beforeEach, describe, expect, test, spyOn } from \"bun:test\";\nimport { TokenizerService } from \"./tokenizerService\";\nimport type { SessionUsageService } from \"./sessionUsageService\";\nimport * as tokenizerUtils from \"@/node/utils/main/tokenizer\";\nimport * as statsUtils from \"@/common/utils/tokens/tokenStatsCalculator\";\nimport { createMuxMessage } from \"@/common/types/message\";\n\ndescribe(\"TokenizerService\", () => {\n  let sessionUsageService: SessionUsageService;\n  let service: TokenizerService;\n\n  beforeEach(() => {\n    sessionUsageService = {\n      setTokenStatsCache: () => Promise.resolve(),\n    } as unknown as SessionUsageService;\n    service = new TokenizerService(sessionUsageService);\n  });\n\n  describe(\"countTokens\", () => {\n    test(\"delegates to underlying function\", async () => {\n      const spy = spyOn(tokenizerUtils, \"countTokens\").mockResolvedValue(42);\n\n      const result = await service.countTokens(\"gpt-4\", \"hello world\");\n      expect(result).toBe(42);\n      expect(spy).toHaveBeenCalledWith(\"gpt-4\", \"hello world\");\n      spy.mockRestore();\n    });\n\n    test(\"throws on empty model\", () => {\n      expect(service.countTokens(\"\", \"text\")).rejects.toThrow(\"requires model name\");\n    });\n\n    test(\"throws on invalid text\", () => {\n      // @ts-expect-error testing runtime validation\n      expect(service.countTokens(\"gpt-4\", null)).rejects.toThrow(\"requires text\");\n    });\n  });\n\n  describe(\"countTokensBatch\", () => {\n    test(\"delegates to underlying function\", async () => {\n      const spy = spyOn(tokenizerUtils, \"countTokensBatch\").mockResolvedValue([10, 20]);\n\n      const result = await service.countTokensBatch(\"gpt-4\", [\"a\", \"b\"]);\n      expect(result).toEqual([10, 20]);\n      expect(spy).toHaveBeenCalledWith(\"gpt-4\", [\"a\", \"b\"]);\n      spy.mockRestore();\n    });\n\n    test(\"throws on non-array input\", () => {\n      // @ts-expect-error testing runtime validation\n      expect(service.countTokensBatch(\"gpt-4\", \"not-array\")).rejects.toThrow(\"requires an array\");\n    });\n  });\n\n  describe(\"calculateStats\", () => {\n    test(\"delegates to underlying function and persists token stats cache\", async () => {\n      const messages = [\n        createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 1 }),\n        createMuxMessage(\"msg2\", \"assistant\", \"World\", { historySequence: 2 }),\n      ];\n\n      const mockResult = {\n        consumers: [{ name: \"User\", tokens: 100, percentage: 100 }],\n        totalTokens: 100,\n        model: \"gpt-4\",\n        tokenizerName: \"cl100k\",\n        usageHistory: [],\n      };\n      const statsSpy = spyOn(statsUtils, \"calculateTokenStats\").mockResolvedValue(mockResult);\n      const persistSpy = spyOn(sessionUsageService, \"setTokenStatsCache\").mockResolvedValue(\n        undefined\n      );\n      const nowSpy = spyOn(Date, \"now\").mockReturnValue(1234);\n\n      const result = await service.calculateStats(\"test-workspace\", messages, \"gpt-4\");\n      expect(result).toBe(mockResult);\n      expect(statsSpy).toHaveBeenCalledWith(messages, \"gpt-4\");\n      expect(persistSpy).toHaveBeenCalledWith(\n        \"test-workspace\",\n        expect.objectContaining({\n          version: 1,\n          computedAt: 1234,\n          model: \"gpt-4\",\n          tokenizerName: \"cl100k\",\n          totalTokens: 100,\n          consumers: mockResult.consumers,\n          history: { messageCount: 2, maxHistorySequence: 2 },\n        })\n      );\n\n      nowSpy.mockRestore();\n      statsSpy.mockRestore();\n      persistSpy.mockRestore();\n    });\n\n    test(\"skips persisting stale token stats cache when calculations overlap\", async () => {\n      const messagesV1 = [\n        createMuxMessage(\"msg1\", \"user\", \"Hello\", { historySequence: 1 }),\n        createMuxMessage(\"msg2\", \"assistant\", \"World\", { historySequence: 2 }),\n      ];\n\n      const messagesV2 = [\n        ...messagesV1,\n        createMuxMessage(\"msg3\", \"assistant\", \"!!!\", { historySequence: 3 }),\n      ];\n\n      const deferred = <T>() => {\n        let resolve!: (value: T) => void;\n        let reject!: (error: unknown) => void;\n        const promise = new Promise<T>((res, rej) => {\n          resolve = res;\n          reject = rej;\n        });\n        return { promise, resolve, reject };\n      };\n\n      const statsV1 = {\n        consumers: [{ name: \"User\", tokens: 1, percentage: 100 }],\n        totalTokens: 1,\n        model: \"gpt-4\",\n        tokenizerName: \"cl100k\",\n        usageHistory: [],\n      };\n      const statsV2 = {\n        consumers: [{ name: \"User\", tokens: 2, percentage: 100 }],\n        totalTokens: 2,\n        model: \"gpt-4\",\n        tokenizerName: \"cl100k\",\n        usageHistory: [],\n      };\n\n      const d1 = deferred<typeof statsV1>();\n      const d2 = deferred<typeof statsV2>();\n\n      const statsSpy = spyOn(statsUtils, \"calculateTokenStats\")\n        .mockImplementationOnce(() => d1.promise)\n        .mockImplementationOnce(() => d2.promise);\n      const persistSpy = spyOn(sessionUsageService, \"setTokenStatsCache\").mockResolvedValue(\n        undefined\n      );\n\n      const p1 = service.calculateStats(\"test-workspace\", messagesV1, \"gpt-4\");\n      const p2 = service.calculateStats(\"test-workspace\", messagesV2, \"gpt-4\");\n\n      // Resolve second (newer) request first\n      d2.resolve(statsV2);\n      expect(await p2).toBe(statsV2);\n\n      // Resolve first (older) request last\n      d1.resolve(statsV1);\n      expect(await p1).toBe(statsV1);\n\n      // Only the newer request should persist the cache.\n      expect(persistSpy).toHaveBeenCalledTimes(1);\n      expect(persistSpy).toHaveBeenCalledWith(\n        \"test-workspace\",\n        expect.objectContaining({\n          history: { messageCount: messagesV2.length, maxHistorySequence: 3 },\n        })\n      );\n\n      statsSpy.mockRestore();\n      persistSpy.mockRestore();\n    });\n\n    test(\"throws on invalid messages\", () => {\n      // @ts-expect-error testing runtime validation\n      expect(service.calculateStats(\"test-workspace\", null, \"gpt-4\")).rejects.toThrow(\n        \"requires an array\"\n      );\n    });\n\n    test(\"throws on empty workspaceId\", () => {\n      expect(service.calculateStats(\"\", [], \"gpt-4\")).rejects.toThrow(\"requires workspaceId\");\n    });\n  });\n});\n"]}