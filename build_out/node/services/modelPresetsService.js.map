{"version":3,"file":"modelPresetsService.js","sourceRoot":"","sources":["../../../src/node/services/modelPresetsService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\nimport * as path from \"path\";\nimport * as crypto from \"crypto\";\nimport writeFileAtomic from \"write-file-atomic\";\nimport type { Config } from \"@/node/config\";\nimport type { CustomModelMetadata } from \"@/common/orpc/schemas/api\";\nimport type { Result } from \"@/common/types/result\";\nimport { log } from \"./log\";\n\n// --- Data Model ---\n\nexport interface PresetModelEntry {\n  provider: string;\n  modelId: string;\n  metadata?: CustomModelMetadata;\n}\n\nexport interface ModelPreset {\n  id: string;\n  name: string;\n  description?: string;\n  createdAt: number;\n  updatedAt: number;\n  models: PresetModelEntry[];\n}\n\ninterface ModelPresetsFile {\n  version: 1;\n  presets: ModelPreset[];\n}\n\nconst EMPTY_FILE: ModelPresetsFile = { version: 1, presets: [] };\n\n/**\n * Service for managing model presets.\n *\n * Presets let users snapshot their model configurations and restore them later.\n * Data is stored in `~/.mux/model-presets.json` using atomic writes.\n */\nexport class ModelPresetsService {\n  private readonly PRESETS_FILE = \"model-presets.json\";\n  private readonly config: Config;\n\n  constructor(config: Config) {\n    this.config = config;\n  }\n\n  private getFilePath(): string {\n    return path.join(this.config.rootDir, this.PRESETS_FILE);\n  }\n\n  private async readFile(): Promise<ModelPresetsFile> {\n    try {\n      const data = await fs.readFile(this.getFilePath(), \"utf-8\");\n      return JSON.parse(data) as ModelPresetsFile;\n    } catch (error) {\n      if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n        return { ...EMPTY_FILE };\n      }\n      log.warn(\"[ModelPresetsService] Error reading presets file\", { error });\n      return { ...EMPTY_FILE };\n    }\n  }\n\n  private async writeFile(data: ModelPresetsFile): Promise<void> {\n    const filePath = this.getFilePath();\n    await fs.mkdir(path.dirname(filePath), { recursive: true });\n    await writeFileAtomic(filePath, JSON.stringify(data, null, 2));\n  }\n\n  /** List all saved presets. */\n  async listPresets(): Promise<ModelPreset[]> {\n    const file = await this.readFile();\n    return file.presets;\n  }\n\n  /** Save a new preset from the provided models. */\n  async savePreset(\n    name: string,\n    models: PresetModelEntry[],\n    description?: string\n  ): Promise<ModelPreset> {\n    const file = await this.readFile();\n    const now = Date.now();\n    const preset: ModelPreset = {\n      id: crypto.randomUUID(),\n      name,\n      description,\n      createdAt: now,\n      updatedAt: now,\n      models,\n    };\n    file.presets.push(preset);\n    await this.writeFile(file);\n    return preset;\n  }\n\n  /** Get a single preset by ID. */\n  async getPreset(id: string): Promise<ModelPreset | undefined> {\n    const file = await this.readFile();\n    return file.presets.find((p) => p.id === id);\n  }\n\n  /** Delete a preset by ID. Returns success/error result. */\n  async deletePreset(id: string): Promise<Result<void, string>> {\n    const file = await this.readFile();\n    const index = file.presets.findIndex((p) => p.id === id);\n    if (index === -1) {\n      return { success: false, error: `Preset not found: ${id}` };\n    }\n    file.presets.splice(index, 1);\n    await this.writeFile(file);\n    return { success: true, data: undefined };\n  }\n\n  /** Update an existing preset. */\n  async updatePreset(\n    id: string,\n    updates: { name?: string; description?: string; models?: PresetModelEntry[] }\n  ): Promise<Result<ModelPreset, string>> {\n    const file = await this.readFile();\n    const preset = file.presets.find((p) => p.id === id);\n    if (!preset) {\n      return { success: false, error: `Preset not found: ${id}` };\n    }\n    if (updates.name !== undefined) preset.name = updates.name;\n    if (updates.description !== undefined) preset.description = updates.description;\n    if (updates.models !== undefined) preset.models = updates.models;\n    preset.updatedAt = Date.now();\n    await this.writeFile(file);\n    return { success: true, data: preset };\n  }\n\n  /**\n   * Export presets as a portable JSON string.\n   * If ids are provided, only those presets are exported; otherwise all.\n   */\n  async exportPresets(ids?: string[]): Promise<string> {\n    const file = await this.readFile();\n    const presets = ids ? file.presets.filter((p) => ids.includes(p.id)) : file.presets;\n    const exportData = { version: 1 as const, presets };\n    return JSON.stringify(exportData, null, 2);\n  }\n\n  /**\n   * Import presets from a JSON string. Validates structure before importing.\n   * Imported presets get new IDs to avoid collisions.\n   */\n  async importPresets(json: string): Promise<Result<ModelPreset[], string>> {\n    let parsed: unknown;\n    try {\n      parsed = JSON.parse(json);\n    } catch {\n      return { success: false, error: \"Invalid JSON\" };\n    }\n\n    if (!parsed || typeof parsed !== \"object\") {\n      return { success: false, error: \"Expected an object with presets array\" };\n    }\n\n    const obj = parsed as Record<string, unknown>;\n    if (!Array.isArray(obj.presets)) {\n      return { success: false, error: \"Missing or invalid 'presets' array\" };\n    }\n\n    const file = await this.readFile();\n    const imported: ModelPreset[] = [];\n    const now = Date.now();\n\n    for (const raw of obj.presets) {\n      if (!raw || typeof raw !== \"object\") continue;\n      const p = raw as Record<string, unknown>;\n\n      if (typeof p.name !== \"string\" || !Array.isArray(p.models)) {\n        continue; // skip malformed entries\n      }\n\n      const models: PresetModelEntry[] = [];\n      for (const m of p.models as unknown[]) {\n        if (!m || typeof m !== \"object\") continue;\n        const model = m as Record<string, unknown>;\n        if (typeof model.provider !== \"string\" || typeof model.modelId !== \"string\") continue;\n        models.push({\n          provider: model.provider,\n          modelId: model.modelId,\n          metadata: model.metadata as CustomModelMetadata | undefined,\n        });\n      }\n\n      const preset: ModelPreset = {\n        id: crypto.randomUUID(), // new ID to avoid collision\n        name: p.name,\n        description: typeof p.description === \"string\" ? p.description : undefined,\n        createdAt: now,\n        updatedAt: now,\n        models,\n      };\n      file.presets.push(preset);\n      imported.push(preset);\n    }\n\n    if (imported.length === 0) {\n      return { success: false, error: \"No valid presets found in import data\" };\n    }\n\n    await this.writeFile(file);\n    return { success: true, data: imported };\n  }\n}\n"]}