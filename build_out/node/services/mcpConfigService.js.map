{"version":3,"file":"mcpConfigService.js","sourceRoot":"","sources":["../../../src/node/services/mcpConfigService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs\";\nimport * as path from \"path\";\nimport * as jsonc from \"jsonc-parser\";\nimport writeFileAtomic from \"write-file-atomic\";\nimport type {\n  MCPConfig,\n  MCPHeaderValue,\n  MCPServerInfo,\n  MCPServerTransport,\n} from \"@/common/types/mcp\";\nimport { Ok, Err } from \"@/common/types/result\";\nimport type { Result } from \"@/common/types/result\";\nimport assert from \"@/common/utils/assert\";\nimport type { Config } from \"@/node/config\";\nimport { log } from \"@/node/services/log\";\n\nexport class MCPConfigService {\n  private readonly config: Config;\n\n  constructor(config: Config) {\n    assert(\n      typeof config.rootDir === \"string\" && config.rootDir.trim().length > 0,\n      \"MCPConfigService: config.rootDir must be a non-empty string\"\n    );\n\n    this.config = config;\n  }\n\n  private getGlobalConfigPath(): string {\n    return path.join(this.config.rootDir, \"mcp.jsonc\");\n  }\n\n  private getRepoOverridePath(projectPath: string): string {\n    return path.join(projectPath, \".mux\", \"mcp.jsonc\");\n  }\n\n  private async pathExists(targetPath: string): Promise<boolean> {\n    try {\n      await fs.promises.access(targetPath, fs.constants.F_OK);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  private async ensureMuxRootDir(): Promise<void> {\n    if (!(await this.pathExists(this.config.rootDir))) {\n      await fs.promises.mkdir(this.config.rootDir, { recursive: true });\n    }\n  }\n\n  /**\n   * Normalize a raw config entry into a strongly-typed server definition.\n   *\n   * Supported raw formats:\n   * - string: stdio command\n   * - object w/ command: stdio\n   * - object w/ url: http/sse/auto (defaults to auto)\n   */\n  private normalizeEntry(entry: unknown): MCPServerInfo {\n    if (typeof entry === \"string\") {\n      return { transport: \"stdio\", command: entry, disabled: false };\n    }\n\n    if (!entry || typeof entry !== \"object\") {\n      // Fail closed for invalid shapes.\n      return { transport: \"stdio\", command: \"\", disabled: true };\n    }\n\n    const obj = entry as Record<string, unknown>;\n    const disabled = typeof obj.disabled === \"boolean\" ? obj.disabled : false;\n    const toolAllowlist = Array.isArray(obj.toolAllowlist)\n      ? obj.toolAllowlist.filter((v): v is string => typeof v === \"string\")\n      : undefined;\n\n    const transport =\n      obj.transport === \"stdio\" ||\n      obj.transport === \"http\" ||\n      obj.transport === \"sse\" ||\n      obj.transport === \"auto\"\n        ? obj.transport\n        : undefined;\n\n    const command = typeof obj.command === \"string\" ? obj.command : undefined;\n    const url = typeof obj.url === \"string\" ? obj.url : undefined;\n\n    const headersRaw = obj.headers;\n    let headers: Record<string, string | { secret: string }> | undefined;\n\n    if (headersRaw && typeof headersRaw === \"object\" && !Array.isArray(headersRaw)) {\n      const next: Record<string, string | { secret: string }> = {};\n      for (const [k, v] of Object.entries(headersRaw as Record<string, unknown>)) {\n        if (typeof v === \"string\") {\n          next[k] = v;\n          continue;\n        }\n        if (v && typeof v === \"object\" && !Array.isArray(v)) {\n          const secret = (v as Record<string, unknown>).secret;\n          if (typeof secret === \"string\") {\n            next[k] = { secret };\n          }\n        }\n      }\n      if (Object.keys(next).length > 0) {\n        headers = next;\n      }\n    }\n\n    // If it has a url, prefer HTTP-based transports (default to auto).\n    if (url) {\n      const httpTransport = transport && transport !== \"stdio\" ? transport : \"auto\";\n      return {\n        transport: httpTransport,\n        url,\n        headers,\n        disabled,\n        toolAllowlist,\n      };\n    }\n\n    // Otherwise, treat it as stdio.\n    return {\n      transport: \"stdio\",\n      command: command ?? \"\",\n      disabled,\n      toolAllowlist,\n    };\n  }\n\n  private async readConfigFile(filePath: string): Promise<MCPConfig> {\n    try {\n      const exists = await this.pathExists(filePath);\n      if (!exists) {\n        return { servers: {} };\n      }\n\n      const raw = await fs.promises.readFile(filePath, \"utf-8\");\n      const parsed = jsonc.parse(raw) as { servers?: Record<string, unknown> } | undefined;\n\n      if (!parsed || typeof parsed !== \"object\" || !parsed.servers) {\n        return { servers: {} };\n      }\n\n      // Normalize all entries on read\n      const servers: Record<string, MCPServerInfo> = {};\n      for (const [name, entry] of Object.entries(parsed.servers)) {\n        servers[name] = this.normalizeEntry(entry);\n      }\n      return { servers };\n    } catch (error) {\n      // Defensive: never crash on startup due to corrupt config.\n      log.error(\"Failed to read MCP config\", { filePath, error });\n      return { servers: {} };\n    }\n  }\n\n  private async getGlobalConfig(): Promise<MCPConfig> {\n    return this.readConfigFile(this.getGlobalConfigPath());\n  }\n\n  private async getRepoOverrideConfig(projectPath: string): Promise<MCPConfig> {\n    return this.readConfigFile(this.getRepoOverridePath(projectPath));\n  }\n\n  private async saveGlobalConfig(config: MCPConfig): Promise<void> {\n    await this.ensureMuxRootDir();\n\n    const filePath = this.getGlobalConfigPath();\n\n    // Write minimal format:\n    // - string for stdio servers without extra settings\n    // - object when:\n    //   - disabled/toolAllowlist set, or\n    //   - non-stdio transport, or\n    //   - headers present\n    //\n    // toolAllowlist: undefined = all tools (omit), [] = no tools, [...] = those tools\n    const output: Record<string, unknown> = {};\n\n    for (const [name, entry] of Object.entries(config.servers)) {\n      const hasSettings = entry.disabled || entry.toolAllowlist !== undefined;\n\n      if (entry.transport === \"stdio\") {\n        if (!hasSettings) {\n          output[name] = entry.command;\n          continue;\n        }\n\n        const obj: Record<string, unknown> = {\n          command: entry.command,\n        };\n        if (entry.disabled) obj.disabled = true;\n        if (entry.toolAllowlist !== undefined) obj.toolAllowlist = entry.toolAllowlist;\n        output[name] = obj;\n        continue;\n      }\n\n      const obj: Record<string, unknown> = {\n        transport: entry.transport,\n        url: entry.url,\n      };\n      if (entry.headers) obj.headers = entry.headers;\n      if (entry.disabled) obj.disabled = true;\n      if (entry.toolAllowlist !== undefined) obj.toolAllowlist = entry.toolAllowlist;\n\n      output[name] = obj;\n    }\n\n    await writeFileAtomic(filePath, JSON.stringify({ servers: output }, null, 2), {\n      encoding: \"utf-8\",\n      mode: 0o600,\n    });\n  }\n\n  /**\n   * List configured servers.\n   *\n   * - When no projectPath is provided: returns global servers from <muxHome>/mcp.jsonc\n   * - When projectPath is provided: merges global + <projectPath>/.mux/mcp.jsonc (override wins)\n   */\n  async listServers(projectPath?: string): Promise<Record<string, MCPServerInfo>> {\n    const globalCfg = await this.getGlobalConfig();\n\n    if (!projectPath) {\n      return globalCfg.servers;\n    }\n\n    const repoCfg = await this.getRepoOverrideConfig(projectPath);\n\n    // Repo overrides win by server name.\n    return {\n      ...globalCfg.servers,\n      ...repoCfg.servers,\n    };\n  }\n\n  async addServer(\n    name: string,\n    input: {\n      transport?: MCPServerTransport;\n      command?: string;\n      url?: string;\n      headers?: Record<string, MCPHeaderValue>;\n    }\n  ): Promise<Result<void>> {\n    if (!name.trim()) {\n      return Err(\"Server name is required\");\n    }\n\n    const transport: MCPServerTransport = input.transport ?? \"stdio\";\n\n    if (transport === \"stdio\") {\n      if (!input.command?.trim()) {\n        return Err(\"Command is required\");\n      }\n    } else {\n      if (!input.url?.trim()) {\n        return Err(\"URL is required\");\n      }\n    }\n\n    const cfg = await this.getGlobalConfig();\n    const existing = cfg.servers[name];\n\n    const base = {\n      disabled: existing?.disabled ?? false,\n      toolAllowlist: existing?.toolAllowlist,\n    };\n\n    const next: MCPServerInfo =\n      transport === \"stdio\"\n        ? {\n            transport: \"stdio\",\n            command: input.command!,\n            ...base,\n          }\n        : {\n            transport,\n            url: input.url!,\n            headers: input.headers,\n            ...base,\n          };\n\n    cfg.servers[name] = next;\n\n    try {\n      await this.saveGlobalConfig(cfg);\n      return Ok(undefined);\n    } catch (error) {\n      log.error(\"Failed to save MCP server\", { name, error });\n      return Err(error instanceof Error ? error.message : String(error));\n    }\n  }\n\n  async setServerEnabled(name: string, enabled: boolean): Promise<Result<void>> {\n    const cfg = await this.getGlobalConfig();\n    const entry = cfg.servers[name];\n    if (!entry) {\n      return Err(`Server ${name} not found`);\n    }\n    cfg.servers[name] = { ...entry, disabled: !enabled };\n    try {\n      await this.saveGlobalConfig(cfg);\n      return Ok(undefined);\n    } catch (error) {\n      log.error(\"Failed to update MCP server enabled state\", { name, error });\n      return Err(error instanceof Error ? error.message : String(error));\n    }\n  }\n\n  async removeServer(name: string): Promise<Result<void>> {\n    const cfg = await this.getGlobalConfig();\n    if (!cfg.servers[name]) {\n      return Err(`Server ${name} not found`);\n    }\n    delete cfg.servers[name];\n    try {\n      await this.saveGlobalConfig(cfg);\n      return Ok(undefined);\n    } catch (error) {\n      log.error(\"Failed to remove MCP server\", { name, error });\n      return Err(error instanceof Error ? error.message : String(error));\n    }\n  }\n\n  async setToolAllowlist(name: string, toolAllowlist: string[]): Promise<Result<void>> {\n    const cfg = await this.getGlobalConfig();\n    const entry = cfg.servers[name];\n    if (!entry) {\n      return Err(`Server ${name} not found`);\n    }\n\n    // [] = no tools allowed, [...tools] = those tools allowed\n    cfg.servers[name] = {\n      ...entry,\n      toolAllowlist,\n    };\n\n    try {\n      await this.saveGlobalConfig(cfg);\n      return Ok(undefined);\n    } catch (error) {\n      log.error(\"Failed to update MCP server tool allowlist\", { name, error });\n      return Err(error instanceof Error ? error.message : String(error));\n    }\n  }\n}\n"]}