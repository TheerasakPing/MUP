{"version":3,"file":"mcpConfigService.js","sourceRoot":"","sources":["../../../src/node/services/mcpConfigService.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport * as jsonc from \"jsonc-parser\";\r\nimport writeFileAtomic from \"write-file-atomic\";\r\nimport type {\r\n  MCPConfig,\r\n  MCPHeaderValue,\r\n  MCPServerInfo,\r\n  MCPServerTransport,\r\n} from \"@/common/types/mcp\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport assert from \"@/common/utils/assert\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\nexport class MCPConfigService {\r\n  private readonly config: Config;\r\n\r\n  constructor(config: Config) {\r\n    assert(\r\n      typeof config.rootDir === \"string\" && config.rootDir.trim().length > 0,\r\n      \"MCPConfigService: config.rootDir must be a non-empty string\"\r\n    );\r\n\r\n    this.config = config;\r\n  }\r\n\r\n  private getGlobalConfigPath(): string {\r\n    return path.join(this.config.rootDir, \"mcp.jsonc\");\r\n  }\r\n\r\n  private getRepoOverridePath(projectPath: string): string {\r\n    return path.join(projectPath, \".mux\", \"mcp.jsonc\");\r\n  }\r\n\r\n  private async pathExists(targetPath: string): Promise<boolean> {\r\n    try {\r\n      await fs.promises.access(targetPath, fs.constants.F_OK);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async ensureMuxRootDir(): Promise<void> {\r\n    if (!(await this.pathExists(this.config.rootDir))) {\r\n      await fs.promises.mkdir(this.config.rootDir, { recursive: true });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Normalize a raw config entry into a strongly-typed server definition.\r\n   *\r\n   * Supported raw formats:\r\n   * - string: stdio command\r\n   * - object w/ command: stdio\r\n   * - object w/ url: http/sse/auto (defaults to auto)\r\n   */\r\n  private normalizeEntry(entry: unknown): MCPServerInfo {\r\n    if (typeof entry === \"string\") {\r\n      return { transport: \"stdio\", command: entry, disabled: false };\r\n    }\r\n\r\n    if (!entry || typeof entry !== \"object\") {\r\n      // Fail closed for invalid shapes.\r\n      return { transport: \"stdio\", command: \"\", disabled: true };\r\n    }\r\n\r\n    const obj = entry as Record<string, unknown>;\r\n    const disabled = typeof obj.disabled === \"boolean\" ? obj.disabled : false;\r\n    const toolAllowlist = Array.isArray(obj.toolAllowlist)\r\n      ? obj.toolAllowlist.filter((v): v is string => typeof v === \"string\")\r\n      : undefined;\r\n\r\n    const transport =\r\n      obj.transport === \"stdio\" ||\r\n      obj.transport === \"http\" ||\r\n      obj.transport === \"sse\" ||\r\n      obj.transport === \"auto\"\r\n        ? obj.transport\r\n        : undefined;\r\n\r\n    const command = typeof obj.command === \"string\" ? obj.command : undefined;\r\n    const url = typeof obj.url === \"string\" ? obj.url : undefined;\r\n\r\n    const headersRaw = obj.headers;\r\n    let headers: Record<string, string | { secret: string }> | undefined;\r\n\r\n    if (headersRaw && typeof headersRaw === \"object\" && !Array.isArray(headersRaw)) {\r\n      const next: Record<string, string | { secret: string }> = {};\r\n      for (const [k, v] of Object.entries(headersRaw as Record<string, unknown>)) {\r\n        if (typeof v === \"string\") {\r\n          next[k] = v;\r\n          continue;\r\n        }\r\n        if (v && typeof v === \"object\" && !Array.isArray(v)) {\r\n          const secret = (v as Record<string, unknown>).secret;\r\n          if (typeof secret === \"string\") {\r\n            next[k] = { secret };\r\n          }\r\n        }\r\n      }\r\n      if (Object.keys(next).length > 0) {\r\n        headers = next;\r\n      }\r\n    }\r\n\r\n    // If it has a url, prefer HTTP-based transports (default to auto).\r\n    if (url) {\r\n      const httpTransport = transport && transport !== \"stdio\" ? transport : \"auto\";\r\n      return {\r\n        transport: httpTransport,\r\n        url,\r\n        headers,\r\n        disabled,\r\n        toolAllowlist,\r\n      };\r\n    }\r\n\r\n    // Otherwise, treat it as stdio.\r\n    return {\r\n      transport: \"stdio\",\r\n      command: command ?? \"\",\r\n      disabled,\r\n      toolAllowlist,\r\n    };\r\n  }\r\n\r\n  private async readConfigFile(filePath: string): Promise<MCPConfig> {\r\n    try {\r\n      const exists = await this.pathExists(filePath);\r\n      if (!exists) {\r\n        return { servers: {} };\r\n      }\r\n\r\n      const raw = await fs.promises.readFile(filePath, \"utf-8\");\r\n      const parsed = jsonc.parse(raw) as { servers?: Record<string, unknown> } | undefined;\r\n\r\n      if (!parsed || typeof parsed !== \"object\" || !parsed.servers) {\r\n        return { servers: {} };\r\n      }\r\n\r\n      // Normalize all entries on read\r\n      const servers: Record<string, MCPServerInfo> = {};\r\n      for (const [name, entry] of Object.entries(parsed.servers)) {\r\n        servers[name] = this.normalizeEntry(entry);\r\n      }\r\n      return { servers };\r\n    } catch (error) {\r\n      // Defensive: never crash on startup due to corrupt config.\r\n      log.error(\"Failed to read MCP config\", { filePath, error });\r\n      return { servers: {} };\r\n    }\r\n  }\r\n\r\n  private async getGlobalConfig(): Promise<MCPConfig> {\r\n    return this.readConfigFile(this.getGlobalConfigPath());\r\n  }\r\n\r\n  private async getRepoOverrideConfig(projectPath: string): Promise<MCPConfig> {\r\n    return this.readConfigFile(this.getRepoOverridePath(projectPath));\r\n  }\r\n\r\n  private async saveGlobalConfig(config: MCPConfig): Promise<void> {\r\n    await this.ensureMuxRootDir();\r\n\r\n    const filePath = this.getGlobalConfigPath();\r\n\r\n    // Write minimal format:\r\n    // - string for stdio servers without extra settings\r\n    // - object when:\r\n    //   - disabled/toolAllowlist set, or\r\n    //   - non-stdio transport, or\r\n    //   - headers present\r\n    //\r\n    // toolAllowlist: undefined = all tools (omit), [] = no tools, [...] = those tools\r\n    const output: Record<string, unknown> = {};\r\n\r\n    for (const [name, entry] of Object.entries(config.servers)) {\r\n      const hasSettings = entry.disabled || entry.toolAllowlist !== undefined;\r\n\r\n      if (entry.transport === \"stdio\") {\r\n        if (!hasSettings) {\r\n          output[name] = entry.command;\r\n          continue;\r\n        }\r\n\r\n        const obj: Record<string, unknown> = {\r\n          command: entry.command,\r\n        };\r\n        if (entry.disabled) obj.disabled = true;\r\n        if (entry.toolAllowlist !== undefined) obj.toolAllowlist = entry.toolAllowlist;\r\n        output[name] = obj;\r\n        continue;\r\n      }\r\n\r\n      const obj: Record<string, unknown> = {\r\n        transport: entry.transport,\r\n        url: entry.url,\r\n      };\r\n      if (entry.headers) obj.headers = entry.headers;\r\n      if (entry.disabled) obj.disabled = true;\r\n      if (entry.toolAllowlist !== undefined) obj.toolAllowlist = entry.toolAllowlist;\r\n\r\n      output[name] = obj;\r\n    }\r\n\r\n    await writeFileAtomic(filePath, JSON.stringify({ servers: output }, null, 2), {\r\n      encoding: \"utf-8\",\r\n      mode: 0o600,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * List configured servers.\r\n   *\r\n   * - When no projectPath is provided: returns global servers from <muxHome>/mcp.jsonc\r\n   * - When projectPath is provided: merges global + <projectPath>/.mux/mcp.jsonc (override wins)\r\n   */\r\n  async listServers(projectPath?: string): Promise<Record<string, MCPServerInfo>> {\r\n    const globalCfg = await this.getGlobalConfig();\r\n\r\n    if (!projectPath) {\r\n      return globalCfg.servers;\r\n    }\r\n\r\n    const repoCfg = await this.getRepoOverrideConfig(projectPath);\r\n\r\n    // Repo overrides win by server name.\r\n    return {\r\n      ...globalCfg.servers,\r\n      ...repoCfg.servers,\r\n    };\r\n  }\r\n\r\n  async addServer(\r\n    name: string,\r\n    input: {\r\n      transport?: MCPServerTransport;\r\n      command?: string;\r\n      url?: string;\r\n      headers?: Record<string, MCPHeaderValue>;\r\n    }\r\n  ): Promise<Result<void>> {\r\n    if (!name.trim()) {\r\n      return Err(\"Server name is required\");\r\n    }\r\n\r\n    const transport: MCPServerTransport = input.transport ?? \"stdio\";\r\n\r\n    if (transport === \"stdio\") {\r\n      if (!input.command?.trim()) {\r\n        return Err(\"Command is required\");\r\n      }\r\n    } else {\r\n      if (!input.url?.trim()) {\r\n        return Err(\"URL is required\");\r\n      }\r\n    }\r\n\r\n    const cfg = await this.getGlobalConfig();\r\n    const existing = cfg.servers[name];\r\n\r\n    const base = {\r\n      disabled: existing?.disabled ?? false,\r\n      toolAllowlist: existing?.toolAllowlist,\r\n    };\r\n\r\n    const next: MCPServerInfo =\r\n      transport === \"stdio\"\r\n        ? {\r\n            transport: \"stdio\",\r\n            command: input.command!,\r\n            ...base,\r\n          }\r\n        : {\r\n            transport,\r\n            url: input.url!,\r\n            headers: input.headers,\r\n            ...base,\r\n          };\r\n\r\n    cfg.servers[name] = next;\r\n\r\n    try {\r\n      await this.saveGlobalConfig(cfg);\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      log.error(\"Failed to save MCP server\", { name, error });\r\n      return Err(error instanceof Error ? error.message : String(error));\r\n    }\r\n  }\r\n\r\n  async setServerEnabled(name: string, enabled: boolean): Promise<Result<void>> {\r\n    const cfg = await this.getGlobalConfig();\r\n    const entry = cfg.servers[name];\r\n    if (!entry) {\r\n      return Err(`Server ${name} not found`);\r\n    }\r\n    cfg.servers[name] = { ...entry, disabled: !enabled };\r\n    try {\r\n      await this.saveGlobalConfig(cfg);\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      log.error(\"Failed to update MCP server enabled state\", { name, error });\r\n      return Err(error instanceof Error ? error.message : String(error));\r\n    }\r\n  }\r\n\r\n  async removeServer(name: string): Promise<Result<void>> {\r\n    const cfg = await this.getGlobalConfig();\r\n    if (!cfg.servers[name]) {\r\n      return Err(`Server ${name} not found`);\r\n    }\r\n    delete cfg.servers[name];\r\n    try {\r\n      await this.saveGlobalConfig(cfg);\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      log.error(\"Failed to remove MCP server\", { name, error });\r\n      return Err(error instanceof Error ? error.message : String(error));\r\n    }\r\n  }\r\n\r\n  async setToolAllowlist(name: string, toolAllowlist: string[]): Promise<Result<void>> {\r\n    const cfg = await this.getGlobalConfig();\r\n    const entry = cfg.servers[name];\r\n    if (!entry) {\r\n      return Err(`Server ${name} not found`);\r\n    }\r\n\r\n    // [] = no tools allowed, [...tools] = those tools allowed\r\n    cfg.servers[name] = {\r\n      ...entry,\r\n      toolAllowlist,\r\n    };\r\n\r\n    try {\r\n      await this.saveGlobalConfig(cfg);\r\n      return Ok(undefined);\r\n    } catch (error) {\r\n      log.error(\"Failed to update MCP server tool allowlist\", { name, error });\r\n      return Err(error instanceof Error ? error.message : String(error));\r\n    }\r\n  }\r\n}\r\n"]}