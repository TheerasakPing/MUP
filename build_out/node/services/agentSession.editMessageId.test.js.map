{"version":3,"file":"agentSession.editMessageId.test.js","sourceRoot":"","sources":["../../../src/node/services/agentSession.editMessageId.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it, mock, afterEach, spyOn } from \"bun:test\";\r\nimport { EventEmitter } from \"events\";\r\nimport type { AIService } from \"@/node/services/aiService\";\r\nimport type { PartialService } from \"@/node/services/partialService\";\r\nimport type { InitStateManager } from \"@/node/services/initStateManager\";\r\nimport type { BackgroundProcessManager } from \"@/node/services/backgroundProcessManager\";\r\nimport type { Config } from \"@/node/config\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport type { SendMessageError } from \"@/common/types/errors\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok } from \"@/common/types/result\";\r\nimport { AgentSession } from \"./agentSession\";\r\nimport { createTestHistoryService } from \"./testHistoryService\";\r\nimport type { CostTrackingService } from \"./costTrackingService\";\r\n\r\ndescribe(\"AgentSession.sendMessage (editMessageId)\", () => {\r\n  let historyCleanup: (() => Promise<void>) | undefined;\r\n  afterEach(async () => {\r\n    await historyCleanup?.();\r\n  });\r\n\r\n  it(\"treats missing edit target as no-op (allows recovery after compaction)\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    const truncateAfterMessage = spyOn(historyService, \"truncateAfterMessage\");\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\");\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n    const streamMessage = mock((_messages: MuxMessage[]) => {\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      streamMessage: streamMessage as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.sendMessage(\"hello\", {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      editMessageId: \"missing-user-message-id\",\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(truncateAfterMessage.mock.calls).toHaveLength(1);\r\n    expect(appendToHistory.mock.calls).toHaveLength(1);\r\n    expect(streamMessage.mock.calls).toHaveLength(1);\r\n  });\r\n\r\n  it(\"clears image parts when editing with explicit empty fileParts\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const originalMessageId = \"user-message-with-image\";\r\n    const originalImageUrl = \"data:image/png;base64,AAAA\";\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    // Seed original message before setting up spies\r\n    await historyService.appendToHistory(\r\n      workspaceId,\r\n      createMuxMessage(originalMessageId, \"user\", \"original\", { historySequence: 0 }, [\r\n        { type: \"file\" as const, mediaType: \"image/png\", url: originalImageUrl },\r\n      ])\r\n    );\r\n\r\n    const truncateAfterMessage = spyOn(historyService, \"truncateAfterMessage\");\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\");\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n    const streamMessage = mock((_messages: MuxMessage[]) => {\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      streamMessage: streamMessage as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.sendMessage(\"edited\", {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      editMessageId: originalMessageId,\r\n      fileParts: [],\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(truncateAfterMessage.mock.calls).toHaveLength(1);\r\n    expect(appendToHistory.mock.calls).toHaveLength(1);\r\n\r\n    const appendedMessage = appendToHistory.mock.calls[0][1];\r\n    const appendedFileParts = appendedMessage.parts.filter(\r\n      (part) => part.type === \"file\"\r\n    ) as Array<{ type: \"file\"; url: string; mediaType: string }>;\r\n\r\n    expect(appendedFileParts).toHaveLength(0);\r\n  });\r\n  it(\"preserves image parts when editing and fileParts are omitted\", async () => {\r\n    const workspaceId = \"ws-test\";\r\n\r\n    const config = {\r\n      srcDir: \"/tmp\",\r\n      getSessionDir: (_workspaceId: string) => \"/tmp\",\r\n    } as unknown as Config;\r\n\r\n    const originalMessageId = \"user-message-with-image\";\r\n    const originalImageUrl = \"data:image/png;base64,AAAA\";\r\n\r\n    const { historyService, cleanup } = await createTestHistoryService();\r\n    historyCleanup = cleanup;\r\n\r\n    // Seed original message before setting up spies\r\n    await historyService.appendToHistory(\r\n      workspaceId,\r\n      createMuxMessage(originalMessageId, \"user\", \"original\", { historySequence: 0 }, [\r\n        { type: \"file\" as const, mediaType: \"image/png\", url: originalImageUrl },\r\n      ])\r\n    );\r\n\r\n    const truncateAfterMessage = spyOn(historyService, \"truncateAfterMessage\");\r\n    const appendToHistory = spyOn(historyService, \"appendToHistory\");\r\n    const getHistoryFromLatestBoundary = spyOn(historyService, \"getHistoryFromLatestBoundary\");\r\n\r\n    const partialService = {\r\n      commitToHistory: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n    } as unknown as PartialService;\r\n\r\n    const aiEmitter = new EventEmitter();\r\n    const streamMessage = mock((_messages: MuxMessage[]) => {\r\n      return Promise.resolve(Ok(undefined));\r\n    });\r\n    const aiService = Object.assign(aiEmitter, {\r\n      isStreaming: mock((_workspaceId: string) => false),\r\n      stopStream: mock((_workspaceId: string) => Promise.resolve(Ok(undefined))),\r\n      streamMessage: streamMessage as unknown as (\r\n        ...args: Parameters<AIService[\"streamMessage\"]>\r\n      ) => Promise<Result<void, SendMessageError>>,\r\n    }) as unknown as AIService;\r\n\r\n    const initStateManager = new EventEmitter() as unknown as InitStateManager;\r\n\r\n    const backgroundProcessManager = {\r\n      cleanup: mock((_workspaceId: string) => Promise.resolve()),\r\n      setMessageQueued: mock((_workspaceId: string, _queued: boolean) => {\r\n        void _queued;\r\n      }),\r\n    } as unknown as BackgroundProcessManager;\r\n\r\n    const session = new AgentSession({\r\n      workspaceId,\r\n      config,\r\n      historyService,\r\n      partialService,\r\n      aiService,\r\n      initStateManager,\r\n      costTrackingService: {} as unknown as CostTrackingService,\r\n      backgroundProcessManager,\r\n    });\r\n\r\n    const result = await session.sendMessage(\"edited\", {\r\n      model: \"anthropic:claude-3-5-sonnet-latest\",\r\n      agentId: \"exec\",\r\n      editMessageId: originalMessageId,\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getHistoryFromLatestBoundary.mock.calls.length).toBeGreaterThan(0);\r\n    expect(truncateAfterMessage.mock.calls).toHaveLength(1);\r\n    expect(appendToHistory.mock.calls).toHaveLength(1);\r\n\r\n    const appendedMessage = appendToHistory.mock.calls[0][1];\r\n    const appendedFileParts = appendedMessage.parts.filter(\r\n      (part) => part.type === \"file\"\r\n    ) as Array<{ type: \"file\"; url: string; mediaType: string }>;\r\n\r\n    expect(appendedFileParts).toHaveLength(1);\r\n    expect(appendedFileParts[0].url).toBe(originalImageUrl);\r\n    expect(appendedFileParts[0].mediaType).toBe(\"image/png\");\r\n  });\r\n});\r\n"]}