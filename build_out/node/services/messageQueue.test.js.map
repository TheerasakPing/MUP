{"version":3,"file":"messageQueue.test.js","sourceRoot":"","sources":["../../../src/node/services/messageQueue.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach } from \"bun:test\";\r\nimport { MessageQueue } from \"./messageQueue\";\r\nimport type { MuxFrontendMetadata } from \"@/common/types/message\";\r\nimport type { SendMessageOptions } from \"@/common/orpc/types\";\r\n\r\ndescribe(\"MessageQueue\", () => {\r\n  let queue: MessageQueue;\r\n\r\n  beforeEach(() => {\r\n    queue = new MessageQueue();\r\n  });\r\n\r\n  describe(\"getDisplayText\", () => {\r\n    it(\"should return joined messages for normal messages\", () => {\r\n      queue.add(\"First message\");\r\n      queue.add(\"Second message\");\r\n\r\n      expect(queue.getDisplayText()).toBe(\"First message\\nSecond message\");\r\n    });\r\n\r\n    it(\"should return rawCommand for compaction request\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact -t 3000\",\r\n        parsed: { maxOutputTokens: 3000 },\r\n      };\r\n\r\n      const options: SendMessageOptions = {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      };\r\n\r\n      queue.add(\"Summarize this conversation into a compact form...\", options);\r\n\r\n      expect(queue.getDisplayText()).toBe(\"/compact -t 3000\");\r\n    });\r\n\r\n    it(\"should throw when adding compaction after normal message\", () => {\r\n      queue.add(\"First message\");\r\n\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact\",\r\n        parsed: {},\r\n      };\r\n\r\n      const options: SendMessageOptions = {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      };\r\n\r\n      // Compaction requests cannot be mixed with other messages to prevent\r\n      // silent failures where compaction metadata would be lost\r\n      expect(() => queue.add(\"Summarize this conversation...\", options)).toThrow(\r\n        /Cannot queue compaction request/\r\n      );\r\n    });\r\n\r\n    it(\"should return joined messages when metadata type is not compaction-request\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"normal\",\r\n      };\r\n\r\n      const options: SendMessageOptions = {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      };\r\n\r\n      queue.add(\"Regular message\", options);\r\n\r\n      expect(queue.getDisplayText()).toBe(\"Regular message\");\r\n    });\r\n\r\n    it(\"should return empty string for empty queue\", () => {\r\n      expect(queue.getDisplayText()).toBe(\"\");\r\n    });\r\n\r\n    it(\"should return joined messages after clearing compaction metadata\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact\",\r\n        parsed: {},\r\n      };\r\n\r\n      const options: SendMessageOptions = {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      };\r\n\r\n      queue.add(\"Summarize this...\", options);\r\n      queue.clear();\r\n      queue.add(\"New message\");\r\n\r\n      expect(queue.getDisplayText()).toBe(\"New message\");\r\n    });\r\n  });\r\n\r\n  describe(\"getMessages\", () => {\r\n    it(\"should return raw messages even for compaction requests\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact\",\r\n        parsed: {},\r\n      };\r\n\r\n      const options: SendMessageOptions = {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      };\r\n\r\n      queue.add(\"Summarize this conversation...\", options);\r\n\r\n      // getMessages should return the actual message text for editing\r\n      expect(queue.getMessages()).toEqual([\"Summarize this conversation...\"]);\r\n      // getDisplayText should return the slash command\r\n      expect(queue.getDisplayText()).toBe(\"/compact\");\r\n    });\r\n  });\r\n\r\n  describe(\"hasCompactionRequest\", () => {\r\n    it(\"should return false for empty queue\", () => {\r\n      expect(queue.hasCompactionRequest()).toBe(false);\r\n    });\r\n\r\n    it(\"should return false for normal messages\", () => {\r\n      queue.add(\"Regular message\", { model: \"gpt-4\", agentId: \"exec\" });\r\n      expect(queue.hasCompactionRequest()).toBe(false);\r\n    });\r\n\r\n    it(\"should return true when compaction request is queued\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact\",\r\n        parsed: {},\r\n      };\r\n\r\n      queue.add(\"Summarize...\", {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      });\r\n\r\n      expect(queue.hasCompactionRequest()).toBe(true);\r\n    });\r\n\r\n    it(\"should return false after clearing\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact\",\r\n        parsed: {},\r\n      };\r\n\r\n      queue.add(\"Summarize...\", {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      });\r\n      queue.clear();\r\n\r\n      expect(queue.hasCompactionRequest()).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"addOnce\", () => {\r\n    it(\"should dedupe repeated entries by key\", () => {\r\n      const image = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      const addedFirst = queue.addOnce(\r\n        \"Follow up\",\r\n        { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] },\r\n        \"follow-up\"\r\n      );\r\n      const addedSecond = queue.addOnce(\r\n        \"Follow up\",\r\n        { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] },\r\n        \"follow-up\"\r\n      );\r\n\r\n      expect(addedFirst).toBe(true);\r\n      expect(addedSecond).toBe(false);\r\n      expect(queue.getMessages()).toEqual([\"Follow up\"]);\r\n      expect(queue.getFileParts()).toEqual([image]);\r\n    });\r\n  });\r\n\r\n  describe(\"multi-message batching\", () => {\r\n    it(\"should batch multiple follow-up messages\", () => {\r\n      queue.add(\"First message\");\r\n      queue.add(\"Second message\");\r\n      queue.add(\"Third message\");\r\n\r\n      expect(queue.getMessages()).toEqual([\"First message\", \"Second message\", \"Third message\"]);\r\n      expect(queue.getDisplayText()).toBe(\"First message\\nSecond message\\nThird message\");\r\n    });\r\n\r\n    it(\"should preserve compaction metadata when follow-up is added\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"compaction-request\",\r\n        rawCommand: \"/compact\",\r\n        parsed: {},\r\n      };\r\n\r\n      queue.add(\"Summarize...\", {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      });\r\n      queue.add(\"And then do this follow-up task\");\r\n\r\n      // Display shows all messages (multiple messages = not just compaction)\r\n      expect(queue.getDisplayText()).toBe(\"Summarize...\\nAnd then do this follow-up task\");\r\n\r\n      // getMessages includes both\r\n      expect(queue.getMessages()).toEqual([\"Summarize...\", \"And then do this follow-up task\"]);\r\n\r\n      // produceMessage preserves compaction metadata from first message\r\n      const { message, options } = queue.produceMessage();\r\n      expect(message).toBe(\"Summarize...\\nAnd then do this follow-up task\");\r\n      const muxMeta = options?.muxMetadata as MuxFrontendMetadata;\r\n      expect(muxMeta.type).toBe(\"compaction-request\");\r\n      if (muxMeta.type === \"compaction-request\") {\r\n        expect(muxMeta.rawCommand).toBe(\"/compact\");\r\n      }\r\n    });\r\n\r\n    it(\"should throw when adding agent-skill invocation after normal message\", () => {\r\n      queue.add(\"First message\");\r\n\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"agent-skill\",\r\n        rawCommand: \"/init\",\r\n        skillName: \"init\",\r\n        scope: \"built-in\",\r\n      };\r\n\r\n      const options: SendMessageOptions = {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      };\r\n\r\n      expect(() => queue.add(\"Using skill init\", options)).toThrow(\r\n        /Cannot queue agent skill invocation/\r\n      );\r\n    });\r\n\r\n    it(\"should throw when adding normal message after agent-skill invocation\", () => {\r\n      const metadata: MuxFrontendMetadata = {\r\n        type: \"agent-skill\",\r\n        rawCommand: \"/init\",\r\n        skillName: \"init\",\r\n        scope: \"built-in\",\r\n      };\r\n\r\n      queue.add(\"Use skill init\", {\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        agentId: \"exec\",\r\n        muxMetadata: metadata,\r\n      });\r\n\r\n      expect(queue.getDisplayText()).toBe(\"/init\");\r\n\r\n      expect(() => queue.add(\"Follow-up message\")).toThrow(\r\n        /agent skill invocation is already queued/\r\n      );\r\n    });\r\n\r\n    it(\"should produce combined message for API call\", () => {\r\n      queue.add(\"First message\", { model: \"gpt-4\", agentId: \"exec\" });\r\n      queue.add(\"Second message\");\r\n\r\n      const { message, options } = queue.produceMessage();\r\n\r\n      // Messages are joined with newlines\r\n      expect(message).toBe(\"First message\\nSecond message\");\r\n      // Latest options are used\r\n      expect(options?.model).toBe(\"gpt-4\");\r\n    });\r\n\r\n    it(\"should batch messages with mixed images\", () => {\r\n      const image1 = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      const image2 = { url: \"data:image/jpeg;base64,def\", mediaType: \"image/jpeg\" };\r\n\r\n      queue.add(\"Message with image\", {\r\n        model: \"gpt-4\",\r\n        agentId: \"exec\",\r\n        fileParts: [image1],\r\n      });\r\n      queue.add(\"Follow-up without image\");\r\n      queue.add(\"Another with image\", {\r\n        model: \"gpt-4\",\r\n        agentId: \"exec\",\r\n        fileParts: [image2],\r\n      });\r\n\r\n      expect(queue.getMessages()).toEqual([\r\n        \"Message with image\",\r\n        \"Follow-up without image\",\r\n        \"Another with image\",\r\n      ]);\r\n      expect(queue.getFileParts()).toEqual([image1, image2]);\r\n      expect(queue.getDisplayText()).toBe(\r\n        \"Message with image\\nFollow-up without image\\nAnother with image\"\r\n      );\r\n    });\r\n  });\r\n\r\n  describe(\"getFileParts\", () => {\r\n    it(\"should return accumulated images from multiple messages\", () => {\r\n      const image1 = {\r\n        url: \"data:image/png;base64,abc\",\r\n        mediaType: \"image/png\",\r\n      };\r\n      const image2 = {\r\n        url: \"data:image/jpeg;base64,def\",\r\n        mediaType: \"image/jpeg\",\r\n      };\r\n      const image3 = {\r\n        url: \"data:image/gif;base64,ghi\",\r\n        mediaType: \"image/gif\",\r\n      };\r\n\r\n      queue.add(\"First message\", {\r\n        model: \"gpt-4\",\r\n        agentId: \"exec\",\r\n        fileParts: [image1],\r\n      });\r\n      queue.add(\"Second message\", {\r\n        model: \"gpt-4\",\r\n        agentId: \"exec\",\r\n        fileParts: [image2, image3],\r\n      });\r\n\r\n      const images = queue.getFileParts();\r\n      expect(images).toEqual([image1, image2, image3]);\r\n    });\r\n\r\n    it(\"should return empty array when no images\", () => {\r\n      queue.add(\"Text only message\");\r\n      expect(queue.getFileParts()).toEqual([]);\r\n    });\r\n\r\n    it(\"should return copy of images array\", () => {\r\n      const image = {\r\n        type: \"file\" as const,\r\n        url: \"data:image/png;base64,abc\",\r\n        mediaType: \"image/png\",\r\n      };\r\n      queue.add(\"Message\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] });\r\n\r\n      const images1 = queue.getFileParts();\r\n      const images2 = queue.getFileParts();\r\n\r\n      expect(images1).toEqual(images2);\r\n      expect(images1).not.toBe(images2); // Different array instances\r\n    });\r\n\r\n    it(\"should clear images when queue is cleared\", () => {\r\n      const image = {\r\n        url: \"data:image/png;base64,abc\",\r\n        mediaType: \"image/png\",\r\n      };\r\n      queue.add(\"Message\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] });\r\n\r\n      expect(queue.getFileParts()).toHaveLength(1);\r\n\r\n      queue.clear();\r\n      expect(queue.getFileParts()).toEqual([]);\r\n    });\r\n  });\r\n\r\n  describe(\"image-only messages\", () => {\r\n    it(\"should accept image-only messages (empty text with images)\", () => {\r\n      const image = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      queue.add(\"\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] });\r\n\r\n      expect(queue.getMessages()).toEqual([]);\r\n      expect(queue.getFileParts()).toEqual([image]);\r\n      expect(queue.isEmpty()).toBe(false);\r\n    });\r\n\r\n    it(\"should reject messages with empty text and no images\", () => {\r\n      queue.add(\"\", { model: \"gpt-4\", agentId: \"exec\" });\r\n\r\n      expect(queue.isEmpty()).toBe(true);\r\n      expect(queue.getMessages()).toEqual([]);\r\n      expect(queue.getFileParts()).toEqual([]);\r\n    });\r\n\r\n    it(\"should handle mixed text and image-only messages\", () => {\r\n      const image1 = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      const image2 = { url: \"data:image/jpeg;base64,def\", mediaType: \"image/jpeg\" };\r\n\r\n      queue.add(\"Text message\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image1] });\r\n      queue.add(\"\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image2] }); // Image-only\r\n\r\n      expect(queue.getMessages()).toEqual([\"Text message\"]);\r\n      expect(queue.getFileParts()).toEqual([image1, image2]);\r\n      expect(queue.isEmpty()).toBe(false);\r\n    });\r\n\r\n    it(\"should consider queue non-empty when only images present\", () => {\r\n      const image = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      queue.add(\"\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] });\r\n\r\n      expect(queue.isEmpty()).toBe(false);\r\n    });\r\n\r\n    it(\"should produce correct message for image-only queue\", () => {\r\n      const image = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      queue.add(\"\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] });\r\n\r\n      const { message, options } = queue.produceMessage();\r\n\r\n      expect(message).toBe(\"\");\r\n      expect(options?.fileParts).toEqual([image]);\r\n      expect(options?.model).toBe(\"gpt-4\");\r\n    });\r\n\r\n    it(\"should return empty string for getDisplayText with image-only\", () => {\r\n      const image = { url: \"data:image/png;base64,abc\", mediaType: \"image/png\" };\r\n      queue.add(\"\", { model: \"gpt-4\", agentId: \"exec\", fileParts: [image] });\r\n\r\n      expect(queue.getDisplayText()).toBe(\"\");\r\n    });\r\n  });\r\n});\r\n"]}