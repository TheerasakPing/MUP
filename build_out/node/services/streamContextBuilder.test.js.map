{"version":3,"file":"streamContextBuilder.test.js","sourceRoot":"","sources":["../../../src/node/services/streamContextBuilder.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\r\nimport * as path from \"node:path\";\r\n\r\nimport { describe, expect, test } from \"bun:test\";\r\n\r\nimport { DEFAULT_RUNTIME_CONFIG } from \"@/common/constants/workspace\";\r\nimport { sliceMessagesFromLatestCompactionBoundary } from \"@/common/utils/messages/compactionBoundary\";\r\nimport { createMuxMessage } from \"@/common/types/message\";\r\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\r\nimport { DEFAULT_TASK_SETTINGS } from \"@/common/types/tasks\";\r\nimport { getPlanFilePath } from \"@/common/utils/planStorage\";\r\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\r\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\r\n\r\nimport { buildPlanInstructions } from \"./streamContextBuilder\";\r\n\r\nclass TestRuntime extends LocalRuntime {\r\n  constructor(\r\n    projectPath: string,\r\n    private readonly muxHomePath: string\r\n  ) {\r\n    super(projectPath);\r\n  }\r\n\r\n  override getMuxHome(): string {\r\n    return this.muxHomePath;\r\n  }\r\n}\r\n\r\ndescribe(\"buildPlanInstructions\", () => {\r\n  test(\"uses request payload history for Start Here detection\", async () => {\r\n    using tempRoot = new DisposableTempDir(\"stream-context-builder\");\r\n\r\n    const projectPath = path.join(tempRoot.path, \"project\");\r\n    const muxHome = path.join(tempRoot.path, \"mux-home\");\r\n    await fs.mkdir(projectPath, { recursive: true });\r\n    await fs.mkdir(muxHome, { recursive: true });\r\n\r\n    const metadata: WorkspaceMetadata = {\r\n      id: \"ws-1\",\r\n      name: \"workspace-1\",\r\n      projectName: \"project-1\",\r\n      projectPath,\r\n      runtimeConfig: DEFAULT_RUNTIME_CONFIG,\r\n    };\r\n\r\n    const runtime = new TestRuntime(projectPath, muxHome);\r\n\r\n    const planFilePath = getPlanFilePath(metadata.name, metadata.projectName, muxHome);\r\n    await fs.mkdir(path.dirname(planFilePath), { recursive: true });\r\n    await fs.writeFile(planFilePath, \"# Plan\\n\\n- Keep implementing\", \"utf-8\");\r\n\r\n    const startHereSummary = createMuxMessage(\r\n      \"start-here\",\r\n      \"assistant\",\r\n      \"# Start Here\\n\\n- Existing plan context\\n\\n*Plan file preserved at:* /tmp/plan.md\",\r\n      {\r\n        compacted: \"user\",\r\n        agentId: \"plan\",\r\n      }\r\n    );\r\n\r\n    const compactionBoundary = createMuxMessage(\"boundary\", \"assistant\", \"Compacted summary\", {\r\n      compacted: \"user\",\r\n      compactionBoundary: true,\r\n      compactionEpoch: 1,\r\n    });\r\n\r\n    const latestUserMessage = createMuxMessage(\"u1\", \"user\", \"continue implementation\");\r\n\r\n    const fullHistory = [startHereSummary, compactionBoundary, latestUserMessage];\r\n    const requestPayloadMessages = sliceMessagesFromLatestCompactionBoundary(fullHistory);\r\n\r\n    expect(requestPayloadMessages.map((message) => message.id)).toEqual([\"boundary\", \"u1\"]);\r\n\r\n    const fromSlicedPayload = await buildPlanInstructions({\r\n      runtime,\r\n      metadata,\r\n      workspaceId: metadata.id,\r\n      workspacePath: projectPath,\r\n      effectiveMode: \"exec\",\r\n      effectiveAgentId: \"exec\",\r\n      agentIsPlanLike: false,\r\n      agentDiscoveryPath: projectPath,\r\n      additionalSystemInstructions: undefined,\r\n      shouldDisableTaskToolsForDepth: false,\r\n      taskDepth: 0,\r\n      taskSettings: DEFAULT_TASK_SETTINGS,\r\n      requestPayloadMessages,\r\n    });\r\n\r\n    const fromFullHistory = await buildPlanInstructions({\r\n      runtime,\r\n      metadata,\r\n      workspaceId: metadata.id,\r\n      workspacePath: projectPath,\r\n      effectiveMode: \"exec\",\r\n      effectiveAgentId: \"exec\",\r\n      agentIsPlanLike: false,\r\n      agentDiscoveryPath: projectPath,\r\n      additionalSystemInstructions: undefined,\r\n      shouldDisableTaskToolsForDepth: false,\r\n      taskDepth: 0,\r\n      taskSettings: DEFAULT_TASK_SETTINGS,\r\n      requestPayloadMessages: fullHistory,\r\n    });\r\n\r\n    expect(fromSlicedPayload.effectiveAdditionalInstructions).toContain(\r\n      `A plan file exists at: ${fromSlicedPayload.planFilePath}`\r\n    );\r\n    expect(fromFullHistory.effectiveAdditionalInstructions).toBeUndefined();\r\n  });\r\n});\r\n"]}