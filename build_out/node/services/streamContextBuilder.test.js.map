{"version":3,"file":"streamContextBuilder.test.js","sourceRoot":"","sources":["../../../src/node/services/streamContextBuilder.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\n\nimport { describe, expect, test } from \"bun:test\";\n\nimport { DEFAULT_RUNTIME_CONFIG } from \"@/common/constants/workspace\";\nimport { sliceMessagesFromLatestCompactionBoundary } from \"@/common/utils/messages/compactionBoundary\";\nimport { createMuxMessage } from \"@/common/types/message\";\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\nimport { DEFAULT_TASK_SETTINGS } from \"@/common/types/tasks\";\nimport { getPlanFilePath } from \"@/common/utils/planStorage\";\nimport { LocalRuntime } from \"@/node/runtime/LocalRuntime\";\nimport { DisposableTempDir } from \"@/node/services/tempDir\";\n\nimport { buildPlanInstructions } from \"./streamContextBuilder\";\n\nclass TestRuntime extends LocalRuntime {\n  constructor(\n    projectPath: string,\n    private readonly muxHomePath: string\n  ) {\n    super(projectPath);\n  }\n\n  override getMuxHome(): string {\n    return this.muxHomePath;\n  }\n}\n\ndescribe(\"buildPlanInstructions\", () => {\n  test(\"uses request payload history for Start Here detection\", async () => {\n    using tempRoot = new DisposableTempDir(\"stream-context-builder\");\n\n    const projectPath = path.join(tempRoot.path, \"project\");\n    const muxHome = path.join(tempRoot.path, \"mux-home\");\n    await fs.mkdir(projectPath, { recursive: true });\n    await fs.mkdir(muxHome, { recursive: true });\n\n    const metadata: WorkspaceMetadata = {\n      id: \"ws-1\",\n      name: \"workspace-1\",\n      projectName: \"project-1\",\n      projectPath,\n      runtimeConfig: DEFAULT_RUNTIME_CONFIG,\n    };\n\n    const runtime = new TestRuntime(projectPath, muxHome);\n\n    const planFilePath = getPlanFilePath(metadata.name, metadata.projectName, muxHome);\n    await fs.mkdir(path.dirname(planFilePath), { recursive: true });\n    await fs.writeFile(planFilePath, \"# Plan\\n\\n- Keep implementing\", \"utf-8\");\n\n    const startHereSummary = createMuxMessage(\n      \"start-here\",\n      \"assistant\",\n      \"# Start Here\\n\\n- Existing plan context\\n\\n*Plan file preserved at:* /tmp/plan.md\",\n      {\n        compacted: \"user\",\n        agentId: \"plan\",\n      }\n    );\n\n    const compactionBoundary = createMuxMessage(\"boundary\", \"assistant\", \"Compacted summary\", {\n      compacted: \"user\",\n      compactionBoundary: true,\n      compactionEpoch: 1,\n    });\n\n    const latestUserMessage = createMuxMessage(\"u1\", \"user\", \"continue implementation\");\n\n    const fullHistory = [startHereSummary, compactionBoundary, latestUserMessage];\n    const requestPayloadMessages = sliceMessagesFromLatestCompactionBoundary(fullHistory);\n\n    expect(requestPayloadMessages.map((message) => message.id)).toEqual([\"boundary\", \"u1\"]);\n\n    const fromSlicedPayload = await buildPlanInstructions({\n      runtime,\n      metadata,\n      workspaceId: metadata.id,\n      workspacePath: projectPath,\n      effectiveMode: \"exec\",\n      effectiveAgentId: \"exec\",\n      agentIsPlanLike: false,\n      agentDiscoveryPath: projectPath,\n      additionalSystemInstructions: undefined,\n      shouldDisableTaskToolsForDepth: false,\n      taskDepth: 0,\n      taskSettings: DEFAULT_TASK_SETTINGS,\n      requestPayloadMessages,\n    });\n\n    const fromFullHistory = await buildPlanInstructions({\n      runtime,\n      metadata,\n      workspaceId: metadata.id,\n      workspacePath: projectPath,\n      effectiveMode: \"exec\",\n      effectiveAgentId: \"exec\",\n      agentIsPlanLike: false,\n      agentDiscoveryPath: projectPath,\n      additionalSystemInstructions: undefined,\n      shouldDisableTaskToolsForDepth: false,\n      taskDepth: 0,\n      taskSettings: DEFAULT_TASK_SETTINGS,\n      requestPayloadMessages: fullHistory,\n    });\n\n    expect(fromSlicedPayload.effectiveAdditionalInstructions).toContain(\n      `A plan file exists at: ${fromSlicedPayload.planFilePath}`\n    );\n    expect(fromFullHistory.effectiveAdditionalInstructions).toBeUndefined();\n  });\n});\n"]}