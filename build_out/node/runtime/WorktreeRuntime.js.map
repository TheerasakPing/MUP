{"version":3,"file":"WorktreeRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/WorktreeRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\r\n  EnsureReadyOptions,\r\n  EnsureReadyResult,\r\n  WorkspaceCreationParams,\r\n  WorkspaceCreationResult,\r\n  WorkspaceInitParams,\r\n  WorkspaceInitResult,\r\n  WorkspaceForkParams,\r\n  WorkspaceForkResult,\r\n} from \"./Runtime\";\r\nimport { WORKSPACE_REPO_MISSING_ERROR } from \"./Runtime\";\r\nimport { checkInitHookExists, getMuxEnv } from \"./initHook\";\r\nimport { LocalBaseRuntime } from \"./LocalBaseRuntime\";\r\nimport { getErrorMessage } from \"@/common/utils/errors\";\r\nimport { isGitRepository } from \"@/node/utils/pathUtils\";\r\nimport { WorktreeManager } from \"@/node/worktree/WorktreeManager\";\r\n\r\n/**\r\n * Worktree runtime implementation that executes commands and file operations\r\n * directly on the host machine using Node.js APIs.\r\n *\r\n * This runtime uses git worktrees for workspace isolation:\r\n * - Workspaces are created in {srcBaseDir}/{projectName}/{workspaceName}\r\n * - Each workspace is a git worktree with its own branch\r\n */\r\nexport class WorktreeRuntime extends LocalBaseRuntime {\r\n  private readonly worktreeManager: WorktreeManager;\r\n  private readonly currentProjectPath?: string;\r\n  private readonly currentWorkspaceName?: string;\r\n\r\n  constructor(\r\n    srcBaseDir: string,\r\n    options?: {\r\n      projectPath?: string;\r\n      workspaceName?: string;\r\n    }\r\n  ) {\r\n    super();\r\n    this.worktreeManager = new WorktreeManager(srcBaseDir);\r\n    this.currentProjectPath = options?.projectPath;\r\n    this.currentWorkspaceName = options?.workspaceName;\r\n  }\r\n\r\n  getWorkspacePath(projectPath: string, workspaceName: string): string {\r\n    return this.worktreeManager.getWorkspacePath(projectPath, workspaceName);\r\n  }\r\n\r\n  override async ensureReady(options?: EnsureReadyOptions): Promise<EnsureReadyResult> {\r\n    if (!this.currentProjectPath || !this.currentWorkspaceName) {\r\n      return { ready: true };\r\n    }\r\n\r\n    const statusSink = options?.statusSink;\r\n    statusSink?.({\r\n      phase: \"checking\",\r\n      runtimeType: \"worktree\",\r\n      detail: \"Checking repository...\",\r\n    });\r\n\r\n    const workspacePath = this.getWorkspacePath(this.currentProjectPath, this.currentWorkspaceName);\r\n    const hasRepo = await isGitRepository(workspacePath);\r\n    if (!hasRepo) {\r\n      statusSink?.({\r\n        phase: \"error\",\r\n        runtimeType: \"worktree\",\r\n        detail: WORKSPACE_REPO_MISSING_ERROR,\r\n      });\r\n      return {\r\n        ready: false,\r\n        error: WORKSPACE_REPO_MISSING_ERROR,\r\n        errorType: \"runtime_not_ready\",\r\n      };\r\n    }\r\n\r\n    statusSink?.({ phase: \"ready\", runtimeType: \"worktree\" });\r\n    return { ready: true };\r\n  }\r\n\r\n  async createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult> {\r\n    return this.worktreeManager.createWorkspace({\r\n      projectPath: params.projectPath,\r\n      branchName: params.branchName,\r\n      trunkBranch: params.trunkBranch,\r\n      initLogger: params.initLogger,\r\n    });\r\n  }\r\n\r\n  async initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult> {\r\n    const { projectPath, branchName, workspacePath, initLogger, abortSignal, env, skipInitHook } =\r\n      params;\r\n\r\n    try {\r\n      if (skipInitHook) {\r\n        initLogger.logStep(\"Skipping .mux/init hook (disabled for this task)\");\r\n        initLogger.logComplete(0);\r\n        return { success: true };\r\n      }\r\n\r\n      // Run .mux/init hook if it exists\r\n      // Note: runInitHook calls logComplete() internally if hook exists\r\n      const hookExists = await checkInitHookExists(projectPath);\r\n      if (hookExists) {\r\n        initLogger.enterHookPhase?.();\r\n        const muxEnv = { ...env, ...getMuxEnv(projectPath, \"worktree\", branchName) };\r\n        await this.runInitHook(workspacePath, muxEnv, initLogger, abortSignal);\r\n      } else {\r\n        // No hook - signal completion immediately\r\n        initLogger.logComplete(0);\r\n      }\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMsg = getErrorMessage(error);\r\n      initLogger.logStderr(`Initialization failed: ${errorMsg}`);\r\n      initLogger.logComplete(-1);\r\n      return {\r\n        success: false,\r\n        error: errorMsg,\r\n      };\r\n    }\r\n  }\r\n\r\n  async renameWorkspace(\r\n    projectPath: string,\r\n    oldName: string,\r\n    newName: string,\r\n    _abortSignal?: AbortSignal\r\n  ): Promise<\r\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\r\n  > {\r\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\r\n    return this.worktreeManager.renameWorkspace(projectPath, oldName, newName);\r\n  }\r\n\r\n  async deleteWorkspace(\r\n    projectPath: string,\r\n    workspaceName: string,\r\n    force: boolean,\r\n    _abortSignal?: AbortSignal\r\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }> {\r\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\r\n    return this.worktreeManager.deleteWorkspace(projectPath, workspaceName, force);\r\n  }\r\n\r\n  async forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult> {\r\n    return this.worktreeManager.forkWorkspace(params);\r\n  }\r\n}\r\n"]}