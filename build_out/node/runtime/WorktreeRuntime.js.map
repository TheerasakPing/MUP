{"version":3,"file":"WorktreeRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/WorktreeRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  EnsureReadyOptions,\n  EnsureReadyResult,\n  WorkspaceCreationParams,\n  WorkspaceCreationResult,\n  WorkspaceInitParams,\n  WorkspaceInitResult,\n  WorkspaceForkParams,\n  WorkspaceForkResult,\n} from \"./Runtime\";\nimport { WORKSPACE_REPO_MISSING_ERROR } from \"./Runtime\";\nimport { checkInitHookExists, getMuxEnv } from \"./initHook\";\nimport { LocalBaseRuntime } from \"./LocalBaseRuntime\";\nimport { getErrorMessage } from \"@/common/utils/errors\";\nimport { isGitRepository } from \"@/node/utils/pathUtils\";\nimport { WorktreeManager } from \"@/node/worktree/WorktreeManager\";\n\n/**\n * Worktree runtime implementation that executes commands and file operations\n * directly on the host machine using Node.js APIs.\n *\n * This runtime uses git worktrees for workspace isolation:\n * - Workspaces are created in {srcBaseDir}/{projectName}/{workspaceName}\n * - Each workspace is a git worktree with its own branch\n */\nexport class WorktreeRuntime extends LocalBaseRuntime {\n  private readonly worktreeManager: WorktreeManager;\n  private readonly currentProjectPath?: string;\n  private readonly currentWorkspaceName?: string;\n\n  constructor(\n    srcBaseDir: string,\n    options?: {\n      projectPath?: string;\n      workspaceName?: string;\n    }\n  ) {\n    super();\n    this.worktreeManager = new WorktreeManager(srcBaseDir);\n    this.currentProjectPath = options?.projectPath;\n    this.currentWorkspaceName = options?.workspaceName;\n  }\n\n  getWorkspacePath(projectPath: string, workspaceName: string): string {\n    return this.worktreeManager.getWorkspacePath(projectPath, workspaceName);\n  }\n\n  override async ensureReady(options?: EnsureReadyOptions): Promise<EnsureReadyResult> {\n    if (!this.currentProjectPath || !this.currentWorkspaceName) {\n      return { ready: true };\n    }\n\n    const statusSink = options?.statusSink;\n    statusSink?.({\n      phase: \"checking\",\n      runtimeType: \"worktree\",\n      detail: \"Checking repository...\",\n    });\n\n    const workspacePath = this.getWorkspacePath(this.currentProjectPath, this.currentWorkspaceName);\n    const hasRepo = await isGitRepository(workspacePath);\n    if (!hasRepo) {\n      statusSink?.({\n        phase: \"error\",\n        runtimeType: \"worktree\",\n        detail: WORKSPACE_REPO_MISSING_ERROR,\n      });\n      return {\n        ready: false,\n        error: WORKSPACE_REPO_MISSING_ERROR,\n        errorType: \"runtime_not_ready\",\n      };\n    }\n\n    statusSink?.({ phase: \"ready\", runtimeType: \"worktree\" });\n    return { ready: true };\n  }\n\n  async createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult> {\n    return this.worktreeManager.createWorkspace({\n      projectPath: params.projectPath,\n      branchName: params.branchName,\n      trunkBranch: params.trunkBranch,\n      initLogger: params.initLogger,\n    });\n  }\n\n  async initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult> {\n    const { projectPath, branchName, workspacePath, initLogger, abortSignal, env, skipInitHook } =\n      params;\n\n    try {\n      if (skipInitHook) {\n        initLogger.logStep(\"Skipping .mux/init hook (disabled for this task)\");\n        initLogger.logComplete(0);\n        return { success: true };\n      }\n\n      // Run .mux/init hook if it exists\n      // Note: runInitHook calls logComplete() internally if hook exists\n      const hookExists = await checkInitHookExists(projectPath);\n      if (hookExists) {\n        initLogger.enterHookPhase?.();\n        const muxEnv = { ...env, ...getMuxEnv(projectPath, \"worktree\", branchName) };\n        await this.runInitHook(workspacePath, muxEnv, initLogger, abortSignal);\n      } else {\n        // No hook - signal completion immediately\n        initLogger.logComplete(0);\n      }\n      return { success: true };\n    } catch (error) {\n      const errorMsg = getErrorMessage(error);\n      initLogger.logStderr(`Initialization failed: ${errorMsg}`);\n      initLogger.logComplete(-1);\n      return {\n        success: false,\n        error: errorMsg,\n      };\n    }\n  }\n\n  async renameWorkspace(\n    projectPath: string,\n    oldName: string,\n    newName: string,\n    _abortSignal?: AbortSignal\n  ): Promise<\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\n  > {\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\n    return this.worktreeManager.renameWorkspace(projectPath, oldName, newName);\n  }\n\n  async deleteWorkspace(\n    projectPath: string,\n    workspaceName: string,\n    force: boolean,\n    _abortSignal?: AbortSignal\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }> {\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\n    return this.worktreeManager.deleteWorkspace(projectPath, workspaceName, force);\n  }\n\n  async forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult> {\n    return this.worktreeManager.forkWorkspace(params);\n  }\n}\n"]}