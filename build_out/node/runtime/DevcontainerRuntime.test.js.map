{"version":3,"file":"DevcontainerRuntime.test.js","sourceRoot":"","sources":["../../../src/node/runtime/DevcontainerRuntime.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from \"bun:test\";\nimport { DevcontainerRuntime } from \"./DevcontainerRuntime\";\n\ninterface RuntimeState {\n  remoteHomeDir?: string;\n  remoteUser?: string;\n  remoteWorkspaceFolder?: string;\n  currentWorkspacePath?: string;\n}\n\nfunction createRuntime(state: RuntimeState): DevcontainerRuntime {\n  const runtime = new DevcontainerRuntime({\n    srcBaseDir: \"/tmp/mux\",\n    configPath: \".devcontainer/devcontainer.json\",\n  });\n  const internal = runtime as unknown as RuntimeState;\n  internal.remoteHomeDir = state.remoteHomeDir;\n  internal.remoteUser = state.remoteUser;\n  internal.remoteWorkspaceFolder = state.remoteWorkspaceFolder;\n  internal.currentWorkspacePath = state.currentWorkspacePath;\n  return runtime;\n}\n\ndescribe(\"DevcontainerRuntime.resolvePath\", () => {\n  it(\"resolves ~ to cached remoteHomeDir\", async () => {\n    const runtime = createRuntime({ remoteHomeDir: \"/home/coder\" });\n    expect(await runtime.resolvePath(\"~\")).toBe(\"/home/coder\");\n  });\n\n  it(\"throws when home is unknown\", async () => {\n    const runtime = createRuntime({});\n    // eslint-disable-next-line @typescript-eslint/await-thenable -- bun:test expect().rejects requires await\n    await expect(runtime.resolvePath(\"~\")).rejects.toThrow(\"container home directory unavailable\");\n  });\n\n  it(\"resolves ~/path to cached remoteHomeDir\", async () => {\n    const runtime = createRuntime({ remoteHomeDir: \"/opt/user\" });\n    expect(await runtime.resolvePath(\"~/.mux\")).toBe(\"/opt/user/.mux\");\n  });\n\n  it(\"falls back to /home/<user> without cached home\", async () => {\n    const runtime = createRuntime({ remoteUser: \"node\" });\n    expect(await runtime.resolvePath(\"~\")).toBe(\"/home/node\");\n  });\n\n  it(\"falls back to /root for root user\", async () => {\n    const runtime = createRuntime({ remoteUser: \"root\" });\n    expect(await runtime.resolvePath(\"~\")).toBe(\"/root\");\n  });\n\n  it(\"resolves relative paths against remoteWorkspaceFolder\", async () => {\n    const runtime = createRuntime({ remoteWorkspaceFolder: \"/workspaces/demo\" });\n    expect(await runtime.resolvePath(\"./foo\")).toBe(\"/workspaces/demo/foo\");\n    expect(await runtime.resolvePath(\"bar\")).toBe(\"/workspaces/demo/bar\");\n  });\n\n  it(\"resolves relative paths against / when no workspace set\", async () => {\n    const runtime = createRuntime({});\n    expect(await runtime.resolvePath(\"foo\")).toBe(\"/foo\");\n  });\n\n  it(\"passes absolute paths through\", async () => {\n    const runtime = createRuntime({});\n    expect(await runtime.resolvePath(\"/tmp/test\")).toBe(\"/tmp/test\");\n  });\n});\n\ndescribe(\"DevcontainerRuntime.quoteForContainer\", () => {\n  function quoteForContainer(runtime: DevcontainerRuntime, filePath: string): string {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\n    return (runtime as any).quoteForContainer(filePath);\n  }\n\n  it(\"uses $HOME expansion for tilde paths\", () => {\n    const runtime = createRuntime({});\n    expect(quoteForContainer(runtime, \"~/.mux\")).toBe('\"$HOME/.mux\"');\n  });\n});\n\ndescribe(\"DevcontainerRuntime.resolveContainerCwd\", () => {\n  // Access the private method for testing\n  function resolveContainerCwd(\n    runtime: DevcontainerRuntime,\n    optionsCwd: string | undefined,\n    workspaceFolder: string\n  ): string {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\n    return (runtime as any).resolveContainerCwd(optionsCwd, workspaceFolder);\n  }\n\n  it(\"uses POSIX absolute path as cwd\", () => {\n    const runtime = createRuntime({ remoteWorkspaceFolder: \"/workspaces/project\" });\n    expect(resolveContainerCwd(runtime, \"/tmp/test\", \"/host/workspace\")).toBe(\"/tmp/test\");\n  });\n\n  it(\"rejects Windows drive letter paths and falls back to workspace\", () => {\n    const runtime = createRuntime({ remoteWorkspaceFolder: \"/workspaces/project\" });\n    expect(resolveContainerCwd(runtime, \"C:\\\\Users\\\\dev\", \"/host/workspace\")).toBe(\n      \"/workspaces/project\"\n    );\n  });\n\n  it(\"rejects paths with backslashes and falls back to workspace\", () => {\n    const runtime = createRuntime({ remoteWorkspaceFolder: \"/workspaces/project\" });\n    expect(resolveContainerCwd(runtime, \"some\\\\path\", \"/host/workspace\")).toBe(\n      \"/workspaces/project\"\n    );\n  });\n\n  it(\"falls back to workspaceFolder when remoteWorkspaceFolder not set\", () => {\n    const runtime = createRuntime({});\n    expect(resolveContainerCwd(runtime, \"C:\\\\\", \"/host/workspace\")).toBe(\"/host/workspace\");\n  });\n\n  it(\"falls back when cwd is undefined\", () => {\n    const runtime = createRuntime({ remoteWorkspaceFolder: \"/workspaces/project\" });\n    expect(resolveContainerCwd(runtime, undefined, \"/host/workspace\")).toBe(\"/workspaces/project\");\n  });\n});\n\ndescribe(\"DevcontainerRuntime.resolveHostPathForMounted\", () => {\n  function resolveHostPathForMounted(\n    runtime: DevcontainerRuntime,\n    filePath: string\n  ): string | null {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\n    return (runtime as any).resolveHostPathForMounted(filePath);\n  }\n\n  it(\"accepts Windows host paths under the workspace root\", () => {\n    const runtime = createRuntime({ currentWorkspacePath: \"C:\\\\ws\\\\proj\" });\n    const filePath = \"C:\\\\ws\\\\proj\\\\.mux\\\\mcp.local.jsonc\";\n    expect(resolveHostPathForMounted(runtime, filePath)).toBe(filePath);\n  });\n});\ndescribe(\"DevcontainerRuntime.mapHostPathToContainer\", () => {\n  // Access the private method for testing\n  function mapHostPathToContainer(runtime: DevcontainerRuntime, hostPath: string): string | null {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\n    return (runtime as any).mapHostPathToContainer(hostPath);\n  }\n\n  it(\"maps host workspace root to container workspace\", () => {\n    const runtime = createRuntime({\n      remoteWorkspaceFolder: \"/workspaces/project\",\n      currentWorkspacePath: \"/home/user/mux/project/branch\",\n    });\n    expect(mapHostPathToContainer(runtime, \"/home/user/mux/project/branch\")).toBe(\n      \"/workspaces/project\"\n    );\n  });\n\n  it(\"maps host subpath to container subpath\", () => {\n    const runtime = createRuntime({\n      remoteWorkspaceFolder: \"/workspaces/project\",\n      currentWorkspacePath: \"/home/user/mux/project/branch\",\n    });\n    expect(mapHostPathToContainer(runtime, \"/home/user/mux/project/branch/src/file.ts\")).toBe(\n      \"/workspaces/project/src/file.ts\"\n    );\n  });\n\n  it(\"normalizes Windows backslashes to forward slashes\", () => {\n    const runtime = createRuntime({\n      remoteWorkspaceFolder: \"/workspaces/project\",\n      currentWorkspacePath: \"C:\\\\Users\\\\dev\\\\mux\\\\project\\\\branch\",\n    });\n    // Windows-style path with backslashes should map correctly\n    expect(\n      mapHostPathToContainer(runtime, \"C:\\\\Users\\\\dev\\\\mux\\\\project\\\\branch\\\\src\\\\file.ts\")\n    ).toBe(\"/workspaces/project/src/file.ts\");\n  });\n\n  it(\"returns null for paths outside workspace\", () => {\n    const runtime = createRuntime({\n      remoteWorkspaceFolder: \"/workspaces/project\",\n      currentWorkspacePath: \"/home/user/mux/project/branch\",\n    });\n    expect(mapHostPathToContainer(runtime, \"/tmp/other\")).toBeNull();\n  });\n\n  it(\"returns null when workspace not set\", () => {\n    const runtime = createRuntime({});\n    expect(mapHostPathToContainer(runtime, \"/some/path\")).toBeNull();\n  });\n});\n"]}