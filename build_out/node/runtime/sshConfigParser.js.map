{"version":3,"file":"sshConfigParser.js","sourceRoot":"","sources":["../../../src/node/runtime/sshConfigParser.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * SSH config parsing utilities (ssh-config wrapper).\r\n */\r\n\r\nimport { spawnSync } from \"child_process\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport SSHConfig, { glob } from \"ssh-config\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\ninterface ParsedValueToken {\r\n  val: string;\r\n  separator: string;\r\n  quoted?: boolean;\r\n}\r\nconst DEFAULT_SSH_PORT = 22;\r\n\r\nexport interface ResolvedSSHConfig {\r\n  host: string;\r\n  hostName: string;\r\n  user?: string;\r\n  port: number;\r\n  identityFiles: string[];\r\n  proxyCommand?: string;\r\n}\r\n\r\nfunction getHomeDir(): string {\r\n  return process.env.USERPROFILE ?? os.homedir();\r\n}\r\nfunction getDefaultUsername(): string {\r\n  try {\r\n    return os.userInfo().username;\r\n  } catch {\r\n    return process.env.USER ?? process.env.USERNAME ?? \"\";\r\n  }\r\n}\r\n\r\nfunction expandHomePath(value: string, homeDir: string): string {\r\n  if (value === \"~\") {\r\n    return homeDir;\r\n  }\r\n\r\n  if (value.startsWith(\"~/\") || value.startsWith(\"~\\\\\")) {\r\n    return path.join(homeDir, value.slice(2));\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nfunction normalizeIdentityFile(value: string, homeDir: string): string {\r\n  const expanded = expandHomePath(value, homeDir);\r\n  if (path.isAbsolute(expanded)) {\r\n    return expanded;\r\n  }\r\n\r\n  return path.join(homeDir, expanded);\r\n}\r\n\r\nfunction parseHostAndUser(host: string): { host: string; user?: string } {\r\n  const trimmed = host.trim();\r\n  const atIndex = trimmed.lastIndexOf(\"@\");\r\n  if (atIndex > 0) {\r\n    const user = trimmed.slice(0, atIndex).trim();\r\n    const hostname = trimmed.slice(atIndex + 1).trim();\r\n    if (user && hostname) {\r\n      return { host: hostname, user };\r\n    }\r\n  }\r\n\r\n  return { host: trimmed };\r\n}\r\n\r\nfunction isParsedValueToken(value: unknown): value is ParsedValueToken {\r\n  return typeof value === \"object\" && value !== null && \"val\" in value && \"separator\" in value;\r\n}\r\n\r\nfunction tokensToString(tokens: ParsedValueToken[]): string {\r\n  return tokens\r\n    .map(({ val, separator, quoted }) => {\r\n      const rendered = quoted ? `\"${val}\"` : val;\r\n      return `${separator}${rendered}`;\r\n    })\r\n    .join(\"\")\r\n    .trimStart();\r\n}\r\n\r\ntype ComputedConfigValue = string | string[] | ParsedValueToken[];\r\n\r\nfunction getConfigValue(\r\n  config: Record<string, ComputedConfigValue>,\r\n  key: string\r\n): ComputedConfigValue | undefined {\r\n  const match = Object.entries(config).find(\r\n    ([configKey]) => configKey.toLowerCase() === key.toLowerCase()\r\n  );\r\n  return match?.[1];\r\n}\r\n\r\nfunction toStringValue(value: ComputedConfigValue | undefined): string | undefined {\r\n  if (typeof value === \"string\") {\r\n    return value;\r\n  }\r\n\r\n  if (Array.isArray(value)) {\r\n    const first = value[0];\r\n    if (typeof first === \"string\") {\r\n      return first;\r\n    }\r\n    if (isParsedValueToken(first)) {\r\n      return tokensToString(value as ParsedValueToken[]);\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\ntype MatchCriteriaValue = string | Array<{ val: string; separator: string; quoted?: boolean }>;\r\n\r\nfunction getCriteriaValue(\r\n  criteria: Record<string, MatchCriteriaValue>,\r\n  key: string\r\n): MatchCriteriaValue | undefined {\r\n  const match = Object.entries(criteria).find(\r\n    ([criteriaKey]) => criteriaKey.toLowerCase() === key.toLowerCase()\r\n  );\r\n  return match?.[1];\r\n}\r\n\r\nfunction criteriaToString(value: MatchCriteriaValue | undefined): string | undefined {\r\n  if (typeof value === \"string\") {\r\n    return value;\r\n  }\r\n\r\n  if (Array.isArray(value)) {\r\n    return value[0]?.val;\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nfunction criteriaToStringArray(value: MatchCriteriaValue | undefined): string[] {\r\n  if (typeof value === \"string\") {\r\n    return [value];\r\n  }\r\n\r\n  if (Array.isArray(value)) {\r\n    return value.map(({ val }) => val);\r\n  }\r\n\r\n  return [];\r\n}\r\n\r\nfunction expandMatchExecTokens(command: string, hostName: string, user?: string): string {\r\n  return command.replace(/%(%|h|r)/g, (_match, token) => {\r\n    switch (token) {\r\n      case \"%\":\r\n        return \"%\";\r\n      case \"h\":\r\n        return hostName;\r\n      case \"r\":\r\n        return user ?? \"\";\r\n      default:\r\n        return _match;\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Handle `Match host ... !exec ...` blocks that ssh-config doesn't evaluate.\r\n *\r\n * Limitation: Only applies ProxyCommand from matching Match blocks. Other directives\r\n * like User, Port, IdentityFile in the same block are ignored. This is sufficient for\r\n * Coder configs which only set ProxyCommand in Match blocks.\r\n */\r\nfunction applyNegatedExecMatch(\r\n  config: SSHConfig,\r\n  hostName: string,\r\n  user: string | undefined,\r\n  computed: Record<string, ComputedConfigValue>\r\n): void {\r\n  if (getConfigValue(computed, \"ProxyCommand\")) {\r\n    return;\r\n  }\r\n\r\n  for (const line of config) {\r\n    if (line.type !== SSHConfig.DIRECTIVE || line.param !== \"Match\") {\r\n      continue;\r\n    }\r\n\r\n    if (!(\"criteria\" in line)) {\r\n      continue;\r\n    }\r\n\r\n    const criteria = line.criteria as Record<string, MatchCriteriaValue>;\r\n    const hostCriterion = getCriteriaValue(criteria, \"host\");\r\n    const negatedExec = getCriteriaValue(criteria, \"!exec\");\r\n\r\n    if (!hostCriterion || !negatedExec) {\r\n      continue;\r\n    }\r\n\r\n    const hostPatterns = criteriaToStringArray(hostCriterion);\r\n    if (!glob(hostPatterns, hostName)) {\r\n      continue;\r\n    }\r\n\r\n    const execCommand = criteriaToString(negatedExec);\r\n    if (!execCommand) {\r\n      continue;\r\n    }\r\n\r\n    const expandedCommand = expandMatchExecTokens(execCommand, hostName, user);\r\n    const execResult = spawnSync(expandedCommand, { shell: true });\r\n\r\n    if (execResult.status === 0) {\r\n      continue;\r\n    }\r\n\r\n    const proxyLine = line.config.find(\r\n      (subline) =>\r\n        subline.type === SSHConfig.DIRECTIVE && subline.param.toLowerCase() === \"proxycommand\"\r\n    );\r\n\r\n    if (proxyLine?.type === SSHConfig.DIRECTIVE) {\r\n      computed.ProxyCommand = proxyLine.value as ComputedConfigValue;\r\n      return;\r\n    }\r\n  }\r\n}\r\n\r\nfunction toStringArray(value: ComputedConfigValue | undefined): string[] {\r\n  if (typeof value === \"string\") {\r\n    return [value];\r\n  }\r\n\r\n  if (Array.isArray(value)) {\r\n    const first = value[0];\r\n    if (typeof first === \"string\") {\r\n      return value as string[];\r\n    }\r\n    if (isParsedValueToken(first)) {\r\n      return [tokensToString(value as ParsedValueToken[])];\r\n    }\r\n  }\r\n\r\n  return [];\r\n}\r\n\r\nasync function loadSSHConfig(): Promise<SSHConfig | null> {\r\n  const homeDir = getHomeDir();\r\n  const configPath = path.join(homeDir, \".ssh\", \"config\");\r\n\r\n  try {\r\n    const content = await fs.readFile(configPath, \"utf8\");\r\n    const parsed = SSHConfig.parse(content);\r\n    return parsed;\r\n  } catch (error) {\r\n    if ((error as NodeJS.ErrnoException | undefined)?.code !== \"ENOENT\") {\r\n      log.debug(\"Failed to read SSH config\", {\r\n        configPath,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function resolveSSHConfig(host: string): Promise<ResolvedSSHConfig> {\r\n  const { host: hostAlias, user: userOverride } = parseHostAndUser(host);\r\n  const homeDir = getHomeDir();\r\n\r\n  const config = await loadSSHConfig();\r\n  const computed = config\r\n    ? userOverride\r\n      ? config.compute({ Host: hostAlias, User: userOverride })\r\n      : config.compute(hostAlias)\r\n    : {};\r\n\r\n  const hostName = toStringValue(getConfigValue(computed, \"HostName\")) ?? hostAlias;\r\n  const userFromConfig = toStringValue(getConfigValue(computed, \"User\"));\r\n\r\n  if (config) {\r\n    // Default to local username for %r expansion if no User is specified\r\n    const matchExecUser = userOverride ?? userFromConfig ?? getDefaultUsername();\r\n    applyNegatedExecMatch(config, hostName, matchExecUser, computed);\r\n  }\r\n\r\n  const portValue = toStringValue(getConfigValue(computed, \"Port\"));\r\n  const identityValues = toStringArray(getConfigValue(computed, \"IdentityFile\"));\r\n  const proxyCommandRaw = toStringValue(getConfigValue(computed, \"ProxyCommand\"));\r\n\r\n  const port = portValue ? Number.parseInt(portValue, 10) : DEFAULT_SSH_PORT;\r\n\r\n  const identityFiles = identityValues.map((value) => normalizeIdentityFile(value, homeDir));\r\n\r\n  const proxyCommand =\r\n    proxyCommandRaw && proxyCommandRaw.toLowerCase() !== \"none\"\r\n      ? proxyCommandRaw.trim()\r\n      : undefined;\r\n\r\n  return {\r\n    host: hostAlias,\r\n    hostName,\r\n    user: userOverride ?? userFromConfig,\r\n    port: Number.isFinite(port) ? port : DEFAULT_SSH_PORT,\r\n    identityFiles,\r\n    proxyCommand,\r\n  };\r\n}\r\n"]}