{"version":3,"file":"sshConfigParser.test.js","sourceRoot":"","sources":["../../../src/node/runtime/sshConfigParser.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport { resolveSSHConfig } from \"./sshConfigParser\";\r\n\r\ndescribe(\"resolveSSHConfig\", () => {\r\n  test(\"applies Host + Match host proxy rules\", async () => {\r\n    const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-ssh-config-\"));\r\n    const previousUserProfile = process.env.USERPROFILE;\r\n\r\n    process.env.USERPROFILE = tempDir;\r\n\r\n    try {\r\n      await fs.mkdir(path.join(tempDir, \".ssh\"), { recursive: true });\r\n\r\n      const config = [\r\n        \"Host *.coder\",\r\n        \"  User coder-user\",\r\n        \"  UserKnownHostsFile /dev/null\",\r\n        \"\",\r\n        'Match host *.coder !exec \"exit 1\"',\r\n        \"  ProxyCommand /usr/local/bin/coder --stdio %h\",\r\n        \"\",\r\n      ].join(\"\\n\");\r\n\r\n      await fs.writeFile(path.join(tempDir, \".ssh\", \"config\"), config, \"utf8\");\r\n\r\n      const resolved = await resolveSSHConfig(\"pog2.coder\");\r\n\r\n      expect(resolved.user).toBe(\"coder-user\");\r\n      expect(resolved.hostName).toBe(\"pog2.coder\");\r\n      expect(resolved.proxyCommand).toBe(\"/usr/local/bin/coder --stdio %h\");\r\n    } finally {\r\n      if (previousUserProfile === undefined) {\r\n        delete process.env.USERPROFILE;\r\n      } else {\r\n        process.env.USERPROFILE = previousUserProfile;\r\n      }\r\n\r\n      await fs.rm(tempDir, { recursive: true, force: true });\r\n    }\r\n  });\r\n\r\n  test(\"defaults %r to local username when no User is specified\", async () => {\r\n    const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-ssh-config-\"));\r\n    const previousUserProfile = process.env.USERPROFILE;\r\n\r\n    process.env.USERPROFILE = tempDir;\r\n\r\n    try {\r\n      await fs.mkdir(path.join(tempDir, \".ssh\"), { recursive: true });\r\n\r\n      // Config with no User directive - %r should default to local username\r\n      // The !exec command checks if %r is non-empty; if it were empty, exit 0\r\n      // would cause the Match to NOT apply (since !exec means \"apply if command fails\")\r\n      const config = [\r\n        \"Host test-host\",\r\n        \"  HostName 10.0.0.1\",\r\n        \"\",\r\n        // !exec \"test -n %r\" fails when %r is non-empty (test -n returns 0 for non-empty)\r\n        // So we use \"test -z %r\" which returns 0 when %r IS empty, 1 when non-empty\r\n        // With %r defaulting to local username, test -z will fail, Match applies\r\n        'Match host 10.0.0.1 !exec \"test -z %r\"',\r\n        \"  ProxyCommand /usr/bin/proxy --user %r\",\r\n        \"\",\r\n      ].join(\"\\n\");\r\n\r\n      await fs.writeFile(path.join(tempDir, \".ssh\", \"config\"), config, \"utf8\");\r\n\r\n      const resolved = await resolveSSHConfig(\"test-host\");\r\n\r\n      // Should apply ProxyCommand because %r is non-empty (local username)\r\n      expect(resolved.proxyCommand).toBe(\"/usr/bin/proxy --user %r\");\r\n      // user should be undefined since no User directive\r\n      expect(resolved.user).toBeUndefined();\r\n    } finally {\r\n      if (previousUserProfile === undefined) {\r\n        delete process.env.USERPROFILE;\r\n      } else {\r\n        process.env.USERPROFILE = previousUserProfile;\r\n      }\r\n\r\n      await fs.rm(tempDir, { recursive: true, force: true });\r\n    }\r\n  });\r\n});\r\n"]}