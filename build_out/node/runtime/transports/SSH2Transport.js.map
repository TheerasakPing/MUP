{"version":3,"file":"SSH2Transport.js","sourceRoot":"","sources":["../../../../src/node/runtime/transports/SSH2Transport.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ChildProcess } from \"child_process\";\r\nimport { EventEmitter } from \"events\";\r\nimport { PassThrough } from \"stream\";\r\nimport type { ClientChannel } from \"ssh2\";\r\nimport { RuntimeError as RuntimeErrorClass } from \"../Runtime\";\r\nimport { getErrorMessage } from \"@/common/utils/errors\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { attachStreamErrorHandler, isIgnorableStreamError } from \"@/node/utils/streamErrors\";\r\nimport { expandTildeForSSH } from \"../tildeExpansion\";\r\nimport { ssh2ConnectionPool } from \"../SSH2ConnectionPool\";\r\nimport type { SpawnResult } from \"../RemoteRuntime\";\r\nimport type {\r\n  SSHTransport,\r\n  SSHTransportConfig,\r\n  SpawnOptions,\r\n  PtyHandle,\r\n  PtySessionParams,\r\n} from \"./SSHTransport\";\r\n\r\nclass SSH2ChildProcess extends EventEmitter {\r\n  readonly stdout: NodeJS.ReadableStream;\r\n  readonly stderr: NodeJS.ReadableStream;\r\n  readonly stdin: NodeJS.WritableStream;\r\n\r\n  exitCode: number | null = null;\r\n  signalCode: string | null = null;\r\n  killed = false;\r\n  pid = 0;\r\n\r\n  constructor(private readonly channel: ClientChannel) {\r\n    super();\r\n\r\n    const stdoutPipe = new PassThrough();\r\n    const stderrPipe = new PassThrough();\r\n    const stdinPipe = new PassThrough();\r\n\r\n    channel.pipe(stdoutPipe);\r\n    (channel.stderr ?? new PassThrough()).pipe(stderrPipe);\r\n    stdinPipe.pipe(channel);\r\n\r\n    this.stdout = stdoutPipe;\r\n    this.stderr = stderrPipe;\r\n    this.stdin = stdinPipe;\r\n\r\n    let closeEventFired = false;\r\n    let closeTimer: ReturnType<typeof setTimeout> | null = null;\r\n    let closeEmitted = false;\r\n\r\n    const emitClose = () => {\r\n      if (closeEmitted) {\r\n        return;\r\n      }\r\n      closeEmitted = true;\r\n\r\n      if (closeTimer) {\r\n        clearTimeout(closeTimer);\r\n        closeTimer = null;\r\n      }\r\n\r\n      this.emit(\"close\", this.exitCode ?? 0, this.signalCode);\r\n    };\r\n\r\n    channel.on(\"exit\", (code: number | null, signal: string | null) => {\r\n      this.exitCode = typeof code === \"number\" ? code : null;\r\n      this.signalCode = typeof signal === \"string\" ? signal : null;\r\n\r\n      // ssh2 sometimes emits \"close\" before \"exit\"; if that happens, ensure we still\r\n      // report the real exit code.\r\n      if (closeEventFired) {\r\n        emitClose();\r\n      }\r\n    });\r\n\r\n    channel.on(\"close\", (...args: unknown[]) => {\r\n      closeEventFired = true;\r\n\r\n      // ssh2 sometimes emits \"close\" with the exit code/signal. Capture it so we still\r\n      // report the correct exit status even if we missed the earlier \"exit\" event\r\n      // (e.g. extremely fast commands).\r\n      const [code, signal] = args;\r\n\r\n      if (this.exitCode === null && typeof code === \"number\") {\r\n        this.exitCode = code;\r\n      }\r\n\r\n      if (this.signalCode === null && typeof signal === \"string\") {\r\n        this.signalCode = signal;\r\n      }\r\n\r\n      if (this.exitCode !== null || this.signalCode !== null) {\r\n        emitClose();\r\n        return;\r\n      }\r\n\r\n      // Grace period: allow the \"exit\" event to arrive after \"close\".\r\n      // Without this, we can incorrectly report exitCode=0 for failed commands.\r\n      closeTimer = setTimeout(() => emitClose(), 250);\r\n      closeTimer.unref?.();\r\n    });\r\n\r\n    channel.on(\"error\", (err: Error) => {\r\n      this.emit(\"error\", err);\r\n    });\r\n  }\r\n\r\n  kill(signal?: string): boolean {\r\n    this.killed = true;\r\n    try {\r\n      if (signal && typeof this.channel.signal === \"function\") {\r\n        this.channel.signal(signal);\r\n      }\r\n    } catch {\r\n      // Ignore signal errors.\r\n    }\r\n\r\n    try {\r\n      this.channel.close();\r\n    } catch {\r\n      // Ignore close errors.\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n\r\nclass SSH2Pty implements PtyHandle {\r\n  private closed = false;\r\n\r\n  constructor(private readonly channel: ClientChannel) {\r\n    this.channel.on(\"close\", () => {\r\n      this.closed = true;\r\n    });\r\n\r\n    const closeChannel = () => {\r\n      this.closed = true;\r\n      try {\r\n        this.channel.close();\r\n      } catch {\r\n        // Ignore close errors.\r\n      }\r\n    };\r\n\r\n    // PTY channels can emit socket errors when sessions exit early.\r\n    attachStreamErrorHandler(this.channel, \"ssh2-pty-channel\", {\r\n      logger: log,\r\n      onIgnorable: closeChannel,\r\n      onUnexpected: closeChannel,\r\n    });\r\n\r\n    if (this.channel.stderr) {\r\n      attachStreamErrorHandler(this.channel.stderr, \"ssh2-pty-stderr\", {\r\n        logger: log,\r\n        onIgnorable: closeChannel,\r\n        onUnexpected: closeChannel,\r\n      });\r\n    }\r\n  }\r\n\r\n  write(data: string): void {\r\n    if (this.closed || this.channel.destroyed || this.channel.writableEnded) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.channel.write(data);\r\n    } catch (error) {\r\n      if (isIgnorableStreamError(error)) {\r\n        return;\r\n      }\r\n\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      const code =\r\n        error && typeof error === \"object\" && \"code\" in error && typeof error.code === \"string\"\r\n          ? error.code\r\n          : undefined;\r\n\r\n      log.warn(\"SSH2 PTY write failed\", { code, message });\r\n    }\r\n  }\r\n\r\n  resize(cols: number, rows: number): void {\r\n    this.channel.setWindow(rows, cols, 0, 0);\r\n  }\r\n\r\n  kill(): void {\r\n    this.closed = true;\r\n    this.channel.close();\r\n  }\r\n\r\n  onData(handler: (data: string) => void): { dispose: () => void } {\r\n    const onStdout = (data: Buffer) => handler(data.toString());\r\n    const onStderr = (data: Buffer) => handler(data.toString());\r\n\r\n    this.channel.on(\"data\", onStdout);\r\n    this.channel.stderr?.on(\"data\", onStderr);\r\n\r\n    return {\r\n      dispose: () => {\r\n        this.channel.off(\"data\", onStdout);\r\n        this.channel.stderr?.off(\"data\", onStderr);\r\n      },\r\n    };\r\n  }\r\n\r\n  onExit(handler: (event: { exitCode: number; signal?: number }) => void): { dispose: () => void } {\r\n    const onClose = (code?: number | null) => {\r\n      handler({ exitCode: typeof code === \"number\" ? code : 0 });\r\n    };\r\n\r\n    this.channel.on(\"close\", onClose);\r\n\r\n    return {\r\n      dispose: () => {\r\n        this.channel.off(\"close\", onClose);\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\nexport class SSH2Transport implements SSHTransport {\r\n  constructor(private readonly config: SSHTransportConfig) {}\r\n\r\n  isConnectionFailure(_exitCode: number, _stderr: string): boolean {\r\n    return false;\r\n  }\r\n\r\n  getConfig(): SSHTransportConfig {\r\n    return this.config;\r\n  }\r\n\r\n  markHealthy(): void {\r\n    ssh2ConnectionPool.markHealthy(this.config);\r\n  }\r\n\r\n  reportFailure(error: string): void {\r\n    ssh2ConnectionPool.reportFailure(this.config, error);\r\n  }\r\n\r\n  async acquireConnection(options?: {\r\n    abortSignal?: AbortSignal;\r\n    timeoutMs?: number;\r\n    onWait?: (waitMs: number) => void;\r\n  }): Promise<void> {\r\n    await ssh2ConnectionPool.acquireConnection(this.config, {\r\n      abortSignal: options?.abortSignal,\r\n      timeoutMs: options?.timeoutMs,\r\n      onWait: options?.onWait,\r\n    });\r\n  }\r\n\r\n  async spawnRemoteProcess(fullCommand: string, options: SpawnOptions): Promise<SpawnResult> {\r\n    const connectTimeoutSec =\r\n      options.timeout !== undefined ? Math.min(Math.ceil(options.timeout), 15) : 15;\r\n\r\n    let client;\r\n    try {\r\n      ({ client } = await ssh2ConnectionPool.acquireConnection(this.config, {\r\n        abortSignal: options.abortSignal,\r\n        timeoutMs: connectTimeoutSec * 1000,\r\n      }));\r\n    } catch (error) {\r\n      throw new RuntimeErrorClass(\r\n        `SSH2 connection failed: ${getErrorMessage(error)}`,\r\n        \"network\",\r\n        error instanceof Error ? error : undefined\r\n      );\r\n    }\r\n\r\n    try {\r\n      const channel = await new Promise<ClientChannel>((resolve, reject) => {\r\n        const onExec = (err?: Error, stream?: ClientChannel) => {\r\n          if (err) {\r\n            reject(err);\r\n            return;\r\n          }\r\n          if (!stream) {\r\n            reject(new Error(\"SSH2 exec did not return a stream\"));\r\n            return;\r\n          }\r\n          resolve(stream);\r\n        };\r\n\r\n        if (options.forcePTY) {\r\n          client.exec(fullCommand, { pty: { term: \"xterm-256color\" } }, onExec);\r\n        } else {\r\n          client.exec(fullCommand, onExec);\r\n        }\r\n      });\r\n\r\n      const process = new SSH2ChildProcess(channel) as unknown as ChildProcess;\r\n      return { process };\r\n    } catch (error) {\r\n      ssh2ConnectionPool.reportFailure(this.config, getErrorMessage(error));\r\n      throw new RuntimeErrorClass(\r\n        `SSH2 command failed: ${getErrorMessage(error)}`,\r\n        \"network\",\r\n        error instanceof Error ? error : undefined\r\n      );\r\n    }\r\n  }\r\n\r\n  async createPtySession(params: PtySessionParams): Promise<PtyHandle> {\r\n    const { client } = await ssh2ConnectionPool.acquireConnection(this.config, { maxWaitMs: 0 });\r\n    const channel = await new Promise<ClientChannel>((resolve, reject) => {\r\n      client.shell(\r\n        {\r\n          term: \"xterm-256color\",\r\n          cols: params.cols,\r\n          rows: params.rows,\r\n        },\r\n        (err, stream) => {\r\n          if (err) {\r\n            reject(err);\r\n            return;\r\n          }\r\n          if (!stream) {\r\n            reject(new Error(\"SSH2 shell did not return a stream\"));\r\n            return;\r\n          }\r\n          resolve(stream);\r\n        }\r\n      );\r\n    });\r\n\r\n    // expandTildeForSSH already returns a quoted string (e.g., \"$HOME/path\")\r\n    // Do NOT wrap with shellQuotePath - that would double-quote it\r\n    // Exit on cd failure to match OpenSSH transport behavior (cd ... && exec $SHELL -i)\r\n    const expandedPath = expandTildeForSSH(params.workspacePath);\r\n    channel.write(`cd ${expandedPath} || exit 1\\n`);\r\n\r\n    return new SSH2Pty(channel);\r\n  }\r\n}\r\n"]}