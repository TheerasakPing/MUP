{"version":3,"file":"SSH2Transport.js","sourceRoot":"","sources":["../../../../src/node/runtime/transports/SSH2Transport.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ChildProcess } from \"child_process\";\nimport { EventEmitter } from \"events\";\nimport { PassThrough } from \"stream\";\nimport type { ClientChannel } from \"ssh2\";\nimport { RuntimeError as RuntimeErrorClass } from \"../Runtime\";\nimport { getErrorMessage } from \"@/common/utils/errors\";\nimport { log } from \"@/node/services/log\";\nimport { attachStreamErrorHandler, isIgnorableStreamError } from \"@/node/utils/streamErrors\";\nimport { expandTildeForSSH } from \"../tildeExpansion\";\nimport { ssh2ConnectionPool } from \"../SSH2ConnectionPool\";\nimport type { SpawnResult } from \"../RemoteRuntime\";\nimport type {\n  SSHTransport,\n  SSHTransportConfig,\n  SpawnOptions,\n  PtyHandle,\n  PtySessionParams,\n} from \"./SSHTransport\";\n\nclass SSH2ChildProcess extends EventEmitter {\n  readonly stdout: NodeJS.ReadableStream;\n  readonly stderr: NodeJS.ReadableStream;\n  readonly stdin: NodeJS.WritableStream;\n\n  exitCode: number | null = null;\n  signalCode: string | null = null;\n  killed = false;\n  pid = 0;\n\n  constructor(private readonly channel: ClientChannel) {\n    super();\n\n    const stdoutPipe = new PassThrough();\n    const stderrPipe = new PassThrough();\n    const stdinPipe = new PassThrough();\n\n    channel.pipe(stdoutPipe);\n    (channel.stderr ?? new PassThrough()).pipe(stderrPipe);\n    stdinPipe.pipe(channel);\n\n    this.stdout = stdoutPipe;\n    this.stderr = stderrPipe;\n    this.stdin = stdinPipe;\n\n    let closeEventFired = false;\n    let closeTimer: ReturnType<typeof setTimeout> | null = null;\n    let closeEmitted = false;\n\n    const emitClose = () => {\n      if (closeEmitted) {\n        return;\n      }\n      closeEmitted = true;\n\n      if (closeTimer) {\n        clearTimeout(closeTimer);\n        closeTimer = null;\n      }\n\n      this.emit(\"close\", this.exitCode ?? 0, this.signalCode);\n    };\n\n    channel.on(\"exit\", (code: number | null, signal: string | null) => {\n      this.exitCode = typeof code === \"number\" ? code : null;\n      this.signalCode = typeof signal === \"string\" ? signal : null;\n\n      // ssh2 sometimes emits \"close\" before \"exit\"; if that happens, ensure we still\n      // report the real exit code.\n      if (closeEventFired) {\n        emitClose();\n      }\n    });\n\n    channel.on(\"close\", (...args: unknown[]) => {\n      closeEventFired = true;\n\n      // ssh2 sometimes emits \"close\" with the exit code/signal. Capture it so we still\n      // report the correct exit status even if we missed the earlier \"exit\" event\n      // (e.g. extremely fast commands).\n      const [code, signal] = args;\n\n      if (this.exitCode === null && typeof code === \"number\") {\n        this.exitCode = code;\n      }\n\n      if (this.signalCode === null && typeof signal === \"string\") {\n        this.signalCode = signal;\n      }\n\n      if (this.exitCode !== null || this.signalCode !== null) {\n        emitClose();\n        return;\n      }\n\n      // Grace period: allow the \"exit\" event to arrive after \"close\".\n      // Without this, we can incorrectly report exitCode=0 for failed commands.\n      closeTimer = setTimeout(() => emitClose(), 250);\n      closeTimer.unref?.();\n    });\n\n    channel.on(\"error\", (err: Error) => {\n      this.emit(\"error\", err);\n    });\n  }\n\n  kill(signal?: string): boolean {\n    this.killed = true;\n    try {\n      if (signal && typeof this.channel.signal === \"function\") {\n        this.channel.signal(signal);\n      }\n    } catch {\n      // Ignore signal errors.\n    }\n\n    try {\n      this.channel.close();\n    } catch {\n      // Ignore close errors.\n    }\n\n    return true;\n  }\n}\n\nclass SSH2Pty implements PtyHandle {\n  private closed = false;\n\n  constructor(private readonly channel: ClientChannel) {\n    this.channel.on(\"close\", () => {\n      this.closed = true;\n    });\n\n    const closeChannel = () => {\n      this.closed = true;\n      try {\n        this.channel.close();\n      } catch {\n        // Ignore close errors.\n      }\n    };\n\n    // PTY channels can emit socket errors when sessions exit early.\n    attachStreamErrorHandler(this.channel, \"ssh2-pty-channel\", {\n      logger: log,\n      onIgnorable: closeChannel,\n      onUnexpected: closeChannel,\n    });\n\n    if (this.channel.stderr) {\n      attachStreamErrorHandler(this.channel.stderr, \"ssh2-pty-stderr\", {\n        logger: log,\n        onIgnorable: closeChannel,\n        onUnexpected: closeChannel,\n      });\n    }\n  }\n\n  write(data: string): void {\n    if (this.closed || this.channel.destroyed || this.channel.writableEnded) {\n      return;\n    }\n\n    try {\n      this.channel.write(data);\n    } catch (error) {\n      if (isIgnorableStreamError(error)) {\n        return;\n      }\n\n      const message = error instanceof Error ? error.message : String(error);\n      const code =\n        error && typeof error === \"object\" && \"code\" in error && typeof error.code === \"string\"\n          ? error.code\n          : undefined;\n\n      log.warn(\"SSH2 PTY write failed\", { code, message });\n    }\n  }\n\n  resize(cols: number, rows: number): void {\n    this.channel.setWindow(rows, cols, 0, 0);\n  }\n\n  kill(): void {\n    this.closed = true;\n    this.channel.close();\n  }\n\n  onData(handler: (data: string) => void): { dispose: () => void } {\n    const onStdout = (data: Buffer) => handler(data.toString());\n    const onStderr = (data: Buffer) => handler(data.toString());\n\n    this.channel.on(\"data\", onStdout);\n    this.channel.stderr?.on(\"data\", onStderr);\n\n    return {\n      dispose: () => {\n        this.channel.off(\"data\", onStdout);\n        this.channel.stderr?.off(\"data\", onStderr);\n      },\n    };\n  }\n\n  onExit(handler: (event: { exitCode: number; signal?: number }) => void): { dispose: () => void } {\n    const onClose = (code?: number | null) => {\n      handler({ exitCode: typeof code === \"number\" ? code : 0 });\n    };\n\n    this.channel.on(\"close\", onClose);\n\n    return {\n      dispose: () => {\n        this.channel.off(\"close\", onClose);\n      },\n    };\n  }\n}\n\nexport class SSH2Transport implements SSHTransport {\n  constructor(private readonly config: SSHTransportConfig) {}\n\n  isConnectionFailure(_exitCode: number, _stderr: string): boolean {\n    return false;\n  }\n\n  getConfig(): SSHTransportConfig {\n    return this.config;\n  }\n\n  markHealthy(): void {\n    ssh2ConnectionPool.markHealthy(this.config);\n  }\n\n  reportFailure(error: string): void {\n    ssh2ConnectionPool.reportFailure(this.config, error);\n  }\n\n  async acquireConnection(options?: {\n    abortSignal?: AbortSignal;\n    timeoutMs?: number;\n    onWait?: (waitMs: number) => void;\n  }): Promise<void> {\n    await ssh2ConnectionPool.acquireConnection(this.config, {\n      abortSignal: options?.abortSignal,\n      timeoutMs: options?.timeoutMs,\n      onWait: options?.onWait,\n    });\n  }\n\n  async spawnRemoteProcess(fullCommand: string, options: SpawnOptions): Promise<SpawnResult> {\n    const connectTimeoutSec =\n      options.timeout !== undefined ? Math.min(Math.ceil(options.timeout), 15) : 15;\n\n    let client;\n    try {\n      ({ client } = await ssh2ConnectionPool.acquireConnection(this.config, {\n        abortSignal: options.abortSignal,\n        timeoutMs: connectTimeoutSec * 1000,\n      }));\n    } catch (error) {\n      throw new RuntimeErrorClass(\n        `SSH2 connection failed: ${getErrorMessage(error)}`,\n        \"network\",\n        error instanceof Error ? error : undefined\n      );\n    }\n\n    try {\n      const channel = await new Promise<ClientChannel>((resolve, reject) => {\n        const onExec = (err?: Error, stream?: ClientChannel) => {\n          if (err) {\n            reject(err);\n            return;\n          }\n          if (!stream) {\n            reject(new Error(\"SSH2 exec did not return a stream\"));\n            return;\n          }\n          resolve(stream);\n        };\n\n        if (options.forcePTY) {\n          client.exec(fullCommand, { pty: { term: \"xterm-256color\" } }, onExec);\n        } else {\n          client.exec(fullCommand, onExec);\n        }\n      });\n\n      const process = new SSH2ChildProcess(channel) as unknown as ChildProcess;\n      return { process };\n    } catch (error) {\n      ssh2ConnectionPool.reportFailure(this.config, getErrorMessage(error));\n      throw new RuntimeErrorClass(\n        `SSH2 command failed: ${getErrorMessage(error)}`,\n        \"network\",\n        error instanceof Error ? error : undefined\n      );\n    }\n  }\n\n  async createPtySession(params: PtySessionParams): Promise<PtyHandle> {\n    const { client } = await ssh2ConnectionPool.acquireConnection(this.config, { maxWaitMs: 0 });\n    const channel = await new Promise<ClientChannel>((resolve, reject) => {\n      client.shell(\n        {\n          term: \"xterm-256color\",\n          cols: params.cols,\n          rows: params.rows,\n        },\n        (err, stream) => {\n          if (err) {\n            reject(err);\n            return;\n          }\n          if (!stream) {\n            reject(new Error(\"SSH2 shell did not return a stream\"));\n            return;\n          }\n          resolve(stream);\n        }\n      );\n    });\n\n    // expandTildeForSSH already returns a quoted string (e.g., \"$HOME/path\")\n    // Do NOT wrap with shellQuotePath - that would double-quote it\n    // Exit on cd failure to match OpenSSH transport behavior (cd ... && exec $SHELL -i)\n    const expandedPath = expandTildeForSSH(params.workspacePath);\n    channel.write(`cd ${expandedPath} || exit 1\\n`);\n\n    return new SSH2Pty(channel);\n  }\n}\n"]}