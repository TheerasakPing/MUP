{"version":3,"file":"OpenSSHTransport.js","sourceRoot":"","sources":["../../../../src/node/runtime/transports/OpenSSHTransport.ts"],"names":[],"mappings":"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","sourcesContent":["import { spawn } from \"child_process\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\nimport { spawnPtyProcess } from \"../ptySpawn\";\r\nimport { expandTildeForSSH } from \"../tildeExpansion\";\r\nimport { getControlPath, sshConnectionPool, type SSHConnectionConfig } from \"../sshConnectionPool\";\r\nimport type { SpawnResult } from \"../RemoteRuntime\";\r\nimport type {\r\n  SSHTransport,\r\n  SSHTransportConfig,\r\n  SpawnOptions,\r\n  PtyHandle,\r\n  PtySessionParams,\r\n} from \"./SSHTransport\";\r\n\r\nexport class OpenSSHTransport implements SSHTransport {\r\n  private readonly config: SSHConnectionConfig;\r\n  private readonly controlPath: string;\r\n\r\n  constructor(config: SSHConnectionConfig) {\r\n    this.config = config;\r\n    this.controlPath = getControlPath(config);\r\n  }\r\n\r\n  isConnectionFailure(exitCode: number, _stderr: string): boolean {\r\n    return exitCode === 255;\r\n  }\r\n\r\n  getConfig(): SSHTransportConfig {\r\n    return this.config;\r\n  }\r\n\r\n  markHealthy(): void {\r\n    sshConnectionPool.markHealthy(this.config);\r\n  }\r\n\r\n  reportFailure(error: string): void {\r\n    sshConnectionPool.reportFailure(this.config, error);\r\n  }\r\n\r\n  async acquireConnection(options?: {\r\n    abortSignal?: AbortSignal;\r\n    timeoutMs?: number;\r\n    onWait?: (waitMs: number) => void;\r\n  }): Promise<void> {\r\n    await sshConnectionPool.acquireConnection(this.config, {\r\n      abortSignal: options?.abortSignal,\r\n      timeoutMs: options?.timeoutMs,\r\n      onWait: options?.onWait,\r\n    });\r\n  }\r\n\r\n  async spawnRemoteProcess(fullCommand: string, options: SpawnOptions): Promise<SpawnResult> {\r\n    await sshConnectionPool.acquireConnection(this.config, {\r\n      abortSignal: options.abortSignal,\r\n    });\r\n\r\n    // Note: use -tt (not -t) so PTY allocation works even when stdin is a pipe.\r\n    const sshArgs: string[] = [options.forcePTY ? \"-tt\" : \"-T\", ...this.buildSSHArgs()];\r\n\r\n    const connectTimeout =\r\n      options.timeout !== undefined ? Math.min(Math.ceil(options.timeout), 15) : 15;\r\n    sshArgs.push(\"-o\", `ConnectTimeout=${connectTimeout}`);\r\n    sshArgs.push(\"-o\", \"ServerAliveInterval=5\");\r\n    sshArgs.push(\"-o\", \"ServerAliveCountMax=2\");\r\n\r\n    sshArgs.push(this.config.host, fullCommand);\r\n\r\n    log.debug(`SSH exec on ${this.config.host}`);\r\n    const process = spawn(\"ssh\", sshArgs, {\r\n      stdio: [\"pipe\", \"pipe\", \"pipe\"],\r\n      windowsHide: true,\r\n    });\r\n\r\n    return { process };\r\n  }\r\n\r\n  async createPtySession(params: PtySessionParams): Promise<PtyHandle> {\r\n    await sshConnectionPool.acquireConnection(this.config, { maxWaitMs: 0 });\r\n\r\n    const args: string[] = [...this.buildSSHArgs()];\r\n    args.push(\"-o\", \"ConnectTimeout=15\");\r\n    args.push(\"-o\", \"ServerAliveInterval=5\");\r\n    args.push(\"-o\", \"ServerAliveCountMax=2\");\r\n    args.push(\"-t\");\r\n    args.push(this.config.host);\r\n\r\n    // expandTildeForSSH already returns a quoted string (e.g., \"$HOME/path\")\r\n    // Do NOT wrap with shellQuotePath - that would double-quote it\r\n    const expandedPath = expandTildeForSSH(params.workspacePath);\r\n    args.push(`cd ${expandedPath} && exec $SHELL -i`);\r\n\r\n    return spawnPtyProcess({\r\n      runtimeLabel: \"SSH\",\r\n      command: \"ssh\",\r\n      args,\r\n      cwd: process.cwd(),\r\n      cols: params.cols,\r\n      rows: params.rows,\r\n      preferElectronBuild: false,\r\n    });\r\n  }\r\n\r\n  private buildSSHArgs(): string[] {\r\n    const args: string[] = [];\r\n\r\n    if (this.config.port) {\r\n      args.push(\"-p\", this.config.port.toString());\r\n    }\r\n\r\n    if (this.config.identityFile) {\r\n      args.push(\"-i\", this.config.identityFile);\r\n      args.push(\"-o\", \"StrictHostKeyChecking=no\");\r\n      args.push(\"-o\", \"UserKnownHostsFile=/dev/null\");\r\n    }\r\n\r\n    args.push(\"-o\", \"LogLevel=FATAL\");\r\n    args.push(\"-o\", \"ControlMaster=auto\");\r\n    args.push(\"-o\", `ControlPath=${this.controlPath}`);\r\n    args.push(\"-o\", \"ControlPersist=60\");\r\n\r\n    return args;\r\n  }\r\n}\r\n"]}