{"version":3,"file":"OpenSSHTransport.js","sourceRoot":"","sources":["../../../../src/node/runtime/transports/OpenSSHTransport.ts"],"names":[],"mappings":"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","sourcesContent":["import { spawn } from \"child_process\";\nimport { log } from \"@/node/services/log\";\n\nimport { spawnPtyProcess } from \"../ptySpawn\";\nimport { expandTildeForSSH } from \"../tildeExpansion\";\nimport { getControlPath, sshConnectionPool, type SSHConnectionConfig } from \"../sshConnectionPool\";\nimport type { SpawnResult } from \"../RemoteRuntime\";\nimport type {\n  SSHTransport,\n  SSHTransportConfig,\n  SpawnOptions,\n  PtyHandle,\n  PtySessionParams,\n} from \"./SSHTransport\";\n\nexport class OpenSSHTransport implements SSHTransport {\n  private readonly config: SSHConnectionConfig;\n  private readonly controlPath: string;\n\n  constructor(config: SSHConnectionConfig) {\n    this.config = config;\n    this.controlPath = getControlPath(config);\n  }\n\n  isConnectionFailure(exitCode: number, _stderr: string): boolean {\n    return exitCode === 255;\n  }\n\n  getConfig(): SSHTransportConfig {\n    return this.config;\n  }\n\n  markHealthy(): void {\n    sshConnectionPool.markHealthy(this.config);\n  }\n\n  reportFailure(error: string): void {\n    sshConnectionPool.reportFailure(this.config, error);\n  }\n\n  async acquireConnection(options?: {\n    abortSignal?: AbortSignal;\n    timeoutMs?: number;\n    onWait?: (waitMs: number) => void;\n  }): Promise<void> {\n    await sshConnectionPool.acquireConnection(this.config, {\n      abortSignal: options?.abortSignal,\n      timeoutMs: options?.timeoutMs,\n      onWait: options?.onWait,\n    });\n  }\n\n  async spawnRemoteProcess(fullCommand: string, options: SpawnOptions): Promise<SpawnResult> {\n    await sshConnectionPool.acquireConnection(this.config, {\n      abortSignal: options.abortSignal,\n    });\n\n    // Note: use -tt (not -t) so PTY allocation works even when stdin is a pipe.\n    const sshArgs: string[] = [options.forcePTY ? \"-tt\" : \"-T\", ...this.buildSSHArgs()];\n\n    const connectTimeout =\n      options.timeout !== undefined ? Math.min(Math.ceil(options.timeout), 15) : 15;\n    sshArgs.push(\"-o\", `ConnectTimeout=${connectTimeout}`);\n    sshArgs.push(\"-o\", \"ServerAliveInterval=5\");\n    sshArgs.push(\"-o\", \"ServerAliveCountMax=2\");\n\n    sshArgs.push(this.config.host, fullCommand);\n\n    log.debug(`SSH exec on ${this.config.host}`);\n    const process = spawn(\"ssh\", sshArgs, {\n      stdio: [\"pipe\", \"pipe\", \"pipe\"],\n      windowsHide: true,\n    });\n\n    return { process };\n  }\n\n  async createPtySession(params: PtySessionParams): Promise<PtyHandle> {\n    await sshConnectionPool.acquireConnection(this.config, { maxWaitMs: 0 });\n\n    const args: string[] = [...this.buildSSHArgs()];\n    args.push(\"-o\", \"ConnectTimeout=15\");\n    args.push(\"-o\", \"ServerAliveInterval=5\");\n    args.push(\"-o\", \"ServerAliveCountMax=2\");\n    args.push(\"-t\");\n    args.push(this.config.host);\n\n    // expandTildeForSSH already returns a quoted string (e.g., \"$HOME/path\")\n    // Do NOT wrap with shellQuotePath - that would double-quote it\n    const expandedPath = expandTildeForSSH(params.workspacePath);\n    args.push(`cd ${expandedPath} && exec $SHELL -i`);\n\n    return spawnPtyProcess({\n      runtimeLabel: \"SSH\",\n      command: \"ssh\",\n      args,\n      cwd: process.cwd(),\n      cols: params.cols,\n      rows: params.rows,\n      preferElectronBuild: false,\n    });\n  }\n\n  private buildSSHArgs(): string[] {\n    const args: string[] = [];\n\n    if (this.config.port) {\n      args.push(\"-p\", this.config.port.toString());\n    }\n\n    if (this.config.identityFile) {\n      args.push(\"-i\", this.config.identityFile);\n      args.push(\"-o\", \"StrictHostKeyChecking=no\");\n      args.push(\"-o\", \"UserKnownHostsFile=/dev/null\");\n    }\n\n    args.push(\"-o\", \"LogLevel=FATAL\");\n    args.push(\"-o\", \"ControlMaster=auto\");\n    args.push(\"-o\", `ControlPath=${this.controlPath}`);\n    args.push(\"-o\", \"ControlPersist=60\");\n\n    return args;\n  }\n}\n"]}