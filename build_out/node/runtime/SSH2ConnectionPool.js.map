{"version":3,"file":"SSH2ConnectionPool.js","sourceRoot":"","sources":["../../../src/node/runtime/SSH2ConnectionPool.ts"],"names":[],"mappings":";AAAA;;;;;;;GAOG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,MAAY,EAAE,wCAAoB;AAClC,MAAY,EAAE,+BAAW;AACzB,MAAY,IAAI,iCAAa;AAC7B,iDAAyD;AACzD,mCAAgC;AAChC,+BAA8B;AAC9B,kDAAwD;AACxD,6CAA0C;AAC1C,4DAAqE;AAErE,uDAA6E;AAmB7E;;GAEG;AACH,MAAM,gBAAgB,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;AAE1C,MAAM,0BAA0B,GAAG,MAAM,CAAC;AAC1C,MAAM,mBAAmB,GAAG,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC;AAE1C;;;GAGG;AACH,MAAM,eAAe,GAAG,EAAE,GAAG,IAAI,CAAC;AAsClC,SAAS,UAAU,CAAC,OAAe,EAAU;IAC3C,MAAM,YAAY,GAAG,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC;IAC/C,OAAO,OAAO,GAAG,YAAY,CAAC;AAAA,CAC/B;AAED,KAAK,UAAU,cAAc,CAAC,EAAU,EAAE,WAAyB,EAAiB;IAClF,IAAI,EAAE,IAAI,CAAC;QAAE,OAAO;IACpB,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;QACzB,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;IACvC,CAAC;IAED,MAAM,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE,CAAC;QAC3C,MAAM,KAAK,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;YAC7B,OAAO,EAAE,CAAC;YACV,OAAO,EAAE,CAAC;QAAA,CACX,EAAE,EAAE,CAAC,CAAC;QAEP,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;YACpB,OAAO,EAAE,CAAC;YACV,MAAM,CAAC,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC,CAAC;QAAA,CACxC,CAAC;QAEF,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;YACpB,YAAY,CAAC,KAAK,CAAC,CAAC;YACpB,WAAW,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAAA,CACpD,CAAC;QAEF,WAAW,EAAE,gBAAgB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAAA,CACjD,CAAC,CAAC;AAAA,CACJ;AAED,SAAS,cAAc,GAAuB;IAC5C,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa,EAAE,CAAC;QAC9B,OAAO,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC;IACnC,CAAC;IAED,IAAI,OAAO,CAAC,QAAQ,KAAK,OAAO,EAAE,CAAC;QACjC,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,OAAO,SAAS,CAAC;AAAA,CAClB;AAED,SAAS,kBAAkB,GAAW;IACpC,IAAI,CAAC;QACH,OAAO,EAAE,CAAC,QAAQ,EAAE,CAAC,QAAQ,CAAC;IAChC,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,OAAO,CAAC,GAAG,CAAC,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,IAAI,SAAS,CAAC;IAC/D,CAAC;AAAA,CACF;AAED,MAAM,sBAAsB,GAAG;IAC7B,eAAe;IACf,iBAAiB;IACjB,oBAAoB;IACpB,mBAAmB;IACnB,sBAAsB;IACtB,eAAe;CAChB,CAAC;AACF,SAAS,eAAe,CAAC,KAAa,EAAU;IAC9C,IAAI,KAAK,KAAK,GAAG,EAAE,CAAC;QAClB,OAAO,EAAE,CAAC,OAAO,EAAE,CAAC;IACtB,CAAC;IAED,IAAI,KAAK,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,KAAK,CAAC,UAAU,CAAC,KAAK,CAAC,EAAE,CAAC;QACtD,OAAO,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;IACjD,CAAC;IAED,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,EAAE,CAAC;QAC5B,OAAO,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,CAAC;IACxC,CAAC;IAED,OAAO,KAAK,CAAC;AAAA,CACd;AAED,SAAS,iBAAiB,CAAC,MAA2B,EAAU;IAC9D,MAAM,KAAK,GAAG;QACZ,kBAAkB,EAAE;QACpB,MAAM,CAAC,IAAI;QACX,MAAM,CAAC,IAAI,EAAE,QAAQ,EAAE,IAAI,IAAI;QAC/B,MAAM,CAAC,YAAY,IAAI,SAAS;KACjC,CAAC;IACF,OAAO,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAAA,CACxB;AAED,SAAS,oBAAoB,CAC3B,OAAe,EACf,MAAoD,EACpD;IACA,OAAO,OAAO,CAAC,OAAO,CAAC,aAAa,EAAE,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE,CAAC;QACtD,QAAQ,KAAK,EAAE,CAAC;YACd,KAAK,GAAG;gBACN,OAAO,GAAG,CAAC;YACb,KAAK,GAAG;gBACN,OAAO,MAAM,CAAC,IAAI,CAAC;YACrB,KAAK,GAAG;gBACN,OAAO,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YAC7B,KAAK,GAAG;gBACN,OAAO,MAAM,CAAC,IAAI,CAAC;YACrB;gBACE,OAAO,KAAK,CAAC;QACjB,CAAC;IAAA,CACF,CAAC,CAAC;AAAA,CACJ;AAED,SAAS,iBAAiB,CAAC,OAAe,EAAuC;IAC/E,IAAI,OAAO,CAAC,QAAQ,KAAK,OAAO,EAAE,CAAC;QACjC,OAAO;YACL,OAAO,EAAE,OAAO,CAAC,GAAG,CAAC,OAAO,IAAI,SAAS;YACzC,IAAI,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,OAAO,CAAC;SAClC,CAAC;IACJ,CAAC;IAED,OAAO,EAAE,OAAO,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,IAAI,EAAE,OAAO,CAAC,EAAE,CAAC;AAAA,CACtD;AAED,SAAS,iBAAiB,CACxB,OAAe,EACf,MAAoD,EAIpD;IACA,MAAM,WAAW,GAAG,oBAAoB,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;IAC1D,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,iBAAiB,CAAC,WAAW,CAAC,CAAC;IAEhE,MAAM,IAAI,GAAG,IAAA,qBAAK,EAAC,KAAK,EAAE,IAAI,EAAE;QAC9B,KAAK,EAAE,CAAC,MAAM,EAAE,MAAM,EAAE,MAAM,CAAC;QAC/B,WAAW,EAAE,IAAI;KAClB,CAAC,CAAC;IAEH,IAAI,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,EAAE,GAAG,EAAE,CAAC;QAC5B,gDAAgD;IADnB,CAE9B,CAAC,CAAC;IAEH,IAAI,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;QAChC,MAAM,IAAI,KAAK,CAAC,4CAA4C,CAAC,CAAC;IAChE,CAAC;IAED,MAAM,IAAI,GAAG,eAAM,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE,QAAQ,EAAE,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC;IAE1E,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;AAAA,CAChC;AAED;;;;;GAKG;AACH,SAAS,mBAAmB,CAAC,KAAc,EAAW;IACpD,IAAI,CAAC,KAAK,EAAE,CAAC;QACX,OAAO,KAAK,CAAC;IACf,CAAC;IACD,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,KAAK,KAAK,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;IAChG,OAAO,CACL,OAAO,CAAC,QAAQ,CAAC,gCAAgC,CAAC;QAClD,OAAO,CAAC,QAAQ,CAAC,wCAAwC,CAAC;QAC1D,OAAO,CAAC,QAAQ,CAAC,oCAAoC,CAAC;QACtD,CAAC,OAAO,CAAC,QAAQ,CAAC,yBAAyB,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAC9E,CAAC;AAAA,CACH;AAED,SAAS,aAAa,CAAC,KAAc,EAAW;IAC9C,IAAI,CAAC,KAAK,EAAE,CAAC;QACX,OAAO,KAAK,CAAC;IACf,CAAC;IAED,qEAAqE;IACrE,oDAAoD;IACpD,IAAI,mBAAmB,CAAC,KAAK,CAAC,EAAE,CAAC;QAC/B,OAAO,IAAI,CAAC;IACd,CAAC;IAED,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,IAAI,KAAK,EAAE,CAAC;QACpE,MAAM,KAAK,GAAI,KAA4B,CAAC,KAAK,CAAC;QAClD,IAAI,KAAK,KAAK,uBAAuB,EAAE,CAAC;YACtC,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,KAAK,KAAK,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;IAChG,OAAO,CACL,OAAO,CAAC,QAAQ,CAAC,8CAA8C,CAAC;QAChE,OAAO,CAAC,QAAQ,CAAC,uBAAuB,CAAC;QACzC,OAAO,CAAC,QAAQ,CAAC,wBAAwB,CAAC,CAC3C,CAAC;AAAA,CACH;AACD,KAAK,UAAU,kBAAkB,CAAC,aAAuB,EAAqB;IAC5E,MAAM,IAAI,GAAa,EAAE,CAAC;IAE1B,KAAK,MAAM,IAAI,IAAI,aAAa,EAAE,CAAC;QACjC,IAAI,CAAC;YACH,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;QACrC,CAAC;QAAC,MAAM,CAAC;YACP,0BAA0B;QAC5B,CAAC;IACH,CAAC;IAED,OAAO,IAAI,CAAC;AAAA,CACb;AAED;IACU,MAAM,GAAG,IAAI,GAAG,EAA4B,CAAC;IAC7C,QAAQ,GAAG,IAAI,GAAG,EAAwC,CAAC;IAC3D,WAAW,GAAG,IAAI,GAAG,EAA+B,CAAC;IAE7D,KAAK,CAAC,iBAAiB,CACrB,MAA2B,EAC3B,OAAO,GAA6B,EAAE,EACR;QAC9B,MAAM,GAAG,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAC;QACtC,MAAM,SAAS,GAAG,OAAO,CAAC,SAAS,IAAI,0BAA0B,CAAC;QAClE,MAAM,KAAK,GAAG,OAAO,CAAC,KAAK,IAAI,cAAc,CAAC;QAC9C,MAAM,SAAS,GAAG,OAAO,CAAC,SAAS,IAAI,mBAAmB,CAAC;QAC3D,MAAM,UAAU,GAAG,SAAS,GAAG,CAAC,CAAC;QACjC,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAE7B,OAAO,IAAI,EAAE,CAAC;YACZ,IAAI,OAAO,CAAC,WAAW,EAAE,OAAO,EAAE,CAAC;gBACjC,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;YACvC,CAAC;YAED,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAC3C,IAAI,QAAQ,EAAE,CAAC;gBACb,IAAI,CAAC,eAAe,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;gBACpC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;gBACzB,OAAO,QAAQ,CAAC;YAClB,CAAC;YAED,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACpC,IAAI,MAAM,EAAE,YAAY,IAAI,MAAM,CAAC,YAAY,GAAG,IAAI,IAAI,EAAE,EAAE,CAAC;gBAC7D,MAAM,WAAW,GAAG,MAAM,CAAC,YAAY,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAC/D,MAAM,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,CAAC;gBAEpD,IAAI,CAAC,UAAU,EAAE,CAAC;oBAChB,MAAM,IAAI,KAAK,CACb,qBAAqB,MAAM,CAAC,IAAI,sBAAsB,aAAa,KAAK;wBACtE,eAAe,MAAM,CAAC,SAAS,IAAI,SAAS,EAAE,CACjD,CAAC;gBACJ,CAAC;gBAED,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;gBACzC,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,SAAS,CAAC,CAAC;gBACpD,IAAI,QAAQ,IAAI,CAAC,EAAE,CAAC;oBAClB,MAAM,IAAI,KAAK,CACb,qBAAqB,MAAM,CAAC,IAAI,yCAAyC;wBACvE,eAAe,MAAM,CAAC,SAAS,IAAI,SAAS,EAAE,CACjD,CAAC;gBACJ,CAAC;gBAED,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC;gBAC/C,OAAO,CAAC,MAAM,EAAE,CAAC,MAAM,CAAC,CAAC;gBACzB,MAAM,KAAK,CAAC,MAAM,EAAE,OAAO,CAAC,WAAW,CAAC,CAAC;gBACzC,SAAS;YACX,CAAC;YAED,IAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACtC,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACd,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,SAAS,EAAE,OAAO,CAAC,WAAW,CAAC,CAAC;gBAChE,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;gBACjC,wEAAwE;gBACxE,iEAAiE;gBACjE,6CAA6C;gBAC7C,gEAAgE;gBAChE,KAAK,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,EAAC,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;YACzE,CAAC;YAED,IAAI,CAAC;gBACH,MAAM,KAAK,GAAG,MAAM,QAAQ,CAAC;gBAC7B,OAAO,KAAK,CAAC;YACf,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,UAAU,EAAE,CAAC;oBAChB,MAAM,KAAK,CAAC;gBACd,CAAC;gBAED,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;gBACzC,IAAI,SAAS,IAAI,SAAS,EAAE,CAAC;oBAC3B,MAAM,KAAK,CAAC;gBACd,CAAC;YACH,CAAC;QACH,CAAC;IAAA,CACF;IAED,WAAW,CAAC,MAA2B,EAAQ;QAC7C,MAAM,GAAG,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAC;QACtC,MAAM,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QACtC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,EAAE;YACnB,MAAM,EAAE,SAAS;YACjB,WAAW,EAAE,IAAI,IAAI,EAAE;YACvB,mBAAmB,EAAE,CAAC;YACtB,WAAW,EAAE,QAAQ,EAAE,WAAW;YAClC,SAAS,EAAE,QAAQ,EAAE,SAAS;SAC/B,CAAC,CAAC;IAAA,CACJ;IAED,aAAa,CAAC,MAA2B,EAAE,YAAoB,EAAQ;QACrE,MAAM,GAAG,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAC;QACtC,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;QACvB,MAAM,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QACrC,MAAM,QAAQ,GAAG,CAAC,OAAO,EAAE,mBAAmB,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;QACzD,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,GAAG,CAAC,EAAE,gBAAgB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QACzE,MAAM,cAAc,GAAG,UAAU,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC,CAAC;QAElE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,EAAE;YACnB,MAAM,EAAE,WAAW;YACnB,WAAW,EAAE,GAAG;YAChB,SAAS,EAAE,YAAY;YACvB,mBAAmB,EAAE,QAAQ;YAC7B,YAAY,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,cAAc,GAAG,IAAI,CAAC;YAC1D,WAAW,EAAE,OAAO,EAAE,WAAW;SAClC,CAAC,CAAC;IAAA,CACJ;IAED;;;OAGG;IACH,cAAc,GAAS;QACrB,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;QACpB,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;IAAA,CACvB;IAED;;;OAGG;IACK,eAAe,CAAC,KAA0B,EAAE,GAAW,EAAQ;QACrE,KAAK,CAAC,cAAc,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAElC,4BAA4B;QAC5B,IAAI,KAAK,CAAC,SAAS,EAAE,CAAC;YACpB,YAAY,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;QAChC,CAAC;QAED,qBAAqB;QACrB,KAAK,CAAC,SAAS,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;YACjC,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;QAAA,CACtC,EAAE,eAAe,CAAC,CAAC;IAAA,CACrB;IAED;;OAEG;IACK,mBAAmB,CAAC,GAAW,EAAE,KAA0B,EAAQ;QACzE,0DAA0D;QAC1D,IAAI,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,KAAK,EAAE,CAAC;YACxC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAE7B,IAAI,CAAC;YACH,KAAK,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;QACrB,CAAC;QAAC,MAAM,CAAC;YACP,uCAAuC;QACzC,CAAC;QAED,IAAI,KAAK,CAAC,YAAY,EAAE,QAAQ,KAAK,IAAI,EAAE,CAAC;YAC1C,IAAI,CAAC;gBACH,KAAK,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC;YAC5B,CAAC;YAAC,MAAM,CAAC;gBACP,8BAA8B;YAChC,CAAC;QACH,CAAC;IAAA,CACF;IAEO,KAAK,CAAC,OAAO,CACnB,MAA2B,EAC3B,SAAiB,EACjB,WAAyB,EACK;QAC9B,MAAM,GAAG,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAC;QACtC,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,IAAA,kCAAgB,EAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACrD,MAAM,cAAc,GAAsB;gBACxC,GAAG,QAAQ;gBACX,IAAI,EAAE,MAAM,CAAC,IAAI,IAAI,QAAQ,CAAC,IAAI;gBAClC,aAAa,EAAE,MAAM,CAAC,YAAY;oBAChC,CAAC,CAAC,CAAC,eAAe,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;oBACxC,CAAC,CAAC,QAAQ,CAAC,aAAa;aAC3B,CAAC;YACF,MAAM,KAAK,GAAG,cAAc,EAAE,CAAC;YAC/B,MAAM,iBAAiB,GACrB,cAAc,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,cAAc,CAAC,aAAa,CAAC,CAAC,CAAC,EAAE,CAAC;YAC9E,MAAM,qBAAqB,GACzB,iBAAiB,CAAC,MAAM,GAAG,CAAC;gBAC1B,CAAC,CAAC,iBAAiB;gBACnB,CAAC,CAAC,sBAAsB,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC,CAAC;YAClE,MAAM,QAAQ,GAAG,cAAc,CAAC,IAAI,IAAI,kBAAkB,EAAE,CAAC;YAC7D,MAAM,WAAW,GAAG;gBAClB,IAAI,EAAE,cAAc,CAAC,QAAQ;gBAC7B,IAAI,EAAE,cAAc,CAAC,IAAI;gBACzB,IAAI,EAAE,QAAQ;aACf,CAAC;YAEF,MAAM,iBAAiB,GAAG,KAAK,EAC7B,aAAuB,EACvB,aAAiC,EACH,EAAE,CAAC;gBACjC,MAAM,4BAA4B,GAAsB;oBACtD,GAAG,cAAc;oBACjB,aAAa;iBACd,CAAC;gBAEF,MAAM,YAAY,GAAG,MAAM,kBAAkB,CAAC,4BAA4B,CAAC,aAAa,CAAC,CAAC;gBAC1F,MAAM,SAAS,GACb,YAAY,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC;gBAEvD,MAAM,cAAc,GAAG,KAAK,EAC1B,UAA8B,EAC9B,iBAA0B,EACI,EAAE,CAAC;oBACjC,MAAM,KAAK,GAAG,4BAA4B,CAAC,YAAY;wBACrD,CAAC,CAAC,iBAAiB,CAAC,4BAA4B,CAAC,YAAY,EAAE,WAAW,CAAC;wBAC3E,CAAC,CAAC,SAAS,CAAC;oBAEd,MAAM,MAAM,GAAG,IAAI,aAAM,EAAE,CAAC;oBAC5B,MAAM,KAAK,GAAwB;wBACjC,MAAM;wBACN,cAAc,EAAE,4BAA4B;wBAC5C,YAAY,EAAE,KAAK,EAAE,OAAO;wBAC5B,cAAc,EAAE,IAAI,CAAC,GAAG,EAAE;qBAC3B,CAAC;oBAEF,MAAM,YAAY,GAAG,GAAG,EAAE,CAAC;wBACzB,IAAI,KAAK,EAAE,OAAO,EAAE,QAAQ,KAAK,IAAI,EAAE,CAAC;4BACtC,KAAK,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;wBACvB,CAAC;oBAAA,CACF,CAAC;oBAEF,MAAM,kBAAkB,GAAG,GAAG,EAAE,CAAC;wBAC/B,IAAI,KAAK,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;4BACzC,KAAK,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;wBACvB,CAAC;wBACD,YAAY,EAAE,CAAC;oBAAA,CAChB,CAAC;oBAEF,IAAI,KAAK,EAAE,CAAC;wBACV,2EAA2E;wBAC3E,MAAM,MAAM,GAAG,CAAC,OAA4B,EAAE,KAAa,EAAE,EAAE,CAAC;4BAC9D,IAAA,uCAAwB,EAAC,OAAO,EAAE,KAAK,EAAE;gCACvC,MAAM,EAAE,SAAG;gCACX,WAAW,EAAE,kBAAkB;gCAC/B,YAAY,EAAE,kBAAkB;6BACjC,CAAC,CAAC;wBAAA,CACJ,CAAC;wBAEF,MAAM,CAAC,KAAK,CAAC,OAAO,EAAE,oBAAoB,CAAC,CAAC;wBAC5C,MAAM,CAAC,KAAK,CAAC,IAAI,EAAE,mBAAmB,CAAC,CAAC;wBAExC,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;4BACxB,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,EAAE,kBAAkB,CAAC,CAAC;wBAClD,CAAC;wBACD,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;4BACzB,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,mBAAmB,CAAC,CAAC;wBACpD,CAAC;wBACD,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;4BACzB,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,mBAAmB,CAAC,CAAC;wBACpD,CAAC;oBACH,CAAC;oBAED,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;wBACpB,IAAI,KAAK,CAAC,SAAS,EAAE,CAAC;4BACpB,YAAY,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;wBAChC,CAAC;wBACD,YAAY,EAAE,CAAC;wBACf,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;oBAAA,CAC9B,CAAC;oBAEF,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;oBAC5B,MAAM,CAAC,EAAE,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;oBAC1B,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC;wBAC1B,IAAI,KAAK,CAAC,SAAS,EAAE,CAAC;4BACpB,YAAY,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;wBAChC,CAAC;wBACD,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,iBAAiB,EAAE,CAAC;4BAC7C,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,IAAA,wBAAe,EAAC,GAAG,CAAC,CAAC,CAAC;wBACnD,CAAC;wBACD,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;wBAC7B,YAAY,EAAE,CAAC;oBAAA,CAChB,CAAC,CAAC;oBAEH,MAAM,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE,CAAC;wBAC3C,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;4BACpB,OAAO,EAAE,CAAC;4BACV,OAAO,EAAE,CAAC;wBAAA,CACX,CAAC;wBAEF,MAAM,OAAO,GAAG,CAAC,GAAU,EAAE,EAAE,CAAC;4BAC9B,OAAO,EAAE,CAAC;4BACV,MAAM,CAAC,GAAG,CAAC,CAAC;wBAAA,CACb,CAAC;wBAEF,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;4BACpB,OAAO,EAAE,CAAC;4BACV,MAAM,CAAC,GAAG,EAAE,CAAC;4BACb,YAAY,EAAE,CAAC;4BACf,MAAM,CAAC,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC,CAAC;wBAAA,CACxC,CAAC;wBAEF,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;4BACpB,MAAM,CAAC,GAAG,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;4BAC7B,MAAM,CAAC,GAAG,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;4BAC7B,WAAW,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;wBAAA,CACpD,CAAC;wBAEF,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;wBAC5B,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;wBAC5B,WAAW,EAAE,gBAAgB,CAAC,OAAO,EAAE,OAAO,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;wBAEhE,MAAM,cAAc,GAAG;4BACrB,IAAI,EAAE,cAAc,CAAC,QAAQ;4BAC7B,IAAI,EAAE,cAAc,CAAC,IAAI;4BACzB,QAAQ;4BACR,KAAK,EAAE,aAAa;4BACpB,IAAI,EAAE,KAAK,EAAE,IAAI;4BACjB,YAAY,EAAE,SAAS;4BACvB,iBAAiB,EAAE,IAAI;4BACvB,iBAAiB,EAAE,CAAC;4BACpB,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,EAAE,UAAU,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;yBACtC,CAAC;wBAEF,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;oBAAA,CAChC,CAAC,CAAC;oBAEH,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;wBACzB,MAAM,CAAC,GAAG,EAAE,CAAC;wBACb,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;oBACvC,CAAC;oBAED,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;oBACzB,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;oBACjC,KAAK,CAAC,SAAS,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;wBACjC,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;oBAAA,CACtC,EAAE,eAAe,CAAC,CAAC;oBACpB,OAAO,KAAK,CAAC;gBAAA,CACd,CAAC;gBAEF,KAAK,MAAM,CAAC,KAAK,EAAE,UAAU,CAAC,IAAI,SAAS,CAAC,OAAO,EAAE,EAAE,CAAC;oBACtD,MAAM,SAAS,GAAG,KAAK,KAAK,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC;oBAEjD,IAAI,CAAC;wBACH,OAAO,MAAM,cAAc,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;oBACrD,CAAC;oBAAC,OAAO,KAAK,EAAE,CAAC;wBACf,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,IAAI,SAAS,EAAE,CAAC;4BACvC,MAAM,KAAK,CAAC;wBACd,CAAC;oBACH,CAAC;gBACH,CAAC;gBAED,MAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;YAAA,CAC/C,CAAC;YAEF,MAAM,kBAAkB,GAAG,KAAK,IAAI,iBAAiB,CAAC,MAAM,KAAK,CAAC,CAAC;YACnE,IAAI,kBAAkB,EAAE,CAAC;gBACvB,IAAI,CAAC;oBACH,OAAO,MAAM,iBAAiB,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;gBAC5C,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC;wBAC1B,MAAM,KAAK,CAAC;oBACd,CAAC;gBACH,CAAC;YACH,CAAC;YAED,MAAM,gBAAgB,GAAG,kBAAkB,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,CAAC;YAChE,OAAO,MAAM,iBAAiB,CAAC,qBAAqB,EAAE,gBAAgB,CAAC,CAAC;QAC1E,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,IAAA,wBAAe,EAAC,KAAK,CAAC,CAAC,CAAC;YACnD,MAAM,KAAK,CAAC;QACd,CAAC;IAAA,CACF;CACF;;AAEY,QAAA,kBAAkB,GAAG,IAAI,kBAAkB,EAAE,CAAC","sourcesContent":["/**\r\n * SSH2 Connection Pool\r\n *\r\n * Manages persistent ssh2 Client connections with:\r\n * - Connection reuse (single Client per host)\r\n * - Health tracking + backoff\r\n * - Singleflighting concurrent connection attempts\r\n */\r\n\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport { spawn, type ChildProcess } from \"child_process\";\r\nimport { Duplex } from \"stream\";\r\nimport { Client } from \"ssh2\";\r\nimport { getErrorMessage } from \"@/common/utils/errors\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { attachStreamErrorHandler } from \"@/node/utils/streamErrors\";\r\nimport type { SSHConnectionConfig } from \"./sshConnectionPool\";\r\nimport { resolveSSHConfig, type ResolvedSSHConfig } from \"./sshConfigParser\";\r\n\r\n/**\r\n * Connection health status\r\n */\r\nexport type ConnectionStatus = \"healthy\" | \"unhealthy\" | \"unknown\";\r\n\r\n/**\r\n * Connection health state for a single SSH target\r\n */\r\nexport interface ConnectionHealth {\r\n  status: ConnectionStatus;\r\n  lastSuccess?: Date;\r\n  lastFailure?: Date;\r\n  lastError?: string;\r\n  backoffUntil?: Date;\r\n  consecutiveFailures: number;\r\n}\r\n\r\n/**\r\n * Backoff schedule in seconds: 1s → 2s → 4s → 7s → 10s (cap)\r\n */\r\nconst BACKOFF_SCHEDULE = [1, 2, 4, 7, 10];\r\n\r\nconst DEFAULT_CONNECT_TIMEOUT_MS = 10_000;\r\nconst DEFAULT_MAX_WAIT_MS = 2 * 60 * 1000;\r\n\r\n/**\r\n * Close idle connections after 60 seconds (matches ControlPersist=60).\r\n * This prevents accumulating stale connections to many Coder workspaces.\r\n */\r\nconst IDLE_TIMEOUT_MS = 60 * 1000;\r\n\r\nexport interface AcquireConnectionOptions {\r\n  /** Timeout for the connection attempt. */\r\n  timeoutMs?: number;\r\n\r\n  /**\r\n   * Max time to wait (ms) for a host to become healthy (waits + retries).\r\n   *\r\n   * - Omit to use the default (waits through backoff).\r\n   * - Set to 0 to fail fast.\r\n   */\r\n  maxWaitMs?: number;\r\n\r\n  /** Optional abort signal to cancel any waiting. */\r\n  abortSignal?: AbortSignal;\r\n\r\n  /**\r\n   * Called when acquireConnection is waiting due to backoff.\r\n   */\r\n  onWait?: (waitMs: number) => void;\r\n\r\n  /**\r\n   * Test seam.\r\n   *\r\n   * If provided, this is used for sleeping between wait cycles.\r\n   */\r\n  sleep?: (ms: number, abortSignal?: AbortSignal) => Promise<void>;\r\n}\r\n\r\ninterface SSH2ConnectionEntry {\r\n  client: Client;\r\n  resolvedConfig: ResolvedSSHConfig;\r\n  proxyProcess?: ChildProcess;\r\n  lastActivityAt: number;\r\n  idleTimer?: ReturnType<typeof setTimeout>;\r\n}\r\n\r\nfunction withJitter(seconds: number): number {\r\n  const jitterFactor = 0.8 + Math.random() * 0.4;\r\n  return seconds * jitterFactor;\r\n}\r\n\r\nasync function sleepWithAbort(ms: number, abortSignal?: AbortSignal): Promise<void> {\r\n  if (ms <= 0) return;\r\n  if (abortSignal?.aborted) {\r\n    throw new Error(\"Operation aborted\");\r\n  }\r\n\r\n  await new Promise<void>((resolve, reject) => {\r\n    const timer = setTimeout(() => {\r\n      cleanup();\r\n      resolve();\r\n    }, ms);\r\n\r\n    const onAbort = () => {\r\n      cleanup();\r\n      reject(new Error(\"Operation aborted\"));\r\n    };\r\n\r\n    const cleanup = () => {\r\n      clearTimeout(timer);\r\n      abortSignal?.removeEventListener(\"abort\", onAbort);\r\n    };\r\n\r\n    abortSignal?.addEventListener(\"abort\", onAbort);\r\n  });\r\n}\r\n\r\nfunction getAgentConfig(): string | undefined {\r\n  if (process.env.SSH_AUTH_SOCK) {\r\n    return process.env.SSH_AUTH_SOCK;\r\n  }\r\n\r\n  if (process.platform === \"win32\") {\r\n    return \"pageant\";\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nfunction getDefaultUsername(): string {\r\n  try {\r\n    return os.userInfo().username;\r\n  } catch {\r\n    return process.env.USER ?? process.env.USERNAME ?? \"unknown\";\r\n  }\r\n}\r\n\r\nconst DEFAULT_IDENTITY_FILES = [\r\n  \"~/.ssh/id_rsa\",\r\n  \"~/.ssh/id_ecdsa\",\r\n  \"~/.ssh/id_ecdsa_sk\",\r\n  \"~/.ssh/id_ed25519\",\r\n  \"~/.ssh/id_ed25519_sk\",\r\n  \"~/.ssh/id_dsa\",\r\n];\r\nfunction expandLocalPath(value: string): string {\r\n  if (value === \"~\") {\r\n    return os.homedir();\r\n  }\r\n\r\n  if (value.startsWith(\"~/\") || value.startsWith(\"~\\\\\")) {\r\n    return path.join(os.homedir(), value.slice(2));\r\n  }\r\n\r\n  if (!path.isAbsolute(value)) {\r\n    return path.join(os.homedir(), value);\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nfunction makeConnectionKey(config: SSHConnectionConfig): string {\r\n  const parts = [\r\n    getDefaultUsername(),\r\n    config.host,\r\n    config.port?.toString() ?? \"22\",\r\n    config.identityFile ?? \"default\",\r\n  ];\r\n  return parts.join(\":\");\r\n}\r\n\r\nfunction sanitizeProxyCommand(\r\n  command: string,\r\n  tokens: { host: string; port: number; user: string }\r\n) {\r\n  return command.replace(/%(%|h|p|r)/g, (match, token) => {\r\n    switch (token) {\r\n      case \"%\":\r\n        return \"%\";\r\n      case \"h\":\r\n        return tokens.host;\r\n      case \"p\":\r\n        return String(tokens.port);\r\n      case \"r\":\r\n        return tokens.user;\r\n      default:\r\n        return match;\r\n    }\r\n  });\r\n}\r\n\r\nfunction getProxyShellArgs(command: string): { command: string; args: string[] } {\r\n  if (process.platform === \"win32\") {\r\n    return {\r\n      command: process.env.COMSPEC ?? \"cmd.exe\",\r\n      args: [\"/d\", \"/s\", \"/c\", command],\r\n    };\r\n  }\r\n\r\n  return { command: \"/bin/sh\", args: [\"-c\", command] };\r\n}\r\n\r\nfunction spawnProxyCommand(\r\n  command: string,\r\n  tokens: { host: string; port: number; user: string }\r\n): {\r\n  sock: Duplex;\r\n  process: ChildProcess;\r\n} {\r\n  const substituted = sanitizeProxyCommand(command, tokens);\r\n  const { command: shell, args } = getProxyShellArgs(substituted);\r\n\r\n  const proc = spawn(shell, args, {\r\n    stdio: [\"pipe\", \"pipe\", \"pipe\"],\r\n    windowsHide: true,\r\n  });\r\n\r\n  proc.stderr?.on(\"data\", () => {\r\n    // Drain stderr to avoid blocking proxy process.\r\n  });\r\n\r\n  if (!proc.stdin || !proc.stdout) {\r\n    throw new Error(\"ProxyCommand did not provide stdio streams\");\r\n  }\r\n\r\n  const sock = Duplex.from({ writable: proc.stdin, readable: proc.stdout });\r\n\r\n  return { sock, process: proc };\r\n}\r\n\r\n/**\r\n * Detect if error is due to encrypted key without passphrase.\r\n * ssh2 throws parse errors like \"Cannot parse privateKey: Encrypted private OpenSSH key detected,\r\n * but no passphrase given\" when encountering encrypted keys without a passphrase.\r\n * We treat these as auth failures so the retry loop can skip the key and try agent-only.\r\n */\r\nfunction isEncryptedKeyError(error: unknown): boolean {\r\n  if (!error) {\r\n    return false;\r\n  }\r\n  const message = error instanceof Error ? error.message : typeof error === \"string\" ? error : \"\";\r\n  return (\r\n    message.includes(\"Encrypted private key detected\") ||\r\n    message.includes(\"Encrypted private OpenSSH key detected\") ||\r\n    message.includes(\"Encrypted PPK private key detected\") ||\r\n    (message.includes(\"Cannot parse privateKey\") && message.includes(\"ncrypted\"))\r\n  );\r\n}\r\n\r\nfunction isAuthFailure(error: unknown): boolean {\r\n  if (!error) {\r\n    return false;\r\n  }\r\n\r\n  // Encrypted key without passphrase should be treated as auth failure\r\n  // so we can fall back to agent-only authentication.\r\n  if (isEncryptedKeyError(error)) {\r\n    return true;\r\n  }\r\n\r\n  if (typeof error === \"object\" && error !== null && \"level\" in error) {\r\n    const level = (error as { level?: string }).level;\r\n    if (level === \"client-authentication\") {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  const message = error instanceof Error ? error.message : typeof error === \"string\" ? error : \"\";\r\n  return (\r\n    message.includes(\"All configured authentication methods failed\") ||\r\n    message.includes(\"Authentication failed\") ||\r\n    message.includes(\"Authentication failure\")\r\n  );\r\n}\r\nasync function resolvePrivateKeys(identityFiles: string[]): Promise<Buffer[]> {\r\n  const keys: Buffer[] = [];\r\n\r\n  for (const file of identityFiles) {\r\n    try {\r\n      keys.push(await fs.readFile(file));\r\n    } catch {\r\n      // Try next identity file.\r\n    }\r\n  }\r\n\r\n  return keys;\r\n}\r\n\r\nexport class SSH2ConnectionPool {\r\n  private health = new Map<string, ConnectionHealth>();\r\n  private inflight = new Map<string, Promise<SSH2ConnectionEntry>>();\r\n  private connections = new Map<string, SSH2ConnectionEntry>();\r\n\r\n  async acquireConnection(\r\n    config: SSHConnectionConfig,\r\n    options: AcquireConnectionOptions = {}\r\n  ): Promise<SSH2ConnectionEntry> {\r\n    const key = makeConnectionKey(config);\r\n    const timeoutMs = options.timeoutMs ?? DEFAULT_CONNECT_TIMEOUT_MS;\r\n    const sleep = options.sleep ?? sleepWithAbort;\r\n    const maxWaitMs = options.maxWaitMs ?? DEFAULT_MAX_WAIT_MS;\r\n    const shouldWait = maxWaitMs > 0;\r\n    const startTime = Date.now();\r\n\r\n    while (true) {\r\n      if (options.abortSignal?.aborted) {\r\n        throw new Error(\"Operation aborted\");\r\n      }\r\n\r\n      const existing = this.connections.get(key);\r\n      if (existing) {\r\n        this.touchConnection(existing, key);\r\n        this.markHealthy(config);\r\n        return existing;\r\n      }\r\n\r\n      const health = this.health.get(key);\r\n      if (health?.backoffUntil && health.backoffUntil > new Date()) {\r\n        const remainingMs = health.backoffUntil.getTime() - Date.now();\r\n        const remainingSecs = Math.ceil(remainingMs / 1000);\r\n\r\n        if (!shouldWait) {\r\n          throw new Error(\r\n            `SSH connection to ${config.host} is in backoff for ${remainingSecs}s. ` +\r\n              `Last error: ${health.lastError ?? \"unknown\"}`\r\n          );\r\n        }\r\n\r\n        const elapsedMs = Date.now() - startTime;\r\n        const budgetMs = Math.max(0, maxWaitMs - elapsedMs);\r\n        if (budgetMs <= 0) {\r\n          throw new Error(\r\n            `SSH connection to ${config.host} is in backoff and maxWaitMs exceeded. ` +\r\n              `Last error: ${health.lastError ?? \"unknown\"}`\r\n          );\r\n        }\r\n\r\n        const waitMs = Math.min(remainingMs, budgetMs);\r\n        options.onWait?.(waitMs);\r\n        await sleep(waitMs, options.abortSignal);\r\n        continue;\r\n      }\r\n\r\n      let inflight = this.inflight.get(key);\r\n      if (!inflight) {\r\n        inflight = this.connect(config, timeoutMs, options.abortSignal);\r\n        this.inflight.set(key, inflight);\r\n        // Attach no-op catch to prevent unhandled rejection when singleflighted\r\n        // promise rejects before any caller awaits it. Actual errors are\r\n        // propagated to callers via the await below.\r\n        // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n        void inflight.catch(() => {}).finally(() => this.inflight.delete(key));\r\n      }\r\n\r\n      try {\r\n        const entry = await inflight;\r\n        return entry;\r\n      } catch (error) {\r\n        if (!shouldWait) {\r\n          throw error;\r\n        }\r\n\r\n        const elapsedMs = Date.now() - startTime;\r\n        if (elapsedMs >= maxWaitMs) {\r\n          throw error;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  markHealthy(config: SSHConnectionConfig): void {\r\n    const key = makeConnectionKey(config);\r\n    const existing = this.health.get(key);\r\n    this.health.set(key, {\r\n      status: \"healthy\",\r\n      lastSuccess: new Date(),\r\n      consecutiveFailures: 0,\r\n      lastFailure: existing?.lastFailure,\r\n      lastError: existing?.lastError,\r\n    });\r\n  }\r\n\r\n  reportFailure(config: SSHConnectionConfig, errorMessage: string): void {\r\n    const key = makeConnectionKey(config);\r\n    const now = new Date();\r\n    const current = this.health.get(key);\r\n    const failures = (current?.consecutiveFailures ?? 0) + 1;\r\n    const backoffIndex = Math.min(failures - 1, BACKOFF_SCHEDULE.length - 1);\r\n    const backoffSeconds = withJitter(BACKOFF_SCHEDULE[backoffIndex]);\r\n\r\n    this.health.set(key, {\r\n      status: \"unhealthy\",\r\n      lastFailure: now,\r\n      lastError: errorMessage,\r\n      consecutiveFailures: failures,\r\n      backoffUntil: new Date(Date.now() + backoffSeconds * 1000),\r\n      lastSuccess: current?.lastSuccess,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear all health state. Used in tests to reset between test cases\r\n   * so backoff from one test doesn't affect subsequent tests.\r\n   */\r\n  clearAllHealth(): void {\r\n    this.health.clear();\r\n    this.inflight.clear();\r\n  }\r\n\r\n  /**\r\n   * Update last activity time and reset idle timer.\r\n   * Called on each acquireConnection() to keep active connections alive.\r\n   */\r\n  private touchConnection(entry: SSH2ConnectionEntry, key: string): void {\r\n    entry.lastActivityAt = Date.now();\r\n\r\n    // Clear existing idle timer\r\n    if (entry.idleTimer) {\r\n      clearTimeout(entry.idleTimer);\r\n    }\r\n\r\n    // Set new idle timer\r\n    entry.idleTimer = setTimeout(() => {\r\n      this.closeIdleConnection(key, entry);\r\n    }, IDLE_TIMEOUT_MS);\r\n  }\r\n\r\n  /**\r\n   * Close a connection that has been idle for too long.\r\n   */\r\n  private closeIdleConnection(key: string, entry: SSH2ConnectionEntry): void {\r\n    // Verify this is still the active connection for this key\r\n    if (this.connections.get(key) !== entry) {\r\n      return;\r\n    }\r\n\r\n    this.connections.delete(key);\r\n\r\n    try {\r\n      entry.client.end();\r\n    } catch {\r\n      // Ignore errors closing the connection\r\n    }\r\n\r\n    if (entry.proxyProcess?.exitCode === null) {\r\n      try {\r\n        entry.proxyProcess.kill();\r\n      } catch {\r\n        // Ignore errors killing proxy\r\n      }\r\n    }\r\n  }\r\n\r\n  private async connect(\r\n    config: SSHConnectionConfig,\r\n    timeoutMs: number,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<SSH2ConnectionEntry> {\r\n    const key = makeConnectionKey(config);\r\n    try {\r\n      const resolved = await resolveSSHConfig(config.host);\r\n      const resolvedConfig: ResolvedSSHConfig = {\r\n        ...resolved,\r\n        port: config.port ?? resolved.port,\r\n        identityFiles: config.identityFile\r\n          ? [expandLocalPath(config.identityFile)]\r\n          : resolved.identityFiles,\r\n      };\r\n      const agent = getAgentConfig();\r\n      const baseIdentityFiles =\r\n        resolvedConfig.identityFiles.length > 0 ? resolvedConfig.identityFiles : [];\r\n      const fallbackIdentityFiles =\r\n        baseIdentityFiles.length > 0\r\n          ? baseIdentityFiles\r\n          : DEFAULT_IDENTITY_FILES.map((file) => expandLocalPath(file));\r\n      const username = resolvedConfig.user ?? getDefaultUsername();\r\n      const proxyTokens = {\r\n        host: resolvedConfig.hostName,\r\n        port: resolvedConfig.port,\r\n        user: username,\r\n      };\r\n\r\n      const attemptConnection = async (\r\n        identityFiles: string[],\r\n        agentOverride: string | undefined\r\n      ): Promise<SSH2ConnectionEntry> => {\r\n        const resolvedConfigWithIdentities: ResolvedSSHConfig = {\r\n          ...resolvedConfig,\r\n          identityFiles,\r\n        };\r\n\r\n        const readableKeys = await resolvePrivateKeys(resolvedConfigWithIdentities.identityFiles);\r\n        const keysToTry: Array<Buffer | undefined> =\r\n          readableKeys.length > 0 ? readableKeys : [undefined];\r\n\r\n        const connectWithKey = async (\r\n          privateKey: Buffer | undefined,\r\n          reportAuthFailure: boolean\r\n        ): Promise<SSH2ConnectionEntry> => {\r\n          const proxy = resolvedConfigWithIdentities.proxyCommand\r\n            ? spawnProxyCommand(resolvedConfigWithIdentities.proxyCommand, proxyTokens)\r\n            : undefined;\r\n\r\n          const client = new Client();\r\n          const entry: SSH2ConnectionEntry = {\r\n            client,\r\n            resolvedConfig: resolvedConfigWithIdentities,\r\n            proxyProcess: proxy?.process,\r\n            lastActivityAt: Date.now(),\r\n          };\r\n\r\n          const cleanupProxy = () => {\r\n            if (proxy?.process?.exitCode === null) {\r\n              proxy.process.kill();\r\n            }\r\n          };\r\n\r\n          const cleanupProxySocket = () => {\r\n            if (proxy?.sock && !proxy.sock.destroyed) {\r\n              proxy.sock.destroy();\r\n            }\r\n            cleanupProxy();\r\n          };\r\n\r\n          if (proxy) {\r\n            // ProxyCommand streams can emit EPIPE/ECONNRESET; handle to avoid crashes.\r\n            const attach = (emitter: NodeJS.EventEmitter, label: string) => {\r\n              attachStreamErrorHandler(emitter, label, {\r\n                logger: log,\r\n                onIgnorable: cleanupProxySocket,\r\n                onUnexpected: cleanupProxySocket,\r\n              });\r\n            };\r\n\r\n            attach(proxy.process, \"ssh2-proxy-process\");\r\n            attach(proxy.sock, \"ssh2-proxy-socket\");\r\n\r\n            if (proxy.process.stdin) {\r\n              attach(proxy.process.stdin, \"ssh2-proxy-stdin\");\r\n            }\r\n            if (proxy.process.stdout) {\r\n              attach(proxy.process.stdout, \"ssh2-proxy-stdout\");\r\n            }\r\n            if (proxy.process.stderr) {\r\n              attach(proxy.process.stderr, \"ssh2-proxy-stderr\");\r\n            }\r\n          }\r\n\r\n          const onClose = () => {\r\n            if (entry.idleTimer) {\r\n              clearTimeout(entry.idleTimer);\r\n            }\r\n            cleanupProxy();\r\n            this.connections.delete(key);\r\n          };\r\n\r\n          client.on(\"close\", onClose);\r\n          client.on(\"end\", onClose);\r\n          client.on(\"error\", (err) => {\r\n            if (entry.idleTimer) {\r\n              clearTimeout(entry.idleTimer);\r\n            }\r\n            if (!isAuthFailure(err) || reportAuthFailure) {\r\n              this.reportFailure(config, getErrorMessage(err));\r\n            }\r\n            this.connections.delete(key);\r\n            cleanupProxy();\r\n          });\r\n\r\n          await new Promise<void>((resolve, reject) => {\r\n            const onReady = () => {\r\n              cleanup();\r\n              resolve();\r\n            };\r\n\r\n            const onError = (err: Error) => {\r\n              cleanup();\r\n              reject(err);\r\n            };\r\n\r\n            const onAbort = () => {\r\n              cleanup();\r\n              client.end();\r\n              cleanupProxy();\r\n              reject(new Error(\"Operation aborted\"));\r\n            };\r\n\r\n            const cleanup = () => {\r\n              client.off(\"ready\", onReady);\r\n              client.off(\"error\", onError);\r\n              abortSignal?.removeEventListener(\"abort\", onAbort);\r\n            };\r\n\r\n            client.on(\"ready\", onReady);\r\n            client.on(\"error\", onError);\r\n            abortSignal?.addEventListener(\"abort\", onAbort, { once: true });\r\n\r\n            const connectOptions = {\r\n              host: resolvedConfig.hostName,\r\n              port: resolvedConfig.port,\r\n              username,\r\n              agent: agentOverride,\r\n              sock: proxy?.sock,\r\n              readyTimeout: timeoutMs,\r\n              keepaliveInterval: 5000,\r\n              keepaliveCountMax: 2,\r\n              ...(privateKey ? { privateKey } : {}),\r\n            };\r\n\r\n            client.connect(connectOptions);\r\n          });\r\n\r\n          if (abortSignal?.aborted) {\r\n            client.end();\r\n            throw new Error(\"Operation aborted\");\r\n          }\r\n\r\n          this.markHealthy(config);\r\n          this.connections.set(key, entry);\r\n          entry.idleTimer = setTimeout(() => {\r\n            this.closeIdleConnection(key, entry);\r\n          }, IDLE_TIMEOUT_MS);\r\n          return entry;\r\n        };\r\n\r\n        for (const [index, privateKey] of keysToTry.entries()) {\r\n          const isLastKey = index === keysToTry.length - 1;\r\n\r\n          try {\r\n            return await connectWithKey(privateKey, isLastKey);\r\n          } catch (error) {\r\n            if (!isAuthFailure(error) || isLastKey) {\r\n              throw error;\r\n            }\r\n          }\r\n        }\r\n\r\n        throw new Error(\"SSH2 authentication failed\");\r\n      };\r\n\r\n      const shouldTryAgentOnly = agent && baseIdentityFiles.length === 0;\r\n      if (shouldTryAgentOnly) {\r\n        try {\r\n          return await attemptConnection([], agent);\r\n        } catch (error) {\r\n          if (!isAuthFailure(error)) {\r\n            throw error;\r\n          }\r\n        }\r\n      }\r\n\r\n      const agentForFallback = shouldTryAgentOnly ? undefined : agent;\r\n      return await attemptConnection(fallbackIdentityFiles, agentForFallback);\r\n    } catch (error) {\r\n      this.reportFailure(config, getErrorMessage(error));\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nexport const ssh2ConnectionPool = new SSH2ConnectionPool();\r\n"]}