{"version":3,"file":"SSH2ConnectionPool.js","sourceRoot":"","sources":["../../../src/node/runtime/SSH2ConnectionPool.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * SSH2 Connection Pool\n *\n * Manages persistent ssh2 Client connections with:\n * - Connection reuse (single Client per host)\n * - Health tracking + backoff\n * - Singleflighting concurrent connection attempts\n */\n\nimport * as fs from \"fs/promises\";\nimport * as os from \"os\";\nimport * as path from \"path\";\nimport { spawn, type ChildProcess } from \"child_process\";\nimport { Duplex } from \"stream\";\nimport { Client } from \"ssh2\";\nimport { getErrorMessage } from \"@/common/utils/errors\";\nimport { log } from \"@/node/services/log\";\nimport { attachStreamErrorHandler } from \"@/node/utils/streamErrors\";\nimport type { SSHConnectionConfig } from \"./sshConnectionPool\";\nimport { resolveSSHConfig, type ResolvedSSHConfig } from \"./sshConfigParser\";\n\n/**\n * Connection health status\n */\nexport type ConnectionStatus = \"healthy\" | \"unhealthy\" | \"unknown\";\n\n/**\n * Connection health state for a single SSH target\n */\nexport interface ConnectionHealth {\n  status: ConnectionStatus;\n  lastSuccess?: Date;\n  lastFailure?: Date;\n  lastError?: string;\n  backoffUntil?: Date;\n  consecutiveFailures: number;\n}\n\n/**\n * Backoff schedule in seconds: 1s → 2s → 4s → 7s → 10s (cap)\n */\nconst BACKOFF_SCHEDULE = [1, 2, 4, 7, 10];\n\nconst DEFAULT_CONNECT_TIMEOUT_MS = 10_000;\nconst DEFAULT_MAX_WAIT_MS = 2 * 60 * 1000;\n\n/**\n * Close idle connections after 60 seconds (matches ControlPersist=60).\n * This prevents accumulating stale connections to many Coder workspaces.\n */\nconst IDLE_TIMEOUT_MS = 60 * 1000;\n\nexport interface AcquireConnectionOptions {\n  /** Timeout for the connection attempt. */\n  timeoutMs?: number;\n\n  /**\n   * Max time to wait (ms) for a host to become healthy (waits + retries).\n   *\n   * - Omit to use the default (waits through backoff).\n   * - Set to 0 to fail fast.\n   */\n  maxWaitMs?: number;\n\n  /** Optional abort signal to cancel any waiting. */\n  abortSignal?: AbortSignal;\n\n  /**\n   * Called when acquireConnection is waiting due to backoff.\n   */\n  onWait?: (waitMs: number) => void;\n\n  /**\n   * Test seam.\n   *\n   * If provided, this is used for sleeping between wait cycles.\n   */\n  sleep?: (ms: number, abortSignal?: AbortSignal) => Promise<void>;\n}\n\ninterface SSH2ConnectionEntry {\n  client: Client;\n  resolvedConfig: ResolvedSSHConfig;\n  proxyProcess?: ChildProcess;\n  lastActivityAt: number;\n  idleTimer?: ReturnType<typeof setTimeout>;\n}\n\nfunction withJitter(seconds: number): number {\n  const jitterFactor = 0.8 + Math.random() * 0.4;\n  return seconds * jitterFactor;\n}\n\nasync function sleepWithAbort(ms: number, abortSignal?: AbortSignal): Promise<void> {\n  if (ms <= 0) return;\n  if (abortSignal?.aborted) {\n    throw new Error(\"Operation aborted\");\n  }\n\n  await new Promise<void>((resolve, reject) => {\n    const timer = setTimeout(() => {\n      cleanup();\n      resolve();\n    }, ms);\n\n    const onAbort = () => {\n      cleanup();\n      reject(new Error(\"Operation aborted\"));\n    };\n\n    const cleanup = () => {\n      clearTimeout(timer);\n      abortSignal?.removeEventListener(\"abort\", onAbort);\n    };\n\n    abortSignal?.addEventListener(\"abort\", onAbort);\n  });\n}\n\nfunction getAgentConfig(): string | undefined {\n  if (process.env.SSH_AUTH_SOCK) {\n    return process.env.SSH_AUTH_SOCK;\n  }\n\n  if (process.platform === \"win32\") {\n    return \"pageant\";\n  }\n\n  return undefined;\n}\n\nfunction getDefaultUsername(): string {\n  try {\n    return os.userInfo().username;\n  } catch {\n    return process.env.USER ?? process.env.USERNAME ?? \"unknown\";\n  }\n}\n\nconst DEFAULT_IDENTITY_FILES = [\n  \"~/.ssh/id_rsa\",\n  \"~/.ssh/id_ecdsa\",\n  \"~/.ssh/id_ecdsa_sk\",\n  \"~/.ssh/id_ed25519\",\n  \"~/.ssh/id_ed25519_sk\",\n  \"~/.ssh/id_dsa\",\n];\nfunction expandLocalPath(value: string): string {\n  if (value === \"~\") {\n    return os.homedir();\n  }\n\n  if (value.startsWith(\"~/\") || value.startsWith(\"~\\\\\")) {\n    return path.join(os.homedir(), value.slice(2));\n  }\n\n  if (!path.isAbsolute(value)) {\n    return path.join(os.homedir(), value);\n  }\n\n  return value;\n}\n\nfunction makeConnectionKey(config: SSHConnectionConfig): string {\n  const parts = [\n    getDefaultUsername(),\n    config.host,\n    config.port?.toString() ?? \"22\",\n    config.identityFile ?? \"default\",\n  ];\n  return parts.join(\":\");\n}\n\nfunction sanitizeProxyCommand(\n  command: string,\n  tokens: { host: string; port: number; user: string }\n) {\n  return command.replace(/%(%|h|p|r)/g, (match, token) => {\n    switch (token) {\n      case \"%\":\n        return \"%\";\n      case \"h\":\n        return tokens.host;\n      case \"p\":\n        return String(tokens.port);\n      case \"r\":\n        return tokens.user;\n      default:\n        return match;\n    }\n  });\n}\n\nfunction getProxyShellArgs(command: string): { command: string; args: string[] } {\n  if (process.platform === \"win32\") {\n    return {\n      command: process.env.COMSPEC ?? \"cmd.exe\",\n      args: [\"/d\", \"/s\", \"/c\", command],\n    };\n  }\n\n  return { command: \"/bin/sh\", args: [\"-c\", command] };\n}\n\nfunction spawnProxyCommand(\n  command: string,\n  tokens: { host: string; port: number; user: string }\n): {\n  sock: Duplex;\n  process: ChildProcess;\n} {\n  const substituted = sanitizeProxyCommand(command, tokens);\n  const { command: shell, args } = getProxyShellArgs(substituted);\n\n  const proc = spawn(shell, args, {\n    stdio: [\"pipe\", \"pipe\", \"pipe\"],\n    windowsHide: true,\n  });\n\n  proc.stderr?.on(\"data\", () => {\n    // Drain stderr to avoid blocking proxy process.\n  });\n\n  if (!proc.stdin || !proc.stdout) {\n    throw new Error(\"ProxyCommand did not provide stdio streams\");\n  }\n\n  const sock = Duplex.from({ writable: proc.stdin, readable: proc.stdout });\n\n  return { sock, process: proc };\n}\n\n/**\n * Detect if error is due to encrypted key without passphrase.\n * ssh2 throws parse errors like \"Cannot parse privateKey: Encrypted private OpenSSH key detected,\n * but no passphrase given\" when encountering encrypted keys without a passphrase.\n * We treat these as auth failures so the retry loop can skip the key and try agent-only.\n */\nfunction isEncryptedKeyError(error: unknown): boolean {\n  if (!error) {\n    return false;\n  }\n  const message = error instanceof Error ? error.message : typeof error === \"string\" ? error : \"\";\n  return (\n    message.includes(\"Encrypted private key detected\") ||\n    message.includes(\"Encrypted private OpenSSH key detected\") ||\n    message.includes(\"Encrypted PPK private key detected\") ||\n    (message.includes(\"Cannot parse privateKey\") && message.includes(\"ncrypted\"))\n  );\n}\n\nfunction isAuthFailure(error: unknown): boolean {\n  if (!error) {\n    return false;\n  }\n\n  // Encrypted key without passphrase should be treated as auth failure\n  // so we can fall back to agent-only authentication.\n  if (isEncryptedKeyError(error)) {\n    return true;\n  }\n\n  if (typeof error === \"object\" && error !== null && \"level\" in error) {\n    const level = (error as { level?: string }).level;\n    if (level === \"client-authentication\") {\n      return true;\n    }\n  }\n\n  const message = error instanceof Error ? error.message : typeof error === \"string\" ? error : \"\";\n  return (\n    message.includes(\"All configured authentication methods failed\") ||\n    message.includes(\"Authentication failed\") ||\n    message.includes(\"Authentication failure\")\n  );\n}\nasync function resolvePrivateKeys(identityFiles: string[]): Promise<Buffer[]> {\n  const keys: Buffer[] = [];\n\n  for (const file of identityFiles) {\n    try {\n      keys.push(await fs.readFile(file));\n    } catch {\n      // Try next identity file.\n    }\n  }\n\n  return keys;\n}\n\nexport class SSH2ConnectionPool {\n  private health = new Map<string, ConnectionHealth>();\n  private inflight = new Map<string, Promise<SSH2ConnectionEntry>>();\n  private connections = new Map<string, SSH2ConnectionEntry>();\n\n  async acquireConnection(\n    config: SSHConnectionConfig,\n    options: AcquireConnectionOptions = {}\n  ): Promise<SSH2ConnectionEntry> {\n    const key = makeConnectionKey(config);\n    const timeoutMs = options.timeoutMs ?? DEFAULT_CONNECT_TIMEOUT_MS;\n    const sleep = options.sleep ?? sleepWithAbort;\n    const maxWaitMs = options.maxWaitMs ?? DEFAULT_MAX_WAIT_MS;\n    const shouldWait = maxWaitMs > 0;\n    const startTime = Date.now();\n\n    while (true) {\n      if (options.abortSignal?.aborted) {\n        throw new Error(\"Operation aborted\");\n      }\n\n      const existing = this.connections.get(key);\n      if (existing) {\n        this.touchConnection(existing, key);\n        this.markHealthy(config);\n        return existing;\n      }\n\n      const health = this.health.get(key);\n      if (health?.backoffUntil && health.backoffUntil > new Date()) {\n        const remainingMs = health.backoffUntil.getTime() - Date.now();\n        const remainingSecs = Math.ceil(remainingMs / 1000);\n\n        if (!shouldWait) {\n          throw new Error(\n            `SSH connection to ${config.host} is in backoff for ${remainingSecs}s. ` +\n              `Last error: ${health.lastError ?? \"unknown\"}`\n          );\n        }\n\n        const elapsedMs = Date.now() - startTime;\n        const budgetMs = Math.max(0, maxWaitMs - elapsedMs);\n        if (budgetMs <= 0) {\n          throw new Error(\n            `SSH connection to ${config.host} is in backoff and maxWaitMs exceeded. ` +\n              `Last error: ${health.lastError ?? \"unknown\"}`\n          );\n        }\n\n        const waitMs = Math.min(remainingMs, budgetMs);\n        options.onWait?.(waitMs);\n        await sleep(waitMs, options.abortSignal);\n        continue;\n      }\n\n      let inflight = this.inflight.get(key);\n      if (!inflight) {\n        inflight = this.connect(config, timeoutMs, options.abortSignal);\n        this.inflight.set(key, inflight);\n        // Attach no-op catch to prevent unhandled rejection when singleflighted\n        // promise rejects before any caller awaits it. Actual errors are\n        // propagated to callers via the await below.\n        // eslint-disable-next-line @typescript-eslint/no-empty-function\n        void inflight.catch(() => {}).finally(() => this.inflight.delete(key));\n      }\n\n      try {\n        const entry = await inflight;\n        return entry;\n      } catch (error) {\n        if (!shouldWait) {\n          throw error;\n        }\n\n        const elapsedMs = Date.now() - startTime;\n        if (elapsedMs >= maxWaitMs) {\n          throw error;\n        }\n      }\n    }\n  }\n\n  markHealthy(config: SSHConnectionConfig): void {\n    const key = makeConnectionKey(config);\n    const existing = this.health.get(key);\n    this.health.set(key, {\n      status: \"healthy\",\n      lastSuccess: new Date(),\n      consecutiveFailures: 0,\n      lastFailure: existing?.lastFailure,\n      lastError: existing?.lastError,\n    });\n  }\n\n  reportFailure(config: SSHConnectionConfig, errorMessage: string): void {\n    const key = makeConnectionKey(config);\n    const now = new Date();\n    const current = this.health.get(key);\n    const failures = (current?.consecutiveFailures ?? 0) + 1;\n    const backoffIndex = Math.min(failures - 1, BACKOFF_SCHEDULE.length - 1);\n    const backoffSeconds = withJitter(BACKOFF_SCHEDULE[backoffIndex]);\n\n    this.health.set(key, {\n      status: \"unhealthy\",\n      lastFailure: now,\n      lastError: errorMessage,\n      consecutiveFailures: failures,\n      backoffUntil: new Date(Date.now() + backoffSeconds * 1000),\n      lastSuccess: current?.lastSuccess,\n    });\n  }\n\n  /**\n   * Clear all health state. Used in tests to reset between test cases\n   * so backoff from one test doesn't affect subsequent tests.\n   */\n  clearAllHealth(): void {\n    this.health.clear();\n    this.inflight.clear();\n  }\n\n  /**\n   * Update last activity time and reset idle timer.\n   * Called on each acquireConnection() to keep active connections alive.\n   */\n  private touchConnection(entry: SSH2ConnectionEntry, key: string): void {\n    entry.lastActivityAt = Date.now();\n\n    // Clear existing idle timer\n    if (entry.idleTimer) {\n      clearTimeout(entry.idleTimer);\n    }\n\n    // Set new idle timer\n    entry.idleTimer = setTimeout(() => {\n      this.closeIdleConnection(key, entry);\n    }, IDLE_TIMEOUT_MS);\n  }\n\n  /**\n   * Close a connection that has been idle for too long.\n   */\n  private closeIdleConnection(key: string, entry: SSH2ConnectionEntry): void {\n    // Verify this is still the active connection for this key\n    if (this.connections.get(key) !== entry) {\n      return;\n    }\n\n    this.connections.delete(key);\n\n    try {\n      entry.client.end();\n    } catch {\n      // Ignore errors closing the connection\n    }\n\n    if (entry.proxyProcess?.exitCode === null) {\n      try {\n        entry.proxyProcess.kill();\n      } catch {\n        // Ignore errors killing proxy\n      }\n    }\n  }\n\n  private async connect(\n    config: SSHConnectionConfig,\n    timeoutMs: number,\n    abortSignal?: AbortSignal\n  ): Promise<SSH2ConnectionEntry> {\n    const key = makeConnectionKey(config);\n    try {\n      const resolved = await resolveSSHConfig(config.host);\n      const resolvedConfig: ResolvedSSHConfig = {\n        ...resolved,\n        port: config.port ?? resolved.port,\n        identityFiles: config.identityFile\n          ? [expandLocalPath(config.identityFile)]\n          : resolved.identityFiles,\n      };\n      const agent = getAgentConfig();\n      const baseIdentityFiles =\n        resolvedConfig.identityFiles.length > 0 ? resolvedConfig.identityFiles : [];\n      const fallbackIdentityFiles =\n        baseIdentityFiles.length > 0\n          ? baseIdentityFiles\n          : DEFAULT_IDENTITY_FILES.map((file) => expandLocalPath(file));\n      const username = resolvedConfig.user ?? getDefaultUsername();\n      const proxyTokens = {\n        host: resolvedConfig.hostName,\n        port: resolvedConfig.port,\n        user: username,\n      };\n\n      const attemptConnection = async (\n        identityFiles: string[],\n        agentOverride: string | undefined\n      ): Promise<SSH2ConnectionEntry> => {\n        const resolvedConfigWithIdentities: ResolvedSSHConfig = {\n          ...resolvedConfig,\n          identityFiles,\n        };\n\n        const readableKeys = await resolvePrivateKeys(resolvedConfigWithIdentities.identityFiles);\n        const keysToTry: Array<Buffer | undefined> =\n          readableKeys.length > 0 ? readableKeys : [undefined];\n\n        const connectWithKey = async (\n          privateKey: Buffer | undefined,\n          reportAuthFailure: boolean\n        ): Promise<SSH2ConnectionEntry> => {\n          const proxy = resolvedConfigWithIdentities.proxyCommand\n            ? spawnProxyCommand(resolvedConfigWithIdentities.proxyCommand, proxyTokens)\n            : undefined;\n\n          const client = new Client();\n          const entry: SSH2ConnectionEntry = {\n            client,\n            resolvedConfig: resolvedConfigWithIdentities,\n            proxyProcess: proxy?.process,\n            lastActivityAt: Date.now(),\n          };\n\n          const cleanupProxy = () => {\n            if (proxy?.process?.exitCode === null) {\n              proxy.process.kill();\n            }\n          };\n\n          const cleanupProxySocket = () => {\n            if (proxy?.sock && !proxy.sock.destroyed) {\n              proxy.sock.destroy();\n            }\n            cleanupProxy();\n          };\n\n          if (proxy) {\n            // ProxyCommand streams can emit EPIPE/ECONNRESET; handle to avoid crashes.\n            const attach = (emitter: NodeJS.EventEmitter, label: string) => {\n              attachStreamErrorHandler(emitter, label, {\n                logger: log,\n                onIgnorable: cleanupProxySocket,\n                onUnexpected: cleanupProxySocket,\n              });\n            };\n\n            attach(proxy.process, \"ssh2-proxy-process\");\n            attach(proxy.sock, \"ssh2-proxy-socket\");\n\n            if (proxy.process.stdin) {\n              attach(proxy.process.stdin, \"ssh2-proxy-stdin\");\n            }\n            if (proxy.process.stdout) {\n              attach(proxy.process.stdout, \"ssh2-proxy-stdout\");\n            }\n            if (proxy.process.stderr) {\n              attach(proxy.process.stderr, \"ssh2-proxy-stderr\");\n            }\n          }\n\n          const onClose = () => {\n            if (entry.idleTimer) {\n              clearTimeout(entry.idleTimer);\n            }\n            cleanupProxy();\n            this.connections.delete(key);\n          };\n\n          client.on(\"close\", onClose);\n          client.on(\"end\", onClose);\n          client.on(\"error\", (err) => {\n            if (entry.idleTimer) {\n              clearTimeout(entry.idleTimer);\n            }\n            if (!isAuthFailure(err) || reportAuthFailure) {\n              this.reportFailure(config, getErrorMessage(err));\n            }\n            this.connections.delete(key);\n            cleanupProxy();\n          });\n\n          await new Promise<void>((resolve, reject) => {\n            const onReady = () => {\n              cleanup();\n              resolve();\n            };\n\n            const onError = (err: Error) => {\n              cleanup();\n              reject(err);\n            };\n\n            const onAbort = () => {\n              cleanup();\n              client.end();\n              cleanupProxy();\n              reject(new Error(\"Operation aborted\"));\n            };\n\n            const cleanup = () => {\n              client.off(\"ready\", onReady);\n              client.off(\"error\", onError);\n              abortSignal?.removeEventListener(\"abort\", onAbort);\n            };\n\n            client.on(\"ready\", onReady);\n            client.on(\"error\", onError);\n            abortSignal?.addEventListener(\"abort\", onAbort, { once: true });\n\n            const connectOptions = {\n              host: resolvedConfig.hostName,\n              port: resolvedConfig.port,\n              username,\n              agent: agentOverride,\n              sock: proxy?.sock,\n              readyTimeout: timeoutMs,\n              keepaliveInterval: 5000,\n              keepaliveCountMax: 2,\n              ...(privateKey ? { privateKey } : {}),\n            };\n\n            client.connect(connectOptions);\n          });\n\n          if (abortSignal?.aborted) {\n            client.end();\n            throw new Error(\"Operation aborted\");\n          }\n\n          this.markHealthy(config);\n          this.connections.set(key, entry);\n          entry.idleTimer = setTimeout(() => {\n            this.closeIdleConnection(key, entry);\n          }, IDLE_TIMEOUT_MS);\n          return entry;\n        };\n\n        for (const [index, privateKey] of keysToTry.entries()) {\n          const isLastKey = index === keysToTry.length - 1;\n\n          try {\n            return await connectWithKey(privateKey, isLastKey);\n          } catch (error) {\n            if (!isAuthFailure(error) || isLastKey) {\n              throw error;\n            }\n          }\n        }\n\n        throw new Error(\"SSH2 authentication failed\");\n      };\n\n      const shouldTryAgentOnly = agent && baseIdentityFiles.length === 0;\n      if (shouldTryAgentOnly) {\n        try {\n          return await attemptConnection([], agent);\n        } catch (error) {\n          if (!isAuthFailure(error)) {\n            throw error;\n          }\n        }\n      }\n\n      const agentForFallback = shouldTryAgentOnly ? undefined : agent;\n      return await attemptConnection(fallbackIdentityFiles, agentForFallback);\n    } catch (error) {\n      this.reportFailure(config, getErrorMessage(error));\n      throw error;\n    }\n  }\n}\n\nexport const ssh2ConnectionPool = new SSH2ConnectionPool();\n"]}