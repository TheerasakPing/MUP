{"version":3,"file":"DockerRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/DockerRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Docker runtime implementation that executes commands inside Docker containers.\r\n *\r\n * Features:\r\n * - Each workspace runs in its own container\r\n * - Container name derived from project+workspace name\r\n * - Uses docker exec for command execution\r\n * - Hardcoded paths: srcBaseDir=/src, bgOutputDir=/tmp/mux-bashes\r\n * - Managed lifecycle: container created/destroyed with workspace\r\n *\r\n * Extends RemoteRuntime for shared exec/file operations.\r\n */\r\n\r\nimport { spawn, exec } from \"child_process\";\r\nimport { createHash } from \"crypto\";\r\nimport * as path from \"path\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as os from \"os\";\r\nimport type {\r\n  ExecOptions,\r\n  WorkspaceCreationParams,\r\n  WorkspaceCreationResult,\r\n  WorkspaceInitParams,\r\n  WorkspaceInitResult,\r\n  WorkspaceForkParams,\r\n  WorkspaceForkResult,\r\n  InitLogger,\r\n  EnsureReadyResult,\r\n} from \"./Runtime\";\r\nimport { RuntimeError } from \"./Runtime\";\r\nimport { RemoteRuntime, type SpawnResult } from \"./RemoteRuntime\";\r\nimport { checkInitHookExists, getMuxEnv, runInitHookOnRuntime } from \"./initHook\";\r\nimport { getProjectName } from \"@/node/utils/runtime/helpers\";\r\nimport { getErrorMessage } from \"@/common/utils/errors\";\r\nimport { syncProjectViaGitBundle } from \"./gitBundleSync\";\r\nimport {\r\n  getHostGitconfigPath,\r\n  hasHostGitconfig,\r\n  resolveGhToken,\r\n  resolveSshAgentForwarding,\r\n} from \"./credentialForwarding\";\r\nimport { streamToString, shescape } from \"./streamUtils\";\r\n\r\n/** Hardcoded source directory inside container */\r\nconst CONTAINER_SRC_DIR = \"/src\";\r\n\r\n/**\r\n * Result of running a Docker command\r\n */\r\ninterface DockerCommandResult {\r\n  exitCode: number;\r\n  stdout: string;\r\n  stderr: string;\r\n}\r\n\r\n/** Result of checking if a container already exists and is valid for reuse */\r\ntype ContainerCheckResult =\r\n  | { action: \"skip\" } // Valid forked container, skip setup\r\n  | { action: \"cleanup\"; reason: string } // Exists but invalid, needs removal\r\n  | { action: \"create\" }; // Doesn't exist, proceed to create\r\n\r\n/**\r\n * Run a Docker CLI command and return result.\r\n * Unlike execAsync, this always resolves (never rejects) and returns exit code.\r\n */\r\nfunction runDockerCommand(command: string, timeoutMs = 30000): Promise<DockerCommandResult> {\r\n  return new Promise((resolve) => {\r\n    let stdout = \"\";\r\n    let stderr = \"\";\r\n    let timedOut = false;\r\n\r\n    const child = exec(command);\r\n\r\n    const timer = setTimeout(() => {\r\n      timedOut = true;\r\n      child.kill();\r\n      resolve({ exitCode: -1, stdout, stderr: \"Command timed out\" });\r\n    }, timeoutMs);\r\n\r\n    child.stdout?.on(\"data\", (data: Buffer) => {\r\n      stdout += data.toString();\r\n    });\r\n\r\n    child.stderr?.on(\"data\", (data: Buffer) => {\r\n      stderr += data.toString();\r\n    });\r\n\r\n    child.on(\"close\", (code) => {\r\n      clearTimeout(timer);\r\n      if (timedOut) return;\r\n      resolve({ exitCode: code ?? -1, stdout, stderr });\r\n    });\r\n\r\n    child.on(\"error\", (err) => {\r\n      clearTimeout(timer);\r\n      if (timedOut) return;\r\n      resolve({ exitCode: -1, stdout, stderr: err.message });\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Run a command with array args (no shell interpolation).\r\n * Similar to runDockerCommand but safer for paths with special characters.\r\n */\r\nfunction runSpawnCommand(\r\n  command: string,\r\n  args: string[],\r\n  timeoutMs = 30000\r\n): Promise<DockerCommandResult> {\r\n  return new Promise((resolve) => {\r\n    let stdout = \"\";\r\n    let stderr = \"\";\r\n    let timedOut = false;\r\n\r\n    const child = spawn(command, args);\r\n\r\n    const timer = setTimeout(() => {\r\n      timedOut = true;\r\n      child.kill();\r\n      resolve({ exitCode: -1, stdout, stderr: \"Command timed out\" });\r\n    }, timeoutMs);\r\n\r\n    child.stdout?.on(\"data\", (data: Buffer) => {\r\n      stdout += data.toString();\r\n    });\r\n\r\n    child.stderr?.on(\"data\", (data: Buffer) => {\r\n      stderr += data.toString();\r\n    });\r\n\r\n    child.on(\"close\", (code) => {\r\n      clearTimeout(timer);\r\n      if (timedOut) return;\r\n      resolve({ exitCode: code ?? -1, stdout, stderr });\r\n    });\r\n\r\n    child.on(\"error\", (err) => {\r\n      clearTimeout(timer);\r\n      if (timedOut) return;\r\n      resolve({ exitCode: -1, stdout, stderr: err.message });\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Build Docker args for credential sharing.\r\n * Forwards SSH agent into the container.\r\n * Note: ~/.gitconfig is copied (not mounted) after container creation so gh can modify it.\r\n * Uses agent forwarding only (no ~/.ssh mount) to avoid passphrase/permission issues.\r\n */\r\nfunction buildCredentialArgs(): string[] {\r\n  const args: string[] = [];\r\n\r\n  // SSH agent forwarding (no ~/.ssh mount - causes passphrase/permission issues)\r\n  const sshForwarding = resolveSshAgentForwarding(\"/ssh-agent\");\r\n  if (sshForwarding) {\r\n    args.push(\"-v\", `${sshForwarding.hostSocketPath}:${sshForwarding.targetSocketPath}:ro`);\r\n    args.push(\"-e\", `SSH_AUTH_SOCK=${sshForwarding.targetSocketPath}`);\r\n  }\r\n\r\n  // GitHub CLI auth via token\r\n  const ghToken = resolveGhToken();\r\n  if (ghToken) {\r\n    args.push(\"-e\", `GH_TOKEN=${ghToken}`);\r\n  }\r\n\r\n  return args;\r\n}\r\n\r\n/**\r\n * Run docker run with streaming output (for image pull progress).\r\n * Streams stdout/stderr to initLogger for visibility during image pulls.\r\n */\r\nfunction streamDockerRun(\r\n  containerName: string,\r\n  image: string,\r\n  initLogger: InitLogger,\r\n  options?: { abortSignal?: AbortSignal; shareCredentials?: boolean; timeoutMs?: number }\r\n): Promise<DockerCommandResult> {\r\n  const { abortSignal, shareCredentials, timeoutMs = 600000 } = options ?? {};\r\n\r\n  return new Promise((resolve) => {\r\n    let stdout = \"\";\r\n    let stderr = \"\";\r\n    let resolved = false;\r\n\r\n    const finish = (result: DockerCommandResult) => {\r\n      if (resolved) return;\r\n      resolved = true;\r\n      clearTimeout(timer);\r\n      abortSignal?.removeEventListener(\"abort\", abortHandler);\r\n      resolve(result);\r\n    };\r\n\r\n    // Build docker run args\r\n    const dockerArgs = [\"run\", \"-d\", \"--name\", containerName];\r\n    if (shareCredentials) {\r\n      dockerArgs.push(...buildCredentialArgs());\r\n    }\r\n    dockerArgs.push(image, \"sleep\", \"infinity\");\r\n\r\n    // Use spawn for streaming output - array args don't need shell escaping\r\n    const child = spawn(\"docker\", dockerArgs);\r\n\r\n    const timer = setTimeout(() => {\r\n      child.kill();\r\n      void runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n      finish({ exitCode: -1, stdout, stderr: \"Container creation timed out\" });\r\n    }, timeoutMs);\r\n\r\n    const abortHandler = () => {\r\n      child.kill();\r\n      // Container might have been created before abort - clean it up\r\n      void runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n      finish({ exitCode: -1, stdout, stderr: \"Aborted\" });\r\n    };\r\n    abortSignal?.addEventListener(\"abort\", abortHandler);\r\n\r\n    child.stdout?.on(\"data\", (data: Buffer) => {\r\n      const text = data.toString();\r\n      stdout += text;\r\n      // docker run -d outputs container ID to stdout, not useful to stream\r\n    });\r\n\r\n    child.stderr?.on(\"data\", (data: Buffer) => {\r\n      const text = data.toString();\r\n      stderr += text;\r\n      // Stream pull progress to init logger\r\n      for (const line of text.split(\"\\n\").filter((l) => l.trim())) {\r\n        initLogger.logStdout(line);\r\n      }\r\n    });\r\n\r\n    child.on(\"close\", (code) => {\r\n      finish({ exitCode: code ?? -1, stdout, stderr });\r\n    });\r\n\r\n    child.on(\"error\", (err) => {\r\n      finish({ exitCode: -1, stdout, stderr: err.message });\r\n    });\r\n  });\r\n}\r\n\r\nexport interface DockerRuntimeConfig {\r\n  /** Docker image to use (e.g., node:20) */\r\n  image: string;\r\n  /**\r\n   * Container name for existing workspaces.\r\n   * When creating a new workspace, this is computed during createWorkspace().\r\n   * When recreating runtime for an existing workspace, this should be passed\r\n   * to allow exec operations without calling createWorkspace again.\r\n   */\r\n  containerName?: string;\r\n  /** Forward SSH agent and mount ~/.gitconfig read-only into container */\r\n  shareCredentials?: boolean;\r\n}\r\n\r\n/**\r\n * Sanitize a string for use in Docker container names.\r\n * Docker names must match: [a-zA-Z0-9][a-zA-Z0-9_.-]*\r\n */\r\nfunction sanitizeContainerName(name: string): string {\r\n  return name\r\n    .replace(/[^a-zA-Z0-9_.-]/g, \"-\")\r\n    .replace(/^[^a-zA-Z0-9]+/, \"\")\r\n    .replace(/-+/g, \"-\");\r\n}\r\n\r\n/**\r\n * Generate container name from project path and workspace name.\r\n * Format: mux-{projectName}-{workspaceName}-{hash}\r\n * Hash suffix prevents collisions (e.g., feature/foo vs feature-foo)\r\n */\r\nexport function getContainerName(projectPath: string, workspaceName: string): string {\r\n  const projectName = getProjectName(projectPath);\r\n  const hash = createHash(\"sha256\")\r\n    .update(`${projectPath}:${workspaceName}`)\r\n    .digest(\"hex\")\r\n    .slice(0, 6);\r\n  // Reserve 7 chars for \"-{hash}\", leaving 56 for base\r\n  const base = sanitizeContainerName(`mux-${projectName}-${workspaceName}`).slice(0, 56);\r\n  return `${base}-${hash}`;\r\n}\r\n\r\n/**\r\n * Docker runtime implementation that executes commands inside Docker containers.\r\n * Extends RemoteRuntime for shared exec/file operations.\r\n */\r\nexport class DockerRuntime extends RemoteRuntime {\r\n  private readonly config: DockerRuntimeConfig;\r\n  /** Container name - set during construction (for existing) or createWorkspace (for new) */\r\n  private containerName?: string;\r\n  /** Container user info - detected after container creation/start */\r\n  private containerUid?: string;\r\n  private containerGid?: string;\r\n  private containerHome?: string;\r\n\r\n  constructor(config: DockerRuntimeConfig) {\r\n    super();\r\n    this.config = config;\r\n    // If container name is provided (existing workspace), store it\r\n    if (config.containerName) {\r\n      this.containerName = config.containerName;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the container name (if set)\r\n   */\r\n  public getContainerName(): string | undefined {\r\n    return this.containerName;\r\n  }\r\n\r\n  /**\r\n   * Get Docker image name\r\n   */\r\n  public getImage(): string {\r\n    return this.config.image;\r\n  }\r\n\r\n  // ===== RemoteRuntime abstract method implementations =====\r\n\r\n  protected readonly commandPrefix = \"Docker\";\r\n\r\n  protected getBasePath(): string {\r\n    return CONTAINER_SRC_DIR;\r\n  }\r\n\r\n  protected quoteForRemote(filePath: string): string {\r\n    // Expand ~ to container user's home (detected at runtime, defaults to /root)\r\n    const home = this.containerHome ?? \"/root\";\r\n    const expanded = filePath.startsWith(\"~/\")\r\n      ? `${home}/${filePath.slice(2)}`\r\n      : filePath === \"~\"\r\n        ? home\r\n        : filePath;\r\n    return shescape.quote(expanded);\r\n  }\r\n\r\n  protected cdCommand(cwd: string): string {\r\n    return `cd ${shescape.quote(cwd)}`;\r\n  }\r\n\r\n  protected spawnRemoteProcess(fullCommand: string, _options: ExecOptions): Promise<SpawnResult> {\r\n    // Verify container name is available\r\n    if (!this.containerName) {\r\n      throw new RuntimeError(\r\n        \"Docker runtime not initialized with container name. \" +\r\n          \"For existing workspaces, pass containerName in config. \" +\r\n          \"For new workspaces, call createWorkspace first.\",\r\n        \"exec\"\r\n      );\r\n    }\r\n\r\n    // Build docker exec args.\r\n    //\r\n    // Note: RemoteRuntime.exec() injects env vars via `export ...`, so we don't need `docker exec -e`\r\n    // here (and avoiding `-e` keeps quoting behavior consistent with SSH).\r\n    const dockerArgs: string[] = [\"exec\", \"-i\", this.containerName, \"bash\", \"-c\", fullCommand];\r\n\r\n    // Spawn docker exec command\r\n    const process = spawn(\"docker\", dockerArgs, {\r\n      stdio: [\"pipe\", \"pipe\", \"pipe\"],\r\n      windowsHide: true,\r\n    });\r\n\r\n    return Promise.resolve({ process });\r\n  }\r\n\r\n  /**\r\n   * Override buildWriteCommand to preserve symlinks and file permissions.\r\n   *\r\n   * This matches SSHRuntime behavior: write through the symlink to the final target,\r\n   * while keeping the symlink itself intact.\r\n   */\r\n  protected buildWriteCommand(quotedPath: string, quotedTempPath: string): string {\r\n    // Default to 644 (world-readable) for new files, particularly important for\r\n    // plan files in /var/mux which need to be readable by VS Code Dev Containers\r\n    return `RESOLVED=$(readlink -f ${quotedPath} 2>/dev/null || echo ${quotedPath}) && PERMS=$(stat -c '%a' \"$RESOLVED\" 2>/dev/null || echo 644) && mkdir -p $(dirname \"$RESOLVED\") && cat > ${quotedTempPath} && chmod \"$PERMS\" ${quotedTempPath} && mv ${quotedTempPath} \"$RESOLVED\"`;\r\n  }\r\n  // ===== Runtime interface implementations =====\r\n\r\n  resolvePath(filePath: string): Promise<string> {\r\n    // DockerRuntime uses a fixed workspace base (/src), but we still want reasonable shell-style\r\n    // behavior for callers that pass \"~\" or \"~/...\".\r\n    //\r\n    // NOTE: Some base images (e.g., codercom/*-base) run as a non-root user (like \"coder\"), so\r\n    // \"~\" should resolve to that user's home (e.g., /home/coder), not /root.\r\n    const home = this.containerHome ?? \"/root\";\r\n\r\n    if (filePath === \"~\") {\r\n      return Promise.resolve(home);\r\n    }\r\n    if (filePath.startsWith(\"~/\")) {\r\n      return Promise.resolve(path.posix.join(home, filePath.slice(2)));\r\n    }\r\n\r\n    return Promise.resolve(\r\n      filePath.startsWith(\"/\") ? filePath : path.posix.join(CONTAINER_SRC_DIR, filePath)\r\n    );\r\n  }\r\n\r\n  getWorkspacePath(_projectPath: string, _workspaceName: string): string {\r\n    // For Docker, workspace path is always /src inside the container\r\n    return CONTAINER_SRC_DIR;\r\n  }\r\n\r\n  async createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult> {\r\n    const { projectPath, branchName } = params;\r\n\r\n    // Generate container name and check for collisions before persisting metadata\r\n    const containerName = getContainerName(projectPath, branchName);\r\n\r\n    // Check if container already exists (collision detection)\r\n    const checkResult = await runDockerCommand(`docker inspect ${containerName}`, 10000);\r\n    if (checkResult.exitCode === 0) {\r\n      return {\r\n        success: false,\r\n        error: `Workspace already exists: container ${containerName}`,\r\n      };\r\n    }\r\n    // Distinguish \"container doesn't exist\" from actual Docker errors\r\n    if (!checkResult.stderr.toLowerCase().includes(\"no such object\")) {\r\n      return {\r\n        success: false,\r\n        error: `Docker error: ${checkResult.stderr || checkResult.stdout || \"unknown error\"}`,\r\n      };\r\n    }\r\n\r\n    // Store container name - actual container creation happens in postCreateSetup\r\n    // so that image pull progress is visible in the init section\r\n    this.containerName = containerName;\r\n\r\n    return {\r\n      success: true,\r\n      workspacePath: CONTAINER_SRC_DIR,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Post-create setup: provision container OR detect fork and setup credentials.\r\n   * Runs after mux persists workspace metadata so build logs stream to UI in real-time.\r\n   *\r\n   * Handles ALL environment setup:\r\n   * - Fresh workspace: provisions container (create, sync, checkout, credentials)\r\n   * - Fork: detects existing container, logs \"from fork\", sets up credentials\r\n   * - Stale container: removes and re-provisions\r\n   *\r\n   * After this completes, the container is ready for initWorkspace() to run the hook.\r\n   */\r\n  async postCreateSetup(params: WorkspaceInitParams): Promise<void> {\r\n    const {\r\n      projectPath,\r\n      branchName,\r\n      trunkBranch,\r\n      workspacePath,\r\n      initLogger,\r\n      abortSignal,\r\n      env,\r\n      skipInitHook,\r\n    } = params;\r\n\r\n    if (!this.containerName) {\r\n      throw new Error(\"Container not initialized. Call createWorkspace first.\");\r\n    }\r\n    const containerName = this.containerName;\r\n\r\n    // Check if container already exists (e.g., from successful fork or aborted previous attempt)\r\n    const containerCheck = await this.checkExistingContainer(\r\n      containerName,\r\n      workspacePath,\r\n      branchName\r\n    );\r\n    switch (containerCheck.action) {\r\n      case \"skip\":\r\n        // Fork path: container already valid, just log and setup credentials\r\n        initLogger.logStep(\r\n          skipInitHook\r\n            ? \"Container already running (from fork), skipping init hook...\"\r\n            : \"Container already running (from fork), running init hook...\"\r\n        );\r\n        await this.setupCredentials(containerName, env);\r\n        return;\r\n      case \"cleanup\":\r\n        initLogger.logStep(containerCheck.reason);\r\n        await runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n        break;\r\n      case \"create\":\r\n        break;\r\n    }\r\n\r\n    // Provision container (throws on error - caller handles)\r\n    await this.provisionContainer({\r\n      containerName,\r\n      projectPath,\r\n      workspacePath,\r\n      branchName,\r\n      trunkBranch,\r\n      initLogger,\r\n      abortSignal,\r\n      env,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initialize workspace by running .mux/init hook.\r\n   * Assumes postCreateSetup() has already been called to provision/prepare the container.\r\n   *\r\n   * This method ONLY runs the hook - all container provisioning and credential setup\r\n   * is handled by postCreateSetup().\r\n   */\r\n  async initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult> {\r\n    const { projectPath, branchName, workspacePath, initLogger, abortSignal, env, skipInitHook } =\r\n      params;\r\n\r\n    try {\r\n      if (!this.containerName) {\r\n        return {\r\n          success: false,\r\n          error: \"Container not initialized. Call createWorkspace first.\",\r\n        };\r\n      }\r\n\r\n      if (skipInitHook) {\r\n        initLogger.logStep(\"Skipping .mux/init hook (disabled for this task)\");\r\n        initLogger.logComplete(0);\r\n        return { success: true };\r\n      }\r\n\r\n      // Run .mux/init hook if it exists\r\n      const hookExists = await checkInitHookExists(projectPath);\r\n      if (hookExists) {\r\n        initLogger.enterHookPhase?.();\r\n        const muxEnv = { ...env, ...getMuxEnv(projectPath, \"docker\", branchName) };\r\n        const hookPath = `${workspacePath}/.mux/init`;\r\n        await runInitHookOnRuntime(this, hookPath, workspacePath, muxEnv, initLogger, abortSignal);\r\n      } else {\r\n        initLogger.logComplete(0);\r\n      }\r\n\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMsg = getErrorMessage(error);\r\n      initLogger.logStderr(`Initialization failed: ${errorMsg}`);\r\n      initLogger.logComplete(-1);\r\n      // Do NOT delete container on hook failure - user can debug\r\n      return {\r\n        success: false,\r\n        error: errorMsg,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if a container already exists and whether it's valid for reuse.\r\n   * Returns action to take: skip setup, cleanup invalid container, or create new.\r\n   */\r\n  private async checkExistingContainer(\r\n    containerName: string,\r\n    workspacePath: string,\r\n    branchName: string\r\n  ): Promise<ContainerCheckResult> {\r\n    const exists = await runDockerCommand(`docker inspect ${containerName}`, 10000);\r\n    if (exists.exitCode !== 0) return { action: \"create\" };\r\n\r\n    const isRunning = await runDockerCommand(\r\n      `docker inspect -f '{{.State.Running}}' ${containerName}`,\r\n      10000\r\n    );\r\n    if (isRunning.exitCode !== 0 || isRunning.stdout.trim() !== \"true\") {\r\n      return { action: \"cleanup\", reason: \"Removing stale container from previous attempt...\" };\r\n    }\r\n\r\n    // Container running - validate it has an initialized git repo\r\n    const gitCheck = await runDockerCommand(\r\n      `docker exec ${containerName} test -d ${workspacePath}/.git`,\r\n      5000\r\n    );\r\n    if (gitCheck.exitCode !== 0) {\r\n      return {\r\n        action: \"cleanup\",\r\n        reason: \"Container exists but repo not initialized, recreating...\",\r\n      };\r\n    }\r\n\r\n    // Verify correct branch is checked out\r\n    // (handles edge case: crash after clone but before checkout left container on wrong branch)\r\n    const branchCheck = await runDockerCommand(\r\n      `docker exec ${containerName} git -C ${workspacePath} rev-parse --abbrev-ref HEAD`,\r\n      5000\r\n    );\r\n    if (branchCheck.exitCode !== 0 || branchCheck.stdout.trim() !== branchName) {\r\n      return { action: \"cleanup\", reason: \"Container exists but wrong branch, recreating...\" };\r\n    }\r\n\r\n    return { action: \"skip\" };\r\n  }\r\n\r\n  /**\r\n   * Copy gitconfig and configure gh CLI credential helper in container.\r\n   * Called for both new containers and reused forked containers.\r\n   */\r\n  private async setupCredentials(\r\n    containerName: string,\r\n    env?: Record<string, string>\r\n  ): Promise<void> {\r\n    if (!this.config.shareCredentials) return;\r\n\r\n    // Copy host gitconfig into container (not mounted, so gh can modify it)\r\n    if (hasHostGitconfig()) {\r\n      await runDockerCommand(\r\n        `docker cp ${getHostGitconfigPath()} ${containerName}:/root/.gitconfig`,\r\n        10000\r\n      );\r\n    }\r\n\r\n    // Configure gh CLI as git credential helper if GH_TOKEN is available\r\n    // GH_TOKEN can come from project secrets (env) or host environment (buildCredentialArgs)\r\n    const ghToken = resolveGhToken(env);\r\n    if (ghToken) {\r\n      await runDockerCommand(\r\n        `docker exec -e GH_TOKEN=${shescape.quote(ghToken)} ${containerName} sh -c 'command -v gh >/dev/null && gh auth setup-git || true'`,\r\n        10000\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provision container: create, sync project, checkout branch.\r\n   * Throws on error (does not call logComplete - caller handles that).\r\n   * Used by postCreateSetup() for streaming logs before initWorkspace().\r\n   */\r\n  private async provisionContainer(params: {\r\n    containerName: string;\r\n    projectPath: string;\r\n    workspacePath: string;\r\n    branchName: string;\r\n    trunkBranch: string;\r\n    initLogger: InitLogger;\r\n    abortSignal?: AbortSignal;\r\n    env?: Record<string, string>;\r\n  }): Promise<void> {\r\n    const {\r\n      containerName,\r\n      projectPath,\r\n      workspacePath,\r\n      branchName,\r\n      trunkBranch,\r\n      initLogger,\r\n      abortSignal,\r\n      env,\r\n    } = params;\r\n\r\n    // 1. Create container (with image pull if needed)\r\n    initLogger.logStep(`Creating container from ${this.config.image}...`);\r\n\r\n    if (abortSignal?.aborted) {\r\n      throw new Error(\"Workspace creation aborted\");\r\n    }\r\n\r\n    // Create and start container with streaming output for image pull progress\r\n    const runResult = await streamDockerRun(containerName, this.config.image, initLogger, {\r\n      abortSignal,\r\n      shareCredentials: this.config.shareCredentials,\r\n    });\r\n    if (runResult.exitCode !== 0) {\r\n      await runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n      throw new Error(`Failed to create container: ${runResult.stderr}`);\r\n    }\r\n\r\n    // Detect container's default user (may be non-root, e.g., codercom/enterprise-base runs as \"coder\")\r\n    const [uidResult, gidResult, homeResult] = await Promise.all([\r\n      runDockerCommand(`docker exec ${containerName} id -u`, 5000),\r\n      runDockerCommand(`docker exec ${containerName} id -g`, 5000),\r\n      runDockerCommand(`docker exec ${containerName} sh -c 'echo $HOME'`, 5000),\r\n    ]);\r\n    this.containerUid = uidResult.stdout.trim() || \"0\";\r\n    this.containerGid = gidResult.stdout.trim() || \"0\";\r\n    this.containerHome = homeResult.stdout.trim() || \"/root\";\r\n\r\n    // Create /src directory and /var/mux/plans in container\r\n    // Use --user root to create directories, then chown to container's default user\r\n    // /var/mux is used instead of ~/.mux because /root has 700 permissions,\r\n    // which makes it inaccessible to VS Code Dev Containers (non-root user)\r\n    initLogger.logStep(\"Preparing workspace directory...\");\r\n    const mkdirResult = await runDockerCommand(\r\n      `docker exec --user root ${containerName} sh -c 'mkdir -p ${CONTAINER_SRC_DIR} /var/mux/plans && chown ${this.containerUid}:${this.containerGid} ${CONTAINER_SRC_DIR} /var/mux /var/mux/plans'`,\r\n      10000\r\n    );\r\n    if (mkdirResult.exitCode !== 0) {\r\n      await runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n      throw new Error(`Failed to create workspace directory: ${mkdirResult.stderr}`);\r\n    }\r\n\r\n    initLogger.logStep(\"Container ready\");\r\n\r\n    // Setup credentials (gitconfig + gh auth)\r\n    await this.setupCredentials(containerName, env);\r\n\r\n    // 2. Sync project to container using git bundle + docker cp\r\n    initLogger.logStep(\"Syncing project files to container...\");\r\n    try {\r\n      await this.syncProjectToContainer(\r\n        projectPath,\r\n        containerName,\r\n        workspacePath,\r\n        initLogger,\r\n        abortSignal\r\n      );\r\n    } catch (error) {\r\n      await runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n      throw new Error(`Failed to sync project: ${getErrorMessage(error)}`);\r\n    }\r\n    initLogger.logStep(\"Files synced successfully\");\r\n\r\n    // 3. Checkout branch\r\n    initLogger.logStep(`Checking out branch: ${branchName}`);\r\n    const checkoutCmd = `git checkout ${shescape.quote(branchName)} 2>/dev/null || git checkout -b ${shescape.quote(branchName)} ${shescape.quote(trunkBranch)}`;\r\n\r\n    const checkoutStream = await this.exec(checkoutCmd, {\r\n      cwd: workspacePath,\r\n      timeout: 300,\r\n      abortSignal,\r\n    });\r\n\r\n    const [stdout, stderr, exitCode] = await Promise.all([\r\n      streamToString(checkoutStream.stdout),\r\n      streamToString(checkoutStream.stderr),\r\n      checkoutStream.exitCode,\r\n    ]);\r\n\r\n    if (exitCode !== 0) {\r\n      await runDockerCommand(`docker rm -f ${containerName}`, 10000);\r\n      throw new Error(`Failed to checkout branch: ${stderr || stdout}`);\r\n    }\r\n    initLogger.logStep(\"Branch checked out successfully\");\r\n  }\r\n\r\n  private async syncProjectToContainer(\r\n    projectPath: string,\r\n    containerName: string,\r\n    workspacePath: string,\r\n    initLogger: InitLogger,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<void> {\r\n    const timestamp = Date.now();\r\n    const bundleFilename = `mux-bundle-${timestamp}.bundle`;\r\n    const remoteBundlePath = `/tmp/${bundleFilename}`;\r\n    // Use os.tmpdir() for host path (Windows doesn't have /tmp)\r\n    const localBundlePath = path.join(os.tmpdir(), bundleFilename);\r\n\r\n    await syncProjectViaGitBundle({\r\n      projectPath,\r\n      workspacePath,\r\n      remoteTmpDir: \"/tmp\",\r\n      remoteBundlePath,\r\n      exec: (command, options) => this.exec(command, options),\r\n      quoteRemotePath: (path) => this.quoteForRemote(path),\r\n      initLogger,\r\n      abortSignal,\r\n      cloneStep: \"Cloning repository in container...\",\r\n      createRemoteBundle: async ({ remoteBundlePath, initLogger, abortSignal }) => {\r\n        try {\r\n          if (abortSignal?.aborted) {\r\n            throw new Error(\"Sync operation aborted before starting\");\r\n          }\r\n\r\n          const bundleResult = await runDockerCommand(\r\n            `git -C \"${projectPath}\" bundle create \"${localBundlePath}\" --all`,\r\n            300000\r\n          );\r\n\r\n          if (bundleResult.exitCode !== 0) {\r\n            throw new Error(`Failed to create bundle: ${bundleResult.stderr}`);\r\n          }\r\n\r\n          initLogger.logStep(\"Copying bundle to container...\");\r\n          const copyResult = await runDockerCommand(\r\n            `docker cp \"${localBundlePath}\" ${containerName}:${remoteBundlePath}`,\r\n            300000\r\n          );\r\n\r\n          if (copyResult.exitCode !== 0) {\r\n            throw new Error(`Failed to copy bundle: ${copyResult.stderr}`);\r\n          }\r\n\r\n          return {\r\n            cleanupLocal: async () => {\r\n              await runDockerCommand(`rm -f \"${localBundlePath}\"`, 5000);\r\n            },\r\n          };\r\n        } catch (error) {\r\n          await runDockerCommand(`rm -f \"${localBundlePath}\"`, 5000);\r\n          throw error;\r\n        }\r\n      },\r\n    });\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/require-await\r\n  async renameWorkspace(\r\n    _projectPath: string,\r\n    _oldName: string,\r\n    _newName: string,\r\n    _abortSignal?: AbortSignal\r\n  ): Promise<\r\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\r\n  > {\r\n    // For Docker, renaming means:\r\n    // 1. Create new container with new name\r\n    // 2. Copy /src from old container to new\r\n    // 3. Remove old container\r\n    // This is complex and error-prone, so we don't support it for now\r\n    return {\r\n      success: false,\r\n      error:\r\n        \"Renaming Docker workspaces is not supported. Create a new workspace and delete the old one.\",\r\n    };\r\n  }\r\n\r\n  async deleteWorkspace(\r\n    projectPath: string,\r\n    workspaceName: string,\r\n    force: boolean,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }> {\r\n    if (abortSignal?.aborted) {\r\n      return { success: false, error: \"Delete operation aborted\" };\r\n    }\r\n\r\n    const containerName = getContainerName(projectPath, workspaceName);\r\n    const deletedPath = CONTAINER_SRC_DIR;\r\n\r\n    try {\r\n      // Check if container exists\r\n      const inspectResult = await runDockerCommand(`docker inspect ${containerName}`, 10000);\r\n\r\n      if (inspectResult.exitCode !== 0) {\r\n        // Only treat as \"doesn't exist\" if Docker says so\r\n        if (inspectResult.stderr.toLowerCase().includes(\"no such object\")) {\r\n          return { success: true, deletedPath };\r\n        }\r\n        return {\r\n          success: false,\r\n          error: `Docker error: ${inspectResult.stderr || inspectResult.stdout || \"unknown error\"}`,\r\n        };\r\n      }\r\n\r\n      if (!force) {\r\n        // Check if container is already running before we start it\r\n        const wasRunning = await runDockerCommand(\r\n          `docker inspect -f '{{.State.Running}}' ${containerName}`,\r\n          10000\r\n        );\r\n        const containerWasRunning =\r\n          wasRunning.exitCode === 0 && wasRunning.stdout.trim() === \"true\";\r\n\r\n        // Start container if stopped (docker start is idempotent - succeeds if already running)\r\n        const startResult = await runDockerCommand(`docker start ${containerName}`, 30000);\r\n        if (startResult.exitCode !== 0) {\r\n          // Container won't start - skip dirty checks, allow deletion\r\n          // (container is broken/orphaned, user likely wants to clean up)\r\n        } else {\r\n          // Helper to stop container if we started it (don't leave it running on check failure)\r\n          const stopIfWeStartedIt = async () => {\r\n            if (!containerWasRunning) {\r\n              await runDockerCommand(`docker stop ${containerName}`, 10000);\r\n            }\r\n          };\r\n\r\n          // Check for uncommitted changes\r\n          const checkResult = await runDockerCommand(\r\n            `docker exec ${containerName} bash -c 'cd ${CONTAINER_SRC_DIR} && git diff --quiet --exit-code && git diff --quiet --cached --exit-code'`,\r\n            10000\r\n          );\r\n\r\n          if (checkResult.exitCode !== 0) {\r\n            await stopIfWeStartedIt();\r\n            return {\r\n              success: false,\r\n              error: \"Workspace contains uncommitted changes. Use force flag to delete anyway.\",\r\n            };\r\n          }\r\n\r\n          // Check for unpushed commits (only if remotes exist - repos with no remotes would show all commits)\r\n          const hasRemotes = await runDockerCommand(\r\n            `docker exec ${containerName} bash -c 'cd ${CONTAINER_SRC_DIR} && git remote | grep -q .'`,\r\n            10000\r\n          );\r\n          if (hasRemotes.exitCode === 0) {\r\n            const unpushedResult = await runDockerCommand(\r\n              `docker exec ${containerName} bash -c 'cd ${CONTAINER_SRC_DIR} && git log --branches --not --remotes --oneline'`,\r\n              10000\r\n            );\r\n\r\n            if (unpushedResult.exitCode === 0 && unpushedResult.stdout.trim()) {\r\n              await stopIfWeStartedIt();\r\n              return {\r\n                success: false,\r\n                error: `Workspace contains unpushed commits:\\n\\n${unpushedResult.stdout.trim()}`,\r\n              };\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Stop and remove container\r\n      const rmResult = await runDockerCommand(`docker rm -f ${containerName}`, 30000);\r\n\r\n      if (rmResult.exitCode !== 0) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to remove container: ${rmResult.stderr}`,\r\n        };\r\n      }\r\n\r\n      return { success: true, deletedPath };\r\n    } catch (error) {\r\n      return { success: false, error: `Failed to delete workspace: ${getErrorMessage(error)}` };\r\n    }\r\n  }\r\n\r\n  async forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult> {\r\n    const { projectPath, sourceWorkspaceName, newWorkspaceName, initLogger } = params;\r\n\r\n    const srcContainerName = getContainerName(projectPath, sourceWorkspaceName);\r\n    const destContainerName = getContainerName(projectPath, newWorkspaceName);\r\n    const hostTempPath = path.join(os.tmpdir(), `mux-fork-${Date.now()}.bundle`);\r\n    const containerBundlePath = \"/tmp/fork.bundle\";\r\n    let destContainerCreated = false;\r\n    let forkSucceeded = false;\r\n\r\n    try {\r\n      // 1. Verify source container exists\r\n      const srcCheck = await runDockerCommand(`docker inspect ${srcContainerName}`, 10000);\r\n      if (srcCheck.exitCode !== 0) {\r\n        return {\r\n          success: false,\r\n          error: `Source workspace container not found: ${srcContainerName}`,\r\n        };\r\n      }\r\n\r\n      // 2. Get current branch from source\r\n      initLogger.logStep(\"Detecting source workspace branch...\");\r\n      const branchResult = await runDockerCommand(\r\n        `docker exec ${srcContainerName} git -C ${CONTAINER_SRC_DIR} branch --show-current`,\r\n        30000\r\n      );\r\n      const sourceBranch = branchResult.stdout.trim();\r\n      if (branchResult.exitCode !== 0 || sourceBranch.length === 0) {\r\n        return {\r\n          success: false,\r\n          error: \"Failed to detect branch in source workspace (detached HEAD?)\",\r\n        };\r\n      }\r\n\r\n      // 3. Create git bundle inside source container\r\n      initLogger.logStep(\"Creating git bundle from source...\");\r\n      const bundleResult = await runDockerCommand(\r\n        `docker exec ${srcContainerName} git -C ${CONTAINER_SRC_DIR} bundle create ${containerBundlePath} --all`,\r\n        300000\r\n      );\r\n      if (bundleResult.exitCode !== 0) {\r\n        return { success: false, error: `Failed to create git bundle: ${bundleResult.stderr}` };\r\n      }\r\n\r\n      // 4. Transfer bundle to host\r\n      initLogger.logStep(\"Copying bundle from source container...\");\r\n      const cpOutResult = await runDockerCommand(\r\n        `docker cp ${srcContainerName}:${containerBundlePath} ${shescape.quote(hostTempPath)}`,\r\n        300000\r\n      );\r\n      if (cpOutResult.exitCode !== 0) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to copy bundle from source: ${cpOutResult.stderr}`,\r\n        };\r\n      }\r\n\r\n      // 5. Create destination container\r\n      initLogger.logStep(`Creating container: ${destContainerName}...`);\r\n      const dockerArgs = [\"run\", \"-d\", \"--name\", destContainerName];\r\n      if (this.config.shareCredentials) {\r\n        dockerArgs.push(...buildCredentialArgs());\r\n      }\r\n      dockerArgs.push(this.config.image, \"sleep\", \"infinity\");\r\n      const runResult = await runSpawnCommand(\"docker\", dockerArgs, 60000);\r\n      if (runResult.exitCode !== 0) {\r\n        // Handle TOCTOU race - container may have been created between check and run\r\n        if (runResult.stderr.includes(\"already in use\")) {\r\n          return {\r\n            success: false,\r\n            error: `Workspace already exists: container ${destContainerName}`,\r\n          };\r\n        }\r\n        return { success: false, error: `Failed to create container: ${runResult.stderr}` };\r\n      }\r\n      destContainerCreated = true;\r\n\r\n      // 5b. Detect container user and prepare directories (may be non-root)\r\n      const [uidResult, gidResult, homeResult] = await Promise.all([\r\n        runDockerCommand(`docker exec ${destContainerName} id -u`, 5000),\r\n        runDockerCommand(`docker exec ${destContainerName} id -g`, 5000),\r\n        runDockerCommand(`docker exec ${destContainerName} sh -c 'echo $HOME'`, 5000),\r\n      ]);\r\n      const destUid = uidResult.stdout.trim() || \"0\";\r\n      const destGid = gidResult.stdout.trim() || \"0\";\r\n      const destHome = homeResult.stdout.trim() || \"/root\";\r\n\r\n      // Create /src and /var/mux/plans as root, then chown to container user\r\n      const mkdirResult = await runDockerCommand(\r\n        `docker exec --user root ${destContainerName} sh -c 'mkdir -p ${CONTAINER_SRC_DIR} /var/mux/plans && chown ${destUid}:${destGid} ${CONTAINER_SRC_DIR} /var/mux /var/mux/plans'`,\r\n        10000\r\n      );\r\n      if (mkdirResult.exitCode !== 0) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to prepare workspace directory: ${mkdirResult.stderr}`,\r\n        };\r\n      }\r\n\r\n      // 6. Copy bundle into destination and clone\r\n      initLogger.logStep(\"Copying bundle to destination container...\");\r\n      const cpInResult = await runDockerCommand(\r\n        `docker cp ${shescape.quote(hostTempPath)} ${destContainerName}:${containerBundlePath}`,\r\n        300000\r\n      );\r\n      if (cpInResult.exitCode !== 0) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to copy bundle to destination: ${cpInResult.stderr}`,\r\n        };\r\n      }\r\n\r\n      initLogger.logStep(\"Cloning repository in destination...\");\r\n      const cloneResult = await runDockerCommand(\r\n        `docker exec ${destContainerName} git clone ${containerBundlePath} ${CONTAINER_SRC_DIR}`,\r\n        300000\r\n      );\r\n      if (cloneResult.exitCode !== 0) {\r\n        return { success: false, error: `Failed to clone from bundle: ${cloneResult.stderr}` };\r\n      }\r\n\r\n      // Ensure /src is owned by the container user (git clone may create as current user)\r\n      await runDockerCommand(\r\n        `docker exec --user root ${destContainerName} chown -R ${destUid}:${destGid} ${CONTAINER_SRC_DIR}`,\r\n        30000\r\n      );\r\n\r\n      // Store user info for this runtime instance\r\n      this.containerUid = destUid;\r\n      this.containerGid = destGid;\r\n      this.containerHome = destHome;\r\n\r\n      // 7. Create local tracking branches (best-effort)\r\n      initLogger.logStep(\"Creating local tracking branches...\");\r\n      try {\r\n        const remotesResult = await runDockerCommand(\r\n          `docker exec ${destContainerName} git -C ${CONTAINER_SRC_DIR} branch -r`,\r\n          30000\r\n        );\r\n        if (remotesResult.exitCode === 0) {\r\n          const remotes = remotesResult.stdout\r\n            .split(\"\\n\")\r\n            .map((b) => b.trim())\r\n            .filter((b) => b.startsWith(\"origin/\") && !b.includes(\"HEAD\"));\r\n\r\n          for (const remote of remotes) {\r\n            const localName = remote.replace(\"origin/\", \"\");\r\n            await runDockerCommand(\r\n              `docker exec ${destContainerName} git -C ${CONTAINER_SRC_DIR} branch ${shescape.quote(localName)} ${shescape.quote(remote)} 2>/dev/null || true`,\r\n              10000\r\n            );\r\n          }\r\n        }\r\n      } catch {\r\n        // Ignore - best-effort\r\n      }\r\n\r\n      // 8. Preserve origin URL (best-effort)\r\n      try {\r\n        const originResult = await runDockerCommand(\r\n          `docker exec ${srcContainerName} git -C ${CONTAINER_SRC_DIR} remote get-url origin 2>/dev/null || true`,\r\n          10000\r\n        );\r\n        const originUrl = originResult.stdout.trim();\r\n        if (originUrl.length > 0) {\r\n          await runDockerCommand(\r\n            `docker exec ${destContainerName} git -C ${CONTAINER_SRC_DIR} remote set-url origin ${shescape.quote(originUrl)}`,\r\n            10000\r\n          );\r\n        } else {\r\n          await runDockerCommand(\r\n            `docker exec ${destContainerName} git -C ${CONTAINER_SRC_DIR} remote remove origin 2>/dev/null || true`,\r\n            10000\r\n          );\r\n        }\r\n      } catch {\r\n        // Ignore - best-effort\r\n      }\r\n\r\n      // 9. Checkout destination branch\r\n      initLogger.logStep(`Checking out branch: ${newWorkspaceName}`);\r\n      const checkoutCmd =\r\n        `git checkout ${shescape.quote(newWorkspaceName)} 2>/dev/null || ` +\r\n        `git checkout -b ${shescape.quote(newWorkspaceName)} ${shescape.quote(sourceBranch)}`;\r\n      const checkoutResult = await runDockerCommand(\r\n        `docker exec ${destContainerName} bash -c ${shescape.quote(`cd ${CONTAINER_SRC_DIR} && ${checkoutCmd}`)}`,\r\n        120000\r\n      );\r\n      if (checkoutResult.exitCode !== 0) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to checkout forked branch: ${checkoutResult.stderr || checkoutResult.stdout}`,\r\n        };\r\n      }\r\n\r\n      initLogger.logStep(\"Fork completed successfully\");\r\n      forkSucceeded = true;\r\n      // Update containerName so subsequent initWorkspace() targets the forked container\r\n      this.containerName = destContainerName;\r\n      return { success: true, workspacePath: CONTAINER_SRC_DIR, sourceBranch };\r\n    } catch (error) {\r\n      return { success: false, error: getErrorMessage(error) };\r\n    } finally {\r\n      // 10. Cleanup (best-effort, ignore errors)\r\n      /* eslint-disable @typescript-eslint/no-empty-function */\r\n      // Clean up bundle in source container\r\n      await runDockerCommand(\r\n        `docker exec ${srcContainerName} rm -f ${containerBundlePath}`,\r\n        5000\r\n      ).catch(() => {});\r\n      // Clean up bundle in destination container (if it exists)\r\n      if (destContainerCreated) {\r\n        await runDockerCommand(\r\n          `docker exec ${destContainerName} rm -f ${containerBundlePath}`,\r\n          5000\r\n        ).catch(() => {});\r\n        // Remove orphaned destination container on failure\r\n        if (!forkSucceeded) {\r\n          await runDockerCommand(`docker rm -f ${destContainerName}`, 10000).catch(() => {});\r\n        }\r\n      }\r\n      // Clean up host temp file\r\n      await fs.unlink(hostTempPath).catch(() => {});\r\n      /* eslint-enable @typescript-eslint/no-empty-function */\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ensure the Docker container is running.\r\n   * `docker start` is idempotent - succeeds if already running, starts if stopped,\r\n   * and waits if container is in a transitional state (starting/restarting).\r\n   *\r\n   * Returns typed error for retry decisions:\r\n   * - runtime_not_ready: container missing or permanent failure\r\n   * - runtime_start_failed: transient failure (daemon issue, etc.)\r\n   */\r\n  override async ensureReady(): Promise<EnsureReadyResult> {\r\n    if (!this.containerName) {\r\n      return {\r\n        ready: false,\r\n        error: \"Container name not set\",\r\n        errorType: \"runtime_not_ready\",\r\n      };\r\n    }\r\n\r\n    const result = await runDockerCommand(`docker start ${this.containerName}`, 30000);\r\n    if (result.exitCode !== 0) {\r\n      const stderr = result.stderr || \"Failed to start container\";\r\n\r\n      // Classify error type based on stderr content\r\n      const isContainerMissing =\r\n        stderr.includes(\"No such container\") || stderr.includes(\"not found\");\r\n\r\n      return {\r\n        ready: false,\r\n        error: stderr,\r\n        errorType: isContainerMissing ? \"runtime_not_ready\" : \"runtime_start_failed\",\r\n      };\r\n    }\r\n\r\n    // Detect container user info if not already set (e.g., runtime recreated for existing workspace)\r\n    if (!this.containerHome) {\r\n      const [uidResult, gidResult, homeResult] = await Promise.all([\r\n        runDockerCommand(`docker exec ${this.containerName} id -u`, 5000),\r\n        runDockerCommand(`docker exec ${this.containerName} id -g`, 5000),\r\n        runDockerCommand(`docker exec ${this.containerName} sh -c 'echo $HOME'`, 5000),\r\n      ]);\r\n      this.containerUid = uidResult.stdout.trim() || \"0\";\r\n      this.containerGid = gidResult.stdout.trim() || \"0\";\r\n      this.containerHome = homeResult.stdout.trim() || \"/root\";\r\n    }\r\n\r\n    return { ready: true };\r\n  }\r\n\r\n  /**\r\n   * Docker uses /var/mux instead of ~/.mux because:\r\n   * - /root has 700 permissions, inaccessible to VS Code Dev Containers (non-root user)\r\n   * - /var/mux is world-readable by default\r\n   */\r\n  override getMuxHome(): string {\r\n    return \"/var/mux\";\r\n  }\r\n}\r\n"]}