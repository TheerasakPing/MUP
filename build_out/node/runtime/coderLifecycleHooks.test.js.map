{"version":3,"file":"coderLifecycleHooks.test.js","sourceRoot":"","sources":["../../../src/node/runtime/coderLifecycleHooks.test.ts"],"names":[],"mappings":";;AAAA,uCAAsD;AACtD,+DAG+B;AAC/B,kDAA2C;AAI3C,SAAS,sBAAsB,CAAC,SAAsC,EAAqB;IACzF,OAAO;QACL,EAAE,EAAE,IAAI;QACR,IAAI,EAAE,IAAI;QACV,WAAW,EAAE,MAAM;QACnB,WAAW,EAAE,WAAW;QACxB,aAAa,EAAE;YACb,IAAI,EAAE,KAAK;YACX,IAAI,EAAE,UAAU;YAChB,UAAU,EAAE,OAAO;YACnB,KAAK,EAAE;gBACL,aAAa,EAAE,QAAQ;aACxB;SACF;QACD,GAAG,SAAS;KACb,CAAC;AAAA,CACH;AAED,IAAA,mBAAQ,EAAC,8BAA8B,EAAE,GAAG,EAAE,CAAC;IAC7C,IAAA,aAAE,EAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE,CAAC;QAC9D,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC9F,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CACnD,CAAC;QAEF,MAAM,aAAa,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CACzF,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAC/B,CAAC;QAEF,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,aAAa;SACa,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,kDAA4B,EAAC;YACxC,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,KAAK;SACjC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,EAAE;SAC5C,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,aAAa,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IAAA,CAChD,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,4DAA4D,EAAE,KAAK,IAAI,EAAE,CAAC;QAC3E,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC9F,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CACnD,CAAC;QAEF,MAAM,aAAa,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CACzF,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAC/B,CAAC;QAEF,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,aAAa;SACa,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,kDAA4B,EAAC;YACxC,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;SAChC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,CAAC;gBACxC,aAAa,EAAE;oBACb,IAAI,EAAE,KAAK;oBACX,IAAI,EAAE,UAAU;oBAChB,UAAU,EAAE,OAAO;oBACnB,KAAK,EAAE,EAAE,aAAa,EAAE,QAAQ,EAAE,iBAAiB,EAAE,IAAI,EAAE;iBAC5D;aACF,CAAC;SACH,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,aAAa,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IAAA,CAChD,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,2CAA2C,EAAE,KAAK,IAAI,EAAE,CAAC;QAC1D,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAE7B,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC,CAAC;QAE5D,MAAM,aAAa,GAAG,IAAA,eAAI,EAExB,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QAExC,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,aAAa;SACa,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,kDAA4B,EAAC;YACxC,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;YAC/B,SAAS,EAAE,IAAI;SAChB,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,CAAC;gBACxC,aAAa,EAAE;oBACb,IAAI,EAAE,KAAK;oBACX,IAAI,EAAE,UAAU;oBAChB,UAAU,EAAE,OAAO;oBACnB,KAAK,EAAE,EAAE,aAAa,EAAE,QAAQ,EAAE;iBACnC;aACF,CAAC;SACH,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,oBAAoB,CAAC,QAAQ,EAAE,iBAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;QAE9E,MAAM,aAAa,GAAI,kBAA8C,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAEtF,CAAC;QACF,IAAA,iBAAM,EAAC,OAAO,aAAa,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACtD,IAAA,iBAAM,EAAC,aAAa,CAAC,SAAS,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;QAEnD,IAAA,iBAAM,EAAC,aAAa,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QAC/C,IAAA,iBAAM,EAAC,aAAa,CAAC,CAAC,oBAAoB,CAAC,QAAQ,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAAA,CAC3E,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC;AAEH,IAAA,mBAAQ,EAAC,iCAAiC,EAAE,GAAG,EAAE,CAAC;IAChD,IAAA,aAAE,EAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE,CAAC;QAC9D,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC9F,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CACnD,CAAC;QAEF,MAAM,cAAc,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC1F,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAC/B,CAAC;QAEF,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,cAAc;SACY,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,qDAA+B,EAAC;YAC3C,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,KAAK;SACjC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,EAAE;SAC5C,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IAAA,CACjD,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,4DAA4D,EAAE,KAAK,IAAI,EAAE,CAAC;QAC3E,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC9F,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CACnD,CAAC;QAEF,MAAM,cAAc,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC1F,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAC/B,CAAC;QAEF,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,cAAc;SACY,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,qDAA+B,EAAC;YAC3C,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;SAChC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,CAAC;gBACxC,aAAa,EAAE;oBACb,IAAI,EAAE,KAAK;oBACX,IAAI,EAAE,UAAU;oBAChB,UAAU,EAAE,OAAO;oBACnB,KAAK,EAAE,EAAE,aAAa,EAAE,QAAQ,EAAE,iBAAiB,EAAE,IAAI,EAAE;iBAC5D;aACF,CAAC;SACH,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IAAA,CACjD,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE,CAAC;QAC3D,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAE7B,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC,CAAC;QAE5D,MAAM,cAAc,GAAG,IAAA,eAAI,EAEzB,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QAExC,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,cAAc;SACY,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,qDAA+B,EAAC;YAC3C,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;YAC/B,SAAS,EAAE,IAAI;SAChB,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,CAAC;gBACxC,aAAa,EAAE;oBACb,IAAI,EAAE,KAAK;oBACX,IAAI,EAAE,UAAU;oBAChB,UAAU,EAAE,OAAO;oBACnB,KAAK,EAAE,EAAE,aAAa,EAAE,QAAQ,EAAE;iBACnC;aACF,CAAC;SACH,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,oBAAoB,CAAC,QAAQ,EAAE,iBAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;QAE9E,MAAM,aAAa,GAAI,kBAA8C,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAEtF,CAAC;QACF,IAAA,iBAAM,EAAC,OAAO,aAAa,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACtD,IAAA,iBAAM,EAAC,aAAa,CAAC,SAAS,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;QAEnD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QAChD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,oBAAoB,CAAC,QAAQ,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAAA,CAC5E,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,gEAAgE,EAAE,KAAK,IAAI,EAAE,CAAC;QAC/E,IAAI,SAAS,GAAG,CAAC,CAAC;QAClB,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAE7B,GAAG,EAAE,CAAC;YACN,SAAS,EAAE,CAAC;YACZ,IAAI,SAAS,KAAK,CAAC,EAAE,CAAC;gBACpB,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YAC7D,CAAC;YACD,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;QAAA,CAC3D,CAAC,CAAC;QAEH,MAAM,cAAc,GAAG,IAAA,eAAI,EAEzB,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QAExC,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,cAAc;SACY,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,qDAA+B,EAAC;YAC3C,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;YAC/B,SAAS,EAAE,IAAI;YACf,sBAAsB,EAAE,CAAC;YACzB,qBAAqB,EAAE,IAAI;SAC5B,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,EAAE;SAC5C,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QAChD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,oBAAoB,CAAC,QAAQ,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAAA,CAC5E,CAAC,CAAC;IACH,IAAA,aAAE,EAAC,4DAA4D,EAAE,KAAK,IAAI,EAAE,CAAC;QAC3E,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC9F,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CACnD,CAAC;QAEF,MAAM,cAAc,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC1F,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAC/B,CAAC;QAEF,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,cAAc;SACY,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,qDAA+B,EAAC;YAC3C,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;SAChC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,EAAE;SAC5C,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IAAA,CACjD,CAAC,CAAC;IAEH,IAAA,aAAE,EAAC,oCAAoC,EAAE,KAAK,IAAI,EAAE,CAAC;QACnD,MAAM,kBAAkB,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC9F,OAAO,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,WAAW,EAAE,CAAC,CACvC,CAAC;QAEF,MAAM,cAAc,GAAG,IAAA,eAAI,EAA4D,GAAG,EAAE,CAC1F,OAAO,CAAC,OAAO,CAAC,IAAA,WAAE,EAAC,SAAS,CAAC,CAAC,CAC/B,CAAC;QAEF,MAAM,YAAY,GAAG;YACnB,kBAAkB;YAClB,cAAc;SACY,CAAC;QAE7B,MAAM,IAAI,GAAG,IAAA,qDAA+B,EAAC;YAC3C,YAAY;YACZ,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI;SAChC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC;YACxB,WAAW,EAAE,IAAI;YACjB,iBAAiB,EAAE,sBAAsB,EAAE;SAC5C,CAAC,CAAC;QAEH,IAAA,iBAAM,EAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,IAAA,iBAAM,EAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACpD,IAAA,iBAAM,EAAC,cAAc,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IAAA,CACjD,CAAC,CAAC;AAAA,CACJ,CAAC,CAAC","sourcesContent":["import { describe, expect, it, mock } from \"bun:test\";\nimport {\n  createStartCoderOnUnarchiveHook,\n  createStopCoderOnArchiveHook,\n} from \"./coderLifecycleHooks\";\nimport { Ok } from \"@/common/types/result\";\nimport type { CoderService, WorkspaceStatusResult } from \"@/node/services/coderService\";\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\n\nfunction createSshCoderMetadata(overrides?: Partial<WorkspaceMetadata>): WorkspaceMetadata {\n  return {\n    id: \"ws\",\n    name: \"ws\",\n    projectName: \"proj\",\n    projectPath: \"/tmp/proj\",\n    runtimeConfig: {\n      type: \"ssh\",\n      host: \"coder://\",\n      srcBaseDir: \"~/mux\",\n      coder: {\n        workspaceName: \"mux-ws\",\n      },\n    },\n    ...overrides,\n  };\n}\n\ndescribe(\"createStopCoderOnArchiveHook\", () => {\n  it(\"does nothing when stop-on-archive is disabled\", async () => {\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\n      Promise.resolve({ kind: \"ok\", status: \"running\" })\n    );\n\n    const stopWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\n      Promise.resolve(Ok(undefined))\n    );\n\n    const coderService = {\n      getWorkspaceStatus,\n      stopWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStopCoderOnArchiveHook({\n      coderService,\n      shouldStopOnArchive: () => false,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata(),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\n    expect(stopWorkspace).toHaveBeenCalledTimes(0);\n  });\n\n  it(\"does nothing when connected to an existing Coder workspace\", async () => {\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\n      Promise.resolve({ kind: \"ok\", status: \"running\" })\n    );\n\n    const stopWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\n      Promise.resolve(Ok(undefined))\n    );\n\n    const coderService = {\n      getWorkspaceStatus,\n      stopWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStopCoderOnArchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata({\n        runtimeConfig: {\n          type: \"ssh\",\n          host: \"coder://\",\n          srcBaseDir: \"~/mux\",\n          coder: { workspaceName: \"mux-ws\", existingWorkspace: true },\n        },\n      }),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\n    expect(stopWorkspace).toHaveBeenCalledTimes(0);\n  });\n\n  it(\"stops a running dedicated Coder workspace\", async () => {\n    const getWorkspaceStatus = mock<\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<WorkspaceStatusResult>\n    >(() => Promise.resolve({ kind: \"ok\", status: \"running\" }));\n\n    const stopWorkspace = mock<\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<ReturnType<typeof Ok>>\n    >(() => Promise.resolve(Ok(undefined)));\n\n    const coderService = {\n      getWorkspaceStatus,\n      stopWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStopCoderOnArchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n      timeoutMs: 1234,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata({\n        runtimeConfig: {\n          type: \"ssh\",\n          host: \"coder://\",\n          srcBaseDir: \"~/mux\",\n          coder: { workspaceName: \"mux-ws\" },\n        },\n      }),\n    });\n\n    expect(result.success).toBe(true);\n\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\n    expect(getWorkspaceStatus).toHaveBeenCalledWith(\"mux-ws\", expect.any(Object));\n\n    const statusOptions = (getWorkspaceStatus as ReturnType<typeof mock>).mock.calls[0]?.[1] as {\n      timeoutMs?: number;\n    };\n    expect(typeof statusOptions.timeoutMs).toBe(\"number\");\n    expect(statusOptions.timeoutMs).toBeGreaterThan(0);\n\n    expect(stopWorkspace).toHaveBeenCalledTimes(1);\n    expect(stopWorkspace).toHaveBeenCalledWith(\"mux-ws\", { timeoutMs: 1234 });\n  });\n});\n\ndescribe(\"createStartCoderOnUnarchiveHook\", () => {\n  it(\"does nothing when stop-on-archive is disabled\", async () => {\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\n      Promise.resolve({ kind: \"ok\", status: \"stopped\" })\n    );\n\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\n      Promise.resolve(Ok(undefined))\n    );\n\n    const coderService = {\n      getWorkspaceStatus,\n      startWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStartCoderOnUnarchiveHook({\n      coderService,\n      shouldStopOnArchive: () => false,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata(),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\n  });\n\n  it(\"does nothing when connected to an existing Coder workspace\", async () => {\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\n      Promise.resolve({ kind: \"ok\", status: \"stopped\" })\n    );\n\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\n      Promise.resolve(Ok(undefined))\n    );\n\n    const coderService = {\n      getWorkspaceStatus,\n      startWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStartCoderOnUnarchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata({\n        runtimeConfig: {\n          type: \"ssh\",\n          host: \"coder://\",\n          srcBaseDir: \"~/mux\",\n          coder: { workspaceName: \"mux-ws\", existingWorkspace: true },\n        },\n      }),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\n  });\n\n  it(\"starts a stopped dedicated Coder workspace\", async () => {\n    const getWorkspaceStatus = mock<\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<WorkspaceStatusResult>\n    >(() => Promise.resolve({ kind: \"ok\", status: \"stopped\" }));\n\n    const startWorkspace = mock<\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<ReturnType<typeof Ok>>\n    >(() => Promise.resolve(Ok(undefined)));\n\n    const coderService = {\n      getWorkspaceStatus,\n      startWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStartCoderOnUnarchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n      timeoutMs: 1234,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata({\n        runtimeConfig: {\n          type: \"ssh\",\n          host: \"coder://\",\n          srcBaseDir: \"~/mux\",\n          coder: { workspaceName: \"mux-ws\" },\n        },\n      }),\n    });\n\n    expect(result.success).toBe(true);\n\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\n    expect(getWorkspaceStatus).toHaveBeenCalledWith(\"mux-ws\", expect.any(Object));\n\n    const statusOptions = (getWorkspaceStatus as ReturnType<typeof mock>).mock.calls[0]?.[1] as {\n      timeoutMs?: number;\n    };\n    expect(typeof statusOptions.timeoutMs).toBe(\"number\");\n    expect(statusOptions.timeoutMs).toBeGreaterThan(0);\n\n    expect(startWorkspace).toHaveBeenCalledTimes(1);\n    expect(startWorkspace).toHaveBeenCalledWith(\"mux-ws\", { timeoutMs: 1234 });\n  });\n\n  it(\"waits for stopping workspace to become stopped before starting\", async () => {\n    let pollCount = 0;\n    const getWorkspaceStatus = mock<\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<WorkspaceStatusResult>\n    >(() => {\n      pollCount++;\n      if (pollCount === 1) {\n        return Promise.resolve({ kind: \"ok\", status: \"stopping\" });\n      }\n      return Promise.resolve({ kind: \"ok\", status: \"stopped\" });\n    });\n\n    const startWorkspace = mock<\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<ReturnType<typeof Ok>>\n    >(() => Promise.resolve(Ok(undefined)));\n\n    const coderService = {\n      getWorkspaceStatus,\n      startWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStartCoderOnUnarchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n      timeoutMs: 1234,\n      stoppingPollIntervalMs: 0,\n      stoppingWaitTimeoutMs: 1000,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata(),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(2);\n    expect(startWorkspace).toHaveBeenCalledTimes(1);\n    expect(startWorkspace).toHaveBeenCalledWith(\"mux-ws\", { timeoutMs: 1234 });\n  });\n  it(\"does nothing when workspace is already running or starting\", async () => {\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\n      Promise.resolve({ kind: \"ok\", status: \"running\" })\n    );\n\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\n      Promise.resolve(Ok(undefined))\n    );\n\n    const coderService = {\n      getWorkspaceStatus,\n      startWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStartCoderOnUnarchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata(),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\n  });\n\n  it(\"treats not_found status as success\", async () => {\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\n      Promise.resolve({ kind: \"not_found\" })\n    );\n\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\n      Promise.resolve(Ok(undefined))\n    );\n\n    const coderService = {\n      getWorkspaceStatus,\n      startWorkspace,\n    } as unknown as CoderService;\n\n    const hook = createStartCoderOnUnarchiveHook({\n      coderService,\n      shouldStopOnArchive: () => true,\n    });\n\n    const result = await hook({\n      workspaceId: \"ws\",\n      workspaceMetadata: createSshCoderMetadata(),\n    });\n\n    expect(result.success).toBe(true);\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\n  });\n});\n"]}