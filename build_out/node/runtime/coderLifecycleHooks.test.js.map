{"version":3,"file":"coderLifecycleHooks.test.js","sourceRoot":"","sources":["../../../src/node/runtime/coderLifecycleHooks.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it, mock } from \"bun:test\";\r\nimport {\r\n  createStartCoderOnUnarchiveHook,\r\n  createStopCoderOnArchiveHook,\r\n} from \"./coderLifecycleHooks\";\r\nimport { Ok } from \"@/common/types/result\";\r\nimport type { CoderService, WorkspaceStatusResult } from \"@/node/services/coderService\";\r\nimport type { WorkspaceMetadata } from \"@/common/types/workspace\";\r\n\r\nfunction createSshCoderMetadata(overrides?: Partial<WorkspaceMetadata>): WorkspaceMetadata {\r\n  return {\r\n    id: \"ws\",\r\n    name: \"ws\",\r\n    projectName: \"proj\",\r\n    projectPath: \"/tmp/proj\",\r\n    runtimeConfig: {\r\n      type: \"ssh\",\r\n      host: \"coder://\",\r\n      srcBaseDir: \"~/mux\",\r\n      coder: {\r\n        workspaceName: \"mux-ws\",\r\n      },\r\n    },\r\n    ...overrides,\r\n  };\r\n}\r\n\r\ndescribe(\"createStopCoderOnArchiveHook\", () => {\r\n  it(\"does nothing when stop-on-archive is disabled\", async () => {\r\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\r\n      Promise.resolve({ kind: \"ok\", status: \"running\" })\r\n    );\r\n\r\n    const stopWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\r\n      Promise.resolve(Ok(undefined))\r\n    );\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      stopWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStopCoderOnArchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => false,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata(),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\r\n    expect(stopWorkspace).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  it(\"does nothing when connected to an existing Coder workspace\", async () => {\r\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\r\n      Promise.resolve({ kind: \"ok\", status: \"running\" })\r\n    );\r\n\r\n    const stopWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\r\n      Promise.resolve(Ok(undefined))\r\n    );\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      stopWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStopCoderOnArchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata({\r\n        runtimeConfig: {\r\n          type: \"ssh\",\r\n          host: \"coder://\",\r\n          srcBaseDir: \"~/mux\",\r\n          coder: { workspaceName: \"mux-ws\", existingWorkspace: true },\r\n        },\r\n      }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\r\n    expect(stopWorkspace).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  it(\"stops a running dedicated Coder workspace\", async () => {\r\n    const getWorkspaceStatus = mock<\r\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<WorkspaceStatusResult>\r\n    >(() => Promise.resolve({ kind: \"ok\", status: \"running\" }));\r\n\r\n    const stopWorkspace = mock<\r\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<ReturnType<typeof Ok>>\r\n    >(() => Promise.resolve(Ok(undefined)));\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      stopWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStopCoderOnArchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n      timeoutMs: 1234,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata({\r\n        runtimeConfig: {\r\n          type: \"ssh\",\r\n          host: \"coder://\",\r\n          srcBaseDir: \"~/mux\",\r\n          coder: { workspaceName: \"mux-ws\" },\r\n        },\r\n      }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledWith(\"mux-ws\", expect.any(Object));\r\n\r\n    const statusOptions = (getWorkspaceStatus as ReturnType<typeof mock>).mock.calls[0]?.[1] as {\r\n      timeoutMs?: number;\r\n    };\r\n    expect(typeof statusOptions.timeoutMs).toBe(\"number\");\r\n    expect(statusOptions.timeoutMs).toBeGreaterThan(0);\r\n\r\n    expect(stopWorkspace).toHaveBeenCalledTimes(1);\r\n    expect(stopWorkspace).toHaveBeenCalledWith(\"mux-ws\", { timeoutMs: 1234 });\r\n  });\r\n});\r\n\r\ndescribe(\"createStartCoderOnUnarchiveHook\", () => {\r\n  it(\"does nothing when stop-on-archive is disabled\", async () => {\r\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\r\n      Promise.resolve({ kind: \"ok\", status: \"stopped\" })\r\n    );\r\n\r\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\r\n      Promise.resolve(Ok(undefined))\r\n    );\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      startWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStartCoderOnUnarchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => false,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata(),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\r\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  it(\"does nothing when connected to an existing Coder workspace\", async () => {\r\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\r\n      Promise.resolve({ kind: \"ok\", status: \"stopped\" })\r\n    );\r\n\r\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\r\n      Promise.resolve(Ok(undefined))\r\n    );\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      startWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStartCoderOnUnarchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata({\r\n        runtimeConfig: {\r\n          type: \"ssh\",\r\n          host: \"coder://\",\r\n          srcBaseDir: \"~/mux\",\r\n          coder: { workspaceName: \"mux-ws\", existingWorkspace: true },\r\n        },\r\n      }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(0);\r\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  it(\"starts a stopped dedicated Coder workspace\", async () => {\r\n    const getWorkspaceStatus = mock<\r\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<WorkspaceStatusResult>\r\n    >(() => Promise.resolve({ kind: \"ok\", status: \"stopped\" }));\r\n\r\n    const startWorkspace = mock<\r\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<ReturnType<typeof Ok>>\r\n    >(() => Promise.resolve(Ok(undefined)));\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      startWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStartCoderOnUnarchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n      timeoutMs: 1234,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata({\r\n        runtimeConfig: {\r\n          type: \"ssh\",\r\n          host: \"coder://\",\r\n          srcBaseDir: \"~/mux\",\r\n          coder: { workspaceName: \"mux-ws\" },\r\n        },\r\n      }),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledWith(\"mux-ws\", expect.any(Object));\r\n\r\n    const statusOptions = (getWorkspaceStatus as ReturnType<typeof mock>).mock.calls[0]?.[1] as {\r\n      timeoutMs?: number;\r\n    };\r\n    expect(typeof statusOptions.timeoutMs).toBe(\"number\");\r\n    expect(statusOptions.timeoutMs).toBeGreaterThan(0);\r\n\r\n    expect(startWorkspace).toHaveBeenCalledTimes(1);\r\n    expect(startWorkspace).toHaveBeenCalledWith(\"mux-ws\", { timeoutMs: 1234 });\r\n  });\r\n\r\n  it(\"waits for stopping workspace to become stopped before starting\", async () => {\r\n    let pollCount = 0;\r\n    const getWorkspaceStatus = mock<\r\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<WorkspaceStatusResult>\r\n    >(() => {\r\n      pollCount++;\r\n      if (pollCount === 1) {\r\n        return Promise.resolve({ kind: \"ok\", status: \"stopping\" });\r\n      }\r\n      return Promise.resolve({ kind: \"ok\", status: \"stopped\" });\r\n    });\r\n\r\n    const startWorkspace = mock<\r\n      (workspaceName: string, options?: { timeoutMs?: number }) => Promise<ReturnType<typeof Ok>>\r\n    >(() => Promise.resolve(Ok(undefined)));\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      startWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStartCoderOnUnarchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n      timeoutMs: 1234,\r\n      stoppingPollIntervalMs: 0,\r\n      stoppingWaitTimeoutMs: 1000,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata(),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(2);\r\n    expect(startWorkspace).toHaveBeenCalledTimes(1);\r\n    expect(startWorkspace).toHaveBeenCalledWith(\"mux-ws\", { timeoutMs: 1234 });\r\n  });\r\n  it(\"does nothing when workspace is already running or starting\", async () => {\r\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\r\n      Promise.resolve({ kind: \"ok\", status: \"running\" })\r\n    );\r\n\r\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\r\n      Promise.resolve(Ok(undefined))\r\n    );\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      startWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStartCoderOnUnarchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata(),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\r\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\r\n  });\r\n\r\n  it(\"treats not_found status as success\", async () => {\r\n    const getWorkspaceStatus = mock<(workspaceName: string) => Promise<WorkspaceStatusResult>>(() =>\r\n      Promise.resolve({ kind: \"not_found\" })\r\n    );\r\n\r\n    const startWorkspace = mock<(workspaceName: string) => Promise<ReturnType<typeof Ok>>>(() =>\r\n      Promise.resolve(Ok(undefined))\r\n    );\r\n\r\n    const coderService = {\r\n      getWorkspaceStatus,\r\n      startWorkspace,\r\n    } as unknown as CoderService;\r\n\r\n    const hook = createStartCoderOnUnarchiveHook({\r\n      coderService,\r\n      shouldStopOnArchive: () => true,\r\n    });\r\n\r\n    const result = await hook({\r\n      workspaceId: \"ws\",\r\n      workspaceMetadata: createSshCoderMetadata(),\r\n    });\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(getWorkspaceStatus).toHaveBeenCalledTimes(1);\r\n    expect(startWorkspace).toHaveBeenCalledTimes(0);\r\n  });\r\n});\r\n"]}