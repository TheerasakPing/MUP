{"version":3,"file":"initHook.test.js","sourceRoot":"","sources":["../../../src/node/runtime/initHook.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from \"bun:test\";\r\nimport { LineBuffer, createLineBufferedLoggers, getMuxEnv } from \"./initHook\";\r\nimport type { InitLogger } from \"./Runtime\";\r\n\r\ndescribe(\"LineBuffer\", () => {\r\n  it(\"should buffer incomplete lines\", () => {\r\n    const lines: string[] = [];\r\n    const buffer = new LineBuffer((line) => lines.push(line));\r\n\r\n    buffer.append(\"hello \");\r\n    expect(lines).toEqual([]);\r\n\r\n    buffer.append(\"world\\n\");\r\n    expect(lines).toEqual([\"hello world\"]);\r\n  });\r\n\r\n  it(\"should handle multiple lines in one chunk\", () => {\r\n    const lines: string[] = [];\r\n    const buffer = new LineBuffer((line) => lines.push(line));\r\n\r\n    buffer.append(\"line1\\nline2\\nline3\\n\");\r\n    expect(lines).toEqual([\"line1\", \"line2\", \"line3\"]);\r\n  });\r\n\r\n  it(\"should handle incomplete line at end\", () => {\r\n    const lines: string[] = [];\r\n    const buffer = new LineBuffer((line) => lines.push(line));\r\n\r\n    buffer.append(\"line1\\nline2\\nincomplete\");\r\n    expect(lines).toEqual([\"line1\", \"line2\"]);\r\n\r\n    buffer.flush();\r\n    expect(lines).toEqual([\"line1\", \"line2\", \"incomplete\"]);\r\n  });\r\n\r\n  it(\"should skip empty lines\", () => {\r\n    const lines: string[] = [];\r\n    const buffer = new LineBuffer((line) => lines.push(line));\r\n\r\n    buffer.append(\"\\nline1\\n\\nline2\\n\\n\");\r\n    expect(lines).toEqual([\"line1\", \"line2\"]);\r\n  });\r\n\r\n  it(\"should handle flush with no buffered data\", () => {\r\n    const lines: string[] = [];\r\n    const buffer = new LineBuffer((line) => lines.push(line));\r\n\r\n    buffer.append(\"line1\\n\");\r\n    expect(lines).toEqual([\"line1\"]);\r\n\r\n    buffer.flush();\r\n    expect(lines).toEqual([\"line1\"]); // No change\r\n  });\r\n});\r\n\r\n// getMuxEnv tests are placed here because initHook.ts owns the implementation.\r\ndescribe(\"createLineBufferedLoggers\", () => {\r\n  it(\"should create separate buffers for stdout and stderr\", () => {\r\n    const stdoutLines: string[] = [];\r\n    const stderrLines: string[] = [];\r\n\r\n    const mockLogger: InitLogger = {\r\n      logStep: () => {\r\n        /* no-op for test */\r\n      },\r\n      logStdout: (line) => stdoutLines.push(line),\r\n      logStderr: (line) => stderrLines.push(line),\r\n      logComplete: () => {\r\n        /* no-op for test */\r\n      },\r\n    };\r\n\r\n    const loggers = createLineBufferedLoggers(mockLogger);\r\n\r\n    loggers.stdout.append(\"out1\\nout2\\n\");\r\n    loggers.stderr.append(\"err1\\nerr2\\n\");\r\n\r\n    expect(stdoutLines).toEqual([\"out1\", \"out2\"]);\r\n    expect(stderrLines).toEqual([\"err1\", \"err2\"]);\r\n  });\r\n\r\n  it(\"should handle incomplete lines and flush separately\", () => {\r\n    const stdoutLines: string[] = [];\r\n    const stderrLines: string[] = [];\r\n\r\n    const mockLogger: InitLogger = {\r\n      logStep: () => {\r\n        /* no-op for test */\r\n      },\r\n      logStdout: (line) => stdoutLines.push(line),\r\n      logStderr: (line) => stderrLines.push(line),\r\n      logComplete: () => {\r\n        /* no-op for test */\r\n      },\r\n    };\r\n\r\n    const loggers = createLineBufferedLoggers(mockLogger);\r\n\r\n    loggers.stdout.append(\"incomplete\");\r\n    loggers.stderr.append(\"also incomplete\");\r\n\r\n    expect(stdoutLines).toEqual([]);\r\n    expect(stderrLines).toEqual([]);\r\n\r\n    loggers.stdout.flush();\r\n    expect(stdoutLines).toEqual([\"incomplete\"]);\r\n    expect(stderrLines).toEqual([]); // stderr not flushed yet\r\n\r\n    loggers.stderr.flush();\r\n    expect(stderrLines).toEqual([\"also incomplete\"]);\r\n  });\r\n});\r\n\r\ndescribe(\"getMuxEnv\", () => {\r\n  it(\"should include base MUX_ environment variables\", () => {\r\n    const env = getMuxEnv(\"/path/to/project\", \"worktree\", \"feature-branch\");\r\n\r\n    expect(env.MUX_PROJECT_PATH).toBe(\"/path/to/project\");\r\n    expect(env.MUX_RUNTIME).toBe(\"worktree\");\r\n    expect(env.MUX_WORKSPACE_NAME).toBe(\"feature-branch\");\r\n    expect(env.MUX_MODEL_STRING).toBeUndefined();\r\n    expect(env.MUX_THINKING_LEVEL).toBeUndefined();\r\n    expect(env.MUX_COSTS_USD).toBeUndefined();\r\n  });\r\n\r\n  it(\"should include model + thinking env vars when provided\", () => {\r\n    const env = getMuxEnv(\"/path/to/project\", \"worktree\", \"feature-branch\", {\r\n      modelString: \"openai:gpt-5.2-pro\",\r\n      thinkingLevel: \"medium\",\r\n    });\r\n\r\n    expect(env.MUX_MODEL_STRING).toBe(\"openai:gpt-5.2-pro\");\r\n    expect(env.MUX_THINKING_LEVEL).toBe(\"medium\");\r\n  });\r\n\r\n  it(\"should allow explicit thinkingLevel=off\", () => {\r\n    const env = getMuxEnv(\"/path/to/project\", \"local\", \"main\", {\r\n      modelString: \"anthropic:claude-3-5-sonnet\",\r\n      thinkingLevel: \"off\",\r\n    });\r\n\r\n    expect(env.MUX_MODEL_STRING).toBe(\"anthropic:claude-3-5-sonnet\");\r\n    expect(env.MUX_THINKING_LEVEL).toBe(\"off\");\r\n  });\r\n\r\n  it(\"should include MUX_COSTS_USD when costsUsd is provided\", () => {\r\n    const env = getMuxEnv(\"/path/to/project\", \"worktree\", \"feature-branch\", {\r\n      modelString: \"anthropic:claude-opus-4-5\",\r\n      thinkingLevel: \"high\",\r\n      costsUsd: 1.2345,\r\n    });\r\n\r\n    expect(env.MUX_COSTS_USD).toBe(\"1.23\");\r\n  });\r\n\r\n  it(\"should include MUX_COSTS_USD=0.00 when costsUsd is 0\", () => {\r\n    const env = getMuxEnv(\"/path/to/project\", \"worktree\", \"main\", {\r\n      costsUsd: 0,\r\n    });\r\n\r\n    expect(env.MUX_COSTS_USD).toBe(\"0.00\");\r\n  });\r\n\r\n  it(\"should not include MUX_COSTS_USD when costsUsd is undefined\", () => {\r\n    const env = getMuxEnv(\"/path/to/project\", \"worktree\", \"main\", {\r\n      modelString: \"openai:gpt-4\",\r\n    });\r\n\r\n    expect(env.MUX_COSTS_USD).toBeUndefined();\r\n  });\r\n});\r\n"]}