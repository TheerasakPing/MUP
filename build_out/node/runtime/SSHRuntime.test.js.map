{"version":3,"file":"SSHRuntime.test.js","sourceRoot":"","sources":["../../../src/node/runtime/SSHRuntime.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it, beforeEach, afterEach, spyOn } from \"bun:test\";\r\nimport * as runtimeHelpers from \"@/node/utils/runtime/helpers\";\r\nimport { SSHRuntime, computeBaseRepoPath } from \"./SSHRuntime\";\r\nimport { createSSHTransport } from \"./transports\";\r\n\r\n/**\r\n * SSHRuntime unit tests (run with bun test)\r\n *\r\n * Integration tests for workspace operations (renameWorkspace, deleteWorkspace, forkWorkspace,\r\n * worktree-based operations) require Docker and are in tests/runtime/runtime.test.ts.\r\n * Run with: TEST_INTEGRATION=1 bun x jest tests/runtime/runtime.test.ts\r\n */\r\ndescribe(\"SSHRuntime constructor\", () => {\r\n  it(\"should accept tilde in srcBaseDir\", () => {\r\n    // Tildes are now allowed - they will be resolved via resolvePath()\r\n    expect(() => {\r\n      const config = { host: \"example.com\", srcBaseDir: \"~/mux\" };\r\n      new SSHRuntime(config, createSSHTransport(config, false));\r\n    }).not.toThrow();\r\n  });\r\n\r\n  it(\"should accept bare tilde in srcBaseDir\", () => {\r\n    // Tildes are now allowed - they will be resolved via resolvePath()\r\n    expect(() => {\r\n      const config = { host: \"example.com\", srcBaseDir: \"~\" };\r\n      new SSHRuntime(config, createSSHTransport(config, false));\r\n    }).not.toThrow();\r\n  });\r\n\r\n  it(\"should accept absolute paths in srcBaseDir\", () => {\r\n    expect(() => {\r\n      const config = { host: \"example.com\", srcBaseDir: \"/home/user/mux\" };\r\n      new SSHRuntime(config, createSSHTransport(config, false));\r\n    }).not.toThrow();\r\n  });\r\n});\r\n\r\ndescribe(\"SSHRuntime.ensureReady repository checks\", () => {\r\n  let execBufferedSpy: ReturnType<typeof spyOn<typeof runtimeHelpers, \"execBuffered\">> | null =\r\n    null;\r\n  let runtime: SSHRuntime;\r\n\r\n  beforeEach(() => {\r\n    const config = { host: \"example.com\", srcBaseDir: \"/home/user/src\" };\r\n    runtime = new SSHRuntime(config, createSSHTransport(config, false), {\r\n      projectPath: \"/project\",\r\n      workspaceName: \"ws\",\r\n    });\r\n  });\r\n\r\n  afterEach(() => {\r\n    execBufferedSpy?.mockRestore();\r\n    execBufferedSpy = null;\r\n  });\r\n\r\n  it(\"accepts worktrees where .git is a file\", async () => {\r\n    execBufferedSpy = spyOn(runtimeHelpers, \"execBuffered\")\r\n      .mockResolvedValueOnce({ stdout: \"\", stderr: \"\", exitCode: 0, duration: 0 })\r\n      .mockResolvedValueOnce({ stdout: \".git\", stderr: \"\", exitCode: 0, duration: 0 });\r\n\r\n    const result = await runtime.ensureReady();\r\n\r\n    expect(execBufferedSpy).toHaveBeenCalledTimes(2);\r\n    const firstCommand = execBufferedSpy?.mock.calls[0]?.[1];\r\n    expect(firstCommand).toContain(\"test -d\");\r\n    expect(firstCommand).toContain(\"test -f\");\r\n    expect(result).toEqual({ ready: true });\r\n  });\r\n\r\n  it(\"returns runtime_not_ready when the repo is missing\", async () => {\r\n    execBufferedSpy = spyOn(runtimeHelpers, \"execBuffered\").mockResolvedValue({\r\n      stdout: \"\",\r\n      stderr: \"\",\r\n      exitCode: 1,\r\n      duration: 0,\r\n    });\r\n\r\n    const result = await runtime.ensureReady();\r\n\r\n    expect(result.ready).toBe(false);\r\n    if (!result.ready) {\r\n      expect(result.errorType).toBe(\"runtime_not_ready\");\r\n    }\r\n  });\r\n\r\n  it(\"returns runtime_start_failed when git is unavailable\", async () => {\r\n    execBufferedSpy = spyOn(runtimeHelpers, \"execBuffered\")\r\n      .mockResolvedValueOnce({ stdout: \"\", stderr: \"\", exitCode: 0, duration: 0 })\r\n      .mockResolvedValueOnce({\r\n        stdout: \"\",\r\n        stderr: \"command not found\",\r\n        exitCode: 127,\r\n        duration: 0,\r\n      });\r\n\r\n    const result = await runtime.ensureReady();\r\n\r\n    expect(result.ready).toBe(false);\r\n    if (!result.ready) {\r\n      expect(result.errorType).toBe(\"runtime_start_failed\");\r\n    }\r\n  });\r\n});\r\ndescribe(\"computeBaseRepoPath\", () => {\r\n  it(\"computes the correct bare repo path\", () => {\r\n    // computeBaseRepoPath uses getProjectName (basename) to compute:\r\n    // <srcBaseDir>/<projectName>/.mux-base.git\r\n    const result = computeBaseRepoPath(\"~/mux\", \"/Users/me/code/my-project\");\r\n    expect(result).toBe(\"~/mux/my-project/.mux-base.git\");\r\n  });\r\n\r\n  it(\"handles absolute srcBaseDir\", () => {\r\n    const result = computeBaseRepoPath(\"/home/user/src\", \"/code/repo\");\r\n    expect(result).toBe(\"/home/user/src/repo/.mux-base.git\");\r\n  });\r\n});\r\n"]}