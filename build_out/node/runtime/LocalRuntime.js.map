{"version":3,"file":"LocalRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/LocalRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\r\n  EnsureReadyOptions,\r\n  EnsureReadyResult,\r\n  WorkspaceCreationParams,\r\n  WorkspaceCreationResult,\r\n  WorkspaceInitParams,\r\n  WorkspaceInitResult,\r\n  WorkspaceForkParams,\r\n  WorkspaceForkResult,\r\n} from \"./Runtime\";\r\nimport { checkInitHookExists, getMuxEnv } from \"./initHook\";\r\nimport { getErrorMessage } from \"@/common/utils/errors\";\r\nimport { LocalBaseRuntime } from \"./LocalBaseRuntime\";\r\n\r\n/**\r\n * Local runtime implementation that uses the project directory directly.\r\n *\r\n * Unlike WorktreeRuntime, this runtime:\r\n * - Does NOT create git worktrees or isolate workspaces\r\n * - Uses the project directory as the workspace path\r\n * - Cannot delete the project directory (deleteWorkspace is a no-op)\r\n * - Supports forking (creates new workspace entries pointing to same project directory)\r\n *\r\n * This is useful for users who want to work directly in their project\r\n * without the overhead of worktree management.\r\n */\r\nexport class LocalRuntime extends LocalBaseRuntime {\r\n  private readonly projectPath: string;\r\n\r\n  constructor(projectPath: string) {\r\n    super();\r\n    this.projectPath = projectPath;\r\n  }\r\n\r\n  /**\r\n   * For LocalRuntime, the workspace path is always the project path itself.\r\n   * The workspaceName parameter is ignored since there's only one workspace per project.\r\n   */\r\n  getWorkspacePath(_projectPath: string, _workspaceName: string): string {\r\n    return this.projectPath;\r\n  }\r\n\r\n  override ensureReady(options?: EnsureReadyOptions): Promise<EnsureReadyResult> {\r\n    const statusSink = options?.statusSink;\r\n    statusSink?.({\r\n      phase: \"checking\",\r\n      runtimeType: \"local\",\r\n      detail: \"Checking repository...\",\r\n    });\r\n\r\n    // Non-git projects are explicitly supported for LocalRuntime; avoid blocking readiness\r\n    // on missing .git so local-only workflows continue to work.\r\n    statusSink?.({ phase: \"ready\", runtimeType: \"local\" });\r\n    return Promise.resolve({ ready: true });\r\n  }\r\n\r\n  /**\r\n   * Creating a workspace is a no-op for LocalRuntime since we use the project directory directly.\r\n   * We just verify the directory exists.\r\n   */\r\n  async createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult> {\r\n    const { initLogger } = params;\r\n\r\n    try {\r\n      initLogger.logStep(\"Using project directory directly (no worktree isolation)\");\r\n\r\n      // Verify the project directory exists\r\n      try {\r\n        await this.stat(this.projectPath);\r\n      } catch {\r\n        return {\r\n          success: false,\r\n          error: `Project directory does not exist: ${this.projectPath}`,\r\n        };\r\n      }\r\n\r\n      initLogger.logStep(\"Project directory verified\");\r\n\r\n      return { success: true, workspacePath: this.projectPath };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: getErrorMessage(error),\r\n      };\r\n    }\r\n  }\r\n\r\n  async initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult> {\r\n    const { projectPath, branchName, workspacePath, initLogger, abortSignal, env, skipInitHook } =\r\n      params;\r\n\r\n    try {\r\n      if (skipInitHook) {\r\n        initLogger.logStep(\"Skipping .mux/init hook (disabled for this task)\");\r\n        initLogger.logComplete(0);\r\n        return { success: true };\r\n      }\r\n\r\n      // Run .mux/init hook if it exists\r\n      const hookExists = await checkInitHookExists(projectPath);\r\n      if (hookExists) {\r\n        initLogger.enterHookPhase?.();\r\n        const muxEnv = { ...env, ...getMuxEnv(projectPath, \"local\", branchName) };\r\n        await this.runInitHook(workspacePath, muxEnv, initLogger, abortSignal);\r\n      } else {\r\n        // No hook - signal completion immediately\r\n        initLogger.logComplete(0);\r\n      }\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMsg = getErrorMessage(error);\r\n      initLogger.logStderr(`Initialization failed: ${errorMsg}`);\r\n      initLogger.logComplete(-1);\r\n      return {\r\n        success: false,\r\n        error: errorMsg,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Renaming is a no-op for LocalRuntime - the workspace path is always the project directory.\r\n   * Returns success so the metadata (workspace name) can be updated in config.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/require-await\r\n  async renameWorkspace(\r\n    _projectPath: string,\r\n    _oldName: string,\r\n    _newName: string,\r\n    _abortSignal?: AbortSignal\r\n  ): Promise<\r\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\r\n  > {\r\n    // No filesystem operation needed - path stays the same\r\n    return { success: true, oldPath: this.projectPath, newPath: this.projectPath };\r\n  }\r\n\r\n  /**\r\n   * Deleting is a no-op for LocalRuntime - we never delete the user's project directory.\r\n   * Returns success so the workspace entry can be removed from config.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/require-await\r\n  async deleteWorkspace(\r\n    _projectPath: string,\r\n    _workspaceName: string,\r\n    _force: boolean,\r\n    _abortSignal?: AbortSignal\r\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }> {\r\n    // Return success but don't actually delete anything\r\n    // The project directory should never be deleted\r\n    return { success: true, deletedPath: this.projectPath };\r\n  }\r\n\r\n  /**\r\n   * Fork for LocalRuntime creates a new workspace entry pointing to the same project directory.\r\n   * Since LocalRuntime doesn't create separate directories, \"forking\" just means:\r\n   * 1. A new workspace ID with the new name\r\n   * 2. Copied chat history (handled by workspaceService)\r\n   * 3. Same project directory as source\r\n   *\r\n   * This enables conversation branching without git worktree overhead.\r\n   */\r\n  async forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult> {\r\n    const { initLogger } = params;\r\n\r\n    initLogger.logStep(\"Creating conversation fork (no worktree isolation)\");\r\n\r\n    // Verify the project directory exists (same check as createWorkspace)\r\n    try {\r\n      await this.stat(this.projectPath);\r\n    } catch {\r\n      return {\r\n        success: false,\r\n        error: `Project directory does not exist: ${this.projectPath}`,\r\n      };\r\n    }\r\n\r\n    initLogger.logStep(\"Project directory verified\");\r\n\r\n    // Return success - the workspace service will copy chat history\r\n    // and create a new workspace entry pointing to this project directory\r\n    return {\r\n      success: true,\r\n      workspacePath: this.projectPath,\r\n      // sourceBranch is optional for LocalRuntime since no git operations are involved\r\n    };\r\n  }\r\n}\r\n"]}