{"version":3,"file":"LocalRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/LocalRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  EnsureReadyOptions,\n  EnsureReadyResult,\n  WorkspaceCreationParams,\n  WorkspaceCreationResult,\n  WorkspaceInitParams,\n  WorkspaceInitResult,\n  WorkspaceForkParams,\n  WorkspaceForkResult,\n} from \"./Runtime\";\nimport { checkInitHookExists, getMuxEnv } from \"./initHook\";\nimport { getErrorMessage } from \"@/common/utils/errors\";\nimport { LocalBaseRuntime } from \"./LocalBaseRuntime\";\n\n/**\n * Local runtime implementation that uses the project directory directly.\n *\n * Unlike WorktreeRuntime, this runtime:\n * - Does NOT create git worktrees or isolate workspaces\n * - Uses the project directory as the workspace path\n * - Cannot delete the project directory (deleteWorkspace is a no-op)\n * - Supports forking (creates new workspace entries pointing to same project directory)\n *\n * This is useful for users who want to work directly in their project\n * without the overhead of worktree management.\n */\nexport class LocalRuntime extends LocalBaseRuntime {\n  private readonly projectPath: string;\n\n  constructor(projectPath: string) {\n    super();\n    this.projectPath = projectPath;\n  }\n\n  /**\n   * For LocalRuntime, the workspace path is always the project path itself.\n   * The workspaceName parameter is ignored since there's only one workspace per project.\n   */\n  getWorkspacePath(_projectPath: string, _workspaceName: string): string {\n    return this.projectPath;\n  }\n\n  override ensureReady(options?: EnsureReadyOptions): Promise<EnsureReadyResult> {\n    const statusSink = options?.statusSink;\n    statusSink?.({\n      phase: \"checking\",\n      runtimeType: \"local\",\n      detail: \"Checking repository...\",\n    });\n\n    // Non-git projects are explicitly supported for LocalRuntime; avoid blocking readiness\n    // on missing .git so local-only workflows continue to work.\n    statusSink?.({ phase: \"ready\", runtimeType: \"local\" });\n    return Promise.resolve({ ready: true });\n  }\n\n  /**\n   * Creating a workspace is a no-op for LocalRuntime since we use the project directory directly.\n   * We just verify the directory exists.\n   */\n  async createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult> {\n    const { initLogger } = params;\n\n    try {\n      initLogger.logStep(\"Using project directory directly (no worktree isolation)\");\n\n      // Verify the project directory exists\n      try {\n        await this.stat(this.projectPath);\n      } catch {\n        return {\n          success: false,\n          error: `Project directory does not exist: ${this.projectPath}`,\n        };\n      }\n\n      initLogger.logStep(\"Project directory verified\");\n\n      return { success: true, workspacePath: this.projectPath };\n    } catch (error) {\n      return {\n        success: false,\n        error: getErrorMessage(error),\n      };\n    }\n  }\n\n  async initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult> {\n    const { projectPath, branchName, workspacePath, initLogger, abortSignal, env, skipInitHook } =\n      params;\n\n    try {\n      if (skipInitHook) {\n        initLogger.logStep(\"Skipping .mux/init hook (disabled for this task)\");\n        initLogger.logComplete(0);\n        return { success: true };\n      }\n\n      // Run .mux/init hook if it exists\n      const hookExists = await checkInitHookExists(projectPath);\n      if (hookExists) {\n        initLogger.enterHookPhase?.();\n        const muxEnv = { ...env, ...getMuxEnv(projectPath, \"local\", branchName) };\n        await this.runInitHook(workspacePath, muxEnv, initLogger, abortSignal);\n      } else {\n        // No hook - signal completion immediately\n        initLogger.logComplete(0);\n      }\n      return { success: true };\n    } catch (error) {\n      const errorMsg = getErrorMessage(error);\n      initLogger.logStderr(`Initialization failed: ${errorMsg}`);\n      initLogger.logComplete(-1);\n      return {\n        success: false,\n        error: errorMsg,\n      };\n    }\n  }\n\n  /**\n   * Renaming is a no-op for LocalRuntime - the workspace path is always the project directory.\n   * Returns success so the metadata (workspace name) can be updated in config.\n   */\n  // eslint-disable-next-line @typescript-eslint/require-await\n  async renameWorkspace(\n    _projectPath: string,\n    _oldName: string,\n    _newName: string,\n    _abortSignal?: AbortSignal\n  ): Promise<\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\n  > {\n    // No filesystem operation needed - path stays the same\n    return { success: true, oldPath: this.projectPath, newPath: this.projectPath };\n  }\n\n  /**\n   * Deleting is a no-op for LocalRuntime - we never delete the user's project directory.\n   * Returns success so the workspace entry can be removed from config.\n   */\n  // eslint-disable-next-line @typescript-eslint/require-await\n  async deleteWorkspace(\n    _projectPath: string,\n    _workspaceName: string,\n    _force: boolean,\n    _abortSignal?: AbortSignal\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }> {\n    // Return success but don't actually delete anything\n    // The project directory should never be deleted\n    return { success: true, deletedPath: this.projectPath };\n  }\n\n  /**\n   * Fork for LocalRuntime creates a new workspace entry pointing to the same project directory.\n   * Since LocalRuntime doesn't create separate directories, \"forking\" just means:\n   * 1. A new workspace ID with the new name\n   * 2. Copied chat history (handled by workspaceService)\n   * 3. Same project directory as source\n   *\n   * This enables conversation branching without git worktree overhead.\n   */\n  async forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult> {\n    const { initLogger } = params;\n\n    initLogger.logStep(\"Creating conversation fork (no worktree isolation)\");\n\n    // Verify the project directory exists (same check as createWorkspace)\n    try {\n      await this.stat(this.projectPath);\n    } catch {\n      return {\n        success: false,\n        error: `Project directory does not exist: ${this.projectPath}`,\n      };\n    }\n\n    initLogger.logStep(\"Project directory verified\");\n\n    // Return success - the workspace service will copy chat history\n    // and create a new workspace entry pointing to this project directory\n    return {\n      success: true,\n      workspacePath: this.projectPath,\n      // sourceBranch is optional for LocalRuntime since no git operations are involved\n    };\n  }\n}\n"]}