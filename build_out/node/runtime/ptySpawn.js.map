{"version":3,"file":"ptySpawn.js","sourceRoot":"","sources":["../../../src/node/runtime/ptySpawn.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IPty } from \"node-pty\";\nimport { log } from \"@/node/services/log\";\n\ninterface PtySpawnRequest {\n  runtimeLabel: string;\n  command: string;\n  args: string[];\n  cwd: string;\n  cols: number;\n  rows: number;\n  preferElectronBuild: boolean;\n  env?: NodeJS.ProcessEnv;\n  pathEnv?: string;\n  logLocalEnv?: boolean;\n}\n\n// eslint-disable-next-line @typescript-eslint/consistent-type-imports\nfunction loadNodePty(runtimeType: string, preferElectronBuild: boolean): typeof import(\"node-pty\") {\n  const first = preferElectronBuild ? \"node-pty\" : \"@lydell/node-pty\";\n  const second = preferElectronBuild ? \"@lydell/node-pty\" : \"node-pty\";\n\n  try {\n    // eslint-disable-next-line @typescript-eslint/no-require-imports, @typescript-eslint/no-unsafe-assignment\n    const pty = require(first);\n    log.debug(`Using ${first} for ${runtimeType}`);\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return pty;\n  } catch {\n    try {\n      // eslint-disable-next-line @typescript-eslint/no-require-imports, @typescript-eslint/no-unsafe-assignment\n      const pty = require(second);\n      log.debug(`Using ${second} for ${runtimeType} (fallback)`);\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return pty;\n    } catch (err) {\n      log.error(\"Neither @lydell/node-pty nor node-pty available:\", err);\n      throw new Error(\n        process.versions.electron\n          ? `${runtimeType} terminals are not available. node-pty failed to load (likely due to Electron ABI version mismatch). Run 'make rebuild-native' to rebuild native modules.`\n          : `${runtimeType} terminals are not available. No prebuilt binaries found for your platform. Supported: linux-x64, linux-arm64, darwin-x64, darwin-arm64, win32-x64.`\n      );\n    }\n  }\n}\n\nfunction resolvePathEnv(env: NodeJS.ProcessEnv, pathEnvOverride?: string): string | undefined {\n  if (pathEnvOverride) {\n    return pathEnvOverride;\n  }\n\n  return (\n    env.PATH ??\n    env.Path ??\n    (process.platform === \"win32\" ? undefined : \"/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\")\n  );\n}\n\nexport function spawnPtyProcess(request: PtySpawnRequest): IPty {\n  const pty = loadNodePty(request.runtimeLabel, request.preferElectronBuild);\n  const mergedEnv: NodeJS.ProcessEnv = { ...process.env, ...request.env };\n  const pathEnv = resolvePathEnv(mergedEnv, request.pathEnv);\n\n  const env: NodeJS.ProcessEnv = {\n    ...mergedEnv,\n    TERM: \"xterm-256color\",\n    ...(pathEnv ? { PATH: pathEnv } : {}),\n  };\n\n  try {\n    return pty.spawn(request.command, request.args, {\n      name: \"xterm-256color\",\n      cols: request.cols,\n      rows: request.rows,\n      cwd: request.cwd,\n      env,\n    });\n  } catch (err) {\n    log.error(`[PTY] Failed to spawn ${request.runtimeLabel} terminal:`, err);\n\n    const printableArgs = request.args.length > 0 ? ` ${request.args.join(\" \")}` : \"\";\n    const cmd = `${request.command}${printableArgs}`;\n    const details = `cmd=\"${cmd}\", cwd=\"${request.cwd}\", platform=\"${process.platform}\"`;\n    const errMessage = err instanceof Error ? err.message : String(err);\n\n    if (request.logLocalEnv) {\n      log.error(`Local PTY spawn config: ${cmd} (cwd: ${request.cwd})`);\n      log.error(`process.env.SHELL: ${process.env.SHELL ?? \"undefined\"}`);\n      log.error(`process.env.PATH: ${process.env.PATH ?? process.env.Path ?? \"undefined\"}`);\n    }\n\n    throw new Error(`Failed to spawn ${request.runtimeLabel} terminal (${details}): ${errMessage}`);\n  }\n}\n"]}