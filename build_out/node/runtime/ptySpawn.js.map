{"version":3,"file":"ptySpawn.js","sourceRoot":"","sources":["../../../src/node/runtime/ptySpawn.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IPty } from \"node-pty\";\r\nimport { log } from \"@/node/services/log\";\r\n\r\ninterface PtySpawnRequest {\r\n  runtimeLabel: string;\r\n  command: string;\r\n  args: string[];\r\n  cwd: string;\r\n  cols: number;\r\n  rows: number;\r\n  preferElectronBuild: boolean;\r\n  env?: NodeJS.ProcessEnv;\r\n  pathEnv?: string;\r\n  logLocalEnv?: boolean;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/consistent-type-imports\r\nfunction loadNodePty(runtimeType: string, preferElectronBuild: boolean): typeof import(\"node-pty\") {\r\n  const first = preferElectronBuild ? \"node-pty\" : \"@lydell/node-pty\";\r\n  const second = preferElectronBuild ? \"@lydell/node-pty\" : \"node-pty\";\r\n\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/no-require-imports, @typescript-eslint/no-unsafe-assignment\r\n    const pty = require(first);\r\n    log.debug(`Using ${first} for ${runtimeType}`);\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n    return pty;\r\n  } catch {\r\n    try {\r\n      // eslint-disable-next-line @typescript-eslint/no-require-imports, @typescript-eslint/no-unsafe-assignment\r\n      const pty = require(second);\r\n      log.debug(`Using ${second} for ${runtimeType} (fallback)`);\r\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n      return pty;\r\n    } catch (err) {\r\n      log.error(\"Neither @lydell/node-pty nor node-pty available:\", err);\r\n      throw new Error(\r\n        process.versions.electron\r\n          ? `${runtimeType} terminals are not available. node-pty failed to load (likely due to Electron ABI version mismatch). Run 'make rebuild-native' to rebuild native modules.`\r\n          : `${runtimeType} terminals are not available. No prebuilt binaries found for your platform. Supported: linux-x64, linux-arm64, darwin-x64, darwin-arm64, win32-x64.`\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction resolvePathEnv(env: NodeJS.ProcessEnv, pathEnvOverride?: string): string | undefined {\r\n  if (pathEnvOverride) {\r\n    return pathEnvOverride;\r\n  }\r\n\r\n  return (\r\n    env.PATH ??\r\n    env.Path ??\r\n    (process.platform === \"win32\" ? undefined : \"/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\")\r\n  );\r\n}\r\n\r\nexport function spawnPtyProcess(request: PtySpawnRequest): IPty {\r\n  const pty = loadNodePty(request.runtimeLabel, request.preferElectronBuild);\r\n  const mergedEnv: NodeJS.ProcessEnv = { ...process.env, ...request.env };\r\n  const pathEnv = resolvePathEnv(mergedEnv, request.pathEnv);\r\n\r\n  const env: NodeJS.ProcessEnv = {\r\n    ...mergedEnv,\r\n    TERM: \"xterm-256color\",\r\n    ...(pathEnv ? { PATH: pathEnv } : {}),\r\n  };\r\n\r\n  try {\r\n    return pty.spawn(request.command, request.args, {\r\n      name: \"xterm-256color\",\r\n      cols: request.cols,\r\n      rows: request.rows,\r\n      cwd: request.cwd,\r\n      env,\r\n    });\r\n  } catch (err) {\r\n    log.error(`[PTY] Failed to spawn ${request.runtimeLabel} terminal:`, err);\r\n\r\n    const printableArgs = request.args.length > 0 ? ` ${request.args.join(\" \")}` : \"\";\r\n    const cmd = `${request.command}${printableArgs}`;\r\n    const details = `cmd=\"${cmd}\", cwd=\"${request.cwd}\", platform=\"${process.platform}\"`;\r\n    const errMessage = err instanceof Error ? err.message : String(err);\r\n\r\n    if (request.logLocalEnv) {\r\n      log.error(`Local PTY spawn config: ${cmd} (cwd: ${request.cwd})`);\r\n      log.error(`process.env.SHELL: ${process.env.SHELL ?? \"undefined\"}`);\r\n      log.error(`process.env.PATH: ${process.env.PATH ?? process.env.Path ?? \"undefined\"}`);\r\n    }\r\n\r\n    throw new Error(`Failed to spawn ${request.runtimeLabel} terminal (${details}): ${errMessage}`);\r\n  }\r\n}\r\n"]}