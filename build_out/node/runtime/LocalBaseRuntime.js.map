{"version":3,"file":"LocalBaseRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/LocalBaseRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["import { spawn } from \"child_process\";\nimport * as fs from \"fs\";\nimport * as fsPromises from \"fs/promises\";\nimport * as path from \"path\";\nimport { Readable, Writable } from \"stream\";\n\nimport type {\n  Runtime,\n  ExecOptions,\n  ExecStream,\n  FileStat,\n  WorkspaceCreationParams,\n  WorkspaceCreationResult,\n  WorkspaceInitParams,\n  WorkspaceInitResult,\n  WorkspaceForkParams,\n  WorkspaceForkResult,\n  InitLogger,\n  EnsureReadyResult,\n} from \"./Runtime\";\nimport { RuntimeError as RuntimeErrorClass } from \"./Runtime\";\nimport { NON_INTERACTIVE_ENV_VARS } from \"@/common/constants/env\";\nimport { getBashPath } from \"@/node/utils/main/bashPath\";\nimport { shellQuote } from \"@/common/utils/shell\";\nimport { EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT } from \"@/common/constants/exitCodes\";\nimport { DisposableProcess, killProcessTree } from \"@/node/utils/disposableExec\";\nimport { expandTilde } from \"./tildeExpansion\";\nimport { getInitHookPath, createLineBufferedLoggers } from \"./initHook\";\n\n/**\n * Abstract base class for local runtimes (both WorktreeRuntime and LocalRuntime).\n *\n * Provides shared implementation for:\n * - exec() - Command execution with streaming I/O\n * - readFile() - File reading with streaming\n * - writeFile() - Atomic file writes with streaming\n * - stat() - File statistics\n * - resolvePath() - Path resolution with tilde expansion\n * - normalizePath() - Path normalization\n *\n * Subclasses must implement workspace-specific methods:\n * - getWorkspacePath()\n * - createWorkspace()\n * - initWorkspace()\n * - deleteWorkspace()\n * - renameWorkspace()\n * - forkWorkspace()\n */\nexport abstract class LocalBaseRuntime implements Runtime {\n  async exec(command: string, options: ExecOptions): Promise<ExecStream> {\n    const startTime = performance.now();\n\n    // Use the specified working directory (must be a specific workspace path)\n    const cwd = options.cwd;\n\n    // Check if working directory exists before spawning\n    // This prevents confusing ENOENT errors from spawn()\n    try {\n      await fsPromises.access(cwd);\n    } catch (err) {\n      throw new RuntimeErrorClass(\n        `Working directory does not exist: ${cwd}`,\n        \"exec\",\n        err instanceof Error ? err : undefined\n      );\n    }\n\n    const bashPath = getBashPath();\n    const spawnCommand = bashPath;\n\n    // Match RemoteRuntime behavior: ensure non-interactive env vars are set inside the shell.\n    //\n    // Why not rely solely on `env`?\n    // - On Windows, env var casing and shell startup state can be surprising.\n    // - These are non-sensitive vars that we want to guarantee for git/editor safety.\n    const nonInteractivePrelude = Object.entries(NON_INTERACTIVE_ENV_VARS)\n      .map(([key, value]) => `export ${key}=${shellQuote(value)}`)\n      .join(\"\\n\");\n\n    const spawnArgs = [\"-c\", `${nonInteractivePrelude}\\n${command}`];\n\n    const defaultPath = \"/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\";\n    const effectivePath =\n      (options.env?.PATH && options.env.PATH.length > 0 ? options.env.PATH : process.env.PATH) ??\n      defaultPath;\n\n    const childProcess = spawn(spawnCommand, spawnArgs, {\n      cwd,\n      env: {\n        ...process.env,\n        ...(options.env ?? {}),\n        ...NON_INTERACTIVE_ENV_VARS,\n        PATH: effectivePath,\n      },\n      stdio: [\"pipe\", \"pipe\", \"pipe\"],\n      // CRITICAL: Spawn as detached process group leader to enable cleanup of background processes.\n      // When a bash script spawns background processes (e.g., `sleep 100 &`), we need to kill\n      // the entire process group (including all backgrounded children) via process.kill(-pid).\n      // NOTE: detached:true does NOT cause bash to wait for background jobs when using 'exit' event\n      // instead of 'close' event. The 'exit' event fires when bash exits, ignoring background children.\n      detached: true,\n      // Prevent console window from appearing on Windows (WSL bash spawns steal focus otherwise)\n      windowsHide: true,\n    });\n\n    // Wrap in DisposableProcess for automatic cleanup\n    const disposable = new DisposableProcess(childProcess);\n\n    // Convert Node.js streams to Web Streams\n    const stdout = Readable.toWeb(childProcess.stdout) as unknown as ReadableStream<Uint8Array>;\n    const stderr = Readable.toWeb(childProcess.stderr) as unknown as ReadableStream<Uint8Array>;\n    const stdin = Writable.toWeb(childProcess.stdin) as unknown as WritableStream<Uint8Array>;\n\n    // No stream cleanup in DisposableProcess - streams close naturally when process exits\n    // bash.ts handles cleanup after waiting for exitCode\n\n    // Track if we killed the process due to timeout or abort\n    let timedOut = false;\n    let aborted = false;\n\n    // Create promises for exit code and duration\n    // Uses special exit codes (EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT) for expected error conditions\n    const exitCode = new Promise<number>((resolve, reject) => {\n      // Use 'exit' event instead of 'close' to handle background processes correctly.\n      // The 'close' event waits for ALL child processes (including background ones) to exit,\n      // which causes hangs when users spawn background processes like servers.\n      // The 'exit' event fires when the main bash process exits, which is what we want.\n      childProcess.on(\"exit\", (code) => {\n        // Clean up any background processes (process group cleanup)\n        // This prevents zombie processes when scripts spawn background tasks\n        if (childProcess.pid !== undefined) {\n          // Kill the full process tree to prevent hangs when scripts spawn background jobs.\n          //\n          // On Unix we can kill the whole group via process.kill(-pid).\n          // On Windows we must use taskkill to avoid leaking child processes.\n          killProcessTree(childProcess.pid);\n        }\n\n        // Check abort first (highest priority)\n        if (aborted || options.abortSignal?.aborted) {\n          resolve(EXIT_CODE_ABORTED);\n          return;\n        }\n        // Check if we killed the process due to timeout\n        if (timedOut) {\n          resolve(EXIT_CODE_TIMEOUT);\n          return;\n        }\n        resolve(code ?? 0);\n        // Cleanup runs automatically via DisposableProcess\n      });\n\n      childProcess.on(\"error\", (err) => {\n        reject(new RuntimeErrorClass(`Failed to execute command: ${err.message}`, \"exec\", err));\n      });\n    });\n\n    const duration = exitCode.then(() => performance.now() - startTime);\n\n    // Avoid unhandled promise rejections in fire-and-forget exec() callsites.\n    // Callers that await these promises will still observe the rejection.\n    void exitCode.catch(() => undefined);\n    void duration.catch(() => undefined);\n\n    // Register process group cleanup with DisposableProcess\n    // This ensures ALL background children are killed when process exits\n    disposable.addCleanup(() => {\n      if (childProcess.pid === undefined) return;\n\n      // Kill the full process tree (see comment in exit handler).\n      killProcessTree(childProcess.pid);\n    });\n\n    // Handle abort signal\n    if (options.abortSignal) {\n      options.abortSignal.addEventListener(\"abort\", () => {\n        aborted = true;\n        disposable[Symbol.dispose](); // Kill process and run cleanup\n      });\n    }\n\n    // Handle timeout\n    if (options.timeout !== undefined) {\n      const timeoutHandle = setTimeout(() => {\n        timedOut = true;\n        disposable[Symbol.dispose](); // Kill process and run cleanup\n      }, options.timeout * 1000);\n\n      // Clear timeout if process exits naturally\n      void exitCode.catch(() => undefined).finally(() => clearTimeout(timeoutHandle));\n    }\n\n    return { stdout, stderr, stdin, exitCode, duration };\n  }\n\n  readFile(filePath: string, _abortSignal?: AbortSignal): ReadableStream<Uint8Array> {\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\n    // Expand tildes before reading (Node.js fs doesn't expand ~)\n    const expandedPath = expandTilde(filePath);\n    const nodeStream = fs.createReadStream(expandedPath);\n\n    // Handle errors by wrapping in a transform\n    const webStream = Readable.toWeb(nodeStream) as unknown as ReadableStream<Uint8Array>;\n\n    return new ReadableStream<Uint8Array>({\n      async start(controller: ReadableStreamDefaultController<Uint8Array>) {\n        try {\n          const reader = webStream.getReader();\n          while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n            controller.enqueue(value);\n          }\n          controller.close();\n        } catch (err) {\n          controller.error(\n            new RuntimeErrorClass(\n              `Failed to read file ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\n              \"file_io\",\n              err instanceof Error ? err : undefined\n            )\n          );\n        }\n      },\n    });\n  }\n\n  writeFile(filePath: string, _abortSignal?: AbortSignal): WritableStream<Uint8Array> {\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\n    // Expand tildes before writing (Node.js fs doesn't expand ~)\n    const expandedPath = expandTilde(filePath);\n    let tempPath: string;\n    let writer: WritableStreamDefaultWriter<Uint8Array>;\n    let resolvedPath: string;\n    let originalMode: number | undefined;\n\n    return new WritableStream<Uint8Array>({\n      async start() {\n        // Resolve symlinks to write through them (preserves the symlink)\n        try {\n          resolvedPath = await fsPromises.realpath(expandedPath);\n          // Save original permissions to restore after write\n          const stat = await fsPromises.stat(resolvedPath);\n          originalMode = stat.mode;\n        } catch {\n          // If file doesn't exist, use the expanded path and default permissions\n          resolvedPath = expandedPath;\n          originalMode = undefined;\n        }\n\n        // Create parent directories if they don't exist\n        const parentDir = path.dirname(resolvedPath);\n        await fsPromises.mkdir(parentDir, { recursive: true });\n\n        // Create temp file for atomic write\n        tempPath = `${resolvedPath}.tmp.${Date.now()}`;\n        const nodeStream = fs.createWriteStream(tempPath);\n        const webStream = Writable.toWeb(nodeStream) as WritableStream<Uint8Array>;\n        writer = webStream.getWriter();\n      },\n      async write(chunk: Uint8Array) {\n        await writer.write(chunk);\n      },\n      async close() {\n        // Close the writer and rename to final location\n        await writer.close();\n        try {\n          // If we have original permissions, apply them to temp file before rename\n          if (originalMode !== undefined) {\n            await fsPromises.chmod(tempPath, originalMode);\n          }\n          await fsPromises.rename(tempPath, resolvedPath);\n        } catch (err) {\n          throw new RuntimeErrorClass(\n            `Failed to write file ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\n            \"file_io\",\n            err instanceof Error ? err : undefined\n          );\n        }\n      },\n      async abort(reason?: unknown) {\n        // Clean up temp file on abort\n        await writer.abort();\n        try {\n          await fsPromises.unlink(tempPath);\n        } catch {\n          // Ignore errors cleaning up temp file\n        }\n        throw new RuntimeErrorClass(\n          `Failed to write file ${filePath}: ${String(reason)}`,\n          \"file_io\"\n        );\n      },\n    });\n  }\n\n  async stat(filePath: string, _abortSignal?: AbortSignal): Promise<FileStat> {\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\n    // Expand tildes before stat (Node.js fs doesn't expand ~)\n    const expandedPath = expandTilde(filePath);\n    try {\n      const stats = await fsPromises.stat(expandedPath);\n      return {\n        size: stats.size,\n        modifiedTime: stats.mtime,\n        isDirectory: stats.isDirectory(),\n      };\n    } catch (err) {\n      throw new RuntimeErrorClass(\n        `Failed to stat ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\n        \"file_io\",\n        err instanceof Error ? err : undefined\n      );\n    }\n  }\n\n  async ensureDir(dirPath: string): Promise<void> {\n    const expandedPath = expandTilde(dirPath);\n    try {\n      await fsPromises.mkdir(expandedPath, { recursive: true });\n    } catch (err) {\n      throw new RuntimeErrorClass(\n        `Failed to create directory ${dirPath}: ${err instanceof Error ? err.message : String(err)}`,\n        \"file_io\",\n        err instanceof Error ? err : undefined\n      );\n    }\n  }\n\n  resolvePath(filePath: string): Promise<string> {\n    // Expand tilde to actual home directory path\n    const expanded = expandTilde(filePath);\n\n    // Resolve to absolute path (handles relative paths like \"./foo\")\n    return Promise.resolve(path.resolve(expanded));\n  }\n\n  normalizePath(targetPath: string, basePath: string): string {\n    // For local runtime, use Node.js path resolution\n    // Handle special case: current directory\n    const target = targetPath.trim();\n    if (target === \".\") {\n      return path.resolve(basePath);\n    }\n    // Expand tildes before resolving (~ is not expanded by path.resolve)\n    const expanded = expandTilde(target);\n    return path.resolve(basePath, expanded);\n  }\n\n  // Abstract methods that subclasses must implement\n  abstract getWorkspacePath(projectPath: string, workspaceName: string): string;\n\n  abstract createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult>;\n\n  abstract initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult>;\n\n  abstract renameWorkspace(\n    projectPath: string,\n    oldName: string,\n    newName: string,\n    abortSignal?: AbortSignal\n  ): Promise<\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\n  >;\n\n  abstract deleteWorkspace(\n    projectPath: string,\n    workspaceName: string,\n    force: boolean,\n    abortSignal?: AbortSignal\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }>;\n\n  abstract forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult>;\n\n  /**\n   * Get the runtime's temp directory.\n   * Uses OS temp dir on local systems.\n   */\n  tempDir(): Promise<string> {\n    // Use /tmp on Unix, or OS temp dir on Windows\n    const isWindows = process.platform === \"win32\";\n    return Promise.resolve(isWindows ? (process.env.TEMP ?? \"C:\\\\Temp\") : \"/tmp\");\n  }\n\n  getMuxHome(): string {\n    return \"~/.mux\";\n  }\n\n  /**\n   * Local runtimes are always ready.\n   */\n  ensureReady(): Promise<EnsureReadyResult> {\n    return Promise.resolve({ ready: true });\n  }\n\n  /**\n   * Helper to run .mux/init hook if it exists and is executable.\n   * Shared between WorktreeRuntime and LocalRuntime.\n   * @param workspacePath - Path to the workspace directory\n   * @param muxEnv - MUX_ environment variables (from getMuxEnv)\n   * @param initLogger - Logger for streaming output\n   * @param abortSignal - Optional abort signal\n   */\n  protected async runInitHook(\n    workspacePath: string,\n    muxEnv: Record<string, string>,\n    initLogger: InitLogger,\n    abortSignal?: AbortSignal\n  ): Promise<void> {\n    // Hook path is derived from MUX_PROJECT_PATH in muxEnv\n    const projectPath = muxEnv.MUX_PROJECT_PATH;\n    const hookPath = getInitHookPath(projectPath);\n    initLogger.logStep(`Running init hook: ${hookPath}`);\n\n    if (abortSignal?.aborted) {\n      initLogger.logComplete(EXIT_CODE_ABORTED);\n      return;\n    }\n\n    // Create line-buffered loggers\n    const loggers = createLineBufferedLoggers(initLogger);\n\n    return new Promise<void>((resolve) => {\n      const bashPath = getBashPath();\n      const proc = spawn(bashPath, [\"-c\", `\"${hookPath}\"`], {\n        cwd: workspacePath,\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\n        env: {\n          ...process.env,\n          ...muxEnv,\n        },\n        // Prevent console window from appearing on Windows\n        windowsHide: true,\n        // Spawn as a detached process group leader so we can reliably cancel the hook.\n        detached: true,\n      });\n\n      let aborted = false;\n\n      const onAbort = () => {\n        aborted = true;\n\n        if (proc.pid !== undefined) {\n          killProcessTree(proc.pid);\n          return;\n        }\n\n        try {\n          proc.kill(\"SIGKILL\");\n        } catch {\n          // ignore\n        }\n      };\n\n      abortSignal?.addEventListener(\"abort\", onAbort, { once: true });\n      if (abortSignal?.aborted) {\n        onAbort();\n      }\n\n      proc.stdout.on(\"data\", (data: Buffer) => {\n        loggers.stdout.append(data.toString());\n      });\n\n      proc.stderr.on(\"data\", (data: Buffer) => {\n        loggers.stderr.append(data.toString());\n      });\n\n      proc.on(\"close\", (code) => {\n        abortSignal?.removeEventListener(\"abort\", onAbort);\n\n        // Flush any remaining buffered output\n        loggers.stdout.flush();\n        loggers.stderr.flush();\n\n        initLogger.logComplete(aborted || abortSignal?.aborted ? EXIT_CODE_ABORTED : (code ?? 0));\n        resolve();\n      });\n\n      proc.on(\"error\", (err) => {\n        abortSignal?.removeEventListener(\"abort\", onAbort);\n\n        if (aborted || abortSignal?.aborted) {\n          initLogger.logComplete(EXIT_CODE_ABORTED);\n          resolve();\n          return;\n        }\n\n        initLogger.logStderr(`Error running init hook: ${err.message}`);\n        initLogger.logComplete(-1);\n        resolve();\n      });\n    });\n  }\n}\n"]}