{"version":3,"file":"LocalBaseRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/LocalBaseRuntime.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,iDAAsC;AACtC,MAAY,EAAE,+BAAW;AACzB,MAAY,UAAU,wCAAoB;AAC1C,MAAY,IAAI,iCAAa;AAC7B,mCAA4C;AAgB5C,uCAA8D;AAC9D,gDAAkE;AAClE,yDAAyD;AACzD,gDAAkD;AAClD,4DAAoF;AACpF,gEAAiF;AACjF,qDAA+C;AAC/C,yCAAwE;AAExE;;;;;;;;;;;;;;;;;;GAkBG;AACH;IACE,KAAK,CAAC,IAAI,CAAC,OAAe,EAAE,OAAoB,EAAuB;QACrE,MAAM,SAAS,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;QAEpC,0EAA0E;QAC1E,MAAM,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC;QAExB,oDAAoD;QACpD,qDAAqD;QACrD,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC/B,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,MAAM,IAAI,sBAAiB,CACzB,qCAAqC,GAAG,EAAE,EAC1C,MAAM,EACN,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CACvC,CAAC;QACJ,CAAC;QAED,MAAM,QAAQ,GAAG,IAAA,sBAAW,GAAE,CAAC;QAC/B,MAAM,YAAY,GAAG,QAAQ,CAAC;QAE9B,0FAA0F;QAC1F,EAAE;QACF,gCAAgC;QAChC,0EAA0E;QAC1E,kFAAkF;QAClF,MAAM,qBAAqB,GAAG,MAAM,CAAC,OAAO,CAAC,8BAAwB,CAAC;aACnE,GAAG,CAAC,CAAC,CAAC,GAAG,EAAE,KAAK,CAAC,EAAE,EAAE,CAAC,UAAU,GAAG,IAAI,IAAA,kBAAU,EAAC,KAAK,CAAC,EAAE,CAAC;aAC3D,IAAI,CAAC,IAAI,CAAC,CAAC;QAEd,MAAM,SAAS,GAAG,CAAC,IAAI,EAAE,GAAG,qBAAqB,KAAK,OAAO,EAAE,CAAC,CAAC;QAEjE,MAAM,WAAW,GAAG,8CAA8C,CAAC;QACnE,MAAM,aAAa,GACjB,CAAC,OAAO,CAAC,GAAG,EAAE,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC;YACxF,WAAW,CAAC;QAEd,MAAM,YAAY,GAAG,IAAA,qBAAK,EAAC,YAAY,EAAE,SAAS,EAAE;YAClD,GAAG;YACH,GAAG,EAAE;gBACH,GAAG,OAAO,CAAC,GAAG;gBACd,GAAG,CAAC,OAAO,CAAC,GAAG,IAAI,EAAE,CAAC;gBACtB,GAAG,8BAAwB;gBAC3B,IAAI,EAAE,aAAa;aACpB;YACD,KAAK,EAAE,CAAC,MAAM,EAAE,MAAM,EAAE,MAAM,CAAC;YAC/B,8FAA8F;YAC9F,wFAAwF;YACxF,yFAAyF;YACzF,8FAA8F;YAC9F,kGAAkG;YAClG,QAAQ,EAAE,IAAI;YACd,2FAA2F;YAC3F,WAAW,EAAE,IAAI;SAClB,CAAC,CAAC;QAEH,kDAAkD;QAClD,MAAM,UAAU,GAAG,IAAI,kCAAiB,CAAC,YAAY,CAAC,CAAC;QAEvD,yCAAyC;QACzC,MAAM,MAAM,GAAG,iBAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,MAAM,CAA0C,CAAC;QAC5F,MAAM,MAAM,GAAG,iBAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,MAAM,CAA0C,CAAC;QAC5F,MAAM,KAAK,GAAG,iBAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,KAAK,CAA0C,CAAC;QAE1F,sFAAsF;QACtF,qDAAqD;QAErD,yDAAyD;QACzD,IAAI,QAAQ,GAAG,KAAK,CAAC;QACrB,IAAI,OAAO,GAAG,KAAK,CAAC;QAEpB,6CAA6C;QAC7C,+FAA+F;QAC/F,MAAM,QAAQ,GAAG,IAAI,OAAO,CAAS,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE,CAAC;YACxD,gFAAgF;YAChF,uFAAuF;YACvF,yEAAyE;YACzE,kFAAkF;YAClF,YAAY,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC;gBAChC,4DAA4D;gBAC5D,qEAAqE;gBACrE,IAAI,YAAY,CAAC,GAAG,KAAK,SAAS,EAAE,CAAC;oBACnC,kFAAkF;oBAClF,EAAE;oBACF,8DAA8D;oBAC9D,oEAAoE;oBACpE,IAAA,gCAAe,EAAC,YAAY,CAAC,GAAG,CAAC,CAAC;gBACpC,CAAC;gBAED,uCAAuC;gBACvC,IAAI,OAAO,IAAI,OAAO,CAAC,WAAW,EAAE,OAAO,EAAE,CAAC;oBAC5C,OAAO,CAAC,6BAAiB,CAAC,CAAC;oBAC3B,OAAO;gBACT,CAAC;gBACD,gDAAgD;gBAChD,IAAI,QAAQ,EAAE,CAAC;oBACb,OAAO,CAAC,6BAAiB,CAAC,CAAC;oBAC3B,OAAO;gBACT,CAAC;gBACD,OAAO,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC;gBACnB,mDAAmD;YADhC,CAEpB,CAAC,CAAC;YAEH,YAAY,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC;gBAChC,MAAM,CAAC,IAAI,sBAAiB,CAAC,8BAA8B,GAAG,CAAC,OAAO,EAAE,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC;YAAA,CACzF,CAAC,CAAC;QAAA,CACJ,CAAC,CAAC;QAEH,MAAM,QAAQ,GAAG,QAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,WAAW,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC,CAAC;QAEpE,0EAA0E;QAC1E,sEAAsE;QACtE,KAAK,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC;QACrC,KAAK,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC;QAErC,wDAAwD;QACxD,qEAAqE;QACrE,UAAU,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;YAC1B,IAAI,YAAY,CAAC,GAAG,KAAK,SAAS;gBAAE,OAAO;YAE3C,4DAA4D;YAC5D,IAAA,gCAAe,EAAC,YAAY,CAAC,GAAG,CAAC,CAAC;QAAA,CACnC,CAAC,CAAC;QAEH,sBAAsB;QACtB,IAAI,OAAO,CAAC,WAAW,EAAE,CAAC;YACxB,OAAO,CAAC,WAAW,CAAC,gBAAgB,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC;gBAClD,OAAO,GAAG,IAAI,CAAC;gBACf,UAAU,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,+BAA+B;YAAhC,CAC9B,CAAC,CAAC;QACL,CAAC;QAED,iBAAiB;QACjB,IAAI,OAAO,CAAC,OAAO,KAAK,SAAS,EAAE,CAAC;YAClC,MAAM,aAAa,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC;gBACrC,QAAQ,GAAG,IAAI,CAAC;gBAChB,UAAU,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,+BAA+B;YAAhC,CAC9B,EAAE,OAAO,CAAC,OAAO,GAAG,IAAI,CAAC,CAAC;YAE3B,2CAA2C;YAC3C,KAAK,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,YAAY,CAAC,aAAa,CAAC,CAAC,CAAC;QAClF,CAAC;QAED,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC;IAAA,CACtD;IAED,QAAQ,CAAC,QAAgB,EAAE,YAA0B,EAA8B;QACjF,mFAAmF;QACnF,6DAA6D;QAC7D,MAAM,YAAY,GAAG,IAAA,4BAAW,EAAC,QAAQ,CAAC,CAAC;QAC3C,MAAM,UAAU,GAAG,EAAE,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;QAErD,2CAA2C;QAC3C,MAAM,SAAS,GAAG,iBAAQ,CAAC,KAAK,CAAC,UAAU,CAA0C,CAAC;QAEtF,OAAO,IAAI,cAAc,CAAa;YACpC,KAAK,CAAC,KAAK,CAAC,UAAuD,EAAE;gBACnE,IAAI,CAAC;oBACH,MAAM,MAAM,GAAG,SAAS,CAAC,SAAS,EAAE,CAAC;oBACrC,OAAO,IAAI,EAAE,CAAC;wBACZ,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,MAAM,CAAC,IAAI,EAAE,CAAC;wBAC5C,IAAI,IAAI;4BAAE,MAAM;wBAChB,UAAU,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;oBAC5B,CAAC;oBACD,UAAU,CAAC,KAAK,EAAE,CAAC;gBACrB,CAAC;gBAAC,OAAO,GAAG,EAAE,CAAC;oBACb,UAAU,CAAC,KAAK,CACd,IAAI,sBAAiB,CACnB,uBAAuB,QAAQ,KAAK,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,EACtF,SAAS,EACT,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CACvC,CACF,CAAC;gBACJ,CAAC;YAAA,CACF;SACF,CAAC,CAAC;IAAA,CACJ;IAED,SAAS,CAAC,QAAgB,EAAE,YAA0B,EAA8B;QAClF,mFAAmF;QACnF,6DAA6D;QAC7D,MAAM,YAAY,GAAG,IAAA,4BAAW,EAAC,QAAQ,CAAC,CAAC;QAC3C,IAAI,QAAgB,CAAC;QACrB,IAAI,MAA+C,CAAC;QACpD,IAAI,YAAoB,CAAC;QACzB,IAAI,YAAgC,CAAC;QAErC,OAAO,IAAI,cAAc,CAAa;YACpC,KAAK,CAAC,KAAK,GAAG;gBACZ,iEAAiE;gBACjE,IAAI,CAAC;oBACH,YAAY,GAAG,MAAM,UAAU,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC;oBACvD,mDAAmD;oBACnD,MAAM,IAAI,GAAG,MAAM,UAAU,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;oBACjD,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC;gBAC3B,CAAC;gBAAC,MAAM,CAAC;oBACP,uEAAuE;oBACvE,YAAY,GAAG,YAAY,CAAC;oBAC5B,YAAY,GAAG,SAAS,CAAC;gBAC3B,CAAC;gBAED,gDAAgD;gBAChD,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;gBAC7C,MAAM,UAAU,CAAC,KAAK,CAAC,SAAS,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;gBAEvD,oCAAoC;gBACpC,QAAQ,GAAG,GAAG,YAAY,QAAQ,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC;gBAC/C,MAAM,UAAU,GAAG,EAAE,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;gBAClD,MAAM,SAAS,GAAG,iBAAQ,CAAC,KAAK,CAAC,UAAU,CAA+B,CAAC;gBAC3E,MAAM,GAAG,SAAS,CAAC,SAAS,EAAE,CAAC;YAAA,CAChC;YACD,KAAK,CAAC,KAAK,CAAC,KAAiB,EAAE;gBAC7B,MAAM,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAAA,CAC3B;YACD,KAAK,CAAC,KAAK,GAAG;gBACZ,gDAAgD;gBAChD,MAAM,MAAM,CAAC,KAAK,EAAE,CAAC;gBACrB,IAAI,CAAC;oBACH,yEAAyE;oBACzE,IAAI,YAAY,KAAK,SAAS,EAAE,CAAC;wBAC/B,MAAM,UAAU,CAAC,KAAK,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC;oBACjD,CAAC;oBACD,MAAM,UAAU,CAAC,MAAM,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC;gBAClD,CAAC;gBAAC,OAAO,GAAG,EAAE,CAAC;oBACb,MAAM,IAAI,sBAAiB,CACzB,wBAAwB,QAAQ,KAAK,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,EACvF,SAAS,EACT,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CACvC,CAAC;gBACJ,CAAC;YAAA,CACF;YACD,KAAK,CAAC,KAAK,CAAC,MAAgB,EAAE;gBAC5B,8BAA8B;gBAC9B,MAAM,MAAM,CAAC,KAAK,EAAE,CAAC;gBACrB,IAAI,CAAC;oBACH,MAAM,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;gBACpC,CAAC;gBAAC,MAAM,CAAC;oBACP,sCAAsC;gBACxC,CAAC;gBACD,MAAM,IAAI,sBAAiB,CACzB,wBAAwB,QAAQ,KAAK,MAAM,CAAC,MAAM,CAAC,EAAE,EACrD,SAAS,CACV,CAAC;YAAA,CACH;SACF,CAAC,CAAC;IAAA,CACJ;IAED,KAAK,CAAC,IAAI,CAAC,QAAgB,EAAE,YAA0B,EAAqB;QAC1E,mFAAmF;QACnF,0DAA0D;QAC1D,MAAM,YAAY,GAAG,IAAA,4BAAW,EAAC,QAAQ,CAAC,CAAC;QAC3C,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,MAAM,UAAU,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YAClD,OAAO;gBACL,IAAI,EAAE,KAAK,CAAC,IAAI;gBAChB,YAAY,EAAE,KAAK,CAAC,KAAK;gBACzB,WAAW,EAAE,KAAK,CAAC,WAAW,EAAE;aACjC,CAAC;QACJ,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,MAAM,IAAI,sBAAiB,CACzB,kBAAkB,QAAQ,KAAK,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,EACjF,SAAS,EACT,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CACvC,CAAC;QACJ,CAAC;IAAA,CACF;IAED,KAAK,CAAC,SAAS,CAAC,OAAe,EAAiB;QAC9C,MAAM,YAAY,GAAG,IAAA,4BAAW,EAAC,OAAO,CAAC,CAAC;QAC1C,IAAI,CAAC;YACH,MAAM,UAAU,CAAC,KAAK,CAAC,YAAY,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;QAC5D,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,MAAM,IAAI,sBAAiB,CACzB,8BAA8B,OAAO,KAAK,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,EAC5F,SAAS,EACT,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,CACvC,CAAC;QACJ,CAAC;IAAA,CACF;IAED,WAAW,CAAC,QAAgB,EAAmB;QAC7C,6CAA6C;QAC7C,MAAM,QAAQ,GAAG,IAAA,4BAAW,EAAC,QAAQ,CAAC,CAAC;QAEvC,iEAAiE;QACjE,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC;IAAA,CAChD;IAED,aAAa,CAAC,UAAkB,EAAE,QAAgB,EAAU;QAC1D,iDAAiD;QACjD,yCAAyC;QACzC,MAAM,MAAM,GAAG,UAAU,CAAC,IAAI,EAAE,CAAC;QACjC,IAAI,MAAM,KAAK,GAAG,EAAE,CAAC;YACnB,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QAChC,CAAC;QACD,qEAAqE;QACrE,MAAM,QAAQ,GAAG,IAAA,4BAAW,EAAC,MAAM,CAAC,CAAC;QACrC,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;IAAA,CACzC;IA2BD;;;OAGG;IACH,OAAO,GAAoB;QACzB,8CAA8C;QAC9C,MAAM,SAAS,GAAG,OAAO,CAAC,QAAQ,KAAK,OAAO,CAAC;QAC/C,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,IAAI,UAAU,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;IAAA,CAC/E;IAED,UAAU,GAAW;QACnB,OAAO,QAAQ,CAAC;IAAA,CACjB;IAED;;OAEG;IACH,WAAW,GAA+B;QACxC,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;IAAA,CACzC;IAED;;;;;;;OAOG;IACO,KAAK,CAAC,WAAW,CACzB,aAAqB,EACrB,MAA8B,EAC9B,UAAsB,EACtB,WAAyB,EACV;QACf,uDAAuD;QACvD,MAAM,WAAW,GAAG,MAAM,CAAC,gBAAgB,CAAC;QAC5C,MAAM,QAAQ,GAAG,IAAA,0BAAe,EAAC,WAAW,CAAC,CAAC;QAC9C,UAAU,CAAC,OAAO,CAAC,sBAAsB,QAAQ,EAAE,CAAC,CAAC;QAErD,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;YACzB,UAAU,CAAC,WAAW,CAAC,6BAAiB,CAAC,CAAC;YAC1C,OAAO;QACT,CAAC;QAED,+BAA+B;QAC/B,MAAM,OAAO,GAAG,IAAA,oCAAyB,EAAC,UAAU,CAAC,CAAC;QAEtD,OAAO,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,EAAE,CAAC;YACpC,MAAM,QAAQ,GAAG,IAAA,sBAAW,GAAE,CAAC;YAC/B,MAAM,IAAI,GAAG,IAAA,qBAAK,EAAC,QAAQ,EAAE,CAAC,IAAI,EAAE,IAAI,QAAQ,GAAG,CAAC,EAAE;gBACpD,GAAG,EAAE,aAAa;gBAClB,KAAK,EAAE,CAAC,QAAQ,EAAE,MAAM,EAAE,MAAM,CAAC;gBACjC,GAAG,EAAE;oBACH,GAAG,OAAO,CAAC,GAAG;oBACd,GAAG,MAAM;iBACV;gBACD,mDAAmD;gBACnD,WAAW,EAAE,IAAI;gBACjB,+EAA+E;gBAC/E,QAAQ,EAAE,IAAI;aACf,CAAC,CAAC;YAEH,IAAI,OAAO,GAAG,KAAK,CAAC;YAEpB,MAAM,OAAO,GAAG,GAAG,EAAE,CAAC;gBACpB,OAAO,GAAG,IAAI,CAAC;gBAEf,IAAI,IAAI,CAAC,GAAG,KAAK,SAAS,EAAE,CAAC;oBAC3B,IAAA,gCAAe,EAAC,IAAI,CAAC,GAAG,CAAC,CAAC;oBAC1B,OAAO;gBACT,CAAC;gBAED,IAAI,CAAC;oBACH,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBACvB,CAAC;gBAAC,MAAM,CAAC;oBACP,SAAS;gBACX,CAAC;YAAA,CACF,CAAC;YAEF,WAAW,EAAE,gBAAgB,CAAC,OAAO,EAAE,OAAO,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;YAChE,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;gBACzB,OAAO,EAAE,CAAC;YACZ,CAAC;YAED,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,IAAY,EAAE,EAAE,CAAC;gBACvC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;YAAA,CACxC,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,IAAY,EAAE,EAAE,CAAC;gBACvC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;YAAA,CACxC,CAAC,CAAC;YAEH,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC;gBACzB,WAAW,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBAEnD,sCAAsC;gBACtC,OAAO,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;gBACvB,OAAO,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;gBAEvB,UAAU,CAAC,WAAW,CAAC,OAAO,IAAI,WAAW,EAAE,OAAO,CAAC,CAAC,CAAC,6BAAiB,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC,CAAC;gBAC1F,OAAO,EAAE,CAAC;YAAA,CACX,CAAC,CAAC;YAEH,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC;gBACxB,WAAW,EAAE,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;gBAEnD,IAAI,OAAO,IAAI,WAAW,EAAE,OAAO,EAAE,CAAC;oBACpC,UAAU,CAAC,WAAW,CAAC,6BAAiB,CAAC,CAAC;oBAC1C,OAAO,EAAE,CAAC;oBACV,OAAO;gBACT,CAAC;gBAED,UAAU,CAAC,SAAS,CAAC,4BAA4B,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC;gBAChE,UAAU,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC3B,OAAO,EAAE,CAAC;YAAA,CACX,CAAC,CAAC;QAAA,CACJ,CAAC,CAAC;IAAA,CACJ;CACF","sourcesContent":["import { spawn } from \"child_process\";\r\nimport * as fs from \"fs\";\r\nimport * as fsPromises from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport { Readable, Writable } from \"stream\";\r\n\r\nimport type {\r\n  Runtime,\r\n  ExecOptions,\r\n  ExecStream,\r\n  FileStat,\r\n  WorkspaceCreationParams,\r\n  WorkspaceCreationResult,\r\n  WorkspaceInitParams,\r\n  WorkspaceInitResult,\r\n  WorkspaceForkParams,\r\n  WorkspaceForkResult,\r\n  InitLogger,\r\n  EnsureReadyResult,\r\n} from \"./Runtime\";\r\nimport { RuntimeError as RuntimeErrorClass } from \"./Runtime\";\r\nimport { NON_INTERACTIVE_ENV_VARS } from \"@/common/constants/env\";\r\nimport { getBashPath } from \"@/node/utils/main/bashPath\";\r\nimport { shellQuote } from \"@/common/utils/shell\";\r\nimport { EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT } from \"@/common/constants/exitCodes\";\r\nimport { DisposableProcess, killProcessTree } from \"@/node/utils/disposableExec\";\r\nimport { expandTilde } from \"./tildeExpansion\";\r\nimport { getInitHookPath, createLineBufferedLoggers } from \"./initHook\";\r\n\r\n/**\r\n * Abstract base class for local runtimes (both WorktreeRuntime and LocalRuntime).\r\n *\r\n * Provides shared implementation for:\r\n * - exec() - Command execution with streaming I/O\r\n * - readFile() - File reading with streaming\r\n * - writeFile() - Atomic file writes with streaming\r\n * - stat() - File statistics\r\n * - resolvePath() - Path resolution with tilde expansion\r\n * - normalizePath() - Path normalization\r\n *\r\n * Subclasses must implement workspace-specific methods:\r\n * - getWorkspacePath()\r\n * - createWorkspace()\r\n * - initWorkspace()\r\n * - deleteWorkspace()\r\n * - renameWorkspace()\r\n * - forkWorkspace()\r\n */\r\nexport abstract class LocalBaseRuntime implements Runtime {\r\n  async exec(command: string, options: ExecOptions): Promise<ExecStream> {\r\n    const startTime = performance.now();\r\n\r\n    // Use the specified working directory (must be a specific workspace path)\r\n    const cwd = options.cwd;\r\n\r\n    // Check if working directory exists before spawning\r\n    // This prevents confusing ENOENT errors from spawn()\r\n    try {\r\n      await fsPromises.access(cwd);\r\n    } catch (err) {\r\n      throw new RuntimeErrorClass(\r\n        `Working directory does not exist: ${cwd}`,\r\n        \"exec\",\r\n        err instanceof Error ? err : undefined\r\n      );\r\n    }\r\n\r\n    const bashPath = getBashPath();\r\n    const spawnCommand = bashPath;\r\n\r\n    // Match RemoteRuntime behavior: ensure non-interactive env vars are set inside the shell.\r\n    //\r\n    // Why not rely solely on `env`?\r\n    // - On Windows, env var casing and shell startup state can be surprising.\r\n    // - These are non-sensitive vars that we want to guarantee for git/editor safety.\r\n    const nonInteractivePrelude = Object.entries(NON_INTERACTIVE_ENV_VARS)\r\n      .map(([key, value]) => `export ${key}=${shellQuote(value)}`)\r\n      .join(\"\\n\");\r\n\r\n    const spawnArgs = [\"-c\", `${nonInteractivePrelude}\\n${command}`];\r\n\r\n    const defaultPath = \"/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\";\r\n    const effectivePath =\r\n      (options.env?.PATH && options.env.PATH.length > 0 ? options.env.PATH : process.env.PATH) ??\r\n      defaultPath;\r\n\r\n    const childProcess = spawn(spawnCommand, spawnArgs, {\r\n      cwd,\r\n      env: {\r\n        ...process.env,\r\n        ...(options.env ?? {}),\r\n        ...NON_INTERACTIVE_ENV_VARS,\r\n        PATH: effectivePath,\r\n      },\r\n      stdio: [\"pipe\", \"pipe\", \"pipe\"],\r\n      // CRITICAL: Spawn as detached process group leader to enable cleanup of background processes.\r\n      // When a bash script spawns background processes (e.g., `sleep 100 &`), we need to kill\r\n      // the entire process group (including all backgrounded children) via process.kill(-pid).\r\n      // NOTE: detached:true does NOT cause bash to wait for background jobs when using 'exit' event\r\n      // instead of 'close' event. The 'exit' event fires when bash exits, ignoring background children.\r\n      detached: true,\r\n      // Prevent console window from appearing on Windows (WSL bash spawns steal focus otherwise)\r\n      windowsHide: true,\r\n    });\r\n\r\n    // Wrap in DisposableProcess for automatic cleanup\r\n    const disposable = new DisposableProcess(childProcess);\r\n\r\n    // Convert Node.js streams to Web Streams\r\n    const stdout = Readable.toWeb(childProcess.stdout) as unknown as ReadableStream<Uint8Array>;\r\n    const stderr = Readable.toWeb(childProcess.stderr) as unknown as ReadableStream<Uint8Array>;\r\n    const stdin = Writable.toWeb(childProcess.stdin) as unknown as WritableStream<Uint8Array>;\r\n\r\n    // No stream cleanup in DisposableProcess - streams close naturally when process exits\r\n    // bash.ts handles cleanup after waiting for exitCode\r\n\r\n    // Track if we killed the process due to timeout or abort\r\n    let timedOut = false;\r\n    let aborted = false;\r\n\r\n    // Create promises for exit code and duration\r\n    // Uses special exit codes (EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT) for expected error conditions\r\n    const exitCode = new Promise<number>((resolve, reject) => {\r\n      // Use 'exit' event instead of 'close' to handle background processes correctly.\r\n      // The 'close' event waits for ALL child processes (including background ones) to exit,\r\n      // which causes hangs when users spawn background processes like servers.\r\n      // The 'exit' event fires when the main bash process exits, which is what we want.\r\n      childProcess.on(\"exit\", (code) => {\r\n        // Clean up any background processes (process group cleanup)\r\n        // This prevents zombie processes when scripts spawn background tasks\r\n        if (childProcess.pid !== undefined) {\r\n          // Kill the full process tree to prevent hangs when scripts spawn background jobs.\r\n          //\r\n          // On Unix we can kill the whole group via process.kill(-pid).\r\n          // On Windows we must use taskkill to avoid leaking child processes.\r\n          killProcessTree(childProcess.pid);\r\n        }\r\n\r\n        // Check abort first (highest priority)\r\n        if (aborted || options.abortSignal?.aborted) {\r\n          resolve(EXIT_CODE_ABORTED);\r\n          return;\r\n        }\r\n        // Check if we killed the process due to timeout\r\n        if (timedOut) {\r\n          resolve(EXIT_CODE_TIMEOUT);\r\n          return;\r\n        }\r\n        resolve(code ?? 0);\r\n        // Cleanup runs automatically via DisposableProcess\r\n      });\r\n\r\n      childProcess.on(\"error\", (err) => {\r\n        reject(new RuntimeErrorClass(`Failed to execute command: ${err.message}`, \"exec\", err));\r\n      });\r\n    });\r\n\r\n    const duration = exitCode.then(() => performance.now() - startTime);\r\n\r\n    // Avoid unhandled promise rejections in fire-and-forget exec() callsites.\r\n    // Callers that await these promises will still observe the rejection.\r\n    void exitCode.catch(() => undefined);\r\n    void duration.catch(() => undefined);\r\n\r\n    // Register process group cleanup with DisposableProcess\r\n    // This ensures ALL background children are killed when process exits\r\n    disposable.addCleanup(() => {\r\n      if (childProcess.pid === undefined) return;\r\n\r\n      // Kill the full process tree (see comment in exit handler).\r\n      killProcessTree(childProcess.pid);\r\n    });\r\n\r\n    // Handle abort signal\r\n    if (options.abortSignal) {\r\n      options.abortSignal.addEventListener(\"abort\", () => {\r\n        aborted = true;\r\n        disposable[Symbol.dispose](); // Kill process and run cleanup\r\n      });\r\n    }\r\n\r\n    // Handle timeout\r\n    if (options.timeout !== undefined) {\r\n      const timeoutHandle = setTimeout(() => {\r\n        timedOut = true;\r\n        disposable[Symbol.dispose](); // Kill process and run cleanup\r\n      }, options.timeout * 1000);\r\n\r\n      // Clear timeout if process exits naturally\r\n      void exitCode.catch(() => undefined).finally(() => clearTimeout(timeoutHandle));\r\n    }\r\n\r\n    return { stdout, stderr, stdin, exitCode, duration };\r\n  }\r\n\r\n  readFile(filePath: string, _abortSignal?: AbortSignal): ReadableStream<Uint8Array> {\r\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\r\n    // Expand tildes before reading (Node.js fs doesn't expand ~)\r\n    const expandedPath = expandTilde(filePath);\r\n    const nodeStream = fs.createReadStream(expandedPath);\r\n\r\n    // Handle errors by wrapping in a transform\r\n    const webStream = Readable.toWeb(nodeStream) as unknown as ReadableStream<Uint8Array>;\r\n\r\n    return new ReadableStream<Uint8Array>({\r\n      async start(controller: ReadableStreamDefaultController<Uint8Array>) {\r\n        try {\r\n          const reader = webStream.getReader();\r\n          while (true) {\r\n            const { done, value } = await reader.read();\r\n            if (done) break;\r\n            controller.enqueue(value);\r\n          }\r\n          controller.close();\r\n        } catch (err) {\r\n          controller.error(\r\n            new RuntimeErrorClass(\r\n              `Failed to read file ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\r\n              \"file_io\",\r\n              err instanceof Error ? err : undefined\r\n            )\r\n          );\r\n        }\r\n      },\r\n    });\r\n  }\r\n\r\n  writeFile(filePath: string, _abortSignal?: AbortSignal): WritableStream<Uint8Array> {\r\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\r\n    // Expand tildes before writing (Node.js fs doesn't expand ~)\r\n    const expandedPath = expandTilde(filePath);\r\n    let tempPath: string;\r\n    let writer: WritableStreamDefaultWriter<Uint8Array>;\r\n    let resolvedPath: string;\r\n    let originalMode: number | undefined;\r\n\r\n    return new WritableStream<Uint8Array>({\r\n      async start() {\r\n        // Resolve symlinks to write through them (preserves the symlink)\r\n        try {\r\n          resolvedPath = await fsPromises.realpath(expandedPath);\r\n          // Save original permissions to restore after write\r\n          const stat = await fsPromises.stat(resolvedPath);\r\n          originalMode = stat.mode;\r\n        } catch {\r\n          // If file doesn't exist, use the expanded path and default permissions\r\n          resolvedPath = expandedPath;\r\n          originalMode = undefined;\r\n        }\r\n\r\n        // Create parent directories if they don't exist\r\n        const parentDir = path.dirname(resolvedPath);\r\n        await fsPromises.mkdir(parentDir, { recursive: true });\r\n\r\n        // Create temp file for atomic write\r\n        tempPath = `${resolvedPath}.tmp.${Date.now()}`;\r\n        const nodeStream = fs.createWriteStream(tempPath);\r\n        const webStream = Writable.toWeb(nodeStream) as WritableStream<Uint8Array>;\r\n        writer = webStream.getWriter();\r\n      },\r\n      async write(chunk: Uint8Array) {\r\n        await writer.write(chunk);\r\n      },\r\n      async close() {\r\n        // Close the writer and rename to final location\r\n        await writer.close();\r\n        try {\r\n          // If we have original permissions, apply them to temp file before rename\r\n          if (originalMode !== undefined) {\r\n            await fsPromises.chmod(tempPath, originalMode);\r\n          }\r\n          await fsPromises.rename(tempPath, resolvedPath);\r\n        } catch (err) {\r\n          throw new RuntimeErrorClass(\r\n            `Failed to write file ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\r\n            \"file_io\",\r\n            err instanceof Error ? err : undefined\r\n          );\r\n        }\r\n      },\r\n      async abort(reason?: unknown) {\r\n        // Clean up temp file on abort\r\n        await writer.abort();\r\n        try {\r\n          await fsPromises.unlink(tempPath);\r\n        } catch {\r\n          // Ignore errors cleaning up temp file\r\n        }\r\n        throw new RuntimeErrorClass(\r\n          `Failed to write file ${filePath}: ${String(reason)}`,\r\n          \"file_io\"\r\n        );\r\n      },\r\n    });\r\n  }\r\n\r\n  async stat(filePath: string, _abortSignal?: AbortSignal): Promise<FileStat> {\r\n    // Note: _abortSignal ignored for local operations (fast, no need for cancellation)\r\n    // Expand tildes before stat (Node.js fs doesn't expand ~)\r\n    const expandedPath = expandTilde(filePath);\r\n    try {\r\n      const stats = await fsPromises.stat(expandedPath);\r\n      return {\r\n        size: stats.size,\r\n        modifiedTime: stats.mtime,\r\n        isDirectory: stats.isDirectory(),\r\n      };\r\n    } catch (err) {\r\n      throw new RuntimeErrorClass(\r\n        `Failed to stat ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\r\n        \"file_io\",\r\n        err instanceof Error ? err : undefined\r\n      );\r\n    }\r\n  }\r\n\r\n  async ensureDir(dirPath: string): Promise<void> {\r\n    const expandedPath = expandTilde(dirPath);\r\n    try {\r\n      await fsPromises.mkdir(expandedPath, { recursive: true });\r\n    } catch (err) {\r\n      throw new RuntimeErrorClass(\r\n        `Failed to create directory ${dirPath}: ${err instanceof Error ? err.message : String(err)}`,\r\n        \"file_io\",\r\n        err instanceof Error ? err : undefined\r\n      );\r\n    }\r\n  }\r\n\r\n  resolvePath(filePath: string): Promise<string> {\r\n    // Expand tilde to actual home directory path\r\n    const expanded = expandTilde(filePath);\r\n\r\n    // Resolve to absolute path (handles relative paths like \"./foo\")\r\n    return Promise.resolve(path.resolve(expanded));\r\n  }\r\n\r\n  normalizePath(targetPath: string, basePath: string): string {\r\n    // For local runtime, use Node.js path resolution\r\n    // Handle special case: current directory\r\n    const target = targetPath.trim();\r\n    if (target === \".\") {\r\n      return path.resolve(basePath);\r\n    }\r\n    // Expand tildes before resolving (~ is not expanded by path.resolve)\r\n    const expanded = expandTilde(target);\r\n    return path.resolve(basePath, expanded);\r\n  }\r\n\r\n  // Abstract methods that subclasses must implement\r\n  abstract getWorkspacePath(projectPath: string, workspaceName: string): string;\r\n\r\n  abstract createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult>;\r\n\r\n  abstract initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult>;\r\n\r\n  abstract renameWorkspace(\r\n    projectPath: string,\r\n    oldName: string,\r\n    newName: string,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<\r\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\r\n  >;\r\n\r\n  abstract deleteWorkspace(\r\n    projectPath: string,\r\n    workspaceName: string,\r\n    force: boolean,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }>;\r\n\r\n  abstract forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult>;\r\n\r\n  /**\r\n   * Get the runtime's temp directory.\r\n   * Uses OS temp dir on local systems.\r\n   */\r\n  tempDir(): Promise<string> {\r\n    // Use /tmp on Unix, or OS temp dir on Windows\r\n    const isWindows = process.platform === \"win32\";\r\n    return Promise.resolve(isWindows ? (process.env.TEMP ?? \"C:\\\\Temp\") : \"/tmp\");\r\n  }\r\n\r\n  getMuxHome(): string {\r\n    return \"~/.mux\";\r\n  }\r\n\r\n  /**\r\n   * Local runtimes are always ready.\r\n   */\r\n  ensureReady(): Promise<EnsureReadyResult> {\r\n    return Promise.resolve({ ready: true });\r\n  }\r\n\r\n  /**\r\n   * Helper to run .mux/init hook if it exists and is executable.\r\n   * Shared between WorktreeRuntime and LocalRuntime.\r\n   * @param workspacePath - Path to the workspace directory\r\n   * @param muxEnv - MUX_ environment variables (from getMuxEnv)\r\n   * @param initLogger - Logger for streaming output\r\n   * @param abortSignal - Optional abort signal\r\n   */\r\n  protected async runInitHook(\r\n    workspacePath: string,\r\n    muxEnv: Record<string, string>,\r\n    initLogger: InitLogger,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<void> {\r\n    // Hook path is derived from MUX_PROJECT_PATH in muxEnv\r\n    const projectPath = muxEnv.MUX_PROJECT_PATH;\r\n    const hookPath = getInitHookPath(projectPath);\r\n    initLogger.logStep(`Running init hook: ${hookPath}`);\r\n\r\n    if (abortSignal?.aborted) {\r\n      initLogger.logComplete(EXIT_CODE_ABORTED);\r\n      return;\r\n    }\r\n\r\n    // Create line-buffered loggers\r\n    const loggers = createLineBufferedLoggers(initLogger);\r\n\r\n    return new Promise<void>((resolve) => {\r\n      const bashPath = getBashPath();\r\n      const proc = spawn(bashPath, [\"-c\", `\"${hookPath}\"`], {\r\n        cwd: workspacePath,\r\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\r\n        env: {\r\n          ...process.env,\r\n          ...muxEnv,\r\n        },\r\n        // Prevent console window from appearing on Windows\r\n        windowsHide: true,\r\n        // Spawn as a detached process group leader so we can reliably cancel the hook.\r\n        detached: true,\r\n      });\r\n\r\n      let aborted = false;\r\n\r\n      const onAbort = () => {\r\n        aborted = true;\r\n\r\n        if (proc.pid !== undefined) {\r\n          killProcessTree(proc.pid);\r\n          return;\r\n        }\r\n\r\n        try {\r\n          proc.kill(\"SIGKILL\");\r\n        } catch {\r\n          // ignore\r\n        }\r\n      };\r\n\r\n      abortSignal?.addEventListener(\"abort\", onAbort, { once: true });\r\n      if (abortSignal?.aborted) {\r\n        onAbort();\r\n      }\r\n\r\n      proc.stdout.on(\"data\", (data: Buffer) => {\r\n        loggers.stdout.append(data.toString());\r\n      });\r\n\r\n      proc.stderr.on(\"data\", (data: Buffer) => {\r\n        loggers.stderr.append(data.toString());\r\n      });\r\n\r\n      proc.on(\"close\", (code) => {\r\n        abortSignal?.removeEventListener(\"abort\", onAbort);\r\n\r\n        // Flush any remaining buffered output\r\n        loggers.stdout.flush();\r\n        loggers.stderr.flush();\r\n\r\n        initLogger.logComplete(aborted || abortSignal?.aborted ? EXIT_CODE_ABORTED : (code ?? 0));\r\n        resolve();\r\n      });\r\n\r\n      proc.on(\"error\", (err) => {\r\n        abortSignal?.removeEventListener(\"abort\", onAbort);\r\n\r\n        if (aborted || abortSignal?.aborted) {\r\n          initLogger.logComplete(EXIT_CODE_ABORTED);\r\n          resolve();\r\n          return;\r\n        }\r\n\r\n        initLogger.logStderr(`Error running init hook: ${err.message}`);\r\n        initLogger.logComplete(-1);\r\n        resolve();\r\n      });\r\n    });\r\n  }\r\n}\r\n"]}