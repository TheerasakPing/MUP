{"version":3,"file":"tildeExpansion.js","sourceRoot":"","sources":["../../../src/node/runtime/tildeExpansion.ts"],"names":[],"mappings":";AAAA;;;;;;;;GAQG;;;;;;;;AAEH,gDAAwB;AACxB,oDAAsD;AACtD,wDAAwD;AAExD;;;;;;;;;;;;;;;GAeG;AACH,qBAA4B,QAAgB,EAAU;IACpD,kFAAkF;IAClF,EAAE;IACF,uFAAuF;IACvF,+CAA+C;IAC/C,MAAM,WAAW,GAAG,CAAC,QAAQ,EAAE,SAAS,EAAE,SAAS,EAAE,UAAU,CAAU,CAAC;IAC1E,KAAK,MAAM,MAAM,IAAI,WAAW,EAAE,CAAC;QACjC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC;YACjC,SAAS;QACX,CAAC;QAED,MAAM,QAAQ,GAAG,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAC5C,IAAI,QAAQ,KAAK,SAAS,IAAI,QAAQ,KAAK,GAAG,IAAI,QAAQ,KAAK,IAAI,EAAE,CAAC;YACpE,SAAS;QACX,CAAC;QAED,MAAM,OAAO,GAAG,IAAA,kBAAU,GAAE,CAAC;QAC7B,MAAM,MAAM,GAAG,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;QACpE,MAAM,gBAAgB,GAAG,MAAM,CAAC,OAAO,CAAC,SAAS,EAAE,cAAI,CAAC,GAAG,CAAC,CAAC;QAC7D,OAAO,gBAAgB,CAAC,CAAC,CAAC,cAAI,CAAC,IAAI,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;IAC3E,CAAC;IAED,OAAO,0BAAa,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;AAAA,CAC3C;AAED;;;;;;;;;;;;;;;;;;GAkBG;AACH,2BAAkC,IAAY,EAAU;IACtD,IAAI,IAAI,KAAK,GAAG,EAAE,CAAC;QACjB,OAAO,SAAS,CAAC;IACnB,CAAC;SAAM,IAAI,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;QACjC,MAAM,cAAc,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QACrC,oDAAoD;QACpD,MAAM,OAAO,GAAG,cAAc;aAC3B,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC;aACtB,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC;aACpB,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC;aACrB,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACxB,OAAO,UAAU,OAAO,GAAG,CAAC;IAC9B,CAAC;SAAM,CAAC;QACN,kCAAkC;QAClC,mEAAmE;QACnE,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,GAAG,CAAC;IAC5G,CAAC;AAAA,CACF;AAED;;;;;;;;;;GAUG;AACH,yBAAgC,IAAY,EAAU;IACpD,OAAO,MAAM,iBAAiB,CAAC,IAAI,CAAC,EAAE,CAAC;AAAA,CACxC","sourcesContent":["/**\n * Utilities for handling tilde path expansion\n *\n * For SSH commands, tilde paths need special handling:\n * - Quoted tildes won't expand: `cd '~'` fails, but `cd \"$HOME\"` works\n * - Must escape special shell characters when using $HOME expansion\n *\n * For local paths, tildes should be expanded to actual file system paths.\n */\n\nimport path from \"path\";\nimport { getMuxHome } from \"@/common/constants/paths\";\nimport { PlatformPaths } from \"@/node/utils/paths.main\";\n\n/**\n * Expand tilde to actual home directory path for local file system operations.\n *\n * Converts:\n * - \"~\" → \"/home/user\" (actual home directory)\n * - \"~/path\" → \"/home/user/path\"\n * - \"/abs/path\" → \"/abs/path\" (unchanged)\n *\n * @param filePath - Path that may contain tilde prefix\n * @returns Fully expanded absolute path\n *\n * @example\n * expandTilde(\"~\")           // => \"/home/user\"\n * expandTilde(\"~/workspace\") // => \"/home/user/workspace\"\n * expandTilde(\"/abs/path\")   // => \"/abs/path\"\n */\nexport function expandTilde(filePath: string): string {\n  // Special-case mux's own default src dir path so it respects MUX_ROOT + NODE_ENV.\n  //\n  // DEFAULT_RUNTIME_CONFIG uses \"~/.mux/src\"; if we expand \"~\" to the OS home directory,\n  // we lose test isolation when MUX_ROOT is set.\n  const muxPrefixes = [\"~/.mux\", \"~\\\\.mux\", \"~/.cmux\", \"~\\\\.cmux\"] as const;\n  for (const prefix of muxPrefixes) {\n    if (!filePath.startsWith(prefix)) {\n      continue;\n    }\n\n    const nextChar = filePath.at(prefix.length);\n    if (nextChar !== undefined && nextChar !== \"/\" && nextChar !== \"\\\\\") {\n      continue;\n    }\n\n    const muxHome = getMuxHome();\n    const suffix = filePath.slice(prefix.length).replace(/^[/\\\\]+/, \"\");\n    const normalizedSuffix = suffix.replace(/[/\\\\]+/g, path.sep);\n    return normalizedSuffix ? path.join(muxHome, normalizedSuffix) : muxHome;\n  }\n\n  return PlatformPaths.expandHome(filePath);\n}\n\n/**\n * Expand tilde path to $HOME-based path for use in SSH commands.\n *\n * Converts:\n * - \"~\" → \"$HOME\"\n * - \"~/path\" → \"$HOME/path\"\n * - \"/abs/path\" → quoted absolute path (no expansion)\n *\n * The result is safe to use in bash commands and will properly expand at runtime.\n * Special characters in paths are escaped for use inside double quotes.\n *\n * @param path - Path that may contain tilde prefix\n * @returns Bash-safe string ready to use in commands\n *\n * @example\n * expandTildeForSSH(\"~\")           // => \"$HOME\"\n * expandTildeForSSH(\"~/workspace\") // => \"$HOME/workspace\"\n * expandTildeForSSH(\"/abs/path\")   // => '\"/abs/path\"'\n */\nexport function expandTildeForSSH(path: string): string {\n  if (path === \"~\") {\n    return '\"$HOME\"';\n  } else if (path.startsWith(\"~/\")) {\n    const pathAfterTilde = path.slice(2);\n    // Escape special chars for use inside double quotes\n    const escaped = pathAfterTilde\n      .replace(/\\\\/g, \"\\\\\\\\\")\n      .replace(/\"/g, '\\\\\"')\n      .replace(/\\$/g, \"\\\\$\")\n      .replace(/`/g, \"\\\\`\");\n    return `\"$HOME/${escaped}\"`;\n  } else {\n    // No tilde - quote the path as-is\n    // Note: We use double quotes to allow variable expansion if needed\n    return `\"${path.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"').replace(/\\$/g, \"\\\\$\").replace(/`/g, \"\\\\`\")}\"`;\n  }\n}\n\n/**\n * Generate a cd command for use in SSH exec, handling tilde paths correctly.\n *\n * @param path - Working directory path (may contain tilde)\n * @returns Bash command string like `cd \"$HOME/path\"`\n *\n * @example\n * cdCommandForSSH(\"~\")           // => 'cd \"$HOME\"'\n * cdCommandForSSH(\"~/workspace\") // => 'cd \"$HOME/workspace\"'\n * cdCommandForSSH(\"/abs/path\")   // => 'cd \"/abs/path\"'\n */\nexport function cdCommandForSSH(path: string): string {\n  return `cd ${expandTildeForSSH(path)}`;\n}\n"]}