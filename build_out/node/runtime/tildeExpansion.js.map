{"version":3,"file":"tildeExpansion.js","sourceRoot":"","sources":["../../../src/node/runtime/tildeExpansion.ts"],"names":[],"mappings":";AAAA;;;;;;;;GAQG;;;;;;;;AAEH,gDAAwB;AACxB,oDAAsD;AACtD,wDAAwD;AAExD;;;;;;;;;;;;;;;GAeG;AACH,qBAA4B,QAAgB,EAAU;IACpD,kFAAkF;IAClF,EAAE;IACF,uFAAuF;IACvF,+CAA+C;IAC/C,MAAM,WAAW,GAAG,CAAC,QAAQ,EAAE,SAAS,EAAE,SAAS,EAAE,UAAU,CAAU,CAAC;IAC1E,KAAK,MAAM,MAAM,IAAI,WAAW,EAAE,CAAC;QACjC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC;YACjC,SAAS;QACX,CAAC;QAED,MAAM,QAAQ,GAAG,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAC5C,IAAI,QAAQ,KAAK,SAAS,IAAI,QAAQ,KAAK,GAAG,IAAI,QAAQ,KAAK,IAAI,EAAE,CAAC;YACpE,SAAS;QACX,CAAC;QAED,MAAM,OAAO,GAAG,IAAA,kBAAU,GAAE,CAAC;QAC7B,MAAM,MAAM,GAAG,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;QACpE,MAAM,gBAAgB,GAAG,MAAM,CAAC,OAAO,CAAC,SAAS,EAAE,cAAI,CAAC,GAAG,CAAC,CAAC;QAC7D,OAAO,gBAAgB,CAAC,CAAC,CAAC,cAAI,CAAC,IAAI,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;IAC3E,CAAC;IAED,OAAO,0BAAa,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;AAAA,CAC3C;AAED;;;;;;;;;;;;;;;;;;GAkBG;AACH,2BAAkC,IAAY,EAAU;IACtD,IAAI,IAAI,KAAK,GAAG,EAAE,CAAC;QACjB,OAAO,SAAS,CAAC;IACnB,CAAC;SAAM,IAAI,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;QACjC,MAAM,cAAc,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QACrC,oDAAoD;QACpD,MAAM,OAAO,GAAG,cAAc;aAC3B,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC;aACtB,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC;aACpB,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC;aACrB,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACxB,OAAO,UAAU,OAAO,GAAG,CAAC;IAC9B,CAAC;SAAM,CAAC;QACN,kCAAkC;QAClC,mEAAmE;QACnE,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,GAAG,CAAC;IAC5G,CAAC;AAAA,CACF;AAED;;;;;;;;;;GAUG;AACH,yBAAgC,IAAY,EAAU;IACpD,OAAO,MAAM,iBAAiB,CAAC,IAAI,CAAC,EAAE,CAAC;AAAA,CACxC","sourcesContent":["/**\r\n * Utilities for handling tilde path expansion\r\n *\r\n * For SSH commands, tilde paths need special handling:\r\n * - Quoted tildes won't expand: `cd '~'` fails, but `cd \"$HOME\"` works\r\n * - Must escape special shell characters when using $HOME expansion\r\n *\r\n * For local paths, tildes should be expanded to actual file system paths.\r\n */\r\n\r\nimport path from \"path\";\r\nimport { getMuxHome } from \"@/common/constants/paths\";\r\nimport { PlatformPaths } from \"@/node/utils/paths.main\";\r\n\r\n/**\r\n * Expand tilde to actual home directory path for local file system operations.\r\n *\r\n * Converts:\r\n * - \"~\" → \"/home/user\" (actual home directory)\r\n * - \"~/path\" → \"/home/user/path\"\r\n * - \"/abs/path\" → \"/abs/path\" (unchanged)\r\n *\r\n * @param filePath - Path that may contain tilde prefix\r\n * @returns Fully expanded absolute path\r\n *\r\n * @example\r\n * expandTilde(\"~\")           // => \"/home/user\"\r\n * expandTilde(\"~/workspace\") // => \"/home/user/workspace\"\r\n * expandTilde(\"/abs/path\")   // => \"/abs/path\"\r\n */\r\nexport function expandTilde(filePath: string): string {\r\n  // Special-case mux's own default src dir path so it respects MUX_ROOT + NODE_ENV.\r\n  //\r\n  // DEFAULT_RUNTIME_CONFIG uses \"~/.mux/src\"; if we expand \"~\" to the OS home directory,\r\n  // we lose test isolation when MUX_ROOT is set.\r\n  const muxPrefixes = [\"~/.mux\", \"~\\\\.mux\", \"~/.cmux\", \"~\\\\.cmux\"] as const;\r\n  for (const prefix of muxPrefixes) {\r\n    if (!filePath.startsWith(prefix)) {\r\n      continue;\r\n    }\r\n\r\n    const nextChar = filePath.at(prefix.length);\r\n    if (nextChar !== undefined && nextChar !== \"/\" && nextChar !== \"\\\\\") {\r\n      continue;\r\n    }\r\n\r\n    const muxHome = getMuxHome();\r\n    const suffix = filePath.slice(prefix.length).replace(/^[/\\\\]+/, \"\");\r\n    const normalizedSuffix = suffix.replace(/[/\\\\]+/g, path.sep);\r\n    return normalizedSuffix ? path.join(muxHome, normalizedSuffix) : muxHome;\r\n  }\r\n\r\n  return PlatformPaths.expandHome(filePath);\r\n}\r\n\r\n/**\r\n * Expand tilde path to $HOME-based path for use in SSH commands.\r\n *\r\n * Converts:\r\n * - \"~\" → \"$HOME\"\r\n * - \"~/path\" → \"$HOME/path\"\r\n * - \"/abs/path\" → quoted absolute path (no expansion)\r\n *\r\n * The result is safe to use in bash commands and will properly expand at runtime.\r\n * Special characters in paths are escaped for use inside double quotes.\r\n *\r\n * @param path - Path that may contain tilde prefix\r\n * @returns Bash-safe string ready to use in commands\r\n *\r\n * @example\r\n * expandTildeForSSH(\"~\")           // => \"$HOME\"\r\n * expandTildeForSSH(\"~/workspace\") // => \"$HOME/workspace\"\r\n * expandTildeForSSH(\"/abs/path\")   // => '\"/abs/path\"'\r\n */\r\nexport function expandTildeForSSH(path: string): string {\r\n  if (path === \"~\") {\r\n    return '\"$HOME\"';\r\n  } else if (path.startsWith(\"~/\")) {\r\n    const pathAfterTilde = path.slice(2);\r\n    // Escape special chars for use inside double quotes\r\n    const escaped = pathAfterTilde\r\n      .replace(/\\\\/g, \"\\\\\\\\\")\r\n      .replace(/\"/g, '\\\\\"')\r\n      .replace(/\\$/g, \"\\\\$\")\r\n      .replace(/`/g, \"\\\\`\");\r\n    return `\"$HOME/${escaped}\"`;\r\n  } else {\r\n    // No tilde - quote the path as-is\r\n    // Note: We use double quotes to allow variable expansion if needed\r\n    return `\"${path.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"').replace(/\\$/g, \"\\\\$\").replace(/`/g, \"\\\\`\")}\"`;\r\n  }\r\n}\r\n\r\n/**\r\n * Generate a cd command for use in SSH exec, handling tilde paths correctly.\r\n *\r\n * @param path - Working directory path (may contain tilde)\r\n * @returns Bash command string like `cd \"$HOME/path\"`\r\n *\r\n * @example\r\n * cdCommandForSSH(\"~\")           // => 'cd \"$HOME\"'\r\n * cdCommandForSSH(\"~/workspace\") // => 'cd \"$HOME/workspace\"'\r\n * cdCommandForSSH(\"/abs/path\")   // => 'cd \"/abs/path\"'\r\n */\r\nexport function cdCommandForSSH(path: string): string {\r\n  return `cd ${expandTildeForSSH(path)}`;\r\n}\r\n"]}