{"version":3,"file":"RemoteRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/RemoteRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Abstract base class for remote execution runtimes (SSH, Docker).\n *\n * Provides shared implementation for:\n * - exec() with streaming I/O, timeout/abort handling\n * - readFile(), writeFile(), stat() via exec\n * - normalizePath() for POSIX paths\n * - tempDir() returning /tmp\n *\n * Subclasses implement:\n * - spawnRemoteProcess() - how to spawn the external process (ssh/docker)\n * - getBasePath() - base directory for workspace operations\n * - quoteForRemote() - path quoting strategy\n * - onExitCode() - optional exit code handling (SSH connection pool)\n */\n\nimport type { ChildProcess } from \"child_process\";\nimport { Readable } from \"stream\";\nimport type {\n  Runtime,\n  ExecOptions,\n  ExecStream,\n  FileStat,\n  WorkspaceCreationParams,\n  WorkspaceCreationResult,\n  WorkspaceInitParams,\n  WorkspaceInitResult,\n  WorkspaceForkParams,\n  WorkspaceForkResult,\n  EnsureReadyResult,\n} from \"./Runtime\";\nimport { RuntimeError } from \"./Runtime\";\nimport { EXIT_CODE_ABORTED, EXIT_CODE_TIMEOUT } from \"@/common/constants/exitCodes\";\nimport { log } from \"@/node/services/log\";\nimport { attachStreamErrorHandler } from \"@/node/utils/streamErrors\";\nimport { NON_INTERACTIVE_ENV_VARS } from \"@/common/constants/env\";\nimport { DisposableProcess } from \"@/node/utils/disposableExec\";\nimport { streamToString, shescape } from \"./streamUtils\";\n\n/**\n * Result from spawning a remote process.\n */\nexport interface SpawnResult {\n  /** The spawned child process */\n  process: ChildProcess;\n  /** Optional async work to do before exec (e.g., acquire connection) */\n  preExec?: Promise<void>;\n}\n\n/**\n * Abstract base class for remote execution runtimes.\n */\nexport abstract class RemoteRuntime implements Runtime {\n  /**\n   * Spawn the external process for command execution.\n   * SSH spawns `ssh`, Docker spawns `docker exec`.\n   *\n   * @param fullCommand The full shell command to execute (already wrapped in bash -c)\n   * @param options Original exec options\n   * @returns The spawned process and optional pre-exec work\n   */\n  protected abstract spawnRemoteProcess(\n    fullCommand: string,\n    options: ExecOptions\n  ): Promise<SpawnResult>;\n\n  /**\n   * Get the base path for file operations (used as cwd for file commands).\n   * SSH returns srcBaseDir, Docker returns /src.\n   */\n  protected abstract getBasePath(): string;\n\n  /**\n   * Quote a path for use in remote shell commands.\n   * SSH uses expandTildeForSSH (handles ~ expansion), Docker uses shescape.quote.\n   */\n  protected abstract quoteForRemote(path: string): string;\n\n  /**\n   * Build the cd command for the given cwd.\n   * SSH needs special handling for ~, Docker uses simple quoting.\n   */\n  protected abstract cdCommand(cwd: string): string;\n\n  /**\n   * Called when exec completes with an exit code.\n   * Subclasses can use this for connection pool health tracking.\n   * @param stderr - Captured stderr for error reporting (e.g., SSH connection failures)\n   */\n  protected onExitCode(_exitCode: number, _options: ExecOptions, _stderr: string): void {\n    // Default: no-op. SSH overrides to report to connection pool.\n  }\n\n  /**\n   * Command prefix (e.g., \"SSH\" or \"Docker\") for logging.\n   */\n  protected abstract readonly commandPrefix: string;\n\n  /**\n   * Execute command with streaming I/O.\n   * Shared implementation that delegates process spawning to subclass.\n   */\n  async exec(command: string, options: ExecOptions): Promise<ExecStream> {\n    const startTime = performance.now();\n\n    // Short-circuit if already aborted\n    if (options.abortSignal?.aborted) {\n      throw new RuntimeError(\"Operation aborted before execution\", \"exec\");\n    }\n\n    // Build command parts\n    const parts: string[] = [];\n\n    // Add cd command\n    parts.push(this.cdCommand(options.cwd));\n\n    // Add environment variable exports (user env first, then non-interactive overrides)\n    const envVars = { ...options.env, ...NON_INTERACTIVE_ENV_VARS };\n    for (const [key, value] of Object.entries(envVars)) {\n      parts.push(`export ${key}=${shescape.quote(value)}`);\n    }\n\n    // Add the actual command\n    parts.push(command);\n\n    // Join all parts with && to ensure each step succeeds before continuing\n    let fullCommand = parts.join(\" && \");\n\n    // Wrap in bash for consistent shell behavior\n    fullCommand = `bash -c ${shescape.quote(fullCommand)}`;\n\n    // Optionally wrap with timeout\n    if (options.timeout !== undefined) {\n      const remoteTimeout = Math.ceil(options.timeout) + 1;\n      fullCommand = `timeout -s KILL ${remoteTimeout} ${fullCommand}`;\n    }\n\n    // Spawn the remote process (SSH or Docker)\n    // For SSH, this awaits connection pool backoff before spawning\n    const { process: childProcess } = await this.spawnRemoteProcess(fullCommand, options);\n\n    // Short-lived commands can close stdin before writes/close complete.\n    if (childProcess.stdin) {\n      attachStreamErrorHandler(childProcess.stdin, `${this.commandPrefix} stdin`, {\n        logger: log,\n      });\n    }\n\n    // Wrap in DisposableProcess for cleanup\n    const disposable = new DisposableProcess(childProcess);\n\n    // Track if we killed the process due to timeout or abort\n    let timedOut = false;\n    let aborted = false;\n\n    // Declared here so it's captured by the exitCode promise closure,\n    // but the data listener is added AFTER Readable.toWeb() to avoid\n    // putting the stream in flowing mode prematurely.\n    let stderrForErrorReporting = \"\";\n\n    // Create promises for exit code and duration immediately.\n    const exitCode = new Promise<number>((resolve, reject) => {\n      childProcess.on(\"close\", (code, signal) => {\n        if (aborted || options.abortSignal?.aborted) {\n          resolve(EXIT_CODE_ABORTED);\n          return;\n        }\n        if (timedOut) {\n          resolve(EXIT_CODE_TIMEOUT);\n          return;\n        }\n        const finalExitCode = code ?? (signal ? -1 : 0);\n\n        // Let subclass handle exit code (e.g., SSH connection pool)\n        this.onExitCode(finalExitCode, options, stderrForErrorReporting);\n\n        resolve(finalExitCode);\n      });\n\n      childProcess.on(\"error\", (err) => {\n        reject(\n          new RuntimeError(\n            `Failed to execute ${this.commandPrefix} command: ${err.message}`,\n            \"exec\",\n            err\n          )\n        );\n      });\n    });\n\n    const duration = exitCode.then(() => performance.now() - startTime);\n\n    // Handle abort signal\n    if (options.abortSignal) {\n      const abortSignal = options.abortSignal;\n      const onAbort = () => {\n        aborted = true;\n\n        // For SSH/Docker, killing the local client too aggressively (SIGKILL) can leave the\n        // remote command running. Prefer SIGTERM first so the runtime can tear down cleanly,\n        // then hard-kill if it doesn't exit promptly.\n        //\n        // Note: SSH2's ChildProcess shim only sends a remote signal when an explicit signal\n        // string is provided, so always pass SIGTERM.\n        try {\n          childProcess.kill(\"SIGTERM\");\n        } catch {\n          // ignore\n        }\n\n        const hardKillHandle = setTimeout(() => {\n          const hasExited = childProcess.exitCode !== null || childProcess.signalCode !== null;\n          if (hasExited) {\n            return;\n          }\n          disposable[Symbol.dispose]();\n        }, 1000);\n        hardKillHandle.unref();\n      };\n\n      abortSignal.addEventListener(\"abort\", onAbort, { once: true });\n\n      // Avoid retaining closures on long-lived abort signals once the process exits.\n      void exitCode.finally(() => abortSignal.removeEventListener(\"abort\", onAbort));\n    }\n\n    // Handle timeout\n    if (options.timeout !== undefined) {\n      const timeoutHandle = setTimeout(() => {\n        timedOut = true;\n\n        try {\n          childProcess.kill(\"SIGTERM\");\n        } catch {\n          // ignore\n        }\n\n        const hardKillHandle = setTimeout(() => {\n          const hasExited = childProcess.exitCode !== null || childProcess.signalCode !== null;\n          if (hasExited) {\n            return;\n          }\n          disposable[Symbol.dispose]();\n        }, 1000);\n        hardKillHandle.unref();\n      }, options.timeout * 1000);\n\n      void exitCode.finally(() => clearTimeout(timeoutHandle));\n    }\n\n    // Convert Node.js streams to Web Streams\n    const stdout = Readable.toWeb(childProcess.stdout!) as unknown as ReadableStream<Uint8Array>;\n    const stderr = Readable.toWeb(childProcess.stderr!) as unknown as ReadableStream<Uint8Array>;\n\n    // Capture stderr for error reporting (e.g., SSH exit code 255 failures).\n    // Must be AFTER Readable.toWeb() to avoid putting the stream in flowing mode prematurely.\n    childProcess.stderr?.on(\"data\", (data: Buffer) => {\n      stderrForErrorReporting += data.toString();\n    });\n\n    // Writable.toWeb(childProcess.stdin) is surprisingly easy to get into an invalid state\n    // for short-lived remote commands (notably via SSH) where stdin may already be closed\n    // by the time callers attempt `await stream.stdin.close()`.\n    //\n    // Wrap stdin ourselves so close() is idempotent.\n    const stdin = new WritableStream<Uint8Array>({\n      write: async (chunk) => {\n        const nodeStdin = childProcess.stdin;\n        if (!nodeStdin || nodeStdin.destroyed) {\n          return;\n        }\n\n        await new Promise<void>((resolve, reject) => {\n          const onError = (err: Error) => {\n            nodeStdin.off(\"error\", onError);\n            reject(err);\n          };\n          nodeStdin.on(\"error\", onError);\n\n          nodeStdin.write(Buffer.from(chunk), (err) => {\n            nodeStdin.off(\"error\", onError);\n            if (err) {\n              reject(err);\n              return;\n            }\n            resolve();\n          });\n        });\n      },\n      close: async () => {\n        const nodeStdin = childProcess.stdin;\n        if (!nodeStdin || nodeStdin.destroyed || nodeStdin.writableEnded) {\n          return;\n        }\n\n        await new Promise<void>((resolve) => {\n          const onError = () => {\n            cleanup();\n            resolve();\n          };\n\n          const onFinish = () => {\n            cleanup();\n            resolve();\n          };\n\n          const cleanup = () => {\n            nodeStdin.removeListener(\"error\", onError);\n            nodeStdin.removeListener(\"finish\", onFinish);\n          };\n\n          nodeStdin.once(\"error\", onError);\n          nodeStdin.once(\"finish\", onFinish);\n\n          try {\n            nodeStdin.end();\n          } catch {\n            onError();\n          }\n        });\n      },\n      abort: () => {\n        childProcess.stdin?.destroy();\n      },\n    });\n\n    log.debug(`${this.commandPrefix} command: ${fullCommand}`);\n\n    return { stdout, stderr, stdin, exitCode, duration };\n  }\n\n  /**\n   * Read file contents as a stream via exec.\n   */\n  readFile(filePath: string, abortSignal?: AbortSignal): ReadableStream<Uint8Array> {\n    return new ReadableStream<Uint8Array>({\n      start: async (controller: ReadableStreamDefaultController<Uint8Array>) => {\n        try {\n          const stream = await this.exec(`cat ${this.quoteForRemote(filePath)}`, {\n            cwd: this.getBasePath(),\n            timeout: 300,\n            abortSignal,\n          });\n\n          const reader = stream.stdout.getReader();\n          const exitCodePromise = stream.exitCode;\n\n          while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n            controller.enqueue(value);\n          }\n\n          const code = await exitCodePromise;\n          if (code !== 0) {\n            const stderr = await streamToString(stream.stderr);\n            throw new RuntimeError(`Failed to read file ${filePath}: ${stderr}`, \"file_io\");\n          }\n\n          controller.close();\n        } catch (err) {\n          if (err instanceof RuntimeError) {\n            controller.error(err);\n          } else {\n            controller.error(\n              new RuntimeError(\n                `Failed to read file ${filePath}: ${err instanceof Error ? err.message : String(err)}`,\n                \"file_io\",\n                err instanceof Error ? err : undefined\n              )\n            );\n          }\n        }\n      },\n    });\n  }\n\n  /**\n   * Write file contents atomically via exec.\n   * Uses temp file + mv for atomic write.\n   */\n  writeFile(filePath: string, abortSignal?: AbortSignal): WritableStream<Uint8Array> {\n    const quotedPath = this.quoteForRemote(filePath);\n    const tempPath = `${filePath}.tmp.${Date.now()}`;\n    const quotedTempPath = this.quoteForRemote(tempPath);\n\n    // Build write command - subclasses can override buildWriteCommand for special handling\n    const writeCommand = this.buildWriteCommand(quotedPath, quotedTempPath);\n\n    let execPromise: Promise<ExecStream> | null = null;\n\n    const getExecStream = () => {\n      execPromise ??= this.exec(writeCommand, {\n        cwd: this.getBasePath(),\n        timeout: 300,\n        abortSignal,\n      });\n      return execPromise;\n    };\n\n    return new WritableStream<Uint8Array>({\n      write: async (chunk: Uint8Array) => {\n        const stream = await getExecStream();\n        const writer = stream.stdin.getWriter();\n        try {\n          await writer.write(chunk);\n        } finally {\n          writer.releaseLock();\n        }\n      },\n      close: async () => {\n        const stream = await getExecStream();\n        await stream.stdin.close();\n        const exitCode = await stream.exitCode;\n\n        if (exitCode !== 0) {\n          const stderr = await streamToString(stream.stderr);\n          throw new RuntimeError(`Failed to write file ${filePath}: ${stderr}`, \"file_io\");\n        }\n      },\n      abort: async (reason?: unknown) => {\n        const stream = await getExecStream();\n        await stream.stdin.abort();\n        throw new RuntimeError(`Failed to write file ${filePath}: ${String(reason)}`, \"file_io\");\n      },\n    });\n  }\n\n  /**\n   * Build the write command for atomic file writes.\n   * Can be overridden by subclasses for special handling (e.g., SSH symlink preservation).\n   */\n  protected buildWriteCommand(quotedPath: string, quotedTempPath: string): string {\n    return `mkdir -p $(dirname ${quotedPath}) && cat > ${quotedTempPath} && mv ${quotedTempPath} ${quotedPath}`;\n  }\n\n  /**\n   * Ensure a directory exists (mkdir -p semantics).\n   */\n  async ensureDir(dirPath: string): Promise<void> {\n    const stream = await this.exec(`mkdir -p ${this.quoteForRemote(dirPath)}`, {\n      cwd: \"/\",\n      timeout: 10,\n    });\n\n    await stream.stdin.close();\n\n    const [stdout, stderr, exitCode] = await Promise.all([\n      streamToString(stream.stdout),\n      streamToString(stream.stderr),\n      stream.exitCode,\n    ]);\n\n    if (exitCode !== 0) {\n      const extra = stderr.trim() || stdout.trim();\n      throw new RuntimeError(\n        `Failed to create directory ${dirPath}: exit code ${exitCode}${extra ? `: ${extra}` : \"\"}`,\n        \"file_io\"\n      );\n    }\n  }\n\n  /**\n   * Get file statistics via exec.\n   * Uses stat -L to follow symlinks (report target's type, not \"symbolic link\").\n   */\n  async stat(filePath: string, abortSignal?: AbortSignal): Promise<FileStat> {\n    const stream = await this.exec(`stat -L -c '%s %Y %F' ${this.quoteForRemote(filePath)}`, {\n      cwd: this.getBasePath(),\n      timeout: 10,\n      abortSignal,\n    });\n\n    const [stdout, stderr, exitCode] = await Promise.all([\n      streamToString(stream.stdout),\n      streamToString(stream.stderr),\n      stream.exitCode,\n    ]);\n\n    if (exitCode !== 0) {\n      throw new RuntimeError(`Failed to stat ${filePath}: ${stderr}`, \"file_io\");\n    }\n\n    const parts = stdout.trim().split(\" \");\n    if (parts.length < 3) {\n      throw new RuntimeError(`Failed to parse stat output for ${filePath}: ${stdout}`, \"file_io\");\n    }\n\n    const size = parseInt(parts[0], 10);\n    const mtime = parseInt(parts[1], 10);\n    const fileType = parts.slice(2).join(\" \");\n\n    return {\n      size,\n      modifiedTime: new Date(mtime * 1000),\n      isDirectory: fileType === \"directory\",\n    };\n  }\n\n  /**\n   * Normalize path for comparison (POSIX semantics).\n   * Shared between SSH and Docker.\n   */\n  normalizePath(targetPath: string, basePath: string): string {\n    const target = targetPath.trim();\n    let base = basePath.trim();\n\n    // Normalize base path - remove trailing slash (except for root \"/\")\n    if (base.length > 1 && base.endsWith(\"/\")) {\n      base = base.slice(0, -1);\n    }\n\n    // Handle special case: current directory\n    if (target === \".\") {\n      return base;\n    }\n\n    // Handle absolute paths and tilde\n    if (target.startsWith(\"/\") || target === \"~\" || target.startsWith(\"~/\")) {\n      let normalizedTarget = target;\n      // Remove trailing slash for comparison (except for root \"/\")\n      if (normalizedTarget.length > 1 && normalizedTarget.endsWith(\"/\")) {\n        normalizedTarget = normalizedTarget.slice(0, -1);\n      }\n      return normalizedTarget;\n    }\n\n    // Relative path - resolve against base\n    const normalizedTarget = base.endsWith(\"/\") ? base + target : base + \"/\" + target;\n\n    // Remove trailing slash\n    if (normalizedTarget.length > 1 && normalizedTarget.endsWith(\"/\")) {\n      return normalizedTarget.slice(0, -1);\n    }\n\n    return normalizedTarget;\n  }\n\n  /**\n   * Return /tmp as the temp directory for remote runtimes.\n   */\n  tempDir(): Promise<string> {\n    return Promise.resolve(\"/tmp\");\n  }\n\n  getMuxHome(): string {\n    return \"~/.mux\";\n  }\n\n  // Abstract methods that subclasses must implement\n\n  /**\n   * Remote runtimes are always ready (SSH connections are re-established as needed).\n   * Subclasses (CoderSSHRuntime, DockerRuntime) may override for provisioning checks.\n   */\n  ensureReady(): Promise<EnsureReadyResult> {\n    return Promise.resolve({ ready: true });\n  }\n\n  abstract resolvePath(path: string): Promise<string>;\n  abstract getWorkspacePath(projectPath: string, workspaceName: string): string;\n  abstract createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult>;\n  abstract initWorkspace(params: WorkspaceInitParams): Promise<WorkspaceInitResult>;\n  abstract renameWorkspace(\n    projectPath: string,\n    oldName: string,\n    newName: string,\n    abortSignal?: AbortSignal\n  ): Promise<\n    { success: true; oldPath: string; newPath: string } | { success: false; error: string }\n  >;\n  abstract deleteWorkspace(\n    projectPath: string,\n    workspaceName: string,\n    force: boolean,\n    abortSignal?: AbortSignal\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }>;\n  abstract forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult>;\n}\n"]}