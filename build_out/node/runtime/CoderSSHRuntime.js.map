{"version":3,"file":"CoderSSHRuntime.js","sourceRoot":"","sources":["../../../src/node/runtime/CoderSSHRuntime.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * CoderSSHRuntime - SSH runtime wrapper for Coder workspaces.\r\n *\r\n * Extends SSHRuntime to add Coder-specific provisioning via postCreateSetup():\r\n * - Creates Coder workspace (if not connecting to existing)\r\n * - Runs `coder config-ssh --yes` to set up SSH proxy\r\n *\r\n * This ensures mux workspace metadata is persisted before the long-running\r\n * Coder build starts, allowing build logs to stream to init logs (like Docker).\r\n */\r\n\r\nimport type {\r\n  RuntimeCreateFlags,\r\n  WorkspaceCreationParams,\r\n  WorkspaceCreationResult,\r\n  WorkspaceForkParams,\r\n  WorkspaceForkResult,\r\n  WorkspaceInitParams,\r\n  EnsureReadyOptions,\r\n  EnsureReadyResult,\r\n  RuntimeStatusEvent,\r\n} from \"./Runtime\";\r\nimport { SSHRuntime, type SSHRuntimeConfig } from \"./SSHRuntime\";\r\nimport type { SSHTransport } from \"./transports\";\r\nimport type { CoderWorkspaceConfig, RuntimeConfig } from \"@/common/types/runtime\";\r\nimport { isSSHRuntime } from \"@/common/types/runtime\";\r\nimport type { CoderService } from \"@/node/services/coderService\";\r\nimport type { Result } from \"@/common/types/result\";\r\nimport { Ok, Err } from \"@/common/types/result\";\r\nimport { log } from \"@/node/services/log\";\r\nimport { execBuffered } from \"@/node/utils/runtime/helpers\";\r\nimport { expandTildeForSSH } from \"./tildeExpansion\";\r\nimport * as path from \"path\";\r\n\r\nexport interface CoderSSHRuntimeConfig extends SSHRuntimeConfig {\r\n  /** Coder-specific configuration */\r\n  coder: CoderWorkspaceConfig;\r\n}\r\n\r\n/**\r\n * Coder workspace name regex: ^[a-zA-Z0-9]+(?:-[a-zA-Z0-9]+)*$\r\n * - Must start with alphanumeric\r\n * - Can contain hyphens, but only between alphanumeric segments\r\n * - No underscores (unlike mux workspace names)\r\n */\r\nconst CODER_NAME_REGEX = /^[a-zA-Z0-9]+(?:-[a-zA-Z0-9]+)*$/;\r\n\r\n/**\r\n * Transform a mux workspace name to be Coder-compatible.\r\n * - Replace underscores with hyphens\r\n * - Remove leading/trailing hyphens\r\n * - Collapse multiple consecutive hyphens\r\n */\r\nfunction toCoderCompatibleName(name: string): string {\r\n  return name\r\n    .replace(/_/g, \"-\") // Replace underscores with hyphens\r\n    .replace(/^-+|-+$/g, \"\") // Remove leading/trailing hyphens\r\n    .replace(/-{2,}/g, \"-\"); // Collapse multiple hyphens\r\n}\r\n\r\nconst CODER_INACTIVITY_THRESHOLD_MS = 5 * 60 * 1000;\r\nconst CODER_ENSURE_READY_TIMEOUT_MS = 120_000;\r\nconst CODER_STATUS_POLL_INTERVAL_MS = 2_000;\r\n\r\n/**\r\n * SSH runtime that handles Coder workspace provisioning.\r\n *\r\n * IMPORTANT: This extends SSHRuntime (rather than delegating) so other backend\r\n * code that checks `runtime instanceof SSHRuntime` (PTY, tools, path handling)\r\n * continues to behave correctly for Coder workspaces.\r\n */\r\nexport class CoderSSHRuntime extends SSHRuntime {\r\n  private coderConfig: CoderWorkspaceConfig;\r\n  private readonly coderService: CoderService;\r\n\r\n  /**\r\n   * Timestamp of last time we (a) successfully used the runtime or (b) decided not\r\n   * to block the user (unknown Coder CLI error).\r\n   * Used to avoid running expensive status checks on every message while still\r\n   * catching auto-stopped workspaces after long inactivity.\r\n   */\r\n  private lastActivityAtMs = 0;\r\n\r\n  /**\r\n   * Flags for WorkspaceService to customize create flow:\r\n   * - deferredRuntimeAccess: skip srcBaseDir resolution (Coder host doesn't exist yet)\r\n   * - configLevelCollisionDetection: use config-based collision check (can't reach host)\r\n   */\r\n  readonly createFlags: RuntimeCreateFlags = {\r\n    deferredRuntimeAccess: true,\r\n    configLevelCollisionDetection: true,\r\n  };\r\n\r\n  constructor(\r\n    config: CoderSSHRuntimeConfig,\r\n    transport: SSHTransport,\r\n    coderService: CoderService,\r\n    options?: {\r\n      projectPath?: string;\r\n      workspaceName?: string;\r\n    }\r\n  ) {\r\n    if (!config || !coderService || !transport) {\r\n      throw new Error(\"CoderSSHRuntime requires config, transport, and coderService\");\r\n    }\r\n\r\n    const baseConfig: SSHRuntimeConfig = {\r\n      host: config.host,\r\n      srcBaseDir: config.srcBaseDir,\r\n      bgOutputDir: config.bgOutputDir,\r\n      identityFile: config.identityFile,\r\n      port: config.port,\r\n    };\r\n\r\n    super(baseConfig, transport, options);\r\n    this.coderConfig = config.coder;\r\n    this.coderService = coderService;\r\n  }\r\n\r\n  /** In-flight ensureReady promise to avoid duplicate start/wait sequences */\r\n  private ensureReadyPromise: Promise<EnsureReadyResult> | null = null;\r\n\r\n  /**\r\n   * Check if runtime is ready for use.\r\n   *\r\n   * Behavior:\r\n   * - If creation failed during postCreateSetup(), fail fast.\r\n   * - If workspace is running: return ready.\r\n   * - If workspace is stopped: auto-start and wait (blocking, ~120s timeout).\r\n   * - If workspace is stopping: poll until stopped, then start.\r\n   * - Emits runtime-status events via statusSink for UX feedback.\r\n   *\r\n   * Concurrency: shares an in-flight promise to avoid duplicate start sequences.\r\n   */\r\n  override async ensureReady(options?: EnsureReadyOptions): Promise<EnsureReadyResult> {\r\n    const workspaceName = this.coderConfig.workspaceName;\r\n    if (!workspaceName) {\r\n      return {\r\n        ready: false,\r\n        error: \"Coder workspace name not set\",\r\n        errorType: \"runtime_not_ready\",\r\n      };\r\n    }\r\n\r\n    const now = Date.now();\r\n\r\n    // Fast path: recently active, skip expensive status check\r\n    if (\r\n      this.lastActivityAtMs !== 0 &&\r\n      now - this.lastActivityAtMs < CODER_INACTIVITY_THRESHOLD_MS\r\n    ) {\r\n      return { ready: true };\r\n    }\r\n\r\n    // Avoid duplicate concurrent start/wait sequences\r\n    if (this.ensureReadyPromise) {\r\n      return this.ensureReadyPromise;\r\n    }\r\n\r\n    this.ensureReadyPromise = this.doEnsureReady(workspaceName, options);\r\n    try {\r\n      return await this.ensureReadyPromise;\r\n    } finally {\r\n      this.ensureReadyPromise = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Core ensureReady logic - called once (protected by ensureReadyPromise).\r\n   *\r\n   * Flow:\r\n   * 1. Check status via `coder list` - short-circuit for \"running\" or \"not_found\"\r\n   * 2. If \"stopping\"/\"canceling\": poll until it clears (coder ssh can't autostart during these)\r\n   * 3. Run `coder ssh --wait=yes -- true` which handles everything else:\r\n   *    - stopped: auto-starts, streams build logs, waits for startup scripts\r\n   *    - starting/pending: waits for build completion + startup scripts\r\n   */\r\n  private async doEnsureReady(\r\n    workspaceName: string,\r\n    options?: EnsureReadyOptions\r\n  ): Promise<EnsureReadyResult> {\r\n    const statusSink = options?.statusSink;\r\n    const signal = options?.signal;\r\n    const startTime = Date.now();\r\n\r\n    const emitStatus = (phase: RuntimeStatusEvent[\"phase\"], detail?: string) => {\r\n      statusSink?.({ phase, runtimeType: \"ssh\", detail });\r\n    };\r\n\r\n    // Helper: check if we've exceeded overall timeout\r\n    const isTimedOut = () => Date.now() - startTime > CODER_ENSURE_READY_TIMEOUT_MS;\r\n    const remainingMs = () => Math.max(0, CODER_ENSURE_READY_TIMEOUT_MS - (Date.now() - startTime));\r\n\r\n    // Step 1: Check current status for short-circuits\r\n    emitStatus(\"checking\");\r\n\r\n    if (signal?.aborted) {\r\n      emitStatus(\"error\");\r\n      return { ready: false, error: \"Aborted\", errorType: \"runtime_start_failed\" };\r\n    }\r\n\r\n    let statusResult = await this.coderService.getWorkspaceStatus(workspaceName, {\r\n      timeoutMs: Math.min(remainingMs(), 10_000),\r\n      signal,\r\n    });\r\n\r\n    // Short-circuit: already running\r\n    if (statusResult.kind === \"ok\" && statusResult.status === \"running\") {\r\n      const repoCheck = await this.checkWorkspaceRepo(options);\r\n      if (repoCheck && !repoCheck.ready) {\r\n        emitStatus(\"error\", repoCheck.error);\r\n        return repoCheck;\r\n      }\r\n\r\n      this.lastActivityAtMs = Date.now();\r\n      emitStatus(\"ready\");\r\n      return { ready: true };\r\n    }\r\n\r\n    // Short-circuit: workspace doesn't exist\r\n    if (statusResult.kind === \"not_found\") {\r\n      emitStatus(\"error\");\r\n      return {\r\n        ready: false,\r\n        error: `Coder workspace \"${workspaceName}\" not found`,\r\n        errorType: \"runtime_not_ready\",\r\n      };\r\n    }\r\n\r\n    // For status check errors (timeout, auth issues), proceed optimistically\r\n    // and let SSH fail naturally to avoid blocking the happy path\r\n    if (statusResult.kind === \"error\") {\r\n      if (signal?.aborted) {\r\n        emitStatus(\"error\");\r\n        return { ready: false, error: \"Aborted\", errorType: \"runtime_start_failed\" };\r\n      }\r\n      log.debug(\"Coder workspace status unknown, proceeding optimistically\", {\r\n        workspaceName,\r\n        error: statusResult.error,\r\n      });\r\n    }\r\n\r\n    // Step 2: Wait for \"stopping\"/\"canceling\" to clear (coder ssh can't autostart during these)\r\n    if (\r\n      statusResult.kind === \"ok\" &&\r\n      (statusResult.status === \"stopping\" || statusResult.status === \"canceling\")\r\n    ) {\r\n      emitStatus(\"waiting\", \"Waiting for Coder workspace to stop...\");\r\n\r\n      while (\r\n        statusResult.kind === \"ok\" &&\r\n        (statusResult.status === \"stopping\" || statusResult.status === \"canceling\") &&\r\n        !isTimedOut()\r\n      ) {\r\n        if (signal?.aborted) {\r\n          emitStatus(\"error\");\r\n          return { ready: false, error: \"Aborted\", errorType: \"runtime_start_failed\" };\r\n        }\r\n\r\n        await this.sleep(CODER_STATUS_POLL_INTERVAL_MS, signal);\r\n        statusResult = await this.coderService.getWorkspaceStatus(workspaceName, {\r\n          timeoutMs: Math.min(remainingMs(), 10_000),\r\n          signal,\r\n        });\r\n\r\n        // Check for state changes during polling\r\n        if (statusResult.kind === \"ok\" && statusResult.status === \"running\") {\r\n          // Ensure setup failures (missing repo) surface before marking ready.\r\n          const repoCheck = await this.checkWorkspaceRepo(options);\r\n          if (repoCheck && !repoCheck.ready) {\r\n            emitStatus(\"error\", repoCheck.error);\r\n            return repoCheck;\r\n          }\r\n\r\n          this.lastActivityAtMs = Date.now();\r\n          emitStatus(\"ready\");\r\n          return { ready: true };\r\n        }\r\n        if (statusResult.kind === \"not_found\") {\r\n          emitStatus(\"error\");\r\n          return {\r\n            ready: false,\r\n            error: `Coder workspace \"${workspaceName}\" not found`,\r\n            errorType: \"runtime_not_ready\",\r\n          };\r\n        }\r\n      }\r\n\r\n      if (isTimedOut()) {\r\n        emitStatus(\"error\");\r\n        return {\r\n          ready: false,\r\n          error: \"Coder workspace is still stopping... Please retry shortly.\",\r\n          errorType: \"runtime_start_failed\",\r\n        };\r\n      }\r\n    }\r\n\r\n    // Step 3: Use coder ssh --wait=yes to handle all other states\r\n    // This auto-starts stopped workspaces and waits for startup scripts\r\n    emitStatus(\"starting\", \"Connecting to Coder workspace...\");\r\n    log.debug(\"Connecting to Coder workspace via SSH\", { workspaceName });\r\n\r\n    // Create abort signal that fires on timeout or user abort\r\n    const controller = new AbortController();\r\n\r\n    const checkInterval = setInterval(() => {\r\n      if (isTimedOut() || signal?.aborted) {\r\n        controller.abort();\r\n        clearInterval(checkInterval);\r\n      }\r\n    }, 1000);\r\n    controller.signal.addEventListener(\"abort\", () => clearInterval(checkInterval), {\r\n      once: true,\r\n    });\r\n    if (isTimedOut() || signal?.aborted) controller.abort();\r\n\r\n    try {\r\n      for await (const _line of this.coderService.waitForStartupScripts(\r\n        workspaceName,\r\n        controller.signal\r\n      )) {\r\n        // Consume output for timeout/abort handling\r\n      }\r\n\r\n      const repoCheck = await this.checkWorkspaceRepo(options);\r\n      if (repoCheck && !repoCheck.ready) {\r\n        emitStatus(\"error\", repoCheck.error);\r\n        return repoCheck;\r\n      }\r\n\r\n      this.lastActivityAtMs = Date.now();\r\n      emitStatus(\"ready\");\r\n      return { ready: true };\r\n    } catch (error) {\r\n      const errorMsg = error instanceof Error ? error.message : String(error);\r\n\r\n      emitStatus(\"error\");\r\n\r\n      if (isTimedOut()) {\r\n        return {\r\n          ready: false,\r\n          error: \"Coder workspace start timed out\",\r\n          errorType: \"runtime_start_failed\",\r\n        };\r\n      }\r\n\r\n      if (signal?.aborted) {\r\n        return { ready: false, error: \"Aborted\", errorType: \"runtime_start_failed\" };\r\n      }\r\n\r\n      // Map \"not found\" errors to runtime_not_ready\r\n      if (/not found|no access/i.test(errorMsg)) {\r\n        return {\r\n          ready: false,\r\n          error: `Coder workspace \"${workspaceName}\" not found`,\r\n          errorType: \"runtime_not_ready\",\r\n        };\r\n      }\r\n\r\n      return {\r\n        ready: false,\r\n        error: `Failed to connect to Coder workspace: ${errorMsg}`,\r\n        errorType: \"runtime_start_failed\",\r\n      };\r\n    } finally {\r\n      clearInterval(checkInterval);\r\n    }\r\n  }\r\n\r\n  /** Promise-based sleep helper */\r\n  private sleep(ms: number, abortSignal?: AbortSignal): Promise<void> {\r\n    if (abortSignal?.aborted) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    return new Promise((resolve) => {\r\n      const timeout = setTimeout(() => {\r\n        abortSignal?.removeEventListener(\"abort\", onAbort);\r\n        resolve();\r\n      }, ms);\r\n\r\n      const onAbort = () => {\r\n        clearTimeout(timeout);\r\n        abortSignal?.removeEventListener(\"abort\", onAbort);\r\n        resolve();\r\n      };\r\n\r\n      abortSignal?.addEventListener(\"abort\", onAbort, { once: true });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Finalize runtime config after collision handling.\r\n   * Derives Coder workspace name from branch name and computes SSH host.\r\n   */\r\n  async finalizeConfig(\r\n    finalBranchName: string,\r\n    config: RuntimeConfig\r\n  ): Promise<Result<RuntimeConfig, string>> {\r\n    if (!isSSHRuntime(config) || !config.coder) {\r\n      return Ok(config);\r\n    }\r\n\r\n    const coder = config.coder;\r\n    let workspaceName = coder.workspaceName?.trim() ?? \"\";\r\n\r\n    if (!coder.existingWorkspace) {\r\n      // New workspace: derive name from mux workspace name if not provided\r\n      if (!workspaceName) {\r\n        workspaceName = `mux-${finalBranchName}`;\r\n      }\r\n      // Transform to Coder-compatible name (handles underscores, etc.)\r\n      workspaceName = toCoderCompatibleName(workspaceName);\r\n\r\n      // Validate against Coder's regex\r\n      if (!CODER_NAME_REGEX.test(workspaceName)) {\r\n        return Err(\r\n          `Workspace name \"${finalBranchName}\" cannot be converted to a valid Coder name. ` +\r\n            `Use only letters, numbers, and hyphens.`\r\n        );\r\n      }\r\n    } else {\r\n      // Existing workspace: name must be provided (selected from dropdown)\r\n      if (!workspaceName) {\r\n        return Err(\"Coder workspace name is required for existing workspaces\");\r\n      }\r\n    }\r\n\r\n    // Final validation\r\n    if (!workspaceName) {\r\n      return Err(\"Coder workspace name is required\");\r\n    }\r\n\r\n    let hostnameSuffix: string;\r\n    try {\r\n      // Keep a provisioning session around for new workspaces so we can reuse the same token\r\n      // when fetching template parameters during postCreateSetup.\r\n      const session = coder.existingWorkspace\r\n        ? undefined\r\n        : await this.coderService.ensureProvisioningSession(workspaceName);\r\n      const sshConfig = await this.coderService.fetchDeploymentSshConfig(session);\r\n      hostnameSuffix = sshConfig.hostnameSuffix;\r\n    } catch (error) {\r\n      if (!coder.existingWorkspace) {\r\n        await this.coderService.disposeProvisioningSession(workspaceName);\r\n      }\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      return Err(\r\n        `Failed to read Coder deployment SSH config. ` +\r\n          `Make sure you're logged in with the Coder CLI. ` +\r\n          `(${message})`\r\n      );\r\n    }\r\n\r\n    return Ok({\r\n      ...config,\r\n      host: `${workspaceName}.${hostnameSuffix}`,\r\n      coder: { ...coder, workspaceName },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate before persisting workspace metadata.\r\n   * Checks if a Coder workspace with this name already exists.\r\n   */\r\n  async validateBeforePersist(\r\n    _finalBranchName: string,\r\n    config: RuntimeConfig\r\n  ): Promise<Result<void, string>> {\r\n    if (!isSSHRuntime(config) || !config.coder) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    // Skip for \"existing\" mode - user explicitly selected an existing workspace\r\n    if (config.coder.existingWorkspace) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    const workspaceName = config.coder.workspaceName;\r\n    if (!workspaceName) {\r\n      return Ok(undefined);\r\n    }\r\n\r\n    const exists = await this.coderService.workspaceExists(workspaceName);\r\n\r\n    if (exists) {\r\n      await this.coderService.disposeProvisioningSession(workspaceName);\r\n      return Err(\r\n        `A Coder workspace named \"${workspaceName}\" already exists. ` +\r\n          `Either switch to \"Existing\" mode to use it, delete/rename it in Coder, ` +\r\n          `or choose a different mux workspace name.`\r\n      );\r\n    }\r\n\r\n    return Ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Create workspace (fast path only - no SSH needed).\r\n   * The Coder workspace may not exist yet, so we can't reach the SSH host.\r\n   * Just compute the workspace path locally.\r\n   */\r\n  override createWorkspace(params: WorkspaceCreationParams): Promise<WorkspaceCreationResult> {\r\n    const workspacePath = this.getWorkspacePath(params.projectPath, params.directoryName);\r\n\r\n    params.initLogger.logStep(\"Workspace path computed (Coder provisioning will follow)\");\r\n\r\n    return Promise.resolve({\r\n      success: true,\r\n      workspacePath,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete workspace: removes SSH files AND deletes Coder workspace (if Mux-managed).\r\n   *\r\n   * IMPORTANT: Only delete the Coder workspace once we're confident mux will commit\r\n   * the deletion. In the non-force path, WorkspaceService.remove() aborts and keeps\r\n   * workspace metadata when runtime.deleteWorkspace() fails.\r\n   */\r\n  override async deleteWorkspace(\r\n    projectPath: string,\r\n    workspaceName: string,\r\n    force: boolean,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<{ success: true; deletedPath: string } | { success: false; error: string }> {\r\n    // Deleting a Coder workspace is dangerous; CoderService refuses to delete workspaces\r\n    // without the mux- prefix to avoid accidentally deleting user-owned Coder workspaces.\r\n\r\n    // If this workspace is an existing Coder workspace that mux didn't create, just do SSH cleanup.\r\n    if (this.coderConfig.existingWorkspace) {\r\n      return super.deleteWorkspace(projectPath, workspaceName, force, abortSignal);\r\n    }\r\n\r\n    const coderWorkspaceName = this.coderConfig.workspaceName;\r\n\r\n    if (!coderWorkspaceName) {\r\n      log.warn(\"Coder workspace name not set, falling back to SSH-only deletion\");\r\n      return super.deleteWorkspace(projectPath, workspaceName, force, abortSignal);\r\n    }\r\n\r\n    // For force deletes (\"cancel creation\"), skip SSH cleanup and focus on deleting the\r\n    // underlying Coder workspace. During provisioning, the SSH host may not be reachable yet.\r\n    if (force) {\r\n      const deleteResult = await this.coderService.deleteWorkspaceEventually(coderWorkspaceName, {\r\n        timeoutMs: 60_000,\r\n        signal: abortSignal,\r\n        // Avoid races where coder create finishes server-side after we abort the local CLI.\r\n        waitForExistence: true,\r\n        // If the workspace never appears on the server within 10s, assume it was never created\r\n        // and return early instead of waiting the full 60s timeout.\r\n        waitForExistenceTimeoutMs: 10_000,\r\n      });\r\n\r\n      if (!deleteResult.success) {\r\n        return { success: false, error: `Failed to delete Coder workspace: ${deleteResult.error}` };\r\n      }\r\n\r\n      return { success: true, deletedPath: this.getWorkspacePath(projectPath, workspaceName) };\r\n    }\r\n\r\n    // Check if Coder workspace still exists before attempting SSH operations.\r\n    // If it's already gone, skip SSH cleanup (would hang trying to connect to non-existent host).\r\n    const statusResult = await this.coderService.getWorkspaceStatus(coderWorkspaceName);\r\n    if (statusResult.kind === \"not_found\") {\r\n      log.debug(\"Coder workspace already deleted, skipping SSH cleanup\", { coderWorkspaceName });\r\n      return { success: true, deletedPath: this.getWorkspacePath(projectPath, workspaceName) };\r\n    }\r\n    if (statusResult.kind === \"error\") {\r\n      // API errors (auth, network): fall through to SSH cleanup, let it fail naturally\r\n      log.warn(\"Could not check Coder workspace status, proceeding with SSH cleanup\", {\r\n        coderWorkspaceName,\r\n        error: statusResult.error,\r\n      });\r\n    }\r\n    if (statusResult.kind === \"ok\") {\r\n      // If the workspace is stopped, avoid SSH entirely.\r\n      //\r\n      // IMPORTANT tradeoff: This intentionally skips the dirty/unpushed checks performed by\r\n      // SSHRuntime.deleteWorkspace(). Any SSH connection can auto-start a stopped Coder\r\n      // workspace, which is surprising during deletion.\r\n      if (statusResult.status === \"stopped\") {\r\n        if (abortSignal?.aborted && !force) {\r\n          return { success: false, error: \"Delete operation aborted\" };\r\n        }\r\n\r\n        try {\r\n          log.debug(\"Coder workspace is stopped; deleting without SSH cleanup\", {\r\n            coderWorkspaceName,\r\n          });\r\n          const deleteResult = await this.coderService.deleteWorkspaceEventually(\r\n            coderWorkspaceName,\r\n            {\r\n              timeoutMs: 60_000,\r\n              signal: abortSignal,\r\n              waitForExistence: false,\r\n            }\r\n          );\r\n\r\n          if (!deleteResult.success) {\r\n            return {\r\n              success: false,\r\n              error: `Failed to delete Coder workspace: ${deleteResult.error}`,\r\n            };\r\n          }\r\n\r\n          return {\r\n            success: true,\r\n            deletedPath: this.getWorkspacePath(projectPath, workspaceName),\r\n          };\r\n        } catch (error) {\r\n          const message = error instanceof Error ? error.message : String(error);\r\n          log.error(\"Failed to delete stopped Coder workspace\", {\r\n            coderWorkspaceName,\r\n            error: message,\r\n          });\r\n          return { success: false, error: `Failed to delete Coder workspace: ${message}` };\r\n        }\r\n      }\r\n\r\n      // Workspace is being deleted or already deleted - skip SSH (would hang connecting to dying host)\r\n      if (statusResult.status === \"deleted\" || statusResult.status === \"deleting\") {\r\n        log.debug(\"Coder workspace is deleted/deleting, skipping SSH cleanup\", {\r\n          coderWorkspaceName,\r\n          status: statusResult.status,\r\n        });\r\n        return { success: true, deletedPath: this.getWorkspacePath(projectPath, workspaceName) };\r\n      }\r\n    }\r\n\r\n    const sshResult = await super.deleteWorkspace(projectPath, workspaceName, force, abortSignal);\r\n\r\n    // In the normal (force=false) delete path, only delete the Coder workspace if the SSH delete\r\n    // succeeded. If SSH delete failed (e.g., dirty workspace), WorkspaceService.remove() keeps the\r\n    // workspace metadata and the user can retry.\r\n    if (!sshResult.success && !force) {\r\n      return sshResult;\r\n    }\r\n\r\n    try {\r\n      log.debug(`Deleting Coder workspace \"${coderWorkspaceName}\"`);\r\n      const deleteResult = await this.coderService.deleteWorkspaceEventually(coderWorkspaceName, {\r\n        timeoutMs: 60_000,\r\n        signal: abortSignal,\r\n        waitForExistence: false,\r\n      });\r\n\r\n      if (!deleteResult.success) {\r\n        throw new Error(deleteResult.error);\r\n      }\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      log.error(\"Failed to delete Coder workspace\", {\r\n        coderWorkspaceName,\r\n        error: message,\r\n      });\r\n\r\n      if (sshResult.success) {\r\n        return {\r\n          success: false,\r\n          error: `SSH delete succeeded, but failed to delete Coder workspace: ${message}`,\r\n        };\r\n      }\r\n\r\n      return {\r\n        success: false,\r\n        error: `SSH delete failed: ${sshResult.error}; Coder delete also failed: ${message}`,\r\n      };\r\n    }\r\n\r\n    return sshResult;\r\n  }\r\n\r\n  /**\r\n   * Fork workspace: delegates to SSHRuntime, but marks both source and fork\r\n   * as existingWorkspace=true so neither can delete the shared Coder workspace.\r\n   *\r\n   * IMPORTANT: Also updates this instance's coderConfig so that if postCreateSetup\r\n   * runs on this same runtime instance (for the forked workspace), it won't attempt\r\n   * to create a new Coder workspace.\r\n   */\r\n  override async forkWorkspace(params: WorkspaceForkParams): Promise<WorkspaceForkResult> {\r\n    const result = await super.forkWorkspace(params);\r\n    // Coder tasks must share the parent's VM - don't fall back to creating a new one\r\n    if (!result.success) return { ...result, failureIsFatal: true };\r\n\r\n    // Both workspaces now share the Coder workspace - mark as existing so\r\n    // deleting either mux workspace won't destroy the underlying Coder workspace\r\n    const sharedCoderConfig = { ...this.coderConfig, existingWorkspace: true };\r\n\r\n    // Update this instance's config so postCreateSetup() skips coder create\r\n    this.coderConfig = sharedCoderConfig;\r\n\r\n    const sshConfig = this.getConfig();\r\n    const sharedRuntimeConfig = { type: \"ssh\" as const, ...sshConfig, coder: sharedCoderConfig };\r\n\r\n    return {\r\n      ...result,\r\n      forkedRuntimeConfig: sharedRuntimeConfig,\r\n      sourceRuntimeConfig: sharedRuntimeConfig,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Post-create setup: provision Coder workspace and configure SSH.\r\n   * This runs after mux persists workspace metadata, so build logs stream to UI.\r\n   */\r\n  async postCreateSetup(params: WorkspaceInitParams): Promise<void> {\r\n    const { initLogger, abortSignal } = params;\r\n\r\n    // Create Coder workspace if not connecting to an existing one\r\n    if (!this.coderConfig.existingWorkspace) {\r\n      // Validate required fields (workspaceName is set by finalizeConfig during workspace creation)\r\n      const coderWorkspaceName = this.coderConfig.workspaceName;\r\n      if (!coderWorkspaceName) {\r\n        throw new Error(\"Coder workspace name is required (should be set by finalizeConfig)\");\r\n      }\r\n      if (!this.coderConfig.template) {\r\n        await this.coderService.disposeProvisioningSession(coderWorkspaceName);\r\n        throw new Error(\"Coder template is required for new workspaces\");\r\n      }\r\n\r\n      initLogger.logStep(`Creating Coder workspace \"${coderWorkspaceName}\"...`);\r\n\r\n      const provisioningSession = this.coderService.takeProvisioningSession(coderWorkspaceName);\r\n\r\n      try {\r\n        for await (const line of this.coderService.createWorkspace(\r\n          coderWorkspaceName,\r\n          this.coderConfig.template,\r\n          this.coderConfig.preset,\r\n          abortSignal,\r\n          this.coderConfig.templateOrg,\r\n          provisioningSession\r\n        )) {\r\n          initLogger.logStdout(line);\r\n        }\r\n        initLogger.logStep(\"Coder workspace created successfully\");\r\n\r\n        // Wait for startup scripts to complete\r\n        initLogger.logStep(\"Waiting for startup scripts...\");\r\n        for await (const line of this.coderService.waitForStartupScripts(\r\n          coderWorkspaceName,\r\n          abortSignal\r\n        )) {\r\n          initLogger.logStdout(line);\r\n        }\r\n      } catch (error) {\r\n        const errorMsg = error instanceof Error ? error.message : String(error);\r\n        log.error(\"Failed to create Coder workspace\", { error, config: this.coderConfig });\r\n        initLogger.logStderr(`Failed to create Coder workspace: ${errorMsg}`);\r\n        throw new Error(`Failed to create Coder workspace: ${errorMsg}`);\r\n      } finally {\r\n        if (provisioningSession) {\r\n          await provisioningSession.dispose();\r\n        }\r\n      }\r\n    } else if (this.coderConfig.workspaceName) {\r\n      // For existing workspaces, wait for \"stopping\"/\"canceling\" to clear before SSH\r\n      // (coder ssh --wait=yes can't autostart while a stop/cancel build is in progress)\r\n      const workspaceName = this.coderConfig.workspaceName;\r\n      let status = await this.coderService.getWorkspaceStatus(workspaceName, {\r\n        signal: abortSignal,\r\n      });\r\n\r\n      if (status.kind === \"ok\" && (status.status === \"stopping\" || status.status === \"canceling\")) {\r\n        initLogger.logStep(`Waiting for Coder workspace \"${workspaceName}\" to stop...`);\r\n        while (\r\n          status.kind === \"ok\" &&\r\n          (status.status === \"stopping\" || status.status === \"canceling\")\r\n        ) {\r\n          if (abortSignal?.aborted) {\r\n            throw new Error(\"Aborted while waiting for Coder workspace to stop\");\r\n          }\r\n          await this.sleep(CODER_STATUS_POLL_INTERVAL_MS, abortSignal);\r\n          status = await this.coderService.getWorkspaceStatus(workspaceName, {\r\n            signal: abortSignal,\r\n          });\r\n        }\r\n      }\r\n\r\n      // waitForStartupScripts (coder ssh --wait=yes) handles all other states:\r\n      // - stopped: auto-starts, streams build logs, waits for scripts\r\n      // - starting/pending: waits for build + scripts\r\n      // - running: waits for scripts (fast if already done)\r\n      initLogger.logStep(`Connecting to Coder workspace \"${workspaceName}\"...`);\r\n      try {\r\n        for await (const line of this.coderService.waitForStartupScripts(\r\n          workspaceName,\r\n          abortSignal\r\n        )) {\r\n          initLogger.logStdout(line);\r\n        }\r\n      } catch (error) {\r\n        const errorMsg = error instanceof Error ? error.message : String(error);\r\n        log.error(\"Failed waiting for Coder workspace\", { error, config: this.coderConfig });\r\n        initLogger.logStderr(`Failed connecting to Coder workspace: ${errorMsg}`);\r\n        throw new Error(`Failed connecting to Coder workspace: ${errorMsg}`);\r\n      }\r\n    }\r\n\r\n    // Ensure SSH config is set up for Coder workspaces\r\n    initLogger.logStep(\"Configuring SSH for Coder...\");\r\n    try {\r\n      await this.coderService.ensureSSHConfig();\r\n    } catch (error) {\r\n      const errorMsg = error instanceof Error ? error.message : String(error);\r\n      log.error(\"Failed to configure SSH for Coder\", { error });\r\n      initLogger.logStderr(`Failed to configure SSH: ${errorMsg}`);\r\n      throw new Error(`Failed to configure SSH for Coder: ${errorMsg}`);\r\n    }\r\n\r\n    // Create parent directory for workspace (git clone won't create it)\r\n    // This must happen after ensureSSHConfig() so SSH is configured\r\n    initLogger.logStep(\"Preparing workspace directory...\");\r\n    const parentDir = path.posix.dirname(params.workspacePath);\r\n    const mkdirResult = await execBuffered(this, `mkdir -p ${expandTildeForSSH(parentDir)}`, {\r\n      cwd: \"/tmp\",\r\n      timeout: 10,\r\n      abortSignal,\r\n    });\r\n    if (mkdirResult.exitCode !== 0) {\r\n      const errorMsg = mkdirResult.stderr || mkdirResult.stdout || \"Unknown error\";\r\n      log.error(\"Failed to create workspace parent directory\", { parentDir, error: errorMsg });\r\n      initLogger.logStderr(`Failed to prepare workspace directory: ${errorMsg}`);\r\n      throw new Error(`Failed to prepare workspace directory: ${errorMsg}`);\r\n    }\r\n\r\n    this.lastActivityAtMs = Date.now();\r\n  }\r\n}\r\n"]}