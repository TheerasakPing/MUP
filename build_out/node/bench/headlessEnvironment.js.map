{"version":3,"file":"headlessEnvironment.js","sourceRoot":"","sources":["../../../src/node/bench/headlessEnvironment.ts"],"names":[],"mappings":"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","sourcesContent":["import * as os from \"os\";\nimport * as path from \"path\";\nimport * as fs from \"fs/promises\";\nimport createIPCMock from \"electron-mock-ipc\";\nimport type { BrowserWindow, IpcMain as ElectronIpcMain, WebContents } from \"electron\";\nimport { Config } from \"@/node/config\";\nimport { ServiceContainer } from \"@/node/services/serviceContainer\";\n\ntype MockedElectron = ReturnType<typeof createIPCMock>;\n\ninterface CreateHeadlessEnvironmentOptions {\n  /**\n   * Override the root directory for Config. If omitted, a temporary directory is created.\n   */\n  rootDir?: string;\n}\n\nexport interface HeadlessEnvironment {\n  config: Config;\n  services: ServiceContainer;\n  mockIpcMain: ElectronIpcMain;\n  mockIpcRenderer: Electron.IpcRenderer;\n  mockWindow: BrowserWindow;\n  sentEvents: Array<{ channel: string; data: unknown }>;\n  rootDir: string;\n  dispose: () => Promise<void>;\n}\n\nfunction createMockBrowserWindow(): {\n  window: BrowserWindow;\n  sentEvents: Array<{ channel: string; data: unknown }>;\n} {\n  const sentEvents: Array<{ channel: string; data: unknown }> = [];\n\n  const mockWindow = {\n    webContents: {\n      send: (channel: string, data: unknown) => {\n        sentEvents.push({ channel, data });\n      },\n      openDevTools: () => {\n        throw new Error(\"openDevTools is not supported in headless mode\");\n      },\n    } as unknown as WebContents,\n    isMinimized: () => false,\n    restore: () => undefined,\n    focus: () => undefined,\n    loadURL: () => {\n      throw new Error(\"loadURL should not be called in headless mode\");\n    },\n    on: () => undefined,\n    setTitle: () => undefined,\n  } as unknown as BrowserWindow;\n\n  return { window: mockWindow, sentEvents };\n}\n\nasync function establishRootDir(providedRootDir?: string): Promise<{\n  rootDir: string;\n  dispose: () => Promise<void>;\n}> {\n  if (providedRootDir) {\n    return {\n      rootDir: providedRootDir,\n      dispose: async () => {\n        // Caller owns the directory; nothing to clean up.\n      },\n    };\n  }\n\n  const tempRoot = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-headless-\"));\n  return {\n    rootDir: tempRoot,\n    dispose: async () => {\n      await fs.rm(tempRoot, { recursive: true, force: true });\n    },\n  };\n}\n\nfunction assertMockedElectron(mocked: MockedElectron): void {\n  if (!mocked || typeof mocked !== \"object\") {\n    throw new Error(\"Failed to initialize electron-mock-ipc\");\n  }\n\n  if (!(\"ipcMain\" in mocked) || !mocked.ipcMain) {\n    throw new Error(\"electron-mock-ipc returned an invalid ipcMain\");\n  }\n\n  if (!(\"ipcRenderer\" in mocked) || !mocked.ipcRenderer) {\n    throw new Error(\"electron-mock-ipc returned an invalid ipcRenderer\");\n  }\n}\n\nexport async function createHeadlessEnvironment(\n  options: CreateHeadlessEnvironmentOptions = {}\n): Promise<HeadlessEnvironment> {\n  const { rootDir, dispose: disposeRootDir } = await establishRootDir(options.rootDir);\n\n  const config = new Config(rootDir);\n\n  const { window: mockWindow, sentEvents } = createMockBrowserWindow();\n\n  const mockedElectron = createIPCMock();\n  assertMockedElectron(mockedElectron);\n  const mockIpcMainModule = mockedElectron.ipcMain;\n  const mockIpcRendererModule = mockedElectron.ipcRenderer;\n\n  const services = new ServiceContainer(config);\n  await services.initialize();\n  services.windowService.setMainWindow(mockWindow);\n\n  const dispose = async () => {\n    sentEvents.length = 0;\n    await disposeRootDir();\n  };\n\n  return {\n    config,\n    services,\n    mockIpcMain: mockIpcMainModule,\n    mockIpcRenderer: mockIpcRendererModule,\n    mockWindow,\n    sentEvents,\n    rootDir,\n    dispose,\n  };\n}\n"]}