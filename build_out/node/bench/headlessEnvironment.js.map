{"version":3,"file":"headlessEnvironment.js","sourceRoot":"","sources":["../../../src/node/bench/headlessEnvironment.ts"],"names":[],"mappings":"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","sourcesContent":["import * as os from \"os\";\r\nimport * as path from \"path\";\r\nimport * as fs from \"fs/promises\";\r\nimport createIPCMock from \"electron-mock-ipc\";\r\nimport type { BrowserWindow, IpcMain as ElectronIpcMain, WebContents } from \"electron\";\r\nimport { Config } from \"@/node/config\";\r\nimport { ServiceContainer } from \"@/node/services/serviceContainer\";\r\n\r\ntype MockedElectron = ReturnType<typeof createIPCMock>;\r\n\r\ninterface CreateHeadlessEnvironmentOptions {\r\n  /**\r\n   * Override the root directory for Config. If omitted, a temporary directory is created.\r\n   */\r\n  rootDir?: string;\r\n}\r\n\r\nexport interface HeadlessEnvironment {\r\n  config: Config;\r\n  services: ServiceContainer;\r\n  mockIpcMain: ElectronIpcMain;\r\n  mockIpcRenderer: Electron.IpcRenderer;\r\n  mockWindow: BrowserWindow;\r\n  sentEvents: Array<{ channel: string; data: unknown }>;\r\n  rootDir: string;\r\n  dispose: () => Promise<void>;\r\n}\r\n\r\nfunction createMockBrowserWindow(): {\r\n  window: BrowserWindow;\r\n  sentEvents: Array<{ channel: string; data: unknown }>;\r\n} {\r\n  const sentEvents: Array<{ channel: string; data: unknown }> = [];\r\n\r\n  const mockWindow = {\r\n    webContents: {\r\n      send: (channel: string, data: unknown) => {\r\n        sentEvents.push({ channel, data });\r\n      },\r\n      openDevTools: () => {\r\n        throw new Error(\"openDevTools is not supported in headless mode\");\r\n      },\r\n    } as unknown as WebContents,\r\n    isMinimized: () => false,\r\n    restore: () => undefined,\r\n    focus: () => undefined,\r\n    loadURL: () => {\r\n      throw new Error(\"loadURL should not be called in headless mode\");\r\n    },\r\n    on: () => undefined,\r\n    setTitle: () => undefined,\r\n  } as unknown as BrowserWindow;\r\n\r\n  return { window: mockWindow, sentEvents };\r\n}\r\n\r\nasync function establishRootDir(providedRootDir?: string): Promise<{\r\n  rootDir: string;\r\n  dispose: () => Promise<void>;\r\n}> {\r\n  if (providedRootDir) {\r\n    return {\r\n      rootDir: providedRootDir,\r\n      dispose: async () => {\r\n        // Caller owns the directory; nothing to clean up.\r\n      },\r\n    };\r\n  }\r\n\r\n  const tempRoot = await fs.mkdtemp(path.join(os.tmpdir(), \"mux-headless-\"));\r\n  return {\r\n    rootDir: tempRoot,\r\n    dispose: async () => {\r\n      await fs.rm(tempRoot, { recursive: true, force: true });\r\n    },\r\n  };\r\n}\r\n\r\nfunction assertMockedElectron(mocked: MockedElectron): void {\r\n  if (!mocked || typeof mocked !== \"object\") {\r\n    throw new Error(\"Failed to initialize electron-mock-ipc\");\r\n  }\r\n\r\n  if (!(\"ipcMain\" in mocked) || !mocked.ipcMain) {\r\n    throw new Error(\"electron-mock-ipc returned an invalid ipcMain\");\r\n  }\r\n\r\n  if (!(\"ipcRenderer\" in mocked) || !mocked.ipcRenderer) {\r\n    throw new Error(\"electron-mock-ipc returned an invalid ipcRenderer\");\r\n  }\r\n}\r\n\r\nexport async function createHeadlessEnvironment(\r\n  options: CreateHeadlessEnvironmentOptions = {}\r\n): Promise<HeadlessEnvironment> {\r\n  const { rootDir, dispose: disposeRootDir } = await establishRootDir(options.rootDir);\r\n\r\n  const config = new Config(rootDir);\r\n\r\n  const { window: mockWindow, sentEvents } = createMockBrowserWindow();\r\n\r\n  const mockedElectron = createIPCMock();\r\n  assertMockedElectron(mockedElectron);\r\n  const mockIpcMainModule = mockedElectron.ipcMain;\r\n  const mockIpcRendererModule = mockedElectron.ipcRenderer;\r\n\r\n  const services = new ServiceContainer(config);\r\n  await services.initialize();\r\n  services.windowService.setMainWindow(mockWindow);\r\n\r\n  const dispose = async () => {\r\n    sentEvents.length = 0;\r\n    await disposeRootDir();\r\n  };\r\n\r\n  return {\r\n    config,\r\n    services,\r\n    mockIpcMain: mockIpcMainModule,\r\n    mockIpcRenderer: mockIpcRendererModule,\r\n    mockWindow,\r\n    sentEvents,\r\n    rootDir,\r\n    dispose,\r\n  };\r\n}\r\n"]}