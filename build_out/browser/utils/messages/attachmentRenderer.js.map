{"version":3,"file":"attachmentRenderer.js","sourceRoot":"","sources":["../../../../src/browser/utils/messages/attachmentRenderer.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  PostCompactionAttachment,\n  PlanFileReferenceAttachment,\n  TodoListAttachment,\n  EditedFilesReferenceAttachment,\n} from \"@/common/types/attachment\";\nimport { renderTodoItemsAsMarkdownList } from \"@/common/utils/todoList\";\n\nconst SYSTEM_UPDATE_OPEN = \"<system-update>\\n\";\nconst SYSTEM_UPDATE_CLOSE = \"\\n</system-update>\";\n\nfunction wrapSystemUpdate(content: string): string {\n  return `${SYSTEM_UPDATE_OPEN}${content}${SYSTEM_UPDATE_CLOSE}`;\n}\n\n/**\n * Render a plan file reference attachment to content string.\n */\nfunction renderPlanFileReference(attachment: PlanFileReferenceAttachment): string {\n  return `A plan file exists from plan mode at: ${attachment.planFilePath}\n\nPlan contents:\n${attachment.planContent}\n\nIf this plan is relevant to the current work and not already complete, continue working on it.`;\n}\n\n/**\n * Render a todo list attachment to a content string.\n */\nfunction renderTodoListAttachment(attachment: TodoListAttachment): string {\n  const items = renderTodoItemsAsMarkdownList(attachment.todos);\n  return `TODO list (persisted; \\`todo_read\\` will return this):\\n${items || \"- (empty)\"}`;\n}\n\n/**\n * Render an edited files reference attachment to content string.\n */\nfunction renderEditedFilesReference(attachment: EditedFilesReferenceAttachment): string {\n  const fileEntries = attachment.files\n    .map((file) => {\n      const truncationNote = file.truncated ? \" (truncated)\" : \"\";\n      return `File: ${file.path}${truncationNote}\n\\`\\`\\`diff\n${file.diff}\n\\`\\`\\``;\n    })\n    .join(\"\\n\\n\");\n\n  return `The following files were edited in this session:\n\n${fileEntries}`;\n}\n\n/**\n * Render a single post-compaction attachment to its content string.\n */\nexport function renderAttachmentToContent(attachment: PostCompactionAttachment): string {\n  switch (attachment.type) {\n    case \"plan_file_reference\":\n      return renderPlanFileReference(attachment);\n    case \"todo_list\":\n      return renderTodoListAttachment(attachment);\n    case \"edited_files_reference\":\n      return renderEditedFilesReference(attachment);\n  }\n}\n\n/**\n * Render multiple post-compaction attachments to a single content string.\n * Each attachment is wrapped in a <system-update> tag.\n */\nexport function renderAttachmentsToContent(attachments: PostCompactionAttachment[]): string {\n  return attachments.map((att) => wrapSystemUpdate(renderAttachmentToContent(att))).join(\"\\n\");\n}\n\nconst PLAN_TRUNCATION_NOTE = \"\\n\\n...(truncated)\\n\";\n\nfunction renderPlanFileReferenceWithBudget(\n  attachment: PlanFileReferenceAttachment,\n  maxChars: number\n): string | null {\n  if (maxChars <= 0) {\n    return null;\n  }\n\n  const prefix = `A plan file exists from plan mode at: ${attachment.planFilePath}\\n\\nPlan contents:\\n`;\n  const suffix =\n    \"\\n\\nIf this plan is relevant to the current work and not already complete, continue working on it.\";\n\n  const availableForContent = maxChars - prefix.length - suffix.length;\n  if (availableForContent <= 0) {\n    const minimal = `A plan file exists from plan mode at: ${attachment.planFilePath}`;\n    return minimal.length <= maxChars ? minimal : null;\n  }\n\n  let planContent = attachment.planContent;\n  if (planContent.length > availableForContent) {\n    const sliceLength = Math.max(0, availableForContent - PLAN_TRUNCATION_NOTE.length);\n    planContent = `${planContent.slice(0, sliceLength)}${PLAN_TRUNCATION_NOTE}`;\n  }\n\n  return `${prefix}${planContent}${suffix}`;\n}\n\nfunction renderEditedFilesReferenceWithBudget(\n  attachment: EditedFilesReferenceAttachment,\n  maxChars: number\n): { content: string | null; omittedFiles: number } {\n  const header = \"The following files were edited in this session:\\n\\n\";\n\n  if (maxChars <= header.length) {\n    return { content: null, omittedFiles: attachment.files.length };\n  }\n\n  const entries: string[] = [];\n  let used = header.length;\n\n  for (const file of attachment.files) {\n    const truncationNote = file.truncated ? \" (truncated)\" : \"\";\n    const entry = `File: ${file.path}${truncationNote}\\n\\`\\`\\`diff\\n${file.diff}\\n\\`\\`\\``;\n    const separator = entries.length > 0 ? \"\\n\\n\" : \"\";\n    const nextLen = used + separator.length + entry.length;\n\n    if (nextLen > maxChars) {\n      break;\n    }\n\n    entries.push(entry);\n    used = nextLen;\n  }\n\n  const included = entries.length;\n  const omittedFiles = attachment.files.length - included;\n\n  if (included === 0) {\n    return { content: null, omittedFiles: attachment.files.length };\n  }\n\n  return {\n    content: `${header}${entries.join(\"\\n\\n\")}`,\n    omittedFiles,\n  };\n}\n\nfunction sortAttachmentsForInjection(\n  attachments: PostCompactionAttachment[]\n): PostCompactionAttachment[] {\n  const priority: Record<PostCompactionAttachment[\"type\"], number> = {\n    plan_file_reference: 0,\n    todo_list: 1,\n    edited_files_reference: 2,\n  };\n\n  return attachments\n    .map((att, index) => ({ att, index }))\n    .sort((a, b) => {\n      const diff = priority[a.att.type] - priority[b.att.type];\n      return diff !== 0 ? diff : a.index - b.index;\n    })\n    .map((item) => item.att);\n}\n\nexport function renderAttachmentsToContentWithBudget(\n  attachments: PostCompactionAttachment[],\n  options: { maxChars: number }\n): string {\n  const maxChars = Math.max(0, Math.floor(options.maxChars));\n  if (attachments.length === 0 || maxChars === 0) {\n    return \"\";\n  }\n\n  const ordered = sortAttachmentsForInjection(attachments);\n\n  const blocks: string[] = [];\n  let currentLength = 0;\n  let omittedFileDiffs = 0;\n\n  const addBlock = (block: string): boolean => {\n    const separatorLen = blocks.length > 0 ? \"\\n\".length : 0;\n    const nextLength = currentLength + separatorLen + block.length;\n    if (nextLength > maxChars) {\n      return false;\n    }\n\n    blocks.push(block);\n    currentLength = nextLength;\n    return true;\n  };\n\n  for (const attachment of ordered) {\n    const separatorLen = blocks.length > 0 ? \"\\n\".length : 0;\n    const remainingForBlock = maxChars - currentLength - separatorLen;\n    const remainingForContent =\n      remainingForBlock - SYSTEM_UPDATE_OPEN.length - SYSTEM_UPDATE_CLOSE.length;\n\n    if (remainingForContent <= 0) {\n      break;\n    }\n\n    if (attachment.type === \"plan_file_reference\") {\n      const content = renderPlanFileReferenceWithBudget(attachment, remainingForContent);\n      if (content) {\n        addBlock(wrapSystemUpdate(content));\n      }\n      continue;\n    }\n\n    if (attachment.type === \"todo_list\") {\n      const content = renderTodoListAttachment(attachment);\n      if (content.length <= remainingForContent) {\n        addBlock(wrapSystemUpdate(content));\n      }\n      continue;\n    }\n\n    if (attachment.type === \"edited_files_reference\") {\n      const { content, omittedFiles } = renderEditedFilesReferenceWithBudget(\n        attachment,\n        remainingForContent\n      );\n      omittedFileDiffs += omittedFiles;\n\n      if (content) {\n        addBlock(wrapSystemUpdate(content));\n      }\n      continue;\n    }\n  }\n\n  if (omittedFileDiffs > 0) {\n    const plural = omittedFileDiffs === 1 ? \"\" : \"s\";\n    const note = `(post-compaction context truncated; omitted ${omittedFileDiffs} file diff${plural})`;\n    addBlock(wrapSystemUpdate(note));\n  }\n\n  if (blocks.length === 0) {\n    const note = \"(post-compaction context omitted due to size)\";\n    if (note.length + SYSTEM_UPDATE_OPEN.length + SYSTEM_UPDATE_CLOSE.length <= maxChars) {\n      blocks.push(wrapSystemUpdate(note));\n    }\n  }\n\n  return blocks.join(\"\\n\");\n}\n"]}