{"version":3,"file":"modelMessageTransform.js","sourceRoot":"","sources":["../../../../src/browser/utils/messages/modelMessageTransform.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Transform ModelMessages to ensure Anthropic API compliance.\r\n * This operates on already-converted ModelMessages from Vercel AI SDK.\r\n */\r\n\r\nimport type { ModelMessage, AssistantModelMessage, ToolModelMessage } from \"ai\";\r\nimport type { MuxMessage } from \"@/common/types/message\";\r\nimport type { EditedFileAttachment } from \"@/node/services/agentSession\";\r\nimport type { PostCompactionAttachment } from \"@/common/types/attachment\";\r\nimport { MAX_POST_COMPACTION_INJECTION_CHARS } from \"@/common/constants/attachments\";\r\nimport { findLatestCompactionBoundaryIndex } from \"@/common/utils/messages/compactionBoundary\";\r\nimport { renderAttachmentsToContentWithBudget } from \"./attachmentRenderer\";\r\n\r\n/**\r\n * Filter out assistant messages that are empty or only contain reasoning parts.\r\n * Empty messages (no parts or only empty text) and reasoning-only messages are\r\n * invalid for the API and provide no value to the model.\r\n *\r\n * Common scenarios:\r\n * 1. Placeholder messages with empty parts arrays (stream interrupted before any content)\r\n * 2. Messages interrupted during thinking phase before producing text\r\n *\r\n * EXCEPTION: When extended thinking is enabled, preserve reasoning-only messages.\r\n * The Extended Thinking API requires thinking blocks to be present in message history,\r\n * even if they were interrupted before producing text content.\r\n *\r\n * Note: This function filters out reasoning-only messages but does NOT strip reasoning\r\n * parts from messages that have other content. Reasoning parts are handled differently\r\n * per provider (see stripReasoningForOpenAI).\r\n *\r\n * @param messages - The messages to filter\r\n * @param preserveReasoningOnly - If true, keep reasoning-only messages (for Extended Thinking)\r\n */\r\nexport function filterEmptyAssistantMessages(\r\n  messages: MuxMessage[],\r\n  preserveReasoningOnly = false\r\n): MuxMessage[] {\r\n  return messages.filter((msg) => {\r\n    // Keep all non-assistant messages\r\n    if (msg.role !== \"assistant\") {\r\n      return true;\r\n    }\r\n\r\n    // Filter out messages with no parts at all (placeholder messages)\r\n    if (msg.parts?.length === 0) {\r\n      return false;\r\n    }\r\n\r\n    // Keep assistant messages that have at least one part that will survive\r\n    // conversion to provider ModelMessages.\r\n    //\r\n    // Important: We call convertToModelMessages(..., { ignoreIncompleteToolCalls: true }).\r\n    // That means *incomplete* tool calls (state: \"input-available\") will be dropped.\r\n    // If we treat them as content here, we can end up sending an assistant message that\r\n    // becomes empty after conversion, which the AI SDK rejects (\"all messages must have\r\n    // non-empty content...\") and can brick a workspace after a crash.\r\n    const hasContent = msg.parts.some((part) => {\r\n      if (part.type === \"text\") {\r\n        return part.text.trim().length > 0;\r\n      }\r\n\r\n      // Reasoning-only messages are handled below (provider-dependent).\r\n      if (part.type === \"reasoning\") {\r\n        return false;\r\n      }\r\n\r\n      if (part.type === \"dynamic-tool\") {\r\n        // Only completed tool calls produce content that can be replayed to the model.\r\n        return part.state === \"output-available\";\r\n      }\r\n\r\n      // File/image parts count as content.\r\n      if (part.type === \"file\") {\r\n        return true;\r\n      }\r\n\r\n      // Future-proofing: unknown parts should not brick the request.\r\n      return true;\r\n    });\r\n\r\n    if (hasContent) {\r\n      return true;\r\n    }\r\n\r\n    // If preserveReasoningOnly is enabled, keep messages with reasoning parts\r\n    // (needed for Extended Thinking API compliance)\r\n    if (preserveReasoningOnly) {\r\n      const hasReasoning = msg.parts.some((part) => part.type === \"reasoning\");\r\n      return hasReasoning;\r\n    }\r\n\r\n    return false;\r\n  });\r\n}\r\n\r\n/**\r\n * Add [CONTINUE] sentinel to partial messages by inserting a user message.\r\n * This helps the model understand that a message was interrupted and to continue.\r\n * The sentinel is ONLY for model context, not shown in UI.\r\n *\r\n * OPTIMIZATION: If a user message already follows the partial assistant message,\r\n * we skip the sentinel - the user message itself provides the continuation signal.\r\n * This saves tokens and creates more natural conversation flow.\r\n *\r\n * We insert a separate user message instead of modifying the assistant message\r\n * because if the assistant message only has reasoning (no text), it will be\r\n * filtered out, and we'd lose the interruption context. A user message always\r\n * survives filtering.\r\n */\r\nexport function addInterruptedSentinel(messages: MuxMessage[]): MuxMessage[] {\r\n  const result: MuxMessage[] = [];\r\n\r\n  for (let i = 0; i < messages.length; i++) {\r\n    const msg = messages[i];\r\n    result.push(msg);\r\n\r\n    // If this is a partial assistant message, conditionally insert [CONTINUE] sentinel\r\n    if (msg.role === \"assistant\" && msg.metadata?.partial) {\r\n      const nextMsg = messages[i + 1];\r\n\r\n      // Only add sentinel if there's NO user message following\r\n      // If user message follows, it provides the continuation context itself\r\n      if (!nextMsg || nextMsg.role !== \"user\") {\r\n        result.push({\r\n          id: `interrupted-${msg.id}`,\r\n          role: \"user\",\r\n          parts: [{ type: \"text\", text: \"[CONTINUE]\" }],\r\n          metadata: {\r\n            timestamp: msg.metadata.timestamp,\r\n            // Mark as synthetic so it can be identified if needed\r\n            synthetic: true,\r\n          },\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Inject agent transition context when the active agent changes mid-conversation.\r\n * Inserts a synthetic user message before the final user message to signal the agent switch.\r\n * This provides temporal context that helps models understand they should follow new agent instructions.\r\n *\r\n * When transitioning from plan → exec/orchestrator with plan content, includes the plan so the model\r\n * can evaluate its relevance to the current request.\r\n *\r\n * @param messages The conversation history\r\n * @param currentAgentId The agent id for the upcoming assistant response\r\n * @param toolNames Optional list of available tool names to include in transition message\r\n * @param planContent Optional plan content to include when transitioning plan → exec/orchestrator\r\n * @param planFilePath Optional plan file path to include when transitioning plan → exec/orchestrator\r\n * @returns Messages with agent transition context injected if needed\r\n */\r\nexport function injectAgentTransition(\r\n  messages: MuxMessage[],\r\n  currentAgentId?: string,\r\n  toolNames?: string[],\r\n  planContent?: string,\r\n  planFilePath?: string\r\n): MuxMessage[] {\r\n  // No agent specified, nothing to do\r\n  if (!currentAgentId) {\r\n    return messages;\r\n  }\r\n\r\n  // Need at least one message to have a conversation\r\n  if (messages.length === 0) {\r\n    return messages;\r\n  }\r\n\r\n  // Find the last assistant message to check its agent\r\n  const lastAssistantMessage = [...messages].reverse().find((m) => m.role === \"assistant\");\r\n  const lastAgentId = lastAssistantMessage?.metadata?.agentId;\r\n\r\n  // No agent transition if no previous agent or same agent\r\n  if (!lastAgentId || lastAgentId === currentAgentId) {\r\n    return messages;\r\n  }\r\n\r\n  // Agent transition detected! Inject a synthetic user message before the last user message\r\n  // This provides temporal context: user says \"switch agents\" before their actual request\r\n\r\n  // Find the index of the last user message\r\n  let lastUserIndex = -1;\r\n  for (let i = messages.length - 1; i >= 0; i--) {\r\n    if (messages[i].role === \"user\") {\r\n      lastUserIndex = i;\r\n      break;\r\n    }\r\n  }\r\n\r\n  // If there's no user message, can't inject transition (nothing to inject before)\r\n  if (lastUserIndex === -1) {\r\n    return messages;\r\n  }\r\n\r\n  const result: MuxMessage[] = [];\r\n\r\n  // Add all messages up to (but not including) the last user message\r\n  for (let i = 0; i < lastUserIndex; i++) {\r\n    result.push(messages[i]);\r\n  }\r\n\r\n  // Inject agent transition message right before the last user message\r\n  let transitionText = `[Agent switched from ${lastAgentId} to ${currentAgentId}. Follow ${currentAgentId} agent instructions.`;\r\n\r\n  // Append tool availability if provided\r\n  if (toolNames && toolNames.length > 0) {\r\n    transitionText += ` Available tools: ${toolNames.join(\", \")}.]`;\r\n  } else {\r\n    transitionText += \"]\";\r\n  }\r\n\r\n  // When transitioning from the plan agent to exec/orchestrator, include the plan for context.\r\n  // This avoids wasting tokens on tool calls just to re-read the plan file.\r\n  const transitioningFromPlan = lastAgentId === \"plan\";\r\n  const transitioningToExecOrOrchestrator =\r\n    currentAgentId === \"exec\" || currentAgentId === \"orchestrator\";\r\n  if (planContent && transitioningFromPlan && transitioningToExecOrOrchestrator) {\r\n    const planFilePathText = planFilePath ? `Plan file path: ${planFilePath}\\n\\n` : \"\";\r\n    const nextStepText =\r\n      currentAgentId === \"orchestrator\"\r\n        ? \"orchestrate its implementation (do not re-plan).\"\r\n        : \"implement it directly (do not re-plan).\";\r\n    const followupText =\r\n      currentAgentId === \"orchestrator\"\r\n        ? \"Only do extra exploration if the plan is missing critical details or conflicts with the repo:\"\r\n        : \"Only do extra exploration or spawn sub-agents if the plan is missing critical details or conflicts with the repo:\";\r\n    transitionText += `\r\n\r\n${planFilePathText}The following plan was developed in the plan agent. Based on the user's message, determine if they have accepted the plan. If accepted and relevant, ${nextStepText}\r\n${followupText}\r\n\r\n<plan>\r\n${planContent}\r\n</plan>`;\r\n  }\r\n\r\n  const transitionMessage: MuxMessage = {\r\n    id: `agent-transition-${Date.now()}`,\r\n    role: \"user\",\r\n    parts: [\r\n      {\r\n        type: \"text\",\r\n        text: transitionText,\r\n      },\r\n    ],\r\n    metadata: {\r\n      timestamp: Date.now(),\r\n      synthetic: true,\r\n    },\r\n  };\r\n  result.push(transitionMessage);\r\n\r\n  // Add the last user message and any remaining messages\r\n  for (let i = lastUserIndex; i < messages.length; i++) {\r\n    result.push(messages[i]);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Inject file change notifications as a synthetic user message.\r\n * When files are modified externally (by user or linter), append a notification at the end\r\n * so the model is aware of changes without busting the system message cache.\r\n *\r\n * @param messages The conversation history\r\n * @param changedFileAttachments Files that were modified externally\r\n * @returns Messages with file change notification appended if any files changed\r\n */\r\nexport function injectFileChangeNotifications(\r\n  messages: MuxMessage[],\r\n  changedFileAttachments?: EditedFileAttachment[]\r\n): MuxMessage[] {\r\n  if (!changedFileAttachments || changedFileAttachments.length === 0) {\r\n    return messages;\r\n  }\r\n\r\n  const notice = changedFileAttachments\r\n    .map(\r\n      (att) =>\r\n        `Note: ${att.filename} was modified, either by the user or by a linter.\\n` +\r\n        `This change was intentional, so make sure to take it into account as you proceed ` +\r\n        `(i.e., don't revert it unless the user asks you to). Here are the relevant changes:\\n${att.snippet}`\r\n    )\r\n    .join(\"\\n\\n\");\r\n\r\n  const syntheticMessage: MuxMessage = {\r\n    id: `file-change-${Date.now()}`,\r\n    role: \"user\",\r\n    parts: [{ type: \"text\", text: `<system-file-update>\\n${notice}\\n</system-file-update>` }],\r\n    metadata: {\r\n      timestamp: Date.now(),\r\n      synthetic: true,\r\n    },\r\n  };\r\n\r\n  return [...messages, syntheticMessage];\r\n}\r\n\r\nfunction findLatestLegacyCompactionSummaryIndex(messages: MuxMessage[]): number {\r\n  for (let i = messages.length - 1; i >= 0; i -= 1) {\r\n    const message = messages[i];\r\n    if (message.role !== \"assistant\") {\r\n      continue;\r\n    }\r\n\r\n    const compacted = message.metadata?.compacted;\r\n    if (compacted === undefined || compacted === false) {\r\n      continue;\r\n    }\r\n\r\n    return i;\r\n  }\r\n\r\n  return -1;\r\n}\r\n\r\n/**\r\n * Inject post-compaction attachments as a synthetic user message.\r\n * When compaction occurs, this injects a message containing plan file content\r\n * and/or edited files to preserve context that would otherwise be lost.\r\n *\r\n * The message is inserted AFTER the compaction summary message to ensure\r\n * the model receives this context for the next turn.\r\n *\r\n * @param messages The conversation history\r\n * @param attachments Post-compaction attachments (plan file, edited files)\r\n * @returns Messages with attachments injected after compaction summary\r\n */\r\nexport function injectPostCompactionAttachments(\r\n  messages: MuxMessage[],\r\n  attachments?: PostCompactionAttachment[] | null\r\n): MuxMessage[] {\r\n  if (!attachments || attachments.length === 0) {\r\n    return messages;\r\n  }\r\n\r\n  const durableCompactionIndex = findLatestCompactionBoundaryIndex(messages);\r\n  // Durable boundaries are authoritative for current histories. Legacy histories\r\n  // only have metadata.compacted, so fall back to that marker when needed.\r\n  const compactionIndex =\r\n    durableCompactionIndex !== -1\r\n      ? durableCompactionIndex\r\n      : findLatestLegacyCompactionSummaryIndex(messages);\r\n\r\n  if (compactionIndex === -1) {\r\n    // No compaction message found - this shouldn't happen if attachments are provided,\r\n    // but append at end as a fallback\r\n    const syntheticMessage: MuxMessage = {\r\n      id: `post-compaction-${Date.now()}`,\r\n      role: \"user\",\r\n      parts: [\r\n        {\r\n          type: \"text\",\r\n          text: renderAttachmentsToContentWithBudget(attachments, {\r\n            maxChars: MAX_POST_COMPACTION_INJECTION_CHARS,\r\n          }),\r\n        },\r\n      ],\r\n      metadata: {\r\n        timestamp: Date.now(),\r\n        synthetic: true,\r\n      },\r\n    };\r\n    return [...messages, syntheticMessage];\r\n  }\r\n\r\n  // Insert the synthetic message immediately after the compaction summary\r\n  const syntheticMessage: MuxMessage = {\r\n    id: `post-compaction-${Date.now()}`,\r\n    role: \"user\",\r\n    parts: [\r\n      {\r\n        type: \"text\",\r\n        text: renderAttachmentsToContentWithBudget(attachments, {\r\n          maxChars: MAX_POST_COMPACTION_INJECTION_CHARS,\r\n        }),\r\n      },\r\n    ],\r\n    metadata: {\r\n      timestamp: messages[compactionIndex].metadata?.timestamp ?? Date.now(),\r\n      synthetic: true,\r\n    },\r\n  };\r\n\r\n  const result = [...messages];\r\n  result.splice(compactionIndex + 1, 0, syntheticMessage);\r\n  return result;\r\n}\r\n\r\n/**\r\n * Filter out assistant messages that only contain reasoning parts (no text or tool parts).\r\n * Anthropic API rejects messages that have reasoning but no actual content.\r\n * This happens when a message is interrupted during thinking before producing any text.\r\n */\r\n/**\r\n * Split assistant messages with mixed text and tool calls into separate messages\r\n * to comply with Anthropic's requirement that tool_use blocks must be immediately\r\n * followed by their tool_result blocks without intervening text.\r\n */\r\nfunction splitMixedContentMessages(messages: ModelMessage[]): ModelMessage[] {\r\n  const result: ModelMessage[] = [];\r\n\r\n  for (let i = 0; i < messages.length; i++) {\r\n    const msg = messages[i];\r\n\r\n    if (msg.role !== \"assistant\") {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const assistantMsg = msg;\r\n\r\n    if (typeof assistantMsg.content === \"string\") {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const toolCallParts = assistantMsg.content.filter((c) => c.type === \"tool-call\");\r\n\r\n    if (toolCallParts.length === 0) {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const nextMsg = messages[i + 1];\r\n    const hasToolResults = nextMsg?.role === \"tool\";\r\n\r\n    if (!hasToolResults) {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const toolMsg = nextMsg;\r\n\r\n    type ContentArray = Exclude<typeof assistantMsg.content, string>;\r\n    const groups: Array<{ type: \"text\" | \"tool-call\"; parts: ContentArray }> = [];\r\n    let currentGroup: { type: \"text\" | \"tool-call\"; parts: ContentArray } | null = null;\r\n\r\n    for (const part of assistantMsg.content) {\r\n      const partType = part.type === \"tool-call\" ? \"tool-call\" : \"text\";\r\n\r\n      // eslint-disable-next-line @typescript-eslint/prefer-optional-chain\r\n      if (!currentGroup || currentGroup.type !== partType) {\r\n        if (currentGroup) groups.push(currentGroup);\r\n        currentGroup = { type: partType, parts: [] };\r\n      }\r\n\r\n      currentGroup.parts.push(part);\r\n    }\r\n\r\n    if (currentGroup) {\r\n      groups.push(currentGroup);\r\n    }\r\n\r\n    if (groups.length <= 1) {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const toolResultsById = new Map<string, Array<ToolModelMessage[\"content\"][number]>>();\r\n    for (const content of toolMsg.content) {\r\n      if (content.type === \"tool-result\") {\r\n        const existing = toolResultsById.get(content.toolCallId);\r\n        if (existing) {\r\n          existing.push(content);\r\n        } else {\r\n          toolResultsById.set(content.toolCallId, [content]);\r\n        }\r\n      }\r\n    }\r\n\r\n    for (let groupIndex = 0; groupIndex < groups.length; groupIndex++) {\r\n      const group = groups[groupIndex];\r\n      if (group.parts.length === 0) {\r\n        continue;\r\n      }\r\n\r\n      // If text is immediately followed by tool calls, keep them together.\r\n      // Text before tool_use is allowed by Anthropic; only *text after tool_use* is invalid.\r\n      if (group.type === \"text\") {\r\n        const nextGroup = groups[groupIndex + 1];\r\n        if (nextGroup?.type === \"tool-call\" && nextGroup.parts.length > 0) {\r\n          const toolPartsToInclude = nextGroup.parts.filter(\r\n            (p) => p.type === \"tool-call\" && toolResultsById.has(p.toolCallId)\r\n          );\r\n\r\n          // If none of the tool calls have results, keep just the text portion.\r\n          if (toolPartsToInclude.length === 0) {\r\n            result.push({ role: \"assistant\", content: group.parts });\r\n            groupIndex++;\r\n            continue;\r\n          }\r\n\r\n          const newAssistantMsg: AssistantModelMessage = {\r\n            role: \"assistant\",\r\n            content: [...group.parts, ...toolPartsToInclude],\r\n          };\r\n          result.push(newAssistantMsg);\r\n\r\n          const relevantResults: ToolModelMessage[\"content\"] = [];\r\n          for (const part of toolPartsToInclude) {\r\n            if (part.type !== \"tool-call\") {\r\n              continue;\r\n            }\r\n            const results = toolResultsById.get(part.toolCallId);\r\n            if (results) {\r\n              relevantResults.push(...results);\r\n              toolResultsById.delete(part.toolCallId);\r\n            }\r\n          }\r\n\r\n          if (relevantResults.length > 0) {\r\n            const newToolMsg: ToolModelMessage = {\r\n              role: \"tool\",\r\n              content: relevantResults,\r\n            };\r\n            result.push(newToolMsg);\r\n          }\r\n\r\n          groupIndex++;\r\n          continue;\r\n        }\r\n\r\n        result.push({ role: \"assistant\", content: group.parts });\r\n        continue;\r\n      }\r\n\r\n      const partsToInclude = group.parts.filter(\r\n        (p) => p.type === \"tool-call\" && toolResultsById.has(p.toolCallId)\r\n      );\r\n\r\n      if (partsToInclude.length === 0) {\r\n        continue;\r\n      }\r\n\r\n      const newAssistantMsg: AssistantModelMessage = {\r\n        role: \"assistant\",\r\n        content: partsToInclude,\r\n      };\r\n      result.push(newAssistantMsg);\r\n\r\n      const relevantResults: ToolModelMessage[\"content\"] = [];\r\n      for (const part of partsToInclude) {\r\n        if (part.type !== \"tool-call\") {\r\n          continue;\r\n        }\r\n        const results = toolResultsById.get(part.toolCallId);\r\n        if (results) {\r\n          relevantResults.push(...results);\r\n          toolResultsById.delete(part.toolCallId);\r\n        }\r\n      }\r\n\r\n      if (relevantResults.length > 0) {\r\n        const newToolMsg: ToolModelMessage = {\r\n          role: \"tool\",\r\n          content: relevantResults,\r\n        };\r\n        result.push(newToolMsg);\r\n      }\r\n    }\r\n\r\n    i++;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction filterReasoningOnlyMessages(messages: ModelMessage[]): ModelMessage[] {\r\n  return messages.filter((msg) => {\r\n    if (msg.role !== \"assistant\") {\r\n      return true;\r\n    }\r\n\r\n    // Check if content is string or array\r\n    if (typeof msg.content === \"string\") {\r\n      return msg.content.trim().length > 0;\r\n    }\r\n\r\n    // For array content, check if there's at least one non-reasoning part\r\n    const hasNonReasoningContent = msg.content.some((part) => part.type !== \"reasoning\");\r\n\r\n    return hasNonReasoningContent;\r\n  });\r\n}\r\n\r\n/**\r\n * Remove tool-call/tool-result parts that do not have a matching counterpart.\r\n *\r\n * Some providers (e.g., OpenAI responses) reject requests when a tool call is\r\n * present without its tool output. If history is interrupted or corrupted, we\r\n * can end up with orphaned tool-call/tool-result parts. Drop them to keep the\r\n * request valid and self-healing.\r\n */\r\nexport function stripOrphanedToolCalls(messages: ModelMessage[]): ModelMessage[] {\r\n  const toolCallIds = new Set<string>();\r\n  const toolResultIds = new Set<string>();\r\n\r\n  for (const msg of messages) {\r\n    if (msg.role === \"assistant\") {\r\n      const assistantMsg = msg;\r\n      if (typeof assistantMsg.content === \"string\") {\r\n        continue;\r\n      }\r\n      for (const part of assistantMsg.content) {\r\n        if (part.type === \"tool-call\") {\r\n          toolCallIds.add(part.toolCallId);\r\n        }\r\n        if (part.type === \"tool-result\") {\r\n          toolResultIds.add(part.toolCallId);\r\n        }\r\n      }\r\n      continue;\r\n    }\r\n\r\n    if (msg.role === \"tool\") {\r\n      const toolMsg = msg;\r\n      for (const part of toolMsg.content) {\r\n        if (part.type === \"tool-result\") {\r\n          toolResultIds.add(part.toolCallId);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  const missingResults = new Set(\r\n    [...toolCallIds].filter((toolCallId) => !toolResultIds.has(toolCallId))\r\n  );\r\n  const orphanResults = new Set(\r\n    [...toolResultIds].filter((toolCallId) => !toolCallIds.has(toolCallId))\r\n  );\r\n\r\n  if (missingResults.size === 0 && orphanResults.size === 0) {\r\n    return messages;\r\n  }\r\n\r\n  const cleaned: ModelMessage[] = [];\r\n\r\n  for (const msg of messages) {\r\n    if (msg.role === \"assistant\") {\r\n      const assistantMsg = msg;\r\n      if (typeof assistantMsg.content === \"string\") {\r\n        cleaned.push(msg);\r\n        continue;\r\n      }\r\n\r\n      const filteredContent = assistantMsg.content.filter((part) => {\r\n        if (part.type === \"tool-call\") {\r\n          return !missingResults.has(part.toolCallId);\r\n        }\r\n        if (part.type === \"tool-result\") {\r\n          return !orphanResults.has(part.toolCallId);\r\n        }\r\n        return true;\r\n      });\r\n\r\n      if (filteredContent.length === 0) {\r\n        continue;\r\n      }\r\n\r\n      if (filteredContent.length === assistantMsg.content.length) {\r\n        cleaned.push(msg);\r\n      } else {\r\n        cleaned.push({\r\n          ...assistantMsg,\r\n          content: filteredContent,\r\n        });\r\n      }\r\n      continue;\r\n    }\r\n\r\n    if (msg.role === \"tool\") {\r\n      const toolMsg = msg;\r\n      const filteredContent = toolMsg.content.filter((part) => {\r\n        if (part.type !== \"tool-result\") {\r\n          return true;\r\n        }\r\n        return !orphanResults.has(part.toolCallId);\r\n      });\r\n\r\n      if (filteredContent.length === 0) {\r\n        continue;\r\n      }\r\n\r\n      if (filteredContent.length === toolMsg.content.length) {\r\n        cleaned.push(msg);\r\n      } else {\r\n        cleaned.push({\r\n          ...toolMsg,\r\n          content: filteredContent,\r\n        });\r\n      }\r\n      continue;\r\n    }\r\n\r\n    cleaned.push(msg);\r\n  }\r\n\r\n  return cleaned;\r\n}\r\n\r\n/**\r\n * Coalesce consecutive no-progress `task_await` tool-call/tool-result message pairs.\r\n *\r\n * `task_await` is commonly polled in a loop while waiting on sub-agent tasks.\r\n * When there's no new output, those polls add near-duplicate tool messages to\r\n * provider context, increasing tokens without adding information.\r\n *\r\n * This pass removes consecutive *identical* no-progress pairs (same tool input\r\n * fingerprint), keeping only the last pair in each run.\r\n *\r\n * IMPORTANT: To preserve Anthropic tool_use/tool_result adjacency rules, we only\r\n * remove messages in (assistant + immediately following tool) pairs.\r\n *\r\n * Self-healing: If we see anything unexpected (shape mismatch, unstringifiable\r\n * inputs, unparseable outputs), we leave messages unchanged.\r\n */\r\nfunction coalesceConsecutiveNoProgressTaskAwaitPairs(messages: ModelMessage[]): ModelMessage[] {\r\n  function tryJsonStringify(value: unknown): string | undefined {\r\n    try {\r\n      const result = JSON.stringify(value);\r\n      if (typeof result !== \"string\") {\r\n        return undefined;\r\n      }\r\n      return result;\r\n    } catch {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  function getToolCallInputFingerprint(\r\n    part: { input?: unknown } | { args?: unknown }\r\n  ): string | undefined {\r\n    const input = (part as { input?: unknown }).input ?? (part as { args?: unknown }).args;\r\n    return tryJsonStringify(input);\r\n  }\r\n\r\n  function extractToolResultValue(part: { output?: unknown } | { result?: unknown }): unknown {\r\n    const raw = (part as { result?: unknown }).result ?? (part as { output?: unknown }).output;\r\n\r\n    // The AI SDK wraps tool results as `{ type: 'json' | 'text', value: unknown }`.\r\n    if (raw && typeof raw === \"object\" && \"type\" in raw && \"value\" in raw) {\r\n      return (raw as { value?: unknown }).value;\r\n    }\r\n\r\n    return raw;\r\n  }\r\n\r\n  function isNoProgressTaskAwaitResultValue(value: unknown): boolean {\r\n    if (!value || typeof value !== \"object\") {\r\n      return false;\r\n    }\r\n\r\n    const results = (value as { results?: unknown }).results;\r\n    if (!Array.isArray(results)) {\r\n      return false;\r\n    }\r\n\r\n    for (const entry of results) {\r\n      if (!entry || typeof entry !== \"object\") {\r\n        return false;\r\n      }\r\n\r\n      const status = (entry as { status?: unknown }).status;\r\n      if (status !== \"queued\" && status !== \"running\" && status !== \"awaiting_report\") {\r\n        return false;\r\n      }\r\n\r\n      // Treat any non-empty output/report as progress.\r\n      const output = (entry as { output?: unknown }).output;\r\n      if (output !== undefined) {\r\n        if (typeof output !== \"string\") {\r\n          return false;\r\n        }\r\n        if (output.length > 0) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      const reportMarkdown = (entry as { reportMarkdown?: unknown }).reportMarkdown;\r\n      if (typeof reportMarkdown === \"string\" && reportMarkdown.length > 0) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function getTaskAwaitPairInfo(\r\n    allMessages: ModelMessage[],\r\n    index: number\r\n  ):\r\n    | {\r\n        fingerprint: string;\r\n        noProgress: boolean;\r\n      }\r\n    | undefined {\r\n    const assistantMsg = allMessages[index];\r\n    const toolMsg = allMessages[index + 1];\r\n\r\n    if (!assistantMsg || !toolMsg) {\r\n      return undefined;\r\n    }\r\n\r\n    if (assistantMsg.role !== \"assistant\" || toolMsg.role !== \"tool\") {\r\n      return undefined;\r\n    }\r\n\r\n    const assistant = assistantMsg;\r\n    if (typeof assistant.content === \"string\") {\r\n      return undefined;\r\n    }\r\n\r\n    if (assistant.content.length !== 1) {\r\n      return undefined;\r\n    }\r\n\r\n    const toolCallPart = assistant.content[0];\r\n    if (toolCallPart?.type !== \"tool-call\") {\r\n      return undefined;\r\n    }\r\n\r\n    if (toolCallPart.toolName !== \"task_await\") {\r\n      return undefined;\r\n    }\r\n\r\n    const fingerprint = getToolCallInputFingerprint(toolCallPart);\r\n    if (!fingerprint) {\r\n      return undefined;\r\n    }\r\n\r\n    if (!Array.isArray(toolMsg.content) || toolMsg.content.length !== 1) {\r\n      return undefined;\r\n    }\r\n\r\n    const toolResultPart = toolMsg.content[0];\r\n    if (toolResultPart?.type !== \"tool-result\") {\r\n      return undefined;\r\n    }\r\n\r\n    if (toolResultPart.toolName !== \"task_await\") {\r\n      return undefined;\r\n    }\r\n\r\n    // Only coalesce when the tool-result matches the immediately preceding tool-call.\r\n    if (toolResultPart.toolCallId !== toolCallPart.toolCallId) {\r\n      return undefined;\r\n    }\r\n\r\n    const toolResultValue = extractToolResultValue(toolResultPart);\r\n\r\n    return {\r\n      fingerprint,\r\n      noProgress: isNoProgressTaskAwaitResultValue(toolResultValue),\r\n    };\r\n  }\r\n\r\n  try {\r\n    let changed = false;\r\n    const result: ModelMessage[] = [];\r\n\r\n    for (let i = 0; i < messages.length; ) {\r\n      const info = getTaskAwaitPairInfo(messages, i);\r\n      if (!info) {\r\n        result.push(messages[i]);\r\n        i++;\r\n        continue;\r\n      }\r\n\r\n      // Not a no-progress poll, keep it.\r\n      if (!info.noProgress) {\r\n        result.push(messages[i], messages[i + 1]);\r\n        i += 2;\r\n        continue;\r\n      }\r\n\r\n      // Scan ahead for a run of consecutive identical no-progress polls.\r\n      let runEnd = i;\r\n      for (let j = i + 2; j < messages.length; j += 2) {\r\n        const nextInfo = getTaskAwaitPairInfo(messages, j);\r\n        if (!nextInfo) {\r\n          break;\r\n        }\r\n        if (!nextInfo.noProgress) {\r\n          break;\r\n        }\r\n        if (nextInfo.fingerprint !== info.fingerprint) {\r\n          break;\r\n        }\r\n        runEnd = j;\r\n      }\r\n\r\n      if (runEnd !== i) {\r\n        changed = true;\r\n      }\r\n\r\n      result.push(messages[runEnd], messages[runEnd + 1]);\r\n      i = runEnd + 2;\r\n    }\r\n\r\n    return changed ? result : messages;\r\n  } catch {\r\n    // Self-healing: request-time transforms should never brick a workspace.\r\n    return messages;\r\n  }\r\n}\r\n/**\r\n * Strip Anthropic reasoning parts that lack a valid signature.\r\n *\r\n * Anthropic's Extended Thinking API requires thinking blocks to include a signature\r\n * for replay. The Vercel AI SDK's Anthropic provider only sends reasoning parts to\r\n * the API if they have providerOptions.anthropic.signature. Reasoning parts we create\r\n * (placeholders) or from history (where we didn't capture the signature) will be\r\n * silently dropped by the SDK.\r\n *\r\n * If all parts of an assistant message are unsigned reasoning, the SDK drops them all,\r\n * leaving an empty message that Anthropic rejects with:\r\n * \"all messages must have non-empty content except for the optional final assistant message\"\r\n *\r\n * This function removes unsigned reasoning upfront and filters resulting empty messages.\r\n *\r\n * NOTE: This is Anthropic-specific. Other providers (e.g., OpenAI) handle reasoning\r\n * differently and don't require signatures.\r\n */\r\nfunction stripUnsignedAnthropicReasoning(messages: ModelMessage[]): ModelMessage[] {\r\n  const stripped = messages.map((msg) => {\r\n    if (msg.role !== \"assistant\") {\r\n      return msg;\r\n    }\r\n\r\n    const assistantMsg = msg;\r\n    if (typeof assistantMsg.content === \"string\") {\r\n      return msg;\r\n    }\r\n\r\n    // Filter out reasoning parts without anthropic.signature in providerOptions\r\n    const content = assistantMsg.content.filter((part) => {\r\n      if (part.type !== \"reasoning\") {\r\n        return true;\r\n      }\r\n      // Check for anthropic.signature in providerOptions\r\n      const anthropicMeta = (part.providerOptions as { anthropic?: { signature?: string } })\r\n        ?.anthropic;\r\n      return anthropicMeta?.signature != null;\r\n    });\r\n\r\n    const result: typeof assistantMsg = { ...assistantMsg, content };\r\n    return result;\r\n  });\r\n\r\n  // Filter out messages that became empty after stripping reasoning.\r\n  //\r\n  // Important: Anthropic rejects whitespace-only text content blocks (e.g. \"\\n\\n\").\r\n  // If we strip unsigned reasoning from an interrupted message, we can be left with\r\n  // only whitespace text, which would otherwise survive a simple `content.length > 0` check.\r\n  return stripped.filter((msg) => {\r\n    if (msg.role !== \"assistant\") {\r\n      return true;\r\n    }\r\n\r\n    if (typeof msg.content === \"string\") {\r\n      return msg.content.trim().length > 0;\r\n    }\r\n\r\n    return msg.content.some((part) => part.type !== \"text\" || part.text.trim().length > 0);\r\n  });\r\n}\r\n\r\n/**\r\n * Coalesce consecutive parts of the same type within each message.\r\n * Streaming creates many individual text/reasoning parts; merge them for easier debugging.\r\n * Also reduces JSON overhead when sending messages to the API.\r\n * Tool calls remain atomic (not merged).\r\n */\r\nfunction coalesceConsecutiveParts(messages: ModelMessage[]): ModelMessage[] {\r\n  return messages.map((msg) => {\r\n    // Only process assistant messages with array content\r\n    if (msg.role !== \"assistant\") {\r\n      return msg;\r\n    }\r\n\r\n    const assistantMsg = msg;\r\n\r\n    // Skip string content\r\n    if (typeof assistantMsg.content === \"string\") {\r\n      return msg;\r\n    }\r\n\r\n    // Now TypeScript knows content is an array\r\n    type ContentArray = Exclude<typeof assistantMsg.content, string>;\r\n    const coalesced: ContentArray = [];\r\n\r\n    for (const part of assistantMsg.content) {\r\n      const lastPart = coalesced[coalesced.length - 1];\r\n\r\n      // Merge consecutive text parts\r\n      if (part.type === \"text\" && lastPart?.type === \"text\") {\r\n        lastPart.text += part.text;\r\n        continue;\r\n      }\r\n\r\n      // Merge consecutive reasoning parts (extended thinking)\r\n      if (part.type === \"reasoning\" && lastPart?.type === \"reasoning\") {\r\n        lastPart.text += part.text;\r\n        // Preserve signature from later parts - during streaming, the signature\r\n        // arrives at the end and is attached to the last reasoning part.\r\n        // Cast needed because AI SDK's ReasoningPart doesn't have signature,\r\n        // but our MuxReasoningPart (which flows through convertToModelMessages) does.\r\n        const partWithSig = part as typeof part & {\r\n          signature?: string;\r\n          providerOptions?: { anthropic?: { signature?: string } };\r\n        };\r\n        const lastWithSig = lastPart as typeof lastPart & {\r\n          signature?: string;\r\n          providerOptions?: { anthropic?: { signature?: string } };\r\n        };\r\n        if (partWithSig.signature) {\r\n          lastWithSig.signature = partWithSig.signature;\r\n        }\r\n        if (partWithSig.providerOptions) {\r\n          lastWithSig.providerOptions = partWithSig.providerOptions;\r\n        }\r\n        continue;\r\n      }\r\n\r\n      // Keep tool calls and first occurrence of each type\r\n      coalesced.push(part);\r\n    }\r\n\r\n    return {\r\n      ...assistantMsg,\r\n      content: coalesced,\r\n    };\r\n  });\r\n}\r\n/**\r\n * Merge consecutive user messages with newline separators.\r\n * When filtering removes assistant messages, we can end up with consecutive user messages.\r\n * Anthropic requires alternating user/assistant, so we merge them.\r\n */\r\nfunction mergeConsecutiveUserMessages(messages: ModelMessage[]): ModelMessage[] {\r\n  const merged: ModelMessage[] = [];\r\n\r\n  for (const msg of messages) {\r\n    if (msg.role === \"user\" && merged.length > 0 && merged[merged.length - 1].role === \"user\") {\r\n      // Consecutive user message - merge with previous\r\n      const prevMsg = merged[merged.length - 1];\r\n\r\n      // Get text content from both messages\r\n      const prevText = Array.isArray(prevMsg.content)\r\n        ? (prevMsg.content.find((c) => c.type === \"text\")?.text ?? \"\")\r\n        : prevMsg.content;\r\n\r\n      const currentText = Array.isArray(msg.content)\r\n        ? (msg.content.find((c) => c.type === \"text\")?.text ?? \"\")\r\n        : typeof msg.content === \"string\"\r\n          ? msg.content\r\n          : \"\";\r\n\r\n      // Merge with newline prefix\r\n      const mergedText = prevText + \"\\n\" + currentText;\r\n\r\n      // Collect file/image parts from both messages\r\n      const prevImageParts = Array.isArray(prevMsg.content)\r\n        ? prevMsg.content.filter((c) => c.type === \"file\")\r\n        : [];\r\n      const currentImageParts = Array.isArray(msg.content)\r\n        ? msg.content.filter((c) => c.type === \"file\")\r\n        : [];\r\n\r\n      // Update the previous message with merged text and all image parts\r\n      merged[merged.length - 1] = {\r\n        role: \"user\",\r\n        content: [\r\n          { type: \"text\" as const, text: mergedText },\r\n          ...prevImageParts,\r\n          ...currentImageParts,\r\n        ],\r\n      };\r\n    } else {\r\n      // Not consecutive user message, add as-is\r\n      merged.push(msg);\r\n    }\r\n  }\r\n\r\n  return merged;\r\n}\r\n\r\nfunction ensureAnthropicThinkingBeforeToolCalls(messages: ModelMessage[]): ModelMessage[] {\r\n  const result: ModelMessage[] = [];\r\n\r\n  for (const msg of messages) {\r\n    if (msg.role !== \"assistant\") {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const assistantMsg = msg;\r\n    if (typeof assistantMsg.content === \"string\") {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    const content = assistantMsg.content;\r\n    const hasToolCall = content.some((part) => part.type === \"tool-call\");\r\n    if (!hasToolCall) {\r\n      result.push(msg);\r\n      continue;\r\n    }\r\n\r\n    let reasoningParts = content.filter((part) => part.type === \"reasoning\");\r\n    const nonReasoningParts = content.filter((part) => part.type !== \"reasoning\");\r\n\r\n    // If no reasoning is present, try to merge it from the immediately preceding assistant message\r\n    // if that message consists of reasoning-only parts. This commonly happens after splitting.\r\n    if (reasoningParts.length === 0 && result.length > 0) {\r\n      const prev = result[result.length - 1];\r\n      if (prev.role === \"assistant\") {\r\n        const prevAssistant = prev;\r\n        if (typeof prevAssistant.content !== \"string\") {\r\n          const prevIsReasoningOnly =\r\n            prevAssistant.content.length > 0 &&\r\n            prevAssistant.content.every((part) => part.type === \"reasoning\");\r\n          if (prevIsReasoningOnly) {\r\n            result.pop();\r\n            reasoningParts = prevAssistant.content.filter((part) => part.type === \"reasoning\");\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Anthropic extended thinking requires tool-use assistant messages to start with a thinking block.\r\n    // If we still have no reasoning available, insert a minimal placeholder reasoning part.\r\n    // NOTE: The text cannot be empty - Anthropic API rejects empty content.\r\n    if (reasoningParts.length === 0) {\r\n      reasoningParts = [{ type: \"reasoning\" as const, text: \"...\" }];\r\n    }\r\n\r\n    result.push({\r\n      ...assistantMsg,\r\n      content: [...reasoningParts, ...nonReasoningParts],\r\n    });\r\n  }\r\n\r\n  // Anthropic extended thinking also requires the *final* assistant message in the request\r\n  // to start with a thinking block. If the last assistant message is text-only (common for\r\n  // synthetic messages like sub-agent reports), insert an empty reasoning part as a minimal\r\n  // placeholder. This transformation affects only the provider request, not stored history/UI.\r\n  for (let i = result.length - 1; i >= 0; i--) {\r\n    const msg = result[i];\r\n    if (msg.role !== \"assistant\") {\r\n      continue;\r\n    }\r\n\r\n    const assistantMsg = msg;\r\n\r\n    if (typeof assistantMsg.content === \"string\") {\r\n      // String-only assistant messages need converting to part arrays to insert reasoning.\r\n      const text = assistantMsg.content;\r\n      // If it's truly empty, leave it unchanged (it will be filtered elsewhere).\r\n      if (text.length === 0) break;\r\n      result[i] = {\r\n        ...assistantMsg,\r\n        content: [\r\n          { type: \"reasoning\" as const, text: \"...\" },\r\n          { type: \"text\" as const, text },\r\n        ],\r\n      };\r\n      break;\r\n    }\r\n\r\n    const content = assistantMsg.content;\r\n    if (content.length === 0) {\r\n      break;\r\n    }\r\n    if (content[0].type === \"reasoning\") {\r\n      break;\r\n    }\r\n\r\n    result[i] = {\r\n      ...assistantMsg,\r\n      content: [{ type: \"reasoning\" as const, text: \"...\" }, ...content],\r\n    };\r\n    break;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Transform messages to ensure provider API compliance.\r\n * Applies multiple transformation passes based on provider requirements:\r\n * 0. Coalesce consecutive parts (text/reasoning) - all providers, reduces JSON overhead\r\n * 1. Split mixed content messages (text + tool calls) - all providers\r\n * 2. Drop orphaned tool calls/results (self-healing)\r\n * 3. Coalesce consecutive no-progress `task_await` polls - all providers\r\n * 4. Filter reasoning-only messages:\r\n *    - OpenAI: Keep reasoning parts (managed via previousResponseId), filter reasoning-only messages\r\n *    - Anthropic: Filter out reasoning-only messages (API rejects them)\r\n * 5. Merge consecutive user messages - all providers\r\n *\r\n * Note: encryptedContent stripping happens earlier in streamManager when tool results\r\n * are first stored, not during message transformation.\r\n *\r\n * @param messages The messages to transform\r\n * @param provider The provider name (e.g., \"anthropic\", \"openai\")\r\n */\r\nexport function transformModelMessages(\r\n  messages: ModelMessage[],\r\n  provider: string,\r\n  options?: {\r\n    anthropicThinkingEnabled?: boolean;\r\n  }\r\n): ModelMessage[] {\r\n  // Pass 0: Coalesce consecutive parts to reduce JSON overhead from streaming (applies to all providers)\r\n  const coalesced = coalesceConsecutiveParts(messages);\r\n\r\n  // Pass 1: Split mixed content messages (applies to all providers)\r\n  const split = splitMixedContentMessages(coalesced);\r\n\r\n  // Pass 2: Drop orphaned tool-call/tool-result pairs (applies to all providers)\r\n  const toolPaired = stripOrphanedToolCalls(split);\r\n\r\n  // Pass 3: Coalesce consecutive no-progress task_await polls (applies to all providers)\r\n  const taskAwaitCoalesced = coalesceConsecutiveNoProgressTaskAwaitPairs(toolPaired);\r\n\r\n  // Pass 4: Provider-specific reasoning handling\r\n  let reasoningHandled: ModelMessage[];\r\n  if (provider === \"openai\") {\r\n    // OpenAI: Keep reasoning parts - managed via previousResponseId\r\n    // Only filter out reasoning-only messages (messages with no text/tool-call content)\r\n    reasoningHandled = filterReasoningOnlyMessages(taskAwaitCoalesced);\r\n  } else if (provider === \"anthropic\") {\r\n    // Anthropic: When extended thinking is enabled, preserve reasoning-only messages and ensure\r\n    // tool-call messages start with reasoning. When it's disabled, filter reasoning-only messages.\r\n    if (options?.anthropicThinkingEnabled) {\r\n      // First strip reasoning without signatures (SDK will drop them anyway, causing empty messages)\r\n      const signedReasoning = stripUnsignedAnthropicReasoning(taskAwaitCoalesced);\r\n      reasoningHandled = ensureAnthropicThinkingBeforeToolCalls(signedReasoning);\r\n    } else {\r\n      reasoningHandled = filterReasoningOnlyMessages(taskAwaitCoalesced);\r\n    }\r\n  } else {\r\n    // Unknown provider: no reasoning handling\r\n    reasoningHandled = taskAwaitCoalesced;\r\n  }\r\n\r\n  // Pass 5: Merge consecutive user messages (applies to all providers)\r\n  const merged = mergeConsecutiveUserMessages(reasoningHandled);\r\n\r\n  return merged;\r\n}\r\n\r\n/**\r\n * Validate that the transformed messages follow Anthropic's requirements:\r\n * - Every tool-call must be immediately followed by its tool-result message\r\n */\r\nexport function validateAnthropicCompliance(messages: ModelMessage[]): {\r\n  valid: boolean;\r\n  error?: string;\r\n} {\r\n  const pendingToolCalls = new Map<string, number>(); // toolCallId -> message index\r\n\r\n  for (let i = 0; i < messages.length; i++) {\r\n    const msg = messages[i];\r\n\r\n    if (msg.role === \"assistant\") {\r\n      const assistantMsg = msg;\r\n\r\n      // Skip if content is just a string\r\n      if (typeof assistantMsg.content === \"string\") {\r\n        continue;\r\n      }\r\n\r\n      // Track any tool calls in this message\r\n      for (const content of assistantMsg.content) {\r\n        if (content.type === \"tool-call\") {\r\n          pendingToolCalls.set(content.toolCallId, i);\r\n        }\r\n      }\r\n\r\n      // If we have pending tool calls and encounter text or more tool calls,\r\n      // check if the next message has the results\r\n      if (pendingToolCalls.size > 0) {\r\n        const nextMsg = messages[i + 1];\r\n\r\n        // The next message MUST be a tool result message if we have pending calls\r\n        if (nextMsg?.role !== \"tool\") {\r\n          const pendingIds = Array.from(pendingToolCalls.keys()).join(\", \");\r\n          return {\r\n            valid: false,\r\n            error: `Message ${i}: tool_use blocks found without tool_result blocks immediately after: ${pendingIds}`,\r\n          };\r\n        }\r\n      }\r\n    } else if (msg.role === \"tool\") {\r\n      const toolMsg = msg;\r\n\r\n      // Process tool results and clear pending calls\r\n      for (const content of toolMsg.content) {\r\n        if (content.type === \"tool-result\") {\r\n          const toolCallId = content.toolCallId;\r\n\r\n          // Check if this result corresponds to a pending call\r\n          if (!pendingToolCalls.has(toolCallId)) {\r\n            return {\r\n              valid: false,\r\n              error: `Message ${i}: tool_result for ${toolCallId} has no corresponding tool_use`,\r\n            };\r\n          }\r\n\r\n          // Check if the tool call was in the immediately previous assistant message\r\n          const callIndex = pendingToolCalls.get(toolCallId);\r\n          if (callIndex !== i - 1) {\r\n            return {\r\n              valid: false,\r\n              error: `Message ${i}: tool_result for ${toolCallId} is not immediately after its tool_use (was in message ${callIndex ?? \"unknown\"})`,\r\n            };\r\n          }\r\n\r\n          pendingToolCalls.delete(toolCallId);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check for any remaining pending tool calls\r\n  if (pendingToolCalls.size > 0) {\r\n    const pendingIds = Array.from(pendingToolCalls.keys()).join(\", \");\r\n    return {\r\n      valid: false,\r\n      error: `Unresolved tool_use blocks without corresponding tool_result: ${pendingIds}`,\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\nfunction hasAnthropicThinkingSignature(part: { providerOptions?: unknown } | undefined): boolean {\r\n  const providerOptions = part?.providerOptions as\r\n    | { anthropic?: { signature?: unknown } }\r\n    | undefined;\r\n  return (\r\n    typeof providerOptions?.anthropic?.signature === \"string\" &&\r\n    providerOptions.anthropic.signature.length > 0\r\n  );\r\n}\r\n\r\n/**\r\n * Anthropic Extended Thinking self-healing check.\r\n *\r\n * When Anthropic `thinking` is enabled, the API requires that assistant messages containing\r\n * tool calls begin with a thinking block. The AI SDK only replays thinking blocks when the\r\n * reasoning part includes a valid Anthropic signature.\r\n *\r\n * If we have tool-call messages but no signed reasoning to replay, Anthropic rejects the\r\n * request with errors like:\r\n * \"Expected thinking or redacted_thinking, but found tool_use.\"\r\n *\r\n * In that case, the safest fallback is to disable thinking for the request.\r\n */\r\nexport function getAnthropicThinkingDisableReason(messages: ModelMessage[]): string | undefined {\r\n  for (let i = 0; i < messages.length; i++) {\r\n    const msg = messages[i];\r\n    if (msg.role !== \"assistant\") {\r\n      continue;\r\n    }\r\n\r\n    // String-only assistant messages never contain tool calls.\r\n    if (typeof msg.content === \"string\") {\r\n      continue;\r\n    }\r\n\r\n    // Treat unsigned reasoning as absent (the AI SDK will drop it).\r\n    const content = msg.content.filter(\r\n      (part) => part.type !== \"reasoning\" || hasAnthropicThinkingSignature(part)\r\n    );\r\n\r\n    const hasToolCall = content.some((part) => part.type === \"tool-call\");\r\n    if (!hasToolCall) {\r\n      continue;\r\n    }\r\n\r\n    const firstPart = content[0];\r\n    if (!firstPart) {\r\n      // Shouldn't happen, but defensively treat it as unsupported.\r\n      return `Message ${i}: tool-call assistant message became empty after stripping unsigned reasoning`;\r\n    }\r\n\r\n    if (firstPart.type !== \"reasoning\") {\r\n      return `Message ${i}: tool-call assistant message does not start with signed reasoning (starts with ${firstPart.type})`;\r\n    }\r\n\r\n    if (!hasAnthropicThinkingSignature(firstPart)) {\r\n      // Shouldn't happen because we filtered, but keep error message explicit.\r\n      return `Message ${i}: assistant message starts with reasoning but is missing anthropic.signature`;\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n"]}