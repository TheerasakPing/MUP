{"version":3,"file":"modelMessageTransform.js","sourceRoot":"","sources":["../../../../src/browser/utils/messages/modelMessageTransform.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Transform ModelMessages to ensure Anthropic API compliance.\n * This operates on already-converted ModelMessages from Vercel AI SDK.\n */\n\nimport type { ModelMessage, AssistantModelMessage, ToolModelMessage } from \"ai\";\nimport type { MuxMessage } from \"@/common/types/message\";\nimport type { EditedFileAttachment } from \"@/node/services/agentSession\";\nimport type { PostCompactionAttachment } from \"@/common/types/attachment\";\nimport { MAX_POST_COMPACTION_INJECTION_CHARS } from \"@/common/constants/attachments\";\nimport { findLatestCompactionBoundaryIndex } from \"@/common/utils/messages/compactionBoundary\";\nimport { renderAttachmentsToContentWithBudget } from \"./attachmentRenderer\";\n\n/**\n * Filter out assistant messages that are empty or only contain reasoning parts.\n * Empty messages (no parts or only empty text) and reasoning-only messages are\n * invalid for the API and provide no value to the model.\n *\n * Common scenarios:\n * 1. Placeholder messages with empty parts arrays (stream interrupted before any content)\n * 2. Messages interrupted during thinking phase before producing text\n *\n * EXCEPTION: When extended thinking is enabled, preserve reasoning-only messages.\n * The Extended Thinking API requires thinking blocks to be present in message history,\n * even if they were interrupted before producing text content.\n *\n * Note: This function filters out reasoning-only messages but does NOT strip reasoning\n * parts from messages that have other content. Reasoning parts are handled differently\n * per provider (see stripReasoningForOpenAI).\n *\n * @param messages - The messages to filter\n * @param preserveReasoningOnly - If true, keep reasoning-only messages (for Extended Thinking)\n */\nexport function filterEmptyAssistantMessages(\n  messages: MuxMessage[],\n  preserveReasoningOnly = false\n): MuxMessage[] {\n  return messages.filter((msg) => {\n    // Keep all non-assistant messages\n    if (msg.role !== \"assistant\") {\n      return true;\n    }\n\n    // Filter out messages with no parts at all (placeholder messages)\n    if (msg.parts?.length === 0) {\n      return false;\n    }\n\n    // Keep assistant messages that have at least one part that will survive\n    // conversion to provider ModelMessages.\n    //\n    // Important: We call convertToModelMessages(..., { ignoreIncompleteToolCalls: true }).\n    // That means *incomplete* tool calls (state: \"input-available\") will be dropped.\n    // If we treat them as content here, we can end up sending an assistant message that\n    // becomes empty after conversion, which the AI SDK rejects (\"all messages must have\n    // non-empty content...\") and can brick a workspace after a crash.\n    const hasContent = msg.parts.some((part) => {\n      if (part.type === \"text\") {\n        return part.text.trim().length > 0;\n      }\n\n      // Reasoning-only messages are handled below (provider-dependent).\n      if (part.type === \"reasoning\") {\n        return false;\n      }\n\n      if (part.type === \"dynamic-tool\") {\n        // Only completed tool calls produce content that can be replayed to the model.\n        return part.state === \"output-available\";\n      }\n\n      // File/image parts count as content.\n      if (part.type === \"file\") {\n        return true;\n      }\n\n      // Future-proofing: unknown parts should not brick the request.\n      return true;\n    });\n\n    if (hasContent) {\n      return true;\n    }\n\n    // If preserveReasoningOnly is enabled, keep messages with reasoning parts\n    // (needed for Extended Thinking API compliance)\n    if (preserveReasoningOnly) {\n      const hasReasoning = msg.parts.some((part) => part.type === \"reasoning\");\n      return hasReasoning;\n    }\n\n    return false;\n  });\n}\n\n/**\n * Add [CONTINUE] sentinel to partial messages by inserting a user message.\n * This helps the model understand that a message was interrupted and to continue.\n * The sentinel is ONLY for model context, not shown in UI.\n *\n * OPTIMIZATION: If a user message already follows the partial assistant message,\n * we skip the sentinel - the user message itself provides the continuation signal.\n * This saves tokens and creates more natural conversation flow.\n *\n * We insert a separate user message instead of modifying the assistant message\n * because if the assistant message only has reasoning (no text), it will be\n * filtered out, and we'd lose the interruption context. A user message always\n * survives filtering.\n */\nexport function addInterruptedSentinel(messages: MuxMessage[]): MuxMessage[] {\n  const result: MuxMessage[] = [];\n\n  for (let i = 0; i < messages.length; i++) {\n    const msg = messages[i];\n    result.push(msg);\n\n    // If this is a partial assistant message, conditionally insert [CONTINUE] sentinel\n    if (msg.role === \"assistant\" && msg.metadata?.partial) {\n      const nextMsg = messages[i + 1];\n\n      // Only add sentinel if there's NO user message following\n      // If user message follows, it provides the continuation context itself\n      if (!nextMsg || nextMsg.role !== \"user\") {\n        result.push({\n          id: `interrupted-${msg.id}`,\n          role: \"user\",\n          parts: [{ type: \"text\", text: \"[CONTINUE]\" }],\n          metadata: {\n            timestamp: msg.metadata.timestamp,\n            // Mark as synthetic so it can be identified if needed\n            synthetic: true,\n          },\n        });\n      }\n    }\n  }\n\n  return result;\n}\n\n/**\n * Inject agent transition context when the active agent changes mid-conversation.\n * Inserts a synthetic user message before the final user message to signal the agent switch.\n * This provides temporal context that helps models understand they should follow new agent instructions.\n *\n * When transitioning from plan → exec/orchestrator with plan content, includes the plan so the model\n * can evaluate its relevance to the current request.\n *\n * @param messages The conversation history\n * @param currentAgentId The agent id for the upcoming assistant response\n * @param toolNames Optional list of available tool names to include in transition message\n * @param planContent Optional plan content to include when transitioning plan → exec/orchestrator\n * @param planFilePath Optional plan file path to include when transitioning plan → exec/orchestrator\n * @returns Messages with agent transition context injected if needed\n */\nexport function injectAgentTransition(\n  messages: MuxMessage[],\n  currentAgentId?: string,\n  toolNames?: string[],\n  planContent?: string,\n  planFilePath?: string\n): MuxMessage[] {\n  // No agent specified, nothing to do\n  if (!currentAgentId) {\n    return messages;\n  }\n\n  // Need at least one message to have a conversation\n  if (messages.length === 0) {\n    return messages;\n  }\n\n  // Find the last assistant message to check its agent\n  const lastAssistantMessage = [...messages].reverse().find((m) => m.role === \"assistant\");\n  const lastAgentId = lastAssistantMessage?.metadata?.agentId;\n\n  // No agent transition if no previous agent or same agent\n  if (!lastAgentId || lastAgentId === currentAgentId) {\n    return messages;\n  }\n\n  // Agent transition detected! Inject a synthetic user message before the last user message\n  // This provides temporal context: user says \"switch agents\" before their actual request\n\n  // Find the index of the last user message\n  let lastUserIndex = -1;\n  for (let i = messages.length - 1; i >= 0; i--) {\n    if (messages[i].role === \"user\") {\n      lastUserIndex = i;\n      break;\n    }\n  }\n\n  // If there's no user message, can't inject transition (nothing to inject before)\n  if (lastUserIndex === -1) {\n    return messages;\n  }\n\n  const result: MuxMessage[] = [];\n\n  // Add all messages up to (but not including) the last user message\n  for (let i = 0; i < lastUserIndex; i++) {\n    result.push(messages[i]);\n  }\n\n  // Inject agent transition message right before the last user message\n  let transitionText = `[Agent switched from ${lastAgentId} to ${currentAgentId}. Follow ${currentAgentId} agent instructions.`;\n\n  // Append tool availability if provided\n  if (toolNames && toolNames.length > 0) {\n    transitionText += ` Available tools: ${toolNames.join(\", \")}.]`;\n  } else {\n    transitionText += \"]\";\n  }\n\n  // When transitioning from the plan agent to exec/orchestrator, include the plan for context.\n  // This avoids wasting tokens on tool calls just to re-read the plan file.\n  const transitioningFromPlan = lastAgentId === \"plan\";\n  const transitioningToExecOrOrchestrator =\n    currentAgentId === \"exec\" || currentAgentId === \"orchestrator\";\n  if (planContent && transitioningFromPlan && transitioningToExecOrOrchestrator) {\n    const planFilePathText = planFilePath ? `Plan file path: ${planFilePath}\\n\\n` : \"\";\n    const nextStepText =\n      currentAgentId === \"orchestrator\"\n        ? \"orchestrate its implementation (do not re-plan).\"\n        : \"implement it directly (do not re-plan).\";\n    const followupText =\n      currentAgentId === \"orchestrator\"\n        ? \"Only do extra exploration if the plan is missing critical details or conflicts with the repo:\"\n        : \"Only do extra exploration or spawn sub-agents if the plan is missing critical details or conflicts with the repo:\";\n    transitionText += `\n\n${planFilePathText}The following plan was developed in the plan agent. Based on the user's message, determine if they have accepted the plan. If accepted and relevant, ${nextStepText}\n${followupText}\n\n<plan>\n${planContent}\n</plan>`;\n  }\n\n  const transitionMessage: MuxMessage = {\n    id: `agent-transition-${Date.now()}`,\n    role: \"user\",\n    parts: [\n      {\n        type: \"text\",\n        text: transitionText,\n      },\n    ],\n    metadata: {\n      timestamp: Date.now(),\n      synthetic: true,\n    },\n  };\n  result.push(transitionMessage);\n\n  // Add the last user message and any remaining messages\n  for (let i = lastUserIndex; i < messages.length; i++) {\n    result.push(messages[i]);\n  }\n\n  return result;\n}\n\n/**\n * Inject file change notifications as a synthetic user message.\n * When files are modified externally (by user or linter), append a notification at the end\n * so the model is aware of changes without busting the system message cache.\n *\n * @param messages The conversation history\n * @param changedFileAttachments Files that were modified externally\n * @returns Messages with file change notification appended if any files changed\n */\nexport function injectFileChangeNotifications(\n  messages: MuxMessage[],\n  changedFileAttachments?: EditedFileAttachment[]\n): MuxMessage[] {\n  if (!changedFileAttachments || changedFileAttachments.length === 0) {\n    return messages;\n  }\n\n  const notice = changedFileAttachments\n    .map(\n      (att) =>\n        `Note: ${att.filename} was modified, either by the user or by a linter.\\n` +\n        `This change was intentional, so make sure to take it into account as you proceed ` +\n        `(i.e., don't revert it unless the user asks you to). Here are the relevant changes:\\n${att.snippet}`\n    )\n    .join(\"\\n\\n\");\n\n  const syntheticMessage: MuxMessage = {\n    id: `file-change-${Date.now()}`,\n    role: \"user\",\n    parts: [{ type: \"text\", text: `<system-file-update>\\n${notice}\\n</system-file-update>` }],\n    metadata: {\n      timestamp: Date.now(),\n      synthetic: true,\n    },\n  };\n\n  return [...messages, syntheticMessage];\n}\n\nfunction findLatestLegacyCompactionSummaryIndex(messages: MuxMessage[]): number {\n  for (let i = messages.length - 1; i >= 0; i -= 1) {\n    const message = messages[i];\n    if (message.role !== \"assistant\") {\n      continue;\n    }\n\n    const compacted = message.metadata?.compacted;\n    if (compacted === undefined || compacted === false) {\n      continue;\n    }\n\n    return i;\n  }\n\n  return -1;\n}\n\n/**\n * Inject post-compaction attachments as a synthetic user message.\n * When compaction occurs, this injects a message containing plan file content\n * and/or edited files to preserve context that would otherwise be lost.\n *\n * The message is inserted AFTER the compaction summary message to ensure\n * the model receives this context for the next turn.\n *\n * @param messages The conversation history\n * @param attachments Post-compaction attachments (plan file, edited files)\n * @returns Messages with attachments injected after compaction summary\n */\nexport function injectPostCompactionAttachments(\n  messages: MuxMessage[],\n  attachments?: PostCompactionAttachment[] | null\n): MuxMessage[] {\n  if (!attachments || attachments.length === 0) {\n    return messages;\n  }\n\n  const durableCompactionIndex = findLatestCompactionBoundaryIndex(messages);\n  // Durable boundaries are authoritative for current histories. Legacy histories\n  // only have metadata.compacted, so fall back to that marker when needed.\n  const compactionIndex =\n    durableCompactionIndex !== -1\n      ? durableCompactionIndex\n      : findLatestLegacyCompactionSummaryIndex(messages);\n\n  if (compactionIndex === -1) {\n    // No compaction message found - this shouldn't happen if attachments are provided,\n    // but append at end as a fallback\n    const syntheticMessage: MuxMessage = {\n      id: `post-compaction-${Date.now()}`,\n      role: \"user\",\n      parts: [\n        {\n          type: \"text\",\n          text: renderAttachmentsToContentWithBudget(attachments, {\n            maxChars: MAX_POST_COMPACTION_INJECTION_CHARS,\n          }),\n        },\n      ],\n      metadata: {\n        timestamp: Date.now(),\n        synthetic: true,\n      },\n    };\n    return [...messages, syntheticMessage];\n  }\n\n  // Insert the synthetic message immediately after the compaction summary\n  const syntheticMessage: MuxMessage = {\n    id: `post-compaction-${Date.now()}`,\n    role: \"user\",\n    parts: [\n      {\n        type: \"text\",\n        text: renderAttachmentsToContentWithBudget(attachments, {\n          maxChars: MAX_POST_COMPACTION_INJECTION_CHARS,\n        }),\n      },\n    ],\n    metadata: {\n      timestamp: messages[compactionIndex].metadata?.timestamp ?? Date.now(),\n      synthetic: true,\n    },\n  };\n\n  const result = [...messages];\n  result.splice(compactionIndex + 1, 0, syntheticMessage);\n  return result;\n}\n\n/**\n * Filter out assistant messages that only contain reasoning parts (no text or tool parts).\n * Anthropic API rejects messages that have reasoning but no actual content.\n * This happens when a message is interrupted during thinking before producing any text.\n */\n/**\n * Split assistant messages with mixed text and tool calls into separate messages\n * to comply with Anthropic's requirement that tool_use blocks must be immediately\n * followed by their tool_result blocks without intervening text.\n */\nfunction splitMixedContentMessages(messages: ModelMessage[]): ModelMessage[] {\n  const result: ModelMessage[] = [];\n\n  for (let i = 0; i < messages.length; i++) {\n    const msg = messages[i];\n\n    if (msg.role !== \"assistant\") {\n      result.push(msg);\n      continue;\n    }\n\n    const assistantMsg = msg;\n\n    if (typeof assistantMsg.content === \"string\") {\n      result.push(msg);\n      continue;\n    }\n\n    const toolCallParts = assistantMsg.content.filter((c) => c.type === \"tool-call\");\n\n    if (toolCallParts.length === 0) {\n      result.push(msg);\n      continue;\n    }\n\n    const nextMsg = messages[i + 1];\n    const hasToolResults = nextMsg?.role === \"tool\";\n\n    if (!hasToolResults) {\n      result.push(msg);\n      continue;\n    }\n\n    const toolMsg = nextMsg;\n\n    type ContentArray = Exclude<typeof assistantMsg.content, string>;\n    const groups: Array<{ type: \"text\" | \"tool-call\"; parts: ContentArray }> = [];\n    let currentGroup: { type: \"text\" | \"tool-call\"; parts: ContentArray } | null = null;\n\n    for (const part of assistantMsg.content) {\n      const partType = part.type === \"tool-call\" ? \"tool-call\" : \"text\";\n\n      // eslint-disable-next-line @typescript-eslint/prefer-optional-chain\n      if (!currentGroup || currentGroup.type !== partType) {\n        if (currentGroup) groups.push(currentGroup);\n        currentGroup = { type: partType, parts: [] };\n      }\n\n      currentGroup.parts.push(part);\n    }\n\n    if (currentGroup) {\n      groups.push(currentGroup);\n    }\n\n    if (groups.length <= 1) {\n      result.push(msg);\n      continue;\n    }\n\n    const toolResultsById = new Map<string, Array<ToolModelMessage[\"content\"][number]>>();\n    for (const content of toolMsg.content) {\n      if (content.type === \"tool-result\") {\n        const existing = toolResultsById.get(content.toolCallId);\n        if (existing) {\n          existing.push(content);\n        } else {\n          toolResultsById.set(content.toolCallId, [content]);\n        }\n      }\n    }\n\n    for (let groupIndex = 0; groupIndex < groups.length; groupIndex++) {\n      const group = groups[groupIndex];\n      if (group.parts.length === 0) {\n        continue;\n      }\n\n      // If text is immediately followed by tool calls, keep them together.\n      // Text before tool_use is allowed by Anthropic; only *text after tool_use* is invalid.\n      if (group.type === \"text\") {\n        const nextGroup = groups[groupIndex + 1];\n        if (nextGroup?.type === \"tool-call\" && nextGroup.parts.length > 0) {\n          const toolPartsToInclude = nextGroup.parts.filter(\n            (p) => p.type === \"tool-call\" && toolResultsById.has(p.toolCallId)\n          );\n\n          // If none of the tool calls have results, keep just the text portion.\n          if (toolPartsToInclude.length === 0) {\n            result.push({ role: \"assistant\", content: group.parts });\n            groupIndex++;\n            continue;\n          }\n\n          const newAssistantMsg: AssistantModelMessage = {\n            role: \"assistant\",\n            content: [...group.parts, ...toolPartsToInclude],\n          };\n          result.push(newAssistantMsg);\n\n          const relevantResults: ToolModelMessage[\"content\"] = [];\n          for (const part of toolPartsToInclude) {\n            if (part.type !== \"tool-call\") {\n              continue;\n            }\n            const results = toolResultsById.get(part.toolCallId);\n            if (results) {\n              relevantResults.push(...results);\n              toolResultsById.delete(part.toolCallId);\n            }\n          }\n\n          if (relevantResults.length > 0) {\n            const newToolMsg: ToolModelMessage = {\n              role: \"tool\",\n              content: relevantResults,\n            };\n            result.push(newToolMsg);\n          }\n\n          groupIndex++;\n          continue;\n        }\n\n        result.push({ role: \"assistant\", content: group.parts });\n        continue;\n      }\n\n      const partsToInclude = group.parts.filter(\n        (p) => p.type === \"tool-call\" && toolResultsById.has(p.toolCallId)\n      );\n\n      if (partsToInclude.length === 0) {\n        continue;\n      }\n\n      const newAssistantMsg: AssistantModelMessage = {\n        role: \"assistant\",\n        content: partsToInclude,\n      };\n      result.push(newAssistantMsg);\n\n      const relevantResults: ToolModelMessage[\"content\"] = [];\n      for (const part of partsToInclude) {\n        if (part.type !== \"tool-call\") {\n          continue;\n        }\n        const results = toolResultsById.get(part.toolCallId);\n        if (results) {\n          relevantResults.push(...results);\n          toolResultsById.delete(part.toolCallId);\n        }\n      }\n\n      if (relevantResults.length > 0) {\n        const newToolMsg: ToolModelMessage = {\n          role: \"tool\",\n          content: relevantResults,\n        };\n        result.push(newToolMsg);\n      }\n    }\n\n    i++;\n  }\n\n  return result;\n}\n\nfunction filterReasoningOnlyMessages(messages: ModelMessage[]): ModelMessage[] {\n  return messages.filter((msg) => {\n    if (msg.role !== \"assistant\") {\n      return true;\n    }\n\n    // Check if content is string or array\n    if (typeof msg.content === \"string\") {\n      return msg.content.trim().length > 0;\n    }\n\n    // For array content, check if there's at least one non-reasoning part\n    const hasNonReasoningContent = msg.content.some((part) => part.type !== \"reasoning\");\n\n    return hasNonReasoningContent;\n  });\n}\n\n/**\n * Remove tool-call/tool-result parts that do not have a matching counterpart.\n *\n * Some providers (e.g., OpenAI responses) reject requests when a tool call is\n * present without its tool output. If history is interrupted or corrupted, we\n * can end up with orphaned tool-call/tool-result parts. Drop them to keep the\n * request valid and self-healing.\n */\nexport function stripOrphanedToolCalls(messages: ModelMessage[]): ModelMessage[] {\n  const toolCallIds = new Set<string>();\n  const toolResultIds = new Set<string>();\n\n  for (const msg of messages) {\n    if (msg.role === \"assistant\") {\n      const assistantMsg = msg;\n      if (typeof assistantMsg.content === \"string\") {\n        continue;\n      }\n      for (const part of assistantMsg.content) {\n        if (part.type === \"tool-call\") {\n          toolCallIds.add(part.toolCallId);\n        }\n        if (part.type === \"tool-result\") {\n          toolResultIds.add(part.toolCallId);\n        }\n      }\n      continue;\n    }\n\n    if (msg.role === \"tool\") {\n      const toolMsg = msg;\n      for (const part of toolMsg.content) {\n        if (part.type === \"tool-result\") {\n          toolResultIds.add(part.toolCallId);\n        }\n      }\n    }\n  }\n\n  const missingResults = new Set(\n    [...toolCallIds].filter((toolCallId) => !toolResultIds.has(toolCallId))\n  );\n  const orphanResults = new Set(\n    [...toolResultIds].filter((toolCallId) => !toolCallIds.has(toolCallId))\n  );\n\n  if (missingResults.size === 0 && orphanResults.size === 0) {\n    return messages;\n  }\n\n  const cleaned: ModelMessage[] = [];\n\n  for (const msg of messages) {\n    if (msg.role === \"assistant\") {\n      const assistantMsg = msg;\n      if (typeof assistantMsg.content === \"string\") {\n        cleaned.push(msg);\n        continue;\n      }\n\n      const filteredContent = assistantMsg.content.filter((part) => {\n        if (part.type === \"tool-call\") {\n          return !missingResults.has(part.toolCallId);\n        }\n        if (part.type === \"tool-result\") {\n          return !orphanResults.has(part.toolCallId);\n        }\n        return true;\n      });\n\n      if (filteredContent.length === 0) {\n        continue;\n      }\n\n      if (filteredContent.length === assistantMsg.content.length) {\n        cleaned.push(msg);\n      } else {\n        cleaned.push({\n          ...assistantMsg,\n          content: filteredContent,\n        });\n      }\n      continue;\n    }\n\n    if (msg.role === \"tool\") {\n      const toolMsg = msg;\n      const filteredContent = toolMsg.content.filter((part) => {\n        if (part.type !== \"tool-result\") {\n          return true;\n        }\n        return !orphanResults.has(part.toolCallId);\n      });\n\n      if (filteredContent.length === 0) {\n        continue;\n      }\n\n      if (filteredContent.length === toolMsg.content.length) {\n        cleaned.push(msg);\n      } else {\n        cleaned.push({\n          ...toolMsg,\n          content: filteredContent,\n        });\n      }\n      continue;\n    }\n\n    cleaned.push(msg);\n  }\n\n  return cleaned;\n}\n\n/**\n * Coalesce consecutive no-progress `task_await` tool-call/tool-result message pairs.\n *\n * `task_await` is commonly polled in a loop while waiting on sub-agent tasks.\n * When there's no new output, those polls add near-duplicate tool messages to\n * provider context, increasing tokens without adding information.\n *\n * This pass removes consecutive *identical* no-progress pairs (same tool input\n * fingerprint), keeping only the last pair in each run.\n *\n * IMPORTANT: To preserve Anthropic tool_use/tool_result adjacency rules, we only\n * remove messages in (assistant + immediately following tool) pairs.\n *\n * Self-healing: If we see anything unexpected (shape mismatch, unstringifiable\n * inputs, unparseable outputs), we leave messages unchanged.\n */\nfunction coalesceConsecutiveNoProgressTaskAwaitPairs(messages: ModelMessage[]): ModelMessage[] {\n  function tryJsonStringify(value: unknown): string | undefined {\n    try {\n      const result = JSON.stringify(value);\n      if (typeof result !== \"string\") {\n        return undefined;\n      }\n      return result;\n    } catch {\n      return undefined;\n    }\n  }\n\n  function getToolCallInputFingerprint(\n    part: { input?: unknown } | { args?: unknown }\n  ): string | undefined {\n    const input = (part as { input?: unknown }).input ?? (part as { args?: unknown }).args;\n    return tryJsonStringify(input);\n  }\n\n  function extractToolResultValue(part: { output?: unknown } | { result?: unknown }): unknown {\n    const raw = (part as { result?: unknown }).result ?? (part as { output?: unknown }).output;\n\n    // The AI SDK wraps tool results as `{ type: 'json' | 'text', value: unknown }`.\n    if (raw && typeof raw === \"object\" && \"type\" in raw && \"value\" in raw) {\n      return (raw as { value?: unknown }).value;\n    }\n\n    return raw;\n  }\n\n  function isNoProgressTaskAwaitResultValue(value: unknown): boolean {\n    if (!value || typeof value !== \"object\") {\n      return false;\n    }\n\n    const results = (value as { results?: unknown }).results;\n    if (!Array.isArray(results)) {\n      return false;\n    }\n\n    for (const entry of results) {\n      if (!entry || typeof entry !== \"object\") {\n        return false;\n      }\n\n      const status = (entry as { status?: unknown }).status;\n      if (status !== \"queued\" && status !== \"running\" && status !== \"awaiting_report\") {\n        return false;\n      }\n\n      // Treat any non-empty output/report as progress.\n      const output = (entry as { output?: unknown }).output;\n      if (output !== undefined) {\n        if (typeof output !== \"string\") {\n          return false;\n        }\n        if (output.length > 0) {\n          return false;\n        }\n      }\n\n      const reportMarkdown = (entry as { reportMarkdown?: unknown }).reportMarkdown;\n      if (typeof reportMarkdown === \"string\" && reportMarkdown.length > 0) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  function getTaskAwaitPairInfo(\n    allMessages: ModelMessage[],\n    index: number\n  ):\n    | {\n        fingerprint: string;\n        noProgress: boolean;\n      }\n    | undefined {\n    const assistantMsg = allMessages[index];\n    const toolMsg = allMessages[index + 1];\n\n    if (!assistantMsg || !toolMsg) {\n      return undefined;\n    }\n\n    if (assistantMsg.role !== \"assistant\" || toolMsg.role !== \"tool\") {\n      return undefined;\n    }\n\n    const assistant = assistantMsg;\n    if (typeof assistant.content === \"string\") {\n      return undefined;\n    }\n\n    if (assistant.content.length !== 1) {\n      return undefined;\n    }\n\n    const toolCallPart = assistant.content[0];\n    if (toolCallPart?.type !== \"tool-call\") {\n      return undefined;\n    }\n\n    if (toolCallPart.toolName !== \"task_await\") {\n      return undefined;\n    }\n\n    const fingerprint = getToolCallInputFingerprint(toolCallPart);\n    if (!fingerprint) {\n      return undefined;\n    }\n\n    if (!Array.isArray(toolMsg.content) || toolMsg.content.length !== 1) {\n      return undefined;\n    }\n\n    const toolResultPart = toolMsg.content[0];\n    if (toolResultPart?.type !== \"tool-result\") {\n      return undefined;\n    }\n\n    if (toolResultPart.toolName !== \"task_await\") {\n      return undefined;\n    }\n\n    // Only coalesce when the tool-result matches the immediately preceding tool-call.\n    if (toolResultPart.toolCallId !== toolCallPart.toolCallId) {\n      return undefined;\n    }\n\n    const toolResultValue = extractToolResultValue(toolResultPart);\n\n    return {\n      fingerprint,\n      noProgress: isNoProgressTaskAwaitResultValue(toolResultValue),\n    };\n  }\n\n  try {\n    let changed = false;\n    const result: ModelMessage[] = [];\n\n    for (let i = 0; i < messages.length; ) {\n      const info = getTaskAwaitPairInfo(messages, i);\n      if (!info) {\n        result.push(messages[i]);\n        i++;\n        continue;\n      }\n\n      // Not a no-progress poll, keep it.\n      if (!info.noProgress) {\n        result.push(messages[i], messages[i + 1]);\n        i += 2;\n        continue;\n      }\n\n      // Scan ahead for a run of consecutive identical no-progress polls.\n      let runEnd = i;\n      for (let j = i + 2; j < messages.length; j += 2) {\n        const nextInfo = getTaskAwaitPairInfo(messages, j);\n        if (!nextInfo) {\n          break;\n        }\n        if (!nextInfo.noProgress) {\n          break;\n        }\n        if (nextInfo.fingerprint !== info.fingerprint) {\n          break;\n        }\n        runEnd = j;\n      }\n\n      if (runEnd !== i) {\n        changed = true;\n      }\n\n      result.push(messages[runEnd], messages[runEnd + 1]);\n      i = runEnd + 2;\n    }\n\n    return changed ? result : messages;\n  } catch {\n    // Self-healing: request-time transforms should never brick a workspace.\n    return messages;\n  }\n}\n/**\n * Strip Anthropic reasoning parts that lack a valid signature.\n *\n * Anthropic's Extended Thinking API requires thinking blocks to include a signature\n * for replay. The Vercel AI SDK's Anthropic provider only sends reasoning parts to\n * the API if they have providerOptions.anthropic.signature. Reasoning parts we create\n * (placeholders) or from history (where we didn't capture the signature) will be\n * silently dropped by the SDK.\n *\n * If all parts of an assistant message are unsigned reasoning, the SDK drops them all,\n * leaving an empty message that Anthropic rejects with:\n * \"all messages must have non-empty content except for the optional final assistant message\"\n *\n * This function removes unsigned reasoning upfront and filters resulting empty messages.\n *\n * NOTE: This is Anthropic-specific. Other providers (e.g., OpenAI) handle reasoning\n * differently and don't require signatures.\n */\nfunction stripUnsignedAnthropicReasoning(messages: ModelMessage[]): ModelMessage[] {\n  const stripped = messages.map((msg) => {\n    if (msg.role !== \"assistant\") {\n      return msg;\n    }\n\n    const assistantMsg = msg;\n    if (typeof assistantMsg.content === \"string\") {\n      return msg;\n    }\n\n    // Filter out reasoning parts without anthropic.signature in providerOptions\n    const content = assistantMsg.content.filter((part) => {\n      if (part.type !== \"reasoning\") {\n        return true;\n      }\n      // Check for anthropic.signature in providerOptions\n      const anthropicMeta = (part.providerOptions as { anthropic?: { signature?: string } })\n        ?.anthropic;\n      return anthropicMeta?.signature != null;\n    });\n\n    const result: typeof assistantMsg = { ...assistantMsg, content };\n    return result;\n  });\n\n  // Filter out messages that became empty after stripping reasoning.\n  //\n  // Important: Anthropic rejects whitespace-only text content blocks (e.g. \"\\n\\n\").\n  // If we strip unsigned reasoning from an interrupted message, we can be left with\n  // only whitespace text, which would otherwise survive a simple `content.length > 0` check.\n  return stripped.filter((msg) => {\n    if (msg.role !== \"assistant\") {\n      return true;\n    }\n\n    if (typeof msg.content === \"string\") {\n      return msg.content.trim().length > 0;\n    }\n\n    return msg.content.some((part) => part.type !== \"text\" || part.text.trim().length > 0);\n  });\n}\n\n/**\n * Coalesce consecutive parts of the same type within each message.\n * Streaming creates many individual text/reasoning parts; merge them for easier debugging.\n * Also reduces JSON overhead when sending messages to the API.\n * Tool calls remain atomic (not merged).\n */\nfunction coalesceConsecutiveParts(messages: ModelMessage[]): ModelMessage[] {\n  return messages.map((msg) => {\n    // Only process assistant messages with array content\n    if (msg.role !== \"assistant\") {\n      return msg;\n    }\n\n    const assistantMsg = msg;\n\n    // Skip string content\n    if (typeof assistantMsg.content === \"string\") {\n      return msg;\n    }\n\n    // Now TypeScript knows content is an array\n    type ContentArray = Exclude<typeof assistantMsg.content, string>;\n    const coalesced: ContentArray = [];\n\n    for (const part of assistantMsg.content) {\n      const lastPart = coalesced[coalesced.length - 1];\n\n      // Merge consecutive text parts\n      if (part.type === \"text\" && lastPart?.type === \"text\") {\n        lastPart.text += part.text;\n        continue;\n      }\n\n      // Merge consecutive reasoning parts (extended thinking)\n      if (part.type === \"reasoning\" && lastPart?.type === \"reasoning\") {\n        lastPart.text += part.text;\n        // Preserve signature from later parts - during streaming, the signature\n        // arrives at the end and is attached to the last reasoning part.\n        // Cast needed because AI SDK's ReasoningPart doesn't have signature,\n        // but our MuxReasoningPart (which flows through convertToModelMessages) does.\n        const partWithSig = part as typeof part & {\n          signature?: string;\n          providerOptions?: { anthropic?: { signature?: string } };\n        };\n        const lastWithSig = lastPart as typeof lastPart & {\n          signature?: string;\n          providerOptions?: { anthropic?: { signature?: string } };\n        };\n        if (partWithSig.signature) {\n          lastWithSig.signature = partWithSig.signature;\n        }\n        if (partWithSig.providerOptions) {\n          lastWithSig.providerOptions = partWithSig.providerOptions;\n        }\n        continue;\n      }\n\n      // Keep tool calls and first occurrence of each type\n      coalesced.push(part);\n    }\n\n    return {\n      ...assistantMsg,\n      content: coalesced,\n    };\n  });\n}\n/**\n * Merge consecutive user messages with newline separators.\n * When filtering removes assistant messages, we can end up with consecutive user messages.\n * Anthropic requires alternating user/assistant, so we merge them.\n */\nfunction mergeConsecutiveUserMessages(messages: ModelMessage[]): ModelMessage[] {\n  const merged: ModelMessage[] = [];\n\n  for (const msg of messages) {\n    if (msg.role === \"user\" && merged.length > 0 && merged[merged.length - 1].role === \"user\") {\n      // Consecutive user message - merge with previous\n      const prevMsg = merged[merged.length - 1];\n\n      // Get text content from both messages\n      const prevText = Array.isArray(prevMsg.content)\n        ? (prevMsg.content.find((c) => c.type === \"text\")?.text ?? \"\")\n        : prevMsg.content;\n\n      const currentText = Array.isArray(msg.content)\n        ? (msg.content.find((c) => c.type === \"text\")?.text ?? \"\")\n        : typeof msg.content === \"string\"\n          ? msg.content\n          : \"\";\n\n      // Merge with newline prefix\n      const mergedText = prevText + \"\\n\" + currentText;\n\n      // Collect file/image parts from both messages\n      const prevImageParts = Array.isArray(prevMsg.content)\n        ? prevMsg.content.filter((c) => c.type === \"file\")\n        : [];\n      const currentImageParts = Array.isArray(msg.content)\n        ? msg.content.filter((c) => c.type === \"file\")\n        : [];\n\n      // Update the previous message with merged text and all image parts\n      merged[merged.length - 1] = {\n        role: \"user\",\n        content: [\n          { type: \"text\" as const, text: mergedText },\n          ...prevImageParts,\n          ...currentImageParts,\n        ],\n      };\n    } else {\n      // Not consecutive user message, add as-is\n      merged.push(msg);\n    }\n  }\n\n  return merged;\n}\n\nfunction ensureAnthropicThinkingBeforeToolCalls(messages: ModelMessage[]): ModelMessage[] {\n  const result: ModelMessage[] = [];\n\n  for (const msg of messages) {\n    if (msg.role !== \"assistant\") {\n      result.push(msg);\n      continue;\n    }\n\n    const assistantMsg = msg;\n    if (typeof assistantMsg.content === \"string\") {\n      result.push(msg);\n      continue;\n    }\n\n    const content = assistantMsg.content;\n    const hasToolCall = content.some((part) => part.type === \"tool-call\");\n    if (!hasToolCall) {\n      result.push(msg);\n      continue;\n    }\n\n    let reasoningParts = content.filter((part) => part.type === \"reasoning\");\n    const nonReasoningParts = content.filter((part) => part.type !== \"reasoning\");\n\n    // If no reasoning is present, try to merge it from the immediately preceding assistant message\n    // if that message consists of reasoning-only parts. This commonly happens after splitting.\n    if (reasoningParts.length === 0 && result.length > 0) {\n      const prev = result[result.length - 1];\n      if (prev.role === \"assistant\") {\n        const prevAssistant = prev;\n        if (typeof prevAssistant.content !== \"string\") {\n          const prevIsReasoningOnly =\n            prevAssistant.content.length > 0 &&\n            prevAssistant.content.every((part) => part.type === \"reasoning\");\n          if (prevIsReasoningOnly) {\n            result.pop();\n            reasoningParts = prevAssistant.content.filter((part) => part.type === \"reasoning\");\n          }\n        }\n      }\n    }\n\n    // Anthropic extended thinking requires tool-use assistant messages to start with a thinking block.\n    // If we still have no reasoning available, insert a minimal placeholder reasoning part.\n    // NOTE: The text cannot be empty - Anthropic API rejects empty content.\n    if (reasoningParts.length === 0) {\n      reasoningParts = [{ type: \"reasoning\" as const, text: \"...\" }];\n    }\n\n    result.push({\n      ...assistantMsg,\n      content: [...reasoningParts, ...nonReasoningParts],\n    });\n  }\n\n  // Anthropic extended thinking also requires the *final* assistant message in the request\n  // to start with a thinking block. If the last assistant message is text-only (common for\n  // synthetic messages like sub-agent reports), insert an empty reasoning part as a minimal\n  // placeholder. This transformation affects only the provider request, not stored history/UI.\n  for (let i = result.length - 1; i >= 0; i--) {\n    const msg = result[i];\n    if (msg.role !== \"assistant\") {\n      continue;\n    }\n\n    const assistantMsg = msg;\n\n    if (typeof assistantMsg.content === \"string\") {\n      // String-only assistant messages need converting to part arrays to insert reasoning.\n      const text = assistantMsg.content;\n      // If it's truly empty, leave it unchanged (it will be filtered elsewhere).\n      if (text.length === 0) break;\n      result[i] = {\n        ...assistantMsg,\n        content: [\n          { type: \"reasoning\" as const, text: \"...\" },\n          { type: \"text\" as const, text },\n        ],\n      };\n      break;\n    }\n\n    const content = assistantMsg.content;\n    if (content.length === 0) {\n      break;\n    }\n    if (content[0].type === \"reasoning\") {\n      break;\n    }\n\n    result[i] = {\n      ...assistantMsg,\n      content: [{ type: \"reasoning\" as const, text: \"...\" }, ...content],\n    };\n    break;\n  }\n\n  return result;\n}\n\n/**\n * Transform messages to ensure provider API compliance.\n * Applies multiple transformation passes based on provider requirements:\n * 0. Coalesce consecutive parts (text/reasoning) - all providers, reduces JSON overhead\n * 1. Split mixed content messages (text + tool calls) - all providers\n * 2. Drop orphaned tool calls/results (self-healing)\n * 3. Coalesce consecutive no-progress `task_await` polls - all providers\n * 4. Filter reasoning-only messages:\n *    - OpenAI: Keep reasoning parts (managed via previousResponseId), filter reasoning-only messages\n *    - Anthropic: Filter out reasoning-only messages (API rejects them)\n * 5. Merge consecutive user messages - all providers\n *\n * Note: encryptedContent stripping happens earlier in streamManager when tool results\n * are first stored, not during message transformation.\n *\n * @param messages The messages to transform\n * @param provider The provider name (e.g., \"anthropic\", \"openai\")\n */\nexport function transformModelMessages(\n  messages: ModelMessage[],\n  provider: string,\n  options?: {\n    anthropicThinkingEnabled?: boolean;\n  }\n): ModelMessage[] {\n  // Pass 0: Coalesce consecutive parts to reduce JSON overhead from streaming (applies to all providers)\n  const coalesced = coalesceConsecutiveParts(messages);\n\n  // Pass 1: Split mixed content messages (applies to all providers)\n  const split = splitMixedContentMessages(coalesced);\n\n  // Pass 2: Drop orphaned tool-call/tool-result pairs (applies to all providers)\n  const toolPaired = stripOrphanedToolCalls(split);\n\n  // Pass 3: Coalesce consecutive no-progress task_await polls (applies to all providers)\n  const taskAwaitCoalesced = coalesceConsecutiveNoProgressTaskAwaitPairs(toolPaired);\n\n  // Pass 4: Provider-specific reasoning handling\n  let reasoningHandled: ModelMessage[];\n  if (provider === \"openai\") {\n    // OpenAI: Keep reasoning parts - managed via previousResponseId\n    // Only filter out reasoning-only messages (messages with no text/tool-call content)\n    reasoningHandled = filterReasoningOnlyMessages(taskAwaitCoalesced);\n  } else if (provider === \"anthropic\") {\n    // Anthropic: When extended thinking is enabled, preserve reasoning-only messages and ensure\n    // tool-call messages start with reasoning. When it's disabled, filter reasoning-only messages.\n    if (options?.anthropicThinkingEnabled) {\n      // First strip reasoning without signatures (SDK will drop them anyway, causing empty messages)\n      const signedReasoning = stripUnsignedAnthropicReasoning(taskAwaitCoalesced);\n      reasoningHandled = ensureAnthropicThinkingBeforeToolCalls(signedReasoning);\n    } else {\n      reasoningHandled = filterReasoningOnlyMessages(taskAwaitCoalesced);\n    }\n  } else {\n    // Unknown provider: no reasoning handling\n    reasoningHandled = taskAwaitCoalesced;\n  }\n\n  // Pass 5: Merge consecutive user messages (applies to all providers)\n  const merged = mergeConsecutiveUserMessages(reasoningHandled);\n\n  return merged;\n}\n\n/**\n * Validate that the transformed messages follow Anthropic's requirements:\n * - Every tool-call must be immediately followed by its tool-result message\n */\nexport function validateAnthropicCompliance(messages: ModelMessage[]): {\n  valid: boolean;\n  error?: string;\n} {\n  const pendingToolCalls = new Map<string, number>(); // toolCallId -> message index\n\n  for (let i = 0; i < messages.length; i++) {\n    const msg = messages[i];\n\n    if (msg.role === \"assistant\") {\n      const assistantMsg = msg;\n\n      // Skip if content is just a string\n      if (typeof assistantMsg.content === \"string\") {\n        continue;\n      }\n\n      // Track any tool calls in this message\n      for (const content of assistantMsg.content) {\n        if (content.type === \"tool-call\") {\n          pendingToolCalls.set(content.toolCallId, i);\n        }\n      }\n\n      // If we have pending tool calls and encounter text or more tool calls,\n      // check if the next message has the results\n      if (pendingToolCalls.size > 0) {\n        const nextMsg = messages[i + 1];\n\n        // The next message MUST be a tool result message if we have pending calls\n        if (nextMsg?.role !== \"tool\") {\n          const pendingIds = Array.from(pendingToolCalls.keys()).join(\", \");\n          return {\n            valid: false,\n            error: `Message ${i}: tool_use blocks found without tool_result blocks immediately after: ${pendingIds}`,\n          };\n        }\n      }\n    } else if (msg.role === \"tool\") {\n      const toolMsg = msg;\n\n      // Process tool results and clear pending calls\n      for (const content of toolMsg.content) {\n        if (content.type === \"tool-result\") {\n          const toolCallId = content.toolCallId;\n\n          // Check if this result corresponds to a pending call\n          if (!pendingToolCalls.has(toolCallId)) {\n            return {\n              valid: false,\n              error: `Message ${i}: tool_result for ${toolCallId} has no corresponding tool_use`,\n            };\n          }\n\n          // Check if the tool call was in the immediately previous assistant message\n          const callIndex = pendingToolCalls.get(toolCallId);\n          if (callIndex !== i - 1) {\n            return {\n              valid: false,\n              error: `Message ${i}: tool_result for ${toolCallId} is not immediately after its tool_use (was in message ${callIndex ?? \"unknown\"})`,\n            };\n          }\n\n          pendingToolCalls.delete(toolCallId);\n        }\n      }\n    }\n  }\n\n  // Check for any remaining pending tool calls\n  if (pendingToolCalls.size > 0) {\n    const pendingIds = Array.from(pendingToolCalls.keys()).join(\", \");\n    return {\n      valid: false,\n      error: `Unresolved tool_use blocks without corresponding tool_result: ${pendingIds}`,\n    };\n  }\n\n  return { valid: true };\n}\n\nfunction hasAnthropicThinkingSignature(part: { providerOptions?: unknown } | undefined): boolean {\n  const providerOptions = part?.providerOptions as\n    | { anthropic?: { signature?: unknown } }\n    | undefined;\n  return (\n    typeof providerOptions?.anthropic?.signature === \"string\" &&\n    providerOptions.anthropic.signature.length > 0\n  );\n}\n\n/**\n * Anthropic Extended Thinking self-healing check.\n *\n * When Anthropic `thinking` is enabled, the API requires that assistant messages containing\n * tool calls begin with a thinking block. The AI SDK only replays thinking blocks when the\n * reasoning part includes a valid Anthropic signature.\n *\n * If we have tool-call messages but no signed reasoning to replay, Anthropic rejects the\n * request with errors like:\n * \"Expected thinking or redacted_thinking, but found tool_use.\"\n *\n * In that case, the safest fallback is to disable thinking for the request.\n */\nexport function getAnthropicThinkingDisableReason(messages: ModelMessage[]): string | undefined {\n  for (let i = 0; i < messages.length; i++) {\n    const msg = messages[i];\n    if (msg.role !== \"assistant\") {\n      continue;\n    }\n\n    // String-only assistant messages never contain tool calls.\n    if (typeof msg.content === \"string\") {\n      continue;\n    }\n\n    // Treat unsigned reasoning as absent (the AI SDK will drop it).\n    const content = msg.content.filter(\n      (part) => part.type !== \"reasoning\" || hasAnthropicThinkingSignature(part)\n    );\n\n    const hasToolCall = content.some((part) => part.type === \"tool-call\");\n    if (!hasToolCall) {\n      continue;\n    }\n\n    const firstPart = content[0];\n    if (!firstPart) {\n      // Shouldn't happen, but defensively treat it as unsupported.\n      return `Message ${i}: tool-call assistant message became empty after stripping unsigned reasoning`;\n    }\n\n    if (firstPart.type !== \"reasoning\") {\n      return `Message ${i}: tool-call assistant message does not start with signed reasoning (starts with ${firstPart.type})`;\n    }\n\n    if (!hasAnthropicThinkingSignature(firstPart)) {\n      // Shouldn't happen because we filtered, but keep error message explicit.\n      return `Message ${i}: assistant message starts with reasoning but is missing anthropic.signature`;\n    }\n  }\n\n  return undefined;\n}\n"]}