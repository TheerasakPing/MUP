{"version":3,"file":"sanitizeToolInput.js","sourceRoot":"","sources":["../../../../src/browser/utils/messages/sanitizeToolInput.ts"],"names":[],"mappings":";;;AAEA;;;;;;;;;;;;;;GAcG;AACH,4BAAmC,QAAsB,EAAgB;IACvE,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;QAC3B,kDAAkD;QAClD,IAAI,GAAG,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;YAC7B,OAAO,GAAG,CAAC;QACb,CAAC;QAED,uCAAuC;QACvC,MAAM,iBAAiB,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,CACtC,CAAC,IAAI,EAAE,EAAE,CACP,IAAI,CAAC,IAAI,KAAK,cAAc;YAC5B,CAAC,OAAO,IAAI,CAAC,KAAK,KAAK,QAAQ,IAAI,IAAI,CAAC,KAAK,KAAK,IAAI,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CACvF,CAAC;QAEF,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACvB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,0CAA0C;QAC1C,OAAO;YACL,GAAG,GAAG;YACN,KAAK,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAe,EAAE,CAAC;gBAC1C,IAAI,IAAI,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;oBACjC,OAAO,IAAI,CAAC;gBACd,CAAC;gBAED,gDAAgD;gBAChD,IAAI,OAAO,IAAI,CAAC,KAAK,KAAK,QAAQ,IAAI,IAAI,CAAC,KAAK,KAAK,IAAI,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;oBACvF,MAAM,SAAS,GAAgB;wBAC7B,GAAG,IAAI;wBACP,KAAK,EAAE,EAAE,EAAE,4BAA4B;qBACxC,CAAC;oBACF,OAAO,SAAS,CAAC;gBACnB,CAAC;gBAED,OAAO,IAAI,CAAC;YAAA,CACb,CAAC;SACH,CAAC;IAAA,CACH,CAAC,CAAC;AAAA,CACJ","sourcesContent":["import type { MuxMessage, MuxToolPart } from \"@/common/types/message\";\n\n/**\n * Sanitizes tool inputs in messages to ensure they are valid objects.\n *\n * The Anthropic API (and other LLM APIs) require tool inputs to be objects/dictionaries.\n * However, if the model generates malformed JSON or if we have corrupted data in history,\n * the input field might be a string instead of an object.\n *\n * This causes API errors like: \"Input should be a valid dictionary\"\n *\n * This function ensures all tool inputs are objects by converting non-object inputs\n * to empty objects. This allows the conversation to continue even with corrupted history.\n *\n * @param messages - Messages to sanitize\n * @returns New array with sanitized messages (original messages are not modified)\n */\nexport function sanitizeToolInputs(messages: MuxMessage[]): MuxMessage[] {\n  return messages.map((msg) => {\n    // Only process assistant messages with tool parts\n    if (msg.role !== \"assistant\") {\n      return msg;\n    }\n\n    // Check if any parts need sanitization\n    const needsSanitization = msg.parts.some(\n      (part) =>\n        part.type === \"dynamic-tool\" &&\n        (typeof part.input !== \"object\" || part.input === null || Array.isArray(part.input))\n    );\n\n    if (!needsSanitization) {\n      return msg;\n    }\n\n    // Create new message with sanitized parts\n    return {\n      ...msg,\n      parts: msg.parts.map((part): typeof part => {\n        if (part.type !== \"dynamic-tool\") {\n          return part;\n        }\n\n        // Sanitize the input if it's not a valid object\n        if (typeof part.input !== \"object\" || part.input === null || Array.isArray(part.input)) {\n          const sanitized: MuxToolPart = {\n            ...part,\n            input: {}, // Replace with empty object\n          };\n          return sanitized;\n        }\n\n        return part;\n      }),\n    };\n  });\n}\n"]}