{"version":3,"file":"sanitizeToolInput.js","sourceRoot":"","sources":["../../../../src/browser/utils/messages/sanitizeToolInput.ts"],"names":[],"mappings":";;;AAEA;;;;;;;;;;;;;;GAcG;AACH,4BAAmC,QAAsB,EAAgB;IACvE,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;QAC3B,kDAAkD;QAClD,IAAI,GAAG,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;YAC7B,OAAO,GAAG,CAAC;QACb,CAAC;QAED,uCAAuC;QACvC,MAAM,iBAAiB,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,CACtC,CAAC,IAAI,EAAE,EAAE,CACP,IAAI,CAAC,IAAI,KAAK,cAAc;YAC5B,CAAC,OAAO,IAAI,CAAC,KAAK,KAAK,QAAQ,IAAI,IAAI,CAAC,KAAK,KAAK,IAAI,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CACvF,CAAC;QAEF,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACvB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,0CAA0C;QAC1C,OAAO;YACL,GAAG,GAAG;YACN,KAAK,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAe,EAAE,CAAC;gBAC1C,IAAI,IAAI,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;oBACjC,OAAO,IAAI,CAAC;gBACd,CAAC;gBAED,gDAAgD;gBAChD,IAAI,OAAO,IAAI,CAAC,KAAK,KAAK,QAAQ,IAAI,IAAI,CAAC,KAAK,KAAK,IAAI,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;oBACvF,MAAM,SAAS,GAAgB;wBAC7B,GAAG,IAAI;wBACP,KAAK,EAAE,EAAE,EAAE,4BAA4B;qBACxC,CAAC;oBACF,OAAO,SAAS,CAAC;gBACnB,CAAC;gBAED,OAAO,IAAI,CAAC;YAAA,CACb,CAAC;SACH,CAAC;IAAA,CACH,CAAC,CAAC;AAAA,CACJ","sourcesContent":["import type { MuxMessage, MuxToolPart } from \"@/common/types/message\";\r\n\r\n/**\r\n * Sanitizes tool inputs in messages to ensure they are valid objects.\r\n *\r\n * The Anthropic API (and other LLM APIs) require tool inputs to be objects/dictionaries.\r\n * However, if the model generates malformed JSON or if we have corrupted data in history,\r\n * the input field might be a string instead of an object.\r\n *\r\n * This causes API errors like: \"Input should be a valid dictionary\"\r\n *\r\n * This function ensures all tool inputs are objects by converting non-object inputs\r\n * to empty objects. This allows the conversation to continue even with corrupted history.\r\n *\r\n * @param messages - Messages to sanitize\r\n * @returns New array with sanitized messages (original messages are not modified)\r\n */\r\nexport function sanitizeToolInputs(messages: MuxMessage[]): MuxMessage[] {\r\n  return messages.map((msg) => {\r\n    // Only process assistant messages with tool parts\r\n    if (msg.role !== \"assistant\") {\r\n      return msg;\r\n    }\r\n\r\n    // Check if any parts need sanitization\r\n    const needsSanitization = msg.parts.some(\r\n      (part) =>\r\n        part.type === \"dynamic-tool\" &&\r\n        (typeof part.input !== \"object\" || part.input === null || Array.isArray(part.input))\r\n    );\r\n\r\n    if (!needsSanitization) {\r\n      return msg;\r\n    }\r\n\r\n    // Create new message with sanitized parts\r\n    return {\r\n      ...msg,\r\n      parts: msg.parts.map((part): typeof part => {\r\n        if (part.type !== \"dynamic-tool\") {\r\n          return part;\r\n        }\r\n\r\n        // Sanitize the input if it's not a valid object\r\n        if (typeof part.input !== \"object\" || part.input === null || Array.isArray(part.input)) {\r\n          const sanitized: MuxToolPart = {\r\n            ...part,\r\n            input: {}, // Replace with empty object\r\n          };\r\n          return sanitized;\r\n        }\r\n\r\n        return part;\r\n      }),\r\n    };\r\n  });\r\n}\r\n"]}